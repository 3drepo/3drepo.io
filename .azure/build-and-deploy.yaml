trigger:
  batch: true
  branches:
    include:
    - master
    - staging

pr:
  branches:
    include:
    - master
    - staging
    - 'ISSUE_*'

resources:
  repositories:
  - repository: devops
    type: github
    endpoint: 3drepo   # <-- GitHub service connection in Azure DevOps
    name: 3drepo/DevOps
    ref: refs/heads/$(DEVOPS_BRANCH)

variables:
  # Agent VM image name
  vmImageName: 'ubuntu-24.04'
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '3drepo.azurecr.io'
  imageRepository: '3drepo.io'
  containerRegistry: '3drepo.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/.azure/Docker/Dockerfile'
  tag: '$(Build.BuildId)' # not used currently
  DOCKER_BUILDKIT: 1
  branchName: master
  group: tests-group
  customHelmOverride: |
    config.ADDITIONAL_CONFIG=hello

  # Default DevOps branch (can override at queue time)
  DEVOPS_BRANCH: ISSUE_1205

stages:
- stage: Build
  displayName: Container
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - checkout: self  # self = IO repo (where this YAML lives)

    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        buildContext: $(Build.SourcesDirectory)
        tags: |
          $(Build.SourceBranchName)
          $(Build.SourceVersion)

- stage: Helm
  displayName: Deploy
  jobs:
    - job: DeployHelmChart
      pool:
        vmImage: $(vmImageName)
      variables:
      - name: DECODE_PERCENTS
        value: false
      displayName: Deploy
      steps:
      # Checkout DevOps repo from branch $(DEVOPS_BRANCH)
      - checkout: devops
        path: devops-source
        persistCredentials: true

      - task: HelmInstaller@1
        displayName: Helm Installer
        inputs:
          helmVersion: '3.10.3'
          installKubectl: true
          kubectlVersion: 'v1.26.3'
          checkLatestHelmVersion: false

      - script: |
          if [[ "$SYSTEM_PULLREQUEST_SOURCEBRANCH" != "" ]]; then
            echo '##vso[task.setvariable variable=branchName]'$( echo $SYSTEM_PULLREQUEST_SOURCEBRANCH | sed "s/_/-/" | awk '{print tolower($0)}' )
          else
            echo '##vso[task.setvariable variable=branchName]'$( echo $BUILD_SOURCEBRANCHNAME | sed "s/_/-/" | awk '{print tolower($0)}' )
          fi
        displayName: Set new branch name value

      - task: Bash@3
        displayName: Get default Helm values file
        inputs:
          script: |
            curl -u ${TESTS_USER}:${TESTS_PASSWORD} '$(helm-3drepo-io-defaults)' --output $(System.ArtifactsDirectory)/values.yaml
          targetType: 'inline'
        env:
          helm-3drepo-io-defaults: $(helm-3drepo-io-defaults)
          TESTS_USER: $(TESTS_USER)
          TESTS_PASSWORD: $(TESTS_PASSWORD)

      - task: HelmDeploy@0
        displayName: Deploy helm chart
        inputs:
          connectionType: 'Kubernetes Service Connection'
          kubernetesServiceConnection: 'stg3drepo'
          namespace: 'default'
          command: 'upgrade'
          chartType: 'Path'
          chartPath: '$(Build.SourcesDirectory)/devops-repo/helm/io'   # DevOps repo chart
          releaseName: '$(branchName)'
          overrideValues: 'image.tag=$(Build.SourceVersion),branchName=$(branchName),$(customHelmOverride)'
          valueFile: $(System.ArtifactsDirectory)/values.yaml
