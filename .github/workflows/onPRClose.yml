name: On PR closed
on:
  pull_request:
    types: [closed]
jobs:
  extractIssueNumber:
    name: Extract Issue Number
    runs-on: ubuntu-latest
    outputs: 
      issue-number: ${{ steps.commitMsgParser.outputs.issue-number }}
    steps:
      - name: Extract Issue Number from PR
        uses: carmenfan/extract-issue-number-from-PR-merge@v1.1
        with:
          pr: ${{ github.event.number }}
          base: staging
          github-token: ${{ secrets.GITHUB_TOKEN }}
        id: commitMsgParser
  tagOnPRMerge:
    name: Tag merged issues as In staging if applicable
    runs-on: ubuntu-latest
    needs: extractIssueNumber
    steps:
      - name: Apply in staging label
        if: needs.extractIssueNumber.outputs.issue-number
        uses: carmenfan/any-issue-labeller@v1.1
        with:
          issue-number: ${{ needs.extractIssueNumber.outputs.issue-number }}
          label: 'in staging'
          github-token: ${{ secrets.GITHUB_TOKEN }}
  destroy:
    name: Call Azure Pipeline
    runs-on: ubuntu-latest
    needs: extractIssueNumber
    steps:
    - name: Azure Pipelines Action
      if: needs.extractIssueNumber.outputs.issue-number
      uses: Azure/pipelines@v1.2
      with:
        azure-devops-project-url: https://dev.azure.com/3drepo/3drepo.io
        azure-pipeline-name: 'destroy'
        azure-devops-token: ${{ secrets.AZURE_DEVOPS_TOKEN }}
        azure-pipeline-variables:  '{"branchName": "issue-${{ needs.extractIssueNumber.outputs.issue-number }}"}'