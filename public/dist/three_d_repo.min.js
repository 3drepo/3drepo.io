var ViewerUtil,ViewerUtilListeners={},ViewerUtilMyListeners={};!function(){"use strict";ViewerUtil=function(){};var eventElement=document;ViewerUtil.prototype.cloneObject=function(obj){if(!obj||"object"!=typeof obj)return obj;var retObject=new obj.constructor;for(var key in obj)obj.hasOwnProperty(key)&&(retObject[key]=this.cloneObject(obj[key]));return retObject},ViewerUtil.prototype.triggerEvent=function(name,event){var e=new CustomEvent(name,{detail:event});eventElement.dispatchEvent(e)},ViewerUtil.prototype.onEvent=function(name,callback){ViewerUtilListeners.hasOwnProperty(name)||(ViewerUtilListeners[name]=[],ViewerUtilMyListeners[name]=[]),ViewerUtilListeners[name].push(callback);var myListener=function(event){callback(event.detail)};ViewerUtilMyListeners[name].push(myListener),eventElement.addEventListener(name,myListener)},ViewerUtil.prototype.offEvent=function(name,callback){var index=ViewerUtilListeners[name].indexOf(callback);index!==-1&&(eventElement.removeEventListener(name,ViewerUtilMyListeners[name][index]),ViewerUtilListeners[name].splice(index,1),ViewerUtilMyListeners[name].splice(index,1))},ViewerUtil.prototype.offEventAll=function(){for(var eventType in ViewerUtilMyListeners)for(var i=0;i<ViewerUtilMyListeners[eventType].length;i++)eventElement.removeEventListener(eventType,ViewerUtilMyListeners[eventType][i]);ViewerUtilListeners={},ViewerUtilMyListeners={}},ViewerUtil.prototype.eventFactory=function(name){var self=this;return function(event){self.triggerEvent(name,event)}},ViewerUtil.prototype.getAxisAngle=function(from,at,up){var x3dfrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),x3dat=new x3dom.fields.SFVec3f(at[0],at[1],at[2]),x3dup=new x3dom.fields.SFVec3f(up[0],up[1],up[2]),viewMat=x3dom.fields.SFMatrix4f.lookAt(x3dfrom,x3dat,x3dup).inverse(),q=new x3dom.fields.Quaternion(0,0,0,1);return q.setValue(viewMat),q=q.toAxisAngle(),Array.prototype.concat(q[0].toGL(),q[1])},ViewerUtil.prototype.quatLookAt=function(up,forward){forward.normalize(),up.normalize();var right=forward.cross(up);up=right.cross(forward);var w=.5*Math.sqrt(1+right.x+up.y+forward.z),recip=1/(4*w),x=(forward.y-up.z)*recip,y=(right.z-forward.y)*recip,z=(up.x-right.y)*recip;return new x3dom.fields.Quarternion(x,y,z,w)},ViewerUtil.prototype.rotationBetween=function(prevUp,prevView,currUp,currView){var x3domPrevView=new x3dom.fields.SFVec3f(prevView[0],prevView[1],prevView[2]),x3domPrevUp=new x3dom.fields.SFVec3f(prevUp[0],prevUp[1],prevUp[2]),x3domPrevFrom=new x3dom.fields.SFVec3f(0,0,0),x3domPrevAt=x3domPrevFrom.add(x3domPrevView),prevMat=x3dom.fields.SFMatrix4f.lookAt(x3domPrevFrom,x3domPrevAt,x3domPrevUp),x3domCurrView=new x3dom.fields.SFVec3f(currView[0],currView[1],currView[2]),x3domCurrUp=new x3dom.fields.SFVec3f(currUp[0],currUp[1],currUp[2]),x3domCurrFrom=new x3dom.fields.SFVec3f(0,0,0),x3domCurrAt=x3domCurrFrom.add(x3domCurrView),currMat=x3dom.fields.SFMatrix4f.lookAt(x3domCurrFrom,x3domCurrAt,x3domCurrUp);return currMat.mult(prevMat.inverse())},ViewerUtil.prototype.axisAngleToMatrix=function(axis,angle){var mat=new x3dom.fields.SFMatrix4f,cosAngle=Math.cos(angle),sinAngle=Math.sin(angle),t=1-cosAngle,v=axis.normalize();return mat.setFromArray([t*v.x*v.x+cosAngle,t*v.x*v.y+v.z*sinAngle,t*v.x*v.z-v.y*sinAngle,0,t*v.x*v.y-v.z*sinAngle,t*v.y*v.y+cosAngle,t*v.y*v.z+v.x*sinAngle,0,t*v.x*v.z+v.y*sinAngle,t*v.y*v.z-v.x*sinAngle,t*v.z*v.z+cosAngle,0,0,0,0,1]),mat},ViewerUtil.prototype.evDist=function(evt,posA){return Math.sqrt(Math.pow(posA[0]-evt.position.x,2)+Math.pow(posA[1]-evt.position.y,2)+Math.pow(posA[2]-evt.position.z,2))},ViewerUtil.prototype.dist=function(posA,posB){return Math.sqrt(Math.pow(posA[0]-posB[0],2)+Math.pow(posA[1]-posB[1],2)+Math.pow(posA[2]-posB[2],2))},ViewerUtil.prototype.rotToRotation=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo);return crossVec.x+" "+crossVec.y+" "+crossVec.z+" "+Math.acos(dot)},ViewerUtil.prototype.rotAxisAngle=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo),qt=new x3dom.fields.Quaternion(crossVec.x,crossVec.y,crossVec.z,1);return qt.w=vecFrom.length()*vecTo.length()+dot,qt.normalize(qt).toAxisAngle()},ViewerUtil.prototype.scale=function(v,s){return[v[0]*s,v[1]*s,v[2]*s]},ViewerUtil.prototype.normalize=function(v){var sz=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return this.scale(v,1/sz)},ViewerUtil.prototype.dotProduct=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},ViewerUtil.prototype.crossProduct=function(a,b){var x=a[1]*b[2]-a[2]*b[1],y=a[2]*b[0]-a[0]*b[2],z=a[0]*b[1]-a[1]*b[0];return[x,y,z]},ViewerUtil.prototype.vecAdd=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},ViewerUtil.prototype.vecSub=function(a,b){return this.vecAdd(a,this.scale(b,-1))},ViewerUtil.prototype.escapeCSSCharacters=function(string){return string.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g,"\\$&")},ViewerUtil=new ViewerUtil}();var ClipPlane={};!function(){"use strict";ClipPlane=function(id,viewer,axis,colour,distance,percentage,clipDirection){var self=this;this.axis="X",this.clipDirection=void 0===clipDirection?-1:clipDirection,this.percentage=void 0===percentage?1:percentage,this.distance=distance;var volume=null,clipPlaneElem=document.createElement("ClipPlane"),normal=new x3dom.fields.SFVec3f(0,0,0),coordinateFrame=document.createElement("Transform"),outline=document.createElement("Shape"),outlineApp=document.createElement("Appearance"),outlineMat=document.createElement("Material"),outlineLines=document.createElement("LineSet"),outlineCoords=document.createElement("Coordinate"),BBOX_SCALE=1.0001;this.getID=function(){return id};var setOutlineCoordinates=function(){var min=volume.min.multiply(BBOX_SCALE).toGL(),max=volume.max.multiply(BBOX_SCALE).toGL(),axisIDX="XYZ".indexOf(self.axis),outline=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],minor=(axisIDX+1)%3,major=(axisIDX+2)%3;outline[0][minor]=min[minor],outline[0][major]=max[major],outline[1][minor]=min[minor],outline[1][major]=min[major],outline[2][minor]=max[minor],outline[2][major]=min[major],outline[3][minor]=max[minor],outline[3][major]=max[major],outline[4][minor]=min[minor],outline[4][major]=max[major],outlineCoords.setAttribute("point",outline.map(function(item){return item.join(" ")}).join(","))};this.movePlane=function(percentage){var axisIDX="XYZ".indexOf(this.axis),min=volume.min.multiply(BBOX_SCALE).toGL(),max=volume.max.multiply(BBOX_SCALE).toGL();self.percentage=percentage;var distance=0;distance=self.distance?self.distance:(max[axisIDX]-min[axisIDX])*percentage+min[axisIDX],clipPlaneElem.setAttribute("plane",normal.toGL().join(" ")+" "+distance);var translation=[0,0,0];translation[axisIDX]=-distance*this.clipDirection,coordinateFrame.setAttribute("translation",translation.join(","))},this.changeAxis=function(axis){this.axis=axis.toUpperCase(),normal.x="X"===axis?this.clipDirection:0,normal.y="Y"===axis?this.clipDirection:0,normal.z="Z"===axis?this.clipDirection:0,this.movePlane(1),setOutlineCoordinates()},this.destroy=function(){clipPlaneElem&&clipPlaneElem.parentNode&&clipPlaneElem.parentNode.removeChild(clipPlaneElem),coordinateFrame&&coordinateFrame.parentNode&&coordinateFrame.parentNode.removeChild(coordinateFrame)},outlineMat.setAttribute("emissiveColor",colour.join(" ")),outlineLines.setAttribute("vertexCount",5),outlineLines.appendChild(outlineCoords),outlineApp.appendChild(outlineMat),outline.appendChild(outlineApp),outline.appendChild(outlineLines),coordinateFrame.appendChild(outline),viewer.getScene().appendChild(coordinateFrame),volume=viewer.runtime.getBBox(viewer.getScene()),this.changeAxis(axis),viewer.getScene().appendChild(clipPlaneElem),this.movePlane(percentage)}}();var Collision={};!function(){"use strict";Collision=function(viewer){var self=this;this._deltaT=.1,this.deltaX=0,this.deltaY=0,this.ticking=!1,this.prevMove=0,this.stopped=!0,this.viewer=viewer,this.updateDirections=function(event,gamepad){var speed=self.viewer.nav._x3domNode._vf.speed,userX=self._deltaT*speed*(gamepad.xaxis+gamepad.xoffset),userY=self._deltaT*speed*(gamepad.yaxis+gamepad.yoffset);0===userX&&0===userY?self.stopped=!0:self.stopped=!1,self.stopped?(self.userX=0,self.userY=0):(self.userX=-userX,self.userY=-userY,self.ticking||self.tick())},this.tick=function(){self.ticking=!0;var viewArea=self.viewer.getViewArea(),straightDown=new x3dom.fields.SFVec3f(0,-1,0),straightUp=new x3dom.fields.SFVec3f(0,1,0),right=new x3dom.fields.SFVec3f(-1,0,0),currProjMat=self.viewer.getProjectionMatrix(),currViewMat=self.viewer.getViewMatrix(),flyMat=currViewMat.inverse(),from=flyMat.e3(),tmpFlatAt=flyMat.e3(),viewDir=currViewMat.inverse().e2().multiply(-1),viewX=viewDir.x,viewZ=viewDir.z;self.deltaX=self.userX*viewZ+self.userY*viewX,self.deltaZ=-self.userX*viewX+self.userY*viewZ,tmpFlatAt.x+=self.deltaX,tmpFlatAt.z+=self.deltaZ;var tmpTmpMat=x3dom.fields.SFMatrix4f.lookAt(from,tmpFlatAt,straightUp);tmpTmpMat=tmpTmpMat.inverse(),viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpTmpMat,currProjMat.mult(tmpTmpMat));var dist=self.viewer.avatarRadius+1;if(viewArea._pickingInfo.pickObj&&(dist=viewArea._pickingInfo.pickPos.subtract(from).length()),!self.stopped&&dist>self.viewer.avatarRadius){var tmpUp=tmpFlatAt.subtract(from).normalize();right=straightDown.cross(tmpUp),tmpUp=right.cross(straightDown),from.x+=self.deltaX,from.z+=self.deltaZ;var tmpDownMat=x3dom.fields.SFMatrix4f.identity();if(tmpDownMat.setValue(right,tmpUp,straightDown.multiply(-1),from),tmpDownMat=tmpDownMat.inverse(),viewArea._pickingInfo.pickObj=null,viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpDownMat,currProjMat.mult(tmpDownMat)),viewArea._pickingInfo.pickObj){dist=viewArea._pickingInfo.pickPos.subtract(from).length();var movement=.5*(self.viewer.avatarHeight-dist+self.prevMove);from.y+=movement,self.prevMove=movement}var up=flyMat.e1(),tmpMat=x3dom.fields.SFMatrix4f.identity();right=up.cross(flyMat.e2()),tmpMat.setValue(right,up,flyMat.e2(),from),viewArea._scene.getViewpoint().setView(tmpMat.inverse()),self.viewer.runtime.triggerRedraw()}self.nextTick()},this.nextTick=function(){window.requestAnimationFrame?window.requestAnimationFrame(this.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(this.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(this.tick)},ViewerUtil.onEvent("gamepadMove",this.updateDirections)}}();var Gamepad=function(viewer){var self=this;this.enabled=!1,this.gamepad=null,this.timestamp=null,this.browser=null,this.platform=null,this.viewer=viewer,this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){self.gamepad&&(self.gamepad.timestamp&&self.gamepad.timestamp==self.timestamp||(self.timestamp=self.gamepad.timestamp))},this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){if(self.gamepad&&(!self.gamepad.timestamp||self.gamepad.timestamp!=self.timestamp)){self.timestamp=self.gamepad.timestamp;var button_idx=0;"Linux"===self.platform&&"Chrome"===self.browser?ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.axes[0],yaxis:self.gamepad.axes[1],xoffset:0,yoffset:0,button:self.gamepad.buttons[button_idx]}):"Win32"===self.platform&&"Chrome"===self.browser?(button_idx=3,ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.buttons[15].value-self.gamepad.buttons[14].value,yaxis:self.gamepad.buttons[13].value-self.gamepad.buttons[12].value,xoffset:0,yoffset:0,button:self.gamepad.buttons[button_idx]})):"Win32"===self.platform&&"Firefox"===self.browser&&ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.axes[0],yaxis:self.gamepad.axes[1],xoffset:0,yoffset:.15,button:self.gamepad.buttons[button_idx]}),self.gamepad.buttons[button_idx].pressed&&(self.oldButton||(viewer.reset(),viewer.setNavMode("NONE"),viewer.setApp(null),viewer.disableClicking())),self.oldButton=self.gamepad.buttons[button_idx].pressed}},this.tick=function(){navigator.getGamepads()[0]&&(self.gamepad=navigator.getGamepads()[0]),self.gamepad&&self.checkStatus(),self.nextTick()},this.nextTick=function(){this.enabled&&(window.requestAnimationFrame?window.requestAnimationFrame(self.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(self.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(self.tick))},this.stopPolling=function(){self.enabled=!1},this.init=function(){var gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;gamepadSupportAvailable&&(window.navigator.platform.indexOf("Linux")!=-1?self.platform="Linux":window.navigator.platform.indexOf("Win32")!=-1||window.navigator.platform.indexOf("Win64")!=-1?self.platform="Win32":console.error("Platform "+window.navigator.platform+" is not supported."),window.navigator.appVersion.indexOf("Chrome")!=-1?self.browser="Chrome":window.navigator.appVersion.indexOf("Firefox")!=-1?self.browser="Firefox":window.navigator.userAgent.indexOf("Firefox")!=-1?self.browser="Firefox":console.error("Browser version "+window.navigator.appVersion+" is not supported."),self.browser&&self.platform&&("ongamepadconnected"in window?(window.addEventListener("gamepadconnected",self.connected,!1),window.addEventListener("gamepaddisconnected",self.disconnected,!1)):self.startPolling()))}},logo_string="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAB0CAMAAACcw5TeAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA/SAAAP0gH7iTvJAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAwBQTFRF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////vy5IYQAAAP90Uk5TAAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+6wjZNQAAJfNJREFUeNrdnQd8FMX7//eSkBAIkIRA6L0JIkWQIiBfQQEBQREFld6b0kQsKE2kdxQUNAgifCkiSKRLF5ASSkILgUgSAmkkIf3u9j/PM7N3e3ezc7uX/+/1+5l5vcgdye7O7r535/nMzPM8I0mslOi1eu/Fm6Jy/cimSXUkpzLhpt5y4/yvS7v4SrrLPt1Hjjr+y/SGUtEqod/myLrKxW6OO86SDZWMr8roPaUbxo58/Y2ixGPsU/1Xfji0EEBkOeXN/xkgsnyiUlHB4bMWrsdyeuGU0aIyftaWFNjwQVMXILtH6yjTVlyBba0zDQCxbljuvqzcctYMG8c3KyJANsDVbKihY0u/qWlk09TazkDye+irqfFm2HqmgTfkL31NXOD4BLJxWp0iweMjuPC4UH0br4ONI0upgRQYINIpDx77vgaarPNB+o48Eza+WboI8KhTgBcepYvIcnqX5quBnFmgm0gnKh1SA/UBWRZDNr5UVs+RP6EntqAIANlKruO+TiKMh5xbVQ1E0kukkyLlFusDMrHyHbLxlXLuN1a0Rc6/37BXtMry1uBLuogstymamQ5AdBKx8ZCf+ukDIlW8CS1kBXfbLrCd2Ox/PZAx5CqekZBI2n1xiYPWhgrkC45A8I4UuNn9fj7Z6B96317TCUQqf51s/cTNgR9A7WbaT/rXA9kjyxHkA4m4L9Y27ZGINcgRiOoZFZa9xffj53K9QKSQCH1HHvw2ErGW/bcDiZTl1fAZnKTrug+WoESaOQGRfta1e34P/6PwuUc3ECn4ka4jHy3RG95AucW/HUiGLH+OX27B5ZhXL0wnH5kLV8LzFjl/L/zy+PwT9gs/FtD+KTE7vZyBULN6bv5F+Ng+/y50Nb9ZDgru8fzv1ERKniQfl/UDYfp3/UJ4EDIXrYATuzd/D/bN5x9XE3ktl5zYm/92IORSPrADkc+UaQl9v01efcmFW0d5Qacxq0PxA/YLP126PelMDOIDyX+99CnykVC/EhzubJnX4aldJI1VEylFmMUYBhIR/GIm+djs1QeITDHBiWV39PtDTaQzObHBRQkI9Nr+DmqWYiMiTzCtB1HUfhUMDMrKFrH261YDgR0KepX8k3wkNqwQCS9MmR5AZD72B1OJXEYiCzwBIl8MbJuJJ4ZEPjDRRwWEH1RhRSL3ihiQ6WDZL4c8l2QnMtUE7Q18e9KO/PgEtoggfx/CAfJwAhDp7X+QfCQ1LncV+tmB3fPY/msWynI46uNzhoFsAa11rnQbeCZ+okTGIBH4lteL/JgbD0QSihiQcUFgAa6FNky0E/nMtI4OnLfyh9ugqLGhHCCPpSlA5A2/fTCq26wsbPp34Gt5uMMaEGKHFDVmEMiKUOiPnA5oDUTCkIh1OBIhPLr6kZ9D6sQztVWUgCQ9G3SB/P9GpfoJdiKzvaDNeNpWAiCJDRiRYTwbslKaDkTe9P0VejUtgv6GHkvQLMoDWFhHMyIGgSQ3rhQNRrxkK5AcPyIRyyDT38hDAiCRoXUTih4QQiQQLvJpIrTWcnIiCkkwKdkdJAQiJz5DiYzgGvXF0hfQjiSihM5NBHkgpxdQHojCOoYSMWpDkhtXIfZBvn0sFg38MajAcobyQCDyzYr1EooeECByniPyc16WGBD5ESUykq+yvpbm8DoJa+x9x3H4adioJzeu/g/nwMCDApHvVKn3sOgBIUTKcDpiH0k2IPKjhsFEL43iA5Fn4WClU7mgHnAaL23zRGUlN66V4Xrk6ZINiBxTvX5mEQOSikTIl79mqoryPvhT6So/bkTajdEcILlgvj8n9z1TvTsxx0cVIMmgTicYl73pSIQ0WmdVB4Z3cbQC5DH5F1urqMneCdD/TSI2Y6lqA5MayITfYQtyf8bwZC92Ou6TfqG6gt9UQMKHA5Fow0BWgvZOfuI4BuanBjISTj0utYgBmea7h779mkCm+O6jW4zlAEn1602HXDWBnJZGWD1RWT+afpRdBiUdgEz03VsEZW9ed0ZEE0j2y37hzBJwbEi4HwplbSBEGI+0egDEOtxrsxhITiff34ug7M3vRYloAiEXToePJnCNerhff4sQiPytabTVA5VlGei9TQhEzumM/dGiprIK+iARbSBw4ftt+7iorHC/gRYhEHm91xirByrL0s9npxCInPsKvrxFTfaa+/nGCYHIOa8UJ92yDzVkb7jfWjEQeaPX957IXvObxRKFQOTcV/0eqYD0OOtROaPsv1v3Lqd3rRimPf1dpv+S/54S7n/4xy/beXGBnINHccAtAZBzeOGxyr1yBPIEmIavEAC5mUy22LLEMBBwwijocU8AJApOrIta9g6VPSoWZf9/DO1mPfEy9ypa7CvQtX/y14HOQIgYHTkRzihHAGTkJLjwbFmezJO9lWPoCL227H0OiGQZBrL8AzhwlgDIkPlsi/8lIKT84eqLEbDZqnv31KEOQDqfJV/2FfvQjexdK02iW0zhAMmux4Y3NIFEByERw0B2SxPcyN5ZypiNE5CombrLeh6Qb3Ts+MWycPSniXN2Za2OvrP5R1Z+Kdx/zobbWNcKbxuQF/+kV7O72AQxEHk+IzKVZ0Pia9WOF8vei8GUiFEbslwaJwZiHS3N4AGx9WDdlop3eECuh+jaueSMLJiiaOTwy1DwhkmepsebstUZdOdlQL7bZ3tvdhcbLwYiL6BEPuIa9dhq9RLFsvcSJWLYqC+XxlrFKmsCjv27ALEO18cj9Aa/yYoI1rf/Stj4vhpfcWh0bKOwbkqtdOUxt7FY1eAGEhknBiIvRCLT+CrrbuWGSWKVdbksEDGuspZLIJdFKmuyNNkZyFQrzJvouSEhMOMcfdcRyEZoci7o8XuVZtNz+EH1q0+ZOtSze02Kv6C2CshfpStEIZFbYiDyYimWDbNyZO/tCgvcyN6Isp7NqS+X7omByB9LziqrFDxdlnfdVxaM3l/txzoCWVIOHQNK6+YhW+yNVtkMOiiqh0hNRUFsVQEhREKh/t0xAiC/gYhbQoB8wgGSAg1h1A8CIBdAGF/ZYBjIcRh5Xy4Csh3GNWe4AJFQN7r1tg9E5yU5drETEKnCLZw61stDltfZfvcx+d/Ls3URsfGQrZVVQOSoOQNi3aiskb2YrP6UJ3tLn5PFKiu84i2P5tSXt33qRmUN7glELC5ApGlwSyLcFJAiT1xtyBJJwqnjB252BxcMczbuHm87vTPo1zpbT/Up9upHSFX7rbpkdtbEmkC2ezMin3GA5L/InjRNIIl1GBGDQC6X7pAtBrLDG4m4ApE+09cNuBK0hwdEqnpP3/4D/kNdyZU2K8hCbfRsfbtfZdVvp/2Xzl8ezNQFRP6ZEfmcZ0Oetgu+Ipa9CQ0oEaM25HTAyzniwcVfGBEXINIqXXek4HUco3MBItXI1BfhGNAF3WsUl87nyfcX4MtqXbub+2D1VrtLp3fTcVti3QORt1AiX3CN+tP25a6LZe+jRkjEsFE/XuLVPLHs3UqJuAKh+vdOGPa1joVBGyT/FgZTjFlhW0FLPwyDuZT8buh27AKE6d/tYWDHMsN2oLEJO4SOs2FR9lt6MqBHgdU+L9Gb/Kqqunr0ej2pVA/aP+enrfaOvLkvVp/ieBOqvLPyotmN7P3FuxfZ5Eu+ysrqAB5UIpWV9FzF256orCP+3QvEKmubT88CbSDmPl7gD/6gNoacXAx6Fm7JamkY3JIPpfk4XFzylDaQEwGtgMgKCUZxLENM30K7/0LwZTuRU6X6kGZqhqr60urqvX9GhwQUTheDGkP1P3kPUxF526F61fgLab9maQGx4qMYa4/YUQOBP2a9JJK9ADuluWey94CfO9n7X5972kDII+i93U7kUnDTNDuRSdJSeGI7jtUAYsE34IV024SOZajpG3hh2sOAjTmfXtnpUkmOQGzVk/3Nb3lvxuex3BWs/lnwZPpv9UQ6tge7m98ZywXiXByAzAGv9m3xMHbEUVlzYU7xhADIfpiJfXLQMJAdMKzxe5wAyGLwldn+QAvIR/gIFvvNTuRycMsMO5HJ0hq4Mz9rAFlzDt8AJLLeaxi5v9ZhaBxyUdaS5m8avEdn0jWADDVD9V6b7B6dl4MbQaMJhvE4EYKRqMYOGQcyqspdx9AxNZBEaaEb2fuH14+eyd5Kd9zJ3gYPZb7Kwi/FYODF/I5vuIpI2TZP7USmmL7nyl76ZV6Zs/gGtHyCEzowCWcdwdQC6WaQW/u20pfgAvF9D4i847URPDpbBp3H6htSf6vjJcmLEaWoMaNAoqswInN4NuQzaZkYiPktRsQgkNgalW6LgZwuXTdOAGQ6eleY+xU/ZCcSURa1NCMy1esnbSCpTUv/BW9A6RZpqGv6g3PxSOk06/YRIDcqMCJcIOtN7wKRfl5h4MrZugwcLCLkFcoDgzU+ZESMApHvMiJfcY36R1TkaRt1c19KxKgNia1B5bK2DTkbWCtWGwhRhYPJY23ZgWo/YesxHObZehPjSraiD+re7QWaQIAIDEPEReBTHR0BUtgaqXTDofG5yYhwgRAi/cAdOeIqKp8IfN8fplAeNHpmIiViGIh8tyoS4QORJ2L0gkBlkZb0R09kb2yNCjfFsvdCcPUYgeydI71nMTpBpVJZqU1LneZ1H3BYBIDItyoiET4QQuQdM2d/4MHCmSYhET6Q0fvVxUn2xlSrYtaYDwHXXdNesewlLenvnqgsQoQ0F/dV53XASWVFhFR5IlBZC6TRhQACRG67bk0HvREIEMnRBEKIjHLd/THwUOLLpkjfagFZ4bzjAgUITMPca05+9OcNnaCtE8neTHSjMC57odrYF9Ndr2ixAgSOfL28puwFY7G0Lcz9rHVTvuEByUIiRB1eUm0Jb/oABQjUf7uSluyF6te/6FT9NdLcSAxINry9U8fqBoLzbui5eIpdfGue7B1kpS2r9uAiZMAwXzEMZNVmrQd6HAMyAeJSbyRpAekEggo2KabbHUcNZCH0z1Pv2FtqHLJXAxkByulOpgYQrP6sU/UrVUAiBwCRi2Igf7Km4bCVzrsBkPEBp6gLvBcHSJLXcKtYZR1VcpIYBLKWOS5GObSleGIjmTEJOCGSvaXaseFiz4As9dlOd9cEMrDMeYHs5VavBhJtGmARqCwK5IA/++8YOu+G3u/NKZHVEs+GbPIaIwYif8qIGARi7tsARrKOlHDcZBQQGYJA0pozInwgh/1fzCwEkPzePtvEQJKbMCJcIEdLcqpXA5HXMiLCJst2/ThY8C4a9bQWlcitMTfhAiFEPhADkWdSIkaNujkJ76rzNuAobHkfjbpCRMOoH/bHGF4PgZAOlM9WIRDyqFIifKN+opRr9Q5A5A1eSEQTSDyIzOMB6gsfhJSenMIhNj4QQmSqGIg8D4l4MJYlH/J33QjaSPNAWUVES2Ud9scYXg+ByOb+3r8IgchPXkAiGirrTGmX6h2ByD95AxFNIFHYmT2tTCdjP9dmSe+V0gJCiGx0M6e+SNroEZCD/rythtlPjBBJEsjew/5vFgIIuHtfFgKRM9qUydSWvecD3xQDkX/xmS0CImHX+Fyg6lFUyoMaEhdIBsbuLhY5yuHc+EJPgBwozt9sKDWGD5CIpuyFYZXDnTwGch1aiGEHBUAu4WyQluyFDvrFngIgj2ASefuHQiCUSLQiaVJUIYP+fCAP6ydSUawtezHQPMUTIMf2axTqCjkMZFgaMW+vc4HUiWFp2jwD8tVQkA9pAiBvw/uflasBpMIlFs2sKXvrxtMtREAkxSPBpWziA8ms1DBJrLIi/VtneKKy3JcFTBjLDblAKle5UxjZu1MaYhGrrC+UFpkL5Lmgi2LZ+zikbrxY9gIQn92uFx73NlxZF74NuVXhuRSxyjpSghL5/w5EnkSJWItzgdwIrXijEECIzB9sEQKxpUTgAnncCDMyCGzIVUZEBMTnv8ps8e5s+4VPrEnapJgSfKMeWa5ZmlhlHaVEDANJ330YR0h3oxPstd33VUH0u3+32IhclfhG/UZo6PVCACFEYBJEYNSVlAh8o/64EWZkEBj1a+WQiAAIxpDdx5H7su1UIeKTx6gSOTirrCtlW6aLVdafJYGI8TfkU+lLON/3MMNJ6vMVVO4Fm32xQZnU1sGV1knm3AjF3HTPNtAsxYQqa7UEqnStavtWTiqLpkTQUFmEyHmxyrpWHohoA/HGjtA76Pt2OXiKeoTzLnlptGTvpaBFbmTvsZKLPGqyPlMTSe98keZlugCTGCfKIhEi8pL9tYAQIh3FjV5dIRBC5DjHG0sFRB4vJWvL3seN2rmRvdfLjxcAubUFN0p/PhAavygYuIBZ/QNmqiGtVThAUuERPC8KabsGb+XxNYaBnM1BVzAVESjfh5PuVEewWnfqMqM7Q+IDOQJELnsM5BRcP28+5EIQA4I+XRO0ZC9U/3ikAMgDaE8jZ7kZOoG7kPKs4umyFF1J+7JeWGee7A25Rh1TtGUvJlEyG59TfyUPZ/0ciFwuTjo0t4vXhjcopf0XGMTkrQGkVLh7WSAA8lWXXI2dkAgB0hfjVywaQEoDrwKR7MXsq2YxkLia6ElUPySK+s4BkE2mXvma+bJym5W/IZa9sRVZWiuDQP7yfw2q/VIhAmOv6bWlAcDArwzMVOXD03O1lKQB5FW/gyg6OnfklNfi3AH507czPIj5Qx32ezWaESFAvmURRXwg3ZRUhFpA0hsgETGQ7HXr4bmMX5tKXef8aVTza7myludiarOKt8Wy93ZlSsSoDdnv9zo8YDvXQnNtCYNj9JakpvhW+HkzZ9Hz1SQtIDlD4zGpFq+iEkfd25A9iyCEsbvTnji8RIjASS1hRLhA8nqwfAuaNuRRI0pE7wTVUtsU7k/enbM159RTm2Hcp8Co362GRAwb9b3F+jjOSS+CmSkzjcSWxpAv2ZO9JU0gWCLL8+rxP6LPqMt5rtmf8SZeCEKjzojwjXp+b5rWQNuoJzfBg+kEskE1p77V5yXy4szlq6zUZtVixSrrfk0gYlxl7fRx8BKI9rH/aZ+fFAa9aUkM5Do3h7w/9G8u/+AeSF43zt7o9HaBzi1TIhoqy9wXU38IVFZqcyDCBzJoq7o4R1Dt8o3V8MtCIu4iqB7U8cyVdKv3PSL+8IwgGyH+iXVdf/edTkSUGyDXuDzQUUv+oJZbILlduGcZpMr3tkRK0pa95v5t3cjeJy944Eq6DPySfn+o4bkITlmpfwiAHAY384RfDQMJB7fEn2IVNyCIJcTwyhmynAEjqXv7ERHjKwQSVaU4p5Q+SE3pbLdApjXllw40ZGAujHEueQpxdZzqIZrK8q0AyA1Y5Chjk3EgI595pGSO48he03fuIqiUJEpGs5LWf6h2Je1Cvr0EX8Dnvy4QAZ+1xm6aLK0Sq9OGCEtfFoAvv8/1ZJ0oi1VWpGmtZ66kV8sxIjN5TdY4dF4VAMntwogYBJLUkGa4ZEAqK/HndaBHFHKVXks/z4A8DhpnLTyQC0pKhA686pdIH4qBWAYzIoY9F68xItz4EOsInOcU2JC8rpSIURuSWI8OhjLPxSfMzcIrG9KaMyJzPHxDVrBJrkIBUYjkB3CrX4JhJQIbYhlKiRh3Jb1WHonwI6gsA312iGVvXjckYtiox9dCucyAnFaOeR4lPCWySwhkX0f0rpjXEbI8FYz8Dwy+JnTvC6Oma0zgPC0GkjOgJ1x2TJf+4DR3rCNezMqO8PxZP+p8C4m0hol/jeqXSOPFstc6DIlwgAT3+PrEV9pA5Ovln3lqFxNOKsvSr9hRscrKe833T49cSavXzrAB+Q7SaEPZQIOykMgt8RsyHRMe5L6KebfiawddtmdmXmd6z+0bcrcyPojhfu2zMMMIDXj2hiG/9JY4lXcBAhqGaFW/BOOkBSrLOtz0swuQOoO+i7SKQtoKsL8byw/6tGDolkj2Qs8/v7tx2QsPcExlewQVvP+4cgtNvJLSHIiY/bSBYBp7DJFmRB7ULHsViWAQzoY6YiBw2XcqqonM5RCBAUxvzeqXiGQvricwwkH2+raesuux26DPz2H4MCqZHxb9EOKUCs6LAnaWe5aM/3sIH7idZAPSSbGenZmEb1mf/GyiDaRvAXr8f24nElu9fBQSwSCcw2Igy4/ifKiayEweEcurguqPiFQWKHmrLcYQWqlcXWHRY8pd004c8Jil99AGckhZV8yoby/zYFWAVFAc30PZslYZL5Jm9F1tIP64kMl4vImMyL2qFW4jkRZP3MrehSWO4NCLmshnDkR6/mrL68ypvsTr+WKVdRv7VmhD6g7+PsqqO3HAo0aMCC+1BtltphiIdRwjYhBI9kulzjpEUJF3dBV+IW/NXLCsT1Md51ed7sg2H8wpPDYQJnVyu4fAAPHdOo1AJ5wI7ZTlDkh2JxxhuVatDcxQh4f0hLZ3euAKDHgpu8eWv0er+j1+LK2Bpg1ZwIhYVKk1UvZ83D/OXZx6chNK5GOuUV8uzXPjSjqREjFq1J++WOZvNZDjpAXAL6Qt+c2bjaDsFhj1bT7d8z2fD5Fzu/ofchv7P067+j+K0+q1jfpSSkQBkvzDsAYmCWOjcsRx6qnPIxGN9EwrpEVuXEmnIRHDKiuzFcoiBcg3EGLKxkGtQ7EJImZXpLK2+bCFTDybws3r4X9QvPueRqLqD/lj9QKVtco0WQXEsrG6RHlEVnkkThyQ3rpcmlYCMyLNTTvcDC5+Ju3wRPamtwhJtQOBcVXMLDYcw/iLYQtuKS6Svdt8BhZmTr2gd/FI7Zfj2lfN3Yxt/llyoJvBxXWmpeomK29Jk7s02aooX9Z9jJaP5Ye0ZYF1XL1QAOQBPCWzjMteOHBaU1XigJcguxV8aYUkBhfDdryZ5h0BB75tHcDDcbBmKa0N5B4OoJNXJKw1pzSv6MVxcVVXD7ftZBcBkBSwTT+MZ0C+2ammnZspADIKepNZWfwkmA9bMkdR7cHFbnnUO8To4OJqp2T8ITJbMSPASkcIMCf9+5p3pHEC87D10JUUsgeaHzvrBlFxqL7WXXrZ2rL3+TS6hYUmwXyeTfn+tdqNUf9SGZXkpYlND2zzVKyyLvl0y/NEZe1QUvrYonAfQR55KDG0yR3gFwfLyWjdkeA6DwrjSroRu9myx0BqVokWy96EkkjEBkSS2qHT0QdMlWoCsbzHiEzi2ZDzpVGhC2zIdkbEqA2ZQ5NM2oGQfsFh5fBQp+X9vU7rhzrckXOBNWML40o6A3v5HgO5V63yHbHsPRFAiVjsiZTvYGNMiWgbdcv7lMhErlE/E4BpvARGfQclYtioz6Antlx1NQ/xy1zShcb5H2Jyo7Wt6sXgajGFcSWdIU0tBBBChKai0DbqJykRi1Pud0ZEoLIsA5CIRu73EyVfyRWrrJ3FgIhxlTUd03bYgEDQNzqp4Vwha1AsJbRlTkQIPqQeB+zMwDUBPQWiEBGorFOlgIgzECASI5a9loGmBM3VEeSj/svcyN5dxZZ5NKc+WXqgAgJB3+3gSyPs5jIizQW6MxJdST0GQogcKwQQQqSjG9l7utREZyCYjH+wu2T8lkGx/PVD0qFROOg2Gf+vxoFcw2Vg1fmyApWz8sG1XRmRAVp3BAZebvbxGMgFqH/GQY+BQPX3+ouMOty6M9OdgdBk/LnukvFb8vkr7DysHks9oN0k488x7kraz0yPbM91Eq+Enl6R7UTma6qskyzhgYeyFz1oszwGgtVniWRv1Rh6YxyBrJPcJeNfrSTjH8cBkl27VpxY9t4u41ky/iM+LK7eDuSgMjtHF3KnRPZq3ZFWSl4Bz4Ds82Zueh4C4VavBpJcpWqMLLsa9aWSu2T88xgR3qJgclxtuv6ptg35O8izZPy/eA+1OgJZqlQzXWZEVjge1uGOpLcsebwwsnerz5sFhQDCrd7BhsRUo0Scjfo3JnfJ+JdQIqO5Rj2udoNHbpLxl/UsGf9PXqMck/EPU2RWd5YKcn4P8llSy6qSW3KsMLJ3R7E3CgqhsnjVOxr12JpIxEVlbfCCcbsD6jEeJ5W1yjRJ1lzpM652oyRZfqLe/ZKjyrpWzrNk/BvwUbEDAY+CF+FLNUg4CL0fcLFsoSlzyC2BPLHtWrsprTRU1m++vQsKobJY9eqhtEOOKutBHSDiAkTe7PfAdTRzvAqI/J0pVnMtXEJkjevup9SyN7KCZ66ka00OWUlL2QLrMmR5TCcWBTlIW3emt+xUmHxZ8j6/g4WRvekte7hW9o9a9ibUH+ti1NPYjKhzSWnMgOAWYXH81aIfwyB4Ii9x2jQG5DjOTW82nowfhntXOaaJtTmWniZqPKBjFltLg39HIB1pepzHQDDF9IGTHgOBJenTkzm1rWZAMGDt0RoX2ds8TeM0kxoy2atsMZwnexVHUT4RkL1KLIZR2dsizSUraTjp8+AXGDg4FdABxzX3aU1q79S7FBQXyFc17hdqcNF3nVZ1q5ns9d4ic1TW2dIt4Pl+3MTBITkA/OgT6yOQkwGMCG+Be0sfP5z5nuzo0IxJP6chkPQXGBGjWUmrNU91BrJIWYoAwzJOBWACpPsad+QtH5hFl38NKK5d3jJrAomuXP1+YYBMNO3Cs3essHseJQJuQD0YEScb8tcPGC/qdGxME59Qx59m3KZEeCFtcv6sPNXsrq1gQOY0tCEKEaM2JKZy0xQnIJCcKFCZrAIikG7HGqDhl/VJGo7aCOqjufQ1bMidytXuFQKIdR5Uv8Z5m665SARsiELE1ajLjxq6HJxmu20oq4gM0TDqdhc6VcEsCNPQqDMiho367YpNkh2BtCD/bYtOTEw5BHRQFiTgWlUY1xRUR1df0DTqhEhMYQYXUQy5PgRIBF9xRsQVyKNnOEfHxP3xyroMzXPsSXdcgMzind0gC5vHRCJnPFFZN8o3dlzHsIRVsWQJSjL8DJUrp+sd2eEjqA0ncrbt1lZZdypXTSgUkB9NnK1ezbXdGEJkFwdIYgPu4UuwoHkrEom160tnIF/zT4+NfJiRiHHZC9VeD3FKxn9XlpfhF9KinoSLOnWVpSnl3pHtIh6tMd/b21rJ+K1IpFCyd7MXd7NXcmw3Jr8HVp+neJDQxYlHd+SXHjRiZh5c+AkiQt/mAzmusXtHmll9P3ykn6C5bQwACQOnLMgqrQayhyhR/LJYlq8yoyv/oXVHojp31C59aJSgOVwDyFoIJbwTYQTIu2SPcvbqIztpVD2X/hnC7POJ8MiBFVcxK69fgh5ROEq58LbOQL7Rs/sfuOyGrAhWXUBMpO1eSVdRcwTyNemGKuY9vwY7sVhXIGP06d07GjakBLFd84IvGpW97ZXlj6bpqTxKSdd6CyanIXFJsd91nXU0UxtyZScgY/Ut7NOfzY1/rxuICSR8RquQ6y5AIISgDHwBb8nE5oxIKWcgTVN1ndpFn2VcIMUPo3cgS6+kHwiM6ICzcbd8XdVPpVPE5EmdQdqp8pKP3o5TdGUcA7PNXjMgY/V2u4ZKS2Rnhx0REK8faD7DVqE3nYFA2oA25HMEbvG0CyXSygnIs8k6T+1DemZOQOjCVPKTVpSIfiAw8bpHkjrl6qz+Czr18bkEYnah1y82ixtwEmMhcEme3cW65qHLB0YR9MToqOjKL6jTklIgwMNqwcN+grOOGGz4sD6uSBUVionm1pvet6C79TXyCATpBOK9iQWlZLTCBezUQIqbUWb1tLAFaoYgkaGOQJ55zK4s/JkRcIJzGkCMT8GAhjDU97BDezCNFxq/kYOONItdgODYA+ye0RYTXhkAAmv2tGufzfbfRWd0ZmCAQP5rJbD6ergsypWQTjk4Dw2NVFNcby8X/P5SmmyhRGAu5WYoI4JK+Qs8ukKEWD7r8w5A8P0YC4uWKEQGYjaxh/WQSGT5xik2IjIcY5ukDwgmy01uvA2JVEt3BCLdhnmCNuRi8l/ClWS+qP5IMcQKkHpww/c0jMeZBaiexfKlt8RbElWxXjxeJt6SydJ6JyA+MDqXi/FrTzsERhsC0oRIs6hMW/XbKZHPkEheF6w+oW6VGDuRXeTvEcz6oA7u6c2IHEeRyYigUp6OrzMjAvNFkhrIWJbh4V0VkQGYbyuhLnpmXy+PieYYEXKg2vqATMPqzO/hsTJaOcleicj2Aw0AdUFP6QM48vek4d2vBtIU+05XaPq8b+krOtq0yk7kTpXa/9iJTHWSvSvQrd46CgcZsl82JHslaRO7saz6XzAvr/wpEsntzIjgrDcjAklyYMeNzkRwLiUimBFBpTwFX2eFSFp1NRCW1lze7dtPReR9TJceX4cSKdciXUXkS0kfEGXxzeEY3JuR4QRkjiw/jmWdKuktaFzJw/NADeSRwy1ZR6v/AN93RuRe9Rr37EQuOgJhY/qMSE6cMSBVUxyJbKa5q6cjkZz/YPXxdXDWWyGygw5VnXYhAtteDGREOsO2E3B9qfxp4HZi7iSpgaBqghuz3/8dFZH30CWdEblWDrteG5eA5thp0gkETnw+PNUTvH92lb3gkoUBydgqSx0YvjIqIHCNl+235DtK5CNcJY8R+ad21Wg7EZfluzMXWm1EjNkQSXqpwJFIGCXyMRLJ6oDVx9WuC63qlY/hgb3CRuJCzilERnUHLZPe/01IwHuu60fQQ/2t6yKMYetq46YOHaNA0rqPhjv9Z9f1mLK1KwytWj7sCUY2rtcAQHG121xFT+wvIekHsq8rLNskz+5+wxXIs3Repyf4WecN7zqFXn8bByAFfd/FS+02Af76Y1dcaGpe12P2y4x/Yyi8CbvpZToD2dkVmkvr9K6njAOR3lEiUlj1YbT6OXh/nr6P1cf1mqis/BNZ1TZUhfkVC2SrHn2W1E5yAWKkrPKWDABxKg5AfAvYYI5DGe74hhgtzgvcOxZjQKT2yTLvFDV6zep4iO7Xde6Xu8BRsRoFcrqd3otxD0SK4m2y7P8QECl4kd5+yJ2+jg25d8dlt932KZP2DHfOAWYESO61r1vrvxYdQLbzNjn0fwmIJIWO2Jvk7lHPj179qjI18P8ABDmNAb865E4AAAAASUVORK5CYII=",MapTile={},os_clickBuildingObject=ViewerUtil.eventFactory("os_clickBuildingObject");!function(){"use strict";MapTile=function(viewer,eventCallback,options){this.viewer=viewer,this.options=options,this.eventCallback=eventCallback,this.viewer.EVENT.OS_BUILDING_CLICK="VIEWER_OS_BUILDING_CLICK",this.viewer.EVENT.UPDATE_URL="VIEWER_UPDATE_URL",ViewerUtil.onEvent("os_clickBuildingObject",this.os_clickBuildingObject.bind(this))},MapTile.prototype.initCallback=function(viewer){var self=this;viewer.onMouseUp(function(){self.appendMapTileByViewPoint()})},MapTile.prototype.updateSettings=function(settings){var self=this;settings&&settings.hasOwnProperty("mapTile")&&settings.mapTile.lat&&settings.mapTile.lon&&(settings.mapTile.lat=parseFloat(settings.mapTile.lat),settings.mapTile.lon=parseFloat(settings.mapTile.lon),settings.mapTile.y=parseInt(settings.mapTile.y),this.settings=settings,this.originBNG=OsGridRef.latLonToOsGrid(new LatLon(this.settings.mapTile.lat,this.settings.mapTile.lon)),this.meterPerPixel=1,this.mapSizes=[]);var options=this.options;options&&options.lat&&options.lon&&options.y&&setTimeout(function(){self.translateTo(options)},3e3)},MapTile.prototype.translateTo=function(options){if(!this.originBNG)return console.log("Translation aborted due to no origin lat,lon defined");var lat=options.lat,lon=options.lon,height=options.y,view=options.view||[.00028736474304142756,-.9987502603949663,-.0499783431347178],up=options.up||[.005742504650018704,.04997916927067853,-.9987337514469797];(!height||height<0)&&(height=500),this.viewer.setCamera([0,height,0],view,up);var mapImagePosInfo=this._getMapImagePosInfo(),mapXY=this._getSlippyTileLayerPoints(lat,lon,mapImagePosInfo.zoomLevel),nx=mapXY.x-mapImagePosInfo.slippyPoints.x,ny=mapXY.y-mapImagePosInfo.slippyPoints.y,osTargetPoint=OsGridRef.latLonToOsGrid(new LatLon(lat,lon)),mapImageCentreLatLon=new LatLon(this._tile2lat(mapXY.y,mapImagePosInfo.zoomLevel),this._tile2long(mapXY.x,mapImagePosInfo.zoomLevel)),osImagePoint=OsGridRef.latLonToOsGrid(mapImageCentreLatLon),mapSize=this.getMapSize(ny),dx=osTargetPoint.easting*this.meterPerPixel-(osImagePoint.easting*this.meterPerPixel+mapSize/2),dy=osImagePoint.northing*this.meterPerPixel-mapSize/2-osTargetPoint.northing*this.meterPerPixel,camX=this.getSumSizeForXRow(nx,ny)+mapImagePosInfo.offsetX+dx,camY=this.getSumSize(ny)+mapImagePosInfo.offsetY+dy;this.viewer.setCamera([camX,height,camY],view,up,[camX,0,camY]),this.appendMapTileByViewPoint()},MapTile.prototype.getMapSizeByYCoor=function(yCoor){return this.getMapSize(this.findMapTileNoByPos(yCoor))},MapTile.prototype.getMapSize=function(n){var nextN=n<0?n-1:n+1;return Math.abs(this.getSumSize(nextN)-this.getSumSize(n))};var scaleMapImages=!1;scaleMapImages?(MapTile.prototype.getSumSizeForXRow=function(n,y){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel],lat=this._tile2lat(mapImagePosInfo.slippyPoints.y+y,mapImagePosInfo.zoomLevel);return mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*n*this.meterPerPixel},MapTile.prototype.getSumSize=function(n){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel];if(0===n)return 0;if(1===n||n===-1){var lat=this._tile2lat(mapImagePosInfo.slippyPoints.y,mapImagePosInfo.zoomLevel);return this.mapSizes[0]=this.mapSizes[0]||mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*this.meterPerPixel,this.mapSizes[0]*n}var nextN;
if(nextN=n>=0?n-1:n+1,!this.mapSizes[nextN]){var lat=this._tile2lat(mapImagePosInfo.slippyPoints.y+nextN,mapImagePosInfo.zoomLevel);this.mapSizes[nextN]=mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*this.meterPerPixel}return(n>=0?1:-1)*this.mapSizes[nextN]+this.getSumSize(nextN)},MapTile.prototype.findMapTileNoByPos=function(pos){var n,mapSize_0=this.getSumSize(1)-this.getSumSize(0),mapSize_1=this.getSumSize(2)-this.getSumSize(1);if(mapSize_1>mapSize_0&&pos>0)for(var n=0;;){if(this.getSumSize(n)<=pos&&pos<this.getSumSize(n+1))break;n++}else for(var n=0;;){if(this.getSumSize(n)<=pos&&pos<this.getSumSize(n+1))break;n--}return n}):(MapTile.prototype.getSumSize=function(n){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel],lat=this._tile2lat(mapImagePosInfo.slippyPoints.y,mapImagePosInfo.zoomLevel);return mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*n*this.meterPerPixel},MapTile.prototype.findMapTileNoByPos=function(pos){return Math.floor(pos/this.getSumSize(1))},MapTile.prototype.getSumSizeForXRow=MapTile.prototype.getSumSize),MapTile.prototype._clearMapImagePosInfo=function(){this.mapPosInfo=null},MapTile.prototype._getMapImagePosInfo=function(){if(!this.mapPosInfo){var height=this.getLenFromCamToCentre(this.getViewAreaOnZPlane(),this.viewer.getCurrentViewpointInfo().position),zoomLevel=this.getZoomLevel(height),mPerPxTable={0:156543.03,1:78271.52,2:39135.76,3:19567.88,4:9783.94,5:4891.97,6:2445.98,7:1222.99,8:611.5,9:305.75,10:152.87,11:76.437,12:38.219,13:19.109,14:9.5546,15:4.7773,16:2.3887,17:1.1943,18:.5972},slippyPoints=this._getSlippyTileLayerPoints(this.settings.mapTile.lat,this.settings.mapTile.lon,zoomLevel),x=slippyPoints.x,y=slippyPoints.y,mapImgsize=mPerPxTable[zoomLevel]*Math.cos(this._degToRad(this._tile2lat(y,zoomLevel)))*256*this.meterPerPixel,osGridRef=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(y,zoomLevel),this._tile2long(x,zoomLevel))),offsetX=(osGridRef.easting-this.originBNG.easting)*this.meterPerPixel+mapImgsize/2,offsetY=(this.originBNG.northing-osGridRef.northing)*this.meterPerPixel+mapImgsize/2;this.mapPosInfo={x:x,y:y,offsetX:offsetX,offsetY:offsetY,zoomLevel:zoomLevel,slippyPoints:slippyPoints,mPerPxTable:mPerPxTable}}return this.mapPosInfo},MapTile.prototype._startMoveImages=function(){this._moveStep=10;var self=this;this._moveImagesListener=function(e){"ArrowUp"===e.code?self._moveMapImages(0,-self._moveStep):"ArrowLeft"===e.code?self._moveMapImages(-self._moveStep,0):"ArrowDown"===e.code?self._moveMapImages(0,self._moveStep):"ArrowRight"===e.code&&self._moveMapImages(self._moveStep,0)},document.addEventListener("keyup",this._moveImagesListener)},MapTile.prototype._stopMoveImages=function(){document.removeEventListener("keyup",this._moveImagesListener)},MapTile.prototype._moveMapImages=function(dx,dy){this.sumD=this.sumD||[0,0],this.imagesDoms.forEach(function(dom){var t=dom.getAttribute("translation").split(" ");t.forEach(function(number,i){t[i]=parseFloat(number)}),t[0]+=dx,t[2]+=dy,dom.setAttribute("translation",t.join(" "))}),this.sumD[0]+=dx,this.sumD[1]+=dy},MapTile.prototype._newOrigin=function(){var sumD=this.sumD;return OsGridRef.osGridToLatLon(OsGridRef(this.originBNG.easting-sumD[0],this.originBNG.northing+sumD[1]))},MapTile.prototype._setNewOrigin=function(){var sumD=this.sumD;this.viewer.originBNG=OsGridRef(this.originBNG.easting-sumD[0],this.originBNG.northing+sumD[1]),this.mapPosInfo=null,this.sumD=[0,0]},MapTile.prototype._moveMapImagesY=function(y){this.viewer.imagesDoms.forEach(function(dom){var t=dom.getAttribute("translation").split(" ");t.forEach(function(number,i){t[i]=parseFloat(number)}),t[1]=y,dom.setAttribute("translation",t.join(" "))})},MapTile.prototype._clearAllPlanes=function(){var self=this;this._planes&&this._planes.forEach(function(p){self.viewer.getScene().removeChild(p)}),this._planes=[]},MapTile.prototype._appendPlane=function(p){this._planes=this.planes||[],this._planes.push(p),this.viewer.getScene().appendChild(p)},MapTile.prototype._drawPlaneOnZ=function(coords,color){function less(a,b){if(a[0]-center[0]>=0&&b[0]-center[0]<0)return!0;if(a[0]-center[0]<0&&b[0]-center[0]>=0)return!1;if(a[0]-center[0]==0&&b[0]-center[0]==0)return a[2]-center[2]>=0||b[2]-center[2]>=0?a[2]>b[2]:b[2]>a[2];var det=(a[0]-center[0])*(b[2]-center[2])-(b[0]-center[0])*(a[2]-center[2]);if(det<0)return!0;if(det>0)return!1;var d1=(a[0]-center[0])*(a[0]-center[0])+(a[2]-center[2])*(a[2]-center[2]),d2=(b[0]-center[0])*(b[0]-center[0])+(b[2]-center[2])*(b[2]-center[2]);return d1>d2}var coordIndex="",center=[0,0,0];center[0]=(coords[0][0]+coords[1][0],(+coords[2][0]+coords[3][0])/4),center[2]=(coords[0][2]+coords[1][2],(+coords[2][2]+coords[3][2])/4),coords.sort(less);for(var i=0;i<coords.length;i++)coordIndex+=" "+i;coordIndex+=" -1";var coordsFlatten=[];coords.forEach(function(coord){coordsFlatten=coordsFlatten.concat(coord)});var containerNode=document.createElement("div");return containerNode.innerHTML="\t<shape>\t\t<appearance>\t\t\t<material diffuseColor='"+color.join(" ")+"' transparency='0.7'></material>\t\t</appearance>\t\t<IndexedFaceSet ccw='true' colorPerVertex='false' solid='false' coordIndex='"+coordIndex+"'>\t\t\t<coordinate point='"+coordsFlatten.join(" ")+"'></coordinate>\t\t</IndexedFaceSet>\t</shape>",containerNode.children[0]},MapTile.prototype.appendMapImage=function(ox,oy){var posInfo=this._getMapImagePosInfo(),x=posInfo.x,y=posInfo.y,offsetX=posInfo.offsetX,offsetY=posInfo.offsetY,mapHeight=this.settings.mapTile.y?this.settings.mapTile.y:0,size=this.getMapSize(oy);if(this.addedMapImages||(this.addedMapImages={}),this.imagesDoms||(this.imagesDoms=[]),this.addedMapImages[ox+","+oy])return!1;var dom=this.createMapImageTile(size,x+ox,y+oy,[offsetX+this.getSumSizeForXRow(ox,oy),mapHeight,offsetY+this.getSumSize(oy)]);return this.imagesDoms.push(dom),this.viewer.getScene().appendChild(dom),this.addedMapImages[ox+","+oy]=1,!0},MapTile.prototype.removeMapImages=function(){var self=this;this.imagesDoms&&this.imagesDoms.forEach(function(dom){self.viewer.getScene().removeChild(dom)}),this.imagesDoms=[],this.addedMapImages={},this.mapSizes=[]},MapTile.prototype.getLenFromCamToCentre=function(viewAreaCoors,camera){var centre=this.centreOfVecs(viewAreaCoors),lenToCentreVec=[camera[0]-centre[0],camera[1]-centre[1],camera[2]-centre[2]],len=this._vec3Len(lenToCentreVec);return len},MapTile.prototype.getZoomLevel=function(height){var self=this,yToZoomLevel=[{y:5e5,zoomLevel:7},{y:3e5,zoomLevel:8},{y:109e3,zoomLevel:9},{y:58800,zoomLevel:10},{y:30709,zoomLevel:11},{y:16800,zoomLevel:12},{y:8e3,zoomLevel:13},{y:4500,zoomLevel:14},{y:2e3,zoomLevel:15},{y:1e3,zoomLevel:16},{y:500,zoomLevel:17},{y:250,zoomLevel:18},{y:0,zoomLevel:18}];yToZoomLevel.forEach(function(map){map.y*=self.meterPerPixel});for(var zoomLevel,i=0;i<yToZoomLevel.length;i++)if(height>=yToZoomLevel[i].y){zoomLevel=yToZoomLevel[i].zoomLevel;break}return zoomLevel},MapTile.prototype.getViewAreaOnZPlane=function(){for(var vpInfo=this.viewer.getCurrentViewpointInfo(),fov=vpInfo.fov,camera=vpInfo.position,view_dir=vpInfo.view_dir,ratio=vpInfo.aspect_ratio,up=vpInfo.up,right=vpInfo.right,tanHalfFOV=Math.tan(fov/2),planeOffsetX=[1,-1,1,-1],planeOffsetY=[1,1,-1,-1],viewAreaCoors=[],i=0;i<planeOffsetX.length;i++){for(var X=planeOffsetX[i],Y=planeOffsetY[i],rayDirection=[],c=0;c<3;c++)rayDirection[c]=view_dir[c]+X*tanHalfFOV*right[c]+Y*(ratio/tanHalfFOV)*up[c];var gamma=camera[1]/-rayDirection[1];viewAreaCoors[i]=[];for(var c=0;c<3;c++)viewAreaCoors[i][c]=camera[c]+gamma*rayDirection[c]}return viewAreaCoors},MapTile.prototype.centreOfVecs=function(vectors){var centre=[];return vectors[0].forEach(function(value,i){centre[i]=0}),vectors.forEach(function(vector){vector.forEach(function(value,i){centre[i]+=value})}),centre.forEach(function(value,i){centre[i]=value/vectors.length}),centre},MapTile.prototype.isLookingToInf=function(viewAreaCoors){var farVec=[viewAreaCoors[1][0]-viewAreaCoors[0][0],viewAreaCoors[1][2]-viewAreaCoors[0][2]],nearVec=[viewAreaCoors[3][0]-viewAreaCoors[2][0],viewAreaCoors[3][2]-viewAreaCoors[2][2]];return!(this._hasSameSign(farVec[0],nearVec[0])&&this._hasSameSign(farVec[1],nearVec[1]))},MapTile.prototype.getLatLonOfViewArea=function(viewAreaCoors){var centrePoint=this.viewer.getCurrentViewpointInfo().position,mapImgPosInfo=this._getMapImagePosInfo(),mapXY=[this.findMapTileNoByPos(centrePoint[0]),this.findMapTileNoByPos(centrePoint[2])],dx=([mapImgPosInfo.offsetX+this.getSumSizeForXRow(mapXY[0],mapXY[1]),0,mapImgPosInfo.offsetY+this.getSumSize(mapXY[1])],centrePoint[0]-this.getSumSizeForXRow(mapXY[0],mapXY[1])-mapImgPosInfo.offsetX),dy=centrePoint[2]-this.getSumSize(mapXY[1])-mapImgPosInfo.offsetY,mapSize=this.getMapSize(mapXY[1]),osImagePoint=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(mapXY[1]+mapImgPosInfo.slippyPoints.y,this.zoomLevel),this._tile2long(mapXY[0]+mapImgPosInfo.slippyPoints.x,this.zoomLevel))),k=this.meterPerPixel,latlon=OsGridRef.osGridToLatLon(OsGridRef((dx+osImagePoint.easting*k+mapSize/2)/k,(osImagePoint.northing*k-mapSize/2-dy)/k));return latlon},MapTile.prototype.osCoorToSceneCoor=function(osCoor){return[osCoor.easting-this.originBNG.easting,this.originBNG.northing-osCoor.northing]},MapTile.prototype.triggerUpdateURLEvent=function(lat,lon,height,view,up){this.eventCallback(this.viewer.EVENT.UPDATE_URL,{at:[lat,lon,height].join(","),view:view,up:up})},MapTile.prototype.rotatePloygon=function(viewAreaCoors,centre,deg){return viewAreaCoors=JSON.parse(JSON.stringify(viewAreaCoors)),viewAreaCoors.forEach(function(coor){coor.forEach(function(value,i){coor[i]=coor[i]-centre[i]}),coor[0]=coor[0]*Math.cos(Math.PI)-coor[2]*Math.sin(deg),coor[2]=coor[0]*Math.sin(Math.PI)+coor[2]*Math.cos(deg),coor.forEach(function(value,i){coor[i]=coor[i]+centre[i]})}),viewAreaCoors},MapTile.prototype.appendMapTileByViewPoint=function(noDraw){function LenVec2D(vecA,vecB){return Math.sqrt(Math.pow(vecA[0]-vecB[0],2)+Math.pow(vecA[1]-vecB[1],2))}function getCoorOnAC(k){return[a[0]+k*(c[0]-a[0]),a[2]+k*(c[2]-a[2])]}function getCoorOnBD(k){return[b[0]+k*(d[0]-b[0]),b[2]+k*(d[2]-b[2])]}function getCoorVertical(kx,ky){var start,end;return start=getCoorOnAC(ky),end=getCoorOnBD(ky),[start[0]+kx*(end[0]-start[0]),start[1]+kx*(end[1]-start[1])]}function viewAreaIterate(options){for(var genStepX=options.genStepX,genStepY=options.genStepY,yCond=options.yCond,xCond=options.xCond,callback=options.callback,horVecLen=LenVec2D([a[0],a[2]],[c[0],c[2]]),stepY=genStepY(a,horVecLen),ky=-stepY;ky<=1+stepY&&yCond();ky+=stepY){for(var startCoor=getCoorVertical(0,ky),endCoor=getCoorVertical(1,ky),vertVecLen=LenVec2D(endCoor,startCoor),stepX=genStepX(startCoor,vertVecLen),kx=-stepX;kx<=1+stepX&&xCond();kx+=stepX){var coor=getCoorVertical(kx,ky);callback(coor),stepX=genStepX(coor,vertVecLen)}stepY=genStepY(startCoor,horVecLen)}}if(console.log("appendMapTileByViewPoint",this.originBNG),!this.originBNG)return void console.log("originBNG not found");var self=this,vpInfo=this.viewer.getCurrentViewpointInfo(),camera=vpInfo.position,viewAreaCoors=(this._getMapImagePosInfo(),this.getViewAreaOnZPlane()),lookingToInf=this.isLookingToInf(viewAreaCoors),len=this.getLenFromCamToCentre(viewAreaCoors,camera),zoomLevel=this.getZoomLevel(len);this.zoomLevel!==zoomLevel&&(this.removeMapImages(),this._clearMapImagePosInfo(),this.zoomLevel=zoomLevel);var viewAreaLatLon=this.getLatLonOfViewArea(viewAreaCoors),view_dir=this.viewer.getCurrentViewpointInfo().view_dir,up=this.viewer.getCurrentViewpointInfo().up;this.triggerUpdateURLEvent(viewAreaLatLon.lat,viewAreaLatLon.lon,camera[1],view_dir.join(","),up.join(","));var a,b,c,d;if(a=viewAreaCoors[3],b=viewAreaCoors[2],c=viewAreaCoors[1],d=viewAreaCoors[0],lookingToInf){var rotatedViewAreaCoors=this.rotatePloygon(viewAreaCoors,this.centreOfVecs([a,b]),Math.PI);a=rotatedViewAreaCoors[3],b=rotatedViewAreaCoors[2],c=rotatedViewAreaCoors[0],d=rotatedViewAreaCoors[1]}var mapImagesCount=0,maxImageCount=200,getStep=function(coor,vecLen){var yCoor=coor[1],imageSize=self.getMapSizeByYCoor(yCoor);return imageSize/vecLen/2},cond=function(){return mapImagesCount<maxImageCount};viewAreaIterate({genStepY:getStep,genStepX:getStep,yCond:cond,xCond:cond,callback:function(coor){var imageSize=self.getMapSizeByYCoor(coor[1]),mapImgX=Math.floor(coor[0]/imageSize),mapImgZ=Math.floor(coor[1]/imageSize),appended=self.appendMapImage(mapImgX,mapImgZ);appended&&mapImagesCount++}});var tileCount=0,maxTileCount=100,genStep=function(coor,vecLen){var tileSize=100*self.meterPerPixel;return tileSize/vecLen/2};cond=function(){return tileCount<maxTileCount},!noDraw&&this.shouldDraw3DBuildings(this.zoomLevel)&&viewAreaIterate({genStepY:genStep,genStepX:genStep,yCond:cond,xCond:cond,callback:function(coor){var osRef=new OsGridRef(self.originBNG.easting+coor[0]/self.meterPerPixel,self.originBNG.northing-coor[1]/self.meterPerPixel),osrefno=self._OSRefNo(osRef,3),appended=self.appendMapTile(osrefno);appended&&tileCount++}})},MapTile.prototype.shouldDraw3DBuildings=function(zoomLevel){return zoomLevel>=17},MapTile.prototype._hasSameSign=function(a,b){return a<=0&&b<=0||a>=0&&b>=0},MapTile.prototype._roundUpToTen=function(n){var roundUpPlace=10;return Math.ceil(n/roundUpPlace)*roundUpPlace},MapTile.prototype._OSRefNo=function(osRef,length){if(length<1||length>5)return console.log("length must be in range [1 - 5]");var osrefno=osRef.toString().split(" ");return osrefno[1]=osrefno[1].substring(0,length),osrefno[2]=osrefno[2].substring(0,length),osrefno=osrefno.join("")},MapTile.prototype._tile2long=function(x,z){return x/Math.pow(2,z)*360-180},MapTile.prototype._tile2lat=function(y,z){var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},MapTile.prototype._degToRad=function(degrees){return degrees*Math.PI/180},MapTile.prototype._getSlippyTileLayerPoints=function(lat_deg,lng_deg,zoom){var x=Math.floor((lng_deg+180)/360*Math.pow(2,zoom)),y=Math.floor((1-Math.log(Math.tan(lat_deg*Math.PI/180)+1/Math.cos(lat_deg*Math.PI/180))/Math.PI)/2*Math.pow(2,zoom)),layerPoint={x:x,y:y};return layerPoint},MapTile.prototype.os_clickBuildingObject=function(objEvent){objEvent.partID&&this.eventCallback(this.viewer.EVENT.OS_BUILDING_CLICK,{id:objEvent.partID})},MapTile.prototype.appendMapTile=function(osGridRef){if(!this.originBNG,this.addedTileRefs=this.addedTileRefs||[],this.addedTileRefs.indexOf(osGridRef)!==-1)return!1;this.addedTileRefs.push(osGridRef);var gltf=document.createElement("gltf");gltf.setAttribute("onclick","os_clickBuildingObject(event)"),gltf.setAttribute("url",server_config.apiUrl(server_config.MAP_API,"os/buildings.gltf?method=osgrid&osgridref="+osGridRef+"&draw=1"));var translate=[0,0,0],osCoor=OsGridRef.parse(osGridRef),mapImagePosInfo=this._getMapImagePosInfo(),tileLatLon=OsGridRef.osGridToLatLon(osCoor),correspondingMapTile=this._getSlippyTileLayerPoints(tileLatLon.lat,tileLatLon.lon,mapImagePosInfo.zoomLevel),y=correspondingMapTile.y-mapImagePosInfo.slippyPoints.y,mapSize=this.getMapSize(y),corMapTileBNG=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(correspondingMapTile.y,mapImagePosInfo.zoomLevel),this._tile2long(correspondingMapTile.x,mapImagePosInfo.zoomLevel))),dx=osCoor.easting*this.meterPerPixel-(corMapTileBNG.easting*this.meterPerPixel+mapSize/2),dy=corMapTileBNG.northing*this.meterPerPixel-mapSize/2-osCoor.northing*this.meterPerPixel;translate[0]=(correspondingMapTile.x-mapImagePosInfo.slippyPoints.x)*mapSize+dx+mapImagePosInfo.offsetX,translate[2]=(correspondingMapTile.y-mapImagePosInfo.slippyPoints.y)*mapSize+dy+mapImagePosInfo.offsetY;var scale=document.createElement("Transform"),mPerPx=this.meterPerPixel;scale.setAttribute("scale",[mPerPx,mPerPx,mPerPx].join(",")),scale.appendChild(gltf);var transform=document.createElement("transform");return transform.setAttribute("translation",translate.join(" ")),transform.appendChild(scale),this.viewer.getScene().appendChild(transform),transform},MapTile.prototype.createMapImageTile=function(size,x,y,t){var shape=document.createElement("Shape"),app=document.createElement("Appearance"),it=document.createElement("ImageTexture"),mapImagePosInfo=this._getMapImagePosInfo();document.createElement("material");it.setAttribute("url",server_config.apiUrl(server_config.MAP_API,"os/map-images/Outdoor/"+mapImagePosInfo.zoomLevel+"/"+x+"/"+y+".png")),it.setAttribute("crossOrigin","use-credentials"),app.appendChild(it),shape.appendChild(app);var plane=document.createElement("Plane");plane.setAttribute("center","0, 0"),plane.setAttribute("size",[size,size].join(",")),plane.setAttribute("solid",!1),plane.setAttribute("lit",!1),shape.appendChild(plane);var rotate=document.createElement("Transform");rotate.setAttribute("rotation","1,0,0,4.7124"),rotate.appendChild(shape);var translate=document.createElement("Transform");return translate.setAttribute("translation",t.join(" ")),translate.appendChild(rotate),translate},MapTile.prototype._vec3Len=function(vec){return Math.sqrt(Math.pow(vec[0],2)+Math.pow(vec[1],2)+Math.pow(vec[2],2))}}();var MeasureTool={};!function(){"use strict";MeasureTool=function(viewer){var self=this;this.viewer=viewer,this.lineStarted=!1,this.inMeasureMode=!1,this.measureCoords=[null,null],this.measureLine=null,this.measureLineCoords=null,this.measureMouseMove=function(event){var viewArea=self.viewer.getViewArea(),pickingInfo=viewArea._pickingInfo;self.measureCoords[1]=pickingInfo.pickPos,self.updateMeasureLine()},this.measureMouseDown=function(event){var viewArea=self.viewer.getViewArea(),pickingInfo=viewArea._pickingInfo;self.lineStarted?(self.measureCoords[1]=pickingInfo.pickPos,self.lineStarted=!1,self.viewer.offMouseMove(self.measureMouseMove)):(self.measureCoords[0]=pickingInfo.pickPos,self.lineStarted=!0,self.createMeasureLine(),self.viewer.onMouseMove(self.measureMouseMove))}},MeasureTool.prototype.measureMode=function(on){var self=this,element=document.getElementById("x3dom-default-canvas");on?(self.inMeasureMode=!0,element.style.cursor="crosshair",self.viewer.onMouseDown(self.measureMouseDown),self.viewer.onMouseMove(self.measureMouseMove),self.viewer.highlightObjects(),self.viewer.disableClicking()):(self.inMeasureMode=!1,self.deleteMeasureLine(),element.style.cursor="-webkit-grab",self.viewer.offMouseDown(self.measureMouseDown),self.viewer.offMouseMove(self.measureMouseMove),self.viewer.enableClicking())},MeasureTool.prototype.createMeasureLine=function(){var self=this;null!==self.measureLine&&self.deleteMeasureLine();var lineDepth,lineApp,line,colors,line=document.createElement("LineSet");line.setAttribute("vertexCount",8),self.measureLineCoords=document.createElement("Coordinate"),self.measureLineCoords.setAttribute("point","0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0"),line.appendChild(self.measureLineCoords);var colors=document.createElement("Color");colors.setAttribute("color","0 1 0,0 1 0,1 0 0,1 0 0,0 0 1,0 0 1, 1 1 1, 1 1 1"),line.appendChild(colors);var lineDepth=document.createElement("DepthMode");lineDepth.setAttribute("depthFunc","ALWAYS");var lineApp=document.createElement("Appearance");lineApp.appendChild(lineDepth);var lineProperties=document.createElement("LineProperties");lineProperties.setAttribute("linewidthScaleFactor",3),lineApp.appendChild(lineProperties),self.measureLine=document.createElement("Shape"),self.measureLine.appendChild(lineApp),self.measureLine.appendChild(line),self.viewer.scene.appendChild(self.measureLine)},MeasureTool.prototype.updateMeasureLine=function(){var self=this;if(self.lineStarted){var coordString="";if(null!==self.measureCoords[0]&&null!==self.measureCoords[1]){var startCoordArray=self.measureCoords[0].toGL(),endCoordArray=self.measureCoords[1].toGL();coordString+=startCoordArray.join(" ")+",",coordString+=startCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=startCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray.join(" ")+",",coordString+=endCoordArray.join(" ")+",",coordString+=startCoordArray.join(" "),self.measureLineCoords.setAttribute("point",coordString)}}},MeasureTool.prototype.deleteMeasureLine=function(){var self=this;null!==self.measureLine&&(self.measureLine.parentElement.removeChild(self.measureLine),self.measureLine=null,self.measureLineCoords=null)}}();var Pin={};!function(){"use strict";var GREY_PIN=[.5,.5,.5],PIN_RADIUS=.25,PIN_HEIGHT=1,GHOST_OPACITY=.1,OPAQUE_OPACITY=1-GHOST_OPACITY;Pin=function(id,element,trans,position,norm,scale,colours,viewpoint){var self=this;self.id=id,self.highlighted=!1,self.element=element,self.trans=trans,self.scale=scale,self.viewpoint=viewpoint,self.ghostConeIsHighlighted=null,self.coneIsHighlighted=null,self.ghostPinHeadNCol=null,self.pinHeadNCol=null,self.ghostPinHeadColour=null,self.pinHeadColour=null,self.ghostPinHeadIsHighlighted=null,self.pinHeadIsHighlighted=null,self.coneDepth=null,self.pinHeadDepth=null,self.numColours=0,"undefined"==typeof colours?(self.numColours=1,colours=[1,0,0]):"number"==typeof colours[0]?self.numColours=1:self.numColours=colours.length,self.colours=colours;var parent=document.createElement("MatrixTransform");parent.setAttribute("id",self.id),parent.setAttribute("matrix",trans.toGL().toString()),self.modelTransform=document.createElement("Transform");var axisAngle=ViewerUtil.rotAxisAngle([0,1,0],norm);self.modelTransform.setAttribute("rotation",axisAngle.toString()),self.modelTransform.setAttribute("translation",position.join(" ")),parent.appendChild(self.modelTransform),colours=colours.join(" "),this.createBasicPinShape(self.modelTransform,"ALWAYS",GHOST_OPACITY,!0),this.createBasicPinShape(self.modelTransform,"LESS",OPAQUE_OPACITY,!1),self.element.appendChild(parent)},Pin.prototype.remove=function(id){var pinPlacement=document.getElementById(id);null!==pinPlacement&&pinPlacement.parentElement.removeChild(pinPlacement)},Pin.prototype.changeColour=function(colours){var self=this;"undefined"!=typeof colours&&colours.length||(colours=GREY_PIN),"number"==typeof colours[0]?self.numColours=1:self.numColours=colours.length,self.colours=colours,self.pinHeadNCol.setAttribute("value",self.numColours),self.pinHeadColour.setAttribute("value",self.colours.join(" ")),self.ghostPinHeadNCol.setAttribute("value",self.numColours),self.ghostPinHeadColour.setAttribute("value",self.colours.join(" "))},Pin.prototype.highlight=function(){var self=this;self.highlighted=!self.highlighted;var depthMode=self.highlighted?"ALWAYS":"LESS",highlighted=self.highlighted.toString();self.pinHeadIsHighlighted.setAttribute("value",highlighted),self.ghostPinHeadIsHighlighted.setAttribute("value",highlighted),self.coneIsHighlighted.setAttribute("value",highlighted),self.ghostConeIsHighlighted.setAttribute("value",highlighted),self.pinHeadDepth.setAttribute("depthFunc",depthMode),self.coneDepth.setAttribute("depthFunc",depthMode)},Pin.prototype.createBasicPinShape=function(parent,depthMode,opacity,ghostPin){var self=this,ORANGE_HIGHLIGHT="1.0000 0.7 0.0",coneHeight=PIN_HEIGHT-2*PIN_RADIUS,pinshape=document.createElement("Group");pinshape.setAttribute("onclick","clickPin(event)");var pinshapeapp=document.createElement("Appearance"),pinshapescale=document.createElement("Transform");pinshapescale.setAttribute("scale",self.scale+" "+self.scale+" "+self.scale),pinshape.appendChild(pinshapescale);var pinshapeconetrans=document.createElement("Transform");pinshapeconetrans.setAttribute("translation","0.0 "+.5*coneHeight+" 0.0"),pinshapescale.appendChild(pinshapeconetrans);var pinshapeconerot=document.createElement("Transform");pinshapeconerot.setAttribute("rotation","1.0 0.0 0.0 3.1416"),pinshapeconetrans.appendChild(pinshapeconerot);var pinshapeconeshape=document.createElement("Shape");pinshapeconerot.appendChild(pinshapeconeshape);var pinshapecone=document.createElement("Cone");pinshapecone.setAttribute("bottomRadius",(.5*PIN_RADIUS).toString()),pinshapecone.setAttribute("height",coneHeight.toString());var coneApp=pinshapeapp.cloneNode(!0),coneshader=document.createElement("ComposedShader");coneApp.appendChild(coneshader);var coneMat=document.createElement("Material");coneMat.setAttribute("diffuseColor","1.0 1.0 1.0"),coneMat.setAttribute("transparency",opacity),coneApp.appendChild(coneMat);var conehighlight=document.createElement("field");conehighlight.setAttribute("type","SFVec3f"),conehighlight.setAttribute("name","highlightColor"),conehighlight.setAttribute("value",ORANGE_HIGHLIGHT),coneshader.appendChild(conehighlight);var coneishighlighted=document.createElement("field");coneishighlighted.setAttribute("type","SFBool"),coneishighlighted.setAttribute("name","highlightPin"),coneishighlighted.setAttribute("value","false"),coneshader.appendChild(coneishighlighted),ghostPin?self.ghostConeIsHighlighted=coneishighlighted:self.coneIsHighlighted=coneishighlighted;var coneuseclipplane=document.createElement("field");coneuseclipplane.setAttribute("type","SFBool"),coneuseclipplane.setAttribute("name","useClipPlane"),coneuseclipplane.setAttribute("value",ghostPin),coneshader.appendChild(coneuseclipplane);var conevert=document.createElement("ShaderPart");conevert.setAttribute("type","VERTEX"),conevert.setAttribute("USE","noShadeVert"),coneshader.appendChild(conevert);var conefrag=document.createElement("ShaderPart");conefrag.setAttribute("type","FRAGMENT"),conefrag.setAttribute("USE","noShadeFrag"),coneshader.appendChild(conefrag);var conedepth=document.createElement("DepthMode");ghostPin||(self.coneDepth=conedepth),conedepth.setAttribute("depthFunc",depthMode),conedepth.setAttribute("enableDepthTest",(!ghostPin).toString()),coneApp.appendChild(conedepth),pinshapeconeshape.appendChild(coneApp),pinshapeconeshape.appendChild(pinshapecone);var pinshapeballtrans=document.createElement("Transform");pinshapeballtrans.setAttribute("translation","0.0 "+1.4*coneHeight+" 0.0"),pinshapescale.appendChild(pinshapeballtrans);var pinshapeballshape=document.createElement("Shape");pinshapeballtrans.appendChild(pinshapeballshape);var pinshapeball=document.createElement("Sphere");pinshapeball.setAttribute("radius",PIN_RADIUS.toString());var ballApp=pinshapeapp.cloneNode(!0);pinshapeballshape.appendChild(pinshapeball),pinshapeballshape.appendChild(ballApp);var pinheadMat=document.createElement("Material");pinheadMat.setAttribute("diffuseColor","1.0 1.0 1.0"),pinheadMat.setAttribute("transparency",opacity),ballApp.appendChild(pinheadMat);var pinshader=document.createElement("ComposedShader");ballApp.appendChild(pinshader);var pinheadradius=document.createElement("field");pinheadradius.setAttribute("type","SFFloat"),pinheadradius.setAttribute("name","radius"),pinheadradius.setAttribute("value",PIN_RADIUS.toString()),pinshader.appendChild(pinheadradius);var pinheadncol=document.createElement("field");pinheadncol.setAttribute("type","SFFloat"),pinheadncol.setAttribute("name","numColours"),pinheadncol.setAttribute("value",self.numColours),pinshader.appendChild(pinheadncol),ghostPin?self.ghostPinHeadNCol=pinheadncol:self.pinHeadNCol=pinheadncol;var pinheadcolor=document.createElement("field");pinheadcolor.setAttribute("type","MFFloat"),pinheadcolor.setAttribute("name","multicolours"),pinheadcolor.setAttribute("value",self.colours),pinshader.appendChild(pinheadcolor),ghostPin?self.ghostPinHeadColour=pinheadcolor:self.pinHeadColour=pinheadcolor;var pinheadhighlight=document.createElement("field");pinheadhighlight.setAttribute("type","SFVec3f"),pinheadhighlight.setAttribute("name","highlightColor"),pinheadhighlight.setAttribute("value",ORANGE_HIGHLIGHT),pinshader.appendChild(pinheadhighlight);var pinheadishighlighted=document.createElement("field");pinheadishighlighted.setAttribute("type","SFBool"),pinheadishighlighted.setAttribute("name","highlightPin"),pinheadishighlighted.setAttribute("value","false"),pinshader.appendChild(pinheadishighlighted),ghostPin?self.ghostPinHeadIsHighlighted=pinheadishighlighted:self.pinHeadIsHighlighted=pinheadishighlighted;var pinuseclipplane=document.createElement("field");pinuseclipplane.setAttribute("type","SFBool"),pinuseclipplane.setAttribute("name","useClipPlane"),pinuseclipplane.setAttribute("value",(!ghostPin).toString()),pinshader.appendChild(pinuseclipplane);var pinvert=document.createElement("ShaderPart");pinvert.setAttribute("type","VERTEX"),pinvert.setAttribute("USE","multiVert"),pinshader.appendChild(pinvert);var pinfrag=document.createElement("ShaderPart");pinfrag.setAttribute("type","FRAGMENT"),pinfrag.setAttribute("USE","multiFrag"),pinshader.appendChild(pinfrag);var pinheaddepth=document.createElement("DepthMode");ghostPin||(self.pinHeadDepth=pinheaddepth),pinheaddepth.setAttribute("depthFunc",depthMode),pinheaddepth.setAttribute("enableDepthTest",(!ghostPin).toString()),ballApp.appendChild(pinheaddepth),parent.appendChild(pinshape)}}();var PinShader=null;!function(){"use strict";PinShader=function(element){var pinheadshader=document.createElement("ComposedShader");pinheadshader.setAttribute("ID","pinHeadShader");var pinvert=document.createElement("ShaderPart");pinvert.setAttribute("type","VERTEX"),pinvert.setAttribute("DEF","multiVert"),pinvert.textContent="attribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInverse;\nuniform mat4 modelViewProjectionMatrix;\nuniform float radius;\n\nvarying float fragColourSelect;\nvarying vec3 fragNormal;\nvarying vec3 fragEyeVector;\nvarying vec4 fragPosition;\nvarying vec3 pinPosition;\nvoid main()\n{\n\tfragEyeVector = vec3(0.2, 0.2, 0.2);\n\tfragNormal = normal;\n\tfragColourSelect = 1.0 - ((position.y / radius) + 1.0) / 2.0;\n\t\n\tpinPosition = position;\n\tfragPosition = (modelViewMatrix * vec4(position, 1.0));\n\tgl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",pinheadshader.appendChild(pinvert);var pinfrag=document.createElement("ShaderPart");pinfrag.setAttribute("type","FRAGMENT"),pinfrag.setAttribute("DEF","multiFrag");var fragSource="#ifdef GL_FRAGMENT_PRECISION_HIGH\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n";fragSource+="\nuniform float numColours;\nuniform float ambientIntensity;\nuniform float transparency;\nvarying float fragColourSelect;\nvarying vec3 fragNormal;\nvarying vec3 fragEyeVector;\nvarying vec4 fragPosition;\nvarying vec3 pinPosition;\nuniform vec3 multicolours[20];\nuniform mat4 viewMatrixInverse;\nuniform bool highlightPin;\nuniform vec3 highlightColor;\nuniform bool useClipPlane;\n",fragSource+=x3dom.shader.light(1),fragSource+=x3dom.shader.clipPlanes(1),fragSource+="\nvoid main()\n{\n\tint colourSelected = int(floor(fragColourSelect * numColours));\n\tvec3 eye = -pinPosition.xyz;\n\tvec3 normal = normalize(fragNormal);\n\tvec3 ads = lighting(light0_Type, light0_Location, light0_Direction, light0_Color, light0_Attenuation, light0_Radius, light0_Intensity, light0_AmbientIntensity, light0_BeamWidth, light0_CutOffAngle, normalize(fragNormal), eye, 0.0, ambientIntensity);\n\tvec3 ambient = light0_Color * ads.r;\n\tvec3 diffuse = light0_Color * ads.g;\n\tambient = max(ambient, 0.0);\n\tdiffuse = max(diffuse, 0.0);\n\tvec3 pinColor = vec3(0.0,0.0,0.0);\n\tif(useClipPlane) {\n\t\tcalculateClipPlanes();\n\t}\n\tfor(int colidx = 0; colidx < 20; colidx++) {\n\t\tif(colidx == colourSelected) {\n\t\t\tpinColor = multicolours[colidx];\n\t\t\tpinColor = clamp(pinColor, 0.0, 1.0);\n\t\t\tif (highlightPin) {\n\t\t\t\tpinColor = highlightColor;\n\t\t\t}\n\t\t\tgl_FragColor = vec4(pinColor, transparency);\n\t\t}\n\t}\n}\n\n",pinfrag.textContent=fragSource,pinheadshader.appendChild(pinfrag);var coneshader=document.createElement("ComposedShader");coneshader.setAttribute("id","coneShader");var conevert=document.createElement("ShaderPart");conevert.setAttribute("type","VERTEX"),conevert.setAttribute("DEF","noShadeVert");var conevertSource="attribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrixInverse;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\n\nvarying vec4 fragPosition;\nvoid main()\n{\n\tfragPosition = (modelViewMatrix * vec4(position, 1.0));\n\tgl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}";
conevert.textContent=conevertSource,coneshader.appendChild(conevert);var conefrag=document.createElement("ShaderPart");conefrag.setAttribute("type","FRAGMENT"),conefrag.setAttribute("DEF","noShadeFrag");var coneFragSource="#ifdef GL_FRAGMENT_PRECISION_HIGH\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec3 diffuseColor;\nuniform float transparency;\nuniform bool highlightPin;\nuniform vec3 highlightColor;\nuniform mat4 viewMatrixInverse;\nuniform bool useClipPlane;\nvarying vec4 fragPosition;\n";coneFragSource+=x3dom.shader.clipPlanes(1),coneFragSource+="\nvoid main()\n{\n\tvec3 diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n\tif(useClipPlane) {\n\t\tcalculateClipPlanes();\n\t}\n\tif (highlightPin) {\n\t\tdiffuseColor = highlightColor;\n\t}\n\tgl_FragColor = vec4(diffuseColor, transparency);\n}",conefrag.textContent=coneFragSource,coneshader.appendChild(conefrag),element.appendChild(pinheadshader),element.appendChild(coneshader)}}();var bgroundClick,clickObject,clickPin,onMouseOver,onMouseDown,onMouseUp,onMouseMove,onViewpointChange,onLoaded,runtimeReady;x3dom.runtime.ready=runtimeReady;var Viewer={},GOLDEN_RATIO=(1+Math.sqrt(5))/2;!function(){"use strict";bgroundClick=ViewerUtil.eventFactory("bgroundClicked"),clickObject=ViewerUtil.eventFactory("clickObject"),clickPin=ViewerUtil.eventFactory("pinClick"),onMouseOver=ViewerUtil.eventFactory("onMouseOver"),onMouseDown=ViewerUtil.eventFactory("onMouseDown"),onMouseUp=ViewerUtil.eventFactory("onMouseUp"),onMouseMove=ViewerUtil.eventFactory("onMouseMove"),onViewpointChange=ViewerUtil.eventFactory("onViewpointChange"),onLoaded=ViewerUtil.eventFactory("onLoaded"),runtimeReady=ViewerUtil.eventFactory("runtimeReady"),Viewer=function(name,element,manager,callback,errCallback){var self=this;name?this.name=name:this.name="viewer",callback=callback?callback:function(){},errCallback=errCallback?errCallback:function(){},this.element=element,this.inline=null,this.runtime=null,this.fullscreen=!1,this.multiSelectMode=!1,this.pinDropMode=!1,this.clickingEnabled=!1,this.avatarRadius=.5,this.pinSizeFromSettings=!1,this.pinSize=1,this.defaultShowAll=!0,this.zNear=-1,this.zFar=-1,this.manager=manager,this.initialized=!1,this.downloadsLeft=1,this.defaultNavMode=this.NAV_MODES.TURNTABLE,this.selectionDisabled=!1,this.account=null,this.project=null,this.branch=null,this.revision=null,this.modelString=null,this.rootName="model",this.inlineRoots={},this.multipartNodes=[],this.multipartNodesByProject={},this.setHandle=function(handle){this.handle=handle},this.logos=[],this.logoClick=function(){},this.addLogo=function(){self.logoGroup||(self.logoGroup=document.createElement("div"),self.logoGroup.style.width="100%",self.element.appendChild(self.logoGroup));var numLogos=this.logos.length+1,perLogo=Math.floor(100/numLogos),widthPercentage=perLogo+"%",logo=document.createElement("div");logo.style.position="absolute",logo.style["z-index"]=2,logo.style["text-align"]="center",logo.style.width="250px",logo.style.top="10px",logo.style.left=0,logo.style.right=0,logo.style.margin="auto",logo.addEventListener("click",self.logoClick);var logoImage=document.createElement("img");logoImage.setAttribute("src",logo_string),logoImage.setAttribute("style","width: 100%;"),logoImage.textContent=" ",logo.appendChild(logoImage),self.updateLogoWidth(widthPercentage),self.logoGroup.appendChild(logo),self.logos.push(logo)},this.removeLogo=function(){if(self.logos.length){var numLogos=this.logos.length-1,widthPercentage=Math.floor(100/numLogos)+"%";self.logos[numLogos].parentNode.removeChild(self.logos[numLogos]),self.logos.splice(numLogos,1),self.updateLogoWidth(widthPercentage)}},this.updateLogoWidth=function(widthPercentage){for(var i=0;i<self.logos.length;i++)self.logos[i].style.width=widthPercentage},this.handleKeyPresses=function(e){e.charCode==="r".charCodeAt(0)?(self.reset(),self.setApp(null),self.setNavMode(self.NAV_MODES.WALK),self.disableClicking()):e.charCode==="a".charCodeAt(0)?(self.showAll(),self.enableClicking()):e.charCode==="u".charCodeAt(0)&&self.revealAll()},this.init=function(options){self.initialized||(self.options=options,x3dom.runtime.ready=self.initRuntime,self.addLogo(),self.viewer=document.createElement("x3d"),self.viewer.setAttribute("id",self.name),self.viewer.setAttribute("xmlns","http://www.web3d.org/specification/x3d-namespace"),self.viewer.setAttribute("keysEnabled","true"),self.viewer.setAttribute("disableTouch","true"),self.viewer.addEventListener("mousedown",onMouseDown),self.viewer.addEventListener("mouseup",onMouseUp),self.viewer.addEventListener("mousemove",onMouseMove),self.viewer.style["pointer-events"]="all",self.viewer.className="viewer",self.element.appendChild(self.viewer),self.scene=document.createElement("Scene"),self.scene.setAttribute("onbackgroundclicked","bgroundClick(event);"),self.viewer.appendChild(self.scene),self.pinShader=new PinShader(self.scene),self.bground=null,self.currentNavMode=null,self.createBackground(),self.environ=document.createElement("environment"),self.environ.setAttribute("frustumCulling","true"),self.environ.setAttribute("smallFeatureCulling","true"),self.environ.setAttribute("smallFeatureThreshold",5),self.environ.setAttribute("occlusionCulling","true"),self.environ.setAttribute("sorttrans","true"),self.environ.setAttribute("gammaCorrectionDefault","linear"),self.scene.appendChild(self.environ),self.setAmbientLight(),self.createViewpoint(self.name+"_default"),self.nav=document.createElement("navigationInfo"),self.nav.setAttribute("headlight","false"),self.setNavMode(self.defaultNavMode),self.scene.appendChild(self.nav),self.loadViewpoint=self.name+"_default",self.viewer.addEventListener("keypress",self.handleKeyPresses),self.initialized=!0,manager&&manager.registerMe(self),self.enableClicking(),self.plugins=self.options.plugins,Object.keys(self.plugins).forEach(function(key){self.plugins[key].initCallback&&self.plugins[key].initCallback(self)}),callback(self.EVENT.READY,{name:self.name,model:self.modelString}))},this.destroy=function(){self.currentViewpoint&&self.currentViewpoint._xmlNode.removeEventListener("viewpointChanged",self.viewPointChanged),self.viewer.removeEventListener("mousedown",self.managerSwitchMaster),self.removeLogo(),self.viewer.removeEventListener("keypress",self.handleKeyPresses),self.viewer.parentNode.removeChild(self.viewer),ViewerUtil.offEventAll(),self.viewer=void 0},this.initRuntime=function(){this.doc.id===self.name&&(self.runtime=this,callback(self.EVENT.RUNTIME_READY,{name:self.name})),self.runtime.enterFrame=function(){self.gyroOrientation&&self.gyroscope(self.gyroOrientation.alpha,self.gyroOrientation.beta,self.gyroOrientation.gamma)},self.showAll=function(){self.runtime.fitAll(),self.getViewArea()._flyMat=null},ViewerUtil.onEvent("onLoaded",function(objEvent){self.loadViewpoint&&self.setCurrentViewpoint(self.loadViewpoint);var targetParent=objEvent.target._x3domNode._nameSpace.doc._x3dElem;if(self.loadViewpoints(),targetParent===self.viewer&&self.setDiffColors(null),"INLINE"===objEvent.target.tagName.toUpperCase())self.inlineRoots[objEvent.target.nameSpaceName]=objEvent.target;else if("MULTIPART"===objEvent.target.tagName.toUpperCase()&&self.multipartNodes.indexOf(objEvent.target)===-1){var nameSpaceName=objEvent.target._x3domNode._nameSpace.name;self.multipartNodesByProject.hasOwnProperty(nameSpaceName)||(self.multipartNodesByProject[nameSpaceName]={});var multipartName=objEvent.target.getAttribute("id"),multipartNameParts=multipartName.split("__"),multipartID=multipartNameParts[multipartNameParts.length-1];self.multipartNodesByProject[nameSpaceName][multipartID]=objEvent.target,self.multipartNodes.push(objEvent.target)}if(self.downloadsLeft+=objEvent.target.querySelectorAll("[load]").length-1,!self.pinSizeFromSettings){var sceneBBox=self.getScene()._x3domNode.getVolume(),sceneSize=sceneBBox.max.subtract(sceneBBox.min).length();self.pinSize=sceneSize/20}var options=self.options;options.showAll&&self.showAll(),self.downloadsLeft||callback(self.EVENT.LOADED)})},this.setAmbientLight=function(lightDescription){if(self.light){var i=0,attributeNames=[];for(i=0;i<self.light.attributes.length;i++)attributeNames.push(self.light.attributes[i].name);for(i=0;i<attributeNames.length;i++)self.light.removeAttribute(attributeNames[i])}else self.light=document.createElement("directionallight"),self.scene.appendChild(self.light);if(lightDescription)for(var attr in lightDescription)lightDescription.hasOwnProperty(attr)&&self.light.setAttribute(attr,lightDescription[attr]);else self.light.setAttribute("color","0.714, 0.910, 0.953"),self.light.setAttribute("direction","0, -0.9323, -0.362"),self.light.setAttribute("global","true"),self.light.setAttribute("ambientIntensity","0.8"),self.light.setAttribute("shadowIntensity",0)},this.createBackground=function(colourDescription){if(self.bground){var i=0,attributeNames=[];for(i=0;i<self.bground.attributes.length;i++)attributeNames.push(self.bground.attributes[i].name);for(i=0;i<attributeNames.length;i++)self.bground.removeAttribute(attributeNames[i])}else self.bground=document.createElement("background"),self.scene.appendChild(self.bground);if(colourDescription){self.bground.setAttribute("DEF",self.name+"_bground");for(var attr in colourDescription)colourDescription.hasOwnProperty(attr)&&self.bground.setAttribute(attr,colourDescription[attr])}else self.bground.setAttribute("DEF",self.name+"_bground"),self.bground.setAttribute("skyangle","0.9 1.5 1.57"),self.bground.setAttribute("skycolor","0.21 0.18 0.66 0.2 0.44 0.85 0.51 0.81 0.95 0.83 0.93 1"),self.bground.setAttribute("groundangle","0.9 1.5 1.57"),self.bground.setAttribute("groundcolor","0.65 0.65 0.65 0.73 0.73 0.73 0.81 0.81 0.81 0.91 0.91 0.91"),self.bground.textContent=" "},this.gyroscope=function(alpha,beta,gamma){var degToRad=Math.PI/180,b=alpha?alpha:0,a=beta?beta:0,g=-(gamma?gamma:0);a*=degToRad,b*=degToRad,g*=degToRad;var cA=Math.cos(a/2),cB=Math.cos(b/2),cG=Math.cos(g/2),sA=Math.sin(a/2),sB=Math.sin(b/2),sG=Math.sin(g/2),x=sA*cB*cG+cA*sB*sG,y=cA*sB*cG-sA*cB*sG,z=cA*cB*sG-sA*sB*cG,w=cA*cB*cG+sA*sB*sG,q=new x3dom.fields.Quaternion(x,y,z,w),screenAngle=(window.orientation?window.orientation:0)*degToRad*-1,screenQuat=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(0,0,1),screenAngle),viewQuat=new x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(1,0,0),.5*-Math.PI);q=q.multiply(viewQuat),q=q.multiply(screenQuat);var flyMat=null,vp=self.getCurrentViewpoint()._x3domNode;if(self.rollerCoasterMatrix){var qMat=q.toMatrix();flyMat=qMat.transpose().mult(self.rollerCoasterMatrix.inverse())}else flyMat=vp.getViewMatrix().inverse(),flyMat.setRotate(q),flyMat=flyMat.inverse();vp._viewMatrix.setValues(flyMat)},this.switchDebug=function(){self.getViewArea()._visDbgBuf=!self.getViewArea()._visDbgBuf},this.showStats=function(){self.runtime.canvas.stateViewer.display()},this.getViewArea=function(){return self.runtime.canvas.doc._viewarea},this.getViewMatrix=function(){return self.getViewArea().getViewMatrix()},this.getProjectionMatrix=function(){return self.getViewArea().getProjectionMatrix()},this.onMouseUp=function(functionToBind){ViewerUtil.onEvent("onMouseUp",functionToBind)},this.offMouseUp=function(functionToBind){ViewerUtil.offEvent("onMouseUp",functionToBind)},this.onMouseDown=function(functionToBind){ViewerUtil.onEvent("onMouseDown",functionToBind)},this.offMouseDown=function(functionToBind){ViewerUtil.offEvent("onMouseDown",functionToBind)},this.onMouseMove=function(functionToBind){ViewerUtil.onEvent("onMouseMove",functionToBind)},this.offMouseMove=function(functionToBind){ViewerUtil.offEvent("onMouseMove",functionToBind)},this.pickPoint=function(x,y,fireEvent){fireEvent=void 0!==typeof fireEvent&&fireEvent,self.getViewArea()._doc.ctx.pickValue(self.getViewArea(),x,y),fireEvent&&self.mouseDownPickPoint({layerX:x,layerY:y})},this.mouseDownPickPoint=function(event){var viewArea=self.getViewArea(),pickingInfo=viewArea._pickingInfo;if(pickingInfo.pickObj){var account,project,projectParts=null;if(pickingInfo.pickObj._xmlNode?pickingInfo.pickObj._xmlNode.hasAttribute("id")&&(projectParts=pickingInfo.pickObj._xmlNode.getAttribute("id").split("__")):projectParts=pickingInfo.pickObj.pickObj._xmlNode.getAttribute("id").split("__"),projectParts){var objectID=pickingInfo.pickObj.partID?pickingInfo.pickObj.partID:projectParts[2];account=projectParts[0],project=projectParts[1];var inlineTransName=ViewerUtil.escapeCSSCharacters(account+"__"+project),projectInline=self.inlineRoots[inlineTransName],trans=projectInline._x3domNode.getCurrentTransform();console.trace(event),callback(self.EVENT.PICK_POINT,{id:objectID,position:pickingInfo.pickPos,normal:pickingInfo.pickNorm,trans:trans,screenPos:[event.layerX,event.layerY]})}else callback(self.EVENT.PICK_POINT,{position:pickingInfo.pickPos,normal:pickingInfo.pickNorm})}},this.onMouseDown(this.mouseDownPickPoint),this.onViewpointChanged=function(functionToBind){ViewerUtil.onEvent("myViewpointHasChanged",functionToBind)},this.offViewpointChanged=function(functionToBind){ViewerUtil.offEvent("myViewpointHasChanged",functionToBind)},this.viewPointChanged=function(event){var vpInfo=self.getCurrentViewpointInfo(),eye=vpInfo.position,viewDir=vpInfo.view_dir;self.currentNavMode===self.NAV_MODES.HELICOPTER&&(self.nav._x3domNode._vf.typeParams[0]=Math.asin(viewDir[1]),self.nav._x3domNode._vf.typeParams[1]=eye[1]),ViewerUtil.triggerEvent("myViewpointHasChanged",event)},this.onBackgroundClicked=function(functionToBind){ViewerUtil.onEvent("bgroundClicked",functionToBind)},this.offBackgroundClicked=function(functionToBind){ViewerUtil.offEvent("bgroundClicked",functionToBind)},this.selectParts=function(part,zoom,colour){var i;if(colour=colour?colour:self.SELECT_COLOUR.EMISSIVE,Array.isArray(part)||(part=[part]),zoom)for(i=0;i<part.length;i++)part[i].fit();if(self.oldPart)for(i=0;i<self.oldPart.length;i++)self.oldPart[i].resetColor();for(self.oldPart=part,i=0;i<part.length;i++)part[i].setEmissiveColor(colour,"both")},this.selectAndUnselectParts=function(highlightPart,unhighlightPart,zoom,colour){var i;if(colour=colour?colour:self.SELECT_COLOUR.EMISSIVE,zoom){for(i=0;i<highlightPart.length;i++)highlightPart[i].fit();for(i=0;i<unhighlightPart.length;i++)unhighlightPart[i].fit()}for(i=0;i<highlightPart.length;i++)highlightPart[i].setEmissiveColor(colour,"both");for(i=0;i<unhighlightPart.length;i++)unhighlightPart[i].resetColor();self.oldPart=highlightPart},this.clickObject=function(objEvent){var account=null,project=null,id=null;1!==objEvent.button||self.selectionDisabled||objEvent.partID&&(id=objEvent.partID,account=objEvent.part.multiPart._nameSpace.name.split("__")[0],project=objEvent.part.multiPart._nameSpace.name.split("__")[1]),callback(self.EVENT.OBJECT_SELECTED,{account:account,project:project,id:id,source:"viewer"})},this.highlightObjects=function(account,project,ids,zoom,colour){if(!this.multiSelectMode&&!this.pinDropMode){var nameSpaceName=null;if(ids||(ids=[]),ids=Array.isArray(ids)?ids:[ids],!nameSpaceName||self.multipartNodesByProject.hasOwnProperty(nameSpaceName)){var nsMultipartNodes,fullPartsList=[];nsMultipartNodes=nameSpaceName?self.multipartNodesByProject[nameSpaceName]:self.multipartNodes;for(var multipartNodeName in nsMultipartNodes)if(nsMultipartNodes.hasOwnProperty(multipartNodeName)){var parts=nsMultipartNodes[multipartNodeName].getParts(ids);parts&&parts.ids.length>0&&fullPartsList.push(parts)}self.selectParts(fullPartsList,zoom,colour)}for(var i=0;i<ids.length;i++){var id=ids[i],object=document.querySelectorAll("[id$='"+id+"']");object[0]&&self.setApp(object[0],colour)}0===ids.length&&self.setApp(null)}},this.highlightAndUnhighlightObjects=function(account,project,highlight_ids,unhighlight_ids,zoom,colour){var nameSpaceName=null;if(!nameSpaceName||self.multipartNodesByProject.hasOwnProperty(nameSpaceName)){var nsMultipartNodes,fullHighlightPartsList=[],fullUnhighlightPartsList=[];nsMultipartNodes=nameSpaceName?self.multipartNodesByProject[nameSpaceName]:self.multipartNodes;for(var multipartNodeName in nsMultipartNodes)if(nsMultipartNodes.hasOwnProperty(multipartNodeName)){var highlightParts=nsMultipartNodes[multipartNodeName].getParts(highlight_ids);highlightParts&&highlightParts.ids.length>0&&fullHighlightPartsList.push(highlightParts);var unhighlightParts=nsMultipartNodes[multipartNodeName].getParts(unhighlight_ids);unhighlightParts&&unhighlightParts.ids.length>0&&fullUnhighlightPartsList.push(unhighlightParts)}self.selectAndUnselectParts(fullHighlightPartsList,fullUnhighlightPartsList,zoom,colour)}},this.__processSwitchVisibility=function(nameSpaceName,ids,state){if(ids&&ids.length){if(!nameSpaceName||self.multipartNodesByProject.hasOwnProperty(nameSpaceName)){var nsMultipartNodes;nsMultipartNodes=nameSpaceName?self.multipartNodesByProject[nameSpaceName]:self.multipartNodes;for(var multipartNodeName in nsMultipartNodes)if(nsMultipartNodes.hasOwnProperty(multipartNodeName)){var parts=nsMultipartNodes[multipartNodeName].getParts(ids);parts&&parts.ids.length>0&&parts.setVisibility(state)}}for(var i=0;i<ids.length;i++){var id=ids[i],object=document.querySelectorAll("[id$='"+id+"']");object[0]&&object[0].setAttribute("render",state.toString())}}},this.switchObjectVisibility=function(account,project,visible_ids,invisible_ids){var nameSpaceName=null;account&&project&&(nameSpaceName=account+"__"+project),visible_ids&&self.__processSwitchVisibility(nameSpaceName,visible_ids,!0),invisible_ids&&self.__processSwitchVisibility(nameSpaceName,invisible_ids,!1)},ViewerUtil.onEvent("pinClick",function(clickInfo){var pinID=clickInfo.target.parentElement.parentElement.parentElement.parentElement.parentElement.id;callback(self.EVENT.CLICK_PIN,{id:pinID})}),ViewerUtil.onEvent("onMouseDown",function(){document.body.style["pointer-events"]="none"}),ViewerUtil.onEvent("onMouseUp",function(){document.body.style["pointer-events"]="all"}),this.onClickObject=function(functionToBind){ViewerUtil.onEvent("clickObject",functionToBind)},this.offClickObject=function(functionToBind){ViewerUtil.offEvent("clickObject",functionToBind)},this.viewpoints={},this.viewpointsNames={},this.selectedViewpointIdx=0,this.selectedViewpoint=null,this.isFlyingThrough=!1,this.flyThroughTime=1e3,this.flyThrough=function(){self.isFlyingThrough?self.isFlyingThrough=!1:(self.isFlyingThrough=!0,setTimeout(self.flyThroughTick,self.flyThroughTime))},this.flyThroughTick=function(){var newViewpoint=self.selectedViewpointIdx+1;newViewpoint===self.viewpoints.length&&(newViewpoint=0),self.setCurrentViewpoint(self.viewpoints[newViewpoint]),self.isFlyingThrough&&setTimeout(self.flyThroughTick,self.flyThroughTime)},this.getViewpointGroupAndName=function(id){var name,group,splitID=id.trim().split("__");return splitID.length>1?(group=splitID[0].trim(),name=splitID[1].trim()):(name=splitID[0].trim(),group="uncategorized"),{group:group,name:name}},this.loadViewpoints=function(){for(var viewpointList=document.getElementsByTagName("Viewpoint"),v=0;v<viewpointList.length;v++)if(viewpointList[v].hasAttribute("id")){var id=viewpointList[v].id.trim();viewpointList[v].DEF=id;var groupName=self.getViewpointGroupAndName(id);self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=id,self.viewpointsNames[id]=viewpointList[v]}},this.loadViewpoint=null,this.createViewpoint=function(name,from,at,up){var groupName=self.getViewpointGroupAndName(name);if(self.viewpoints[groupName.group]&&self.viewpoints[groupName.group][groupName.name])console.error("Tried to create viewpoint with duplicate name: "+name);else{var newViewPoint=document.createElement("viewpoint");if(newViewPoint.setAttribute("id",name),newViewPoint.setAttribute("def",name),self.scene.appendChild(newViewPoint),from&&at&&up){var q=self.getAxisAngle(from,at,up);newViewPoint.setAttribute("orientation",q.join(","))}self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=name,self.viewpointsNames[name]=newViewPoint}},this.setCurrentViewpointIdx=function(idx){var viewpointNames=Object.keys(self.viewpointsNames);self.setCurrentViewpoint(viewpointNames[idx])},this.setCurrentViewpoint=function(id){if(Object.keys(self.viewpointsNames).indexOf(id)!==-1){var viewpoint=self.viewpointsNames[id];return self.currentViewpoint&&self.currentViewpoint._xmlNode.removeEventListener("viewpointChanged",self.viewPointChanged),self.currentViewpoint=viewpoint._x3domNode,viewpoint.setAttribute("bind",!0),self.getViewArea().resetView(),self.getViewArea()._flyMat=null,viewpoint.addEventListener("viewpointChanged",self.viewPointChanged),self.loadViewpoint=null,viewpoint.appendChild(self.nav),self.runtime.resetExamin(),self.applySettings(),void(id===self.name+"_default"&&(self.defaultShowAll?self.runtime.fitAll():self.reset()))}self.loadViewpoint=id},this.updateSettings=function(settings){settings&&(self.settings=settings,self.applySettings())},this.applySettings=function(){self.settings&&(self.settings.hasOwnProperty("start_all")&&(self.defaultShowAll=self.settings.start_all),self.settings.hasOwnProperty("speed")&&self.setSpeed(self.settings.speed),self.settings.hasOwnProperty("avatarHeight")&&self.changeAvatarHeight(self.settings.avatarHeight),self.settings.hasOwnProperty("defaultNavMode")&&(self.defaultNavMode=self.settings.defaultNavMode),self.settings.hasOwnProperty("pinSize")&&(self.pinSize=self.settings.pinSize,self.pinSizeFromSettings=!0),self.settings.hasOwnProperty("visibilityLimit")&&self.nav.setAttribute("visibilityLimit",self.settings.visibilityLimit),self.settings.hasOwnProperty("zFar")&&self.currentViewpoint._xmlNode.setAttribute("zFar",self.settings.zFar),self.settings.hasOwnProperty("zNear")&&self.currentViewpoint._xmlNode.setAttribute("zNear",self.settings.zNear),self.settings.hasOwnProperty("background")&&self.createBackground(self.settings.background),self.settings.hasOwnProperty("ambientLight")&&self.setAmbientLight(self.settings.ambientLight))},this.applyModelProperties=function(account,project,properties){properties.properties&&properties.properties.hiddenNodes&&self.switchObjectVisibility(null,null,null,properties.properties.hiddenNodes)},this.lookAtObject=function(obj){self.runtime.fitObject(obj,!0)},this.applyApp=function(nodes,factor,emiss,otherSide){var m_idx,origDiff,origAmb;if(otherSide)for(m_idx=0;m_idx<nodes.length;m_idx++)nodes[m_idx]._x3domNode&&(origDiff=nodes[m_idx]._x3domNode._vf.backDiffuseColor,nodes[m_idx]._x3domNode._vf.backDiffuseColor.setValues(origDiff.multiply(factor)),origAmb=nodes[m_idx]._x3domNode._vf.backAmbientIntensity,nodes[m_idx]._x3domNode._vf.backAmbientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.backEmissiveColor.setValueByStr(emiss));else for(m_idx=0;m_idx<nodes.length;m_idx++)nodes[m_idx]._x3domNode&&(origDiff=nodes[m_idx]._x3domNode._vf.diffuseColor,nodes[m_idx]._x3domNode._vf.diffuseColor.setValues(origDiff.multiply(factor)),origAmb=nodes[m_idx]._x3domNode._vf.ambientIntensity,nodes[m_idx]._x3domNode._vf.ambientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.emissiveColor.setValueByStr(emiss))},this.pickObject={},this.pickPoint=function(x,y){var viewArea=self.getViewArea(),scene=viewArea._scene;if("undefined"!=typeof x&&"undefined"!=typeof y){var viewMatrix=self.getViewArea().getViewMatrix(),projMatrix=self.getViewArea().getProjectionMatrix();viewArea._doc.ctx.pickValue(viewArea,x,y,0,viewMatrix,projMatrix.mult(viewMatrix))}var oldPickMode=scene._vf.pickMode.toLowerCase();scene._vf.pickMode="idbuf",scene._vf.pickMode=oldPickMode,self.pickObject=viewArea._pickingInfo,self.pickObject.part=null,self.pickObject.partID=null;var objId=self.pickObject.shadowObjectId;if(scene._multiPartMap)for(var mpi=0;mpi<scene._multiPartMap.multiParts.length;mpi++){var mp=scene._multiPartMap.multiParts[mpi];if(objId>mp._minId&&objId<=mp._maxId){var colorMap=mp._inlineNamespace.defMap.MultiMaterial_ColorMap,emissiveMap=mp._inlineNamespace.defMap.MultiMaterial_EmissiveMap,specularMap=mp._inlineNamespace.defMap.MultiMaterial_SpecularMap,visibilityMap=mp._inlineNamespace.defMap.MultiMaterial_VisibilityMap;self.pickObject.part=new x3dom.Parts(mp,[objId-mp._minId],colorMap,emissiveMap,specularMap,visibilityMap),self.pickObject.partID=mp._idMap.mapping[objId-mp._minId].name,self.pickObject.pickObj=self.pickObject.part.multiPart}}},this.oneGrpNodes=[],this.twoGrpNodes=[],this.setApp=function(group,app){group&&group.multipart||(void 0===app&&(app=self.SELECT_COLOUR.EMISSIVE),self.applyApp(self.oneGrpNodes,2,"0.0 0.0 0.0",!1),self.applyApp(self.twoGrpNodes,2,"0.0 0.0 0.0",!1),self.applyApp(self.twoGrpNodes,2,"0.0 0.0 0.0",!0),self.applyApp(self.diffColorAdded,.5,"0.0 1.0 0.0"),self.applyApp(self.diffColorDeleted,.5,"1.0 0.0 0.0"),group?(self.twoGrpNodes=group.getElementsByTagName("TwoSidedMaterial"),self.oneGrpNodes=group.getElementsByTagName("Material")):(self.oneGrpNodes=[],self.twoGrpNodes=[]),self.applyApp(self.oneGrpNodes,.5,app,!1),self.applyApp(self.twoGrpNodes,.5,app,!1),self.applyApp(self.twoGrpNodes,.5,app,!0),self.viewer.render())},this.setNavMode=function(mode,force){if(self.currentNavMode!==mode||force){if(mode===self.NAV_MODES.WAYFINDER&&waypoint.init(),self.currentNavMode===self.NAV_MODES.WAYFINDER&&waypoint.close(),mode===self.NAV_MODES.HELICOPTER){var vpInfo=self.getCurrentViewpointInfo(),eye=vpInfo.position,viewDir=vpInfo.view_dir;self.nav._x3domNode._vf.typeParams[0]=Math.asin(viewDir[1]),self.nav._x3domNode._vf.typeParams[1]=eye[1];var bboxMax=self.getScene()._x3domNode.getVolume().max,bboxMin=self.getScene()._x3domNode.getVolume().min,bboxSize=bboxMax.subtract(bboxMin),calculatedSpeed=.03*Math.sqrt(Math.max.apply(Math,bboxSize.toGL()));self.nav.setAttribute("speed",calculatedSpeed)}self.currentNavMode=mode,self.nav.setAttribute("type",mode),mode===self.NAV_MODES.WALK?(self.disableClicking(),self.setApp(null)):self.enableClicking(),mode===self.NAV_MODES.WAYFINDER&&waypoint&&waypoint.resetViewer(),mode===self.NAV_MODES.TURNTABLE&&self.nav.setAttribute("typeParams","-0.4 60.0 0 3.14 0.00001")}},this.reload=function(){x3dom.reload()},this.startingPoint=[0,0,0],this.setStartingPoint=function(x,y,z){self.startingPoint[0]=x,self.startingPoint[1]=y,self.startingPoint[2]=z},this.defaultOrientation=[0,0,1],this.setStartingOrientation=function(x,y,z){self.defaultOrientation[0]=x,self.defaultOrientation[1]=y,self.defaultOrientation[2]=z},this.setCameraPosition=function(pos){var vpInfo=self.getCurrentViewpointInfo(),viewDir=vpInfo.view_dir,up=vpInfo.up;self.updateCamera(pos,up,viewDir)},this.moveCamera=function(dV){var currentPos=self.getCurrentViewpointInfo().position;currentPos[0]+=dV[0],currentPos[1]+=dV[1],currentPos[2]+=dV[2],self.setCameraPosition(currentPos)},this.setCameraViewDir=function(viewDir,upDir,centerOfRotation){var currentPos=self.getCurrentViewpointInfo().position;self.updateCamera(currentPos,upDir,viewDir,centerOfRotation)},this.setCamera=function(pos,viewDir,upDir,centerOfRotation,animate,rollerCoasterMode){self.updateCamera(pos,upDir,viewDir,centerOfRotation,animate,rollerCoasterMode)},this.updateCamera=function(pos,up,viewDir,centerOfRotation,animate,rollerCoasterMode){viewDir||(viewDir=self.getCurrentViewpointInfo().view_dir),up||(up=self.getCurrentViewpointInfo().up),up=ViewerUtil.normalize(up);var x3domView=new x3dom.fields.SFVec3f(viewDir[0],viewDir[1],viewDir[2]),x3domUp=new x3dom.fields.SFVec3f(up[0],up[1],up[2]),x3domFrom=new x3dom.fields.SFVec3f(pos[0],pos[1],pos[2]),x3domAt=x3domFrom.add(x3domView.normalize()),viewMatrix=x3dom.fields.SFMatrix4f.lookAt(x3domFrom,x3domAt,x3domUp),currViewpointNode=self.getCurrentViewpoint(),currViewpoint=currViewpointNode._x3domNode;self.currentNavMode===self.NAV_MODES.HELICOPTER&&(self.nav._x3domNode._vf.typeParams[0]=Math.asin(x3domView.y),self.nav._x3domNode._vf.typeParams[1]=x3domFrom.y);var oldViewMatrixCopy=currViewpoint._viewMatrix.toGL();!animate&&rollerCoasterMode?self.rollerCoasterMatrix=viewMatrix:currViewpoint._viewMatrix.setValues(viewMatrix.inverse());var x3domCenter=null;if(centerOfRotation)x3domCenter=new x3dom.fields.SFVec3f(centerOfRotation[0],centerOfRotation[1],centerOfRotation[2]);else{var canvasWidth=self.getViewArea()._doc.canvas.width,canvasHeight=self.getViewArea()._doc.canvas.height;if(self.pickPoint(canvasWidth/2,canvasHeight/2),self.pickObject.pickPos)x3domCenter=self.pickObject.pickPos;else{var ry=new x3dom.fields.Ray(x3domFrom,x3domView),bbox=self.getScene()._x3domNode.getVolume();x3domCenter=ry.intersect(bbox.min,bbox.max)?x3domAt.add(x3domView.multiply(1/(GOLDEN_RATIO+1)*ry.exit)):x3domAt}}animate&&(currViewpoint._viewMatrix.setFromArray(oldViewMatrixCopy),self.getViewArea().animateTo(viewMatrix.inverse(),currViewpoint)),currViewpointNode.setAttribute("centerofrotation",x3domCenter.toGL().join(",")),self.setNavMode(self.currentNavMode),self.getViewArea()._doc.needRender=!0,self.linked&&self.manager.switchMaster(self.handle)},this.linked=!1,this.managerSwitchMaster=function(){self.manager.switchMaster(self.handle)},this.linkMe=function(){self.manager&&(self.manager.linkMe(self.handle),self.onViewpointChanged(self.manager.viewpointLinkFunction),self.viewer.addEventListener("mousedown",self.managerSwitchMaster),self.linked=!0)},this.collDistance=.1,this.changeCollisionDistance=function(collDistance){self.collDistance=collDistance,self.nav._x3domNode._vf.avatarSize[0]=collDistance},this.avatarHeight=1.83,this.changeAvatarHeight=function(height){self.avatarHeight=height,self.nav._x3domNode._vf.avatarSize[1]=height},this.stepHeight=.4,this.changeStepHeight=function(stepHeight){self.stepHeight=stepHeight,self.nav._x3domNode._vf.avatarSize[2]=stepHeight},this.reset=function(){self.setCurrentViewpoint("model__start"),self.changeCollisionDistance(self.collDistance),self.changeAvatarHeight(self.avatarHeight),self.changeStepHeight(self.stepHeight)},this.loadModel=function(account,project,branch,revision){var url="";url="head"===revision?server_config.apiUrl(server_config.GET_API,account+"/"+project+"/revision/"+branch+"/head.x3d.mp"):server_config.apiUrl(server_config.GET_API,account+"/"+project+"/revision/"+revision+".x3d.mp"),self.account=account,self.project=project,self.branch=branch,self.revision=revision,self.modelString=account+"_"+project+"_"+branch+"_"+revision,self.loadURL(url)},this.loadURL=function(url){self.inline&&(self.inline.parentNode.removeChild(self.inline),self.inline=null),self.inline=document.createElement("inline"),self.scene.appendChild(self.inline),self.account&&self.project?self.rootName=self.account+"__"+self.project:self.rootName="model",self.inline.setAttribute("namespacename",self.rootName),self.inline.setAttribute("onload","onLoaded(event);"),self.inline.setAttribute("url",url),self.reload(),self.url=url,callback(self.EVENT.START_LOADING,{name:self.name})},this.getRoot=function(){return self.inline},this.getScene=function(){return self.scene},this.getCurrentViewpoint=function(){return self.getViewArea()._scene.getViewpoint()._xmlNode},this.getCurrentViewpointInfo=function(){var viewPoint={},viewMat=(self.getViewArea()._scene.getViewpoint().getCurrentTransform(),self.getViewMatrix().inverse()),viewRight=viewMat.e0(),viewUp=viewMat.e1(),viewDir=viewMat.e2().multiply(-1),viewPos=viewMat.e3(),center=self.getViewArea()._scene.getViewpoint().getCenterOfRotation(),lookAt=null;lookAt=center?center.subtract(viewPos):viewPos.add(viewDir);var projMat=self.getProjectionMatrix();viewPoint.up=[viewUp.x,viewUp.y,viewUp.z],viewPoint.position=[viewPos.x,viewPos.y,viewPos.z],viewPoint.look_at=[lookAt.x,lookAt.y,lookAt.z],viewPoint.view_dir=[viewDir.x,viewDir.y,viewDir.z],viewPoint.right=[viewRight.x,viewRight.y,viewRight.z],viewPoint.unityHeight=2/projMat._00,viewPoint.fov=2*Math.atan(1/projMat._00),viewPoint.aspect_ratio=viewPoint.fov/projMat._11;var f=projMat._23/(projMat._22+1),n=f*projMat._23/(projMat._23-2*f);return viewPoint.far=f,viewPoint.near=n,viewPoint.clippingPlanes=self.clippingPlanes,
viewPoint},this.speed=2,this.setSpeed=function(speed){self.speed=speed,self.nav.speed=speed},this.bgroundClick=function(event){callback(self.EVENT.BACKGROUND_SELECTED)},this.hiddenParts=[],this.addHiddenPart=function(part){this.hiddenParts.push(part)},this.revealAll=function(event,objEvent){for(var part in self.hiddenParts)self.hiddenParts.hasOwnProperty(part)&&self.hiddenParts[part].setVisibility(!0);self.hiddenParts=[]},this.disableClicking=function(){self.clickingEnabled&&(self.offBackgroundClicked(self.bgroundClick),self.offClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!0),self.clickingEnabled=!1)},this.disableSelecting=function(){self.selectionDisabled=!0},this.enableClicking=function(){self.clickingEnabled||(self.onBackgroundClicked(self.bgroundClick),self.onClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!1),self.clickingEnabled=!0)},this.switchFullScreen=function(vrDisplay){vrDisplay=vrDisplay||{},self.fullscreen?(document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),self.fullscreen=!1):(self.viewer.mozRequestFullScreen?self.viewer.mozRequestFullScreen({vrDisplay:vrDisplay}):self.viewer.webkitRequestFullscreen&&self.viewer.webkitRequestFullscreen({vrDisplay:vrDisplay}),self.fullscreen=!0)},this.diffColorDeleted=[],this.diffColorAdded=[],this.setDiffColors=function(diffColors){diffColors&&(self.diffColors=diffColors);var i,mat,obj;if(self.applyApp(self.diffColorAdded,2,"0.0 0.0 0.0",!1),self.applyApp(self.diffColorDeleted,2,"0.0 0.0 0.0",!1),self.diffColorAdded=[],self.diffColorDeleted=[],self.diffColors&&self.inline.childNodes.length){var defMapSearch=self.inline.childNodes[0]._x3domNode._nameSpace.defMap;if(self.diffColors.added)for(i=0;i<self.diffColors.added.length;i++)obj=defMapSearch[self.diffColors.added[i]],obj&&(mat=obj._xmlNode.getElementsByTagName("Material"),mat.length?(self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0])):(mat=obj._xmlNode.getElementsByTagName("TwoSidedMaterial"),self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0])));if(self.diffColors.deleted)for(i=0;i<self.diffColors.deleted.length;i++)obj=defMapSearch[self.diffColors.deleted[i]],obj&&(mat=obj._xmlNode.getElementsByTagName("Material"),mat.length?(self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0])):(mat=obj._xmlNode.getElementsByTagName("TwoSidedMaterial"),self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0])))}},this.transformEvent=function(event,viewpoint,inverse){var transformation;transformation=inverse?viewpoint._x3domNode.getTransformation().inverse():viewpoint._x3domNode.getTransformation();var newPos=transformation.multMatrixVec(event.position),newOrientMat=ViewerUtil.axisAngleToMatrix(event.orientation[0],event.orientation[1]);newOrientMat=transformation.mult(newOrientMat);var newOrient=new x3dom.fields.Quaternion;newOrient.setValue(newOrientMat),newOrient=newOrient.toAxisAngle(),event.position=newPos,event.orientation=newOrient},this.setMultiSelectMode=function(on){var element=document.getElementById("x3dom-default-canvas");this.multiSelectMode=on,on?(element.style.cursor="default",self.oldPart&&self.oldPart.length>0&&1===self.oldPart[0].ids.length&&self.oldPart[0].resetColor()):element.style.cursor="-webkit-grab"},this.setPinDropMode=function(on){var element=document.getElementById("x3dom-default-canvas");this.pinDropMode=on,element.style.cursor=on?"crosshair":"-webkit-grab"};var clippingPlaneID=-1;this.clippingPlanes=[],this.setClippingPlanes=function(clippingPlanes){self.clearClippingPlanes();for(var clipidx=0;clipidx<clippingPlanes.length;clipidx++){self.addClippingPlane(clippingPlanes[clipidx].axis,clippingPlanes[clipidx].distance,clippingPlanes[clipidx].percentage,clippingPlanes[clipidx].clipDirection)}},this.addClippingPlane=function(axis,distance,percentage,clipDirection){clippingPlaneID+=1;var newClipPlane=new ClipPlane(clippingPlaneID,self,axis,[1,1,1],distance,percentage,clipDirection);return self.clippingPlanes.push(newClipPlane),clippingPlaneID},this.moveClippingPlane=function(percentage){self.clippingPlanes[0].movePlane(percentage)},this.clearClippingPlanes=function(){self.clippingPlanes.forEach(function(clipPlane){clipPlane.destroy()}),self.clippingPlanes=[]},this.getClippingPlane=function(id){return self.clippingPlanes.filter(function(clipPlane){return clipPlane.getID()===id})[0]},self.pins={},this.addPin=function(account,project,id,position,norm,colours,viewpoint){if(self.pins.hasOwnProperty(id))errCallback(self.ERROR.PIN_ID_TAKEN);else{var trans=null,projectNameSpace=account+"__"+project;if(self.inlineRoots.hasOwnProperty(projectNameSpace)){var projectInline=self.inlineRoots[account+"__"+project];trans=projectInline._x3domNode.getCurrentTransform()}self.pins[id]=new Pin(id,self.getScene(),trans,position,norm,self.pinSize,colours,viewpoint)}},this.clickPin=function(id){if(self.pins.hasOwnProperty(id)){var pin=self.pins[id];callback(self.EVENT.CHANGE_PIN_COLOUR,{id:id,colours:[[1,.7,0]]}),callback(self.EVENT.SET_CAMERA,{position:pin.viewpoint.position,view_dir:pin.viewpoint.view_dir,up:pin.viewpoint.up}),callback(self.EVENT.SET_CLIPPING_PLANES,{clippingPlanes:pin.viewpoint.clippingPlanes})}},this.setPinVisibility=function(id,visibility){if(self.pins.hasOwnProperty(id)){var pin=self.pins[id];pin.setAttribute("render",visibility.toString())}},this.removePin=function(id){self.pins.hasOwnProperty(id)&&(self.pins[id].remove(id),delete self.pins[id])},this.previousHighLightedPin=null,this.highlightPin=function(id){self.previousHighLightedPin&&(self.previousHighLightedPin.highlight(),self.previousHighLightedPin=null),id&&self.pins.hasOwnProperty(id)&&(self.pins[id].highlight(),self.previousHighLightedPin=self.pins[id])},this.changePinColours=function(id,colours){self.pins.hasOwnProperty(id)&&self.pins[id].changeColour(colours)}},Viewer.prototype.SELECT_COLOUR={EMISSIVE:"1.0 0.5 0.0"},Viewer.prototype.ERROR={PIN_ID_TAKEN:"VIEWER_PIN_ID_TAKEN"}}();var VIEWER_NAV_MODES=Viewer.prototype.NAV_MODES={HELICOPTER:"HELICOPTER",WALK:"WALK",TURNTABLE:"TURNTABLE",WAYFINDER:"WAYFINDER",FLY:"FLY"},VIEWER_EVENTS=Viewer.prototype.EVENT={READY:"VIEWER_EVENT_READY",START_LOADING:"VIEWING_START_LOADING",LOADED:"VIEWER_EVENT_LOADED",RUNTIME_READY:"VIEWING_RUNTIME_READY",ENTER_VR:"VIEWER_EVENT_ENTER_VR",VR_READY:"VIEWER_EVENT_VR_READY",SET_NAV_MODE:"VIEWER_SET_NAV_MODE",GO_HOME:"VIEWER_GO_HOME",SWITCH_FULLSCREEN:"VIEWER_SWITCH_FULLSCREEN",REGISTER_VIEWPOINT_CALLBACK:"VIEWER_REGISTER_VIEWPOINT_CALLBACK",REGISTER_MOUSE_MOVE_CALLBACK:"VIEWER_REGISTER_MOUSE_MOVE_CALLBACK",OBJECT_SELECTED:"VIEWER_OBJECT_SELECTED",BACKGROUND_SELECTED:"VIEWER_BACKGROUND_SELECTED",HIGHLIGHT_OBJECTS:"VIEWER_HIGHLIGHT_OBJECTS",HIGHLIGHT_AND_UNHIGHLIGHT_OBJECTS:"VIEWER_HIGHLIGHT_AND_UNHIGHLIGHT_OBJECTS",SWITCH_OBJECT_VISIBILITY:"VIEWER_SWITCH_OBJECT_VISIBILITY",SET_PIN_VISIBILITY:"VIEWER_SET_PIN_VISIBILITY",GET_CURRENT_VIEWPOINT:"VIEWER_GET_CURRENT_VIEWPOINT",GET_SCREENSHOT:"VIEWER_GET_SCREENSHOT",MEASURE_MODE_CLICK_POINT:"VIEWER_MEASURE_MODE_CLICK_POINT",PICK_POINT:"VIEWER_PICK_POINT",MOVE_POINT:"VIEWER_MOVE_POINT",SET_CAMERA:"VIEWER_SET_CAMERA",LOGO_CLICK:"VIEWER_LOGO_CLICK",CLEAR_CLIPPING_PLANES:"VIEWER_CLEAR_CLIPPING_PLANES",ADD_CLIPPING_PLANE:"VIEWER_ADD_CLIPPING_PLANE",MOVE_CLIPPING_PLANE:"VIEWER_MOVE_CLIPPING_PLANE",CLIPPING_PLANE_READY:"VIEWER_CLIPPING_PLANE_READY",SET_CLIPPING_PLANES:"VIEWER_SET_CLIPPING_PLANES",CLICK_PIN:"VIEWER_CLICK_PIN",CHANGE_PIN_COLOUR:"VIEWER_CHANGE_PIN_COLOUR",REMOVE_PIN:"VIEWER_REMOVE_PIN",ADD_PIN:"VIEWER_ADD_PIN",MOVE_PIN:"VIEWER_MOVE_PIN"},ViewerManager={};!function(){"use strict";ViewerManager=function(){this.currentViewerName="",this.currentViewer=null,this.linkedViewers=[],this.linkedFunctions=[],this.viewers={},this.selectDefaultCurrentViewer=function(){var viewerNames=Object.keys(this.viewers);viewerNames.length?this.currentViewer=this.viewers[viewerNames[0]]:this.currentViewer=null},x3dom.runtime.ready=this.initRuntime},ViewerManager.prototype.isValidViewerName=function(name){return this.viewers.hasOwnProperty(name)},ViewerManager.prototype.reshape=function(){var viewerSize=100/Object.keys(this.viewers).length,i=0;for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&(this.viewers[name].viewer.style.width=viewerSize+"%",this.viewers[name].viewer.style.left=i*viewerSize+"%",i++)},ViewerManager.prototype.removeViewer=function(name){if(this.isValidHandle(name)){if(1===Object.keys(this.viewers).length)return;this.viewers[name]===this.currentViewer&&this.selectDefaultCurrentViewer(),this.linkedViewers=this.linkedViewers.filter(function(linkedName){return linkedName!==name}),this.viewers[name].close(),delete this.viewers[name],this.currentViewerName===name&&(this.defaultViewerHandle=Object.keys(this.viewers)[0]),this.reshape()}},ViewerManager.prototype.close=function(){for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&this.removeViewer(name)},ViewerManager.prototype.registerMe=function(viewer){this.viewers[viewer.name]=viewer,1===Object.keys(this.viewers).length&&this.selectDefaultCurrentViewer(),this.reshape()},ViewerManager.prototype.linkMe=function(handle){this.addMe(this.linkedViewers,handle)},ViewerManager.prototype.switchCurrent=function(name){this.isValidHandle(name)&&(this.viewMaster=this.viewers[name])},ViewerManager.prototype.getCurrentViewer=function(){if(this.currentViewer)return this.currentViewer},ViewerManager.prototype.linkFunction=function(callback){this.linkedFunctions.push(callback)},ViewerManager.prototype.viewpointLinkFunction=function(newEvent,event){if(this.linkedViewers.length&&this.currentViewer&&event.target===this.currentViewer.getCurrentViewpoint()){event.orientation[1]=event.orientation[1]*-1,this.currentViewer.transformEvent(event,event.target,!1);var i;for(i=0;i<this.linkedViewers.length;i++){var name=this.linkedViewers[i];this.currentViewer.handle!==name&&this.isValidName(name)&&(this.viewers[name].getCurrentViewpoint().setAttribute("position",event.position.toString()),this.viewers[name].getCurrentViewpoint().setAttribute("orientation",event.orientation.toString()))}for(i=0;i<this.linkedFunctions.length;i++)this.linkedFunctions[i](event)}},ViewerManager.prototype.initRuntime=function(){for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&(this.viewers[name].runtime||this.viewers[name].initRuntime())}}(),function(){"use strict";function accountBilling(){return{restrict:"EA",templateUrl:"accountBilling.html",scope:{account:"=",billingAddress:"=",quota:"=",billings:"=",subscriptions:"=",plans:"="},controller:AccountBillingCtrl,controllerAs:"vm",bindToController:!0}}function AccountBillingCtrl($scope,$window,$timeout,UtilsService,serverConfig){function setupLicensesInfo(){vm.numLicenses=vm.subscriptions.filter(function(sub){return sub.inCurrentAgreement}).length,vm.numNewLicenses=vm.numLicenses,vm.pricePerLicense=vm.plans[0].amount}function aRequiredAddressFieldIsEmpty(){return angular.isUndefined(vm.newBillingAddress.firstName)||angular.isUndefined(vm.newBillingAddress.lastName)||angular.isUndefined(vm.newBillingAddress.line1)||angular.isUndefined(vm.newBillingAddress.postalCode)||angular.isUndefined(vm.newBillingAddress.city)||angular.isUndefined(vm.newBillingAddress.countryCode)||angular.isDefined(vm.newBillingAddress.vat)&&""!==vm.newBillingAddress.vat&&angular.isUndefined(vm.newBillingAddress.company)||"US"===vm.newBillingAddress.countryCode&&angular.isUndefined(vm.newBillingAddress.state)}var promise,vm=this;vm.showInfo=!0,vm.saveDisabled=!0,vm.countries=serverConfig.countries,vm.usStates=serverConfig.usStates,vm.showStates=!1,vm.newBillingAddress={},$scope.$watch("vm.numNewLicenses",function(){angular.isDefined(vm.numNewLicenses)?(console.log(vm.numLicenses,vm.numNewLicenses),0===vm.numLicenses&&0===vm.numNewLicenses?vm.saveDisabled=!0:vm.numLicenses===vm.numNewLicenses?vm.saveDisabled=angular.equals(vm.newBillingAddress,vm.billingAddress)||aRequiredAddressFieldIsEmpty():vm.saveDisabled=aRequiredAddressFieldIsEmpty(),vm.priceLicenses=vm.numNewLicenses*vm.pricePerLicense):vm.saveDisabled=!0}),$scope.$watch("vm.billingAddress",function(){angular.isDefined(vm.billingAddress)&&(vm.newBillingAddress=angular.copy(vm.billingAddress),vm.countrySelectDisabled=angular.isDefined(vm.billingAddress.countryCode))},!0),$scope.$watch("vm.newBillingAddress",function(){angular.isDefined(vm.newBillingAddress)&&(0!==vm.numNewLicenses&&(vm.saveDisabled=angular.equals(vm.newBillingAddress,vm.billingAddress)||aRequiredAddressFieldIsEmpty(),vm.companyNameRequired=angular.isDefined(vm.newBillingAddress.vat)&&""!==vm.newBillingAddress.vat),vm.showStates="US"===vm.newBillingAddress.countryCode)},!0),$scope.$watch("vm.subscriptions",function(){angular.isDefined(vm.subscriptions)&&angular.isDefined(vm.plans)&&setupLicensesInfo()},!0),$scope.$watch("vm.plans",function(){angular.isDefined(vm.subscriptions)&&angular.isDefined(vm.plans)&&setupLicensesInfo()},!0),$scope.$watch("vm.billings",function(){var i,length;if(angular.isDefined(vm.billings))for(i=0,length=vm.billings.length;i<length;i+=1)"refund"===vm.billings[i].type?(vm.billings[i].status="Completed",vm.billings[i].description="Refund"):(vm.billings[i].status=vm.billings[i].pending?"Pending":"Paid",vm.billings[i].description=vm.billings[i].items[0].description)}),vm.downloadBilling=function(index){$window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/billings/"+vm.billings[index].invoiceNo+".pdf"),"_blank")},vm.changeSubscription=function(){var data={plans:[{plan:"THE-100-QUID-PLAN",quantity:vm.numNewLicenses}],billingAddress:vm.newBillingAddress};vm.numLicenses===vm.numNewLicenses?vm.payPalInfo="Updating billing information. Please do not refresh the page or close the tab.":vm.payPalInfo="Redirecting to PayPal. Please do not refresh the page or close the tab.",UtilsService.showDialog("paypalDialog.html",$scope,null,!0),promise=UtilsService.doPost(data,vm.account+"/subscriptions"),promise.then(function(response){console.log(response),200===response.status?vm.numLicenses===vm.numNewLicenses?(vm.payPalInfo="Billing information updated.",$timeout(function(){UtilsService.closeDialog()},2e3)):location.href=response.data.url:(vm.closeDialogEnabled=!0,vm.changeHelpToShow=response.data.value,vm.payPalInfo=response.data.message)})},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("accountBilling",accountBilling),AccountBillingCtrl.$inject=["$scope","$window","$timeout","UtilsService","serverConfig"]}(),function(){"use strict";function accountDir(){return{restrict:"EA",templateUrl:"account.html",scope:{state:"=",query:"=",account:"="},controller:AccountCtrl,controllerAs:"vm",bindToController:!0}}function AccountCtrl($scope,$injector,$location,$timeout,AccountService,Auth,UtilsService){function loginStatusListener(event){"tdrLoggedIn"===event.key&&"false"===event.newValue&&Auth.logout()}function init(){var billingsPromise,subscriptionsPromise,plansPromise;getUserInfo(),billingsPromise=UtilsService.doGet(vm.account+"/billings"),billingsPromise.then(function(response){vm.billings=response.data}),subscriptionsPromise=UtilsService.doGet(vm.account+"/subscriptions"),subscriptionsPromise.then(function(response){vm.subscriptions=response.data}),plansPromise=UtilsService.doGet("plans"),plansPromise.then(function(response){200===response.status&&(vm.plans=response.data)})}function getUserInfo(){var userInfoPromise;userInfoPromise=AccountService.getUserInfo(vm.account),userInfoPromise.then(function(response){var i,length;if(vm.accounts=response.data.accounts,vm.username=vm.account,vm.firstName=response.data.firstName,vm.lastName=response.data.lastName,vm.email=response.data.email,vm.hasAvatar=response.data.hasAvatar,vm.billingAddress={},response.data.hasOwnProperty("billingInfo")&&(vm.billingAddress=response.data.billingInfo,vm.billingAddress.hasOwnProperty("firstName")||(vm.billingAddress.firstName=vm.firstName,vm.billingAddress.lastName=vm.lastName)),angular.isDefined(vm.accounts))for(i=0,length=vm.accounts.length;i<length;i+=1)if(vm.accounts[i].account===vm.account){vm.quota=vm.accounts[i].quota;break}})}var vm=this;$scope.$watchGroup(["vm.account","vm.query.page"],function(){var promise;vm.account||vm.query.page?vm.query.hasOwnProperty("page")?($injector.has("account"+UtilsService.capitalizeFirstLetter(vm.query.page)+"Directive")?vm.itemToShow=vm.query.page:vm.itemToShow="repos","billing"===vm.itemToShow?$location.search().hasOwnProperty("cancel")?($location.search("token",null),$location.search("cancel",null),init()):$location.search().hasOwnProperty("token")?(getUserInfo(),vm.payPalInfo="PayPal payment processing. Please do not refresh the page or close the tab.",vm.closeDialogEnabled=!1,UtilsService.showDialog("paypalDialog.html",$scope),promise=UtilsService.doPost({token:$location.search().token},"payment/paypal/execute"),promise.then(function(response){200===response.status,vm.payPalInfo="PayPal has finished processing. Thank you.",$location.search("token",null),$timeout(function(){UtilsService.closeDialog(),init()},2e3)})):init():init()):(vm.itemToShow="repos",init()):(vm.username=null,vm.firstName=null,vm.lastName=null,vm.email=null,vm.projectsGrouped=null,vm.avatarUrl=null)}),vm.showItem=function(item){vm.itemToShow=item},vm.showPage=function(page,callingPage){vm.itemToShow=page,$location.search("page",page),vm.callingPage=callingPage},window.addEventListener("storage",loginStatusListener,!1),"false"===localStorage.getItem("tdrLoggedIn")&&null!==vm.account&&localStorage.setItem("tdrLoggedIn",vm.account)}angular.module("3drepo").directive("accountDir",accountDir),AccountCtrl.$inject=["$scope","$injector","$location","$timeout","AccountService","Auth","UtilsService"]}(),function(){"use strict";function accountFederations(){return{restrict:"EA",templateUrl:"accountFederations.html",scope:{account:"=",accounts:"=",onShowPage:"&",quota:"=",subscriptions:"="},controller:AccountFederationsCtrl,controllerAs:"vm",bindToController:!0}}function AccountFederationsCtrl($scope,$location,$timeout,UtilsService){function setupEditFederation(event,projectIndex){var i,j,iLength,jLength;for(vm.showRemoveWarning=!1,vm.userAccount=angular.copy(userAccount),vm.federationOriginalData=vm.accountsToUse[0].fedProjects[projectIndex],vm.newFederationData=angular.copy(vm.federationOriginalData),vm.newFederationData.hasOwnProperty("subProjects")||(vm.newFederationData.subProjects=[]),i=0,iLength=vm.userAccount.projects.length;i<iLength;i+=1)if(vm.userAccount.projects[i].federated=!1,vm.federationOriginalData.hasOwnProperty("subProjects"))for(j=0,jLength=vm.federationOriginalData.subProjects.length;j<jLength;j+=1)vm.federationOriginalData.subProjects[j].project===vm.userAccount.projects[i].project&&(vm.userAccount.projects[i].federated=!0);UtilsService.showDialog("federationDialog.html",$scope,event)}function setupDelete(event,index){federationToDeleteIndex=index,vm.deleteError=null,vm.deleteTitle="Delete Federation",vm.deleteWarning="This federation will be lost permanently and will not be recoverable",vm.deleteName=vm.accountsToUse[0].fedProjects[federationToDeleteIndex].project,UtilsService.showDialog("deleteDialog.html",$scope,event,!0)}function setupEditTeam(event,index){vm.item=vm.accountsToUse[0].fedProjects[index],UtilsService.showDialog("teamDialog.html",$scope,event)}var federationToDeleteIndex,userAccount,accountsToUse,vm=this;vm.federationOptions={edit:{label:"Edit",icon:"edit"},team:{label:"Team",icon:"group"},delete:{label:"Delete",icon:"delete"}},vm.units=server_config.units,$scope.$watch("vm.accounts",function(){var i,length;if(angular.isDefined(vm.accounts)&&(vm.showInfo=!0,vm.accounts.length>0)){for(accountsToUse=[],i=0,length=vm.accounts.length;i<length;i+=1)0===i?(vm.accounts[i].showProjects=!0,accountsToUse.push(vm.accounts[i]),vm.accounts[i].fedProjects.length>0&&(vm.showInfo=!1),userAccount=vm.accounts[i]):vm.accounts[i].fedProjects.length>0&&(vm.accounts[i].showProjects=!0,accountsToUse.push(vm.accounts[i]),vm.showInfo=!1);vm.accountsToUse=angular.copy(accountsToUse),console.log(vm.accountsToUse)}}),$scope.$watch("vm.newFederationData",function(){null===vm.federationOriginalData?vm.newFederationButtonDisabled=angular.isUndefined(vm.newFederationData.project)||""===vm.newFederationData.project||!vm.newFederationData.unit:vm.newFederationButtonDisabled=angular.equals(vm.newFederationData,vm.federationOriginalData)},!0),vm.setupNewFederation=function(event){vm.userAccount=angular.copy(userAccount),vm.federationOriginalData=null,vm.newFederationData={desc:"",type:"",subProjects:[]},UtilsService.showDialog("federationDialog.html",$scope,event)},vm.closeDialog=function(){UtilsService.closeDialog()},vm.toggleShowProjects=function(index){vm.accountsToUse[index].showProjects=!vm.accountsToUse[index].showProjects,vm.accountsToUse[index].showProjectsIcon=vm.accountsToUse[index].showProjects?"folder_open":"folder"},vm.addToFederation=function(projectIndex){vm.showRemoveWarning=!1,vm.newFederationData.subProjects.push({database:vm.userAccount.account,projectIndex:projectIndex,project:vm.userAccount.projects[projectIndex].project}),vm.userAccount.projects[projectIndex].federated=!0},vm.removeFromFederation=function(index){var i,length,item;if(vm.newFederationData.hasOwnProperty("timestamp")&&1===vm.newFederationData.subProjects.length)vm.showRemoveWarning=!0;else for(item=vm.newFederationData.subProjects.splice(index,1),i=0,length=vm.userAccount.projects.length;i<length;i+=1)if(vm.userAccount.projects[i].project===item[0].project){vm.userAccount.projects[i].federated=!1;break}},vm.saveFederation=function(){var promise;null===vm.federationOriginalData?(promise=UtilsService.doPost(vm.newFederationData,vm.account+"/"+vm.newFederationData.project),promise.then(function(response){console.log(response),vm.showInfo=!1,vm.newFederationData.timestamp=(new Date).toString(),vm.accountsToUse[0].fedProjects.push(vm.newFederationData),vm.closeDialog()})):(promise=UtilsService.doPut(vm.newFederationData,vm.account+"/"+vm.newFederationData.project),promise.then(function(response){console.log(response),vm.federationOriginalData.subProjects=vm.newFederationData.subProjects,vm.closeDialog()})),$timeout(function(){$scope.$apply()})},vm.viewFederation=function(event,accountIndex,projectIndex){console.log(vm.accountsToUse[accountIndex]),0!==accountIndex||vm.accountsToUse[accountIndex].fedProjects[projectIndex].hasOwnProperty("subProjects")?$location.path("/"+vm.accountsToUse[accountIndex].account+"/"+vm.accountsToUse[accountIndex].fedProjects[projectIndex].project,"_self").search({}):setupEditFederation(event,projectIndex)},vm.doFederationOption=function(event,option,federationIndex){switch(option){case"edit":setupEditFederation(event,federationIndex);break;case"team":setupEditTeam(event,federationIndex);break;case"delete":setupDelete(event,federationIndex)}},vm.delete=function(){var promise=UtilsService.doDelete({},vm.account+"/"+vm.accountsToUse[0].fedProjects[federationToDeleteIndex].project);promise.then(function(response){200===response.status?(vm.accountsToUse[0].fedProjects.splice(federationToDeleteIndex,1),vm.showInfo=1===vm.accountsToUse.length&&0===vm.accountsToUse[0].fedProjects.length,vm.closeDialog()):vm.deleteError="Error deleting federation"})},vm.toggleProjectsList=function(index){vm.accountsToUse[index].showProjects=!vm.accountsToUse[index].showProjects,vm.accountsToUse[index].showProjectsIcon=vm.accountsToUse[index].showProjects?"folder_open":"folder"}}angular.module("3drepo").directive("accountFederations",accountFederations),AccountFederationsCtrl.$inject=["$scope","$location","$timeout","UtilsService"]}(),function(){"use strict";function accountInfo(){return{restrict:"E",templateUrl:"accountInfo.html",scope:{username:"=",firstName:"=",lastName:"=",email:"=",itemToShow:"=",hasAvatar:"="},controller:AccountInfoCtrl,controllerAs:"vm",bindToController:!0}}function AccountInfoCtrl($location,$scope,serverConfig,UtilsService){function getAvatarUrl(){return serverConfig.apiUrl(serverConfig.GET_API,vm.username+"/avatar")+"?"+(new Date).valueOf()}var vm=this;console.log("accountinfo",$scope),vm.accountOptions={repos:{label:"Repos"},profile:{label:"Profile"},billing:{label:"Billing"},licenses:{label:"Licenses"}},vm.showItem=function(item){vm.itemToShow=item,$location.search({}).search("page",item)},$scope.$watchGroup(["vm.username","vm.hasAvatar"],function(){vm.username&&vm.hasAvatar&&(vm.avatarUrl=getAvatarUrl())}),vm.upload=function(){var file=document.createElement("input");file.setAttribute("type","file"),file.setAttribute("accept",".gif,.jpg,.jpeg,.png"),file.click(),file.addEventListener("change",function(){vm.uploadingAvatar=!0;var formData=new FormData;formData.append("file",file.files[0]),UtilsService.doPost(formData,vm.username+"/avatar",{"Content-Type":void 0}).then(function(res){vm.uploadingAvatar=!1,console.log(res),200===res.status?vm.avatarUrl=getAvatarUrl():console.log("Upload avatar error",res.data)}),$scope.$apply()})}}angular.module("3drepo").directive("accountInfo",accountInfo),AccountInfoCtrl.$inject=["$location","$scope","serverConfig","UtilsService"]}(),function(){"use strict";function accountLicenses(){return{restrict:"EA",templateUrl:"accountLicenses.html",scope:{account:"=",showPage:"&",subscriptions:"="},controller:AccountLicensesCtrl,controllerAs:"vm",bindToController:!0}}function AccountLicensesCtrl($scope,UtilsService,StateManager){var i,promise,vm=this;$scope.$watch("vm.subscriptions",function(){for(vm.unassigned=[],vm.licenses=[],vm.allLicensesAssigned=!1,vm.numLicenses=vm.subscriptions.length,vm.toShow=vm.numLicenses>0?"0+":"0",i=0;i<vm.numLicenses;i+=1)vm.subscriptions[i].hasOwnProperty("assignedUser")?vm.licenses.push({user:vm.subscriptions[i].assignedUser,id:vm.subscriptions[i]._id,showRemove:vm.subscriptions[i].assignedUser!==vm.account}):vm.unassigned.push(vm.subscriptions[i]._id);vm.allLicensesAssigned=0===vm.unassigned.length}),$scope.$watch("vm.newLicenseAssignee",function(newValue){vm.addMessage="",vm.addDisabled=!(angular.isDefined(newValue)&&""!==newValue.toString())}),vm.assignLicense=function(event){var doSave=!1,enterKey=13;angular.isDefined(event)?event.which===enterKey&&(doSave=!0):doSave=!0,doSave&&(promise=UtilsService.doPost({user:vm.newLicenseAssignee},vm.account+"/subscriptions/"+vm.unassigned[0]+"/assign"),promise.then(function(response){console.log(response),200===response.status?(vm.addMessage="User "+vm.newLicenseAssignee+" assigned a license",vm.licenses.push({user:response.data.assignedUser,id:response.data._id,showRemove:!0}),vm.unassigned.splice(0,1),vm.allLicensesAssigned=0===vm.unassigned.length,vm.addDisabled=vm.allLicensesAssigned,vm.newLicenseAssignee=""):400===response.status?vm.addMessage="This user has already been assigned a license":404===response.status&&(vm.addMessage="User not found")}))},vm.removeLicense=function(index){promise=UtilsService.doDelete({},vm.account+"/subscriptions/"+vm.licenses[index].id+"/assign"),promise.then(function(response){console.log(response),200===response.status?(vm.unassigned.push(vm.licenses[index].id),vm.licenses.splice(index,1),vm.addDisabled=!1,vm.allLicensesAssigned=!1):400===response.data.status&&94===response.data.value&&(vm.licenseAssigneeIndex=index,vm.userProjects=response.data.projects,UtilsService.showDialog("removeLicenseDialog.html",$scope))})},vm.removeLicenseConfirmed=function(){promise=UtilsService.doDelete({},vm.account+"/subscriptions/"+vm.licenses[vm.licenseAssigneeIndex].id+"/assign?cascadeRemove=true"),promise.then(function(response){console.log(response),200===response.status&&(vm.unassigned.push(vm.licenses[vm.licenseAssigneeIndex].id),vm.licenses.splice(vm.licenseAssigneeIndex,1),vm.addDisabled=!1,UtilsService.closeDialog())})},vm.goToBillingPage=function(){StateManager.setQuery({page:"billing"})}}angular.module("3drepo").directive("accountLicenses",accountLicenses),AccountLicensesCtrl.$inject=["$scope","UtilsService","StateManager"]}(),function(){"use strict";function accountMenu(){return{restrict:"EA",templateUrl:"accountMenu.html",scope:{account:"="},controller:AccountMenuCtrl,controllerAs:"vm",bindToController:!0}}function AccountMenuCtrl(Auth,EventService){var vm=this;vm.openMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)},vm.showProjects=function(){EventService.send(EventService.EVENT.SHOW_PROJECTS)},vm.logout=function(){Auth.logout()}}angular.module("3drepo").directive("accountMenu",accountMenu),AccountMenuCtrl.$inject=["Auth","EventService"]}(),function(){"use strict";function accountProfile(){return{restrict:"EA",templateUrl:"accountProfile.html",scope:{username:"=",firstName:"=",lastName:"=",email:"="},controller:AccountProfileCtrl,controllerAs:"vm",bindToController:!0}}function AccountProfileCtrl(AccountService){var promise,vm=this;vm.showInfo=!0,vm.showChangePassword=!1,vm.firstNameNew=vm.firstName,vm.lastNameNew=vm.lastName,vm.emailNew=vm.email,vm.updateInfo=function(){promise=AccountService.updateInfo(vm.username,{email:vm.emailNew,firstName:vm.firstNameNew,lastName:vm.lastNameNew}),promise.then(function(response){console.log(response),"OK"===response.statusText?(vm.infoSaveInfo="Saved",vm.firstName=vm.firstNameNew,vm.lastName=vm.lastNameNew,vm.email=vm.emailNew):vm.infoSaveInfo="Error saving info"})},vm.updatePassword=function(){promise=AccountService.updatePassword(vm.username,{oldPassword:vm.oldPassword,newPassword:vm.newPassword}),promise.then(function(response){console.log(response),"OK"===response.statusText?vm.passwordSaveInfo="Saved":vm.passwordSaveInfo="Error saving password"})},vm.toggleInfo=function(){vm.showInfo=!vm.showInfo},vm.toggleChangePassword=function(){vm.showChangePassword=!vm.showChangePassword}}angular.module("3drepo").directive("accountProfile",accountProfile),AccountProfileCtrl.$inject=["AccountService"]}(),function(){"use strict";function accountProject(){return{restrict:"E",templateUrl:"accountProject.html",scope:{account:"=",project:"=",onUploadFile:"&",uploadedFile:"=",onShowPage:"&",onSetupDeleteProject:"&",quota:"=",subscriptions:"="},controller:AccountProjectCtrl,controllerAs:"vm",bindToController:!0,link:function(scope,element){element.on("$destroy",function(){scope.vm.uploadedFileWatch()})}}}function AccountProjectCtrl($scope,$location,$timeout,$interval,$filter,UtilsService,serverConfig,RevisionsService){function uploadFileToProject(file,tag,desc){var promise,formData;promise=UtilsService.doGet(vm.account+".json"),promise.then(function(response){file.size>response.data.accounts[0].quota.spaceLimit?UtilsService.showDialog("overQuotaDialog.html",$scope,null,!0):(vm.project.uploading=!0,vm.showUploading=!0,vm.showFileUploadInfo=!1,file.size>serverConfig.uploadSizeLimit?$timeout(function(){vm.showUploading=!1,vm.showFileUploadInfo=!0,vm.fileUploadInfo="File exceeds size limit",$timeout(function(){vm.project.uploading=!1},infoTimeout)}):(vm.uploadFileName=file.name,formData=new FormData,formData.append("file",file),tag&&formData.append("tag",tag),desc&&formData.append("desc",desc),promise=UtilsService.doPost(formData,vm.account+"/"+vm.project.name+"/upload",{"Content-Type":void 0}),promise.then(function(response){console.log("uploadModel",response),400===response.status||404===response.status?(68===response.data.value?vm.fileUploadInfo="Unsupported file format":66===response.data.value?vm.fileUploadInfo="Insufficient quota for model":vm.fileUploadInfo=response.data.message,vm.showUploading=!1,vm.showFileUploadInfo=!0,$timeout(function(){vm.project.uploading=!1},infoTimeout)):(console.log("Polling upload!"),pollUpload())})))})}function checkFileUploading(){var promise=UtilsService.doGet(vm.account+"/"+vm.project.name+".json");promise.then(function(response){"processing"===response.data.status&&(vm.project.uploading=!0,vm.showUploading=!0,vm.showFileUploadInfo=!1,pollUpload())})}function pollUpload(){var interval,promise;
interval=$interval(function(){promise=UtilsService.doGet(vm.account+"/"+vm.project.name+".json"),promise.then(function(response){console.log("uploadStatus",response),"ok"!==response.data.status&&"failed"!==response.data.status||("ok"===response.data.status?(vm.project.timestamp=new Date,vm.project.timestampPretty=$filter("prettyDate")(vm.project.timestamp,{showSeconds:!0}),vm.fileUploadInfo="Uploaded",vm.revisions=null):response.data.hasOwnProperty("errorReason")?vm.fileUploadInfo=response.data.errorReason.message:vm.fileUploadInfo="Failed to upload file",vm.showUploading=!1,$interval.cancel(interval),vm.showFileUploadInfo=!0,$timeout(function(){vm.project.uploading=!1},infoTimeout))})},1e3)}function setupEditTeam(event){vm.item=vm.project,UtilsService.showDialog("teamDialog.html",$scope,event)}function getRevision(){return vm.revisions?Promise.resolve(vm.revisions):RevisionsService.listAll(vm.account,vm.project.name).then(function(revisions){return vm.revisions=revisions,Promise.resolve(revisions)})}var vm=this,infoTimeout=4e3;vm.project.name=vm.project.project,null!==vm.project.timestamp&&(vm.project.timestampPretty=$filter("prettyDate")(vm.project.timestamp,{showSeconds:!0})),vm.project.canUpload=!0,vm.projectOptions={upload:{label:"Upload file",icon:"cloud_upload"},projectsetting:{label:"Settings",icon:"settings"},revision:{label:"Revisions",icon:"settings_backup_restore"},team:{label:"Team",icon:"group"},delete:{label:"Delete",icon:"delete"}},vm.project.timestamp&&!vm.project.federate&&(vm.projectOptions.download={label:"Download",icon:"cloud_download"}),checkFileUploading(),vm.uploadedFileWatch=$scope.$watch("vm.uploadedFile",function(){angular.isDefined(vm.uploadedFile)&&null!==vm.uploadedFile&&vm.uploadedFile.project.name===vm.project.name&&(console.log("Uploaded file",vm.uploadedFile),uploadFileToProject(vm.uploadedFile.file,vm.uploadedFile.tag,vm.uploadedFile.desc))}),vm.goToProject=function(){vm.project.uploading||(null===vm.project.timestamp?UtilsService.showDialog("uploadProjectDialog.html",$scope,event,!0):$location.path("/"+vm.account+"/"+vm.project.name,"_self").search("page",null))},vm.doProjectOption=function(event,option){switch(option){case"projectsetting":console.log("Settings clicked"),$location.search("proj",vm.project.name),vm.onShowPage({page:"projectsetting",callingPage:"repos"});break;case"upload":vm.uploadErrorMessage=null,UtilsService.showDialog("uploadProjectDialog.html",$scope,event,!0);break;case"download":window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/"+vm.project.name+"/download/latest"),"_blank");break;case"team":setupEditTeam(event);break;case"delete":vm.onSetupDeleteProject({event:event,project:vm.project});break;case"revision":getRevision(),UtilsService.showDialog("revisionsDialog.html",$scope,event,!0)}},vm.setupAddLicenses=function(){vm.onShowPage({page:"billing",callingPage:"repos"}),UtilsService.closeDialog()},vm.closeDialog=function(){UtilsService.closeDialog()},vm.selectFile=function(){vm.file=document.createElement("input"),vm.file.setAttribute("type","file"),vm.file.click(),vm.file.addEventListener("change",function(){vm.selectedFile=vm.file.files[0];var names=vm.selectedFile.name.split(".");vm.uploadButtonDisabled=!1,vm.uploadErrorMessage=null,1===names.length?(vm.uploadErrorMessage="Filename must have extension",vm.uploadButtonDisabled=!0):serverConfig.acceptedFormat.indexOf(names[names.length-1])===-1&&(vm.uploadErrorMessage="File format not supported",vm.uploadButtonDisabled=!0),$scope.$apply()})},vm.uploadFile=function(){vm.uploadErrorMessage=null,vm.tag&&RevisionsService.isTagFormatInValid(vm.tag)?vm.uploadErrorMessage="Invalid revision name":getRevision().then(function(revisions){vm.tag&&revisions.forEach(function(rev){rev.tag===vm.tag&&(vm.uploadErrorMessage="Revision name already exists")}),vm.uploadErrorMessage||(vm.uploadedFile={project:vm.project,file:vm.file.files[0],tag:vm.tag,desc:vm.desc},vm.closeDialog())})},vm.goToRevision=function(revId){console.log(revId),$location.path("/"+vm.account+"/"+vm.project.name+"/"+revId,"_self")}}angular.module("3drepo").directive("accountProject",accountProject),AccountProjectCtrl.$inject=["$scope","$location","$timeout","$interval","$filter","UtilsService","serverConfig","RevisionsService"]}(),function(){"use strict";function accountProjects(){return{restrict:"EA",templateUrl:"accountProjects.html",scope:{account:"=",accounts:"=",onShowPage:"&",quota:"=",subscriptions:"="},controller:AccountProjectsCtrl,controllerAs:"vm",bindToController:!0}}function AccountProjectsCtrl($scope,$location,$element,$timeout,AccountService,UtilsService,RevisionsService,serverConfig){function updateAccountProjects(account,project){var i,length,accountToUpdate;for(i=0,length=vm.accounts.length;i<length;i+=1)if(vm.accounts[i].name===account){accountToUpdate=vm.accounts[i],accountToUpdate.projects.push(project);break}angular.isUndefined(accountToUpdate)&&(accountToUpdate={name:account,projects:[project],showProjects:!0,showProjectsIcon:"folder_open"},accountToUpdate.canUpload=account===vm.account,vm.accounts.push(accountToUpdate)),null!==vm.newProjectFileToUpload&&$timeout(function(){vm.uploadedFile={project:project,file:vm.newProjectFileToUpload,tag:vm.tag,desc:vm.desc}})}var newProjectFileUploader,vm=this;vm.info="Retrieving projects...",vm.showProgress=!0,vm.projectTypes=["Architectural","Structural","Mechanical","GIS","Other"],vm.units=serverConfig.units,newProjectFileUploader=$element[0].querySelector("#newProjectFileUploader"),newProjectFileUploader.addEventListener("change",function(){vm.newProjectFileToUpload=this.files[0],vm.newProjectFileSelected=!0,$scope.$apply()},!1),$scope.$watch("vm.accounts",function(){var i,length;if(angular.isDefined(vm.accounts))for(console.log(vm.accounts),vm.showProgress=!1,vm.projectsExist=vm.accounts.length>0,vm.info=vm.projectsExist?"":"There are currently no projects",i=0,length=vm.accounts.length;i<length;i+=1)vm.accounts[i].name=vm.accounts[i].account,vm.accounts[i].showProjects=!0,vm.accounts[i].showProjectsIcon="folder_open",vm.accounts[i].showAccount=0===i||0!==vm.accounts[i].projects.length}),$scope.$watch("vm.newProjectData.type",function(newValue){angular.isDefined(newValue)&&(vm.showProjectTypeOtherInput="Other"===newValue.toString())}),$scope.$watch("{a : vm.newProjectData, b: vm.newProjectFileToUpload.name}",function(data){var newValue=vm.newProjectData;if(vm.showNewProjectErrorMessage=!1,vm.newProjectErrorMessage="",angular.isDefined(newValue)&&(vm.newProjectButtonDisabled=angular.isUndefined(newValue.name)||angular.isDefined(newValue.name)&&""===newValue.name,vm.newProjectButtonDisabled||"Other"!==newValue.type||(vm.newProjectButtonDisabled=angular.isUndefined(newValue.otherType)||angular.isDefined(newValue.otherType)&&""===newValue.otherType),newValue.unit||(vm.newProjectButtonDisabled=!0)),vm.newProjectFileToUpload){var names=vm.newProjectFileToUpload.name.split(".");1===names.length?(vm.showNewProjectErrorMessage=!0,vm.newProjectErrorMessage="Filename must have extension",vm.newProjectButtonDisabled=!0):serverConfig.acceptedFormat.indexOf(names[names.length-1])===-1&&(vm.showNewProjectErrorMessage=!0,vm.newProjectErrorMessage="File format not supported",vm.newProjectButtonDisabled=!0)}},!0),$scope.$watch("vm.newDatabaseName",function(newValue){angular.isDefined(newValue)&&(vm.newDatabaseButtonDisabled=angular.isUndefined(newValue)||angular.isDefined(newValue)&&""===newValue.toString())},!0),vm.toggleProjectsList=function(index){vm.accounts[index].showProjects=!vm.accounts[index].showProjects,vm.accounts[index].showProjectsIcon=vm.accounts[index].showProjects?"folder_open":"folder"},vm.newProject=function(event){vm.tag=null,vm.desc=null,vm.showNewProjectErrorMessage=!1,vm.newProjectFileSelected=!1,vm.newProjectData={account:vm.account,type:vm.projectTypes[0]},vm.newProjectFileToUpload=null,UtilsService.showDialog("projectDialog.html",$scope,event,!0)},vm.closeDialog=function(){UtilsService.closeDialog()},vm.saveNewProject=function(event){var project,promise,enterKey=13,doSave=!1;if(angular.isDefined(event)?event.which===enterKey&&(doSave=!0):doSave=!0,doSave){if(RevisionsService.isTagFormatInValid(vm.tag))return vm.showNewProjectErrorMessage=!0,void(vm.newProjectErrorMessage="Invalid revision name");promise=AccountService.newProject(vm.newProjectData),promise.then(function(response){console.log(response),400===response.data.status?(vm.showNewProjectErrorMessage=!0,vm.newProjectErrorMessage=response.data.message):(vm.projectsExist=!0,project={project:response.data.project,canUpload:!0,timestamp:null},updateAccountProjects(response.data.account,project),vm.closeDialog())})}},vm.uploadFileForNewProject=function(){newProjectFileUploader.value="",newProjectFileUploader.click()},vm.newDatabase=function(event){vm.newDatabaseName="",vm.showPaymentWait=!1,vm.newDatabaseToken=!1,UtilsService.showDialog("databaseDialog.html",$scope,event,!0)},vm.saveNewDatabase=function(){var promise=AccountService.newDatabase(vm.account,vm.newDatabaseName);promise.then(function(response){console.log(response),vm.newDatabaseToken=response.data.token,vm.paypalReturnUrl=$location.protocol()+"://"+$location.host()+"/"+vm.account})},vm.setupPayment=function(){$timeout(function(){vm.showPaymentWait=!0})},vm.setupDeleteProject=function(event,project){vm.projectToDelete=project,vm.deleteError=null,vm.deleteTitle="Delete Project",vm.deleteWarning="Your data will be lost permanently and will not be recoverable",vm.deleteName=vm.projectToDelete.name,UtilsService.showDialog("deleteDialog.html",$scope,event,!0)},vm.delete=function(){var i,iLength,j,jLength,promise;promise=UtilsService.doDelete({},vm.account+"/"+vm.projectToDelete.name),promise.then(function(response){if(200===response.status){for(i=0,iLength=vm.accounts.length;i<iLength;i+=1)if(vm.accounts[i].name===response.data.account)for(j=0,jLength=vm.accounts[i].projects.length;j<jLength;j+=1)if(vm.accounts[i].projects[j].name===response.data.project){vm.accounts[i].projects.splice(j,1);break}vm.closeDialog()}else vm.deleteError="Error deleting project"})},vm.removeCollaborator=function(collaborator){delete vm.collaborators[collaborator]},vm.showPage=function(page,callingPage){vm.onShowPage({page:page,callingPage:callingPage})}}angular.module("3drepo").directive("accountProjects",accountProjects),AccountProjectsCtrl.$inject=["$scope","$location","$element","$timeout","AccountService","UtilsService","RevisionsService","serverConfig"]}(),function(){"use strict";function accountProjectsetting(){return{restrict:"EA",templateUrl:"accountProjectsetting.html",scope:{account:"=",showPage:"&",subscriptions:"="},controller:AccountProjectsettingCtrl,controllerAs:"vm",bindToController:!0}}function AccountProjectsettingCtrl($scope,$location,UtilsService,StateManager){var vm=this;vm.goBack=function(){$location.search("project",null),vm.showPage({page:"repos"})},vm.units=server_config.units,vm.mapTile={},vm.projectName=$location.search().proj,UtilsService.doGet(vm.account+"/"+vm.projectName+".json").then(function(response){200===response.status&&response.data.properties?(response.data.properties.mapTile&&(response.data.properties.mapTile.lat&&(vm.mapTile.lat=response.data.properties.mapTile.lat),response.data.properties.mapTile.lon&&(vm.mapTile.lon=response.data.properties.mapTile.lon),response.data.properties.mapTile.y&&(vm.mapTile.y=response.data.properties.mapTile.y),vm.projectType=response.data.type),response.data.properties.unit&&(vm.unit=response.data.properties.unit)):vm.message=response.data.message}),vm.save=function(){var data={mapTile:vm.mapTile,unit:vm.unit};UtilsService.doPut(data,vm.account+"/"+vm.projectName+"/settings").then(function(response){200===response.status?vm.message="Saved":vm.message=response.data.message})}}angular.module("3drepo").directive("accountProjectsetting",accountProjectsetting),AccountProjectsettingCtrl.$inject=["$scope","$location","UtilsService","StateManager"]}(),function(){"use strict";function accountRepos(){return{restrict:"EA",templateUrl:"accountRepos.html",scope:{account:"=",accounts:"=",onShowPage:"&",quota:"=",subscriptions:"="},controller:AccountReposCtrl,controllerAs:"vm",bindToController:!0}}function AccountReposCtrl(){var vm=this;vm.showPage=function(page,callingPage){vm.onShowPage({page:page,callingPage:callingPage})}}angular.module("3drepo").directive("accountRepos",accountRepos),AccountReposCtrl.$inject=[]}(),function(){"use strict";function AccountService($http,$q,serverConfig,UtilsService){function doPost(data,urlEnd,headers){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,urlEnd),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(url,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}function doPut(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,urlEnd),config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}var bid4free,obj={};return obj.updateInfo=function(username,info){return doPut(info,username)},obj.updatePassword=function(username,passwords){return doPut(passwords,username)},obj.getProjectsBid4FreeStatus=function(username){return bid4free=$q.defer(),$http.get(serverConfig.apiUrl(serverConfig.GET_API,username+".json"),{params:{bids:!0}}).then(function(response){bid4free.resolve(response)}),bid4free.promise},obj.newProject=function(projectData){var data={desc:"",type:"Other"===projectData.type?projectData.otherType:projectData.type,unit:projectData.unit};return doPost(data,projectData.account+"/"+projectData.name)},obj.uploadModel=function(projectData){var data=new FormData;return data.append("file",projectData.uploadFile),doPost(data,projectData.account+"/"+projectData.project+"/upload",{"Content-Type":void 0})},obj.uploadStatus=function(projectData){return UtilsService.doGet(projectData.account+"/"+projectData.project+".json")},obj.newDatabase=function(account,databaseName){var data={database:databaseName,plan:"THE-100-QUID-PLAN"};return doPost(data,account+"/database")},obj.newSubscription=function(account,data){return doPost(data,account+"/subscriptions")},obj.getUserInfo=function(username){return UtilsService.doGet(username+".json")},obj}angular.module("3drepo").factory("AccountService",AccountService),AccountService.$inject=["$http","$q","serverConfig","UtilsService"]}(),function(){"use strict";function accountTeam(){return{restrict:"EA",templateUrl:"accountTeam.html",scope:{account:"=",item:"=",showPage:"&",subscriptions:"="},controller:AccountTeamCtrl,controllerAs:"vm",bindToController:!0}}function AccountTeamCtrl($scope,$location,UtilsService,StateManager){function createFilterFor(query){var lowercaseQuery=angular.lowercase(query);return function(user){return 0===user.user.indexOf(lowercaseQuery)}}function setupTeam(){var i,iLength,j,jLength,isMember;for(i=0,iLength=vm.numSubscriptions;i<iLength;i+=1)if(vm.subscriptions[i].hasOwnProperty("assignedUser")&&vm.subscriptions[i].assignedUser!==vm.account){for(isMember=!1,j=0,jLength=vm.members.length;j<jLength;j+=1)if(vm.members[j].user===vm.subscriptions[i].assignedUser){isMember=!0;break}isMember||vm.collaborators.push({user:vm.subscriptions[i].assignedUser})}vm.numSubscriptions=vm.subscriptions.filter(function(sub){return sub.inCurrentAgreement}).length,vm.noLicensesAssigned=vm.numSubscriptions>1&&vm.collaborators.length+vm.members.length===0,vm.notAllLicensesAssigned=!vm.noLicensesAssigned&&vm.numSubscriptions>1&&vm.numSubscriptions-1!==vm.collaborators.length+vm.members.length,vm.allLicenseAssigneesMembers=0===vm.collaborators.length}var promise,vm=this;vm.memberRole="collaborator",vm.collaborators=[],vm.members=[],vm.addDisabled=!1,vm.numSubscriptions=vm.subscriptions.length,vm.toShow=vm.numSubscriptions>1?"1+":vm.numSubscriptions.toString(),console.log(vm.item),promise=UtilsService.doGet(vm.account+"/"+vm.item.project+"/collaborators"),promise.then(function(response){console.log(response),200===response.status&&(vm.members=response.data,angular.isDefined("vm.subscriptions")&&setupTeam())}),$scope.$watch("vm.selectedUser",function(newValue){vm.addDisabled=!(angular.isDefined(newValue)&&null!==newValue)}),vm.goBack=function(){$location.search("project",null),vm.showPage({page:"repos"})},vm.addMember=function(){var i,length,data={role:vm.memberRole,user:vm.selectedUser.user};promise=UtilsService.doPost(data,vm.account+"/"+vm.item.project+"/collaborators"),promise.then(function(response){if(console.log(response),200===response.status){for(vm.members.push(data),i=0,length=vm.collaborators.length;i<length;i+=1)if(vm.collaborators[i].user===vm.selectedUser.user){vm.collaborators.splice(i,1);break}vm.searchText=null,vm.addDisabled=0===vm.collaborators.length,vm.allLicenseAssigneesMembers=0===vm.collaborators.length}})},vm.removeMember=function(index){promise=UtilsService.doDelete(vm.members[index],vm.account+"/"+vm.item.project+"/collaborators"),promise.then(function(response){if(console.log(response),200===response.status){var member=vm.members.splice(index,1);vm.collaborators.push(member[0]),vm.addDisabled=!1,vm.allLicenseAssigneesMembers=!1}})},vm.querySearch=function(query){return query?vm.collaborators.filter(createFilterFor(query)):vm.collaborators},vm.goToPage=function(page){StateManager.setQuery({page:page})},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("accountTeam",accountTeam),AccountTeamCtrl.$inject=["$scope","$location","UtilsService","StateManager"]}(),function(){"use strict";function bid4free(){return{restrict:"E",templateUrl:"bid4free.html",scope:{account:"=",project:"=",branch:"=",revision:"=",state:"="},controller:Bid4FreeCtrl,controllerAs:"vm",bindToController:!0}}function Bid4FreeCtrl($scope,$element,$timeout,BidService,ProjectService){function prettyDate(date){return date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear()}function getStatusIcon(status){var icon="";return"won"===status?icon="fa fa-check md-accent":"lost"===status?icon="fa fa-remove md-warn":"accepted"===status?icon="fa fa-check":"declined"===status?icon="fa fa-remove":"invited"===status&&(icon="fa fa-circle-thin"),icon}function setupFileUploader(){var fileUploader=$element[0].querySelector("#fileUploader");null!==fileUploader&&fileUploader.addEventListener("change",function(){var files=this.files;promise=BidService.saveFiles(vm.packages[0].name,files),promise.then(function(response){console.log(response),vm.showFileUploadedInfo=!0,vm.uploadedFilename=response.data[0].filename})},!1)}var promise,projectUserRolesPromise,projectSummaryPromise,currentSelectedPackageIndex,vm=this;vm.invitedSubContractors=[],vm.addSubContractorDisabled=!0,vm.responded=!1,vm.packageSelected=!1,vm.statusInfo="No package currently selected",vm.saveProjectSummaryDisabled=!0,vm.savePackageDisabled=!0,vm.showProjectSummaryInput=!0,BidService.setAccountAndProject(vm.account,vm.project),vm.subContractors=[{user:"Pinakin"},{user:"Carmen"},{user:"Henry"},{user:"B4F_su8C0n_01"},{user:"B4F_su8C0n_02"},{user:"B4F_su8C0n_03"},{user:"B4F_su8C0n_04"},{user:"B4F_su8C0n_05"},{user:"B4F_su8C0n_06"},{user:"B4F_su8C0n_07"},{user:"B4F_su8C0n_08"},{user:"B4F_su8C0n_09"},{user:"B4F_su8C0n_10"},{user:"B4F_su8C0n_11"},{user:"B4F_su8C0n_12"},{user:"B4F_su8C0n_13"},{user:"B4F_su8C0n_14"},{user:"B4F_su8C0n_15"}],vm.notInvitedSubContractors=JSON.parse(JSON.stringify(vm.subContractors)),vm.projectSummary={site:{label:"Site",type:"input",inputType:"text",value:void 0},code:{label:"Code",type:"input",inputType:"text",value:void 0},client:{label:"Client",type:"input",inputType:"text",value:void 0},budget:{label:"Budget",type:"input",inputType:"number",value:void 0},contact:{label:"Contact",type:"input",inputType:"text",value:void 0},completedBy:{label:"Completed by",type:"date",value:void 0}},vm.packageSummary={name:{label:"Name",type:"input",inputType:"text",value:void 0},site:{label:"Site",type:"input",inputType:"text",value:void 0},code:{label:"Code",type:"input",inputType:"text",value:void 0},budget:{label:"Budget",type:"input",inputType:"number",value:void 0},area:{label:"Area",type:"input",inputType:"text",value:void 0},contact:{label:"Contact",type:"input",inputType:"text",value:void 0},completedBy:{label:"Completed by",type:"date",value:void 0}},projectSummaryPromise=ProjectService.getProjectSummary(),projectSummaryPromise.then(function(response){console.log(response),response.hasOwnProperty("data")&&null!==response.data&&""!==response.data&&(vm.showProjectSummaryInput=!1,vm.projectSummary.name={value:response.data.name},vm.projectSummary.site.value=response.data.site,vm.projectSummary.code.value=response.data.code,vm.projectSummary.client.value=response.data.client,vm.projectSummary.budget.value=response.data.budget,vm.projectSummary.completedByPretty=prettyDate(new Date(response.data.completedBy)))}),projectUserRolesPromise=ProjectService.getUserRolesForProject(),projectUserRolesPromise.then(function(data){var i,length;for(vm.userIsASubContractor=!1,i=0,length=data.length;i<length;i+=1)if("SubContractor"===data[i]){vm.userIsASubContractor=!0;break}vm.userIsAMainContractor=!vm.userIsASubContractor,vm.userIsAMainContractor&&(vm.listTitle="Packages",promise=BidService.getPackage(),promise.then(function(response){console.log(response);var i,length;if(vm.packages=response.data,0===vm.packages.length)vm.summaryInfo="There are no packages for this project",vm.statusInfo="There are no packages for this project";else{for(vm.summaryInfo="No packages currently selected",vm.statusInfo="No packages currently selected",i=0,length=vm.packages.length;i<length;i+=1)vm.packages[i].completedByPretty=prettyDate(new Date(vm.packages[i].completedBy)),vm.packages[i].selected=!1;vm.fileUploadAction="/api/"+vm.account+"/"+vm.project+"/packages/"+vm.packages[0].name+"/attachments"}}))}),$scope.$watch("vm.subContractorUser",function(newValue){vm.addSubContractorDisabled=!angular.isDefined(newValue)}),$scope.$watch("vm.projectSummary",function(newValue,oldValue){var input;if(angular.isDefined(newValue)&&JSON.stringify(newValue)!==JSON.stringify(oldValue)){vm.saveProjectSummaryDisabled=!1;for(input in vm.projectSummary)if(vm.projectSummary.hasOwnProperty(input)&&angular.isUndefined(vm.projectSummary[input].value)){vm.saveProjectSummaryDisabled=!0;break}}},!0),$scope.$watch("vm.packageSummary",function(newValue,oldValue){var input;if(angular.isDefined(newValue)&&JSON.stringify(newValue)!==JSON.stringify(oldValue)){vm.savePackageDisabled=!1;for(input in vm.packageSummary)if(vm.packageSummary.hasOwnProperty(input)&&angular.isUndefined(vm.packageSummary[input].value)){vm.savePackageDisabled=!0;break}vm.showInfo=!1}},!0),vm.saveProjectSummary=function(){var input,data={};for(input in vm.projectSummary)vm.projectSummary.hasOwnProperty(input)&&(data[input]=vm.projectSummary[input].value);vm.saveProjectSummaryDisabled=!0,vm.showProjectSummaryInput=!1,promise=ProjectService.createProjectSummary(data),promise.then(function(response){console.log(response),vm.projectSummary.name={value:response.data.name},vm.projectSummary.completedByPretty=prettyDate(new Date(response.data.completedBy))})},vm.savePackage=function(){var input,data={};for(input in vm.packageSummary)vm.packageSummary.hasOwnProperty(input)&&(data[input]=vm.packageSummary[input].value);promise=BidService.addPackage(data),promise.then(function(response){vm.showInfo=!0,vm.savePackageDisabled="OK"===response.statusText,vm.savePackageDisabled?(data.completedByPretty=prettyDate(new Date(data.completedBy)),vm.packages.push(data),vm.info="Package "+vm.packageSummary.name.value+" saved"):vm.info="Error saving package "+vm.name})},vm.inviteSubContractor=function(){var i,length,index;for(i=0,length=vm.notInvitedSubContractors.length;i<length;i+=1)if(vm.subContractorUser===vm.notInvitedSubContractors[i].user){index=i;break}var data={user:vm.notInvitedSubContractors[index].user};promise=BidService.inviteSubContractor(vm.selectedPackage.name,data),promise.then(function(response){"OK"===response.statusText&&(vm.subContractorsInvited=!0,vm.invitedSubContractors.push(vm.notInvitedSubContractors[index]),vm.invitedSubContractors[vm.invitedSubContractors.length-1].invitedIcon="fa fa-circle-thin",vm.notInvitedSubContractors.splice(index,1),vm.subContractor=void 0)})},vm.awardToSubContractor=function(index){var i,length;promise=BidService.awardBid(vm.selectedPackage.name,vm.invitedSubContractors[index]._id),promise.then(function(response){if("OK"===response.statusText)for(vm.awarded=!0,vm.inviteTitle="Status",vm.invitedSubContractors[index].accepted=!0,i=0,length=vm.invitedSubContractors.length;i<length;i+=1)vm.invitedSubContractors[i].accepted&&(vm.invitedSubContractors[i].invitedIcon=getStatusIcon(i===index?"won":"lost"))})},vm.showPackage=function(index){var i,j,lengthI,lengthJ;vm.showInput=!1,vm.showSummary=!0,vm.showFileUploadedInfo=!1,vm.packageNotAwarded=!0,vm.subContractorUser=void 0,vm.showInfo=!1,vm.selectedPackage=vm.packages[index],console.log(vm.selectedPackage),$timeout(function(){setupFileUploader()},500),promise=BidService.getBids(vm.selectedPackage.name),promise.then(function(response){if("OK"===response.statusText)for(vm.packageSelected=!0,angular.isDefined(currentSelectedPackageIndex)&&(vm.packages[currentSelectedPackageIndex].selected=!1),vm.packages[index].selected=!0,currentSelectedPackageIndex=index,vm.awarded=!1,vm.inviteTitle="Invite",vm.notInvitedSubContractors=JSON.parse(JSON.stringify(vm.subContractors)),vm.invitedSubContractors=response.data,console.log(vm.invitedSubContractors),vm.subContractorsInvited=vm.invitedSubContractors.length>0,i=0,lengthI=vm.invitedSubContractors.length;i<lengthI;i+=1)for(null===vm.invitedSubContractors[i].accepted?vm.invitedSubContractors[i].invitedIcon=getStatusIcon("invited"):null===vm.invitedSubContractors[i].awarded?vm.invitedSubContractors[i].invitedIcon=getStatusIcon("accepted"):vm.invitedSubContractors[i].awarded?(vm.awarded=!0,vm.inviteTitle="Status",vm.packageNotAwarded=!1,vm.invitedSubContractors[i].invitedIcon=getStatusIcon("won")):vm.invitedSubContractors[i].invitedIcon=getStatusIcon("lost"),j=0,lengthJ=vm.notInvitedSubContractors.length;j<lengthJ;j+=1)if(vm.notInvitedSubContractors[j].user===vm.invitedSubContractors[i].user){vm.notInvitedSubContractors.splice(j,1);break}})},vm.setupAddPackage=function(){vm.packageSelected=!0,vm.showInput=!0,vm.showSummary=!1},vm.selectPackage=function(packageName){vm.selectedPackageName=packageName},vm.inviteAccepted=function(){vm.packageInviteAccepted=!0}}angular.module("3drepo").directive("bid4free",bid4free),Bid4FreeCtrl.$inject=["$scope","$element","$timeout","BidService","ProjectService"]}(),function(){"use strict";function bidDocs(){return{restrict:"E",templateUrl:"bidDocs.html",scope:{packageName:"=",inviteAccepted:"="},controller:BidDocsCtrl,controllerAs:"vm",bindToController:!0}}function BidDocsCtrl($scope,$mdDialog,$sce,BidService){function showDocs(){var i,j,length,jLength,exists;if(vm.docs=[],BidService.currentPackage.hasOwnProperty("attachments"))for(i=0,length=BidService.currentPackage.attachments.length;i<length;i+=1){for(exists=!1,j=0,jLength=vm.docs.length;j<jLength;j+=1)if(vm.docs[j].id===BidService.currentPackage.attachments[i]){exists=!0;break}exists||vm.docs.push({title:"Drawing "+BidService.currentPackage.attachments[i],id:BidService.currentPackage.attachments[i]})}}function showDialog(event){$mdDialog.show({controller:bidDocsDialogController,templateUrl:"bidDocsDialog.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0,scope:$scope,preserveScope:!0,onRemoving:removeDialog})}function removeDialog(){vm.closeDialog()}function bidDocsDialogController($scope){}var promise,vm=this;vm.predefinedDocs=[{title:"Bill of Quantities",id:""},{title:"Scope of Works",id:""}],vm.boq=[{type:"Single-Flush: 800 x 2100",code:3,quantity:7},{type:"Pocket_Slider_Door_5851: 2.027 x 0.945",code:51,quantity:3},{type:"Entrance door: Entrance door",code:60,quantity:2},{type:"M_Double-Flush: 1730 x 2134mm",code:65,quantity:1},{type:"Curtain Wall Dbl Glass: Curtain Wall Dbl Glass",code:68,quantity:3}],$scope.$watch("vm.packageName",function(newValue){angular.isDefined(newValue)&&(promise=BidService.getUserBid(newValue),promise.then(function(response){"OK"===response.statusText&&(vm.bidInviteAccepted=response.data.accepted),vm.bidInviteAccepted&&showDocs()}))}),$scope.$watch("vm.inviteAccepted",function(newValue){angular.isDefined(newValue)&&(vm.bidInviteAccepted=!0,showDocs())}),vm.sow="<p><span class='bidDocsUnderline'>Scope of the Sub‐Contract Works</span></p><p>The following defines the ‘Fixed Price Lump Sum’ Scope of the Sub‐Contract Works for the completion of the Partitions,  Ceilings  and  Passive  Fire  Protection  Works  and  is  further  defined  in  the  Documents,  Drawings, Specifications, Protocols and Policies incorporated or referred to within this Tender Enquiry.</p><p>The Health and Safety of all Visitors, Staff, Site Personnel and the General Public is paramount at all times and compliance  with  the  Balfour  Beatty  Construction  Health,  Safety,  Quality  and  Environmental  Conditions  is mandatory. A copy of this document is contained in Numbered Document 7.</p><p>The Sub‐Contractor <span class='bidDocsBold'>shall not</span> sub‐let any part of the sub‐contract works without the prior knowledge and writtenacceptance of BB.</p><p>The Sub‐Contractor shall manufacture, supply, deliver, install, execute, test and commission and complete the Partitions, Ceilings and Passive Fire Protection Works including all necessary labour, plant,  tools, equipment, materials, supervision, off‐loading, distribution around site, removal of waste and protection of the works at the project  known  as  the  Baltic Triangle,  Liverpool,  all    as  described  herein  within  this  Scope  of Works  and  the Documents,  Drawings,  Specifications,  Protocols  and  Polices  incorporated  or  referred  to  within  this  Tender Enquiry.</p><p>The tender Sum is to be fixed until October 2016.</p><p>The Sub‐Contractor has made allowances for all works necessary to carry out and complete the Sub‐Contract Works all as denoted on the Drawings, Specifications and Documents incorporated within this Tender Enquiry. All items which are normally deemed extra over in accordance with the SMM7 or/and NRM2 measurement rules shall also be deemed included within the Sub‐Contract Sum.</p><p>The Sub‐Contractor is deemed to have acquainted themselves with the constraints of the Site and acknowledges and accepts that it is required to co‐ordinate and integrate the Works with the designs, works and programmes of the following associated works: ‐ Precast Concrete Works, Car Park Works, Roofing, Structural Steel, incoming services, M&E installations, Kitchen and Wardrobes installation, and Finishes Generally.</p><p>Notwithstanding  the  need  for  the  Sub‐Contract Works  to  be  properly  co‐ordinated  and  integrated  with  the design, works and programmes of others, the Sub‐Contractor acknowledges and accepts that it will not have exclusive access to and / or possession of the site or any part or parts thereof and that it will be required to work alongside  the  Employer,  Contractor,  the  Competent  Authority  and  other  trades,  Sub‐Contractors  and  /  or suppliers.</p>",vm.sowProcessed=vm.sow.split("</p>"),vm.showPredefinedDocDialog=function(index){vm.docIndex=index,vm.showPredefinedDoc=!0,vm.showDoc=!1,showDialog()},vm.showDocDialog=function(index){vm.docIndex=index,vm.showPredefinedDoc=!1,vm.showDoc=!0,promise=BidService.getFile(BidService.currentPackage.name,vm.docs[index].id),promise.then(function(response){var blob=new Blob([response.data],{type:"application/pdf"});vm.pdfUrl=URL.createObjectURL(blob),showDialog();
})},vm.trustSrc=function(src){return $sce.trustAsResourceUrl(src)},vm.closeDialog=function(){if($mdDialog.cancel(),vm.showDoc){new Worker(vm.pdfUrl);URL.revokeObjectURL(vm.pdfUrl)}}}angular.module("3drepo").directive("bidDocs",bidDocs),BidDocsCtrl.$inject=["$scope","$mdDialog","$sce","BidService"]}(),function(){"use strict";function bidImage(){return{restrict:"E",templateUrl:"bidImage.html",scope:{account:"=",project:"="},controller:BidImageCtrl,controllerAs:"vm",bindToController:!0}}function BidImageCtrl($window){var vm=this;vm.thumbnailPath="/public/images/bid4free_bid_thumbnail.png",vm.showViewer=function(){$window.open(vm.account+"/"+vm.project,"_blank")}}angular.module("3drepo").directive("bidImage",bidImage),BidImageCtrl.$inject=["$window"]}(),function(){"use strict";function bidList(){return{restrict:"E",templateUrl:"bidList.html",scope:{},controller:BidListCtrl,controllerAs:"vm",bindToController:!0}}function BidListCtrl(){}angular.module("3drepo").directive("bidList",bidList),BidListCtrl.$inject=[]}(),function(){"use strict";function bidProjectSummary(){return{restrict:"E",templateUrl:"bidProjectSummary.html",scope:{},controller:BidProjectSummaryCtrl,controllerAs:"vm",bindToController:!0}}function BidProjectSummaryCtrl($location,Auth,ProjectService,BidService){var promise,vm=this;vm.Auth=Auth,promise=ProjectService.getProjectSummary(),promise.then(function(data){vm.projectSummary=data.data,vm.projectSummary.completedByPretty=BidService.prettyDate(new Date(vm.projectSummary.completedBy))}),vm.home=function(){$location.path("/"+Auth.username,"_self").search({})}}angular.module("3drepo").directive("bidProjectSummary",bidProjectSummary),BidProjectSummaryCtrl.$inject=["$location","Auth","ProjectService","BidService"]}(),function(){"use strict";function BidService($http,$q,StateManager,serverConfig){function doPost(data,urlEnd,headers){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.project+"/"+urlEnd),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doGet(urlEnd,param){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,self.account+"/"+self.project+"/"+urlEnd),params={};return angular.isDefined(param)&&(params.responseType="arraybuffer"),$http.get(url,params).then(function(response){deferred.resolve(response)},function(response){deferred.resolve(response)}),deferred.promise}function doPut(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.project+"/"+urlEnd),config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}var currentPackage,boq,boqTotal,obj={},state=StateManager.state,self=this;return obj.setAccountAndProject=function(account,project){self.account=account,self.project=project},obj.addPackage=function(data){return doPost(data,"packages.json")},obj.inviteSubContractor=function(packageName,data){return doPost(data,"packages/"+packageName+"/bids.json")},obj.acceptInvite=function(packageName,accept){return doPost({accept:accept},"packages/"+packageName+"/bids/mine/invitation")},obj.awardBid=function(packageName,bidId){return doPost({},"packages/"+packageName+"/bids/"+bidId+"/award")},obj.getPackage=function(name){var part=angular.isDefined(name)?"/"+name:"";return doGet("packages"+part+".json")},obj.getProjectPackage=function(account,project,name){state.account=account,state.project=project;var part=angular.isDefined(name)?"/"+name:"";return doGet("packages"+part+".json")},obj.getBids=function(packageName){return doGet("packages/"+packageName+"/bids.json")},obj.getUserBid=function(packageName){return doGet("packages/"+packageName+"/bids/mine.json")},obj.getProjectUserBids=function(account,project,packageName){return state.account=account,state.project=project,doGet("packages/"+packageName+"/bids/mine.json")},obj.getTermsAndConditions=function(packageName){return doGet("packages/"+packageName+"/bids/mine/termsAndConds.json")},obj.updateTermsAndConditions=function(packageName,data){return doPut(data,"packages/"+packageName+"/bids/mine/termsAndConds.json")},obj.saveFiles=function(packageName,files){var i,length,data=new FormData;for(i=0,length=files.length;i<length;i+=1)data.append("attachment",files[i]);return doPost(data,"/packages/"+packageName+"/attachments",{"Content-Type":void 0})},obj.getFile=function(packageName,fileId){return doGet("/packages/"+packageName+"/attachments/"+fileId,{})},obj.prettyDate=function(date){return date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear()},Object.defineProperty(obj,"currentPackage",{get:function(){return currentPackage},set:function(aPackage){currentPackage=aPackage}}),Object.defineProperty(obj,"boq",{get:function(){return boq},set:function(data){boq=data}}),Object.defineProperty(obj,"boqTotal",{get:function(){return boqTotal},set:function(total){boqTotal=total}}),obj}angular.module("3drepo").factory("BidService",BidService),BidService.$inject=["$http","$q","StateManager","serverConfig"]}(),function(){"use strict";function bidStatus(){return{restrict:"E",templateUrl:"bidStatus.html",scope:{packageName:"=",onInviteAccepted:"&"},controller:BidStatusCtrl,controllerAs:"vm",bindToController:!0}}function BidStatusCtrl($scope,$timeout,BidService){var promise,vm=this;$scope.$watch("vm.packageName",function(newValue){angular.isDefined(newValue)&&(promise=BidService.getUserBid(newValue),promise.then(function(response){"OK"===response.statusText&&(null===response.data.accepted?vm.invited=!0:response.data.accepted?(vm.accepted=!0,angular.isDefined(BidService.boqTotal)&&(vm.boqTotal=BidService.boqTotal)):vm.declined=!0)}))}),vm.accept=function(accept){promise=BidService.acceptInvite(vm.packageName,accept),promise.then(function(response){"OK"===response.statusText&&(vm.invited=!1,accept?(vm.onInviteAccepted(),vm.accepted=!0):vm.declined=!0)})},vm.submit=function(){$timeout(function(){vm.showSubmitResult=!0},1e3)}}angular.module("3drepo").directive("bidStatus",bidStatus),BidStatusCtrl.$inject=["$scope","$timeout","BidService"]}(),function(){"use strict";function bidSummary(){return{restrict:"E",templateUrl:"bidSummary.html",scope:{onSelectPackage:"&"},controller:BidSummaryCtrl,controllerAs:"vm",bindToController:!0}}function BidSummaryCtrl($scope,BidService){function prettyDate(date){return date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear()}var promise,vm=this;vm.showSelectedPackage=!1,promise=BidService.getPackage(),promise.then(function(response){var i,length;if(vm.packages=[],"OK"===response.statusText&&response.data.length>0&&(vm.packages=response.data,vm.packages[0].completedByPretty=prettyDate(new Date(vm.packages[0].completedBy)),angular.isDefined(BidService.currentPackage)))for(i=0,length=vm.packages.length;i<length;i+=1)if(vm.packages[i].name===BidService.currentPackage.name){vm.selectedPackageIndex=i;break}}),$scope.$watch("vm.selectedPackageIndex",function(newValue){angular.isDefined(newValue)&&(vm.showSelectedPackage=!0,BidService.currentPackage=vm.packages[newValue],vm.packageSorted=[{label:"Name",value:vm.packages[newValue].name},{label:"Site",value:vm.packages[newValue].site},{label:"Budget",value:vm.packages[newValue].budget},{label:"Code",value:vm.packages[newValue].code},{label:"Area",value:vm.packages[newValue].area},{label:"Contact",value:vm.packages[newValue].contact},{label:"Completed by",value:BidService.prettyDate(new Date(vm.packages[newValue].completedBy))}],vm.onSelectPackage({packageName:vm.packages[newValue].name}))})}angular.module("3drepo").directive("bidSummary",bidSummary),BidSummaryCtrl.$inject=["$scope","BidService"]}(),function(){"use strict";function bidWorkspace(){return{restrict:"E",templateUrl:"bidWorkspace.html",scope:{packageName:"=",inviteAccepted:"=",account:"=",project:"="},controller:BidWorkspaceCtrl,controllerAs:"vm",bindToController:!0}}function BidWorkspaceCtrl($scope,$location,BidService){var promise,vm=this;vm.items=["Terms and Conditions","Bill of Quantities","Scope of Works","Other"],$scope.$watch("vm.inviteAccepted",function(newValue){angular.isDefined(newValue)&&(vm.showItems=!0)}),$scope.$watch("vm.packageName",function(newValue){angular.isDefined(newValue)&&(promise=BidService.getUserBid(newValue),promise.then(function(response){"OK"===response.statusText&&(vm.showItems=response.data.accepted)}))}),vm.showInput=function(index){$location.path(vm.account+"/"+vm.project+"/bid4free/bid4freeWorkspace","_self").search({package:BidService.currentPackage.name,tab:index})}}angular.module("3drepo").directive("bidWorkspace",bidWorkspace),BidWorkspaceCtrl.$inject=["$scope","$location","BidService"]}(),function(){"use strict";function bid4freeWorkspace(){return{restrict:"E",templateUrl:"bid4freeWorkspace.html",scope:{packageName:"=",account:"=",project:"=",branch:"=",revision:"="},controller:Bid4freeWorkspaceCtrl,controllerAs:"vm",bindToController:!0}}function Bid4freeWorkspaceCtrl($scope,$location,BidService,EventService){function setBoqTotal(){var i,length,total=0;for(i=0,length=vm.boq.length;i<length;i+=1)angular.isDefined(vm.boq[i].price)&&(total+=parseFloat(vm.boq[i].price));vm.boqTotal=total.toFixed(2),BidService.boqTotal=vm.boqTotal}var promise,tcPromise,vm=this;$location.search();vm.sections=[],vm.sectionType="keyvalue",vm.showSaveConfirmation=!1,angular.isDefined(BidService.boq)?(vm.boq=BidService.boq,setBoqTotal()):(vm.boq=[{type:"Single-Flush: 800 x 2100",code:3,quantity:7},{type:"Pocket_Slider_Door_5851: 2.027 x 0.945",code:51,quantity:3},{type:"Entrance door: Entrance door",code:60,quantity:2},{type:"M_Double-Flush: 1730 x 2134mm",code:65,quantity:1},{type:"Curtain Wall Dbl Glass: Curtain Wall Dbl Glass",code:68,quantity:3}],BidService.boq=vm.boq),EventService.send(EventService.EVENT.CREATE_VIEWER,{name:"default",account:vm.account,project:vm.project,branch:vm.branch,revision:vm.revision}),promise=BidService.getUserBid(vm.packageName),promise.then(function(response){vm.title=vm.project+" / "+response.data.packageName}),tcPromise=BidService.getTermsAndConditions(vm.packageName),tcPromise.then(function(response){var i,length;for(vm.sections=response.data,i=0,length=vm.sections.length;i<length;i+=1)vm.sections[i].showInput=!1,vm.sections[i].items.length>0?vm.sections[i].type=vm.sections[i].items[0].type:vm.sections[i].type="keyvalue"}),vm.selectedTab=$location.search().tab,$scope.$watch("vm.selectedTab",function(newValue){}),$scope.$watch("vm.sectionType",function(newValue){vm.showTableTitlesInput="table"===newValue.toString()}),vm.addSection=function(){var section={block:vm.sectionTitle,items:[],type:vm.sectionType};"table"===vm.sectionType&&(section.items=[{type:"table",keys:[{name:vm.tableColumn1Title,datatype:"string",control:"text"},{name:vm.tableColumn2Title,datatype:"string",control:"text"},{name:vm.tableColumn3Title,datatype:"string",control:"text"}],values:[]}]),vm.sections.push(section),vm.showSaveConfirmation=!1,vm.sectionTitle=void 0,vm.tableColumn1Title=void 0,vm.tableColumn2Title=void 0,vm.tableColumn3Title=void 0},vm.toggleItemInput=function(index){vm.sections[index].showInput=!vm.sections[index].showInput,vm.sections[index].showInput||(vm.sections[index].newItemName=void 0,vm.sections[index].newItemDescription=void 0),vm.showSaveConfirmation=!1},vm.addItem=function(sectionIndex){"keyvalue"===vm.sections[sectionIndex].type?angular.isDefined(vm.sections[sectionIndex].newItemName)&&(vm.sections[sectionIndex].items.push({type:"keyvalue",keys:[{name:vm.sections[sectionIndex].newItemName,datatype:"string",control:"text"}],values:[]}),vm.sections[sectionIndex].newItemName=void 0):angular.isDefined(vm.sections[sectionIndex].column1)&&angular.isDefined(vm.sections[sectionIndex].column2)&&angular.isDefined(vm.sections[sectionIndex].column3)&&(vm.sections[sectionIndex].items[0].values.push([vm.sections[sectionIndex].column1,vm.sections[sectionIndex].column2,vm.sections[sectionIndex].column3]),vm.sections[sectionIndex].column1=void 0,vm.sections[sectionIndex].column2=void 0,vm.sections[sectionIndex].column3=void 0),console.log(vm.sections),vm.sections[sectionIndex].showInput=!1},vm.save=function(){promise=BidService.updateTermsAndConditions(vm.packageName,vm.sections),promise.then(function(response){console.log(response),vm.showSaveConfirmation=!0})},vm.boqRateChange=function(index){vm.boq[index].price=parseFloat(parseFloat(vm.boq[index].quantity)*parseFloat(vm.boq[index].rate)).toFixed(2),setBoqTotal()},vm.goToMainPage=function(){$location.path(vm.account+"/"+vm.project+"/bid4free","_self").search({package:vm.packageName})},vm.init=function(){vm.data=[{block:"Instruction to SC",items:[{type:"keyvalue",keys:[{name:"Test",datatype:"string",control:"text"}],values:["Test description"]}]}],promise=BidService.updateTermsAndConditions(vm.packageName,vm.data),promise.then(function(response){console.log(response)})}}angular.module("3drepo").directive("bid4freeWorkspace",bid4freeWorkspace),Bid4freeWorkspaceCtrl.$inject=["$scope","$location","BidService","EventService"]}(),function(){"use strict";function billing(){return{restrict:"E",scope:{query:"="},templateUrl:"billing.html",controller:BillingCtrl,controllerAs:"vm",bindToController:!0}}function BillingCtrl(EventService,UtilsService,serverConfig){var billingsPromise,i,length,vm=this,euCountryCodes=["BE","BG","CZ","DK","DE","EE","IE","EL","ES","FR","HR","IT","CY","LV","LT","LU","HU","MT","NL","AT","PL","PT","RO","SI","SK","FI","SE"];vm.showBilling=!1,vm.B2B_EU=!1,vm.query.hasOwnProperty("user")&&vm.query.hasOwnProperty("item")&&(billingsPromise=UtilsService.doGet(vm.query.user+"/billings"),billingsPromise.then(function(response){if(console.log("**billings**",response),response.data.length>0&&parseInt(vm.query.item)>=0&&parseInt(vm.query.item)<response.data.length&&(vm.showBilling=!0,vm.billing=response.data[parseInt(vm.query.item)],vm.billing.netAmount=parseFloat(vm.billing.amount-vm.billing.taxAmount).toFixed(2),vm.billing.taxPercentage=Math.round(vm.billing.taxAmount/vm.billing.netAmount*100),vm.B2B_EU=euCountryCodes.indexOf(vm.billing.info.countryCode)!==-1&&vm.billing.info.hasOwnProperty("vat"),vm.type=vm.billing.pending?"Order confirmation":"Invoice",serverConfig.hasOwnProperty("countries")))for(i=0,length=serverConfig.countries.length;i<length;i+=1)if(serverConfig.countries[i].code===vm.billing.info.countryCode){vm.billing.info.country=serverConfig.countries[i].name;break}})),vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)},vm.print=function(){window.print()}}angular.module("3drepo").directive("billing",billing),BillingCtrl.$inject=["EventService","UtilsService","serverConfig"]}(),function(){"use strict";function bottomButtons(){return{restrict:"E",templateUrl:"bottomButtons.html",scope:{},controller:BottomButtonsCtrl,controllerAs:"vm",bindToController:!0}}function BottomButtonsCtrl(EventService){var vm=this;vm.showButtons=!0,vm.fullScreen=!1,vm.showViewingOptionButtons=!1,vm.toggleElements=function(){EventService.send(EventService.EVENT.TOGGLE_ELEMENTS),vm.showButtons=!vm.showButtons};var setViewingOption=function(index){angular.isDefined(index)?(EventService.send(EventService.EVENT.VIEWER.SET_NAV_MODE,{mode:vm.viewingOptions[index].mode}),vm.selectedViewingOptionIndex=index,vm.rightButtons[0]=vm.viewingOptions[index],vm.showViewingOptionButtons=!1):vm.showViewingOptionButtons=!vm.showViewingOptionButtons},home=function(){EventService.send(EventService.EVENT.VIEWER.GO_HOME)},exitFullScreen=function(){document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen||!vm.fullScreen||(vm.fullScreen=!1)};document.addEventListener("webkitfullscreenchange",exitFullScreen,!1),document.addEventListener("mozfullscreenchange",exitFullScreen,!1),document.addEventListener("fullscreenchange",exitFullScreen,!1),document.addEventListener("MSFullscreenChange",exitFullScreen,!1);vm.viewingOptions=[{mode:VIEWER_NAV_MODES.WALK,label:"Walk",icon:"fa fa-child",click:setViewingOption,iconClass:"bottomButtonIconWalk"},{mode:VIEWER_NAV_MODES.HELICOPTER,label:"Helicopter",icon:"icon icon_helicopter",click:setViewingOption,iconClass:"bottomButtonIconHelicopter"},{mode:VIEWER_NAV_MODES.TURNTABLE,label:"Turntable",icon:"icon icon_turntable",click:setViewingOption}],vm.selectedViewingOptionIndex=2,vm.leftButtons=[],vm.leftButtons.push({label:"Home",icon:"fa fa-home",click:home}),vm.rightButtons=[],vm.rightButtons.push(vm.viewingOptions[vm.selectedViewingOptionIndex])}angular.module("3drepo").directive("bottomButtons",bottomButtons),BottomButtonsCtrl.$inject=["EventService"]}(),function(){"use strict";function compassMove(event){event.orientation[1]=-event.orientation[1],viewer.transformEvent(event,event.target,!1),document.getElementById("AxesTrans").setAttribute("rotation",event.orientation.toString())}function compass(){return{restrict:"E",templateUrl:"compass.html",scope:{},controller:CompassCtrl,controllerAs:"cc",bindToController:!0}}function CompassCtrl(EventService){EventService.send(EventService.EVENT.VIEWER.REGISTER_VIEWPOINT_CALLBACK,{callback:compassMove})}angular.module("3drepo").directive("compass",compass),CompassCtrl.$inject=["EventService"]}(),function(){"use strict";function building(){return{restrict:"EA",templateUrl:"building.html",scope:{show:"=",visible:"=",onContentHeightRequest:"&"},controller:BuildingCtrl,controllerAs:"vm",bindToController:!0}}function BuildingCtrl($scope,$timeout,EventService,$http){var vm=this;vm.meta={},$scope.$watch("vm.show",function(newValue){}),$scope.$watch("vm.visible",function(newValue){}),$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.VIEWER.OS_BUILDING_CLICK){vm.testdata=event.value.id;var url="/api/os/building-meta/"+event.value.id;$http.get(url).then(function(data){vm.meta=data.data},function(err){console.trace(err)})}})}angular.module("3drepo").directive("building",building),BuildingCtrl.$inject=["$scope","$timeout","EventService","$http"]}(),function(){"use strict";function clip(){return{restrict:"EA",templateUrl:"clip.html",scope:{show:"=",visible:"=",onContentHeightRequest:"&"},controller:ClipCtrl,controllerAs:"vm",bindToController:!0}}function ClipCtrl($scope,$timeout,EventService){function initClippingPlane(){$timeout(function(){var initPosition=(vm.sliderMax-vm.sliderPosition)/vm.sliderMax;EventService.send(EventService.EVENT.VIEWER.CLEAR_CLIPPING_PLANES),EventService.send(EventService.EVENT.VIEWER.ADD_CLIPPING_PLANE,{axis:translateAxis(vm.selectedAxis),percentage:initPosition})})}function moveClippingPlane(sliderPosition){EventService.send(EventService.EVENT.VIEWER.MOVE_CLIPPING_PLANE,{percentage:(vm.sliderMax-sliderPosition)/vm.sliderMax})}function translateAxis(axis){return"Y"===axis?"Z":"Z"===axis?"Y":"X"}var vm=this;vm.sliderMin=0,vm.sliderMax=100,vm.sliderStep=.1,vm.sliderPosition=vm.sliderMin,vm.axes=["X","Y","Z"],vm.selectedAxis=vm.axes[0],vm.visible=!1,vm.onContentHeightRequest({height:130}),$scope.$watch("vm.show",function(newValue){angular.isDefined(newValue)&&(vm.visible=newValue)}),$scope.$watch("vm.visible",function(newValue){angular.isDefined(newValue)&&(vm.visible=newValue,newValue?initClippingPlane():EventService.send(EventService.EVENT.VIEWER.CLEAR_CLIPPING_PLANES))}),$scope.$watch("vm.selectedAxis",function(newValue){angular.isDefined(newValue)&&vm.show&&(initClippingPlane(),vm.sliderPosition=vm.sliderMin)}),$scope.$watch("vm.sliderPosition",function(newValue){angular.isDefined(newValue)&&vm.show&&moveClippingPlane(newValue)}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.SET_CLIPPING_PLANES&&(event.value.hasOwnProperty("clippingPlanes")&&event.value.clippingPlanes.length?(vm.selectedAxis=translateAxis(event.value.clippingPlanes[0].axis),vm.sliderPosition=100*(1-event.value.clippingPlanes[0].percentage),initClippingPlane(),vm.visible=!0):(vm.visible=!1,vm.sliderPosition=0))})}angular.module("3drepo").directive("clip",clip),ClipCtrl.$inject=["$scope","$timeout","EventService"]}(),function(){"use strict";function contact(){return{restrict:"E",scope:{},templateUrl:"contact.html",controller:ContactCtrl,controllerAs:"vm",bindToController:!0}}function ContactCtrl($scope,UtilsService){var promise,vm=this;vm.contact={information:"",name:"",email:""},vm.sent=!1,vm.sending=!1,$scope.$watch("vm.contact",function(){vm.sendButtonDisabled=""===vm.contact.information||""===vm.contact.name||""===vm.contact.email||angular.isUndefined(vm.contact.email)},!0),vm.send=function(){vm.sending=!0,promise=UtilsService.doPost(vm.contact,"contact"),promise.then(function(response){console.log(response),vm.sending=!1,200===response.status&&(vm.sent=!0)})}}angular.module("3drepo").directive("contact",contact),ContactCtrl.$inject=["$scope","UtilsService"]}(),function(){"use strict";function cookies(){return{restrict:"E",scope:{},templateUrl:"cookies.html",controller:CookiesCtrl,controllerAs:"vm",bindToController:!0}}function CookiesCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("cookies",cookies),CookiesCtrl.$inject=["EventService"]}(),function(){"use strict";function docs(){return{restrict:"EA",templateUrl:"docs.html",scope:{show:"=",onContentHeightRequest:"&"},controller:DocsCtrl,controllerAs:"vm",bindToController:!0}}function DocsCtrl($scope,$mdDialog,$timeout,$filter,EventService,DocsService,UtilsService){function removeDialog(){$scope.closeDialog()}function docsDialogController(){}function setContentHeight(){var itemsHeight,contentHeight=0,metaDataItemHeight=50;angular.forEach(vm.docs,function(value,key){contentHeight+=docTypeHeight,value.show&&("Meta Data"===key&&(itemsHeight=Object.keys(value.data[0].metadata).length*metaDataItemHeight),contentHeight+=itemsHeight)}),vm.onContentHeightRequest({height:contentHeight})}var promise,allDocTypesHeight,autoMetaData,vm=this,docTypeHeight=50;vm.showDocsGetProgress=!1,vm.onContentHeightRequest({height:80}),$scope.$watch(EventService.currentEvent,function(event){var item,i,length;if(autoMetaData&&event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED){var object=event.value;promise=DocsService.getDocs(object.account,object.project,object.id),promise.then(function(data){Object.keys(data).length>0?(vm.show=!0,$timeout(function(){vm.docs=data,allDocTypesHeight=0;for(var docType in vm.docs)if(vm.docs.hasOwnProperty(docType)&&(vm.docs[docType].show=!0,allDocTypesHeight+=docTypeHeight,"Meta Data"===docType))for(i=0,length=vm.docs["Meta Data"].data.length;i<length;i+=1)for(item in vm.docs["Meta Data"].data[i].metadata)vm.docs["Meta Data"].data[i].metadata.hasOwnProperty(item)&&Date.parse(vm.docs["Meta Data"].data[i].metadata[item])&&"string"==typeof vm.docs["Meta Data"].data[i].metadata[item]&&vm.docs["Meta Data"].data[i].metadata[item].indexOf("T")!==-1&&(vm.docs["Meta Data"].data[i].metadata[item]=$filter("prettyDate")(new Date(vm.docs["Meta Data"].data[i].metadata[item]),{showSeconds:!0}));setContentHeight()})):vm.show=!1})}else event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?vm.show=!1:event.type===EventService.EVENT.AUTO_META_DATA&&(autoMetaData=event.value)}),vm.showDoc=function(doc){$scope.pdfUrl=doc.url,vm.progressInfo="Loading document "+doc.name,vm.showDocLoadProgress=!0,$mdDialog.show({controller:docsDialogController,templateUrl:"docsDialog.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0,scope:$scope,preserveScope:!0,onRemoving:removeDialog})},$scope.closeDialog=function(){$mdDialog.cancel()},vm.toggleItem=function(docType){vm.docs[docType].show=!vm.docs[docType].show,setContentHeight()}}angular.module("3drepo").directive("docs",docs),DocsCtrl.$inject=["$scope","$mdDialog","$timeout","$filter","EventService","DocsService","UtilsService"]}(),function(){"use strict";function DocsService($http,$q,serverConfig){var getDocs=function(account,project,objectId){var i,length,data={},deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/meta/"+objectId+".json");return $http.get(url).then(function(json){var dataType;for(i=0,length=json.data.meta.length;i<length;i+=1)dataType=json.data.meta[i].hasOwnProperty("mime")?json.data.meta[i].mime:"Meta Data","application/pdf"===dataType&&(dataType="PDF"),data.hasOwnProperty(dataType)||(data[dataType]={data:[]}),data[dataType].data.push(json.data.meta[i]),json.data.meta[i].url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/"+json.data.meta[i]._id+".pdf");deferred.resolve(data)},function(){deferred.resolve(data)}),deferred.promise};return{getDocs:getDocs}}angular.module("3drepo").factory("DocsService",DocsService),DocsService.$inject=["$http","$q","serverConfig"]}(),function(){"use strict";function groups(){return{restrict:"EA",templateUrl:"groups.html",scope:{account:"=",project:"=",show:"=",showAdd:"=",showEdit:"=",canAdd:"=",onContentHeightRequest:"&",onShowItem:"&",hideItem:"=",selectedMenuOption:"="},controller:GroupsCtrl,controllerAs:"vm",bindToController:!0}}function GroupsCtrl($scope,$timeout,EventService,GroupsService){function setContentHeight(){var contentHeight=0,groupHeaderHeight=56,baseGroupHeight=210,addHeight=250,infoHeight=80,loadingHeight=80;switch(vm.toShow){case"showGroups":angular.forEach(vm.groups,function(){contentHeight+=groupHeaderHeight});break;case"showGroup":contentHeight=baseGroupHeight;break;case"showAdd":contentHeight=addHeight;break;case"showInfo":contentHeight=infoHeight;break;case"showLoading":contentHeight=loadingHeight}vm.onContentHeightRequest({height:contentHeight})}function setupEventWatch(){var index;eventWatch=$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED&&(index=vm.selectedGroup.parents.indexOf(event.value.id),index!==-1?vm.selectedGroup.parents.splice(index,1):vm.selectedGroup.parents.push(event.value.id),promise=GroupsService.updateGroup(vm.selectedGroup),promise.then(function(data){setSelectedGroupHighlightStatus(!0)}))})}function setSelectedGroupHighlightStatus(highlight){var data;null!==vm.selectedGroup&&vm.selectedGroup.parents.length>0&&(data={source:"tree",account:vm.account,project:vm.project},highlight?(data.ids=vm.selectedGroup.parents,data.colour=vm.selectedGroup.color.map(function(item){return item/255}).join(" ")):data.ids=[],EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,data))}function setGroupsVisibleStatus(groups,visible){var i,length,data,ids=[];for(i=0,length=groups.length;i<length;i+=1)groups[i].parents.length>0&&(ids=ids.concat(groups[i].parents));ids.length>0&&(data={source:"tree",account:vm.account,project:vm.project},visible?data.visible_ids=ids:data.invisible_ids=ids,EventService.send(EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY,data))}function doHideAll(hideAllStatus){var i,length,groups=[];if("showGroups"===vm.toShow)setGroupsVisibleStatus(vm.groups,!hideAllStatus);else if("showGroup"===vm.toShow)for(i=0,length=vm.groups.length;i<length;i+=1)vm.groups[i]._id!==vm.selectedGroup._id&&(groups.push(vm.groups[i]),setGroupsVisibleStatus(groups,!hideAll)),setGroupsVisibleStatus([vm.selectedGroup],!0)}var eventWatch,promise,vm=this,colourChangeTimeout=null,hideAll=!1;vm.saveDisabled=!0,vm.canAdd=!0,vm.selectedGroup=null,vm.editingGroup=!1,vm.editingText="Start",vm.colourPickerColour=[255,255,255],vm.toShow="showLoading",vm.loadingInfo="Loading groups",setContentHeight(),GroupsService.init(vm.account,vm.project),promise=GroupsService.getGroups(),promise.then(function(data){vm.groups=data.data,vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",setContentHeight()}),$scope.$watch("vm.showAdd",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.toShow="showAdd",vm.onShowItem(),vm.canAdd=!1,vm.selectedGroup=null,vm.name="",setContentHeight())}),$scope.$watch("vm.hideItem",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",vm.showAdd=!1,vm.canAdd=!0,vm.showEdit=!1,setContentHeight(),setSelectedGroupHighlightStatus(!1),vm.selectedGroup=null,doHideAll(hideAll))}),$scope.$watch("vm.name",function(newValue){angular.isDefined(newValue)&&(vm.saveDisabled=angular.isUndefined(newValue)||""===newValue.toString())}),$scope.$watch("vm.editingGroup",function(newValue){angular.isDefined(newValue)&&(vm.editingText=newValue?"Stop":"Start",newValue?setupEventWatch():angular.isDefined(eventWatch)&&eventWatch())}),$scope.$watch("vm.show",function(newValue){angular.isDefined(newValue)&&(newValue||(vm.editingGroup=!1,hideAll=!1,vm.toShow="showGroups",doHideAll(hideAll)))}),$scope.$watch("vm.showObjects",function(newValue){angular.isDefined(newValue)&&null!==vm.selectedGroup&&setGroupsVisibleStatus([vm.selectedGroup],newValue)}),$scope.$watch("vm.selectedMenuOption",function(newValue){angular.isDefined(newValue)&&"hideAll"===newValue.value&&(hideAll=!hideAll,doHideAll(hideAll))}),vm.showGroup=function(index){vm.selectedGroup=vm.groups[index],vm.toShow="showGroup",vm.onShowItem(),vm.canAdd=!1,vm.editingGroup=!1,vm.showObjects=!0,vm.showEdit=!0,setContentHeight(),doHideAll(hideAll),setSelectedGroupHighlightStatus(!0)},vm.colourPickerChange=function(colour){vm.colourPickerColour=colour,null!==vm.selectedGroup&&(null!==colourChangeTimeout&&$timeout.cancel(colourChangeTimeout),colourChangeTimeout=$timeout(function(){vm.selectedGroup.color=colour,promise=GroupsService.updateGroup(vm.selectedGroup),promise.then(function(data){console.log(data),setSelectedGroupHighlightStatus(!0)})},500))},vm.colourToString=function(colour){return"rgb("+colour.join(",")+")"},vm.deleteGroup=function(){var i,length;for(i=0,length=vm.groups.length;i<length;i+=1)if(vm.groups[i].name===vm.selectedGroup.name){promise=GroupsService.deleteGroup(vm.selectedGroup._id),promise.then(function(data){"OK"===data.statusText&&(vm.groups.splice(i,1),vm.selectedGroup=null,vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",vm.canAdd=!0,setContentHeight())});break}},vm.saveGroup=function(){var i,length,nameExists=!1;for(i=0,length=vm.groups.length;i<length;i+=1)if(vm.groups[i].name===vm.name){nameExists=!0;break}nameExists||(promise=GroupsService.createGroup(vm.name,vm.colourPickerColour),promise.then(function(data){"OK"===data.statusText&&(vm.groups.push(data.data),vm.selectedGroup=null,vm.toShow="showGroups",vm.canAdd=!0,vm.showAdd=!1,setContentHeight())}))}}angular.module("3drepo").directive("groups",groups),GroupsCtrl.$inject=["$scope","$timeout","EventService","GroupsService"]}(),function(){"use strict";function GroupsService($http,$q,serverConfig){function doPost(data,urlEnd,headers){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.project+"/"+urlEnd),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doGet(urlEnd,param){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,self.account+"/"+self.project+"/"+urlEnd),params={};return angular.isDefined(param)&&(params.responseType="arraybuffer"),$http.get(url,params).then(function(response){deferred.resolve(response)},function(response){deferred.resolve(response)}),deferred.promise}function doPut(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.project+"/"+urlEnd),config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doDelete(urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.project+"/"+urlEnd);return $http.delete(url).then(function(response){deferred.resolve(response)}),deferred.promise}var self=this,obj={};return obj.init=function(account,project){self.account=account,
self.project=project},obj.getGroups=function(){return doGet("groups")},obj.createGroup=function(name,color){return doPost({name:name,color:color,parents:[]},"groups")},obj.deleteGroup=function(groupId){return doDelete("groups/"+groupId)},obj.updateGroup=function(group){return doPut(group,"groups/"+group._id)},obj}angular.module("3drepo").factory("GroupsService",GroupsService),GroupsService.$inject=["$http","$q","serverConfig"]}(),function(){"use strict";angular.module("3drepo").service("Auth",["$injector","$q","$http","serverConfig","EventService",function($injector,$q,$http,serverConfig,EventService){var self=this;self.authPromise=$q.defer(),self.loggedIn=null,self.username=null,this.loginSuccess=function(data){self.loggedIn=!0,self.username=data.username,self.userRoles=data.roles,EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:data.username,initialiser:data.initialiser}),self.authPromise.resolve(self.loggedIn)},this.loginFailure=function(reason){self.loggedIn=!1,self.username=null,self.userRoles=null;var initialiser=reason.initialiser;reason.initialiser=void 0,EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:null,initialiser:initialiser,error:reason}),self.authPromise.resolve(self.loggedIn)},this.logoutSuccess=function(){self.loggedIn=!1,self.username=null,self.userRoles=null,EventService.send(EventService.EVENT.USER_LOGGED_OUT),self.authPromise.resolve(self.loggedIn)},this.logoutFailure=function(reason){self.loggedIn=!1,self.username=null,self.userRoles=null,localStorage.setItem("tdrLoggedIn","false"),EventService.send(EventService.EVENT.USER_LOGGED_OUT,{error:reason}),self.authPromise.resolve(self.loggedIn)},this.init=function(){var initPromise=$q.defer();return null===self.loggedIn?($http.get(serverConfig.apiUrl(serverConfig.GET_API,"login")).success(function(data){data.initialiser=!0,self.loginSuccess(data)}).error(function(reason){reason.initialiser=!0,self.loginFailure(reason)}),self.authPromise.promise.then(function(){initPromise.resolve(self.loggedIn)})):(self.loggedIn?EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:self.username}):EventService.send(EventService.EVENT.USER_LOGGED_OUT),initPromise.resolve(self.loggedIn)),initPromise.promise},this.loadProjectRoles=function(account,project){var rolesPromise=$q.defer();return $http.get(serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/roles.json")).success(function(data){self.projectRoles=data,rolesPromise.resolve()}).error(function(){self.projectRoles=null,rolesPromise.resolve()}),rolesPromise.promise},this.getUsername=function(){return this.username},this.login=function(username,password){self.authPromise=$q.defer();var postData={username:username,password:password};return $http.post(serverConfig.apiUrl(serverConfig.POST_API,"login"),postData).success(self.loginSuccess).error(self.loginFailure),self.authPromise.promise},this.logout=function(){return self.authPromise=$q.defer(),$http.post(serverConfig.apiUrl(serverConfig.POST_API,"logout")).success(self.logoutSuccess).error(self.logoutFailure),self.authPromise.promise}}])}(),function(){"use strict";angular.module("3drepo").config(["$stateProvider","$urlRouterProvider","$locationProvider","structure",function($stateProvider,$urlRouterProvider,$locationProvider,structure){$locationProvider.html5Mode(!0),$stateProvider.state("home",{name:"home",url:"/",resolve:{init:function(Auth,StateManager,$q){StateManager.state.authInitialized=!1;var finishedAuth=$q.defer();return StateManager.state.changing=!0,Auth.init().then(function(loggedIn){StateManager.state.authInitialized=!0,StateManager.state.loggedIn=loggedIn,finishedAuth.resolve()}),finishedAuth.promise}}});for(var stateStack=[structure],stateNameStack=["home"];stateStack.length>0;){var parentState=(stateStack.length,stateStack[0]),parentStateName=stateNameStack[0];if(parentState.functions)for(var i=0;i<parentState.functions.length;i++){var childFunction=parentState.functions[i],childFunctionName=parentStateName+"."+childFunction;!function(childFunction){$stateProvider.state(childFunctionName,{name:childFunction,url:childFunction,resolve:{init:function(StateManager,$location,$stateParams){$stateParams[childFunction]=!0,StateManager.setState($stateParams)}}})}(childFunction)}if(parentState.children)for(var i=0;i<parentState.children.length;i++){var childState=parentState.children[i],childStateName=parentStateName+"."+childState.plugin;stateNameStack.push(childStateName),stateStack.push(parentState.children[i]),function(childState){$stateProvider.state(childStateName,{name:parentState.children[i].plugin,url:childState.url||("home"!==parentStateName?"/":"")+":"+childState.plugin,reloadOnSearch:!1,resolve:{init:function(StateManager,$location,$stateParams){StateManager.setState($stateParams)}}})}(childState)}stateStack.splice(0,1),stateNameStack.splice(0,1)}$urlRouterProvider.otherwise("")}]).run(["$location","$rootScope","$state","uiState","StateManager","Auth","$timeout",function($location,$rootScope,$state,uiState,StateManager,Auth,$timeout){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){console.log("stateChangeStart: "+JSON.stringify(fromState)+" --> "+JSON.stringify(toState)),StateManager.state.changing=!0;for(var i=0;i<StateManager.functions.length;i++)StateManager.setStateVar(StateManager.functions[i],!1);StateManager.clearQuery();var stateChangeObject={toState:toState,toParams:toParams,fromState:fromState,fromParams:fromParams};StateManager.startStateChange(stateChangeObject)}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){console.log("stateChangeSuccess: "+JSON.stringify(fromState)+" --> "+JSON.stringify(toState));var stateChangeObject={toState:toState,toParams:toParams,fromState:fromState,fromParams:fromParams};"undefined"!=typeof ga&&null!==ga&&ga("send","pageview",$location.path()),StateManager.handleStateChange(stateChangeObject)}),$rootScope.$on("$locationChangeStart",function(event,next,current){console.log("locationChange")}),$rootScope.$on("$locationChangeSuccess",function(){console.log("locationChangeSucc");var queryParams=$location.search();0===Object.keys(queryParams).length?StateManager.clearQuery():StateManager.setQuery(queryParams)})}]).service("StateManager",["$q","$state","$rootScope","$timeout","structure","EventService","$window","Auth",function($q,$state,$rootScope,$timeout,structure,EventService,$window,Auth){var self=this;$window.StateManager=this,this.state={changing:!0},this.changedState={},this.structure=structure,this.destroy=function(){delete this.state,this.state={},delete this.ui,this.ui={},delete this.Data,this.Data={}},this.changed={},this.state={loggedIn:!1},this.query={},this.functions=[];for(var stateStack=[structure];stateStack.length>0;){var functionName,stackLength=stateStack.length,parentState=stateStack[stackLength-1],i=0;if(parentState.functions)for(i=0;i<parentState.functions.length;i++)functionName=parentState.functions[i],this.functions.indexOf(functionName)>-1?console.error("Duplicate function name when loading in StateManager : "+functionName):this.functions.push(functionName);if(parentState.children)for(var i=0;i<parentState.children.length;i++)stateStack.push(parentState.children[i]);stateStack.splice(0,1)}this.clearChanged=function(){for(var i in self.changed)self.changed.hasOwnProperty(i)&&(self.changed[i]=!1)},self.clearChanged(),this.stateChangeQueue=[];var compareStateChangeObjects=function(stateChangeA,stateChangeB){return stateChangeA.toState===stateChangeB.toState&&stateChangeA.toParams===stateChangeB.toParams&&stateChangeA.fromState===stateChangeB.fromState&&stateChangeA.fromParams===stateChangeB.fromParams};this.startStateChange=function(stateChangeObject){self.stateChangeQueue.push(stateChangeObject)},this.handleStateChange=function(stateChangeObject){var param,fromParams=stateChangeObject.fromParams,toParams=stateChangeObject.toParams;for(param in fromParams)fromParams.hasOwnProperty(param)&&(toParams.hasOwnProperty(param)||self.setStateVar(param,null));for(param in toParams)toParams.hasOwnProperty(param)&&(fromParams.hasOwnProperty(param)?fromParams[param]!==toParams[param]&&self.setStateVar(param,toParams[param]):self.setStateVar(param,toParams[param]));for(var stateStack=[structure],stateNameStack=["home"],clearBelow=!1;stateStack.length>0;){var stackLength=stateStack.length,parentState=stateStack[stackLength-1],parentStateName=stateNameStack[stackLength-1];if("home"===parentStateName||self.state[parentStateName]||(clearBelow=!0),parentState.children)for(var i=0;i<parentState.children.length;i++){var childStateName=parentState.children[i].plugin;stateNameStack.push(childStateName),stateStack.push(parentState.children[i]),clearBelow&&self.setStateVar(childStateName,null)}stateStack.splice(0,1),stateNameStack.splice(0,1)}if(compareStateChangeObjects(stateChangeObject,self.stateChangeQueue[0])){self.stateChangeQueue.pop();var functionList=self.functionsUsed();0===functionList.length&&self.state.loggedIn&&!self.state.account?(self.setStateVar("account",Auth.username),self.updateState()):self.updateState(!0)}else self.stateChangeQueue.pop(),self.handleStateChange(self.stateChangeQueue[self.stateChangeQueue.length-1])},this.stateVars={},this.clearState=function(state){for(var state in self.state)["changing","authInitialized","loggedIn"].indexOf(state)===-1&&self.state.hasOwnProperty(state)&&self.setStateVar(state,null)},this.clearQuery=function(state){for(var param in self.query)delete self.query[param]},this.functionsUsed=function(){var functionList=[];if(self.structure.functions)for(i=0;i<self.structure.functions.length;i++)if(functionName=self.structure.functions[i],self.state[functionName]){functionList.push(functionName);break}return functionList},this.genStateName=function(){var currentChildren=self.structure.children,childidx=0,stateName="home.",functionList=self.functionsUsed(),usesFunction=functionList.length>0;if(usesFunction)stateName+=functionList.join(".")+".";else for(;childidx<currentChildren.length;){var child=currentChildren[childidx],plugin=child.plugin;self.state.hasOwnProperty(plugin)&&self.state[plugin]&&(stateName+=plugin+".",currentChildren=child.children?child.children:[],childidx=-1),childidx+=1}return stateName.substring(0,stateName.length-1)},this.setStateVar=function(varName,value){null===value?delete self.state[varName]:self.state[varName]!==value&&(self.state.changing=!0,self.changedState[varName]=value),self.state[varName]=value},this.setState=function(stateParams){for(var state in stateParams)stateParams.hasOwnProperty(state)&&self.setStateVar(state,stateParams[state])},this.setQuery=function(queryParams){for(var param in queryParams)queryParams.hasOwnProperty(param)&&(self.query[param]=queryParams[param])},this.updateState=function(dontUpdateLocation){var newStateName=self.genStateName();Object.keys(self.changedState).length&&(EventService.send(EventService.EVENT.STATE_CHANGED,self.changedState),self.changedState={});var updateLocation=!dontUpdateLocation;$state.transitionTo(newStateName,self.state,{location:updateLocation}),$timeout(function(){self.state.changing=!1})},$rootScope.$watch(EventService.currentEvent,function(event){if(angular.isDefined(event)&&angular.isDefined(event.type))if(event.type===EventService.EVENT.SET_STATE){for(var key in event.value)"updateLocation"!==key&&event.value.hasOwnProperty(key)&&self.setStateVar(key,event.value[key]);self.updateState()}else event.type===EventService.EVENT.CLEAR_STATE&&self.clearState()})}])}(),function(){"use strict";function autoLogin(){return{restrict:"E",scope:{account:"@",password:"@"},controller:AutoLoginCtrl,controllerAs:"al",bindToController:!0}}function AutoLoginCtrl(Auth){var al=this;al.getTemplateUrl=function(){return al.templateUrl},Auth.login(al.account,al.password)}angular.module("3drepo").directive("autoLogin",autoLogin),AutoLoginCtrl.$inject=["Auth"]}(),function(){"use strict";function home(){return{restrict:"E",templateUrl:"home.html",scope:{account:"@",password:"@",loggedInUrl:"@",loggedOutUrl:"@"},controller:HomeCtrl,controllerAs:"vm",bindToController:!0}}function HomeCtrl($scope,$element,$timeout,$compile,$mdDialog,$window,Auth,StateManager,EventService,UtilsService,serverConfig){var homeLoggedOut,notLoggedInElement,element,func,i,vm=this;vm.state=StateManager.state,vm.query=StateManager.query,vm.functions=StateManager.functions,vm.pointerEvents="auto",vm.goToAccount=!1,vm.goToUserPage=!1,vm.legalDisplays=[],angular.isDefined(serverConfig.legal)&&(vm.legalDisplays=serverConfig.legal),vm.legalDisplays.push({title:"Pricing",page:"pricing"}),vm.legalDisplays.push({title:"Contact",page:"contact"}),$timeout(function(){homeLoggedOut=angular.element($element[0].querySelector("#homeLoggedOut")),$scope.$watch("vm.state",function(newState,oldState){if(newState!==oldState&&!vm.state.changing&&vm.state.authInitialized){for(homeLoggedOut.empty(),vm.goToUserPage=!1,i=0;i<vm.functions.length;i++)if(func=vm.functions[i],vm.state[func]){vm.goToUserPage=!0,element="<"+UtilsService.snake_case(func,"-")+" username='vm.query.username' token='vm.query.token' query='vm.query'></"+UtilsService.snake_case(func,"-")+">",notLoggedInElement=angular.element(element),homeLoggedOut.append(notLoggedInElement),$compile(notLoggedInElement)($scope);break}vm.state.loggedIn||vm.goToUserPage||(notLoggedInElement=angular.element("<login></login>"),homeLoggedOut.append(notLoggedInElement),$compile(notLoggedInElement)($scope))}},!0)}),angular.isDefined(vm.account)&&angular.isDefined(vm.password)&&Auth.login(vm.account,vm.password),vm.logout=function(){Auth.logout()},vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)},vm.legalDisplay=function(event,display){$window.open("/"+display.value)},$scope.$watch(EventService.currentEvent,function(event){angular.isDefined(event)&&angular.isDefined(event.type)&&(event.type===EventService.EVENT.USER_LOGGED_IN?event.value.error||event.value.initialiser||(StateManager.setStateVar("loggedIn",!0),EventService.send(EventService.EVENT.GO_HOME)):event.type===EventService.EVENT.USER_LOGGED_OUT?(EventService.send(EventService.EVENT.CLEAR_STATE),EventService.send(EventService.EVENT.SET_STATE,{loggedIn:!1,account:null})):event.type===EventService.EVENT.SHOW_PROJECTS?(EventService.send(EventService.EVENT.CLEAR_STATE),Auth.init()):event.type===EventService.EVENT.GO_HOME?(EventService.send(EventService.EVENT.CLEAR_STATE),StateManager.state.loggedIn?EventService.send(EventService.EVENT.SET_STATE,{account:Auth.username}):EventService.send(EventService.EVENT.SET_STATE,{})):event.type===EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING&&(vm.pointerEvents=event.value.on?"none":"auto"))}),$scope.closeDialog=function(){$mdDialog.cancel()}}angular.module("3drepo").directive("home",home).config(function($injector){if($injector.has("$mdThemingProvider")){var mdThemingProvider=$injector.get("$mdThemingProvider");mdThemingProvider.definePalette("three_d_repo_primary",{50:"004594",100:"004594",200:"004594",300:"004594",400:"004594",500:"004594",600:"004594",700:"004594",800:"004594",900:"004594",A100:"004594",A200:"004594",A400:"004594",A700:"004594",contrastDefaultColor:"light",contrastDarkColors:["50","100","200","300","400","A100"],contrastLightColors:void 0}),mdThemingProvider.theme("default").primaryPalette("three_d_repo_primary",{default:"500","hue-1":"400","hue-2":"200","hue-3":"50"}).accentPalette("green",{default:"600"}).warnPalette("red")}}),HomeCtrl.$inject=["$scope","$element","$timeout","$compile","$mdDialog","$window","Auth","StateManager","EventService","UtilsService","serverConfig"]}(),function(){"use strict";angular.module("3drepo").factory("authInterceptor",["EventService","$q",function(EventService,$q){return{responseError:function(res){return 401===res.status&&EventService.send(EventService.EVENT.USER_NOT_AUTHORIZED),$q.reject(res)}}}]).config(function($httpProvider){var checkAuthorization=["$q","$location",function($q,$location){var onSuccess=function(res){return res},onError=function(res){return 401===res.status||400===res.status?$q.reject(res):$q.reject(res)};return function(promise){return promise.then(onSuccess,onError)}}];$httpProvider.interceptors.push(checkAuthorization),$httpProvider.defaults.withCredentials=!0,$httpProvider.interceptors.push("authInterceptor")})}(),function(){"use strict";function HttpService($http,$q,EventService,serverConfig){var handlerFactory=function(httpReq){return function(type,url,success,failure){var deferred=$q.defer(),getURI=serverConfig.apiUrl(type,url),successFunc=success||function(response){deferred.resolve(response.data)},failureFunc=failure||function(response){404!==response.status&&401!==response.status||EventService.send(EventService.EVENT.GO_HOME),deferred.resolve([])};return httpReq(getURI).then(successFunc,failureFunc),deferred.promise}},get=handlerFactory($http.get),post=handlerFactory($http.post);return{get:get,post:post}}angular.module("3drepo").factory("HttpService",HttpService),HttpService.$inject=["$http","$q","EventService","serverConfig"]}(),angular.module("3drepo").service("serverConfig",function(){"use strict";for(var k in server_config)this[k]=server_config[k]}),function(){"use strict";function issueArea(){return{restrict:"EA",templateUrl:"issueArea.html",scope:{data:"=",type:"="},link:function(scope,element){element.on("$destroy",function(){scope.vm.eventsWatch()})},controller:IssueAreaCtrl,controllerAs:"vm",bindToController:!0}}function IssueAreaCtrl($scope,$element,$window,$timeout,EventService){function resizeCanvas(){canvas.attr("width",$element[0].offsetWidth),canvas.attr("height",$element[0].offsetHeight)}function initCanvas(canvas){clearCanvas(),canvas.addEventListener("mousedown",function(evt){mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging=!0,updateImage(canvas),window.status="DOWN: "+evt.layerX+", "+evt.layerY,evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!0}),vm.pointerEvents="none"},!1),canvas.addEventListener("mouseup",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),vm.pointerEvents="auto"},!1),canvas.addEventListener("mouseout",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),vm.pointerEvents="auto"},!1),canvas.addEventListener("mousemove",function(evt){window.status="MOVE: "+evt.layerX+", "+evt.layerY,mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging||vm.showPenIndicator?(last_mouse_drag_x===-1||hasDrawnOnCanvas||(hasDrawnOnCanvas=!0),updateImage(canvas)):$timeout(function(){vm.showPenIndicator=!0}),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,setPenIndicatorPosition(evt.layerX,evt.layerY)},!1)}function updateImage(canvas){var context=canvas.getContext("2d");if(mouse_dragging){if(last_mouse_drag_x<0||last_mouse_drag_y<0)return last_mouse_drag_x=mouse_drag_x,void(last_mouse_drag_y=mouse_drag_y);context.lineWidth=pen_size,context.beginPath(),context.strokeStyle=pen_col,context.moveTo(last_mouse_drag_x,last_mouse_drag_y),context.lineTo(mouse_drag_x,mouse_drag_y),context.stroke(),last_mouse_drag_x=mouse_drag_x,last_mouse_drag_y=mouse_drag_y}}function clearCanvas(){var context=myCanvas.getContext("2d");context.clearRect(0,0,myCanvas.width,myCanvas.height),context.fillStyle=canvasColour,context.fillRect(0,0,myCanvas.width,myCanvas.height),context.lineCap="round"}function setupPin(){vm.canvasPointerEvents="none"}function setupErase(){var context=myCanvas.getContext("2d");context.globalCompositeOperation="destination-out",pen_col="rgba(0, 0, 0, 1)",vm.canvasPointerEvents="auto"}function setupScribble(){var context=myCanvas.getContext("2d");context.globalCompositeOperation="source-over",pen_col="#FF0000",pen_size=penIndicatorSize,vm.canvasPointerEvents="auto"}function setPenIndicatorPosition(x,y){var positionFactor=2.2;penIndicator.css("left",x-penIndicatorSize/positionFactor+"px"),penIndicator.css("top",y-penIndicatorSize/positionFactor+"px")}var canvas,myCanvas,penIndicator,vm=this,canvasColour="rgba(0 ,0 ,0, 0)",mouse_drag_x=0,mouse_drag_y=0,last_mouse_drag_x=-1,last_mouse_drag_y=-1,mouse_button=0,mouse_dragging=!1,pen_col="#FF0000",initialPenIndicatorSize=10,penIndicatorSize=initialPenIndicatorSize,penToIndicatorRatio=.8,pen_size=penIndicatorSize*penToIndicatorRatio,hasDrawnOnCanvas=!1;$timeout(function(){angular.isDefined(vm.data)?vm.data.hasOwnProperty("scribble")&&(vm.scribble="data:image/png;base64,"+vm.data.scribble):(canvas=angular.element($element[0].querySelector("#issueAreaCanvas")),myCanvas=document.getElementById("issueAreaCanvas"),penIndicator=angular.element($element[0].querySelector("#issueAreaPenIndicator")),penIndicator.css("font-size",penIndicatorSize+"px"),vm.pointerEvents="auto",vm.showPenIndicator=!1,resizeCanvas(),initCanvas(myCanvas),angular.isDefined(vm.type)&&(vm.canvasPointerEvents="pin"===vm.type?"none":"auto"))}),vm.eventsWatch=$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.SET_ISSUE_AREA_MODE)"scribble"===event.value?setupScribble():"erase"===event.value?setupErase():"pin"===event.value&&setupPin();else if(event.type===EventService.EVENT.GET_ISSUE_AREA_PNG){var png=null;hasDrawnOnCanvas&&(png=myCanvas.toDataURL("image/png"),png=png.substring(png.indexOf(",")+1)),event.value.promise.resolve(png)}}),angular.element($window).bind("resize",function(){})}angular.module("3drepo").directive("issueArea",issueArea),IssueAreaCtrl.$inject=["$scope","$element","$window","$timeout","EventService"]}(),function(){"use strict";function IssueCompCtrl($q,$mdDialog,EventService,IssuesService,UtilsService){function saveIssue(){var data,viewpointPromise=$q.defer(),screenShotPromise=$q.defer();self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise}}),viewpointPromise.promise.then(function(viewpoint){null!==savedScreenShot?null!==issueSelectedObjects?(data={name:self.issueData.name,color:[255,0,0],parents:issueSelectedObjects},UtilsService.doPost(data,self.account+"/"+self.project+"/groups").then(function(response){doSaveIssue(viewpoint,savedScreenShot,response.data._id)})):doSaveIssue(viewpoint,savedScreenShot):(self.sendEvent({type:EventService.EVENT.VIEWER.GET_SCREENSHOT,value:{promise:screenShotPromise}}),screenShotPromise.promise.then(function(screenShot){null!==issueSelectedObjects?(data={name:self.issueData.name,color:[255,0,0],parents:issueSelectedObjects},UtilsService.doPost(data,self.account+"/"+self.project+"/groups").then(function(response){doSaveIssue(viewpoint,screenShot,response.data._id)})):doSaveIssue(viewpoint,screenShot)}))})}function doSaveIssue(viewpoint,screenShot,groupId){var issue;screenShot=screenShot.substring(screenShot.indexOf(",")+1),viewpoint.screenshot=screenShot,issue={account:self.account,project:self.project,objectId:null,name:self.issueData.name,viewpoint:viewpoint,creator_role:self.userRoles[0],pickedPos:null,pickedNorm:null,scale:1,assigned_roles:[],priority:self.issueData.priority,status:self.issueData.status,topic_type:self.issueData.topic_type,desc:self.issueData.desc},null!==self.pinData&&(issue.pickedPos=self.pinData.pickedPos,issue.pickedNorm=self.pinData.pickedNorm),angular.isDefined(groupId)&&(issue.group_id=groupId),IssuesService.saveIssue(issue).then(function(response){console.log(response),self.data=response.data,self.issueData=response.data,self.issueData.title=IssuesService.generateTitle(self.issueData),self.descriptionThumbnail=UtilsService.getServerUrl(self.issueData.viewpoint.screenshotSmall),self.issueData.timeStamp=IssuesService.getPrettyTime(self.issueData.created),self.hideDescription=!self.issueData.hasOwnProperty("desc"),self.issueCreated({issue:self.issueData}),self.actions.pin.hidden=!0,self.actions.multi.hidden=!0,self.submitDisabled=!0,setContentHeight()})}function updateIssue(){var data={priority:self.issueData.priority,status:self.issueData.status,topic_type:self.issueData.topic_type};IssuesService.updateIssue(self.issueData,data).then(function(data){console.log(data),IssuesService.updatedIssue=self.issueData})}function saveComment(){var viewpointPromise=$q.defer();angular.isDefined(self.commentThumbnail)?IssuesService.saveComment(self.issueData,self.comment,commentViewpoint).then(function(response){console.log(response),afterNewComment(response.data.issue)}):(self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise}}),viewpointPromise.promise.then(function(viewpoint){IssuesService.saveComment(self.issueData,self.comment,viewpoint).then(function(response){console.log(response),afterNewComment(response.data.issue)})}))}function afterNewComment(comment){self.issueData.comments.push({comment:comment.comment,owner:comment.owner,timeStamp:IssuesService.getPrettyTime(comment.created),viewpoint:comment.viewpoint}),self.issueData.comments.length>1&&IssuesService.sealComment(self.issueData,self.issueData.comments.length-2).then(function(response){console.log(response),self.issueData.comments[self.issueData.comments.length-2].sealed=!0}),delete self.comment,delete self.commentThumbnail,IssuesService.updatedIssue=self.issueData,self.submitDisabled=!0,aboutToBeDestroyed||setContentHeight()}function ScreenShotDialogController(){this.dialogCaller=self,this.closeScreenShot=function(){self.actions[currentAction].color="",currentAction=null}}function setContentHeight(){var i,length,newIssueHeight=425,issueMinHeight=672,descriptionTextHeight=80,commentTextHeight=80,commentImageHeight=170,additionalInfoHeight=70,thumbnailHeight=170,height=issueMinHeight;if(self.data)for(self.showAdditional&&(height+=additionalInfoHeight),self.issueData.hasOwnProperty("desc")&&(height+=descriptionTextHeight),self.commentThumbnail&&(height+=thumbnailHeight),i=0,length=self.issueData.comments.length;i<length;i+=1)height+=commentTextHeight,self.issueData.comments[i].viewpoint.hasOwnProperty("screenshot")&&(height+=commentImageHeight);else height=newIssueHeight,self.showAdditional&&(height+=additionalInfoHeight);self.contentHeight({height:height})}var commentViewpoint,self=this,savedScreenShot=null,highlightBackground="#FF9800",currentAction=null,editingCommentIndex=null,issueSelectedObjects=null,aboutToBeDestroyed=!1;this.UtilsService=UtilsService,this.hideDescription=!1,this.submitDisabled=!0,this.pinData=null,this.showAdditional=!0,this.editingDescription=!1,this.priorities=[{value:"none",label:"None"},{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],this.statuses=[{value:"open",label:"Open"},{value:"in progress",label:"In progress"},{value:"closed",label:"Closed"}],this.topic_types=[{value:"for_information",label:"For information"},{value:"for_approval",label:"For approval"},{value:"vr",label:"VR"}],this.actions={screen_shot:{icon:"camera_alt",label:"Screen shot",color:"",hidden:!1},pin:{icon:"place",label:"Pin",color:"",hidden:this.data},multi:{icon:"view_comfy",label:"Multi",color:"",hidden:this.data}},this.$onChanges=function(changes){var i,length;if(changes.hasOwnProperty("data")){if(this.data){if(console.log(this.data),this.issueData=angular.copy(this.data),this.issueData.name=IssuesService.generateTitle(this.issueData),this.hideDescription=!this.issueData.hasOwnProperty("desc"),this.issueData.viewpoint.hasOwnProperty("screenshotSmall")&&(this.descriptionThumbnail=UtilsService.getServerUrl(this.issueData.viewpoint.screenshotSmall)),this.canUpdate=this.account===this.issueData.owner,!this.canUpdate)for(i=0,length=this.userRoles.length;i<length;i+=1)if(this.userRoles[i]===this.issueData.creator_role){this.canUpdate=!0;break}this.canEditDescription=0===this.issueData.comments.length}else this.issueData={priority:"none",status:"open",topic_type:"for_information",viewpoint:{}},this.canUpdate=!0;this.statusIcon=IssuesService.getStatusIcon(this.issueData),setContentHeight()}changes.hasOwnProperty("selectedObjects")&&this.selectedObjects&&null!==currentAction&&"multi"===currentAction&&(issueSelectedObjects=this.selectedObjects),changes.hasOwnProperty("event")&&this.event&&null!==currentAction&&"multi"===currentAction&&this.event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED&&(issueSelectedObjects=null)},this.$onDestroy=function(){aboutToBeDestroyed=!0,this.comment&&(IssuesService.updatedIssue=self.issueData,saveComment()),null!==editingCommentIndex&&(this.issueData.comments[editingCommentIndex].editing=!1),null!==currentAction&&"pin"===currentAction&&this.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1})},this.nameChange=function(){this.submitDisabled=!this.issueData.name},this.commentChange=function(){this.submitDisabled=this.data&&!this.comment},this.statusChange=function(){this.statusIcon=IssuesService.getStatusIcon(this.issueData),this.data&&(this.submitDisabled=this.data.priority===this.issueData.priority&&this.data.status===this.issueData.status)},this.submit=function(){self.data?self.data.owner===self.account&&(this.data.priority!==this.issueData.priority||this.data.status!==this.issueData.status)?(updateIssue(),"undefined"!=typeof this.comment&&saveComment()):saveComment():saveIssue()},this.showViewpoint=function(event,viewpoint){if("click"===event.type){var data={position:viewpoint.position,view_dir:viewpoint.view_dir,up:viewpoint.up};self.sendEvent({type:EventService.EVENT.VIEWER.SET_CAMERA,value:data})}},this.showScreenShot=function(viewpoint){self.screenShot=UtilsService.getServerUrl(viewpoint.screenshot),$mdDialog.show({controller:function(){this.dialogCaller=self},controllerAs:"vm",templateUrl:"issueScreenShotDialog.html"})},this.doAction=function(action){var data;if(null===currentAction)currentAction=action;else if(currentAction===action){switch(action){case"multi":issueSelectedObjects=this.selectedObjects;break;case"pin":self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1})}this.actions[currentAction].color="",currentAction=null,self.action=null}else{switch(action){case"multi":issueSelectedObjects=this.selectedObjects;break;case"pin":self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1})}this.actions[currentAction].color="",currentAction=action}if(null!==currentAction)switch(this.actions[currentAction].color=highlightBackground,self.action=action,currentAction){case"screen_shot":delete this.screenShot,$mdDialog.show({controller:ScreenShotDialogController,controllerAs:"vm",templateUrl:"issueScreenShotDialog.html"});break;case"multi":null!==issueSelectedObjects?this.setInitialSelectedObjects({selectedObjects:issueSelectedObjects}):issueSelectedObjects=this.selectedObjects;break;case"pin":data=self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!0})}},this.setPin=function(pinData){self.pinData=pinData.data},this.toggleShowAdditional=function(){this.showAdditional=!this.showAdditional,setContentHeight()},this.toggleEditDescription=function(event){if(event.stopPropagation(),this.editingDescription){this.editingDescription=!1;var data={desc:self.issueData.desc};IssuesService.updateIssue(self.issueData,data).then(function(data){console.log(data)})}else this.editingDescription=!0},this.deleteComment=function(event,index){event.stopPropagation(),IssuesService.deleteComment(self.issueData,index).then(function(response){self.issueData.comments.splice(index,1)}),setContentHeight()},this.toggleEditComment=function(event,index){event.stopPropagation(),this.issueData.comments[index].editing?(editingCommentIndex=null,this.issueData.comments[index].editing=!1,IssuesService.editComment(self.issueData,this.issueData.comments[index].comment,index).then(function(response){self.issueData.comments[index].timeStamp=IssuesService.getPrettyTime(response.data.created);
})):(editingCommentIndex=index,this.issueData.comments[index].editing=!0)},this.screenShotSave=function(data){var viewpointPromise=$q.defer();savedScreenShot=data.screenShot,"object"==typeof self.data?(self.commentThumbnail=data.screenShot,self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise}}),viewpointPromise.promise.then(function(viewpoint){commentViewpoint=viewpoint,commentViewpoint.screenshot=data.screenShot.substring(data.screenShot.indexOf(",")+1)}),setContentHeight()):self.descriptionThumbnail=data.screenShot}}angular.module("3drepo").component("issueComp",{controller:IssueCompCtrl,templateUrl:"issueComp.html",bindings:{account:"<",project:"<",data:"<",keysDown:"<",exit:"&",sendEvent:"&",event:"<",issueCreated:"&",contentHeight:"&",selectedObjects:"<",setInitialSelectedObjects:"&",userRoles:"<"}}),IssueCompCtrl.$inject=["$q","$mdDialog","EventService","IssuesService","UtilsService"]}(),function(){"use strict";function issue(){return{restrict:"EA",templateUrl:"issue.html",scope:{index:"=",data:"=",autoSaveComment:"=",onCommentSaved:"&",onCommentAutoSaved:"&",onToggleCloseIssue:"&",availableRoles:"=",projectUserRoles:"=",onIssueAssignChange:"&"},controller:IssueCtrl,controllerAs:"vm",bindToController:!0}}function IssueCtrl($scope,IssuesService){function setupRolesWatch(){$scope.$watch("vm.roles",function(newValue,oldValue){var i=0,length=0;if(JSON.stringify(newValue)!==JSON.stringify(oldValue)){for(vm.data.assigned_roles=[],i=0,length=vm.roles.length;i<length;i+=1)vm.roles[i].assigned&&vm.data.assigned_roles.push(vm.roles[i].role);promise=IssuesService.assignIssue(vm.data),promise.then(function(){setAssignedRolesColors(),vm.onIssueAssignChange()})}},!0)}function initAssignedRolesDisplay(){var i=0,length=0;if(angular.isDefined(vm.roles)&&angular.isDefined(vm.data)&&vm.data.hasOwnProperty("assigned_roles")){for(i=0,length=vm.roles.length;i<length;i+=1)vm.roles[i].assigned=vm.data.assigned_roles.indexOf(vm.roles[i].role)!==-1;setAssignedRolesColors()}}function setAssignedRolesColors(){var i,length,pinColours=[];for(vm.assignedRolesColors=[],i=0,length=vm.roles.length;i<length;i+=1)if(vm.data.assigned_roles.indexOf(vm.roles[i].role)!==-1){var roleColour=IssuesService.getRoleColor(vm.roles[i].role);vm.assignedRolesColors.push(roleColour),pinColours.push(IssuesService.hexToRgb(roleColour))}}function setupCanModifyIssue(){var i=0,length=0;if(vm.canModifyIssue=!1,angular.isDefined(vm.projectUserRoles)&&angular.isDefined(vm.data)&&vm.data.hasOwnProperty("assigned_roles")&&(vm.canModifyIssue=vm.projectUserRoles.indexOf(vm.data.creator_role)!==-1,!vm.canModifyIssue))for(i=0,length=vm.projectUserRoles.length;i<length;i+=1)if(vm.data.assigned_roles.indexOf(vm.projectUserRoles[i])!==-1){vm.canModifyIssue=!0;break}}var initWatch,vm=this,promise=null,originatorEv=null;vm.showComments=!0,vm.numNewComments=0,vm.saveCommentDisabled=!0,vm.autoSaveComment=!1,vm.showInfo=!1,vm.editingComment=!1,vm.assignedRolesColors=[],vm.savingComment=!1,vm.togglingIssueState=!0,$scope.$watch("vm.availableRoles",function(newValue){var i=0,length=0;if(angular.isDefined(newValue)){for(vm.roles=[],i=0,length=newValue.length;i<length;i+=1)vm.roles.push({role:newValue[i].role,color:newValue[i].color});setupRolesWatch(),initAssignedRolesDisplay(),setupCanModifyIssue()}}),$scope.$watch("vm.autoSaveComment",function(newValue){angular.isDefined(newValue)&&newValue&&!vm.editingComment&&angular.isDefined(vm.comment)&&""!==vm.comment&&(vm.autoSaveComment=!0,vm.saveComment())}),$scope.$watch("vm.comment",function(newValue){angular.isDefined(newValue)&&(vm.saveCommentDisabled=""===newValue)}),initWatch=$scope.$watch("vm.data",function(newValue){var i=0,length=0;if(angular.isDefined(newValue)){if(vm.issueIsOpen=!0,newValue.hasOwnProperty("closed")&&(vm.issueIsOpen=!newValue.closed),vm.issueIsOpen&&newValue.hasOwnProperty("comments"))for(i=0,length=newValue.comments.length;i<length;i+=1)newValue.comments[i].canDelete=i===newValue.comments.length-1&&!newValue.comments[i].sealed;initAssignedRolesDisplay()}initWatch()},!0),vm.saveComment=function(){angular.isDefined(vm.comment)&&""!==vm.comment&&(vm.savingComment=!0,vm.editingComment?(promise=IssuesService.editComment(vm.data,vm.comment,vm.editingCommentIndex),promise.then(function(data){vm.data.comments[vm.editingCommentIndex].comment=vm.comment,vm.data.comments[vm.editingCommentIndex].timeStamp=IssuesService.getPrettyTime(data.created),vm.comment="",vm.savingComment=!1})):(promise=IssuesService.saveComment(vm.data,vm.comment),promise.then(function(data){console.log(data),vm.data.hasOwnProperty("comments")||(vm.data.comments=[]),vm.data.comments.push({owner:data.owner,comment:vm.comment,created:data.created,timeStamp:IssuesService.getPrettyTime(data.created)}),vm.comment="",vm.numNewComments+=1,vm.autoSaveComment?(vm.onCommentAutoSaved({index:vm.index}),vm.autoSaveComment=!1):vm.onCommentSaved(),vm.data.comments.length>1&&(promise=IssuesService.setComment(vm.data,vm.data.comments.length-2),promise.then(function(data){vm.data.comments[vm.data.comments.length-2].set=!0})),vm.savingComment=!1})))},vm.deleteComment=function(index){promise=IssuesService.deleteComment(vm.data,index),promise.then(function(data){vm.data.comments.splice(index,1),vm.numNewComments-=1,vm.comment="",vm.editingComment=!1})},vm.toggleEditComment=function(index){vm.editingComment=!vm.editingComment,vm.editingCommentIndex=index,vm.editingComment?vm.comment=vm.data.comments[vm.data.comments.length-1].comment:vm.comment=""},vm.toggleCloseIssue=function(){vm.issueIsOpen=!vm.issueIsOpen,vm.onToggleCloseIssue({issue:vm.data})},vm.openAssignedRolesMenu=function($mdOpenMenu,event){originatorEv=event,$mdOpenMenu(event)}}angular.module("3drepo").directive("issue",issue),IssueCtrl.$inject=["$scope","IssuesService"]}(),function(){"use strict";function issueHeader(){return{restrict:"EA",templateUrl:"issueHeader.html",scope:{index:"=",issueData:"=",onClick:"&",showInfo:"=",infoText:"=",onHideInfo:"&"},controller:IssueHeaderCtrl,controllerAs:"vm",bindToController:!0}}function IssueHeaderCtrl(){var vm=this;vm.click=function(){angular.isDefined(vm.onClick)&&vm.onClick({index:vm.index,pinSelect:!1})}}angular.module("3drepo").directive("issueHeader",issueHeader),IssueHeaderCtrl.$inject=[]}(),function(){"use strict";function IssuesPinCtrl(EventService){function removePin(){self.sendEvent({type:EventService.EVENT.VIEWER.REMOVE_PIN,value:{id:newPinId}}),self.sendEvent({type:EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,value:[]}),self.setPin({data:null})}var self=this,newPinId="newPinId";this.setPin({data:null}),this.$onChanges=function(changes){var data,position=[],normal=[],pickedPos=null,pickedNorm=null;changes.hasOwnProperty("event")&&null!==changes.event.currentValue&&(changes.event.currentValue.type===EventService.EVENT.VIEWER.PICK_POINT&&changes.event.currentValue.value.hasOwnProperty("id")?(removePin(),angular.forEach(changes.event.currentValue.value.position,function(value){pickedPos=changes.event.currentValue.value.position,position.push(value)}),angular.forEach(changes.event.currentValue.value.normal,function(value){pickedNorm=changes.event.currentValue.value.normal,normal.push(value)}),data={id:newPinId,account:self.account,project:self.project,position:position,norm:normal,selectedObjectId:changes.event.currentValue.value.id,pickedPos:pickedPos,pickedNorm:pickedNorm,colours:[[200,0,0]]},self.sendEvent({type:EventService.EVENT.VIEWER.ADD_PIN,value:data}),this.setPin({data:data})):changes.event.currentValue.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED&&removePin())},this.$onDestroy=function(){removePin()}}angular.module("3drepo").component("issuesPin",{controller:IssuesPinCtrl,bindings:{account:"<",project:"<",sendEvent:"&",event:"<",setPin:"&"}}),IssuesPinCtrl.$inject=["EventService"]}(),function(){"use strict";function IssuesScreenShotCtrl($q,$timeout,$element,UtilsService,EventService){function initCanvas(canvas){canvas.addEventListener("mousedown",function(evt){mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging=!0,updateImage(canvas),window.status="DOWN: "+evt.layerX+", "+evt.layerY,evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!0}),self.actionsPointerEvents="none"},!1),canvas.addEventListener("mouseup",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),self.actionsPointerEvents="auto"},!1),canvas.addEventListener("mouseout",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),self.actionsPointerEvents="auto"},!1),canvas.addEventListener("mousemove",function(evt){window.status="MOVE: "+evt.layerX+", "+evt.layerY,mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging||self.showPenIndicator?(last_mouse_drag_x===-1||hasDrawnOnCanvas||(hasDrawnOnCanvas=!0),updateImage(canvas)):$timeout(function(){self.showPenIndicator=!0}),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,setPenIndicatorPosition(evt.layerX,evt.layerY)},!1)}function updateImage(canvas){var context=canvas.getContext("2d");if(mouse_dragging){if(last_mouse_drag_x<0||last_mouse_drag_y<0)return last_mouse_drag_x=mouse_drag_x,void(last_mouse_drag_y=mouse_drag_y);context.lineWidth=pen_size,context.strokeStyle=pen_col,context.beginPath(),context.lineCap="round",context.moveTo(last_mouse_drag_x,last_mouse_drag_y),context.lineTo(mouse_drag_x,mouse_drag_y),context.stroke(),last_mouse_drag_x=mouse_drag_x,last_mouse_drag_y=mouse_drag_y}}function setupErase(){scribbleCanvasContext.globalCompositeOperation="destination-out",pen_col="rgba(0, 0, 0, 1)"}function setupScribble(){scribbleCanvasContext.globalCompositeOperation="source-over",pen_col="#FF0000"}function setPenIndicatorPosition(x,y){var positionFactorX=10,positionFactorY=30;penIndicator.css("left",x-positionFactorX+"px"),penIndicator.css("top",y+positionFactorY+"px")}var scribbleCanvas,scribbleCanvasContext,penIndicator,self=this,currentActionIndex=null,highlightBackground="#FF9800",screenShotPromise=$q.defer(),innerWidth=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,innerHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,mouse_drag_x=0,mouse_drag_y=0,last_mouse_drag_x=-1,last_mouse_drag_y=-1,mouse_button=0,mouse_dragging=!1,pen_col="#DD0000",penIndicatorSize=16,penToIndicatorRatio=.5,pen_size=penIndicatorSize*penToIndicatorRatio,hasDrawnOnCanvas=!1;"undefined"!=typeof this.screenShot?self.screenShotUse=this.screenShot:$timeout(function(){scribbleCanvas=document.getElementById("scribbleCanvas"),scribbleCanvasContext=scribbleCanvas.getContext("2d"),scribbleCanvas.width=80*innerWidth/100,scribbleCanvas.height=80*innerHeight/100,initCanvas(scribbleCanvas),setupScribble(),self.showPenIndicator=!1,penIndicator=angular.element($element[0].querySelector("#issueScreenShotPenIndicator")),penIndicator.css("font-size",penIndicatorSize+"px"),self.actionsPointerEvents="auto",self.sendEvent({type:EventService.EVENT.VIEWER.GET_SCREENSHOT,value:{promise:screenShotPromise}}),screenShotPromise.promise.then(function(screenShot){self.screenShotUse=screenShot}),self.actions=[{icon:"border_color",action:"draw",label:"Draw",color:highlightBackground},{icon:"fa fa-eraser",action:"erase",label:"Erase",color:""}],currentActionIndex=0}),this.closeDialog=function(){UtilsService.closeDialog(),this.close()},this.doAction=function(index){switch(null===currentActionIndex?(currentActionIndex=index,this.actions[currentActionIndex].color=highlightBackground):currentActionIndex===index?(this.actions[currentActionIndex].color="",currentActionIndex=null):(this.actions[currentActionIndex].color="",currentActionIndex=index,this.actions[currentActionIndex].color=highlightBackground),this.actions[currentActionIndex].action){case"draw":setupScribble();break;case"erase":setupErase()}},this.save=function(){var screenShot,screenShotCanvas=document.getElementById("screenShotCanvas"),screenShotCanvasContext=screenShotCanvas.getContext("2d"),screenShotImage=new Image;screenShotCanvas.width=scribbleCanvas.width,screenShotCanvas.height=scribbleCanvas.height,screenShotImage.src=this.screenShotUse,screenShotCanvasContext.drawImage(screenShotImage,0,0,screenShotCanvas.width,screenShotCanvas.height),screenShotCanvasContext.drawImage(scribbleCanvas,0,0),screenShot=screenShotCanvas.toDataURL("image/png"),this.screenShotSave({screenShot:screenShot}),this.closeDialog()}}angular.module("3drepo").component("issuesScreenShot",{controller:IssuesScreenShotCtrl,templateUrl:"issueScreenShot.html",bindings:{sendEvent:"&",close:"&",screenShotSave:"&",screenShot:"="}}),IssuesScreenShotCtrl.$inject=["$q","$timeout","$element","UtilsService","EventService"]}(),function(){"use strict";function issues(){return{restrict:"EA",templateUrl:"issues.html",scope:{account:"=",project:"=",branch:"=",revision:"=",filterText:"=",show:"=",showAdd:"=",selectedMenuOption:"=",onContentHeightRequest:"&",onShowItem:"&",hideItem:"=",keysDown:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:IssuesCtrl,controllerAs:"vm",bindToController:!0}}function IssuesCtrl($scope,$timeout,IssuesService,EventService,Auth,UtilsService){function setAllIssuesAssignedRolesColors(){var i,length;if(null!==vm.availableRoles)for(i=0,length=vm.issues.length;i<length;i+=1)setIssueAssignedRolesColors(vm.issues[i])}function setIssueAssignedRolesColors(issue){var i,length,roleColour,pinColours=[];for(issue.assignedRolesColors=[],i=0,length=issue.assigned_roles.length;i<length;i+=1)roleColour=IssuesService.getRoleColor(issue.assigned_roles[i]),issue.assignedRolesColors.push(roleColour),pinColours.push(IssuesService.hexToRgb(roleColour))}function deselectPin(issueId){EventService.send(EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,{id:issueId,colours:[[.5,0,0]]})}var promise,rolesPromise,projectUserRolesPromise,vm=this,selectedIssue=null;vm.saveIssueDisabled=!0,vm.issues=[],vm.issuesToShow=[],vm.showProgress=!0,vm.progressInfo="Loading issues",vm.availableRoles=null,vm.projectUserRoles=[],vm.selectedIssue=null,vm.autoSaveComment=!1,vm.onContentHeightRequest({height:70}),vm.savingIssue=!1,vm.toShow="showIssues",promise=IssuesService.getIssues(vm.account,vm.project,vm.revision),promise.then(function(data){vm.showProgress=!1,vm.issues=""===data?[]:data}),rolesPromise=IssuesService.getRoles(vm.account,vm.project),rolesPromise.then(function(data){vm.availableRoles=data,setAllIssuesAssignedRolesColors()}),projectUserRolesPromise=IssuesService.getUserRolesForProject(vm.account,vm.project,Auth.username),projectUserRolesPromise.then(function(data){vm.projectUserRoles=data}),$scope.$watch("vm.title",function(){vm.saveIssueDisabled=angular.isUndefined(vm.title)||""===vm.title.toString()}),$scope.$watch(EventService.currentEvent,function(event){vm.event=event}),vm.issueAssignChange=function(){setIssueAssignedRolesColors(vm.selectedIssue),vm.showPins()},vm.showAlert=function(title){vm.showAddAlert=!0,vm.addAlertText=title},vm.closeAddAlert=function(){vm.showAddAlert=!1,vm.addAlertText=""},vm.commentSaved=function(){vm.setContentHeight()},vm.commentAutoSaved=function(index){vm.selectedIndex=index,vm.infoText="Comment on issue #"+vm.issuesToShow[vm.selectedIndex].title+" auto-saved",vm.issuesToShow[vm.selectedIndex].showInfo=!0,vm.infoTimeout=$timeout(function(){vm.issuesToShow[vm.selectedIndex].showInfo=!1},4e3)},vm.hideInfo=function(){vm.issuesToShow[vm.selectedIndex].showInfo=!1,$timeout.cancel(vm.infoTimeout)},vm.setContentHeight=function(height){vm.onContentHeightRequest({height:height})},$scope.$watch("vm.hideItem",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.toShow="showIssues",vm.setContentHeight())}),$scope.$watch("vm.toShow",function(newValue){angular.isDefined(newValue)&&(vm.showAddButton="showIssues"===newValue.toString()||"showInfo"===newValue.toString())}),vm.sendEvent=function(type,value){EventService.send(type,value)},vm.importBcf=function(file){$scope.$apply(),vm.importingBCF=!0,IssuesService.importBcf(vm.account,vm.project,file).then(function(){return IssuesService.getIssues(vm.account,vm.project,vm.revision)}).then(function(data){vm.importingBCF=!1,vm.issues=""===data?[]:data}).catch(function(err){vm.importingBCF=!1,console.log("Error while importing bcf",err)})},vm.editIssue=function(issue){vm.issueToEdit=issue,vm.event=null,vm.toShow="showIssue",vm.setContentHeight(),vm.onShowItem(),angular.isUndefined(issue)&&null!==selectedIssue&&deselectPin(selectedIssue._id)},vm.editIssueExit=function(issue){vm.hideItem=!0},vm.issueCreated=function(issue){vm.issues.unshift(issue)}}angular.module("3drepo").directive("issues",issues),IssuesCtrl.$inject=["$scope","$timeout","IssuesService","EventService","Auth","UtilsService"]}(),function(){"use strict";function IssuesListCtrl($filter,$window,UtilsService,IssuesService,EventService,serverConfig){function setSelectedIssueIndex(selectedIssue){var i,length;if(null!==selectedIssue)for(i=0,length=self.issuesToShow.length;i<length;i+=1)self.issuesToShow[i]._id===selectedIssue._id&&(selectedIssueIndex=i);else selectedIssueIndex=null}function showIssue(issue){var data,pinHighlightColour=[1,.7,0];data={id:issue._id,colours:pinHighlightColour},self.sendEvent({type:EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,value:data}),data={position:issue.viewpoint.position,view_dir:issue.viewpoint.view_dir,up:issue.viewpoint.up},self.sendEvent({type:EventService.EVENT.VIEWER.SET_CAMERA,value:data}),data={clippingPlanes:issue.viewpoint.clippingPlanes},self.sendEvent({type:EventService.EVENT.VIEWER.SET_CLIPPING_PLANES,value:data}),self.sendEvent({type:EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,value:[]}),issue.hasOwnProperty("group_id")&&UtilsService.doGet(self.account+"/"+self.project+"/groups/"+issue.group_id).then(function(response){data={source:"tree",account:self.account,project:self.project,ids:response.data.parents,colour:response.data.colour},EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,data)})}function deselectPin(issue){var data;issue.position.length>0&&(data={id:issue._id,colours:[[.5,0,0]]},self.sendEvent({type:EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,value:data}))}function pinClicked(issueId){var i,length;for(i=0,length=self.issuesToShow.length;i<length;i+=1)if(self.issuesToShow[i]._id===issueId){selectedIssue=self.issuesToShow[i],setSelectedIssueIndex(selectedIssue),self.onEditIssue({issue:selectedIssue});break}}function setupIssuesToShow(){var sortedIssuesLength,i=0,j=0,length=0;if(self.issuesToShow=[],issuesToShowWithPinsIDs={},self.allIssues.length>0){for(self.issuesToShow=[self.allIssues[0]],i=1,length=self.allIssues.length;i<length;i+=1)for(j=0,sortedIssuesLength=self.issuesToShow.length;j<sortedIssuesLength;j+=1){if(self.allIssues[i].created>self.issuesToShow[j].created&&sortOldestFirst||self.allIssues[i].created<self.issuesToShow[j].created&&!sortOldestFirst){self.issuesToShow.splice(j,0,self.allIssues[i]);break}j===self.issuesToShow.length-1&&self.issuesToShow.push(self.allIssues[i])}if(angular.isDefined(self.filterText)&&""!==self.filterText){var stringSearch=function(superString,subString){return superString.toLowerCase().indexOf(subString.toLowerCase())!==-1};self.issuesToShow=$filter("filter")(self.issuesToShow,function(issue){var i,show=stringSearch(issue.title,self.filterText);if(show=show||stringSearch(issue.timeStamp,self.filterText),show=show||stringSearch(issue.owner,self.filterText),!show&&issue.hasOwnProperty("assigned_roles"))for(i=0;!show&&i<issue.assigned_roles.length;)show=show||stringSearch(issue.assigned_roles[i],self.filterText),i+=1;if(!show&&issue.hasOwnProperty("comments"))for(i=0;!show&&i<issue.comments.length;)show=show||stringSearch(issue.comments[i].comment,self.filterText),show=show||stringSearch(issue.comments[i].owner,self.filterText),i+=1;return show})}for(i=self.issuesToShow.length-1;i>=0;i-=1)showClosed||"closed"!==self.issuesToShow[i].status||self.issuesToShow.splice(i,1)}for(i=0,length=self.issuesToShow.length;i<length;i+=1)self.issuesToShow[i].position.length>0&&(issuesToShowWithPinsIDs[self.issuesToShow[i]._id]=!0);self.issuesToShow.length>0?(self.toShow="list",self.contentHeight({height:self.issuesToShow.length*issuesListItemHeight})):(self.toShow="info",self.info="No issues to show",self.contentHeight({height:infoHeight}))}function showPins(){var i,length,pin,pinData;for(i=0,length=self.allIssues.length;i<length;i+=1)self.allIssues[i].position.length>0&&(pin=angular.element(document.getElementById(self.allIssues[i]._id)),pin.length>0?issuesToShowWithPinsIDs[self.allIssues[i]._id]?pin[0].setAttribute("render","true"):pin[0].setAttribute("render","false"):(pinData={id:self.allIssues[i]._id,position:self.allIssues[i].position,norm:self.allIssues[i].norm,account:self.account,project:self.project},IssuesService.addPin(pinData,[[.78,0,0]],self.allIssues[i].viewpoint)))}var issuesToShowWithPinsIDs,self=this,selectedIssue=null,selectedIssueIndex=null,issuesListItemHeight=150,infoHeight=81,sortOldestFirst=!0,showClosed=!1,focusedIssueIndex=null;this.UtilsService=UtilsService,this.IssuesService=IssuesService,this.$onChanges=function(changes){var i,length,upArrow=38,downArrow=40,rightArrow=39,event={type:"click"},updatedIssue=IssuesService.updatedIssue;if(changes.hasOwnProperty("allIssues")&&this.allIssues)if(this.allIssues.length>0){for(self.toShow="list",setupIssuesToShow(),i=0,length=this.issuesToShow.length;i<length;i+=1)null!==updatedIssue&&updatedIssue._id===this.issuesToShow[i]._id&&(this.issuesToShow[i]=updatedIssue),this.issuesToShow[i].selected&&(selectedIssue=this.issuesToShow[i],focusedIssueIndex=i,setSelectedIssueIndex(selectedIssue));self.contentHeight({height:self.issuesToShow.length*issuesListItemHeight}),showPins()}else self.toShow="info",self.info="There are currently no open issues",self.contentHeight({height:infoHeight});if(changes.hasOwnProperty("filterText")&&"undefined"!=typeof this.filterText&&(setupIssuesToShow(),showPins()),changes.hasOwnProperty("keysDown")&&(changes.keysDown.currentValue.indexOf(downArrow)!==-1||changes.keysDown.currentValue.indexOf(upArrow)!==-1?(null!==focusedIssueIndex?changes.keysDown.currentValue.indexOf(downArrow)!==-1&&focusedIssueIndex!==this.issuesToShow.length-1?(null!==selectedIssue&&(selectedIssue.selected=!1,selectedIssue.focus=!1),this.issuesToShow[focusedIssueIndex].focus=!1,focusedIssueIndex+=1,selectedIssueIndex=focusedIssueIndex):changes.keysDown.currentValue.indexOf(upArrow)!==-1&&0!==focusedIssueIndex&&(null!==selectedIssue&&(selectedIssue.selected=!1,selectedIssue.focus=!1),this.issuesToShow[focusedIssueIndex].focus=!1,focusedIssueIndex-=1,selectedIssueIndex=focusedIssueIndex):null!==selectedIssueIndex&&(changes.keysDown.currentValue.indexOf(downArrow)!==-1&&selectedIssueIndex!==this.issuesToShow.length-1?(selectedIssue.selected=!1,selectedIssueIndex+=1):changes.keysDown.currentValue.indexOf(upArrow)!==-1&&0!==selectedIssueIndex&&(selectedIssue.selected=!1,selectedIssueIndex-=1),deselectPin(selectedIssue)),selectedIssue=this.issuesToShow[selectedIssueIndex],selectedIssue.selected=!0,selectedIssue.focus=!0,showIssue(selectedIssue),setSelectedIssueIndex(selectedIssue)):changes.keysDown.currentValue.indexOf(rightArrow)!==-1&&self.editIssue(selectedIssue)),changes.hasOwnProperty("nonListSelect")&&this.nonListSelect&&this.select(event,this.nonListSelect),changes.hasOwnProperty("event")&&this.event&&this.event.type===EventService.EVENT.VIEWER.CLICK_PIN&&pinClicked(this.event.value.id),changes.hasOwnProperty("menuOption")&&this.menuOption){if("sortByDate"===this.menuOption.value)sortOldestFirst=!sortOldestFirst;else if("showClosed"===this.menuOption.value)showClosed=!showClosed;else if("print"===this.menuOption.value)$window.open(serverConfig.apiUrl(serverConfig.GET_API,this.account+"/"+this.project+"/issues.html"),"_blank");else if("exportBCF"===this.menuOption.value)$window.open(serverConfig.apiUrl(serverConfig.GET_API,this.account+"/"+this.project+"/issues.bcfzip"),"_blank");else if("importBCF"===this.menuOption.value){var file=document.createElement("input");file.setAttribute("type","file"),file.setAttribute("accept",".zip,.bcfzip"),file.click(),file.addEventListener("change",function(){self.importBcf({file:file.files[0]})})}setupIssuesToShow(),self.contentHeight({height:self.issuesToShow.length*issuesListItemHeight}),showPins()}if(changes.hasOwnProperty("updatedIssue")&&this.updatedIssue)for(i=0,length=this.allIssues.length;i<length;i+=1)if(this.updatedIssue._id===this.allIssues[i]._id){this.allIssues[i]=this.updatedIssue;break}},this.select=function(event,issue){"click"===event.type&&(null===selectedIssue||selectedIssue._id===issue._id?(selectedIssue=issue,selectedIssue.selected=!0,selectedIssue.focus=!0,showIssue(selectedIssue),setSelectedIssueIndex(selectedIssue)):(selectedIssue.selected=!1,selectedIssue.focus=!1,deselectPin(selectedIssue),selectedIssue=issue,selectedIssue.selected=!0,selectedIssue.focus=!0,showIssue(selectedIssue),setSelectedIssueIndex(selectedIssue)))},this.setFocus=function(event,issue,index){null!==selectedIssue&&(selectedIssue.focus=!1),focusedIssueIndex=index,issue.focus=!0},this.removeFocus=function(event,issue){focusedIssueIndex=null,issue.focus=!1},this.editIssue=function(issue){this.onEditIssue({issue:issue})}}angular.module("3drepo").component("issuesList",{controller:IssuesListCtrl,templateUrl:"issuesList.html",bindings:{account:"<",project:"<",allIssues:"<",filterText:"<",sendEvent:"&",event:"<",onEditIssue:"&",nonListSelect:"<",keysDown:"<",contentHeight:"&",menuOption:"<",importBcf:"&"}}),IssuesListCtrl.$inject=["$filter","$window","UtilsService","IssuesService","EventService","serverConfig"]}(),function(){"use strict";function IssuesService($http,$q,serverConfig,EventService,UtilsService){function doPut(issue,data){var url,deferred=$q.defer();url=issue.rev_id?serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.project+"/revision/"+issue.rev_id+"/issues/"+issue._id+".json"):serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.project+"/issues/"+issue._id+".json");var config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}var i,url="",config={},j=0,numIssues=0,numComments=0,availableRoles=[],userRoles=[],obj={},newPinId="newPinId",updatedIssue=null;return obj.getPrettyTime=function(time){var prettyTime,postFix,hours,date=new Date(time),currentDate=new Date,monthToText=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return date.getFullYear()===currentDate.getFullYear()&&date.getMonth()===currentDate.getMonth()&&date.getDate()===currentDate.getDate()?(hours=date.getHours(),hours>11?(postFix=" PM",hours>12&&(hours-=12)):(postFix=" AM",0===hours&&(hours=12)),prettyTime=hours+":"+("0"+date.getMinutes()).slice(-2)+postFix):prettyTime=date.getFullYear()===currentDate.getFullYear()?date.getDate()+" "+monthToText[date.getMonth()]:monthToText[date.getMonth()]+" '"+date.getFullYear().toString().slice(-2),prettyTime},obj.generateTitle=function(issue){return issue.typePrefix?issue.typePrefix+"."+issue.number+" "+issue.name:issue.number+" "+issue.name},obj.getIssues=function(account,project,revision){var self=this,deferred=$q.defer();return url=revision?serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/revision/"+revision+"/issues.json"):serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/issues.json"),$http.get(url).then(function(data){for(console.log(data),deferred.resolve(data.data),i=0,numIssues=data.data.length;i<numIssues;i+=1)if(data.data[i].timeStamp=self.getPrettyTime(data.data[i].created),data.data[i].title=self.generateTitle(data.data[i]),data.data[i].hasOwnProperty("comments"))for(j=0,numComments=data.data[i].comments.length;j<numComments;j+=1)data.data[i].comments[j].hasOwnProperty("created")&&(data.data[i].comments[j].timeStamp=self.getPrettyTime(data.data[i].comments[j].created))},function(){deferred.resolve([])}),deferred.promise},obj.saveIssue=function(issue){var url,deferred=$q.defer();return url=issue.rev_id?serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.project+"/revision/"+issue.rev_id+"/issues.json"):serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.project+"/issues.json"),config={withCredentials:!0},null!==issue.pickedPos&&(issue.position=issue.pickedPos.toGL(),issue.norm=issue.pickedNorm.toGL()),$http.post(url,issue,config).then(function(response){deferred.resolve(response)}),deferred.promise},obj.updateIssue=function(issue,data){return doPut(issue,data)},obj.toggleCloseIssue=function(issue){var closed=!0;return issue.hasOwnProperty("closed")&&(closed=!issue.closed),doPut(issue,{closed:closed,number:issue.number})},obj.assignIssue=function(issue){return doPut(issue,{assigned_roles:issue.assigned_roles,number:issue.number})},obj.saveComment=function(issue,comment,viewpoint){return doPut(issue,{comment:comment,viewpoint:viewpoint})},obj.editComment=function(issue,comment,commentIndex){return doPut(issue,{comment:comment,number:issue.number,edit:!0,commentIndex:commentIndex})},obj.deleteComment=function(issue,index){return doPut(issue,{comment:"",number:issue.number,delete:!0,commentIndex:index})},obj.sealComment=function(issue,commentIndex){return doPut(issue,{comment:"",number:issue.number,sealed:!0,commentIndex:commentIndex})},obj.addPin=function(pin,colours,viewpoint){EventService.send(EventService.EVENT.VIEWER.ADD_PIN,{id:pin.id,account:pin.account,project:pin.project,position:pin.position,norm:pin.norm,colours:colours,viewpoint:viewpoint})},obj.removePin=function(id){EventService.send(EventService.EVENT.VIEWER.REMOVE_PIN,{id:id})},obj.fixPin=function(pin,colours){var self=this;self.removePin(),EventService.send(EventService.EVENT.VIEWER.ADD_PIN,{id:newPinId,position:pin.position,norm:pin.norm,colours:colours})},obj.getRoles=function(account,project){var deferred=$q.defer();return url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/roles.json"),$http.get(url).then(function(data){availableRoles=data.data,deferred.resolve(availableRoles)},function(){deferred.resolve([])}),deferred.promise},obj.getUserRolesForProject=function(account,project,username){var deferred=$q.defer();return url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/"+username+"/userRolesForProject.json"),$http.get(url).then(function(data){userRoles=data.data,deferred.resolve(userRoles)},function(){deferred.resolve([])}),deferred.promise},obj.hexToRgb=function(hex){if("undefined"!=typeof hex){var hexColours=[];return"#"===hex.charAt(0)&&(hex=hex.substr(1)),6===hex.length?(hexColours.push(hex.substr(0,2)),hexColours.push(hex.substr(2,2)),hexColours.push(hex.substr(4,2))):3===hex.length?(hexColours.push(hex.substr(0,1)+hex.substr(0,1)),hexColours.push(hex.substr(1,1)+hex.substr(1,1)),hexColours.push(hex.substr(2,1)+hex.substr(2,1))):hexColours=["00","00","00"],[parseInt(hexColours[0],16)/255,parseInt(hexColours[1],16)/255,parseInt(hexColours[2],16)/255]}},obj.getRoleColor=function(role){var roleColor,i=0,length=0;if(availableRoles.length>0)for(i=0,length=availableRoles.length;i<length;i+=1)if(availableRoles[i].role===role){roleColor=availableRoles[i].color;break}return roleColor},obj.getStatusIcon=function(issue){var statusIcon={};if("closed"===issue.status)statusIcon.icon="check_circle",statusIcon.colour="#004594";else switch(statusIcon.icon="open"===issue.status?"panorama_fish_eye":"lens",issue.priority){case"none":statusIcon.colour="#7777777";break;case"low":statusIcon.colour="#4CAF50";break;case"medium":statusIcon.colour="#FF9800";
break;case"high":statusIcon.colour="#F44336"}return statusIcon},obj.importBcf=function(account,project,file){var deferred=$q.defer(),formData=new FormData;return formData.append("file",file),UtilsService.doPost(formData,account+"/"+project+"/issues.bcfzip",{"Content-Type":void 0}).then(function(res){console.log(res),200===res.status?deferred.resolve():deferred.reject(res.data)}),deferred.promise},Object.defineProperty(obj,"newPinId",{get:function(){return newPinId}}),Object.defineProperty(obj,"updatedIssue",{get:function(){var tmpUpdatedIssue;return null===updatedIssue?null:(tmpUpdatedIssue=updatedIssue,updatedIssue=null,tmpUpdatedIssue)},set:function(issue){updatedIssue=issue}}),obj}angular.module("3drepo").factory("IssuesService",IssuesService),IssuesService.$inject=["$http","$q","serverConfig","EventService","UtilsService"]}(),function(){"use strict";function login(){return{restrict:"EA",templateUrl:"login.html",scope:{},controller:LoginCtrl,controllerAs:"vm",bindToController:!0}}function LoginCtrl($scope,Auth,EventService,serverConfig){var vm=this,enterKey=13;vm.version=serverConfig.apiVersion,vm.login=function(event){angular.isDefined(event)?event.which===enterKey&&Auth.login(vm.user.username,vm.user.password):Auth.login(vm.user.username,vm.user.password)},$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.USER_LOGGED_IN&&(console.log(666,event),event.value.hasOwnProperty("error")&&event.value.error.place.indexOf("POST")!==-1&&(500===event.value.error.status?vm.errorMessage="There is currently a problem with the system. Please try again later.":61===event.value.error.value?vm.errorMessage="Please click on the link in the verify email sent to your account":vm.errorMessage=event.value.error.message))})}angular.module("3drepo").directive("login",login),LoginCtrl.$inject=["$scope","Auth","EventService","serverConfig"]}(),function(){"use strict";function measure(){return{restrict:"EA",templateUrl:"measure.html",scope:{account:"=",project:"=",settings:"="},controller:MeasureCtrl,controllerAs:"vm",bindToController:!0}}function MeasureCtrl($scope,$element,EventService,ProjectService){var currentPickPoint,vm=this,coords=[null,null];vm.axisDistance=[0,0,0],vm.totalDistance=0,vm.show=!1,vm.distance=!1,vm.allowMove=!1,vm.units=server_config.units;var coordVector=null;vm.screenPos=[0,0],vm.unit=vm.settings.unit,EventService.send(EventService.EVENT.VIEWER.REGISTER_MOUSE_MOVE_CALLBACK,{callback:function(event){var point=event.hitPnt;vm.screenPos=[event.layerX,event.layerY],vm.allowMove&&(point?(coords[1]=new x3dom.fields.SFVec3f(point[0],point[1],point[2]),coordVector=coords[0].subtract(coords[1]),vm.axisDistance[0]=Math.abs(coordVector.x).toFixed(3),vm.axisDistance[1]=Math.abs(coordVector.y).toFixed(3),vm.axisDistance[2]=Math.abs(coordVector.z).toFixed(3),vm.totalDistance=coordVector.length().toFixed(3),angular.element($element[0]).css("left",(vm.screenPos[0]+5).toString()+"px"),angular.element($element[0]).css("top",(vm.screenPos[1]+5).toString()+"px"),$scope.$apply(),vm.show=!0):vm.show=!1)}}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.PICK_POINT&&event.value.hasOwnProperty("position")&&(currentPickPoint=event.value.position,null===coords[1]||null===coords[0]?(vm.show=!0,vm.allowMove=!0,coords[0]=currentPickPoint):vm.allowMove?(vm.show=!0,vm.allowMove=!1):(coords[0]=currentPickPoint,coords[1]=null,vm.allowMove=!0))})}angular.module("3drepo").directive("tdrMeasure",measure),MeasureCtrl.$inject=["$scope","$element","EventService","ProjectService"]}();var Oculus={};!function(){"use strict";Oculus=function(viewer){var self=this;this.leftTex=null,this.rightTex=null,this.lastW=null,this.lastH=null,this.vrHMD=null,this.vrSensor=null,this.IPD=.01,this.enabled=!1,this.oculus=null,this.viewer=viewer,this.addInstructions=function(){var instruction=document.createElement("div");instruction.setAttribute("id","instructionCircle"),self.viewer.element.appendChild(instruction),instruction.addEventListener("click",function(){self.viewer.switchFullScreen(self.vrHMD),instruction.style.display="none"});var instructionImage=document.createElement("img");instructionImage.setAttribute("id","instructionImage"),instructionImage.setAttribute("src","public/plugins/walkthroughVr/instruction_trans.gif"),instruction.appendChild(instructionImage);var instructionOK=document.createElement("div");instructionOK.setAttribute("id","instructionOK"),instructionOK.textContent="OK",instruction.appendChild(instructionOK)},this.switchVR=function(){var scene=self.viewer.scene;if(this.enabled)this.oculus.parentNode.removeChild(this.oculus),this.leftTex=null,this.rightTex=null,this.lastW=null,this.lastH=null,this.IPD=.0064,this.enabled=!1,this.oculus=null,this.enabled=!1,self.viewer.runtime.enterFrame=function(){},self.viewer.runtime.exitFrame=function(){},self.viewer.getViewArea().skipSceneRender=null,self.viewer.nav.setAttribute("type",self.oldNavMode),self.oldNavMode=null,self.viewer.getScene()._x3domNode._nameSpace.doc.canvas.isMulti=!1,self.viewer.createBackground(),self.viewer.setNavMode(this.oldNavMode),self.viewer.addLogo();else{self.addInstructions();var eyeGroup=document.createElement("group");eyeGroup.setAttribute("def","oculus"),eyeGroup.setAttribute("render","false"),this.oculus=eyeGroup;var leftEye=document.createElement("group");leftEye.setAttribute("def","left"),eyeGroup.appendChild(leftEye);var leftShape=document.createElement("shape");leftShape.setAttribute("isPickable","false"),leftEye.appendChild(leftShape);var leftApp=document.createElement("appearance");leftShape.appendChild(leftApp),self.leftTex=document.createElement("renderedtexture"),self.leftTex.setAttribute("id","rtLeft"),self.leftTex.setAttribute("stereoMode","LEFT_EYE"),self.leftTex.setAttribute("update","ALWAYS"),self.leftTex.setAttribute("oculusRiftVersion","2"),self.leftTex.setAttribute("repeatS","false"),self.leftTex.setAttribute("repeatT","false"),self.leftTex.setAttribute("interpupillaryDistance",this.IPD),leftApp.appendChild(self.leftTex);var leftVP=document.createElement("viewpoint");null!==self.viewer.getCurrentViewpoint()&&leftVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),leftVP.setAttribute("containerfield","viewpoint"),leftVP.textContent=" ",self.leftTex.appendChild(leftVP);var leftBground=document.createElement("background");leftBground.setAttribute("use","viewer_bground"),leftBground.setAttribute("containerfield","background"),leftBground.textContent=" ",self.leftTex.appendChild(leftBground);var leftScene=document.createElement("group");leftScene.setAttribute("USE","root"),leftScene.setAttribute("containerfield","scene"),self.leftTex.appendChild(leftScene);var leftPlane=document.createElement("plane");leftPlane.setAttribute("solid","false"),leftShape.appendChild(leftPlane);var rightEye=document.createElement("group");rightEye.setAttribute("def","right"),eyeGroup.appendChild(rightEye);var rightShape=document.createElement("shape");rightShape.setAttribute("isPickable","false"),rightEye.appendChild(rightShape);var rightApp=document.createElement("appearance");rightShape.appendChild(rightApp),self.rightTex=document.createElement("renderedtexture"),self.rightTex.setAttribute("id","rtRight"),self.rightTex.setAttribute("stereoMode","RIGHT_EYE"),self.rightTex.setAttribute("update","ALWAYS"),self.rightTex.setAttribute("oculusRiftVersion","2"),self.rightTex.setAttribute("repeatS","false"),self.rightTex.setAttribute("repeatT","false"),self.rightTex.setAttribute("interpupillaryDistance",this.IPD),rightApp.appendChild(self.rightTex);var rightPlane=document.createElement("plane");rightPlane.setAttribute("solid","false"),rightShape.appendChild(rightPlane);var rightVP=document.createElement("viewpoint");null!==self.viewer.getCurrentViewpoint()&&rightVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),rightVP.setAttribute("containerfield","viewpoint"),rightVP.textContent=" ",self.rightTex.appendChild(rightVP);var rightBground=document.createElement("background");rightBground.setAttribute("use","viewer_bground"),rightBground.setAttribute("containerfield","background"),rightBground.textContent=" ",self.rightTex.appendChild(rightBground);var rightScene=document.createElement("group");rightScene.setAttribute("use","root"),rightScene.setAttribute("containerfield","scene"),rightScene.textContent=" ",self.rightTex.appendChild(rightScene),scene.appendChild(eyeGroup),leftShape._x3domNode._graph.needCulling=!1,rightShape._x3domNode._graph.needCulling=!1,eyeGroup._x3domNode._graph.needCulling=!1,self.startVR(),self.oldNavMode=self.viewer.nav.getAttribute("type"),self.viewer.nav.setAttribute("type","EXAMINE"),self.viewer.getScene()._x3domNode._nameSpace.doc.canvas.isMulti=!0,this.oldNavMode=self.viewer.currentNavMode,self.viewer.setNavMode(self.viewer.NAV_MODES.FLY),this.enabled=!0,self.viewer.removeLogo()}},this.startVR=function(){self.lastW=self.viewer.runtime.getWidth(),self.lastH=self.viewer.runtime.getHeight(),self.viewpoint=self.viewer.viewpoint,self.viewer.getViewArea().skipSceneRender=!0,self.gyroOrientation=null,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(event){self.gyroOrientation=event},!1),self.viewer.runtime.enterFrame=function(){if(self.gyroOrientation)self.viewer.gyroscope(self.gyroOrientation.alpha,self.gyroOrientation.beta,self.gyroOrientation.gamma),self.gyroOrientation=null;else if(self.vrSensor){var state=self.vrSensor.getState(),h=state.orientation;if(h){var vp=self.viewer.getCurrentViewpoint()._x3domNode,flyMat=vp.getViewMatrix().inverse(),q=new x3dom.fields.Quaternion(h.x,h.y,h.z,h.w);flyMat.setRotate(q),vp.setView(flyMat.inverse())}}},self.viewer.runtime.exitFrame=function(){var w=self.viewer.runtime.getWidth()*(window.devicePixelRatio?window.devicePixelRatio:1),h=self.viewer.runtime.getHeight()*(window.devicePixelRatio?window.devicePixelRatio:1),rotate=h>w;if(rotate?(self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,h/2,w,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.leftTex._x3domNode._webgl.fbo.tex),self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,0,w,h/2),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rightTex._x3domNode._webgl.fbo.tex)):(self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.leftTex._x3domNode._webgl.fbo.tex),self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(w/2,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rightTex._x3domNode._webgl.fbo.tex)),w!==self.lastW||h!==self.lastH){var half=0;half=Math.round(w/2),self.leftTex.setAttribute("dimensions",half+" "+h+" 4"),self.rightTex.setAttribute("dimensions",half+" "+h+" 4"),self.lastW=w,self.lastH=h}self.viewer.runtime.triggerRedraw()}},this.changeIPD=function(newIPD){self.leftTex.setAttribute("interpupillaryDistance",newIPD),self.rightTex.setAttribute("interpupillaryDistance",newIPD)},this.peturbIPD=function(peturbation){var oldDistance=parseFloat(self.leftTex.getAttribute("interpupillaryDistance"));this.changeIPD(oldDistance+peturbation)},this.exitFullscreen=function(){},this.createFullscreenExit=function(){document.addEventListener("webkitfullscreenchange",self.exitFullscreen,!1),document.addEventListener("mozfullscreenchange",self.exitFullscreen,!1),document.addEventListener("fullscreenchange",self.exitFullscreen,!1),document.addEventListener("MSFullscreenChange",self.exitFullscreen,!1)},this.init=function(vrdevs){var i;for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof HMDVRDevice){self.vrHMD=vrdevs[i];break}if(self.vrHMD){for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof PositionSensorVRDevice&&vrdevs[i].hardwareUnitId===self.vrHMD.hardwareUnitId){self.vrSensor=vrdevs[i];break}return self.vrHMD&&self.vrSensor?void 0:void console.error("No HMD found")}},navigator.getVRDevices&&navigator.getVRDevices().then(this.init),this.createFullscreenExit()}}(),function(){"use strict";function panelCardAdd(){return{restrict:"EA",templateUrl:"panelCardAdd.html",scope:{showAdd:"="},controller:PanelCardAddCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardAddCtrl(){var vm=this;vm.add=function(){vm.showAdd=!0}}angular.module("3drepo").directive("panelCardAdd",panelCardAdd),PanelCardAddCtrl.$inject=[]}(),function(){"use strict";function panelCard(){return{restrict:"E",templateUrl:"panelCard.html",scope:{account:"=",project:"=",branch:"=",revision:"=",position:"=",contentData:"=",onHeightRequest:"&",onShowFilter:"&",keysDown:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:PanelCardCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardCtrl($scope,$element,$compile,EventService){function createCardContent(){var i,length,contentItem,element,content=angular.element($element[0].querySelector("#content"));if(element="<"+vm.contentData.type+" show='vm.contentData.show' on-content-height-request='vm.onContentHeightRequest(height)' on-show-item='vm.showItem()' hide-item='vm.hideSelectedItem' show-edit='vm.showEdit' account='vm.account' project='vm.project' branch='vm.branch' revision='vm.revision' keys-down='vm.keysDown' selected-objects='vm.selectedObjects' set-initial-selected-objects='vm.setInitialSelectedObjects({selectedObjects: selectedObjects})'",vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)switch(vm.contentData.options[i].type){case"filter":element+="filter-text='vm.filterText' ";break;case"visible":element+="visible='vm.visible' ";break;case"menu":element+="selected-menu-option='vm.selectedMenuOption' "}vm.contentData.hasOwnProperty("add")&&vm.contentData.add&&(element+="show-add='vm.showAdd' can-add='vm.canAdd'"),element+="></"+vm.contentData.type+">",contentItem=angular.element(element),content.append(contentItem),$compile(contentItem)($scope)}function createToolbarOptions(){var i,length,option,optionElement;if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1){switch(option=null,optionElement="<panel-card-option-"+vm.contentData.options[i].type,optionElement+=" id='panal_card_option_"+vm.contentData.options[i].type+"'",optionElement+=" ng-if='vm.contentData.options["+i+"].visible'",vm.contentData.options[i].color="",optionElement+=" style='color:{{vm.contentData.options["+i+"].color}}'",vm.contentData.options[i].type){case"filter":optionElement+=" show-filter='vm.showFilter'";break;case"visible":optionElement+=" visible='vm.visible'";break;case"menu":optionElement+="menu='vm.contentData.menu' selected-menu-option='vm.selectedMenuOption'";break;case"close":optionElement+="show='vm.contentData.show'"}optionElement+="><panel-card-option-"+vm.contentData.options[i].type+">",option=angular.element(optionElement),null!==option&&(options.prepend(option),$compile(option)($scope))}}function showToolbarOptions(addOptions,show){var i,length;for(i=0,length=vm.contentData.options.length;i<length;i+=1)addOptions.indexOf(vm.contentData.options[i].type)!==-1&&(vm.contentData.options[i].visible=show)}function createFilter(){var i,length,filter,filterContainer=angular.element($element[0].querySelector("#filterContainer"));if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)if("filter"===vm.contentData.options[i].type){filter=angular.element("<panel-card-filter show-filter='vm.showFilter' filter-text='vm.filterText'></panel-card-filter>"),filterContainer.append(filter),$compile(filter)($scope);break}}function toggleAdd(on){on?("issues"===vm.contentData.type&&showToolbarOptions(["filter","menu"],!1),EventService.send(EventService.EVENT.PANEL_CARD_ADD_MODE,{on:!0,type:vm.contentData.type})):("issues"===vm.contentData.type&&showToolbarOptions(["filter","menu"],!0),EventService.send(EventService.EVENT.PANEL_CARD_ADD_MODE,{on:!1}))}function highlightOption(option){var i,length;if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)if(vm.contentData.options[i].type===option){currentHighlightedOptionIndex!==-1&&currentHighlightedOptionIndex!==i?(vm.contentData.options[currentHighlightedOptionIndex].color="",currentHighlightedOptionIndex=i,vm.contentData.options[i].color="#FF9800"):(currentHighlightedOptionIndex=i,vm.contentData.options[i].color="#FF9800");break}}var contentHeight,vm=this,options=angular.element($element[0].querySelector("#options")),currentHighlightedOptionIndex=-1;vm.showHelp=!1,vm.showFilter=!1,vm.visibleStatus=!1,vm.showClearFilterButton=!1,vm.showAdd=!1,$scope.$watch("vm.contentData.type",function(newValue){angular.isDefined(newValue)&&(createCardContent(),createToolbarOptions(),createFilter(),vm.statusIcon=vm.contentData.icon)}),$scope.$watch("vm.contentData.show",function(newValue){angular.isDefined(newValue)&&!newValue&&vm.hideItem()}),$scope.$watch("vm.showAdd",function(newValue){angular.isDefined(newValue)&&toggleAdd(newValue)}),$scope.$watch("vm.showEdit",function(newValue){angular.isDefined(newValue)&&EventService.send(EventService.EVENT.PANEL_CARD_EDIT_MODE,{on:newValue,type:vm.contentData.type})}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.TOGGLE_ISSUE_ADD&&"issues"===vm.contentData.type?(toggleAdd(event.value.on),event.value.on||(vm.contentData.options[currentHighlightedOptionIndex].color="",currentHighlightedOptionIndex=-1)):event.type===EventService.EVENT.PANEL_CARD_ADD_MODE||event.type===EventService.EVENT.PANEL_CARD_EDIT_MODE?event.value.on&&event.value.type!==vm.contentData.type&&vm.hideItem():event.type===EventService.EVENT.SET_ISSUE_AREA_MODE&&"issues"===vm.contentData.type&&highlightOption(event.value)}),$scope.$watch("vm.hideSelectedItem",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.statusIcon=vm.contentData.icon)}),vm.onContentHeightRequest=function(height){contentHeight=height,vm.onHeightRequest({contentItem:vm.contentData,height:contentHeight})},vm.showItem=function(){vm.statusIcon="arrow_back",vm.hideSelectedItem=!1},vm.hideItem=function(){vm.statusIcon=vm.contentData.icon,vm.hideSelectedItem=!0}}angular.module("3drepo").directive("panelCard",panelCard),PanelCardCtrl.$inject=["$scope","$element","$compile","EventService"]}(),function(){"use strict";function panelCardFilter(){return{restrict:"E",templateUrl:"panelCardFilter.html",scope:{showFilter:"=",filterText:"="},controller:PanelCardFilterCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardFilterCtrl($scope,$timeout,$element){var filterInput,vm=this,filterTimeout=null;vm.clearFilter=function(){vm.filterInputText="",filterInput.focus()},$scope.$watch("vm.filterInputText",function(newValue){angular.isDefined(newValue)&&(null!==filterTimeout&&$timeout.cancel(filterTimeout),filterTimeout=$timeout(function(){vm.filterText=vm.filterInputText,vm.showClearFilterButton=""!==vm.filterInputText},500))}),$scope.$watch("vm.showFilter",function(newValue){angular.isDefined(newValue)&&newValue&&$timeout(function(){filterInput=angular.element($element[0].querySelector("#panelCardFilterInput")),filterInput.focus()})})}angular.module("3drepo").directive("panelCardFilter",panelCardFilter),PanelCardFilterCtrl.$inject=["$scope","$timeout","$element"]}(),function(){"use strict";function panelCardOptionAdd(){return{restrict:"E",templateUrl:"panelCardOptionAdd.html",scope:{showAdd:"="},controller:PanelCardOptionAddCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionAddCtrl(){var vm=this;vm.showAddElement=function(event){event.stopPropagation(),vm.showAdd=!0}}angular.module("3drepo").directive("panelCardOptionAdd",panelCardOptionAdd)}(),function(){"use strict";function panelCardOptionClose(){return{restrict:"E",templateUrl:"panelCardOptionClose.html",scope:{show:"="},controller:panelCardOptionCloseCtrl,controllerAs:"vm",bindToController:!0}}function panelCardOptionCloseCtrl(){var vm=this;vm.hide=function(){vm.show=!1}}angular.module("3drepo").directive("panelCardOptionClose",panelCardOptionClose)}(),function(){"use strict";function panelCardOptionErase(){return{restrict:"E",templateUrl:"panelCardOptionErase.html",scope:{},controller:PanelCardOptionEraseCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionEraseCtrl(EventService){var vm=this;vm.setupEraseMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"erase")}}angular.module("3drepo").directive("panelCardOptionErase",panelCardOptionErase),PanelCardOptionEraseCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionFilter(){return{restrict:"E",templateUrl:"panelCardOptionFilter.html",scope:{showFilter:"="},controller:PanelCardOptionFilterCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionFilterCtrl(){var vm=this;vm.toggleFilter=function(event){event.stopPropagation(),vm.showFilter=!vm.showFilter}}angular.module("3drepo").directive("panelCardOptionFilter",panelCardOptionFilter)}(),function(){"use strict";function panelCardOptionMenu(){return{restrict:"E",templateUrl:"panelCardOptionMenu.html",scope:{menu:"=",selectedMenuOption:"="},controller:PanelCardOptionMenuCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionMenuCtrl($timeout){var currentSortIndex,vm=this;vm.menuItemSelected=function(index){vm.menu[index].hasOwnProperty("toggle")?vm.menu[index].toggle?(vm.menu[index].selected=!vm.menu[index].selected,vm.selectedMenuOption=vm.menu[index]):(index!==currentSortIndex?(angular.isDefined(currentSortIndex)&&(vm.menu[currentSortIndex].selected=!1,vm.menu[currentSortIndex].firstSelected=!1,vm.menu[currentSortIndex].secondSelected=!1),currentSortIndex=index,vm.menu[currentSortIndex].selected=!0,vm.menu[currentSortIndex].firstSelected=!0):(vm.menu[currentSortIndex].firstSelected=!vm.menu[currentSortIndex].firstSelected,vm.menu[currentSortIndex].secondSelected=!vm.menu[currentSortIndex].secondSelected),vm.selectedMenuOption=vm.menu[currentSortIndex]):vm.selectedMenuOption=vm.menu[index],$timeout(function(){vm.selectedMenuOption=void 0})}}angular.module("3drepo").directive("panelCardOptionMenu",panelCardOptionMenu),PanelCardOptionMenuCtrl.$inject=["$timeout"]}(),function(){"use strict";function panelCardOptionPin(){return{restrict:"E",templateUrl:"panelCardOptionPin.html",scope:{},controller:PanelCardOptionPinCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionPinCtrl(EventService){var vm=this;vm.setupPinMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"pin")}}angular.module("3drepo").directive("panelCardOptionPin",panelCardOptionPin),PanelCardOptionPinCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionPrint(){return{restrict:"E",templateUrl:"panelCardOptionPrint.html",scope:{account:"=",project:"="},controller:PanelCardOptionPrintCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionPrintCtrl($window,serverConfig){var vm=this;vm.doPrint=function(event){event.stopPropagation(),$window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/"+vm.project+"/issues.html"),"_blank")}}angular.module("3drepo").directive("panelCardOptionPrint",panelCardOptionPrint),PanelCardOptionPrintCtrl.$inject=["$window","serverConfig"]}(),function(){"use strict";function panelCardOptionScribble(){return{restrict:"E",templateUrl:"panelCardOptionScribble.html",scope:{},controller:PanelCardOptionScribbleCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionScribbleCtrl(EventService){var vm=this;vm.setupScribbleMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"scribble")}}angular.module("3drepo").directive("panelCardOptionScribble",panelCardOptionScribble),PanelCardOptionScribbleCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionVisible(){return{restrict:"E",templateUrl:"panelCardOptionVisible.html",scope:{visible:"="},controller:PanelCardOptionVisibleCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionVisibleCtrl(){var vm=this;vm.icon="visibility",vm.toggleVisible=function(event){event.stopPropagation(),vm.visible=!vm.visible,vm.icon=vm.visible?"visibility":"visibility_off"}}angular.module("3drepo").directive("panelCardOptionVisible",panelCardOptionVisible)}(),function(){"use strict";function panel(){return{restrict:"E",templateUrl:"panel.html",scope:{account:"=",project:"=",branch:"=",revision:"=",position:"@",keysDown:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:PanelCtrl,controllerAs:"vm",bindToController:!0}}function PanelCtrl($scope,$window,$timeout,EventService){function hideLastItemGap(){var i,lastFound=!1;for(i=vm.contentItems.length-1;i>=0;i-=1)vm.contentItems[i].show&&(lastFound?vm.contentItems[i].showGap=!0:(vm.contentItems[i].showGap=!1,lastFound=!0))}function calculateContentHeights(){var tempContentItemsShown=angular.copy(contentItemsShown);assignHeights(maxHeightAvailable,tempContentItemsShown,null),$timeout(function(){$scope.$apply()})}function assignHeights(heightAvailable,contentItems,previousContentItems){var i,contentItem,availableHeight=heightAvailable,maxContentItemHeight=(availableHeight-panelToolbarHeight*contentItems.length-itemGap*(contentItems.length-1))/contentItems.length,prev=null;if(Array.isArray(previousContentItems)&&previousContentItems.length===contentItems.length)for(i=contentItems.length-1;i>=0;i-=1)contentItem=getContentItemShownFromType(contentItems[i].type),maxContentItemHeight<contentItem.minHeight?contentItem.requestedHeight<contentItem.minHeight?contentItem.height=contentItem.requestedHeight:(contentItem.height=contentItem.minHeight,availableHeight-=contentItem.height+panelToolbarHeight+itemGap,contentItems.splice(i,1),assignHeights(availableHeight,contentItems,prev)):contentItem.height=maxContentItemHeight;else{for(prev=angular.copy(contentItems),i=contentItems.length-1;i>=0;i-=1)(contentItems[i].requestedHeight<maxContentItemHeight||contentItems[i].fixedHeight)&&(contentItem=getContentItemShownFromType(contentItems[i].type),contentItem.height=contentItems[i].requestedHeight,availableHeight-=contentItem.height+panelToolbarHeight+itemGap,contentItems.splice(i,1));contentItems.length>0&&assignHeights(availableHeight,contentItems,prev)}}function getContentItemShownFromType(type){var i,length;for(i=0,length=contentItemsShown.length;i<length;i+=1)if(contentItemsShown[i].type===type)return contentItemsShown[i]}function setupShownCards(){var i,length;for(contentItemsShown=[],i=0,length=vm.contentItems.length;i<length;i+=1)vm.contentItems[i].show&&contentItemsShown.push(vm.contentItems[i])}function setupContentItemsWatch(){var i,length;$scope.$watch("vm.contentItems",function(newValue,oldValue){for(i=0,length=newValue.length;i<length;i+=1)if(newValue[i].show!==oldValue[i].show){setupShownCards(),hideLastItemGap();break}},!0)}var vm=this,panelTopBottomGap=55,maxHeightAvailable=$window.innerHeight-panelTopBottomGap,itemGap=20,panelToolbarHeight=40,contentItemsShown=[];vm.contentItems=[],vm.showPanel=!0,vm.window=$window,vm.activate=!0,$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.PANEL_CONTENT_SETUP?(vm.contentItems=event.value[vm.position],setupShownCards(),hideLastItemGap(),setupContentItemsWatch()):event.type===EventService.EVENT.TOGGLE_ELEMENTS&&(vm.showPanel=!vm.showPanel)}),angular.element(document).bind("mousedown",function(event){"CANVAS"===event.target.tagName&&(vm.activate=!1,$scope.$apply())}),angular.element(document).bind("mouseup",function(){vm.activate=!0,$scope.$apply()}),vm.buttonClick=function(contentType){var i,j,length,contentItem;for(i=0,length=vm.contentItems.length;i<length;i+=1)if(contentType===vm.contentItems[i].type){if(contentItem=vm.contentItems[i],vm.contentItems[i].show=!vm.contentItems[i].show,vm.contentItems[i].show)contentItemsShown.push(vm.contentItems[i]),calculateContentHeights();else{for(j=contentItemsShown.length-1;j>=0;j-=1)contentItemsShown[j].type===contentType&&contentItemsShown.splice(j,1);vm.contentItems[i].showGap=!1,calculateContentHeights()}break}hideLastItemGap()},vm.heightRequest=function(contentItem,height){contentItem.requestedHeight=height,contentItem.height=height,calculateContentHeights()},angular.element($window).bind("resize",function(){maxHeightAvailable=$window.innerHeight-panelTopBottomGap,calculateContentHeights()})}angular.module("3drepo").directive("panel",panel),PanelCtrl.$inject=["$scope","$window","$timeout","EventService"]}(),function(){"use strict";function passwordChange(){return{restrict:"E",scope:{username:"=",token:"="},templateUrl:"passwordChange.html",controller:PasswordChangeCtrl,controllerAs:"vm",bindToController:!0}}function PasswordChangeCtrl($scope,UtilsService,EventService){function doPasswordChange(){angular.isDefined(vm.username)&&angular.isDefined(vm.token)&&(angular.isDefined(vm.newPassword)&&""!==vm.newPassword?(vm.messageColor=messageColour,vm.message="Please wait...",vm.showProgress=!0,promise=UtilsService.doPut({token:vm.token,newPassword:vm.newPassword},vm.username+"/password"),promise.then(function(response){vm.showProgress=!1,400===response.status?(vm.messageColor=messageErrorColour,vm.message="Error changing password"):(vm.passwordChanged=!0,vm.messageColor=messageColour,vm.message="Your password has been reset. Please go to the login page.")})):(vm.messageColor=messageErrorColour,vm.message="A new password must be entered"))}var promise,vm=this,enterKey=13,messageColour="rgba(0, 0, 0, 0.7)",messageErrorColour="#F44336";vm.passwordChanged=!1,vm.showProgress=!1,$scope.$watch("vm.newPassword",function(){vm.message=""}),vm.passwordChange=function(event){angular.isDefined(event)?event.which===enterKey&&doPasswordChange():doPasswordChange()},vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("passwordChange",passwordChange),PasswordChangeCtrl.$inject=["$scope","UtilsService","EventService"]}(),function(){"use strict";function passwordForgot(){return{restrict:"E",scope:{},templateUrl:"passwordForgot.html",controller:PasswordForgotCtrl,controllerAs:"vm",bindToController:!0}}function PasswordForgotCtrl($scope,UtilsService){var promise,vm=this,messageColour="rgba(0, 0, 0, 0.7)",messageErrorColour="#F44336";vm.showProgress=!1,$scope.$watchGroup(["vm.username","vm.email"],function(){vm.message=""}),vm.requestPasswordChange=function(event){var enterKey=13,requestChange=!1;requestChange=!angular.isDefined(event)||event.which===enterKey,requestChange&&(angular.isDefined(vm.username)&&angular.isDefined(vm.email)?(vm.messageColor=messageColour,vm.message="Please wait...",vm.showProgress=!0,promise=UtilsService.doPost({email:vm.email},vm.username+"/forgot-password"),promise.then(function(response){vm.showProgress=!1,200===response.status?(vm.verified=!0,vm.messageColor=messageColour,vm.message="Thank you. You will receive an email shortly with a link to change your password"):(vm.messageColor=messageErrorColour,vm.message="Error with with one or more fields")})):(vm.messageColor=messageErrorColour,vm.message="All fields must be filled"))}}angular.module("3drepo").directive("passwordForgot",passwordForgot),PasswordForgotCtrl.$inject=["$scope","UtilsService"]}(),function(){"use strict";function payment(){return{restrict:"E",scope:{},templateUrl:"payment.html",controller:paymentCtrl,controllerAs:"vm",bindToController:!0}}function paymentCtrl(EventService){var vm=this;vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("payment",payment),paymentCtrl.$inject=["EventService"]}(),function(){"use strict";function pricing(){return{restrict:"E",scope:{},templateUrl:"pricing.html",controller:PricingCtrl,controllerAs:"vm",
bindToController:!0}}function PricingCtrl($location){var vm=this;vm.showPage=function(page){$location.path("/"+page,"_self")}}angular.module("3drepo").directive("pricing",pricing),PricingCtrl.$inject=["$location"]}(),function(){"use strict";function privacy(){return{restrict:"E",scope:{},templateUrl:"privacy.html",controller:PrivacyCtrl,controllerAs:"vm",bindToController:!0}}function PrivacyCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("privacy",privacy),PrivacyCtrl.$inject=["EventService"]}(),function(){"use strict";function EventService($timeout){var EVENT={AUTO_META_DATA:"EVENT_AUTO_META_DATA",FILTER:"EVENT_FILTER",FULL_SCREEN_ENTER:"EVENT_FULL_SCREEN_ENTER",GET_ISSUE_AREA_PNG:"EVENT_GET_ISSUE_AREA_PNG",GLOBAL_CLICK:"EVENT_GLOBAL_CLICK",ISSUE_AREA_PNG:"EVENT_ISSUE_AREA_PNG",MEASURE_MODE:"EVENT_MEASURE_MODE",MULTI_SELECT_MODE:"EVENT_MULTI_SELECT_MODE",OBJECT_SELECTED:"EVENT_OBJECT_SELECTED",PIN_DROP_MODE:"EVENT_PIN_DROP_MODE",PIN_SELECTED:"EVENT_PIN_SELECTED",PANEL_CONTENT_CLICK:"EVENT_LEFT_PANEL_CONTENT_CLICK",PANEL_CARD_ADD_MODE:"EVENT_PANEL_CARD_ADD_MODE",PANEL_CARD_EDIT_MODE:"EVENT_PANEL_CARD_EDIT_MODE",PANEL_CONTENT_SETUP:"EVENT_PANEL_CONTENT_SETUP",PANEL_CONTENT_TOGGLED:"EVENT_PANEL_CONTENT_TOGGLED",SET_CLIPPING_PLANES:"EVENT_SET_CLIPPING_PLANES",SET_ISSUE_AREA_MODE:"EVENT_SET_ISSUE_AREA_MODE",SHOW_PROJECTS:"EVENT_SHOW_PROJECTS",SHOW_QR_CODE_READER:"EVENT_SHOW_QR_CODE_READER",TOGGLE_ELEMENTS:"EVENT_TOGGLE_ELEMENTS",TOGGLE_HELP:"EVENT_TOGGLE_HELP",TOGGLE_ISSUE_ADD:"EVENT_TOGGLE_ISSUE_ADD",TOGGLE_ISSUE_AREA:"EVENT_TOGGLE_ISSUE_AREA",TOGGLE_ISSUE_AREA_DRAWING:"EVENT_TOGGLE_ISSUE_AREA_DRAWING",WINDOW_HEIGHT_CHANGE:"EVENT_WINDOW_HEIGHT_CHANGE",CREATE_VIEWER:"EVENT_CREATE_VIEWER",CLOSE_VIEWER:"EVENT_CLOSE_VIEWER",VIEWER:VIEWER_EVENTS,PROJECT_SETTINGS_READY:"EVENT_PROJECT_SETTINGS_READY",USER_LOGGED_IN:"EVENT_USER_LOGGED_IN",USER_LOGGED_OUT:"EVENT_USER_LOGGED_OUT",USER_NOT_AUTHORIZED:"EVENT_USER_NOT_AUTHORIZED",GO_HOME:"EVENT_GO_HOME",CLEAR_STATE:"EVENT_CLEAR_STATE",SET_STATE:"EVENT_SET_STATE",STATE_CHANGED:"EVENT_STATE_CHANGED"},ERROR={DUPLICATE_VIEWER_NAME:"ERROR_DUPLICATE_VIEWER_NAME"},currentEvent={},currentError={},send=function(type,value){$timeout(function(){angular.isUndefined(type)?console.trace("UNDEFINED EVENT TYPE"):(console.log("SEND: "+type+" : "+JSON.stringify(value)),currentEvent={type:type,value:value})})},sendError=function(type,value){$timeout(function(){angular.isUndefined(type)?console.trace("UNDEFINED ERROR TYPE"):currentError={type:type,value:value}})};return{EVENT:EVENT,ERROR:ERROR,currentEvent:function(){return currentEvent},currentError:function(){return currentError},send:send,sendError:sendError}}angular.module("3drepo").factory("EventService",EventService),EventService.$inject=["$timeout"]}(),function(){"use strict";function global(EventService){function link(scope,element){}return{restrict:"A",link:link}}angular.module("3drepo").directive("global",global),global.$inject=["EventService"]}(),function(){"use strict";function MultiSelectCtrl(EventService){var objectIndex,self=this,selectedObjects=[],deselectedObjects=[],cmdKey=91,ctrlKey=17,isMac=navigator.platform.indexOf("Mac")!==-1,multiMode=!1;this.setSelectedObjects({selectedObjects:null}),this.$onChanges=function(changes){changes.hasOwnProperty("keysDown")&&(isMac&&changes.keysDown.currentValue.indexOf(cmdKey)!==-1||!isMac&&changes.keysDown.currentValue.indexOf(ctrlKey)!==-1?(multiMode=!0,this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:multiMode}),this.displaySelectedObjects(selectedObjects,deselectedObjects)):multiMode&&(isMac&&changes.keysDown.currentValue.indexOf(cmdKey)===-1||!isMac&&changes.keysDown.currentValue.indexOf(ctrlKey)===-1)&&(multiMode=!1,this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:multiMode}))),changes.hasOwnProperty("event")&&changes.event.currentValue&&(multiMode&&changes.event.currentValue.type===EventService.EVENT.VIEWER.OBJECT_SELECTED?(deselectedObjects=[],objectIndex=selectedObjects.indexOf(changes.event.currentValue.value.id),objectIndex===-1?selectedObjects.push(changes.event.currentValue.value.id):deselectedObjects.push(selectedObjects.splice(objectIndex,1)),this.displaySelectedObjects(selectedObjects,deselectedObjects),selectedObjects.length>0?self.setSelectedObjects({selectedObjects:selectedObjects}):self.setSelectedObjects({selectedObjects:null})):changes.event.currentValue.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED&&selectedObjects.length>0&&(this.displaySelectedObjects([],selectedObjects),selectedObjects=[],self.setSelectedObjects({selectedObjects:null}))),changes.hasOwnProperty("initialSelectedObjects")&&this.initialSelectedObjects&&(selectedObjects=this.initialSelectedObjects,this.displaySelectedObjects(selectedObjects,deselectedObjects))},this.$onDestroy=function(){this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:!1})},this.displaySelectedObjects=function(selectedObjects,deselectedObjects){var data={source:"tree",account:this.account,project:this.project,highlight_ids:selectedObjects,unhighlight_ids:deselectedObjects};this.sendEvent({type:EventService.EVENT.VIEWER.HIGHLIGHT_AND_UNHIGHLIGHT_OBJECTS,value:data})}}angular.module("3drepo").component("multiSelect",{controller:MultiSelectCtrl,bindings:{account:"<",project:"<",keysDown:"<",sendEvent:"&",event:"<",setSelectedObjects:"&",initialSelectedObjects:"<"}}),MultiSelectCtrl.$inject=["EventService"]}(),function(){"use strict";function project(){return{restrict:"E",scope:{account:"=",project:"=",branch:"=",revision:"=",state:"="},templateUrl:"project.html",controller:ProjectCtrl,controllerAs:"vm",bindToController:!0}}function ProjectCtrl($timeout,$scope,$element,$compile,EventService,ProjectService){var projectUI,issueArea,vm=this,panelCard={left:[],right:[]};vm.pointerEvents="auto",vm.keysDown=[],$timeout(function(){projectUI=angular.element($element[0].querySelector("#projectUI"))}),panelCard.left.push({type:"issues",title:"Issues",show:!0,help:"List current issues",icon:"place",menu:[{value:"print",label:"Print",selected:!1,noToggle:!0,icon:"fa-print"},{value:"importBCF",label:"Import BCF",selected:!1,noToggle:!0,icon:"fa-cloud-upload"},{value:"exportBCF",label:"Export BCF",selected:!1,noToggle:!0,icon:"fa-cloud-download",divider:!0},{value:"sortByDate",label:"Sort by Date",firstSelectedIcon:"fa-sort-amount-desc",secondSelectedIcon:"fa-sort-amount-asc",toggle:!1,selected:!0,firstSelected:!0,secondSelected:!1},{value:"showClosed",label:"Show resolved issues",toggle:!0,selected:!1,firstSelected:!1,secondSelected:!1}],minHeight:260,fixedHeight:!1,options:[{type:"menu",visible:!0},{type:"filter",visible:!0},{type:"pin",visible:!1},{type:"erase",visible:!1},{type:"scribble",visible:!1}],add:!0}),panelCard.left.push({type:"tree",title:"Tree",show:!1,help:"Model elements shown in a tree structure",icon:"device_hub",minHeight:80,fixedHeight:!1,options:[{type:"filter",visible:!0}]}),panelCard.left.push({type:"clip",title:"Clip",show:!1,help:"Clipping plane",icon:"crop_original",fixedHeight:!0,options:[{type:"visible",visible:!0}]}),panelCard.right.push({type:"docs",title:"Data",show:!1,help:"Documents",icon:"content_copy",minHeight:80,fixedHeight:!1,options:[{type:"close",visible:!0}]}),panelCard.right.push({type:"building",title:"Building",show:!1,help:"Building",icon:"fa-cubes",fixedHeight:!0,options:[]}),$scope.$watchGroup(["vm.account","vm.project"],function(){angular.isDefined(vm.account)&&angular.isDefined(vm.project)&&ProjectService.getProjectInfo(vm.account,vm.project).then(function(data){vm.settings=data.settings,EventService.send(EventService.EVENT.PROJECT_SETTINGS_READY,{account:data.account,project:data.project,settings:data.settings})})}),$timeout(function(){EventService.send(EventService.EVENT.CREATE_VIEWER,{name:"default",account:vm.account,project:vm.project,branch:vm.branch,revision:vm.revision,at:StateManager.query.at,up:StateManager.query.up,view:StateManager.query.view}),EventService.send(EventService.EVENT.PANEL_CONTENT_SETUP,panelCard)}),$scope.$watch(EventService.currentEvent,function(event){var element,parent=angular.element($element[0].querySelector("#project"));vm.event=event,event.type===EventService.EVENT.TOGGLE_ISSUE_AREA?event.value.on?(issueArea=angular.element("<issue-area></issue-area>"),event.value.hasOwnProperty("issue")?(vm.issueAreaIssue=event.value.issue,issueArea=angular.element("<issue-area data='vm.issueAreaIssue'></issue-area>")):event.value.hasOwnProperty("type")&&(vm.issueAreaType=event.value.type,issueArea=angular.element("<issue-area type='vm.issueAreaType'></issue-area>")),projectUI.prepend(issueArea),$compile(issueArea)($scope)):angular.isDefined(issueArea)&&issueArea.remove():event.type===EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING?vm.pointerEvents=event.value.on?"none":"auto":event.type===EventService.EVENT.MEASURE_MODE&&(event.value?(element=angular.element("<tdr-measure id='tdrMeasure' account='vm.account' project='vm.project' settings='vm.settings' ></tdr-measure>"),parent.append(element),$compile(element)($scope)):(element=angular.element($element[0].querySelector("#tdrMeasure")),element.remove()))}),vm.keyAction=function(event){var i,tmp;if("keydown"===event.type)vm.keysDown.indexOf(event.which)===-1&&(tmp=vm.keysDown,delete vm.keysDown,vm.keysDown=angular.copy(tmp),vm.keysDown.push(event.which));else if("keyup"===event.type){for(i=vm.keysDown.length-1;i>=0;i-=1)vm.keysDown[i]===event.which&&vm.keysDown.splice(i,1);tmp=vm.keysDown,delete vm.keysDown,vm.keysDown=angular.copy(tmp)}},vm.setSelectedObjects=function(selectedObjects){vm.selectedObjects=selectedObjects},vm.setInitialSelectedObjects=function(data){vm.initialSelectedObjects=data.selectedObjects,$timeout(function(){vm.initialSelectedObjects=null})},vm.sendEvent=function(type,value){EventService.send(type,value)}}angular.module("3drepo").directive("project",project),ProjectCtrl.$inject=["$timeout","$scope","$element","$compile","EventService","ProjectService"]}(),function(){"use strict";function ProjectService($http,$q,StateManager,serverConfig,HttpService,Auth){function doPost(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,state.account+"/"+state.project+"/"+urlEnd),config={withCredentials:!0};return $http.post(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doGet(urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,state.account+"/"+state.project+"/"+urlEnd);return $http.get(url).then(function(response){deferred.resolve(response)},function(){deferred.resolve([])}),deferred.promise}var state=StateManager.state,getProjectInfo=function(account,project){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+".json");return $http.get(url).then(function(res){var data=res.data;deferred.resolve({account:account,project:project,owner:data.owner,description:data.desc,type:data.type,settings:data.properties},function(){deferred.resolve()})}),deferred.promise},getRoles=function(account,project){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/roles.json");return $http.get(url).then(function(data){deferred.resolve(data.data)},function(){deferred.resolve([])}),deferred.promise},getUserRolesForProject=function(){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,state.account+"/"+state.project+"/"+Auth.username+"/userRolesForProject.json");return $http.get(url).then(function(response){deferred.resolve(response.data)},function(){deferred.resolve([])}),deferred.promise},getUserRoles=function(account,project){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+project+"/"+Auth.username+"/userRolesForProject.json");return $http.get(url).then(function(response){deferred.resolve(response.data)},function(){deferred.resolve([])}),deferred.promise},createProjectSummary=function(data){return data.name=state.project,doPost(data,"info.json")},getProjectSummary=function(){return doGet("info.json")};return{getRoles:getRoles,getUserRolesForProject:getUserRolesForProject,getUserRoles:getUserRoles,createProjectSummary:createProjectSummary,getProjectSummary:getProjectSummary,getProjectInfo:getProjectInfo}}angular.module("3drepo").factory("ProjectService",ProjectService),ProjectService.$inject=["$http","$q","StateManager","serverConfig","HttpService","Auth"]}(),function(){"use strict";function viewer(EventService){return{restrict:"E",scope:{manager:"=",account:"@",project:"@",branch:"@",revision:"@",name:"@",autoInit:"@",vrMode:"@",at:"@",up:"@",view:"@",eventService:"="},link:function(scope,element){element.on("$destroy",function(){scope.v.viewer.destroy()})},controller:ViewerCtrl,controllerAs:"v",bindToController:!0}}function ViewerCtrl($scope,$q,$http,$element,serverConfig,EventService,$location){function errCallback(errorType,errorValue){v.eventService.sendError(errorType,errorValue)}function eventCallback(type,value){v.eventService.send(type,value)}var v=this;v.initialised=$q.defer(),v.loaded=$q.defer(),v.branch=v.branch?v.branch:"master",v.revision=v.revision?v.revision:"head",v.pointerEvents="auto",angular.isDefined(v.eventService)||(v.EventService=EventService),$scope.reload=function(){v.viewer.loadModel(v.account,v.project,v.branch,v.revision)},$scope.init=function(){v.viewer=new Viewer(v.name,$element[0],v.manager,eventCallback,errCallback);var options={},startLatLon=v.at&&v.at.split(","),view=v.view&&v.view.split(",");view&&view.forEach(function(val,i){view[i]=parseFloat(val)}),options.view=view;var up=v.up&&v.up.split(",");up&&up.forEach(function(val,i){up[i]=parseFloat(val)}),options.up=up;var showAll=!0;startLatLon&&(showAll=!1,options.lat=parseFloat(startLatLon[0]),options.lon=parseFloat(startLatLon[1]),options.y=parseFloat(startLatLon[2])),v.mapTile=new MapTile(v.viewer,eventCallback,options),v.viewer.init({showAll:showAll,plugins:{mapTile:v.mapTile}}),v.oculus=new Oculus(v.viewer),v.gamepad=new Gamepad(v.viewer),v.gamepad.init(),v.measure=new MeasureTool(v.viewer),v.collision=new Collision(v.viewer),$scope.reload(),v.loaded.promise.then(function(){v.oculus=new Oculus(v.viewer),v.gamepad=new Gamepad(v.viewer),v.gamepad.init(),v.collision=new Collision(v.viewer),v.branch="master",v.revision="head",$http.get(serverConfig.apiUrl(serverConfig.GET_API,v.account+"/"+v.project+"/revision/"+v.branch+"/"+v.revision+"/modelProperties.json")).success(function(json,status){v.viewer.applyModelProperties(v.account,v.project,json)})}),$http.get(serverConfig.apiUrl(serverConfig.GET_API,v.account+"/"+v.project+".json")).success(function(json,status){EventService.send(EventService.EVENT.PROJECT_SETTINGS_READY,{account:v.account,project:v.project,settings:json.properties})})},$scope.enterVR=function(){v.loaded.promise.then(function(){v.oculus.switchVR()})},$scope.$watch(v.branch,function(blah){console.log(JSON.stringify(blah))}),$scope.$watch(v.eventService.currentEvent,function(event){angular.isDefined(event)&&angular.isDefined(event.type)&&(event.type===EventService.EVENT.VIEWER.START_LOADING?v.initialised.resolve():event.type===EventService.EVENT.VIEWER.LOADED?v.loaded.resolve():(v.initialised.promise.then(function(){event.type===EventService.EVENT.VIEWER.GO_HOME?v.viewer.showAll():event.type===EventService.EVENT.VIEWER.SWITCH_FULLSCREEN?v.viewer.switchFullScreen(null):event.type===EventService.EVENT.VIEWER.ENTER_VR?v.oculus.switchVR():event.type===EventService.EVENT.VIEWER.REGISTER_VIEWPOINT_CALLBACK?v.viewer.onViewpointChanged(event.value.callback):event.type===EventService.EVENT.VIEWER.REGISTER_MOUSE_MOVE_CALLBACK?v.viewer.onMouseMove(event.value.callback):event.type===EventService.EVENT.PROJECT_SETTINGS_READY&&event.value.account===v.account&&event.value.project===v.project&&(v.viewer.updateSettings(event.value.settings),v.mapTile.updateSettings(event.value.settings))}),v.loaded.promise.then(function(){event.type===EventService.EVENT.VIEWER.ADD_PIN?v.viewer.addPin(event.value.account,event.value.project,event.value.id,event.value.position,event.value.norm,event.value.colours,event.value.viewpoint):event.type===EventService.EVENT.VIEWER.REMOVE_PIN?v.viewer.removePin(event.value.id):event.type===EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR?v.viewer.changePinColours(event.value.id,event.value.colours):event.type===EventService.EVENT.VIEWER.CLICK_PIN?v.viewer.clickPin(event.value.id):event.type===EventService.EVENT.VIEWER.SET_PIN_VISIBILITY?v.viewer.setPinVisibility(event.value.id,event.value.visibility):event.type===EventService.EVENT.VIEWER.CLEAR_CLIPPING_PLANES?v.viewer.clearClippingPlanes():event.type===EventService.EVENT.VIEWER.ADD_CLIPPING_PLANE?v.viewer.addClippingPlane(event.value.axis,event.value.distance?event.value.distance:0,event.value.percentage?event.value.percentage:0,event.value.clipDirection?event.value.clipDirection:-1):event.type===EventService.EVENT.VIEWER.MOVE_CLIPPING_PLANE?v.viewer.moveClippingPlane(event.value.percentage):event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED?v.viewer.highlightObjects(event.value.account,event.value.project,event.value.id?[event.value.id]:event.value.ids,event.value.zoom,event.value.colour):event.type===EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS?v.viewer.highlightObjects(event.value.account,event.value.project,event.value.id?[event.value.id]:event.value.ids,event.value.zoom,event.value.colour):event.type===EventService.EVENT.VIEWER.HIGHLIGHT_AND_UNHIGHLIGHT_OBJECTS?v.viewer.highlightAndUnhighlightObjects(event.value.account,event.value.project,event.value.highlight_ids,event.value.unhighlight_ids,event.value.zoom,event.value.colour):event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?v.viewer.highlightObjects():event.type===EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY?v.viewer.switchObjectVisibility(event.value.account,event.value.project,event.value.visible_ids,event.value.invisible_ids):event.type===EventService.EVENT.VIEWER.SET_CAMERA?v.viewer.setCamera(event.value.position,event.value.view_dir,event.value.up,event.value.look_at,!angular.isDefined(event.value.animate)||event.value.animate,event.value.rollerCoasterMode):event.type===EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT?angular.isDefined(event.value.promise)&&event.value.promise.resolve(v.manager.getCurrentViewer().getCurrentViewpointInfo()):event.type===EventService.EVENT.VIEWER.GET_SCREENSHOT?angular.isDefined(event.value.promise)&&event.value.promise.resolve(v.manager.getCurrentViewer().runtime.getScreenshot()):event.type===EventService.EVENT.VIEWER.SET_NAV_MODE?v.manager.getCurrentViewer().setNavMode(event.value.mode):event.type===EventService.EVENT.MEASURE_MODE?v.measure.measureMode(event.value):event.type===EventService.EVENT.VIEWER.UPDATE_URL?$location.path("/"+v.account+"/"+v.project).search({at:event.value.at,view:event.value.view,up:event.value.up}):event.type===EventService.EVENT.MULTI_SELECT_MODE?v.viewer.setMultiSelectMode(event.value):event.type===EventService.EVENT.PIN_DROP_MODE&&v.viewer.setPinDropMode(event.value)})))}),$scope.init(),angular.isDefined(v.vrMode)&&$scope.enterVR()}angular.module("3drepo").directive("viewer",viewer),viewer.$inject=["EventService"],ViewerCtrl.$inject=["$scope","$q","$http","$element","serverConfig","EventService","$location"]}(),function(){"use strict";function viewerManager(){return{restrict:"E",controller:ViewerManagerCtrl,scope:!0,templateUrl:"viewermanager.html",controllerAs:"vm",bindToController:!0}}function ViewerManagerService($timeout,nextEventService){var currentEvent={},currentError={},sendInternal=function(type,value){currentEvent={type:type,value:value}},send=function(type,value){nextEventService.send(type,value)},sendErrorInternal=function(type,value){currentError={type:type,value:value}},sendError=function(type,value){nextEventService.sendError(type,value)};return{currentEvent:function(){return currentEvent},currentError:function(){return currentError},send:send,sendInternal:sendInternal,sendError:sendError,sendErrorInternal:sendErrorInternal}}function ViewerManagerCtrl($scope,$q,$element,$timeout,EventService){var vm=this;vm.manager=new ViewerManager($element[0]),vm.vmservice=ViewerManagerService($timeout,EventService),vm.viewers={},$scope.manager=vm.manager,vm.viewerInit=$q.defer(),vm.viewerLoaded=$q.defer(),$scope.$watch(EventService.currentEvent,function(event){angular.isDefined(event.type)&&(event.type===EventService.EVENT.CREATE_VIEWER?vm.viewers.hasOwnProperty(event.value.name)?EventService.sendError(EventService.ERROR.DUPLICATE_VIEWER_NAME,{name:event.value.name}):vm.viewers[event.value.name]=event.value:event.type===EventService.EVENT.CLOSE_VIEWER?vm.viewers.hasOwnProperty(event.value.name)&&delete vm.viewers[event.value.name]:event.type===EventService.EVENT.VIEWER.READY?window.viewer=vm.manager.getCurrentViewer():vm.vmservice.sendInternal(event.type,event.value))})}angular.module("3drepo").directive("viewermanager",viewerManager),ViewerManagerCtrl.$inject=["$scope","$q","$element","$timeout","EventService"]}(),function(){"use strict";function registerRequest(){return{restrict:"E",scope:{state:"="},templateUrl:"registerRequest.html",controller:RegisterRequestCtrl,controllerAs:"vm",bindToController:!0}}function RegisterRequestCtrl($scope,$window){var vm=this;$scope.$watch("vm.state",function(newValue){}),vm.goToLoginPage=function(){$window.location.href="/"}}angular.module("3drepo").directive("registerRequest",registerRequest),RegisterRequestCtrl.$inject=["$scope","$window"]}(),function(){"use strict";function registerVerify(){return{restrict:"E",scope:{},templateUrl:"registerVerify.html",controller:RegisterVerifyCtrl,controllerAs:"vm",bindToController:!0}}function RegisterVerifyCtrl(EventService,UtilsService,StateManager){var promise,vm=this,username=StateManager.query.username,token=StateManager.query.token;vm.verified=!1,vm.showPaymentWait=!1,vm.databaseName=username,vm.verifyErrorMessage="Verifying. Please wait...",promise=UtilsService.doPost({token:token},username+"/verify"),promise.then(function(response){200===response.status?(vm.verified=!0,vm.verifySuccessMessage="Congratulations. You have successfully signed up for 3D Repo. You may now login to you account."):60===response.data.value?(vm.verified=!0,vm.verifySuccessMessage="You have already verified your account successfully. You may now login to your account."):vm.verifyErrorMessage="Error with verification"}),vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("registerVerify",registerVerify),RegisterVerifyCtrl.$inject=["EventService","UtilsService","StateManager"]}(),function(){"use strict";function revisions(){return{restrict:"E",templateUrl:"revisions.html",scope:{account:"=",project:"=",revision:"="},controller:revisionsCtrl,controllerAs:"vm",bindToController:!0}}function revisionsCtrl($location,$scope,RevisionsService,UtilsService,$filter){var vm=this;RevisionsService.listAll(vm.account,vm.project).then(function(revisions){vm.revisions=revisions}),$scope.$watch("vm.revisions",function(){vm.revisions&&vm.revisions[0]&&(vm.revision?vm.revisions&&vm.revisions.forEach(function(rev,i){rev.tag===vm.revision?(vm.revName=vm.revision,vm.revisions[i].current=!0):rev._id===vm.revision&&(vm.revName=$filter("revisionDate")(rev.timestamp),vm.revisions[i].current=!0)}):(vm.revName=vm.revisions[0].tag||$filter("revisionDate")(vm.revisions[0].timestamp),vm.revisions[0].current=!0))}),vm.openDialog=function(){vm.revisions||RevisionsService.listAll(vm.account,vm.project).then(function(revisions){vm.revisions=revisions}),UtilsService.showDialog("revisionsDialog.html",$scope,event,!0)},vm.goToRevision=function(revId){UtilsService.closeDialog(),$location.path("/"+vm.account+"/"+vm.project+"/"+revId,"_self")},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("revisions",revisions),revisionsCtrl.$inject=["$location","$scope","RevisionsService","UtilsService","$filter"]}(),function(){"use strict";function RevisionsService(UtilsService){function listAll(account,project){return UtilsService.doGet(account+"/"+project+"/revisions.json").then(function(response){return 200===response.status?Promise.resolve(response.data):Promise.reject(response.data)})}function isTagFormatInValid(tag){return tag&&!tag.match(server_config.tagRegExp)}return{listAll:listAll,isTagFormatInValid:isTagFormatInValid}}angular.module("3drepo").factory("RevisionsService",RevisionsService),RevisionsService.$inject=["UtilsService"]}(),function(){"use strict";function rightPanel(){return{restrict:"E",scope:{},templateUrl:"rightPanel.html",controller:RightPanelCtrl,controllerAs:"vm",bindToController:!0}}function RightPanelCtrl($scope,$timeout,EventService){var vm=this,addIssueMode=null,measureMode=!1,autoMetaData=!0,highlightBackground="#FF9800";vm.showPanel=!0,vm.issueButtons={scribble:{label:"Scribble",icon:"border_color",background:""},erase:{label:"Erase",faIcon:"fa fa-eraser",background:""},pin:{label:"Pin",icon:"pin_drop",background:""}},vm.measureBackground="",vm.metaBackground=highlightBackground,$timeout(function(){EventService.send(EventService.EVENT.AUTO_META_DATA,autoMetaData)}),$scope.$watch(EventService.currentEvent,function(event){event.type!==EventService.EVENT.TOGGLE_ISSUE_AREA||event.value.on?event.type===EventService.EVENT.SET_ISSUE_AREA_MODE?addIssueMode!==event.value&&(vm.issueButtons[addIssueMode].background="",addIssueMode=event.value,vm.issueButtons[addIssueMode].background=highlightBackground):event.type===EventService.EVENT.TOGGLE_ELEMENTS&&(vm.showPanel=!vm.showPanel):null!==addIssueMode&&(vm.issueButtons[addIssueMode].background="",addIssueMode=null)}),vm.issueButtonClick=function(buttonType){measureMode&&(measureMode=!1,vm.measureBackground="",EventService.send(EventService.EVENT.MEASURE_MODE,measureMode)),null===addIssueMode?(addIssueMode=buttonType,vm.issueButtons[buttonType].background=highlightBackground,EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!0,type:buttonType})):addIssueMode===buttonType?(addIssueMode=null,vm.issueButtons[buttonType].background="",EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!1})):(vm.issueButtons[addIssueMode].background="",addIssueMode=buttonType,vm.issueButtons[addIssueMode].background=highlightBackground,EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,buttonType))},vm.toggleMeasure=function(){null!==addIssueMode&&EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!1}),measureMode=!measureMode,vm.measureBackground=measureMode?highlightBackground:"",EventService.send(EventService.EVENT.MEASURE_MODE,measureMode)},vm.toggleAutoMetaData=function(){autoMetaData=!autoMetaData,vm.metaBackground=autoMetaData?highlightBackground:"",EventService.send(EventService.EVENT.AUTO_META_DATA,autoMetaData)}}angular.module("3drepo").directive("rightPanel",rightPanel),RightPanelCtrl.$inject=["$scope","$timeout","EventService"]}(),function(){"use strict";function signUp(){return{restrict:"E",scope:{},templateUrl:"signUp.html",controller:SignUpCtrl,controllerAs:"vm",bindToController:!0}}function SignUpCtrl($location){}angular.module("3drepo").directive("signUp",signUp),SignUpCtrl.$inject=["$location"]}(),function(){"use strict";function signUpForm(){return{restrict:"EA",templateUrl:"signUpForm.html",scope:{buttonLabel:"@"},controller:SignUpFormCtrl,controllerAs:"vm",bindToController:!0}}function SignUpFormCtrl($scope,$mdDialog,$location,serverConfig,UtilsService){function removeDialog(){$scope.closeDialog()}function doRegister(){var data,doRegister=!0,allowedFormat=new RegExp(server_config.usernameRegExp);angular.isDefined(vm.newUser.username)&&angular.isDefined(vm.newUser.email)&&angular.isDefined(vm.newUser.password)?allowedFormat.test(vm.newUser.username)?(vm.showLegalText&&(doRegister=vm.newUser.tcAgreed),doRegister?(data={email:vm.newUser.email,password:vm.newUser.password},vm.useReCapthca&&(data.captcha=vm.reCaptchaResponse),vm.registering=!0,promise=UtilsService.doPost(data,vm.newUser.username),promise.then(function(response){200===response.status?vm.showPage("registerRequest"):62===response.data.value?vm.registerErrorMessage="Prove you're not a robot":55===response.data.value?vm.registerErrorMessage="Username already in use":vm.registerErrorMessage=response.data.message,vm.registering=!1,vm.useReCapthca&&grecaptcha.reset()})):vm.registerErrorMessage="You must agree to the terms and conditions"):vm.registerErrorMessage="Username not allowed":vm.registerErrorMessage="Please fill all fields"}function getLegalTextFromLegalItem(legalItem){return"<a target='_blank' href='/"+legalItem.page+"'>"+legalItem.title+"</a>"}var promise,legalItem,vm=this,enterKey=13,agreeToText="",haveReadText="";if(vm.newUser={username:"",email:"",password:"",tcAgreed:!1},vm.version=serverConfig.apiVersion,vm.logo="/public/images/3drepo-logo-white.png",vm.captchaKey=serverConfig.captcha_client_key,vm.tcAgreed=!1,vm.useReCapthca=!1,vm.registering=!1,vm.showLegalText=!1,serverConfig.hasOwnProperty("auth")&&serverConfig.auth.hasOwnProperty("captcha")&&serverConfig.auth.captcha&&(vm.useReCapthca=!0),angular.isDefined(serverConfig.legal)){vm.showLegalText=!0,vm.legalText="";for(legalItem in serverConfig.legal)serverConfig.legal.hasOwnProperty(legalItem)&&("agreeTo"===serverConfig.legal[legalItem].type?""===agreeToText?agreeToText="I agree to the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem]):agreeToText+=" and the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem]):"haveRead"===serverConfig.legal[legalItem].type&&(""===haveReadText?haveReadText="I have read the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem])+" policy":haveReadText+=" and the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem])+" policy"));vm.legalText=agreeToText,""!==vm.legalText&&(vm.legalText+=" and "),vm.legalText+=haveReadText,""!==vm.legalText&&(vm.legalText+=".")}$scope.$watch("vm.newUser",function(newValue){angular.isDefined(newValue)&&(vm.registerErrorMessage="")},!0),vm.register=function(event){angular.isDefined(event)?event.which===enterKey&&doRegister():doRegister()},vm.showTC=function(){vm.legalTitle="Terms and Conditions",vm.legalText="termsAndConditions",$mdDialog.show({templateUrl:"legalDialog.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0,scope:$scope,preserveScope:!0,onRemoving:removeDialog})},vm.showPage=function(page){$location.path("/"+page,"_self")},$scope.closeDialog=function(){$mdDialog.cancel()}}angular.module("3drepo").directive("signUpForm",signUpForm),SignUpFormCtrl.$inject=["$scope","$mdDialog","$location","serverConfig","UtilsService"]}(),function(){"use strict";function terms(){return{restrict:"E",scope:{},templateUrl:"terms.html",controller:TermsCtrl,controllerAs:"vm",bindToController:!0}}function TermsCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("terms",terms),TermsCtrl.$inject=["EventService"]}(),function(){"use strict";function tree(){return{restrict:"EA",templateUrl:"tree.html",scope:{account:"=",project:"=",branch:"=",revision:"=",filterText:"=",onContentHeightRequest:"&"},controller:TreeCtrl,controllerAs:"vm",bindToController:!0}}function TreeCtrl($scope,$timeout,TreeService,EventService){function setContentHeight(nodesToShow){var i,length,height=0,nodeMinHeight=42,maxStringLength=35,maxStringLengthForLevel=0,lineHeight=18,levelOffset=2;for(i=0,length=nodesToShow.length;i<length;i+=1)maxStringLengthForLevel=maxStringLength-nodesToShow[i].level*levelOffset,height+=nodesToShow[i].hasOwnProperty("name")?nodeMinHeight+lineHeight*Math.floor(nodesToShow[i].name.length/maxStringLengthForLevel):nodeMinHeight+lineHeight;vm.onContentHeightRequest({height:height})}function initNodesToShow(){vm.nodesToShow=[vm.allNodes[0]],vm.nodesToShow[0].level=0,vm.nodesToShow[0].expanded=!1,
vm.nodesToShow[0].hasChildren=!0,vm.nodesToShow[0].selected=!1,vm.nodesToShow[0].hasOwnProperty("toggleState")||(vm.nodesToShow[0].toggleState="visible")}function expandToSelection(path,level){var i,j,length,childrenLength,selectedId=path[path.length-1],selectedIndex=0,selectionFound=!1;for(vm.showNodes=!1,i=0,length=vm.nodesToShow.length;i<length;i+=1)if(vm.nodesToShow[i]._id===path[level])for(vm.nodesToShow[i].expanded=!0,vm.nodesToShow[i].selected=!1,childrenLength=vm.nodesToShow[i].children.length,level===path.length-2&&(selectedIndex=i),j=0;j<childrenLength;j+=1)vm.nodesToShow[i].children[j].expanded=!1,vm.nodesToShow[i].children[j]._id===selectedId?vm.nodesToShow[i].children[j].hasOwnProperty("name")?vm.nodesToShow[i].children[j].selected=!0:vm.selectNode(vm.nodesToShow[i]):vm.nodesToShow[i].children[j].selected=!1,vm.nodesToShow[i].children[j].hasOwnProperty("toggleState")||vm.setToggleState(vm.nodesToShow[i].children[j],"visible"),"children"in vm.nodesToShow[i].children[j]?vm.nodesToShow[i].children[j].hasChildren=vm.nodesToShow[i].children[j].children.length>0:vm.nodesToShow[i].children[j].hasChildren=!1,vm.nodesToShow[i].children[j].selected&&(selectionFound=!0,currentSelectedNode=vm.nodesToShow[i].children[j]),level!==path.length-2||selectionFound||(selectedIndex+=1),vm.nodesToShow[i].children[j].level=level+1,vm.nodesToShow.splice(i+j+1,0,vm.nodesToShow[i].children[j]);level<path.length-2?expandToSelection(path,level+1):level===path.length-2&&(vm.topIndex=selectedIndex-2,setContentHeight(vm.nodesToShow),$timeout(function(){vm.showNodes=!0}))}function setupInfiniteScroll(){vm.infiniteItemsTree={numLoaded_:0,toLoad_:0,getItemAtIndex:function(index){return index>this.numLoaded_?(this.fetchMoreItems_(index),null):index<vm.nodesToShow.length?vm.nodesToShow[index]:null},getLength:function(){return this.numLoaded_+5},fetchMoreItems_:function(index){this.toLoad_<index&&(this.toLoad_+=500,$timeout(angular.noop,300).then(angular.bind(this,function(){this.numLoaded_=this.toLoad_})))}}}function setupInfiniteItemsFilter(){vm.infiniteItemsFilter={numLoaded_:0,toLoad_:0,getItemAtIndex:function(index){return index>this.numLoaded_?(this.fetchMoreItems_(index),null):index<vm.nodes.length?vm.nodes[index]:null},getLength:function(){return this.numLoaded_+5},fetchMoreItems_:function(index){this.toLoad_<index&&(this.toLoad_+=20,$timeout(angular.noop,300).then(angular.bind(this,function(){this.numLoaded_=this.toLoad_})))}}}function updateClickedHidden(node){"invisible"===node.toggleState?clickedHidden[node._id]=node:delete clickedHidden[node._id]}function updateClickedShown(node){"visible"===node.toggleState?clickedShown[node._id]=node:delete clickedShown[node._id]}function pathRelativeWasClickShown(node){var i,length,relativeWasClickShown=!1,path=node.path.split("__");for(path.pop(),i=0,length=path.length;i<length;i+=1)if(clickedShown.hasOwnProperty(path[i])){relativeWasClickShown=!0;break}return relativeWasClickShown}var vm=this,promise=null,i=0,length=0,currentSelectedNode=null,highlightSelectedViewerObject=!0,clickedHidden={},clickedShown={},multiSelectMode=!1;vm.nodes=[],vm.showNodes=!0,vm.showTree=!0,vm.showFilterList=!1,vm.currentFilterItemSelected=null,vm.viewerSelectedObject=null,vm.showProgress=!0,vm.progressInfo="Loading full tree structure",vm.onContentHeightRequest({height:70}),vm.visible=[],vm.invisible=[],promise=TreeService.init(vm.account,vm.project,vm.branch,vm.revision),promise.then(function(data){vm.allNodes=[],vm.allNodes.push(data.nodes),vm.nodes=vm.allNodes,vm.showTree=!0,vm.showProgress=!1,vm.idToPath=data.idToPath,initNodesToShow(),setupInfiniteScroll(),setContentHeight(vm.nodesToShow)}),vm.setToggleState=function(node,visibility){var idx=-1;"invisible"===visibility?((idx=vm.invisible.indexOf(node._id))!==-1?vm.invisible.splice(idx,1):vm.invisible.push(node._id),(idx=vm.visible.indexOf(node._id))!==-1&&vm.visible.splice(idx,1)):((idx=vm.visible.indexOf(node._id))!==-1?vm.visible.splice(idx,1):vm.visible.push(node._id),(idx=vm.invisible.indexOf(node._id))!==-1&&vm.invisible.splice(idx,1)),node.toggleState=visibility},vm.expand=function(_id){var i,length,j,jLength,numChildren=0,index=-1,endOfSplice=!1,numChildrenToForceRedraw=3;for(i=0,length=vm.nodesToShow.length;i<length;i+=1)if(vm.nodesToShow[i]._id===_id){index=i;break}if(index!==-1&&vm.nodesToShow[index].hasChildren){if(vm.nodesToShow[index].expanded)for(;!endOfSplice;)angular.isDefined(vm.nodesToShow[index+1])&&vm.nodesToShow[index+1].path.indexOf(_id)!==-1?vm.nodesToShow.splice(index+1,1):endOfSplice=!0;else{for(numChildren=vm.nodesToShow[index].children.length,numChildren>=numChildrenToForceRedraw&&(vm.showNodes=!1),i=0;i<numChildren;i+=1){if(0===vm.nodesToShow[index].level&&vm.nodesToShow[index].children[i].hasOwnProperty("children")&&vm.nodesToShow[index].children[i].children[0].hasOwnProperty("status")?vm.nodesToShow[index].children[i].status=vm.nodesToShow[index].children[i].children[0].status:(vm.nodesToShow[index].children[i].expanded=!1,vm.nodesToShow[index].children[i].hasOwnProperty("toggleState")?"invisible"!==vm.nodesToShow[index].children[i].toggleState&&"parentOfInvisible"!==vm.nodesToShow[index].children[i].toggleState||!pathRelativeWasClickShown(vm.nodesToShow[index].children[i])||vm.setToggleState(vm.nodesToShow[index].children[i],"visible"):vm.setToggleState(vm.nodesToShow[index].children[i],"visible")),vm.nodesToShow[index].children[i].level=vm.nodesToShow[index].level+1,vm.nodesToShow[index].children[i].hasChildren=!1,"children"in vm.nodesToShow[index].children[i]&&vm.nodesToShow[index].children[i].children.length>0)for(j=0,jLength=vm.nodesToShow[index].children[i].children.length;j<jLength;j++)if(vm.nodesToShow[index].children[i].children[j].hasOwnProperty("name")){vm.nodesToShow[index].children[i].hasChildren=!0;break}vm.nodesToShow.splice(index+i+1,0,vm.nodesToShow[index].children[i])}vm.showNodes||$timeout(function(){vm.showNodes=!0})}vm.nodesToShow[index].expanded=!vm.nodesToShow[index].expanded}setContentHeight(vm.nodesToShow)},$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED){if("tree"!==event.value.source&&highlightSelectedViewerObject){var objectID=event.value.id;if(objectID){var path=vm.idToPath[objectID].split("__");initNodesToShow(),expandToSelection(path,0)}}}else event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?null!==currentSelectedNode&&(currentSelectedNode.selected=!1,currentSelectedNode=null,null!==vm.currentFilterItemSelected&&(vm.currentFilterItemSelected.class="",vm.currentFilterItemSelected=null)):event.type===EventService.EVENT.PANEL_CARD_ADD_MODE||event.type===EventService.EVENT.PANEL_CARD_EDIT_MODE?highlightSelectedViewerObject=!event.value.on:event.type===EventService.EVENT.MULTI_SELECT_MODE&&(multiSelectMode=event.value)}),vm.toggleTreeNode=function(node){var i,j,nodesLength,path,parent=null,nodeToggleState="visible",numInvisible=0,numParentInvisible=0;for(vm.toggledNode=node,path=node.path.split("__"),path.splice(path.length-1,1),i=0,nodesLength=vm.nodesToShow.length;i<nodesLength;i+=1)vm.nodesToShow[i]._id===node._id?(vm.setToggleState(vm.nodesToShow[i],"visible"===vm.nodesToShow[i].toggleState?"invisible":"visible"),nodeToggleState=vm.nodesToShow[i].toggleState,updateClickedHidden(vm.nodesToShow[i]),updateClickedShown(vm.nodesToShow[i])):vm.nodesToShow[i].path.indexOf(node._id)!==-1&&vm.setToggleState(vm.nodesToShow[i],nodeToggleState),vm.nodesToShow[i]._id===path[path.length-1]&&(parent=vm.nodesToShow[i]);if(null!==parent)for(i=path.length-1;i>=0;i-=1)for(j=0,nodesLength=vm.nodesToShow.length;j<nodesLength;j+=1)vm.nodesToShow[j]._id===path[i]&&(numInvisible=vm.nodesToShow[j].children.reduce(function(total,child){return"invisible"===child.toggleState?total+1:total},0),numParentInvisible=vm.nodesToShow[j].children.reduce(function(total,child){return"parentOfInvisible"===child.toggleState?total+1:total},0),numInvisible===vm.nodesToShow[j].children.length?vm.setToggleState(vm.nodesToShow[j],"invisible"):numParentInvisible+numInvisible>0?vm.setToggleState(vm.nodesToShow[j],"parentOfInvisible"):vm.setToggleState(vm.nodesToShow[j],"visible"));toggleNode(node)};var toggleNode=function(node){var childNodes=[],pathArr=[],idx=0,i=0;for(var obj in vm.idToPath)vm.idToPath.hasOwnProperty(obj)&&vm.idToPath[obj].indexOf(node.path)!==-1&&(pathArr=vm.idToPath[obj].split("__"),childNodes.push(pathArr[pathArr.length-1]));if("invisible"===node.toggleState)for(i=0;i<childNodes.length;i++)vm.invisible.indexOf(childNodes[i])===-1&&vm.invisible.push(childNodes[i]),idx=vm.visible.indexOf(childNodes[i]),idx!==-1&&vm.visible.splice(idx,1);else for(i=0;i<childNodes.length;i++)vm.visible.indexOf(childNodes[i])===-1&&vm.visible.push(childNodes[i]),idx=vm.invisible.indexOf(childNodes[i]),idx!==-1&&vm.invisible.splice(idx,1);EventService.send(EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY,{source:"tree",account:node.account,project:node.project,name:node.name,visible_ids:vm.visible,invisible_ids:vm.invisible})};$scope.$watch("vm.filterText",function(newValue){var noFilterItemsFoundHeight=82;angular.isDefined(newValue)&&(""===newValue.toString()?(vm.showTree=!0,vm.showFilterList=!1,vm.showProgress=!1,vm.nodes=vm.nodesToShow,setContentHeight(vm.nodes)):(vm.showTree=!1,vm.showFilterList=!1,vm.showProgress=!0,vm.progressInfo="Filtering tree for objects",promise=TreeService.search(newValue),promise.then(function(json){if(vm.showFilterList=!0,vm.showProgress=!1,vm.nodes=json.data,vm.nodes.length>0){for(vm.filterItemsFound=!0,i=0,length=vm.nodes.length;i<length;i+=1)vm.nodes[i].index=i,vm.nodes[i].toggleState="visible",vm.nodes[i].class="unselectedFilterItem",vm.nodes[i].level=0;setupInfiniteItemsFilter(),setContentHeight(vm.nodes)}else vm.filterItemsFound=!1,vm.onContentHeightRequest({height:noFilterItemsFoundHeight})})))}),vm.selectNode=function(node){if(null!==currentSelectedNode?(currentSelectedNode.selected=!1,currentSelectedNode._id===node._id?currentSelectedNode=null:(node.selected=!0,currentSelectedNode=node)):(node.selected=!0,currentSelectedNode=node),null===currentSelectedNode)EventService.send(EventService.EVENT.VIEWER.BACKGROUND_SELECTED);else{var map=[],pathArr=[];for(var obj in vm.idToPath)vm.idToPath.hasOwnProperty(obj)&&vm.idToPath[obj].indexOf(node._id)!==-1&&(pathArr=vm.idToPath[obj].split("__"),map.push(pathArr[pathArr.length-1]));EventService.send(EventService.EVENT.VIEWER.OBJECT_SELECTED,{source:"tree",account:node.account,project:node.project,id:node._id,name:node.name}),document.getElementsByTagName("multipart").length&&EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,{source:"tree",account:node.account,project:node.project,ids:map})}},vm.filterItemSelected=function(item){null===vm.currentFilterItemSelected?(vm.nodes[item.index].class="treeNodeSelected",vm.currentFilterItemSelected=item):item.index===vm.currentFilterItemSelected.index?(vm.nodes[item.index].class="",vm.currentFilterItemSelected=null):(vm.nodes[vm.currentFilterItemSelected.index].class="",vm.nodes[item.index].class="treeNodeSelected",vm.currentFilterItemSelected=item);var selectedNode=vm.nodes[item.index];vm.selectNode(selectedNode)},vm.toggleFilterNode=function(item){vm.setToggleState(item,"visible"===item.toggleState?"invisible":"visible"),item.path=item._id,toggleNode(item)}}angular.module("3drepo").directive("tree",tree),TreeCtrl.$inject=["$scope","$timeout","TreeService","EventService"]}(),function(){"use strict";function TreeService($http,$q,EventService,serverConfig){var ts=this,init=function(account,project,branch,revision){ts.account=account,ts.project=project,ts.branch=branch?branch:"master",revision?ts.baseURL="/"+account+"/"+project+"/revision/"+revision+"/":ts.baseURL="/"+account+"/"+project+"/revision/master/head/";var deferred=$q.defer(),url=ts.baseURL+"fulltree.json";return $http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(json){deferred.resolve(json.data)}),deferred.promise},search=function(searchString){var deferred=$q.defer(),url=ts.baseURL+"searchtree.json?searchString="+searchString;return $http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(json){deferred.resolve(json)}),deferred.promise};return{init:init,search:search}}angular.module("3drepo").factory("TreeService",TreeService),TreeService.$inject=["$http","$q","EventService","serverConfig"]}(),function(){"use strict";function colourPicker(){return{restrict:"EA",templateUrl:"colourPicker.html",scope:{title:"@",colour:"=",onColourChange:"&",offset:"@"},controller:ColourPickerCtrl,controllerAs:"vm",bindToController:!0}}function ColourPickerCtrl($scope){var vm=this;vm.red=200,vm.green=150,vm.blue=100,$scope.$watchGroup(["vm.red","vm.green","vm.blue"],function(newValues){vm.onColourChange({colour:newValues})}),$scope.$watch("vm.colour",function(newValue){Array.isArray(newValue)&&(vm.red=newValue[0],vm.green=newValue[1],vm.blue=newValue[2])}),vm.open=function($mdOpenMenu,event){$mdOpenMenu(event)}}angular.module("3drepo").directive("tdrColourPicker",colourPicker),ColourPickerCtrl.$inject=["$scope"]}(),function(){"use strict";function tdrProgress(){return{restrict:"EA",templateUrl:"tdrProgress.html",scope:{info:"="},controller:TdrProgressCtrl,controllerAs:"vm",bindToController:!0}}function TdrProgressCtrl($scope){}angular.module("3drepo").directive("tdrProgress",tdrProgress),TdrProgressCtrl.$inject=["$scope"]}(),function(){"use strict";angular.module("3drepo").directive("tdrFocus",function($timeout){return{scope:{trigger:"@tdrFocus"},link:function(scope,element){scope.$watch("trigger",function(value){"true"===value.toString()&&$timeout(function(){element[0].focus()})})}}})}(),function(){"use strict";angular.module("3drepo").filter("formatBytes",function(){return function(input,referenceValue){var factor,units,bytesInMB=1048576,bytesInGB=1073741824;return angular.isDefined(referenceValue)?referenceValue>1073741824?(factor=bytesInGB,units=" GB"):(factor=bytesInMB,units=" MB"):input>1073741824?(factor=bytesInGB,units=" GB"):(factor=bytesInMB,units=" MB"),(Math.round(input/factor*100)/100).toString()+units}}).filter("invoiceDate",function(){return function(input){var invoiceDate,date=new Date(input);return invoiceDate=(date.getDate()<10?"0":"")+date.getDate()+"-"+(date.getMonth()+1<10?"0":"")+(date.getMonth()+1)+"-"+date.getFullYear()+" "+(date.getHours()<10?"0":"")+date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes()}}).filter("prettyDate",function(){return function(input,showSeconds){var projectDate,date=new Date(input);return projectDate=(date.getDate()<10?"0":"")+date.getDate()+"-"+(date.getMonth()+1<10?"0":"")+(date.getMonth()+1)+"-"+date.getFullYear(),angular.isDefined(showSeconds)&&showSeconds&&(projectDate+=" "+(date.getHours()<10?"0":"")+date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes()+"-"+(date.getSeconds()<10?"0":"")+date.getSeconds()),projectDate}}).filter("prettyGMTDate",function(){return function(input){var date=new Date(input);return date.toISOString().substr(0,10)}}).filter("revisionDate",function(){return function(input){return moment(input).format("DD/MM/YYYY HH:mm")}})}(),function(){"use strict";function UtilsService($http,$q,$mdDialog,serverConfig){var obj={};return obj.snake_case=function(name,separator){var SNAKE_CASE_REGEXP=/[A-Z]/g;return separator=separator||"_",name.replace(SNAKE_CASE_REGEXP,function(letter,pos){return(pos?separator:"")+letter.toLowerCase()})},obj.capitalizeFirstLetter=function(string){return string.toString().charAt(0).toUpperCase()+string.slice(1)},obj.doGet=function(url){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.GET_API,url);return $http.get(urlUse).then(function(response){deferred.resolve(response)},function(response){deferred.resolve(response)}),deferred.promise},obj.doPost=function(data,url,headers){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.POST_API,url),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(urlUse,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.doPut=function(data,url){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.POST_API,url),config={withCredentials:!0};return $http.put(urlUse,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.doDelete=function(data,url){var deferred=$q.defer(),config={method:"DELETE",url:serverConfig.apiUrl(serverConfig.POST_API,url),data:data,withCredentials:!0,headers:{"Content-Type":"application/json"}};return $http(config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.showDialog=function(dialogTemplate,scope,event,clickOutsideToClose,parent,fullscreen){scope.utilsRemoveDialog=scope.utilsRemoveDialog||function(){$mdDialog.cancel()};var data={controller:function(){},templateUrl:dialogTemplate,onRemoving:function(){$mdDialog.cancel()}};data.parent=angular.element(angular.isDefined(parent)?parent:document.body),data.scope=angular.isDefined(scope)?scope:null,data.preserveScope=null!==data.scope,data.targetEvent=angular.isDefined(event)?event:null,data.clickOutsideToClose=!angular.isDefined(clickOutsideToClose)||clickOutsideToClose,data.fullscreen=!!angular.isDefined(fullscreen)&&fullscreen,$mdDialog.show(data)},obj.closeDialog=function(){$mdDialog.cancel()},obj.getServerUrl=function(url){return serverConfig.apiUrl(serverConfig.GET_API,url)},obj}angular.module("3drepo").factory("UtilsService",UtilsService),UtilsService.$inject=["$http","$q","$mdDialog","serverConfig"]}(),function(){"use strict";function WalkthroughService($interval,$timeout,$q,$http,serverConfig){function getWalkthroughs(account,project,index){var projectKey=account+"__"+project;angular.isUndefined(index)&&(index="all");var url="/"+account+"/"+project+"/walkthrough/"+index+".json",i=0,length=0;loading=$q.defer();var needLoading=!1;return walkthroughs.hasOwnProperty(projectKey)?walkthroughs[projectKey].hasOwnProperty(index)||(needLoading=!0):(walkthroughs[projectKey]=[],needLoading=!0),needLoading?$http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(data){for(i=0,length=data.data.length;i<length;i++)walkthroughs[projectKey][data.data[i].index]=data.data[i].cameraData;loading.resolve(walkthroughs[projectKey][index])}):loading.resolve(walkthroughs[projectKey][index]),loading.promise}var walkthroughs={},loading=null,saveRecording=function(account,project,index,recording){var postUrl="/"+account+"/"+project+"/walkthrough",projectKey=account+"__"+project;walkthroughs[projectKey][index]=recording,$http.post(serverConfig.apiUrl(serverConfig.POST_API,postUrl),{index:index,cameraData:recording}).then(function(){})};return{saveRecording:saveRecording,getWalkthroughs:getWalkthroughs}}angular.module("3drepo").factory("WalkthroughService",WalkthroughService),WalkthroughService.$inject=["$interval","$timeout","$q","$http","serverConfig"]}(),function(){"use strict";function walkthroughVr(){return{restrict:"EA",scope:{account:"@",project:"@",autoPlay:"@",animate:"@",fps:"@",rollerCoaster:"@"},template:"walkthrough.html",controller:WalkthroughCtrl,controllerAs:"wt",bindToController:!0}}function WalkthroughCtrl($scope,$q,$interval,$timeout,WalkthroughService,EventService){var wt=this;wt.initialized=!1,wt.frames=[],wt.loading=null,wt.frame=0,wt.autoPlay=!!angular.isDefined(wt.autoPlay)&&wt.autoPlay,wt.fps=angular.isDefined(wt.fps)?wt.fps:DEFAULT_FRAMES_PER_SECOND,wt.rollerCoaster=angular.isDefined(wt.rollerCoaster),wt.animate=angular.isDefined(wt.animate),wt.currentWalkthrough=wt.autoPlay?wt.autoPlay:-1,wt.recording=[],wt.isPlaying=!1,wt.isRecording=!1,wt.playInterval=null,wt.recordingInterval=null,wt.userWatchDog=null,wt.stop=function(){wt.isPlaying&&($interval.cancel(wt.playInterval),wt.isPlaying=!1)},wt.play=function(){wt.initialized||(wt.initialized=!0,wt.isPlaying=!0,$timeout.cancel(wt.userWatchDog),wt.frame=0,wt.playInterval=$interval(wt.tickFunction,wt.msPerFrame))},wt.startRecording=function(){wt.currentWalkthrough!==-1&&(wt.isRecording=!0,wt.recording=[],wt.recordingInterval=$interval(function(){var viewpointPromise=$q.defer();EventService.send(EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,{promise:viewpointPromise.promise}),viewpointPromise.then(function(viewpoint){wt.recording.push({position:viewpoint.position,up:viewpoint.up,view_dir:viewpoint.view_dir})})},wt.msPerFrame))},wt.stopRecording=function(){wt.isRecording=!1,$interval.cancel(wt.recordingInterval),WalkthroughService.saveRecording(wt.account,wt.project,wt.currentWalkthrough,wt.recording)},wt.tickFunction=function(){wt.loading&&wt.loading.then(function(){EventService.send(EventService.EVENT.VIEWER.SET_CAMERA,{position:wt.frames[wt.frame].position,up:wt.frames[wt.frame].up,view_dir:wt.frames[wt.frame].view_dir,rollerCoasterMode:wt.rollerCoaster,animate:wt.animate}),wt.frame===wt.numFrames-1?wt.frame=0:wt.frame+=1})},wt.recordButtonClass="btn walkthroughButton btn-success",wt.record=function(){wt.currentWalkthrough!==-1&&(wt.isRecording?(wt.stopRecording(),wt.recordButtonClass="btn walkthroughButton btn-success"):(wt.startRecording(),wt.recordButtonClass="btn walkthroughButton btn-danger"))},wt.userInControl=function(){wt.stop(),$interval.cancel(wt.userWatchDog),wt.userWatchDog=$timeout(function(){wt.play()},USER_CONTROL_WAIT)},wt.setCurrentWalkthrough=function(index){wt.currentWalkthrough=index,wt.loading=WalkthroughService.getWalkthroughs(wt.account,wt.project,index)},$scope.$watchGroup(["account","project"],function(){wt.currentWalkthrough=0,wt.loading=WalkthroughService.getWalkthroughs(wt.account,wt.project)}),$scope.$watch(["fps"],function(newFPS){wt.fps=newFPS,wt.msPerFrame=Math.floor(1e3/wt.fps)}),$scope.$on("$destroy",function(){wt.stop()}),wt.setCurrentWalkthrough(wt.currentWalkthrough)}angular.module("3drepo").directive("walkthrough",walkthroughVr);var DEFAULT_FRAMES_PER_SECOND=30,USER_CONTROL_WAIT=6e4;WalkthroughCtrl.$inject=["$scope","$q","$interval","$timeout","WalkthroughService","EventService"]}(),function(){"use strict";angular.module("3drepo").controller("VRDemoCtrl",["$scope",function($scope){$scope.showMenu=!0,$scope.demoOne=!1,$scope.demoTwo=!1,$scope.goDemoOne=function($event){$scope.showMenu=!1,$scope.demoOne=!0,$scope.demoTwo=!1,$event.preventDefault()},$scope.goDemoTwo=function($event){$scope.showMenu=!1,$scope.demoOne=!1,$scope.demoTwo=!0,$event.preventDefault()},$scope.backToMenu=function(){document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen||($scope.showMenu=!0,$scope.demoOne=!1,$scope.demoTwo=!1)},document.addEventListener("webkitfullscreenchange",$scope.backToMenu,!1),document.addEventListener("mozfullscreenchange",$scope.backToMenu,!1),document.addEventListener("fullscreenchange",$scope.backToMenu,!1),document.addEventListener("MSFullscreenChange",$scope.backToMenu,!1)}])}();
//# sourceMappingURL=three_d_repo.min.js.map