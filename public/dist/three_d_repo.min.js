function AnalyticService(){"use strict";function isGoogleAnalyticEnabled(){return"undefined"!=typeof ga&&null!==ga}function sendPageView(location){isGoogleAnalyticEnabled()&&ga("send","pageview",location.pathname+location.search)}function sendEvent(event){isGoogleAnalyticEnabled()&&(event.hitType="event",ga("send",event))}function setUserId(userId){isGoogleAnalyticEnabled()&&ga("set","userId",userId)}return{sendPageView:sendPageView,sendEvent:sendEvent,setUserId:setUserId}}function NotificationService(serverConfig,$injector){"use strict";function addSocketIdToHeader(socketId){var $httpProvider=$injector.get("$http");$httpProvider.defaults.headers.post=$httpProvider.defaults.headers.post||{},$httpProvider.defaults.headers.put=$httpProvider.defaults.headers.put||{},$httpProvider.defaults.headers.delete=$httpProvider.defaults.headers.delete||{},$httpProvider.defaults.headers.post["x-socket-id"]=socketId,$httpProvider.defaults.headers.put["x-socket-id"]=socketId,$httpProvider.defaults.headers.delete["x-socket-id"]=socketId}function joinRoom(account,model){var modelNameSpace="";model&&(modelNameSpace="::"+model);var room=account+modelNameSpace;joined.indexOf(room)===-1&&(socket.emit("join",{account:account,model:model}),joined.push(room))}function getEventName(account,model,keys,event){var modelNameSpace="";model&&(modelNameSpace="::"+model),keys=keys||[];var keyString="";return keys.length&&(keyString="::"+keys.join("::")),account+modelNameSpace+keyString+"::"+event}function subscribe(account,model,keys,event,callback){joinRoom(account,model),console.log("sub",getEventName(account,model,keys,event)),socket.on(getEventName(account,model,keys,event),function(data){console.log("msg rec",getEventName(account,model,keys,event)),callback(data)})}function unsubscribe(account,model,keys,event){console.log("unsub",getEventName(account,model,keys,event)),socket.off(getEventName(account,model,keys,event))}function subscribeNewIssues(account,model,callback){subscribe(account,model,[],"newIssues",callback)}function unsubscribeNewIssues(account,model){unsubscribe(account,model,[],"newIssues")}function subscribeNewComment(account,model,issueId,callback){subscribe(account,model,[issueId],"newComment",callback)}function unsubscribeNewComment(account,model,issueId){unsubscribe(account,model,[issueId],"newComment")}function subscribeCommentChanged(account,model,issueId,callback){subscribe(account,model,[issueId],"commentChanged",callback)}function unsubscribeCommentChanged(account,model,issueId){unsubscribe(account,model,[issueId],"commentChanged")}function subscribeCommentDeleted(account,model,issueId,callback){subscribe(account,model,[issueId],"commentDeleted",callback)}function unsubscribeCommentDeleted(account,model,issueId){unsubscribe(account,model,[issueId],"commentDeleted")}function subscribeIssueChanged(account,model,issueId,callback){3===arguments.length?(callback=issueId,subscribe(account,model,[],"issueChanged",callback)):subscribe(account,model,[issueId],"issueChanged",callback)}function unsubscribeIssueChanged(account,model,issueId){2===arguments.length?unsubscribe(account,model,[],"issueChanged"):unsubscribe(account,model,[issueId],"issueChanged")}function subscribeModelStatusChanged(account,model,callback){subscribe(account,model,[],"modelStatusChanged",callback)}function unsubscribeModelStatusChanged(account,model){unsubscribe(account,model,[],"modelStatusChanged")}function subscribeNewModel(account,callback){subscribe(account,null,[],"newModel",callback)}function unsubscribeNewModel(account,model){unsubscribe(account,null,[],"newModel")}serverConfig.chatHost&&serverConfig.chatPath||console.log("Chat server settings missing");var socket=io(serverConfig.chatHost,{path:serverConfig.chatPath,transports:["websocket"],reconnectionAttempts:serverConfig.chatReconnectionAttempts}),joined=[];return socket.on("connect",function(){addSocketIdToHeader(socket.id)}),socket.on("reconnect",function(){console.log("Rejoining all rooms on reconnect"),addSocketIdToHeader(socket.id);var lastJoined=joined.slice(0);joined=[],lastJoined.forEach(function(room){room=room.split("::");var account=room[0],model=room[1];joinRoom(account,model)})}),{subscribe:{newIssues:subscribeNewIssues,newComment:subscribeNewComment,commentChanged:subscribeCommentChanged,commentDeleted:subscribeCommentDeleted,issueChanged:subscribeIssueChanged,modelStatusChanged:subscribeModelStatusChanged,newModel:subscribeNewModel},unsubscribe:{newIssues:unsubscribeNewIssues,newComment:unsubscribeNewComment,commentChanged:unsubscribeCommentChanged,commentDeleted:unsubscribeCommentDeleted,issueChanged:unsubscribeIssueChanged,modelStatusChanged:unsubscribeModelStatusChanged,newModel:unsubscribeNewModel}}}var ViewerUtil,ViewerUtilListeners={},ViewerUtilMyListeners={};!function(){"use strict";ViewerUtil=function(){};var eventElement=document;ViewerUtil.prototype.cloneObject=function(obj){if(!obj||"object"!=typeof obj)return obj;var retObject=new obj.constructor;for(var key in obj)obj.hasOwnProperty(key)&&(retObject[key]=this.cloneObject(obj[key]));return retObject},ViewerUtil.prototype.triggerEvent=function(name,event){var e=new CustomEvent(name,{detail:event});eventElement.dispatchEvent(e)},ViewerUtil.prototype.onEvent=function(name,callback){ViewerUtilListeners.hasOwnProperty(name)||(ViewerUtilListeners[name]=[],ViewerUtilMyListeners[name]=[]),ViewerUtilListeners[name].push(callback);var myListener=function(event){callback(event.detail)};ViewerUtilMyListeners[name].push(myListener),eventElement.addEventListener(name,myListener)},ViewerUtil.prototype.offEvent=function(name,callback){var index=ViewerUtilListeners[name].indexOf(callback);index!==-1&&(eventElement.removeEventListener(name,ViewerUtilMyListeners[name][index]),ViewerUtilListeners[name].splice(index,1),ViewerUtilMyListeners[name].splice(index,1))},ViewerUtil.prototype.offEventAll=function(){for(var eventType in ViewerUtilMyListeners)for(var i=0;i<ViewerUtilMyListeners[eventType].length;i++)eventElement.removeEventListener(eventType,ViewerUtilMyListeners[eventType][i]);ViewerUtilListeners={},ViewerUtilMyListeners={}},ViewerUtil.prototype.eventFactory=function(name){var self=this;return function(event){self.triggerEvent(name,event)}},ViewerUtil.prototype.getAxisAngle=function(from,at,up){up=ViewerUtil.normalize(up);var x3dfrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),x3dat=new x3dom.fields.SFVec3f(at[0],at[1],at[2]),x3dup=new x3dom.fields.SFVec3f(up[0],up[1],up[2]),viewMat=x3dom.fields.SFMatrix4f.lookAt(x3dfrom,x3dat,x3dup),q=new x3dom.fields.Quaternion(0,0,0,1);return q.setValue(viewMat),q=q.toAxisAngle(),Array.prototype.concat(q[0].toGL(),q[1])},ViewerUtil.prototype.quatLookAt=function(up,forward){forward.normalize(),up.normalize();var right=forward.cross(up);up=right.cross(forward);var w=.5*Math.sqrt(1+right.x+up.y+forward.z),recip=1/(4*w),x=(forward.y-up.z)*recip,y=(right.z-forward.y)*recip,z=(up.x-right.y)*recip;return new x3dom.fields.Quarternion(x,y,z,w)},ViewerUtil.prototype.rotationBetween=function(prevUp,prevView,currUp,currView){var x3domPrevView=new x3dom.fields.SFVec3f(prevView[0],prevView[1],prevView[2]),x3domPrevUp=new x3dom.fields.SFVec3f(prevUp[0],prevUp[1],prevUp[2]),x3domPrevFrom=new x3dom.fields.SFVec3f(0,0,0),x3domPrevAt=x3domPrevFrom.add(x3domPrevView),prevMat=x3dom.fields.SFMatrix4f.lookAt(x3domPrevFrom,x3domPrevAt,x3domPrevUp),x3domCurrView=new x3dom.fields.SFVec3f(currView[0],currView[1],currView[2]),x3domCurrUp=new x3dom.fields.SFVec3f(currUp[0],currUp[1],currUp[2]),x3domCurrFrom=new x3dom.fields.SFVec3f(0,0,0),x3domCurrAt=x3domCurrFrom.add(x3domCurrView),currMat=x3dom.fields.SFMatrix4f.lookAt(x3domCurrFrom,x3domCurrAt,x3domCurrUp);return currMat.mult(prevMat.inverse())},ViewerUtil.prototype.axisAngleToMatrix=function(axis,angle){var mat=new x3dom.fields.SFMatrix4f,cosAngle=Math.cos(angle),sinAngle=Math.sin(angle),t=1-cosAngle,v=axis.normalize();return mat.setFromArray([t*v.x*v.x+cosAngle,t*v.x*v.y+v.z*sinAngle,t*v.x*v.z-v.y*sinAngle,0,t*v.x*v.y-v.z*sinAngle,t*v.y*v.y+cosAngle,t*v.y*v.z+v.x*sinAngle,0,t*v.x*v.z+v.y*sinAngle,t*v.y*v.z-v.x*sinAngle,t*v.z*v.z+cosAngle,0,0,0,0,1]),mat},ViewerUtil.prototype.evDist=function(evt,posA){return Math.sqrt(Math.pow(posA[0]-evt.position.x,2)+Math.pow(posA[1]-evt.position.y,2)+Math.pow(posA[2]-evt.position.z,2))},ViewerUtil.prototype.dist=function(posA,posB){return Math.sqrt(Math.pow(posA[0]-posB[0],2)+Math.pow(posA[1]-posB[1],2)+Math.pow(posA[2]-posB[2],2))},ViewerUtil.prototype.rotToRotation=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo);return crossVec.x+" "+crossVec.y+" "+crossVec.z+" "+Math.acos(dot)},ViewerUtil.prototype.rotAxisAngle=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo),qt=new x3dom.fields.Quaternion(crossVec.x,crossVec.y,crossVec.z,1);return qt.w=vecFrom.length()*vecTo.length()+dot,qt.normalize(qt).toAxisAngle()},ViewerUtil.prototype.scale=function(v,s){return[v[0]*s,v[1]*s,v[2]*s]},ViewerUtil.prototype.normalize=function(v){var sz=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return this.scale(v,1/sz)},ViewerUtil.prototype.dotProduct=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},ViewerUtil.prototype.crossProduct=function(a,b){var x=a[1]*b[2]-a[2]*b[1],y=a[2]*b[0]-a[0]*b[2],z=a[0]*b[1]-a[1]*b[0];return[x,y,z]},ViewerUtil.prototype.vecAdd=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},ViewerUtil.prototype.vecSub=function(a,b){return this.vecAdd(a,this.scale(b,-1))},ViewerUtil.prototype.escapeCSSCharacters=function(string){return string.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g,"\\$&")},ViewerUtil=new ViewerUtil}();var ClipPlane={};!function(){"use strict";ClipPlane=function(id,viewer,axis,normal,colour,distance,percentage,clipDirection,parentNode){var self=this;console.log("Clip plane created"),this.clipDirection=void 0===clipDirection?-1:clipDirection,this.distance=distance,this.normal=void 0==normal?[0,0,0]:normal;var volume=null,sceneBbox=null,clipPlaneElem=document.createElement("ClipPlane"),coordinateFrame=document.createElement("Transform"),outline=document.createElement("Shape"),outlineApp=document.createElement("Appearance"),outlineMat=document.createElement("Material"),outlineLines=document.createElement("LineSet"),outlineCoords=document.createElement("Coordinate"),BBOX_SCALE=1.0001;this.getID=function(){return id};var setOutlineCoordinates=function(axis){var min=volume.min.multiply(BBOX_SCALE).toGL(),max=volume.max.multiply(BBOX_SCALE).toGL(),axisIDX="XYZ".indexOf(axis),outline=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],minor=(axisIDX+1)%3,major=(axisIDX+2)%3;outline[0][minor]=min[minor],outline[0][major]=max[major],outline[1][minor]=min[minor],outline[1][major]=min[major],outline[2][minor]=max[minor],outline[2][major]=min[major],outline[3][minor]=max[minor],outline[3][major]=max[major],outline[4][minor]=min[minor],outline[4][major]=max[major],outlineCoords.setAttribute("point",outline.map(function(item){return item.join(" ")}).join(","))};this.determineOutline=function(vertices){for(var min=vertices[0].slice(),max=vertices[0].slice(),i=1;i<vertices.length;++i)for(var j=0;j<3;++j)min[j]>vertices[i][j]&&(min[j]=vertices[i][j]),max[j]<vertices[i][j]&&(max[j]=vertices[i][j]);for(var centrePnt=new x3dom.fields.SFVec3f((max[0]+min[0])/2,(max[1]+min[1])/2,(max[2]+min[2])/2),outline=[vertices[0],null,null,null],basePnt=new x3dom.fields.SFVec3f(vertices[0][0],vertices[0][1],vertices[0][2]),baseToCen=basePnt.subtract(centrePnt),i=1;i<vertices.length;++i){var currentPnt=new x3dom.fields.SFVec3f(vertices[i][0],vertices[i][1],vertices[i][2]),curToCen=currentPnt.subtract(centrePnt),dotProd=Math.abs(baseToCen.normalize().dot(curToCen.normalize()));Math.abs(dotProd-1)<.01?outline[2]=vertices[i]:outline[1]?outline[3]=vertices[i]:outline[1]=vertices[i]}return outline.push(vertices[0]),outline},this.movePlane=function(axis,distance){axis=axis.toUpperCase(),this.normal=["X"===axis?this.clipDirection:0,"Y"===axis?this.clipDirection:0,"Z"===axis?this.clipDirection:0];var axisIDX="XYZ".indexOf(axis);volume.min.multiply(BBOX_SCALE).toGL(),volume.max.multiply(BBOX_SCALE).toGL();self.distance=distance,clipPlaneElem.setAttribute("plane",this.normal.join(" ")+" "+self.distance);var translation=[0,0,0];translation[axisIDX]=-self.distance*this.clipDirection,coordinateFrame.setAttribute("translation",translation.join(",")),setOutlineCoordinates(axis)},this.transformClipPlane=function(matrix,writeProperties){var min=volume.min.toGL(),max=volume.max.toGL(),point=min,normal_x3d=new x3dom.fields.SFVec3f(this.normal[0],this.normal[1],this.normal[2]),planePnt=normal_x3d.multiply(-this.distance);if(point=planePnt.toGL(),matrix){normal_x3d=matrix.multMatrixVec(normal_x3d),normal_x3d.normalize(),planePnt=matrix.multMatrixPnt(planePnt);var distance=-normal_x3d.dot(planePnt)*BBOX_SCALE,plane=new x3dom.fields.SFVec4f(normal_x3d.x,normal_x3d.y,normal_x3d.z,distance)}else var plane=new x3dom.fields.SFVec4f(normal_x3d.x,normal_x3d.y,normal_x3d.z,this.distance);if(writeProperties){clipPlaneElem.setAttribute("plane",plane.toGL().join(" "));var translation=[.001*-(max[0]-min[0]),.001*-(max[1]-min[1]),.001*-(max[2]-min[0])];coordinateFrame.setAttribute("translation",translation.join(" ")),this.normal=normal_x3d.toGL(),this.distance=distance;for(var min=sceneBbox.min.multiply(BBOX_SCALE),max=sceneBbox.max.multiply(BBOX_SCALE),bboxOutline=[[new x3dom.fields.SFVec3f(min.x,min.y,min.z),new x3dom.fields.SFVec3f(max.x,min.y,min.z)],[new x3dom.fields.SFVec3f(min.x,min.y,min.z),new x3dom.fields.SFVec3f(min.x,max.y,min.z)],[new x3dom.fields.SFVec3f(min.x,min.y,min.z),new x3dom.fields.SFVec3f(min.x,min.y,max.z)],[new x3dom.fields.SFVec3f(min.x,max.y,min.z),new x3dom.fields.SFVec3f(min.x,max.y,max.z)],[new x3dom.fields.SFVec3f(max.x,max.y,min.z),new x3dom.fields.SFVec3f(max.x,max.y,max.z)],[new x3dom.fields.SFVec3f(max.x,min.y,min.z),new x3dom.fields.SFVec3f(max.x,max.y,min.z)],[new x3dom.fields.SFVec3f(max.x,min.y,min.z),new x3dom.fields.SFVec3f(max.x,min.y,max.z)],[new x3dom.fields.SFVec3f(max.x,min.y,max.z),new x3dom.fields.SFVec3f(max.x,max.y,max.z)],[new x3dom.fields.SFVec3f(min.x,min.y,max.z),new x3dom.fields.SFVec3f(max.x,min.y,max.z)],[new x3dom.fields.SFVec3f(min.x,max.y,max.z),new x3dom.fields.SFVec3f(max.x,max.y,max.z)],[new x3dom.fields.SFVec3f(min.x,max.y,max.z),new x3dom.fields.SFVec3f(min.x,min.y,max.z)],[new x3dom.fields.SFVec3f(min.x,max.y,min.z),new x3dom.fields.SFVec3f(max.x,max.y,min.z)]],outline=[],i=0;i<bboxOutline.length;++i){var lineDir=bboxOutline[i][1].subtract(bboxOutline[i][0]);lineDir=lineDir.normalize();var dotProd=lineDir.dot(normal_x3d);if(Math.abs(dotProd)>1e-6){var d=planePnt.subtract(bboxOutline[i][0]).dot(normal_x3d)/dotProd,intersectPnt=lineDir.multiply(d).add(bboxOutline[i][0]);intersectPnt.x>=min.x&&intersectPnt.x<=max.x&&intersectPnt.y>=min.y&&intersectPnt.y<=max.y&&intersectPnt.z>=min.z&&intersectPnt.z<=max.z&&outline.push(intersectPnt.toGL())}}outline=this.determineOutline(outline),outlineCoords.setAttribute("point",outline.map(function(item){return item.join(" ")}).join(","))}return{normal:normal_x3d.toGL(),distance:distance}},this.getProperties=function(matrix){var res=JSON.parse(JSON.stringify(this));if(matrix){var newValues=this.transformClipPlane(matrix,!1);res.normal=newValues.normal,res.distance=newValues.distance}return res},this.destroy=function(){clipPlaneElem&&clipPlaneElem.parentNode&&clipPlaneElem.parentNode.removeChild(clipPlaneElem),coordinateFrame&&coordinateFrame.parentNode&&coordinateFrame.parentNode.removeChild(coordinateFrame)},sceneBbox=viewer.runtime.getBBox(viewer.getScene()),(normal||""!=axis)&&(outlineMat.setAttribute("emissiveColor",colour.join(" ")),outlineLines.setAttribute("vertexCount",5),outlineLines.appendChild(outlineCoords),outlineApp.appendChild(outlineMat),outline.appendChild(outlineApp),outline.appendChild(outlineLines),coordinateFrame.appendChild(outline),viewer.getScene().appendChild(coordinateFrame),volume=parentNode?viewer.runtime.getBBox(parentNode):sceneBbox,normal||this.movePlane(axis,distance),viewer.getScene().appendChild(clipPlaneElem),normal&&this.transformClipPlane(parentNode._x3domNode.getCurrentTransform(),!0))}}();var Collision={};!function(){"use strict";Collision=function(viewer){var self=this;this._deltaT=.1,this.deltaX=0,this.deltaY=0,this.ticking=!1,this.prevMove=0,this.stopped=!0,this.viewer=viewer,this.updateDirections=function(event,gamepad){var speed=self.viewer.nav._x3domNode._vf.speed,userX=self._deltaT*speed*(gamepad.xaxis+gamepad.xoffset),userY=self._deltaT*speed*(gamepad.yaxis+gamepad.yoffset);0===userX&&0===userY?self.stopped=!0:self.stopped=!1,self.stopped?(self.userX=0,self.userY=0):(self.userX=-userX,self.userY=-userY,self.ticking||self.tick())},this.tick=function(){self.ticking=!0;var viewArea=self.viewer.getViewArea(),straightDown=new x3dom.fields.SFVec3f(0,-1,0),straightUp=new x3dom.fields.SFVec3f(0,1,0),right=new x3dom.fields.SFVec3f(-1,0,0),currProjMat=self.viewer.getProjectionMatrix(),currViewMat=self.viewer.getViewMatrix(),flyMat=currViewMat.inverse(),from=flyMat.e3(),tmpFlatAt=flyMat.e3(),viewDir=currViewMat.inverse().e2().multiply(-1),viewX=viewDir.x,viewZ=viewDir.z;self.deltaX=self.userX*viewZ+self.userY*viewX,self.deltaZ=-self.userX*viewX+self.userY*viewZ,tmpFlatAt.x+=self.deltaX,tmpFlatAt.z+=self.deltaZ;var tmpTmpMat=x3dom.fields.SFMatrix4f.lookAt(from,tmpFlatAt,straightUp);tmpTmpMat=tmpTmpMat.inverse(),viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpTmpMat,currProjMat.mult(tmpTmpMat));var dist=self.viewer.avatarRadius+1;if(viewArea._pickingInfo.pickObj&&(dist=viewArea._pickingInfo.pickPos.subtract(from).length()),!self.stopped&&dist>self.viewer.avatarRadius){var tmpUp=tmpFlatAt.subtract(from).normalize();right=straightDown.cross(tmpUp),tmpUp=right.cross(straightDown),from.x+=self.deltaX,from.z+=self.deltaZ;var tmpDownMat=x3dom.fields.SFMatrix4f.identity();if(tmpDownMat.setValue(right,tmpUp,straightDown.multiply(-1),from),tmpDownMat=tmpDownMat.inverse(),viewArea._pickingInfo.pickObj=null,viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpDownMat,currProjMat.mult(tmpDownMat)),viewArea._pickingInfo.pickObj){dist=viewArea._pickingInfo.pickPos.subtract(from).length();var movement=.5*(self.viewer.avatarHeight-dist+self.prevMove);from.y+=movement,self.prevMove=movement}var up=flyMat.e1(),tmpMat=x3dom.fields.SFMatrix4f.identity();right=up.cross(flyMat.e2()),tmpMat.setValue(right,up,flyMat.e2(),from),viewArea._scene.getViewpoint().setView(tmpMat.inverse()),self.viewer.runtime.triggerRedraw()}self.nextTick()},this.nextTick=function(){window.requestAnimationFrame?window.requestAnimationFrame(this.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(this.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(this.tick)},ViewerUtil.onEvent("gamepadMove",this.updateDirections)}}();var Gamepad=function(viewer){var self=this;this.enabled=!1,this.gamepad=null,this.timestamp=null,this.browser=null,this.platform=null,this.viewer=viewer,this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){self.gamepad&&(self.gamepad.timestamp&&self.gamepad.timestamp==self.timestamp||(self.timestamp=self.gamepad.timestamp))},this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){if(self.gamepad&&(!self.gamepad.timestamp||self.gamepad.timestamp!=self.timestamp)){self.timestamp=self.gamepad.timestamp;var button_idx=0;"Linux"===self.platform&&"Chrome"===self.browser?ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.axes[0],yaxis:self.gamepad.axes[1],xoffset:0,yoffset:0,button:self.gamepad.buttons[button_idx]}):"Win32"===self.platform&&"Chrome"===self.browser?(button_idx=3,ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.buttons[15].value-self.gamepad.buttons[14].value,yaxis:self.gamepad.buttons[13].value-self.gamepad.buttons[12].value,xoffset:0,yoffset:0,button:self.gamepad.buttons[button_idx]})):"Win32"===self.platform&&"Firefox"===self.browser&&ViewerUtil.eventTrigger("gamepadMove",{xaxis:self.gamepad.axes[0],yaxis:self.gamepad.axes[1],xoffset:0,yoffset:.15,button:self.gamepad.buttons[button_idx]}),self.gamepad.buttons[button_idx].pressed&&(self.oldButton||(viewer.reset(),viewer.setNavMode("NONE"),viewer.setApp(null),viewer.disableClicking())),self.oldButton=self.gamepad.buttons[button_idx].pressed}},this.tick=function(){navigator.getGamepads()[0]&&(self.gamepad=navigator.getGamepads()[0]),self.gamepad&&self.checkStatus(),self.nextTick()},this.nextTick=function(){this.enabled&&(window.requestAnimationFrame?window.requestAnimationFrame(self.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(self.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(self.tick))},this.stopPolling=function(){self.enabled=!1},this.init=function(){var gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;gamepadSupportAvailable&&(window.navigator.platform.indexOf("Linux")!=-1?self.platform="Linux":window.navigator.platform.indexOf("Win32")!=-1||window.navigator.platform.indexOf("Win64")!=-1?self.platform="Win32":console.error("Platform "+window.navigator.platform+" is not supported."),window.navigator.appVersion.indexOf("Chrome")!=-1?self.browser="Chrome":window.navigator.appVersion.indexOf("Firefox")!=-1?self.browser="Firefox":window.navigator.userAgent.indexOf("Firefox")!=-1?self.browser="Firefox":console.error("Browser version "+window.navigator.appVersion+" is not supported."),self.browser&&self.platform&&("ongamepadconnected"in window?(window.addEventListener("gamepadconnected",self.connected,!1),window.addEventListener("gamepaddisconnected",self.disconnected,!1)):self.startPolling()))}},logo_string="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAB0CAMAAACcw5TeAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA/SAAAP0gH7iTvJAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAwBQTFRF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////vy5IYQAAAP90Uk5TAAECAwQFBgcICQoLDA0ODxAREhMUFRYXGBkaGxwdHh8gISIjJCUmJygpKissLS4vMDEyMzQ1Njc4OTo7PD0+P0BBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWltcXV5fYGFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6e3x9fn+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKztLW2t7i5uru8vb6/wMHCw8TFxsfIycrLzM3Oz9DR0tPU1dbX2Nna29zd3t/g4eLj5OXm5+jp6uvs7e7v8PHy8/T19vf4+fr7/P3+6wjZNQAAJfNJREFUeNrdnQd8FMX7//eSkBAIkIRA6L0JIkWQIiBfQQEBQREFld6b0kQsKE2kdxQUNAgifCkiSKRLF5ASSkILgUgSAmkkIf3u9j/PM7N3e3ezc7uX/+/1+5l5vcgdye7O7r535/nMzPM8I0mslOi1eu/Fm6Jy/cimSXUkpzLhpt5y4/yvS7v4SrrLPt1Hjjr+y/SGUtEqod/myLrKxW6OO86SDZWMr8roPaUbxo58/Y2ixGPsU/1Xfji0EEBkOeXN/xkgsnyiUlHB4bMWrsdyeuGU0aIyftaWFNjwQVMXILtH6yjTVlyBba0zDQCxbljuvqzcctYMG8c3KyJANsDVbKihY0u/qWlk09TazkDye+irqfFm2HqmgTfkL31NXOD4BLJxWp0iweMjuPC4UH0br4ONI0upgRQYINIpDx77vgaarPNB+o48Eza+WboI8KhTgBcepYvIcnqX5quBnFmgm0gnKh1SA/UBWRZDNr5UVs+RP6EntqAIANlKruO+TiKMh5xbVQ1E0kukkyLlFusDMrHyHbLxlXLuN1a0Rc6/37BXtMry1uBLuogstymamQ5AdBKx8ZCf+ukDIlW8CS1kBXfbLrCd2Ox/PZAx5CqekZBI2n1xiYPWhgrkC45A8I4UuNn9fj7Z6B96317TCUQqf51s/cTNgR9A7WbaT/rXA9kjyxHkA4m4L9Y27ZGINcgRiOoZFZa9xffj53K9QKSQCH1HHvw2ErGW/bcDiZTl1fAZnKTrug+WoESaOQGRfta1e34P/6PwuUc3ECn4ka4jHy3RG95AucW/HUiGLH+OX27B5ZhXL0wnH5kLV8LzFjl/L/zy+PwT9gs/FtD+KTE7vZyBULN6bv5F+Ng+/y50Nb9ZDgru8fzv1ERKniQfl/UDYfp3/UJ4EDIXrYATuzd/D/bN5x9XE3ktl5zYm/92IORSPrADkc+UaQl9v01efcmFW0d5Qacxq0PxA/YLP126PelMDOIDyX+99CnykVC/EhzubJnX4aldJI1VEylFmMUYBhIR/GIm+djs1QeITDHBiWV39PtDTaQzObHBRQkI9Nr+DmqWYiMiTzCtB1HUfhUMDMrKFrH261YDgR0KepX8k3wkNqwQCS9MmR5AZD72B1OJXEYiCzwBIl8MbJuJJ4ZEPjDRRwWEH1RhRSL3ihiQ6WDZL4c8l2QnMtUE7Q18e9KO/PgEtoggfx/CAfJwAhDp7X+QfCQ1LncV+tmB3fPY/msWynI46uNzhoFsAa11rnQbeCZ+okTGIBH4lteL/JgbD0QSihiQcUFgAa6FNky0E/nMtI4OnLfyh9ugqLGhHCCPpSlA5A2/fTCq26wsbPp34Gt5uMMaEGKHFDVmEMiKUOiPnA5oDUTCkIh1OBIhPLr6kZ9D6sQztVWUgCQ9G3SB/P9GpfoJdiKzvaDNeNpWAiCJDRiRYTwbslKaDkTe9P0VejUtgv6GHkvQLMoDWFhHMyIGgSQ3rhQNRrxkK5AcPyIRyyDT38hDAiCRoXUTih4QQiQQLvJpIrTWcnIiCkkwKdkdJAQiJz5DiYzgGvXF0hfQjiSihM5NBHkgpxdQHojCOoYSMWpDkhtXIfZBvn0sFg38MajAcobyQCDyzYr1EooeECByniPyc16WGBD5ESUykq+yvpbm8DoJa+x9x3H4adioJzeu/g/nwMCDApHvVKn3sOgBIUTKcDpiH0k2IPKjhsFEL43iA5Fn4WClU7mgHnAaL23zRGUlN66V4Xrk6ZINiBxTvX5mEQOSikTIl79mqoryPvhT6So/bkTajdEcILlgvj8n9z1TvTsxx0cVIMmgTicYl73pSIQ0WmdVB4Z3cbQC5DH5F1urqMneCdD/TSI2Y6lqA5MayITfYQtyf8bwZC92Ou6TfqG6gt9UQMKHA5Fow0BWgvZOfuI4BuanBjISTj0utYgBmea7h779mkCm+O6jW4zlAEn1602HXDWBnJZGWD1RWT+afpRdBiUdgEz03VsEZW9ed0ZEE0j2y37hzBJwbEi4HwplbSBEGI+0egDEOtxrsxhITiff34ug7M3vRYloAiEXToePJnCNerhff4sQiPytabTVA5VlGei9TQhEzumM/dGiprIK+iARbSBw4ftt+7iorHC/gRYhEHm91xirByrL0s9npxCInPsKvrxFTfaa+/nGCYHIOa8UJ92yDzVkb7jfWjEQeaPX957IXvObxRKFQOTcV/0eqYD0OOtROaPsv1v3Lqd3rRimPf1dpv+S/54S7n/4xy/beXGBnINHccAtAZBzeOGxyr1yBPIEmIavEAC5mUy22LLEMBBwwijocU8AJApOrIta9g6VPSoWZf9/DO1mPfEy9ypa7CvQtX/y14HOQIgYHTkRzihHAGTkJLjwbFmezJO9lWPoCL227H0OiGQZBrL8AzhwlgDIkPlsi/8lIKT84eqLEbDZqnv31KEOQDqfJV/2FfvQjexdK02iW0zhAMmux4Y3NIFEByERw0B2SxPcyN5ZypiNE5CombrLeh6Qb3Ts+MWycPSniXN2Za2OvrP5R1Z+Kdx/zobbWNcKbxuQF/+kV7O72AQxEHk+IzKVZ0Pia9WOF8vei8GUiFEbslwaJwZiHS3N4AGx9WDdlop3eECuh+jaueSMLJiiaOTwy1DwhkmepsebstUZdOdlQL7bZ3tvdhcbLwYiL6BEPuIa9dhq9RLFsvcSJWLYqC+XxlrFKmsCjv27ALEO18cj9Aa/yYoI1rf/Stj4vhpfcWh0bKOwbkqtdOUxt7FY1eAGEhknBiIvRCLT+CrrbuWGSWKVdbksEDGuspZLIJdFKmuyNNkZyFQrzJvouSEhMOMcfdcRyEZoci7o8XuVZtNz+EH1q0+ZOtSze02Kv6C2CshfpStEIZFbYiDyYimWDbNyZO/tCgvcyN6Isp7NqS+X7omByB9LziqrFDxdlnfdVxaM3l/txzoCWVIOHQNK6+YhW+yNVtkMOiiqh0hNRUFsVQEhREKh/t0xAiC/gYhbQoB8wgGSAg1h1A8CIBdAGF/ZYBjIcRh5Xy4Csh3GNWe4AJFQN7r1tg9E5yU5drETEKnCLZw61stDltfZfvcx+d/Ls3URsfGQrZVVQOSoOQNi3aiskb2YrP6UJ3tLn5PFKiu84i2P5tSXt33qRmUN7glELC5ApGlwSyLcFJAiT1xtyBJJwqnjB252BxcMczbuHm87vTPo1zpbT/Up9upHSFX7rbpkdtbEmkC2ezMin3GA5L/InjRNIIl1GBGDQC6X7pAtBrLDG4m4ApE+09cNuBK0hwdEqnpP3/4D/kNdyZU2K8hCbfRsfbtfZdVvp/2Xzl8ezNQFRP6ZEfmcZ0Oetgu+Ipa9CQ0oEaM25HTAyzniwcVfGBEXINIqXXek4HUco3MBItXI1BfhGNAF3WsUl87nyfcX4MtqXbub+2D1VrtLp3fTcVti3QORt1AiX3CN+tP25a6LZe+jRkjEsFE/XuLVPLHs3UqJuAKh+vdOGPa1joVBGyT/FgZTjFlhW0FLPwyDuZT8buh27AKE6d/tYWDHMsN2oLEJO4SOs2FR9lt6MqBHgdU+L9Gb/Kqqunr0ej2pVA/aP+enrfaOvLkvVp/ieBOqvLPyotmN7P3FuxfZ5Eu+ysrqAB5UIpWV9FzF256orCP+3QvEKmubT88CbSDmPl7gD/6gNoacXAx6Fm7JamkY3JIPpfk4XFzylDaQEwGtgMgKCUZxLENM30K7/0LwZTuRU6X6kGZqhqr60urqvX9GhwQUTheDGkP1P3kPUxF526F61fgLab9maQGx4qMYa4/YUQOBP2a9JJK9ADuluWey94CfO9n7X5972kDII+i93U7kUnDTNDuRSdJSeGI7jtUAYsE34IV024SOZajpG3hh2sOAjTmfXtnpUkmOQGzVk/3Nb3lvxuex3BWs/lnwZPpv9UQ6tge7m98ZywXiXByAzAGv9m3xMHbEUVlzYU7xhADIfpiJfXLQMJAdMKzxe5wAyGLwldn+QAvIR/gIFvvNTuRycMsMO5HJ0hq4Mz9rAFlzDt8AJLLeaxi5v9ZhaBxyUdaS5m8avEdn0jWADDVD9V6b7B6dl4MbQaMJhvE4EYKRqMYOGQcyqspdx9AxNZBEaaEb2fuH14+eyd5Kd9zJ3gYPZb7Kwi/FYODF/I5vuIpI2TZP7USmmL7nyl76ZV6Zs/gGtHyCEzowCWcdwdQC6WaQW/u20pfgAvF9D4i847URPDpbBp3H6htSf6vjJcmLEaWoMaNAoqswInN4NuQzaZkYiPktRsQgkNgalW6LgZwuXTdOAGQ6eleY+xU/ZCcSURa1NCMy1esnbSCpTUv/BW9A6RZpqGv6g3PxSOk06/YRIDcqMCJcIOtN7wKRfl5h4MrZugwcLCLkFcoDgzU+ZESMApHvMiJfcY36R1TkaRt1c19KxKgNia1B5bK2DTkbWCtWGwhRhYPJY23ZgWo/YesxHObZehPjSraiD+re7QWaQIAIDEPEReBTHR0BUtgaqXTDofG5yYhwgRAi/cAdOeIqKp8IfN8fplAeNHpmIiViGIh8tyoS4QORJ2L0gkBlkZb0R09kb2yNCjfFsvdCcPUYgeydI71nMTpBpVJZqU1LneZ1H3BYBIDItyoiET4QQuQdM2d/4MHCmSYhET6Q0fvVxUn2xlSrYtaYDwHXXdNesewlLenvnqgsQoQ0F/dV53XASWVFhFR5IlBZC6TRhQACRG67bk0HvREIEMnRBEKIjHLd/THwUOLLpkjfagFZ4bzjAgUITMPca05+9OcNnaCtE8neTHSjMC57odrYF9Ndr2ixAgSOfL28puwFY7G0Lcz9rHVTvuEByUIiRB1eUm0Jb/oABQjUf7uSluyF6te/6FT9NdLcSAxINry9U8fqBoLzbui5eIpdfGue7B1kpS2r9uAiZMAwXzEMZNVmrQd6HAMyAeJSbyRpAekEggo2KabbHUcNZCH0z1Pv2FtqHLJXAxkByulOpgYQrP6sU/UrVUAiBwCRi2Igf7Km4bCVzrsBkPEBp6gLvBcHSJLXcKtYZR1VcpIYBLKWOS5GObSleGIjmTEJOCGSvaXaseFiz4As9dlOd9cEMrDMeYHs5VavBhJtGmARqCwK5IA/++8YOu+G3u/NKZHVEs+GbPIaIwYif8qIGARi7tsARrKOlHDcZBQQGYJA0pozInwgh/1fzCwEkPzePtvEQJKbMCJcIEdLcqpXA5HXMiLCJst2/ThY8C4a9bQWlcitMTfhAiFEPhADkWdSIkaNujkJ76rzNuAobHkfjbpCRMOoH/bHGF4PgZAOlM9WIRDyqFIifKN+opRr9Q5A5A1eSEQTSDyIzOMB6gsfhJSenMIhNj4QQmSqGIg8D4l4MJYlH/J33QjaSPNAWUVES2Ud9scYXg+ByOb+3r8IgchPXkAiGirrTGmX6h2ByD95AxFNIFHYmT2tTCdjP9dmSe+V0gJCiGx0M6e+SNroEZCD/rythtlPjBBJEsjew/5vFgIIuHtfFgKRM9qUydSWvecD3xQDkX/xmS0CImHX+Fyg6lFUyoMaEhdIBsbuLhY5yuHc+EJPgBwozt9sKDWGD5CIpuyFYZXDnTwGch1aiGEHBUAu4WyQluyFDvrFngIgj2ASefuHQiCUSLQiaVJUIYP+fCAP6ydSUawtezHQPMUTIMf2axTqCjkMZFgaMW+vc4HUiWFp2jwD8tVQkA9pAiBvw/uflasBpMIlFs2sKXvrxtMtREAkxSPBpWziA8ms1DBJrLIi/VtneKKy3JcFTBjLDblAKle5UxjZu1MaYhGrrC+UFpkL5Lmgi2LZ+zikbrxY9gIQn92uFx73NlxZF74NuVXhuRSxyjpSghL5/w5EnkSJWItzgdwIrXijEECIzB9sEQKxpUTgAnncCDMyCGzIVUZEBMTnv8ps8e5s+4VPrEnapJgSfKMeWa5ZmlhlHaVEDANJ330YR0h3oxPstd33VUH0u3+32IhclfhG/UZo6PVCACFEYBJEYNSVlAh8o/64EWZkEBj1a+WQiAAIxpDdx5H7su1UIeKTx6gSOTirrCtlW6aLVdafJYGI8TfkU+lLON/3MMNJ6vMVVO4Fm32xQZnU1sGV1knm3AjF3HTPNtAsxYQqa7UEqnStavtWTiqLpkTQUFmEyHmxyrpWHohoA/HGjtA76Pt2OXiKeoTzLnlptGTvpaBFbmTvsZKLPGqyPlMTSe98keZlugCTGCfKIhEi8pL9tYAQIh3FjV5dIRBC5DjHG0sFRB4vJWvL3seN2rmRvdfLjxcAubUFN0p/PhAavygYuIBZ/QNmqiGtVThAUuERPC8KabsGb+XxNYaBnM1BVzAVESjfh5PuVEewWnfqMqM7Q+IDOQJELnsM5BRcP28+5EIQA4I+XRO0ZC9U/3ikAMgDaE8jZ7kZOoG7kPKs4umyFF1J+7JeWGee7A25Rh1TtGUvJlEyG59TfyUPZ/0ciFwuTjo0t4vXhjcopf0XGMTkrQGkVLh7WSAA8lWXXI2dkAgB0hfjVywaQEoDrwKR7MXsq2YxkLia6ElUPySK+s4BkE2mXvma+bJym5W/IZa9sRVZWiuDQP7yfw2q/VIhAmOv6bWlAcDArwzMVOXD03O1lKQB5FW/gyg6OnfklNfi3AH507czPIj5Qx32ezWaESFAvmURRXwg3ZRUhFpA0hsgETGQ7HXr4bmMX5tKXef8aVTza7myludiarOKt8Wy93ZlSsSoDdnv9zo8YDvXQnNtCYNj9JakpvhW+HkzZ9Hz1SQtIDlD4zGpFq+iEkfd25A9iyCEsbvTnji8RIjASS1hRLhA8nqwfAuaNuRRI0pE7wTVUtsU7k/enbM159RTm2Hcp8Co362GRAwb9b3F+jjOSS+CmSkzjcSWxpAv2ZO9JU0gWCLL8+rxP6LPqMt5rtmf8SZeCEKjzojwjXp+b5rWQNuoJzfBg+kEskE1p77V5yXy4szlq6zUZtVixSrrfk0gYlxl7fRx8BKI9rH/aZ+fFAa9aUkM5Do3h7w/9G8u/+AeSF43zt7o9HaBzi1TIhoqy9wXU38IVFZqcyDCBzJoq7o4R1Dt8o3V8MtCIu4iqB7U8cyVdKv3PSL+8IwgGyH+iXVdf/edTkSUGyDXuDzQUUv+oJZbILlduGcZpMr3tkRK0pa95v5t3cjeJy944Eq6DPySfn+o4bkITlmpfwiAHAY384RfDQMJB7fEn2IVNyCIJcTwyhmynAEjqXv7ERHjKwQSVaU4p5Q+SE3pbLdApjXllw40ZGAujHEueQpxdZzqIZrK8q0AyA1Y5Chjk3EgI595pGSO48he03fuIqiUJEpGs5LWf6h2Je1Cvr0EX8Dnvy4QAZ+1xm6aLK0Sq9OGCEtfFoAvv8/1ZJ0oi1VWpGmtZ66kV8sxIjN5TdY4dF4VAMntwogYBJLUkGa4ZEAqK/HndaBHFHKVXks/z4A8DhpnLTyQC0pKhA686pdIH4qBWAYzIoY9F68xItz4EOsInOcU2JC8rpSIURuSWI8OhjLPxSfMzcIrG9KaMyJzPHxDVrBJrkIBUYjkB3CrX4JhJQIbYhlKiRh3Jb1WHonwI6gsA312iGVvXjckYtiox9dCucyAnFaOeR4lPCWySwhkX0f0rpjXEbI8FYz8Dwy+JnTvC6Oma0zgPC0GkjOgJ1x2TJf+4DR3rCNezMqO8PxZP+p8C4m0hol/jeqXSOPFstc6DIlwgAT3+PrEV9pA5Ovln3lqFxNOKsvSr9hRscrKe833T49cSavXzrAB+Q7SaEPZQIOykMgt8RsyHRMe5L6KebfiawddtmdmXmd6z+0bcrcyPojhfu2zMMMIDXj2hiG/9JY4lXcBAhqGaFW/BOOkBSrLOtz0swuQOoO+i7SKQtoKsL8byw/6tGDolkj2Qs8/v7tx2QsPcExlewQVvP+4cgtNvJLSHIiY/bSBYBp7DJFmRB7ULHsViWAQzoY6YiBw2XcqqonM5RCBAUxvzeqXiGQvricwwkH2+raesuux26DPz2H4MCqZHxb9EOKUCs6LAnaWe5aM/3sIH7idZAPSSbGenZmEb1mf/GyiDaRvAXr8f24nElu9fBQSwSCcw2Igy4/ifKiayEweEcurguqPiFQWKHmrLcYQWqlcXWHRY8pd004c8Jil99AGckhZV8yoby/zYFWAVFAc30PZslYZL5Jm9F1tIP64kMl4vImMyL2qFW4jkRZP3MrehSWO4NCLmshnDkR6/mrL68ypvsTr+WKVdRv7VmhD6g7+PsqqO3HAo0aMCC+1BtltphiIdRwjYhBI9kulzjpEUJF3dBV+IW/NXLCsT1Md51ed7sg2H8wpPDYQJnVyu4fAAPHdOo1AJ5wI7ZTlDkh2JxxhuVatDcxQh4f0hLZ3euAKDHgpu8eWv0er+j1+LK2Bpg1ZwIhYVKk1UvZ83D/OXZx6chNK5GOuUV8uzXPjSjqREjFq1J++WOZvNZDjpAXAL6Qt+c2bjaDsFhj1bT7d8z2fD5Fzu/ofchv7P067+j+K0+q1jfpSSkQBkvzDsAYmCWOjcsRx6qnPIxGN9EwrpEVuXEmnIRHDKiuzFcoiBcg3EGLKxkGtQ7EJImZXpLK2+bCFTDybws3r4X9QvPueRqLqD/lj9QKVtco0WQXEsrG6RHlEVnkkThyQ3rpcmlYCMyLNTTvcDC5+Ju3wRPamtwhJtQOBcVXMLDYcw/iLYQtuKS6Svdt8BhZmTr2gd/FI7Zfj2lfN3Yxt/llyoJvBxXWmpeomK29Jk7s02aooX9Z9jJaP5Ye0ZYF1XL1QAOQBPCWzjMteOHBaU1XigJcguxV8aYUkBhfDdryZ5h0BB75tHcDDcbBmKa0N5B4OoJNXJKw1pzSv6MVxcVVXD7ftZBcBkBSwTT+MZ0C+2ammnZspADIKepNZWfwkmA9bMkdR7cHFbnnUO8To4OJqp2T8ITJbMSPASkcIMCf9+5p3pHEC87D10JUUsgeaHzvrBlFxqL7WXXrZ2rL3+TS6hYUmwXyeTfn+tdqNUf9SGZXkpYlND2zzVKyyLvl0y/NEZe1QUvrYonAfQR55KDG0yR3gFwfLyWjdkeA6DwrjSroRu9myx0BqVokWy96EkkjEBkSS2qHT0QdMlWoCsbzHiEzi2ZDzpVGhC2zIdkbEqA2ZQ5NM2oGQfsFh5fBQp+X9vU7rhzrckXOBNWML40o6A3v5HgO5V63yHbHsPRFAiVjsiZTvYGNMiWgbdcv7lMhErlE/E4BpvARGfQclYtioz6Antlx1NQ/xy1zShcb5H2Jyo7Wt6sXgajGFcSWdIU0tBBBChKai0DbqJykRi1Pud0ZEoLIsA5CIRu73EyVfyRWrrJ3FgIhxlTUd03bYgEDQNzqp4Vwha1AsJbRlTkQIPqQeB+zMwDUBPQWiEBGorFOlgIgzECASI5a9loGmBM3VEeSj/svcyN5dxZZ5NKc+WXqgAgJB3+3gSyPs5jIizQW6MxJdST0GQogcKwQQQqSjG9l7utREZyCYjH+wu2T8lkGx/PVD0qFROOg2Gf+vxoFcw2Vg1fmyApWz8sG1XRmRAVp3BAZebvbxGMgFqH/GQY+BQPX3+ouMOty6M9OdgdBk/LnukvFb8vkr7DysHks9oN0k488x7kraz0yPbM91Eq+Enl6R7UTma6qskyzhgYeyFz1oszwGgtVniWRv1Rh6YxyBrJPcJeNfrSTjH8cBkl27VpxY9t4u41ky/iM+LK7eDuSgMjtHF3KnRPZq3ZFWSl4Bz4Ds82Zueh4C4VavBpJcpWqMLLsa9aWSu2T88xgR3qJgclxtuv6ptg35O8izZPy/eA+1OgJZqlQzXWZEVjge1uGOpLcsebwwsnerz5sFhQDCrd7BhsRUo0Scjfo3JnfJ+JdQIqO5Rj2udoNHbpLxl/UsGf9PXqMck/EPU2RWd5YKcn4P8llSy6qSW3KsMLJ3R7E3CgqhsnjVOxr12JpIxEVlbfCCcbsD6jEeJ5W1yjRJ1lzpM652oyRZfqLe/ZKjyrpWzrNk/BvwUbEDAY+CF+FLNUg4CL0fcLFsoSlzyC2BPLHtWrsprTRU1m++vQsKobJY9eqhtEOOKutBHSDiAkTe7PfAdTRzvAqI/J0pVnMtXEJkjevup9SyN7KCZ66ka00OWUlL2QLrMmR5TCcWBTlIW3emt+xUmHxZ8j6/g4WRvekte7hW9o9a9ibUH+ti1NPYjKhzSWnMgOAWYXH81aIfwyB4Ii9x2jQG5DjOTW82nowfhntXOaaJtTmWniZqPKBjFltLg39HIB1pepzHQDDF9IGTHgOBJenTkzm1rWZAMGDt0RoX2ds8TeM0kxoy2atsMZwnexVHUT4RkL1KLIZR2dsizSUraTjp8+AXGDg4FdABxzX3aU1q79S7FBQXyFc17hdqcNF3nVZ1q5ns9d4ic1TW2dIt4Pl+3MTBITkA/OgT6yOQkwGMCG+Be0sfP5z5nuzo0IxJP6chkPQXGBGjWUmrNU91BrJIWYoAwzJOBWACpPsad+QtH5hFl38NKK5d3jJrAomuXP1+YYBMNO3Cs3essHseJQJuQD0YEScb8tcPGC/qdGxME59Qx59m3KZEeCFtcv6sPNXsrq1gQOY0tCEKEaM2JKZy0xQnIJCcKFCZrAIikG7HGqDhl/VJGo7aCOqjufQ1bMidytXuFQKIdR5Uv8Z5m665SARsiELE1ajLjxq6HJxmu20oq4gM0TDqdhc6VcEsCNPQqDMiho367YpNkh2BtCD/bYtOTEw5BHRQFiTgWlUY1xRUR1df0DTqhEhMYQYXUQy5PgRIBF9xRsQVyKNnOEfHxP3xyroMzXPsSXdcgMzind0gC5vHRCJnPFFZN8o3dlzHsIRVsWQJSjL8DJUrp+sd2eEjqA0ncrbt1lZZdypXTSgUkB9NnK1ezbXdGEJkFwdIYgPu4UuwoHkrEom160tnIF/zT4+NfJiRiHHZC9VeD3FKxn9XlpfhF9KinoSLOnWVpSnl3pHtIh6tMd/b21rJ+K1IpFCyd7MXd7NXcmw3Jr8HVp+neJDQxYlHd+SXHjRiZh5c+AkiQt/mAzmusXtHmll9P3ykn6C5bQwACQOnLMgqrQayhyhR/LJYlq8yoyv/oXVHojp31C59aJSgOVwDyFoIJbwTYQTIu2SPcvbqIztpVD2X/hnC7POJ8MiBFVcxK69fgh5ROEq58LbOQL7Rs/sfuOyGrAhWXUBMpO1eSVdRcwTyNemGKuY9vwY7sVhXIGP06d07GjakBLFd84IvGpW97ZXlj6bpqTxKSdd6CyanIXFJsd91nXU0UxtyZScgY/Ut7NOfzY1/rxuICSR8RquQ6y5AIISgDHwBb8nE5oxIKWcgTVN1ndpFn2VcIMUPo3cgS6+kHwiM6ICzcbd8XdVPpVPE5EmdQdqp8pKP3o5TdGUcA7PNXjMgY/V2u4ZKS2Rnhx0REK8faD7DVqE3nYFA2oA25HMEbvG0CyXSygnIs8k6T+1DemZOQOjCVPKTVpSIfiAw8bpHkjrl6qz+Czr18bkEYnah1y82ixtwEmMhcEme3cW65qHLB0YR9MToqOjKL6jTklIgwMNqwcN+grOOGGz4sD6uSBUVionm1pvet6C79TXyCATpBOK9iQWlZLTCBezUQIqbUWb1tLAFaoYgkaGOQJ55zK4s/JkRcIJzGkCMT8GAhjDU97BDezCNFxq/kYOONItdgODYA+ye0RYTXhkAAmv2tGufzfbfRWd0ZmCAQP5rJbD6ergsypWQTjk4Dw2NVFNcby8X/P5SmmyhRGAu5WYoI4JK+Qs8ukKEWD7r8w5A8P0YC4uWKEQGYjaxh/WQSGT5xik2IjIcY5ukDwgmy01uvA2JVEt3BCLdhnmCNuRi8l/ClWS+qP5IMcQKkHpww/c0jMeZBaiexfKlt8RbElWxXjxeJt6SydJ6JyA+MDqXi/FrTzsERhsC0oRIs6hMW/XbKZHPkEheF6w+oW6VGDuRXeTvEcz6oA7u6c2IHEeRyYigUp6OrzMjAvNFkhrIWJbh4V0VkQGYbyuhLnpmXy+PieYYEXKg2vqATMPqzO/hsTJaOcleicj2Aw0AdUFP6QM48vek4d2vBtIU+05XaPq8b+krOtq0yk7kTpXa/9iJTHWSvSvQrd46CgcZsl82JHslaRO7saz6XzAvr/wpEsntzIjgrDcjAklyYMeNzkRwLiUimBFBpTwFX2eFSFp1NRCW1lze7dtPReR9TJceX4cSKdciXUXkS0kfEGXxzeEY3JuR4QRkjiw/jmWdKuktaFzJw/NADeSRwy1ZR6v/AN93RuRe9Rr37EQuOgJhY/qMSE6cMSBVUxyJbKa5q6cjkZz/YPXxdXDWWyGygw5VnXYhAtteDGREOsO2E3B9qfxp4HZi7iSpgaBqghuz3/8dFZH30CWdEblWDrteG5eA5thp0gkETnw+PNUTvH92lb3gkoUBydgqSx0YvjIqIHCNl+235DtK5CNcJY8R+ad21Wg7EZfluzMXWm1EjNkQSXqpwJFIGCXyMRLJ6oDVx9WuC63qlY/hgb3CRuJCzilERnUHLZPe/01IwHuu60fQQ/2t6yKMYetq46YOHaNA0rqPhjv9Z9f1mLK1KwytWj7sCUY2rtcAQHG121xFT+wvIekHsq8rLNskz+5+wxXIs3Repyf4WecN7zqFXn8bByAFfd/FS+02Af76Y1dcaGpe12P2y4x/Yyi8CbvpZToD2dkVmkvr9K6njAOR3lEiUlj1YbT6OXh/nr6P1cf1mqis/BNZ1TZUhfkVC2SrHn2W1E5yAWKkrPKWDABxKg5AfAvYYI5DGe74hhgtzgvcOxZjQKT2yTLvFDV6zep4iO7Xde6Xu8BRsRoFcrqd3otxD0SK4m2y7P8QECl4kd5+yJ2+jg25d8dlt932KZP2DHfOAWYESO61r1vrvxYdQLbzNjn0fwmIJIWO2Jvk7lHPj179qjI18P8ABDmNAb865E4AAAAASUVORK5CYII=",MapTile={},os_clickBuildingObject=ViewerUtil.eventFactory("os_clickBuildingObject");
!function(){"use strict";MapTile=function(viewer,eventCallback,options){this.viewer=viewer,this.options=options,this.eventCallback=eventCallback,this.viewer.EVENT.OS_BUILDING_CLICK="VIEWER_OS_BUILDING_CLICK",this.viewer.EVENT.UPDATE_URL="VIEWER_UPDATE_URL",ViewerUtil.onEvent("os_clickBuildingObject",this.os_clickBuildingObject.bind(this))},MapTile.prototype.initCallback=function(viewer){var self=this;viewer.onMouseUp(function(){self.appendMapTileByViewPoint()})},MapTile.prototype.updateSettings=function(settings){var self=this;settings&&settings.hasOwnProperty("mapTile")&&settings.mapTile.lat&&settings.mapTile.lon&&(settings.mapTile.lat=parseFloat(settings.mapTile.lat),settings.mapTile.lon=parseFloat(settings.mapTile.lon),settings.mapTile.y=parseInt(settings.mapTile.y),this.settings=settings,this.originBNG=OsGridRef.latLonToOsGrid(new LatLon(this.settings.mapTile.lat,this.settings.mapTile.lon)),this.meterPerPixel=1,this.mapSizes=[],this.enabled=this.settings.osEnabled);var options=this.options;options&&options.lat&&options.lon&&options.y&&setTimeout(function(){self.translateTo(options)},3e3)},MapTile.prototype.translateTo=function(options){if(this.enabled){if(!this.originBNG)return console.log("Translation aborted due to no origin lat,lon defined");var lat=options.lat,lon=options.lon,height=options.y,view=options.view||[.00028736474304142756,-.9987502603949663,-.0499783431347178],up=options.up||[.005742504650018704,.04997916927067853,-.9987337514469797];(!height||height<0)&&(height=500),this.viewer.setCamera([0,height,0],view,up);var mapImagePosInfo=this._getMapImagePosInfo(),mapXY=this._getSlippyTileLayerPoints(lat,lon,mapImagePosInfo.zoomLevel),nx=mapXY.x-mapImagePosInfo.slippyPoints.x,ny=mapXY.y-mapImagePosInfo.slippyPoints.y,osTargetPoint=OsGridRef.latLonToOsGrid(new LatLon(lat,lon)),mapImageCentreLatLon=new LatLon(this._tile2lat(mapXY.y,mapImagePosInfo.zoomLevel),this._tile2long(mapXY.x,mapImagePosInfo.zoomLevel)),osImagePoint=OsGridRef.latLonToOsGrid(mapImageCentreLatLon),mapSize=this.getMapSize(ny),dx=osTargetPoint.easting*this.meterPerPixel-(osImagePoint.easting*this.meterPerPixel+mapSize/2),dy=osImagePoint.northing*this.meterPerPixel-mapSize/2-osTargetPoint.northing*this.meterPerPixel,camX=this.getSumSizeForXRow(nx,ny)+mapImagePosInfo.offsetX+dx,camY=this.getSumSize(ny)+mapImagePosInfo.offsetY+dy;this.viewer.setCamera([camX,height,camY],view,up,[camX,0,camY]),this.appendMapTileByViewPoint()}},MapTile.prototype.getMapSizeByYCoor=function(yCoor){return this.getMapSize(this.findMapTileNoByPos(yCoor))},MapTile.prototype.getMapSize=function(n){var nextN=n<0?n-1:n+1;return Math.abs(this.getSumSize(nextN)-this.getSumSize(n))};var scaleMapImages=!1;scaleMapImages?(MapTile.prototype.getSumSizeForXRow=function(n,y){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel],lat=this._tile2lat(mapImagePosInfo.slippyPoints.y+y,mapImagePosInfo.zoomLevel);return mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*n*this.meterPerPixel},MapTile.prototype.getSumSize=function(n){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel];if(0===n)return 0;if(1===n||n===-1){var lat=this._tile2lat(mapImagePosInfo.slippyPoints.y,mapImagePosInfo.zoomLevel);return this.mapSizes[0]=this.mapSizes[0]||mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*this.meterPerPixel,this.mapSizes[0]*n}var nextN;if(nextN=n>=0?n-1:n+1,!this.mapSizes[nextN]){var lat=this._tile2lat(mapImagePosInfo.slippyPoints.y+nextN,mapImagePosInfo.zoomLevel);this.mapSizes[nextN]=mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*this.meterPerPixel}return(n>=0?1:-1)*this.mapSizes[nextN]+this.getSumSize(nextN)},MapTile.prototype.findMapTileNoByPos=function(pos){var n,mapSize_0=this.getSumSize(1)-this.getSumSize(0),mapSize_1=this.getSumSize(2)-this.getSumSize(1);if(mapSize_1>mapSize_0&&pos>0)for(var n=0;;){if(this.getSumSize(n)<=pos&&pos<this.getSumSize(n+1))break;n++}else for(var n=0;;){if(this.getSumSize(n)<=pos&&pos<this.getSumSize(n+1))break;n--}return n}):(MapTile.prototype.getSumSize=function(n){var mapImagePosInfo=this._getMapImagePosInfo(),mapPerPxZoomLevel=mapImagePosInfo.mPerPxTable[mapImagePosInfo.zoomLevel],lat=this._tile2lat(mapImagePosInfo.slippyPoints.y,mapImagePosInfo.zoomLevel);return mapPerPxZoomLevel*Math.cos(this._degToRad(lat))*256*n*this.meterPerPixel},MapTile.prototype.findMapTileNoByPos=function(pos){return Math.floor(pos/this.getSumSize(1))},MapTile.prototype.getSumSizeForXRow=MapTile.prototype.getSumSize),MapTile.prototype._clearMapImagePosInfo=function(){this.mapPosInfo=null},MapTile.prototype._getMapImagePosInfo=function(){if(!this.mapPosInfo){var height=this.getLenFromCamToCentre(this.getViewAreaOnZPlane(),this.viewer.getCurrentViewpointInfo().position),zoomLevel=this.getZoomLevel(height),mPerPxTable={0:156543.03,1:78271.52,2:39135.76,3:19567.88,4:9783.94,5:4891.97,6:2445.98,7:1222.99,8:611.5,9:305.75,10:152.87,11:76.437,12:38.219,13:19.109,14:9.5546,15:4.7773,16:2.3887,17:1.1943,18:.5972},slippyPoints=this._getSlippyTileLayerPoints(this.settings.mapTile.lat,this.settings.mapTile.lon,zoomLevel),x=slippyPoints.x,y=slippyPoints.y,mapImgsize=mPerPxTable[zoomLevel]*Math.cos(this._degToRad(this._tile2lat(y,zoomLevel)))*256*this.meterPerPixel,osGridRef=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(y,zoomLevel),this._tile2long(x,zoomLevel))),offsetX=(osGridRef.easting-this.originBNG.easting)*this.meterPerPixel+mapImgsize/2,offsetY=(this.originBNG.northing-osGridRef.northing)*this.meterPerPixel+mapImgsize/2;this.mapPosInfo={x:x,y:y,offsetX:offsetX,offsetY:offsetY,zoomLevel:zoomLevel,slippyPoints:slippyPoints,mPerPxTable:mPerPxTable}}return this.mapPosInfo},MapTile.prototype._startMoveImages=function(){this._moveStep=10;var self=this;this._moveImagesListener=function(e){"ArrowUp"===e.code?self._moveMapImages(0,-self._moveStep):"ArrowLeft"===e.code?self._moveMapImages(-self._moveStep,0):"ArrowDown"===e.code?self._moveMapImages(0,self._moveStep):"ArrowRight"===e.code&&self._moveMapImages(self._moveStep,0)},document.addEventListener("keyup",this._moveImagesListener)},MapTile.prototype._stopMoveImages=function(){document.removeEventListener("keyup",this._moveImagesListener)},MapTile.prototype._moveMapImages=function(dx,dy){this.sumD=this.sumD||[0,0],this.imagesDoms.forEach(function(dom){var t=dom.getAttribute("translation").split(" ");t.forEach(function(number,i){t[i]=parseFloat(number)}),t[0]+=dx,t[2]+=dy,dom.setAttribute("translation",t.join(" "))}),this.sumD[0]+=dx,this.sumD[1]+=dy},MapTile.prototype._newOrigin=function(){var sumD=this.sumD;return OsGridRef.osGridToLatLon(OsGridRef(this.originBNG.easting-sumD[0],this.originBNG.northing+sumD[1]))},MapTile.prototype._setNewOrigin=function(){var sumD=this.sumD;this.viewer.originBNG=OsGridRef(this.originBNG.easting-sumD[0],this.originBNG.northing+sumD[1]),this.mapPosInfo=null,this.sumD=[0,0]},MapTile.prototype._moveMapImagesY=function(y){this.viewer.imagesDoms.forEach(function(dom){var t=dom.getAttribute("translation").split(" ");t.forEach(function(number,i){t[i]=parseFloat(number)}),t[1]=y,dom.setAttribute("translation",t.join(" "))})},MapTile.prototype._clearAllPlanes=function(){var self=this;this._planes&&this._planes.forEach(function(p){self.viewer.getScene().removeChild(p)}),this._planes=[]},MapTile.prototype._appendPlane=function(p){this._planes=this.planes||[],this._planes.push(p),this.viewer.getScene().appendChild(p)},MapTile.prototype._drawPlaneOnZ=function(coords,color){function less(a,b){if(a[0]-center[0]>=0&&b[0]-center[0]<0)return!0;if(a[0]-center[0]<0&&b[0]-center[0]>=0)return!1;if(a[0]-center[0]==0&&b[0]-center[0]==0)return a[2]-center[2]>=0||b[2]-center[2]>=0?a[2]>b[2]:b[2]>a[2];var det=(a[0]-center[0])*(b[2]-center[2])-(b[0]-center[0])*(a[2]-center[2]);if(det<0)return!0;if(det>0)return!1;var d1=(a[0]-center[0])*(a[0]-center[0])+(a[2]-center[2])*(a[2]-center[2]),d2=(b[0]-center[0])*(b[0]-center[0])+(b[2]-center[2])*(b[2]-center[2]);return d1>d2}var coordIndex="",center=[0,0,0];center[0]=(coords[0][0]+coords[1][0],(+coords[2][0]+coords[3][0])/4),center[2]=(coords[0][2]+coords[1][2],(+coords[2][2]+coords[3][2])/4),coords.sort(less);for(var i=0;i<coords.length;i++)coordIndex+=" "+i;coordIndex+=" -1";var coordsFlatten=[];coords.forEach(function(coord){coordsFlatten=coordsFlatten.concat(coord)});var containerNode=document.createElement("div");return containerNode.innerHTML="\t<shape>\t\t<appearance>\t\t\t<material diffuseColor='"+color.join(" ")+"' transparency='0.7'></material>\t\t</appearance>\t\t<IndexedFaceSet ccw='true' colorPerVertex='false' solid='false' coordIndex='"+coordIndex+"'>\t\t\t<coordinate point='"+coordsFlatten.join(" ")+"'></coordinate>\t\t</IndexedFaceSet>\t</shape>",containerNode.children[0]},MapTile.prototype.appendMapImage=function(ox,oy){var posInfo=this._getMapImagePosInfo(),x=posInfo.x,y=posInfo.y,offsetX=posInfo.offsetX,offsetY=posInfo.offsetY,mapHeight=this.settings.mapTile.y?this.settings.mapTile.y:0,size=this.getMapSize(oy);if(this.addedMapImages||(this.addedMapImages={}),this.imagesDoms||(this.imagesDoms=[]),this.addedMapImages[ox+","+oy])return!1;var dom=this.createMapImageTile(size,x+ox,y+oy,[offsetX+this.getSumSizeForXRow(ox,oy),mapHeight,offsetY+this.getSumSize(oy)]);return this.imagesDoms.push(dom),this.viewer.getScene().appendChild(dom),this.addedMapImages[ox+","+oy]=1,!0},MapTile.prototype.removeMapImages=function(){var self=this;this.imagesDoms&&this.imagesDoms.forEach(function(dom){self.viewer.getScene().removeChild(dom)}),this.imagesDoms=[],this.addedMapImages={},this.mapSizes=[]},MapTile.prototype.getLenFromCamToCentre=function(viewAreaCoors,camera){var centre=this.centreOfVecs(viewAreaCoors),lenToCentreVec=[camera[0]-centre[0],camera[1]-centre[1],camera[2]-centre[2]],len=this._vec3Len(lenToCentreVec);return len},MapTile.prototype.getZoomLevel=function(height){var self=this,yToZoomLevel=[{y:5e5,zoomLevel:7},{y:3e5,zoomLevel:8},{y:109e3,zoomLevel:9},{y:58800,zoomLevel:10},{y:30709,zoomLevel:11},{y:16800,zoomLevel:12},{y:8e3,zoomLevel:13},{y:4500,zoomLevel:14},{y:2e3,zoomLevel:15},{y:1e3,zoomLevel:16},{y:500,zoomLevel:17},{y:250,zoomLevel:18},{y:0,zoomLevel:18}];yToZoomLevel.forEach(function(map){map.y*=self.meterPerPixel});for(var zoomLevel,i=0;i<yToZoomLevel.length;i++)if(height>=yToZoomLevel[i].y){zoomLevel=yToZoomLevel[i].zoomLevel;break}return zoomLevel},MapTile.prototype.getViewAreaOnZPlane=function(){for(var vpInfo=this.viewer.getCurrentViewpointInfo(),fov=vpInfo.fov,camera=vpInfo.position,view_dir=vpInfo.view_dir,ratio=vpInfo.aspect_ratio,up=vpInfo.up,right=vpInfo.right,tanHalfFOV=Math.tan(fov/2),planeOffsetX=[1,-1,1,-1],planeOffsetY=[1,1,-1,-1],viewAreaCoors=[],i=0;i<planeOffsetX.length;i++){for(var X=planeOffsetX[i],Y=planeOffsetY[i],rayDirection=[],c=0;c<3;c++)rayDirection[c]=view_dir[c]+X*tanHalfFOV*right[c]+Y*(ratio/tanHalfFOV)*up[c];var gamma=camera[1]/-rayDirection[1];viewAreaCoors[i]=[];for(var c=0;c<3;c++)viewAreaCoors[i][c]=camera[c]+gamma*rayDirection[c]}return viewAreaCoors},MapTile.prototype.centreOfVecs=function(vectors){var centre=[];return vectors[0].forEach(function(value,i){centre[i]=0}),vectors.forEach(function(vector){vector.forEach(function(value,i){centre[i]+=value})}),centre.forEach(function(value,i){centre[i]=value/vectors.length}),centre},MapTile.prototype.isLookingToInf=function(viewAreaCoors){var farVec=[viewAreaCoors[1][0]-viewAreaCoors[0][0],viewAreaCoors[1][2]-viewAreaCoors[0][2]],nearVec=[viewAreaCoors[3][0]-viewAreaCoors[2][0],viewAreaCoors[3][2]-viewAreaCoors[2][2]];return!(this._hasSameSign(farVec[0],nearVec[0])&&this._hasSameSign(farVec[1],nearVec[1]))},MapTile.prototype.getLatLonOfViewArea=function(viewAreaCoors){var centrePoint=this.viewer.getCurrentViewpointInfo().position,mapImgPosInfo=this._getMapImagePosInfo(),mapXY=[this.findMapTileNoByPos(centrePoint[0]),this.findMapTileNoByPos(centrePoint[2])],dx=([mapImgPosInfo.offsetX+this.getSumSizeForXRow(mapXY[0],mapXY[1]),0,mapImgPosInfo.offsetY+this.getSumSize(mapXY[1])],centrePoint[0]-this.getSumSizeForXRow(mapXY[0],mapXY[1])-mapImgPosInfo.offsetX),dy=centrePoint[2]-this.getSumSize(mapXY[1])-mapImgPosInfo.offsetY,mapSize=this.getMapSize(mapXY[1]),osImagePoint=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(mapXY[1]+mapImgPosInfo.slippyPoints.y,this.zoomLevel),this._tile2long(mapXY[0]+mapImgPosInfo.slippyPoints.x,this.zoomLevel))),k=this.meterPerPixel,latlon=OsGridRef.osGridToLatLon(OsGridRef((dx+osImagePoint.easting*k+mapSize/2)/k,(osImagePoint.northing*k-mapSize/2-dy)/k));return latlon},MapTile.prototype.osCoorToSceneCoor=function(osCoor){return[osCoor.easting-this.originBNG.easting,this.originBNG.northing-osCoor.northing]},MapTile.prototype.triggerUpdateURLEvent=function(lat,lon,height,view,up){this.eventCallback(this.viewer.EVENT.UPDATE_URL,{at:[lat,lon,height].join(","),view:view,up:up})},MapTile.prototype.rotatePloygon=function(viewAreaCoors,centre,deg){return viewAreaCoors=JSON.parse(JSON.stringify(viewAreaCoors)),viewAreaCoors.forEach(function(coor){coor.forEach(function(value,i){coor[i]=coor[i]-centre[i]}),coor[0]=coor[0]*Math.cos(Math.PI)-coor[2]*Math.sin(deg),coor[2]=coor[0]*Math.sin(Math.PI)+coor[2]*Math.cos(deg),coor.forEach(function(value,i){coor[i]=coor[i]+centre[i]})}),viewAreaCoors},MapTile.prototype.appendMapTileByViewPoint=function(noDraw){function LenVec2D(vecA,vecB){return Math.sqrt(Math.pow(vecA[0]-vecB[0],2)+Math.pow(vecA[1]-vecB[1],2))}function getCoorOnAC(k){return[a[0]+k*(c[0]-a[0]),a[2]+k*(c[2]-a[2])]}function getCoorOnBD(k){return[b[0]+k*(d[0]-b[0]),b[2]+k*(d[2]-b[2])]}function getCoorVertical(kx,ky){var start,end;return start=getCoorOnAC(ky),end=getCoorOnBD(ky),[start[0]+kx*(end[0]-start[0]),start[1]+kx*(end[1]-start[1])]}function viewAreaIterate(options){for(var genStepX=options.genStepX,genStepY=options.genStepY,yCond=options.yCond,xCond=options.xCond,callback=options.callback,horVecLen=LenVec2D([a[0],a[2]],[c[0],c[2]]),stepY=genStepY(a,horVecLen),ky=-stepY;ky<=1+stepY&&yCond();ky+=stepY){for(var startCoor=getCoorVertical(0,ky),endCoor=getCoorVertical(1,ky),vertVecLen=LenVec2D(endCoor,startCoor),stepX=genStepX(startCoor,vertVecLen),kx=-stepX;kx<=1+stepX&&xCond();kx+=stepX){var coor=getCoorVertical(kx,ky);callback(coor),stepX=genStepX(coor,vertVecLen)}stepY=genStepY(startCoor,horVecLen)}}if(this.enabled){if(!this.originBNG)return void console.log("originBNG not found");var self=this,vpInfo=this.viewer.getCurrentViewpointInfo(),camera=vpInfo.position,viewAreaCoors=(this._getMapImagePosInfo(),this.getViewAreaOnZPlane()),lookingToInf=this.isLookingToInf(viewAreaCoors),len=this.getLenFromCamToCentre(viewAreaCoors,camera),zoomLevel=this.getZoomLevel(len);this.zoomLevel!==zoomLevel&&(this.removeMapImages(),this._clearMapImagePosInfo(),this.zoomLevel=zoomLevel);var viewAreaLatLon=this.getLatLonOfViewArea(viewAreaCoors),view_dir=this.viewer.getCurrentViewpointInfo().view_dir,up=this.viewer.getCurrentViewpointInfo().up;this.triggerUpdateURLEvent(viewAreaLatLon.lat,viewAreaLatLon.lon,camera[1],view_dir.join(","),up.join(","));var a,b,c,d;if(a=viewAreaCoors[3],b=viewAreaCoors[2],c=viewAreaCoors[1],d=viewAreaCoors[0],lookingToInf){var rotatedViewAreaCoors=this.rotatePloygon(viewAreaCoors,this.centreOfVecs([a,b]),Math.PI);a=rotatedViewAreaCoors[3],b=rotatedViewAreaCoors[2],c=rotatedViewAreaCoors[0],d=rotatedViewAreaCoors[1]}var mapImagesCount=0,maxImageCount=200,getStep=function(coor,vecLen){var yCoor=coor[1],imageSize=self.getMapSizeByYCoor(yCoor);return imageSize/vecLen/2},cond=function(){return mapImagesCount<maxImageCount};viewAreaIterate({genStepY:getStep,genStepX:getStep,yCond:cond,xCond:cond,callback:function(coor){var imageSize=self.getMapSizeByYCoor(coor[1]),mapImgX=Math.floor(coor[0]/imageSize),mapImgZ=Math.floor(coor[1]/imageSize),appended=self.appendMapImage(mapImgX,mapImgZ);appended&&mapImagesCount++}});var tileCount=0,maxTileCount=100,genStep=function(coor,vecLen){var tileSize=100*self.meterPerPixel;return tileSize/vecLen/2};cond=function(){return tileCount<maxTileCount},!noDraw&&this.shouldDraw3DBuildings(this.zoomLevel)&&viewAreaIterate({genStepY:genStep,genStepX:genStep,yCond:cond,xCond:cond,callback:function(coor){var osRef=new OsGridRef(self.originBNG.easting+coor[0]/self.meterPerPixel,self.originBNG.northing-coor[1]/self.meterPerPixel),osrefno=self._OSRefNo(osRef,3),appended=self.appendMapTile(osrefno);appended&&tileCount++}})}},MapTile.prototype.shouldDraw3DBuildings=function(zoomLevel){return zoomLevel>=17},MapTile.prototype._hasSameSign=function(a,b){return a<=0&&b<=0||a>=0&&b>=0},MapTile.prototype._roundUpToTen=function(n){var roundUpPlace=10;return Math.ceil(n/roundUpPlace)*roundUpPlace},MapTile.prototype._OSRefNo=function(osRef,length){if(length<1||length>5)return console.log("length must be in range [1 - 5]");var osrefno=osRef.toString().split(" ");return osrefno[1]=osrefno[1].substring(0,length),osrefno[2]=osrefno[2].substring(0,length),osrefno=osrefno.join("")},MapTile.prototype._tile2long=function(x,z){return x/Math.pow(2,z)*360-180},MapTile.prototype._tile2lat=function(y,z){var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))},MapTile.prototype._degToRad=function(degrees){return degrees*Math.PI/180},MapTile.prototype._getSlippyTileLayerPoints=function(lat_deg,lng_deg,zoom){var x=Math.floor((lng_deg+180)/360*Math.pow(2,zoom)),y=Math.floor((1-Math.log(Math.tan(lat_deg*Math.PI/180)+1/Math.cos(lat_deg*Math.PI/180))/Math.PI)/2*Math.pow(2,zoom)),layerPoint={x:x,y:y};return layerPoint},MapTile.prototype.os_clickBuildingObject=function(objEvent){objEvent.partID&&this.eventCallback(this.viewer.EVENT.OS_BUILDING_CLICK,{id:objEvent.partID})},MapTile.prototype.appendMapTile=function(osGridRef){if(this.enabled&&this.originBNG){if(this.addedTileRefs=this.addedTileRefs||[],this.addedTileRefs.indexOf(osGridRef)!==-1)return!1;this.addedTileRefs.push(osGridRef);var gltf=document.createElement("gltf");gltf.setAttribute("onclick","os_clickBuildingObject(event)"),gltf.setAttribute("url",server_config.apiUrl(server_config.MAP_API,"os/buildings.gltf?method=osgrid&osgridref="+osGridRef+"&draw=1"));var translate=[0,0,0],osCoor=OsGridRef.parse(osGridRef),mapImagePosInfo=this._getMapImagePosInfo(),tileLatLon=OsGridRef.osGridToLatLon(osCoor),correspondingMapTile=this._getSlippyTileLayerPoints(tileLatLon.lat,tileLatLon.lon,mapImagePosInfo.zoomLevel),y=correspondingMapTile.y-mapImagePosInfo.slippyPoints.y,mapSize=this.getMapSize(y),corMapTileBNG=OsGridRef.latLonToOsGrid(new LatLon(this._tile2lat(correspondingMapTile.y,mapImagePosInfo.zoomLevel),this._tile2long(correspondingMapTile.x,mapImagePosInfo.zoomLevel))),dx=osCoor.easting*this.meterPerPixel-(corMapTileBNG.easting*this.meterPerPixel+mapSize/2),dy=corMapTileBNG.northing*this.meterPerPixel-mapSize/2-osCoor.northing*this.meterPerPixel;translate[0]=(correspondingMapTile.x-mapImagePosInfo.slippyPoints.x)*mapSize+dx+mapImagePosInfo.offsetX,translate[2]=(correspondingMapTile.y-mapImagePosInfo.slippyPoints.y)*mapSize+dy+mapImagePosInfo.offsetY;var scale=document.createElement("Transform"),mPerPx=this.meterPerPixel;scale.setAttribute("scale",[mPerPx,mPerPx,mPerPx].join(",")),scale.appendChild(gltf);var transform=document.createElement("transform");return transform.setAttribute("translation",translate.join(" ")),transform.appendChild(scale),this.viewer.getScene().appendChild(transform),transform}},MapTile.prototype.createMapImageTile=function(size,x,y,t){var shape=document.createElement("Shape"),app=document.createElement("Appearance"),it=document.createElement("ImageTexture"),mapImagePosInfo=this._getMapImagePosInfo();document.createElement("material");it.setAttribute("url",server_config.apiUrl(server_config.MAP_API,"os/map-images/Outdoor/"+mapImagePosInfo.zoomLevel+"/"+x+"/"+y+".png")),it.setAttribute("crossOrigin","use-credentials"),app.appendChild(it),shape.appendChild(app);var plane=document.createElement("Plane");plane.setAttribute("center","0, 0"),plane.setAttribute("size",[size,size].join(",")),plane.setAttribute("solid",!1),plane.setAttribute("lit",!1),shape.appendChild(plane);var rotate=document.createElement("Transform");rotate.setAttribute("rotation","1,0,0,4.7124"),rotate.appendChild(shape);var translate=document.createElement("Transform");return translate.setAttribute("translation",t.join(" ")),translate.appendChild(rotate),translate},MapTile.prototype._vec3Len=function(vec){return Math.sqrt(Math.pow(vec[0],2)+Math.pow(vec[1],2)+Math.pow(vec[2],2))}}();var MeasureTool={};!function(){"use strict";MeasureTool=function(viewer){var self=this;this.viewer=viewer,this.lineStarted=!1,this.inMeasureMode=!1,this.measureCoords=[null,null],this.measureLine=null,this.measureLineCoords=null,this.measureMouseMove=function(event){var viewArea=self.viewer.getViewArea(),pickingInfo=viewArea._pickingInfo;self.measureCoords[1]=pickingInfo.pickPos,self.updateMeasureLine()},this.measureMouseDown=function(event){var viewArea=self.viewer.getViewArea(),pickingInfo=viewArea._pickingInfo,doc=viewArea._doc;self.lineStarted?(self.measureCoords[1]=pickingInfo.pickPos,self.lineStarted=!1,doc.inMeasureMode=!1,self.viewer.offMouseMove(self.measureMouseMove)):(self.measureCoords[0]=pickingInfo.pickPos,self.lineStarted=!0,self.createMeasureLine(),doc.inMeasureMode=!0,self.viewer.onMouseMove(self.measureMouseMove))}},MeasureTool.prototype.measureMode=function(on){var self=this,element=document.getElementById("x3dom-default-canvas");on?(self.inMeasureMode=!0,element.style.cursor="crosshair",self.viewer.onMouseDown(self.measureMouseDown),self.viewer.onMouseMove(self.measureMouseMove),self.viewer.highlightObjects(),self.viewer.disableClicking()):(self.inMeasureMode=!1,self.deleteMeasureLine(),element.style.cursor="-webkit-grab",self.viewer.offMouseDown(self.measureMouseDown),self.viewer.offMouseMove(self.measureMouseMove),self.viewer.enableClicking())},MeasureTool.prototype.createMeasureLine=function(){var self=this;null!==self.measureLine&&self.deleteMeasureLine();var lineDepth,lineApp,line,colors,line=document.createElement("LineSet");line.setAttribute("vertexCount",8),self.measureLineCoords=document.createElement("Coordinate"),self.measureLineCoords.setAttribute("point","0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0,0 0 0"),line.appendChild(self.measureLineCoords);var colors=document.createElement("Color");colors.setAttribute("color","0 1 0,0 1 0,1 0 0,1 0 0,0 0 1,0 0 1, 1 1 1, 1 1 1"),line.appendChild(colors);var lineDepth=document.createElement("DepthMode");lineDepth.setAttribute("depthFunc","ALWAYS");var lineApp=document.createElement("Appearance");lineApp.appendChild(lineDepth);var lineProperties=document.createElement("LineProperties");lineProperties.setAttribute("linewidthScaleFactor",3),lineApp.appendChild(lineProperties),self.measureLine=document.createElement("Shape"),self.measureLine.appendChild(lineApp),self.measureLine.appendChild(line),self.viewer.scene.appendChild(self.measureLine)},MeasureTool.prototype.updateMeasureLine=function(){var self=this;if(self.lineStarted){var coordString="";if(null!==self.measureCoords[0]&&null!==self.measureCoords[1]){var startCoordArray=self.measureCoords[0].toGL(),endCoordArray=self.measureCoords[1].toGL();coordString+=startCoordArray.join(" ")+",",coordString+=startCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=startCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray[0]+" "+startCoordArray[1]+" "+endCoordArray[2]+",",coordString+=endCoordArray.join(" ")+",",coordString+=endCoordArray.join(" ")+",",coordString+=startCoordArray.join(" "),self.measureLineCoords.setAttribute("point",coordString)}}},MeasureTool.prototype.deleteMeasureLine=function(){var self=this;null!==self.measureLine&&(self.measureLine.parentElement.removeChild(self.measureLine),self.measureLine=null,self.measureLineCoords=null)}}();var Pin={};!function(){"use strict";Pin=function(id,position,norm,colours,viewpoint,account,model){var self=this;self.id=id,self.highlighted=!1,self.viewpoint=viewpoint,self.account=account,self.model=model,self.numColours=0,"undefined"==typeof colours?(self.numColours=1,colours=[1,0,0]):"number"==typeof colours[0]?self.numColours=1:self.numColours=colours.length,self.colours=colours,UnityUtil.dropPin(id,position,norm,colours[0]),colours=colours.join(" ")},Pin.prototype.remove=function(id){UnityUtil.removePin(id)},Pin.prototype.changeColour=function(colours){var self=this;UnityUtil.changePinColour(self.id,colours[0])},Pin.prototype.highlight=function(){var self=this;self.highlighted=!self.highlighted;var depthMode=self.highlighted?"ALWAYS":"LESS",highlighted=self.highlighted.toString();self.pinHeadIsHighlighted.setAttribute("value",highlighted),self.ghostPinHeadIsHighlighted.setAttribute("value",highlighted),self.coneIsHighlighted.setAttribute("value",highlighted),self.ghostConeIsHighlighted.setAttribute("value",highlighted),self.pinHeadDepth.setAttribute("depthFunc",depthMode),self.coneDepth.setAttribute("depthFunc",depthMode)}}();var PinShader=null;!function(){"use strict";PinShader=function(element){var pinheadshader=document.createElement("ComposedShader");pinheadshader.setAttribute("ID","pinHeadShader");var pinvert=document.createElement("ShaderPart");pinvert.setAttribute("type","VERTEX"),pinvert.setAttribute("DEF","multiVert"),pinvert.textContent="attribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInverse;\nuniform mat4 modelViewProjectionMatrix;\nuniform float radius;\n\nvarying float fragColourSelect;\nvarying vec3 fragNormal;\nvarying vec3 fragEyeVector;\nvarying vec4 fragPosition;\nvarying vec3 pinPosition;\nvoid main()\n{\n\tfragEyeVector = vec3(0.2, 0.2, 0.2);\n\tfragNormal = normal;\n\tfragColourSelect = 1.0 - ((position.y / radius) + 1.0) / 2.0;\n\t\n\tpinPosition = position;\n\tfragPosition = (modelViewMatrix * vec4(position, 1.0));\n\tgl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",pinheadshader.appendChild(pinvert);var pinfrag=document.createElement("ShaderPart");pinfrag.setAttribute("type","FRAGMENT"),pinfrag.setAttribute("DEF","multiFrag");var fragSource="#ifdef GL_FRAGMENT_PRECISION_HIGH\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n";fragSource+="\nuniform float numColours;\nuniform float ambientIntensity;\nuniform float transparency;\nvarying float fragColourSelect;\nvarying vec3 fragNormal;\nvarying vec3 fragEyeVector;\nvarying vec4 fragPosition;\nvarying vec3 pinPosition;\nuniform vec3 multicolours[20];\nuniform mat4 viewMatrixInverse;\nuniform bool highlightPin;\nuniform vec3 highlightColor;\nuniform bool useClipPlane;\n",fragSource+=x3dom.shader.light(1),fragSource+=x3dom.shader.clipPlanes(1),fragSource+="\nvoid main()\n{\n\tint colourSelected = int(floor(fragColourSelect * numColours));\n\tvec3 eye = -pinPosition.xyz;\n\tvec3 normal = normalize(fragNormal);\n\tvec3 ads = lighting(light0_Type, light0_Location, light0_Direction, light0_Color, light0_Attenuation, light0_Radius, light0_Intensity, light0_AmbientIntensity, light0_BeamWidth, light0_CutOffAngle, normalize(fragNormal), eye, 0.0, ambientIntensity);\n\tvec3 ambient = light0_Color * ads.r;\n\tvec3 diffuse = light0_Color * ads.g;\n\tambient = max(ambient, 0.0);\n\tdiffuse = max(diffuse, 0.0);\n\tvec3 pinColor = vec3(0.0,0.0,0.0);\n\tif(useClipPlane) {\n\t\tcalculateClipPlanes();\n\t}\n\tfor(int colidx = 0; colidx < 20; colidx++) {\n\t\tif(colidx == colourSelected) {\n\t\t\tpinColor = multicolours[colidx];\n\t\t\tpinColor = clamp(pinColor, 0.0, 1.0);\n\t\t\tif (highlightPin) {\n\t\t\t\tpinColor = highlightColor;\n\t\t\t}\n\t\t\tgl_FragColor = vec4(pinColor, transparency);\n\t\t}\n\t}\n}\n\n",pinfrag.textContent=fragSource,pinheadshader.appendChild(pinfrag);var coneshader=document.createElement("ComposedShader");coneshader.setAttribute("id","coneShader");var conevert=document.createElement("ShaderPart");conevert.setAttribute("type","VERTEX"),conevert.setAttribute("DEF","noShadeVert");var conevertSource="attribute vec3 position;\nattribute vec3 normal;\n\nuniform mat4 modelViewMatrixInverse;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\n\nvarying vec4 fragPosition;\nvoid main()\n{\n\tfragPosition = (modelViewMatrix * vec4(position, 1.0));\n\tgl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}";conevert.textContent=conevertSource,coneshader.appendChild(conevert);var conefrag=document.createElement("ShaderPart");conefrag.setAttribute("type","FRAGMENT"),conefrag.setAttribute("DEF","noShadeFrag");var coneFragSource="#ifdef GL_FRAGMENT_PRECISION_HIGH\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec3 diffuseColor;\nuniform float transparency;\nuniform bool highlightPin;\nuniform vec3 highlightColor;\nuniform mat4 viewMatrixInverse;\nuniform bool useClipPlane;\nvarying vec4 fragPosition;\n";coneFragSource+=x3dom.shader.clipPlanes(1),coneFragSource+="\nvoid main()\n{\n\tvec3 diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n\tif(useClipPlane) {\n\t\tcalculateClipPlanes();\n\t}\n\tif (highlightPin) {\n\t\tdiffuseColor = highlightColor;\n\t}\n\tgl_FragColor = vec4(diffuseColor, transparency);\n}",conefrag.textContent=coneFragSource,coneshader.appendChild(conefrag),element.appendChild(pinheadshader),element.appendChild(coneshader)}}();var UnityUtil;!function(){"use strict";function toUnity(methodName,requireStatus,params){requireStatus==LoadingState.MODEL_LOADED?UnityUtil.onLoaded().then(function(){SendMessage(UNITY_GAME_OBJECT,methodName,params)}):requireStatus==LoadingState.MODEL_LOADING?UnityUtil.onLoading().then(function(){SendMessage(UNITY_GAME_OBJECT,methodName,params)}):UnityUtil.onReady().then(function(){SendMessage(UNITY_GAME_OBJECT,methodName,params)})}function _getObjectsStatus(nameSpace,promise){objectStatusPromise=promise,toUnity("GetObjectsStatus",LoadingState.MODEL_LOADED,nameSpace)}function _requestViewpoint(account,model,promise){var param={};account&&model&&(param.namespace=account+"."+model),vpPromise=promise,toUnity("RequestViewpoint",LoadingState.MODEL_LOADING,JSON.stringify(param))}angular.module("3drepo").factory("UnityUtil",UnityUtil),UnityUtil=function(){};var readyPromise,readyResolve,loadedPromise,loadedResolve,loadingPromise,loadingResolve,SendMessage_vss,SendMessage_vssn,SendMessage_vsss,LoadingState={VIEWER_READY:1,MODEL_LOADING:2,MODEL_LOADED:3},screenshotPromises=[],vpPromise=null,objectStatusPromise=null,loaded=!1,UNITY_GAME_OBJECT="WebGLInterface";UnityUtil.prototype._SendMessage=function(gameObject,func,param){if(void 0===param)SendMessage_vss||(SendMessage_vss=Module.cwrap("SendMessage","void",["string","string"])),SendMessage_vss(gameObject,func);else if("string"==typeof param)SendMessage_vsss||(SendMessage_vsss=Module.cwrap("SendMessageString","void",["string","string","string"])),SendMessage_vsss(gameObject,func,param);else{if("number"!=typeof param)throw""+param+" is does not have a type which is supported by SendMessage.";SendMessage_vssn||(SendMessage_vssn=Module.cwrap("SendMessageFloat","void",["string","string","number"])),SendMessage_vssn(gameObject,func,param)}},UnityUtil.prototype.onLoaded=function(){return loadedPromise||(loadedPromise=new Promise(function(resolve,reject){loadedResolve={resolve:resolve,reject:reject}})),loadedPromise},UnityUtil.prototype.onLoading=function(){return loadingPromise||(loadingPromise=new Promise(function(resolve,reject){loadingResolve={resolve:resolve,reject:reject}})),loadingPromise},UnityUtil.prototype.onReady=function(){return readyPromise||(readyPromise=new Promise(function(resolve,reject){readyResolve={resolve:resolve,reject:reject}})),readyPromise},UnityUtil.prototype.clipBroadcast=function(clipInfo){UnityUtil.clipBroadcastCallback&&UnityUtil.clipBroadcastCallback(JSON.parse(clipInfo))},UnityUtil.prototype.currentPointInfo=function(pointInfo){
var point=JSON.parse(pointInfo);UnityUtil.objectSelectedCallback&&UnityUtil.objectSelectedCallback(point)},UnityUtil.prototype.doubleClicked=function(meshInfo){var point=JSON.parse(meshInfo);UnityUtil.centreToPoint(point.model,point.meshID)},UnityUtil.prototype.loaded=function(bboxStr){var res={};res.bbox=JSON.parse(bboxStr),loadedResolve.resolve(res),loaded=!0},UnityUtil.prototype.loading=function(bboxStr){loadingResolve.resolve()},UnityUtil.prototype.objectStatusBroadcast=function(nodeInfo){console.log("nodeInfo: "+nodeInfo),objectStatusPromise.resolve(JSON.parse(nodeInfo)),objectStatusPromise=null},UnityUtil.prototype.pickPointAlert=function(pointInfo){var point=JSON.parse(pointInfo);UnityUtil.pickPointCallback&&UnityUtil.pickPointCallback(point)},UnityUtil.prototype.ready=function(){SendMessage=UnityUtil._SendMessage,readyResolve.resolve()},UnityUtil.prototype.screenshotReady=function(screenshot){var ssJSON=JSON.parse(screenshot);screenshotPromises.forEach(function(promise){promise.resolve(ssJSON.ssBytes)}),screenshotPromises=[]},UnityUtil.prototype.viewpointReturned=function(vpInfo){if(null!=vpPromise){var viewpoint=JSON.parse(vpInfo);vpPromise.resolve(viewpoint),vpPromise=null}},UnityUtil.prototype.centreToPoint=function(model,id){var params={};params.model=model,params.meshID=id,toUnity("CentreToObject",LoadingState.MODEL_LOADING,JSON.stringify(params))},UnityUtil.prototype.changePinColour=function(id,colour){var params={};params.color=colour,params.pinName=id,toUnity("ChangePinColor",LoadingState.MODEL_LOADING,JSON.stringify(params))},UnityUtil.prototype.clearHighlights=function(){toUnity("ClearHighlighting",LoadingState.MODEL_LOADED)},UnityUtil.prototype.disableClippingPlanes=function(){toUnity("DisableClip")},UnityUtil.prototype.dropPin=function(id,position,normal,colour){var params={};params.id=id,params.position=position,params.normal=normal,params.color=colour,toUnity("DropPin",LoadingState.MODEL_LOADING,JSON.stringify(params))},UnityUtil.prototype.getObjectsStatus=function(account,model,promise){var nameSpace="";account&&model&&(nameSpace=account+"."+model),objectStatusPromise?objectStatusPromise.then(function(blah){_getObjectsStatus(nameSpace,promise)}):_getObjectsStatus(nameSpace,promise)},UnityUtil.prototype.getPointInfo=function(){toUnity("GetPointInfo",!1,0)},UnityUtil.prototype.highlightObjects=function(account,model,idArr,color,toggleMode){var params={};params.database=account,params.model=model,params.ids=idArr,params.toggle=toggleMode,color&&(params.color=color),toUnity("HighlightObjects",LoadingState.MODEL_LOADED,JSON.stringify(params))},UnityUtil.prototype.loadModel=function(account,model,branch,revision){UnityUtil.reset(),!loaded&&loadedResolve&&(loadedResolve.reject(),loadingResolve.reject()),loadedPromise=null,loadedResolve=null,loadingPromise=null,loadingResolve=null,loaded=!1;var params={};return params.database=account,params.model=model,"head"!=revision&&(params.revID=revision),UnityUtil.onLoading(),toUnity("LoadProject",LoadingState.VIEWER_READY,JSON.stringify(params)),UnityUtil.onLoaded()},UnityUtil.prototype.removePin=function(id){toUnity("RemovePin",LoadingState.MODEL_LOADING,id)},UnityUtil.prototype.reset=function(){toUnity("ClearCanvas",LoadingState.VIEWER_READY)},UnityUtil.prototype.resetCamera=function(){toUnity("ResetCamera",LoadingState.VIEWER_READY)},UnityUtil.prototype.requestScreenShot=function(promise){screenshotPromises.push(promise),toUnity("RequestScreenShot",LoadingState.VIEWER_READY)},UnityUtil.prototype.requestViewpoint=function(account,model,promise){null!=vpPromise?vpPromise.then(_requestViewpoint(account,model,promise)):_requestViewpoint(account,model,promise)},UnityUtil.prototype.setAPIHost=function(hostname){toUnity("SetAPIHost",LoadingState.VIEWER_READY,hostname)},UnityUtil.prototype.setNavigation=function(navMode){toUnity("SetNavMode",LoadingState.VIEWER_READY,navMode)},UnityUtil.prototype.setViewpoint=function(pos,up,forward,account,model){var param={};account&&model&&(param.nameSpace=account+"."+model),param.position=pos,param.up=up,param.forward=forward,toUnity("SetViewpoint",LoadingState.MODEL_LOADING,JSON.stringify(param))},UnityUtil.prototype.toggleStats=function(){toUnity("ShowStats",LoadingState.VIEWER_READY)},UnityUtil.prototype.toggleVisibility=function(account,model,ids,visibility){var param={};account&&model&&(param.nameSpace=account+"."+model),param.ids=ids,param.visible=visibility,toUnity("ToggleVisibility",LoadingState.MODEL_LOADED,JSON.stringify(param))},UnityUtil.prototype.updateClippingPlanes=function(clipPlane,requireBroadcast,account,model){var param={};param.clip=clipPlane,account&&model&&(param.nameSpace=account+"."+model),param.requiresBroadcast=requireBroadcast,toUnity("UpdateClip",LoadingState.MODEL_LOADING,JSON.stringify(param))},UnityUtil=new UnityUtil}();var bgroundClick,clickObject,clickPin,onMouseOver,onMouseDown,onMouseUp,onMouseMove,onViewpointChange,onLoaded,onError,runtimeReady,Viewer={},GOLDEN_RATIO=(1+Math.sqrt(5))/2;!function(){"use strict";bgroundClick=ViewerUtil.eventFactory("bgroundClicked"),clickObject=ViewerUtil.eventFactory("clickObject"),clickPin=ViewerUtil.eventFactory("pinClick"),onMouseOver=ViewerUtil.eventFactory("onMouseOver"),onMouseDown=ViewerUtil.eventFactory("onMouseDown"),onMouseUp=ViewerUtil.eventFactory("onMouseUp"),onMouseMove=ViewerUtil.eventFactory("onMouseMove"),onViewpointChange=ViewerUtil.eventFactory("onViewpointChange"),onLoaded=ViewerUtil.eventFactory("onLoaded"),onError=ViewerUtil.eventFactory("onError"),runtimeReady=ViewerUtil.eventFactory("runtimeReady"),Viewer=function(name,element,manager,callback,errCallback){var self=this;name?this.name=name:this.name="viewer",callback=callback?callback:function(){},errCallback=errCallback?errCallback:function(){},this.element=element,this.inline=null,this.runtime=null,this.fullscreen=!1,this.multiSelectMode=!1,this.pinDropMode=!1,this.clickingEnabled=!1,this.avatarRadius=.5,this.pinSizeFromSettings=!1,this.pinSize=1,this.defaultShowAll=!0,this.zNear=-1,this.zFar=-1,this.manager=manager,this.initialized=!1,this.downloadsLeft=1,this.defaultNavMode=this.NAV_MODES.TURNTABLE,this.selectionDisabled=!1,this.account=null,this.model=null,this.branch=null,this.revision=null,this.modelString=null,this.rootName="model",this.inlineRoots={},this.groupNodes=null,this.multipartNodes=[],this.multipartNodesByModel={},this.units="m",this.convertToM=1,this.setUnits=function(units){this.units=units,"mm"===units?this.convertToM=.001:"ft"===units&&(this.convertToM=.0032)},this.setHandle=function(handle){this.handle=handle},this.logos=[],this.logoClick=function(){},this.addLogo=function(){self.logoGroup||(self.logoGroup=document.createElement("div"),self.logoGroup.style.width="100%",self.element.appendChild(self.logoGroup));var numLogos=this.logos.length+1,perLogo=Math.floor(100/numLogos),widthPercentage=perLogo+"%",logo=document.createElement("div");logo.style.position="absolute",logo.style["z-index"]=2,logo.style["text-align"]="center",logo.style.width="250px",logo.style.top="10px",logo.style.left=0,logo.style.right=0,logo.style.margin="auto",logo.addEventListener("click",self.logoClick);var logoImage=document.createElement("img");logoImage.setAttribute("src",logo_string),logoImage.setAttribute("style","width: 100%;"),logoImage.textContent=" ",logo.appendChild(logoImage),self.updateLogoWidth(widthPercentage),self.logoGroup.appendChild(logo),self.logos.push(logo)},this.removeLogo=function(){if(self.logos.length){var numLogos=this.logos.length-1,widthPercentage=Math.floor(100/numLogos)+"%";self.logos[numLogos].parentNode.removeChild(self.logos[numLogos]),self.logos.splice(numLogos,1),self.updateLogoWidth(widthPercentage)}},this.updateLogoWidth=function(widthPercentage){for(var i=0;i<self.logos.length;i++)self.logos[i].style.width=widthPercentage},this.handleKeyPresses=function(e){console.log("Handling key presses?"),e.charCode==="r".charCodeAt(0)?(self.reset(),self.setApp(null),self.setNavMode(self.NAV_MODES.WALK),self.disableClicking()):e.charCode==="a".charCodeAt(0)?(self.showAll(),self.enableClicking()):e.charCode==="u".charCodeAt(0)&&self.revealAll()},this.init=function(options){if(!self.initialized){self.options=options,self.viewer=document.createElement("div");var canvas=document.createElement("canvas");canvas.className="emscripten",canvas.setAttribute("id","canvas"),canvas.setAttribute("tabindex","1"),canvas.setAttribute("oncontextmenu","event.preventDefault()"),canvas.setAttribute("height","600px"),canvas.setAttribute("width","960px"),canvas.onmousedown=function(){return!1},canvas.addEventListener("mouseup",onMouseUp),canvas.addEventListener("mousemove",onMouseMove),canvas.style["pointer-events"]="all";var canvasScript=document.createElement("script");canvasScript.setAttribute("type","text/javascript");var unitySettings={TOTAL_MEMORY:1065353216,errorhandler:null,compatibilitycheck:null,backgroundColor:"#222C36",splashStyle:"Light",dataUrl:"public/unity/Release/unity.data",codeUrl:"public/unity/Release/unity.js",asmUrl:"public/unity/Release/unity.asm.js",memUrl:"public/unity/Release/unity.mem"},moduleSettings=document.createTextNode("var Module = "+JSON.stringify(unitySettings));canvasScript.appendChild(moduleSettings);var canvasScript2=document.createElement("script");canvasScript2.setAttribute("src","public/unity/Release/UnityLoader.js"),self.viewer.appendChild(canvas),self.viewer.appendChild(canvasScript),self.viewer.appendChild(canvasScript2),self.viewer.className="viewer",self.element.appendChild(self.viewer),self.scene=document.createElement("Scene"),self.scene.setAttribute("onbackgroundclicked","bgroundClick(event);"),self.viewer.appendChild(self.scene),self.bground=null,self.currentNavMode=null,self.createBackground(),self.environ=document.createElement("environment"),self.environ.setAttribute("frustumCulling","true"),self.environ.setAttribute("smallFeatureCulling","true"),self.environ.setAttribute("smallFeatureThreshold",5),self.environ.setAttribute("occlusionCulling","true"),self.environ.setAttribute("sorttrans","true"),self.environ.setAttribute("gammaCorrectionDefault","linear"),self.scene.appendChild(self.environ),self.setAmbientLight(),self.createViewpoint(self.name+"_default"),self.loadViewpoint=self.name+"_default",self.viewer.addEventListener("keypress",self.handleKeyPresses),self.initialized=!0,manager&&manager.registerMe(self),self.enableClicking(),self.plugins=self.options.plugins,Object.keys(self.plugins).forEach(function(key){self.plugins[key].initCallback&&self.plugins[key].initCallback(self)}),UnityUtil.pickPointCallback=self.pickPointEvent,UnityUtil.objectSelectedCallback=self.objectSelected,UnityUtil.clipBroadcastCallback=self.broadcastClippingPlane,UnityUtil.setAPIHost(server_config.apiUrl(server_config.GET_API,"")),self.setNavMode(self.defaultNavMode),UnityUtil.onReady().then(function(){callback(self.EVENT.READY,{name:self.name,model:self.modelString})})}},this.destroy=function(){UnityUtil.reset()},ViewerUtil.onEvent("onError",function(objEvent){self.downloadsLeft+=objEvent.target.querySelectorAll("[load]").length-1}),ViewerUtil.onEvent("onLoaded",function(objEvent){self.loadViewpoint&&self.setCurrentViewpoint(self.loadViewpoint);var targetParent=objEvent.target._x3domNode._nameSpace.doc._x3dElem;if(self.loadViewpoints(),targetParent===self.viewer&&self.setDiffColors(null),"INLINE"===objEvent.target.tagName.toUpperCase()){var nameSpace=objEvent.target.nameSpaceName;if(self.inlineRoots[objEvent.target.nameSpaceName]=objEvent.target,nameSpace==self.account+"__"+self.model&&null==self.groupNodes){self.groupNodes={};for(var modelTrans={},groups=document.getElementsByTagName("Group"),gIdx=0;gIdx<groups.length;++gIdx){var fullModelName=groups[gIdx].id;self.groupNodes[fullModelName]=groups[gIdx];var res=fullModelName.split("__");if(4==res.length){var accProj=res[2]+"__"+res[3];modelTrans[accProj]={trans:groups[gIdx]._x3domNode.getCurrentTransform()}}}}var accProj=nameSpace.split("__");callback(self.EVENT.SET_SUBMODEL_TRANS_INFO,{modelNameSpace:nameSpace,modelTrans:self.getParentTransformation(accProj[0],accProj[1]),isMainModel:accProj[0]===self.account&&accProj[1]===self.model})}else if("MULTIPART"===objEvent.target.tagName.toUpperCase()&&self.multipartNodes.indexOf(objEvent.target)===-1){var nameSpaceName=objEvent.target._x3domNode._nameSpace.name;self.multipartNodesByModel.hasOwnProperty(nameSpaceName)||(self.multipartNodesByModel[nameSpaceName]={});var multipartName=objEvent.target.getAttribute("id"),multipartNameParts=multipartName.split("__"),multipartID=multipartNameParts[multipartNameParts.length-1];self.multipartNodesByModel[nameSpaceName][multipartID]=objEvent.target,self.multipartNodes.push(objEvent.target)}if(self.downloadsLeft+=objEvent.target.querySelectorAll("[load]").length-1,!self.pinSizeFromSettings){var sceneBBox=self.getScene()._x3domNode.getVolume(),sceneSize=sceneBBox.max.subtract(sceneBBox.min).length();self.pinSize=sceneSize/20}var options=self.options;options.showAll&&self.showAll(),!self.downloadsLeft}),this.showAll=function(){UnityUtil.resetCamera()},this.setAmbientLight=function(lightDescription){if(self.light){var i=0,attributeNames=[];for(i=0;i<self.light.attributes.length;i++)attributeNames.push(self.light.attributes[i].name);for(i=0;i<attributeNames.length;i++)self.light.removeAttribute(attributeNames[i])}else self.light=document.createElement("directionallight"),self.scene.appendChild(self.light);if(lightDescription)for(var attr in lightDescription)lightDescription.hasOwnProperty(attr)&&self.light.setAttribute(attr,lightDescription[attr]);else self.light.setAttribute("color","0.714, 0.910, 0.953"),self.light.setAttribute("direction","0, -0.9323, -0.362"),self.light.setAttribute("global","true"),self.light.setAttribute("ambientIntensity","0.8"),self.light.setAttribute("shadowIntensity",0)},this.createBackground=function(colourDescription){if(self.bground){var i=0,attributeNames=[];for(i=0;i<self.bground.attributes.length;i++)attributeNames.push(self.bground.attributes[i].name);for(i=0;i<attributeNames.length;i++)self.bground.removeAttribute(attributeNames[i])}else self.bground=document.createElement("background"),self.scene.appendChild(self.bground);if(colourDescription){self.bground.setAttribute("DEF",self.name+"_bground");for(var attr in colourDescription)colourDescription.hasOwnProperty(attr)&&self.bground.setAttribute(attr,colourDescription[attr])}else self.bground.setAttribute("DEF",self.name+"_bground"),self.bground.setAttribute("skyangle","0.9 1.5 1.57"),self.bground.setAttribute("skycolor","0.21 0.18 0.66 0.2 0.44 0.85 0.51 0.81 0.95 0.83 0.93 1"),self.bground.setAttribute("groundangle","0.9 1.5 1.57"),self.bground.setAttribute("groundcolor","0.65 0.65 0.65 0.73 0.73 0.73 0.81 0.81 0.81 0.91 0.91 0.91"),self.bground.textContent=" "},this.gyroscope=function(alpha,beta,gamma){var degToRad=Math.PI/180,b=alpha?alpha:0,a=beta?beta:0,g=-(gamma?gamma:0);a*=degToRad,b*=degToRad,g*=degToRad;var cA=Math.cos(a/2),cB=Math.cos(b/2),cG=Math.cos(g/2),sA=Math.sin(a/2),sB=Math.sin(b/2),sG=Math.sin(g/2),x=sA*cB*cG+cA*sB*sG,y=cA*sB*cG-sA*cB*sG,z=cA*cB*sG-sA*sB*cG,w=cA*cB*cG+sA*sB*sG,q=new x3dom.fields.Quaternion(x,y,z,w),screenAngle=(window.orientation?window.orientation:0)*degToRad*-1,screenQuat=x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(0,0,1),screenAngle),viewQuat=new x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(1,0,0),.5*-Math.PI);q=q.multiply(viewQuat),q=q.multiply(screenQuat);var flyMat=null,vp=self.getCurrentViewpoint()._x3domNode;if(self.rollerCoasterMatrix){var qMat=q.toMatrix();flyMat=qMat.transpose().mult(self.rollerCoasterMatrix.inverse())}else flyMat=vp.getViewMatrix().inverse(),flyMat.setRotate(q),flyMat=flyMat.inverse();vp._viewMatrix.setValues(flyMat)},this.switchDebug=function(){self.getViewArea()._visDbgBuf=!self.getViewArea()._visDbgBuf},this.showStats=function(){self.runtime.canvas.stateViewer.display()},this.getViewArea=function(){return self.runtime.canvas.doc._viewarea},this.getViewMatrix=function(){return self.getViewArea().getViewMatrix()},this.getParentTransformation=function(account,model){var trans=null,fullParentGroupName=self.account+"__"+self.model+"__"+account+"__"+model,parentGroup=self.groupNodes[fullParentGroupName];return parentGroup?trans=parentGroup._x3domNode.getCurrentTransform():console.error("Cannot find parent group: "+fullParentGroupName),trans},this.getProjectionMatrix=function(){return self.getViewArea().getProjectionMatrix()},this.getScreenshot=function(promise){UnityUtil.requestScreenShot(promise)},this.onMouseUp=function(functionToBind){ViewerUtil.onEvent("onMouseUp",functionToBind)},this.offMouseUp=function(functionToBind){ViewerUtil.offEvent("onMouseUp",functionToBind)},this.onMouseDown=function(functionToBind){ViewerUtil.onEvent("onMouseDown",functionToBind)},this.offMouseDown=function(functionToBind){ViewerUtil.offEvent("onMouseDown",functionToBind)},this.onMouseMove=function(functionToBind){ViewerUtil.onEvent("onMouseMove",functionToBind)},this.offMouseMove=function(functionToBind){ViewerUtil.offEvent("onMouseMove",functionToBind)},this.pickPoint=function(x,y,fireEvent){fireEvent=void 0!==typeof fireEvent&&fireEvent,self.getViewArea()._doc.ctx.pickValue(self.getViewArea(),x,y),fireEvent&&self.mouseDownPickPoint({layerX:x,layerY:y})},this.pickPointEvent=function(pointInfo){callback(self.EVENT.PICK_POINT,{id:pointInfo.id,position:pointInfo.position,normal:pointInfo.normal,screenPos:pointInfo.mousePos})},this.objectSelected=function(pointInfo){self.selectionDisabled||self.pinDropMode||(pointInfo.id?pointInfo.pin?callback(self.EVENT.CLICK_PIN,{id:pointInfo.id}):callback(self.EVENT.OBJECT_SELECTED,{account:pointInfo.database,model:pointInfo.model,id:pointInfo.id,source:"viewer"}):callback(self.EVENT.BACKGROUND_SELECTED))},this.mouseDownPickPoint=function(event){UnityUtil.getPointInfo()},this.onViewpointChanged=function(functionToBind){ViewerUtil.onEvent("myViewpointHasChanged",functionToBind)},this.offViewpointChanged=function(functionToBind){ViewerUtil.offEvent("myViewpointHasChanged",functionToBind)},this.viewPointChanged=function(event){var vpInfo=self.getCurrentViewpointInfo(),eye=vpInfo.position,viewDir=vpInfo.view_dir;self.currentNavMode===self.NAV_MODES.HELICOPTER&&(self.nav._x3domNode._vf.typeParams[0]=Math.asin(viewDir[1]),self.nav._x3domNode._vf.typeParams[1]=eye[1]),ViewerUtil.triggerEvent("myViewpointHasChanged",event)},this.onBackgroundClicked=function(functionToBind){ViewerUtil.onEvent("bgroundClicked",functionToBind)},this.offBackgroundClicked=function(functionToBind){ViewerUtil.offEvent("bgroundClicked",functionToBind)},this.lastMultipart=null,this.highlightObjects=function(account,model,ids_in,zoom,colour,multiOverride){if(!this.pinDropMode){var ids=new Set(ids_in);ids.size?UnityUtil.highlightObjects(account,model,Array.from(ids),colour,multiOverride||this.multiSelectMode):UnityUtil.clearHighlights()}},this.switchObjectVisibility=function(account,model,ids,visibility){UnityUtil.toggleVisibility(account,model,ids,visibility)},ViewerUtil.onEvent("pinClick",function(clickInfo){var pinID=clickInfo.target.parentElement.parentElement.parentElement.parentElement.parentElement.id;callback(self.EVENT.CLICK_PIN,{id:pinID})}),ViewerUtil.onEvent("onMouseDown",function(){return!1}),ViewerUtil.onEvent("onMouseUp",function(){document.body.style["pointer-events"]="all"}),this.onClickObject=function(functionToBind){ViewerUtil.onEvent("clickObject",functionToBind)},this.offClickObject=function(functionToBind){ViewerUtil.offEvent("clickObject",functionToBind)},this.viewpoints={},this.viewpointsNames={},this.selectedViewpointIdx=0,this.selectedViewpoint=null,this.isFlyingThrough=!1,this.flyThroughTime=1e3,this.flyThrough=function(){self.isFlyingThrough?self.isFlyingThrough=!1:(self.isFlyingThrough=!0,setTimeout(self.flyThroughTick,self.flyThroughTime))},this.flyThroughTick=function(){var newViewpoint=self.selectedViewpointIdx+1;newViewpoint===self.viewpoints.length&&(newViewpoint=0),self.setCurrentViewpoint(self.viewpoints[newViewpoint]),self.isFlyingThrough&&setTimeout(self.flyThroughTick,self.flyThroughTime)},this.getObjectsStatus=function(account,model,promise){UnityUtil.getObjectsStatus(account,model,promise)},this.getViewpointGroupAndName=function(id){var name,group,splitID=id.trim().split("__");return splitID.length>1?(group=splitID[0].trim(),name=splitID[1].trim()):(name=splitID[0].trim(),group="uncategorized"),{group:group,name:name}},this.loadViewpoints=function(){for(var viewpointList=document.getElementsByTagName("Viewpoint"),v=0;v<viewpointList.length;v++)if(viewpointList[v].hasAttribute("id")){var id=viewpointList[v].id.trim();viewpointList[v].DEF=id;var groupName=self.getViewpointGroupAndName(id);self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=id,self.viewpointsNames[id]=viewpointList[v]}},this.loadViewpoint=null,this.createViewpoint=function(name,from,at,up){var groupName=self.getViewpointGroupAndName(name);if(self.viewpoints[groupName.group]&&self.viewpoints[groupName.group][groupName.name])console.error("Tried to create viewpoint with duplicate name: "+name);else{var newViewPoint=document.createElement("viewpoint");if(newViewPoint.setAttribute("id",name),newViewPoint.setAttribute("def",name),self.scene.appendChild(newViewPoint),from&&at&&up){var q=ViewerUtil.getAxisAngle(from,at,up);newViewPoint.setAttribute("orientation",q.join(","))}if(from&&newViewPoint.setAttribute("position",from.join(",")),from&&at){var centre=[from[0]+at[0],from[1]+at[1],from[2]+at[2]];newViewPoint.setAttribute("centerofrotation",centre.join(","))}self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=name,self.viewpointsNames[name]=newViewPoint}},this.setCurrentViewpointIdx=function(idx){var viewpointNames=Object.keys(self.viewpointsNames);self.setCurrentViewpoint(viewpointNames[idx])},this.setCurrentViewpoint=function(id){if(Object.keys(self.viewpointsNames).indexOf(id)!==-1){var viewpoint=self.viewpointsNames[id];return self.currentViewpoint&&self.currentViewpoint._xmlNode.removeEventListener("viewpointChanged",self.viewPointChanged),self.currentViewpoint=viewpoint._x3domNode,viewpoint.setAttribute("bind",!0),self.getViewArea().resetView(),self.getViewArea()._flyMat=null,viewpoint.addEventListener("viewpointChanged",self.viewPointChanged),self.loadViewpoint=null,viewpoint.appendChild(self.nav),self.runtime.resetExamin(),self.applySettings(),void(id===self.name+"_default"&&(self.defaultShowAll?self.runtime.fitAll():self.reset()))}console.error("Could not find viewpoint."+id),self.loadViewpoint=id},this.updateSettings=function(settings){settings&&(self.settings=settings,self.applySettings())},this.applySettings=function(){self.settings&&(self.settings.hasOwnProperty("start_all")&&(self.defaultShowAll=self.settings.start_all),self.settings.hasOwnProperty("speed")&&self.setSpeed(self.settings.speed),self.settings.hasOwnProperty("unit")&&self.setUnits(self.settings.unit),self.settings.hasOwnProperty("avatarHeight")&&self.changeAvatarHeight(self.settings.avatarHeight),self.settings.hasOwnProperty("defaultNavMode")&&(self.defaultNavMode=self.settings.defaultNavMode),self.settings.hasOwnProperty("pinSize")&&(self.pinSize=self.settings.pinSize,self.pinSizeFromSettings=!0),self.settings.hasOwnProperty("visibilityLimit")&&self.nav.setAttribute("visibilityLimit",self.settings.visibilityLimit),self.settings.hasOwnProperty("zFar")&&self.currentViewpoint._xmlNode.setAttribute("zFar",self.settings.zFar),self.settings.hasOwnProperty("zNear")&&self.currentViewpoint._xmlNode.setAttribute("zNear",self.settings.zNear),self.settings.hasOwnProperty("background")&&self.createBackground(self.settings.background),self.settings.hasOwnProperty("ambientLight")&&self.setAmbientLight(self.settings.ambientLight))},this.applyModelProperties=function(account,model,properties){if(properties&&(properties.hiddenNodes&&properties.hiddenNodes.length>0&&self.switchObjectVisibility(account,model,properties.hiddenNodes,!1),properties.subProjects))for(var i=0;i<properties.subProjects.length;i++){var entry=properties.subProjects[i];this.applyModelProperties(entry.account,entry.project,entry.properties)}},this.lookAtObject=function(obj){self.runtime.fitObject(obj,!0)},this.applyApp=function(nodes,factor,emiss,otherSide){var m_idx,origDiff,origAmb;if(otherSide)for(m_idx=0;m_idx<nodes.length;m_idx++)nodes[m_idx]._x3domNode&&(origDiff=nodes[m_idx]._x3domNode._vf.backDiffuseColor,nodes[m_idx]._x3domNode._vf.backDiffuseColor.setValues(origDiff.multiply(factor)),origAmb=nodes[m_idx]._x3domNode._vf.backAmbientIntensity,nodes[m_idx]._x3domNode._vf.backAmbientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.backEmissiveColor.setValueByStr(emiss));else for(m_idx=0;m_idx<nodes.length;m_idx++)nodes[m_idx]._x3domNode&&(origDiff=nodes[m_idx]._x3domNode._vf.diffuseColor,nodes[m_idx]._x3domNode._vf.diffuseColor.setValues(origDiff.multiply(factor)),origAmb=nodes[m_idx]._x3domNode._vf.ambientIntensity,nodes[m_idx]._x3domNode._vf.ambientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.emissiveColor.setValueByStr(emiss))},this.pickObject={},this.pickPoint=function(x,y){var viewArea=self.getViewArea(),scene=viewArea._scene;if("undefined"!=typeof x&&"undefined"!=typeof y){var viewMatrix=self.getViewArea().getViewMatrix(),projMatrix=self.getViewArea().getProjectionMatrix();viewArea._doc.ctx.pickValue(viewArea,x,y,0,viewMatrix,projMatrix.mult(viewMatrix))}var oldPickMode=scene._vf.pickMode.toLowerCase();scene._vf.pickMode="idbuf",scene._vf.pickMode=oldPickMode,self.pickObject=viewArea._pickingInfo,self.pickObject.part=null,self.pickObject.partID=null;var objId=self.pickObject.shadowObjectId;if(scene._multiPartMap)for(var mpi=0;mpi<scene._multiPartMap.multiParts.length;mpi++){var mp=scene._multiPartMap.multiParts[mpi];if(objId>mp._minId&&objId<=mp._maxId){var colorMap=mp._inlineNamespace.defMap.MultiMaterial_ColorMap,emissiveMap=mp._inlineNamespace.defMap.MultiMaterial_EmissiveMap,specularMap=mp._inlineNamespace.defMap.MultiMaterial_SpecularMap,visibilityMap=mp._inlineNamespace.defMap.MultiMaterial_VisibilityMap;self.pickObject.part=new x3dom.Parts(mp,[objId-mp._minId],colorMap,emissiveMap,specularMap,visibilityMap),self.pickObject.partID=mp._idMap.mapping[objId-mp._minId].name,self.pickObject.pickObj=self.pickObject.part.multiPart}}},this.oneGrpNodes=[],this.twoGrpNodes=[],this.setNavMode=function(mode,force){(self.currentNavMode!==mode||force)&&(self.currentNavMode=mode,UnityUtil.setNavigation(mode),mode===self.NAV_MODES.WALK?self.disableClicking():self.enableClicking())},this.reload=function(){},this.startingPoint=[0,0,0],this.setStartingPoint=function(x,y,z){self.startingPoint[0]=x,self.startingPoint[1]=y,self.startingPoint[2]=z},this.defaultOrientation=[0,0,1],this.setStartingOrientation=function(x,y,z){self.defaultOrientation[0]=x,self.defaultOrientation[1]=y,self.defaultOrientation[2]=z},this.setCameraPosition=function(pos){var vpInfo=self.getCurrentViewpointInfo(),viewDir=vpInfo.view_dir,up=vpInfo.up;self.updateCamera(pos,up,viewDir)},this.moveCamera=function(dV){var currentPos=self.getCurrentViewpointInfo().position;currentPos[0]+=dV[0],currentPos[1]+=dV[1],currentPos[2]+=dV[2],self.setCameraPosition(currentPos)},this.setCameraViewDir=function(viewDir,upDir,centerOfRotation){var currentPos=self.getCurrentViewpointInfo().position;self.updateCamera(currentPos,upDir,viewDir,centerOfRotation)},this.setCamera=function(pos,viewDir,upDir,centerOfRotation,animate,rollerCoasterMode,account,model){self.updateCamera(pos,upDir,viewDir,centerOfRotation,animate,rollerCoasterMode,account,model)},this.updateCamera=function(pos,up,viewDir,centerOfRotation,animate,rollerCoasterMode,account,model){UnityUtil.setViewpoint(pos,up,viewDir,account,model)},this.linked=!1,this.managerSwitchMaster=function(){self.manager.switchMaster(self.handle)},this.linkMe=function(){self.manager&&(self.manager.linkMe(self.handle),self.onViewpointChanged(self.manager.viewpointLinkFunction),self.viewer.addEventListener("mousedown",self.managerSwitchMaster),self.linked=!0)},this.collDistance=.1,this.changeCollisionDistance=function(collDistance){self.collDistance=collDistance,self.nav._x3domNode._vf.avatarSize[0]=collDistance},this.avatarHeight=1.83,this.changeAvatarHeight=function(height){self.avatarHeight=height,self.nav._x3domNode._vf.avatarSize[1]=height},this.stepHeight=.4,this.changeStepHeight=function(stepHeight){self.stepHeight=stepHeight,self.nav._x3domNode._vf.avatarSize[2]=stepHeight},this.reset=function(){self.setCurrentViewpoint("model__start"),self.changeCollisionDistance(self.collDistance),self.changeAvatarHeight(self.avatarHeight),self.changeStepHeight(self.stepHeight)},this.loadModel=function(account,model,branch,revision){self.account=account,self.model=model,self.branch=branch,self.revision=revision,UnityUtil.loadModel(self.account,self.model,self.branch,self.revision).then(function(bbox){callback(self.EVENT.LOADED,bbox)}),callback(self.EVENT.START_LOADING)},this.getRoot=function(){return self.inline},this.getScene=function(){return self.scene},this.getCurrentViewpoint=function(){return self.getViewArea()._scene.getViewpoint()._xmlNode},this.getCurrentViewpointInfo=function(account,model,promise){UnityUtil.requestViewpoint(account,model,promise)},this.speed=2,this.setSpeed=function(speed){self.speed=speed,self.nav.speed=speed},this.bgroundClick=function(event){callback(self.EVENT.BACKGROUND_SELECTED)},this.hiddenParts=[],this.addHiddenPart=function(part){this.hiddenParts.push(part)},this.revealAll=function(event,objEvent){for(var part in self.hiddenParts)self.hiddenParts.hasOwnProperty(part)&&self.hiddenParts[part].setVisibility(!0);self.hiddenParts=[]},this.disableClicking=function(){self.clickingEnabled&&(self.offBackgroundClicked(self.bgroundClick),self.offClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!0),self.clickingEnabled=!1)},this.disableSelecting=function(){self.selectionDisabled=!0},this.enableClicking=function(){self.clickingEnabled||(self.onBackgroundClicked(self.bgroundClick),self.onClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!1),self.clickingEnabled=!0)},this.switchFullScreen=function(vrDisplay){vrDisplay=vrDisplay||{},self.fullscreen?(document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),self.fullscreen=!1):(self.viewer.mozRequestFullScreen?self.viewer.mozRequestFullScreen({vrDisplay:vrDisplay}):self.viewer.webkitRequestFullscreen&&self.viewer.webkitRequestFullscreen({vrDisplay:vrDisplay}),self.fullscreen=!0)},this.diffColorDeleted=[],this.diffColorAdded=[],this.setDiffColors=function(diffColors){diffColors&&(self.diffColors=diffColors);var i,mat,obj;if(self.applyApp(self.diffColorAdded,2,"0.0 0.0 0.0",!1),self.applyApp(self.diffColorDeleted,2,"0.0 0.0 0.0",!1),self.diffColorAdded=[],self.diffColorDeleted=[],self.diffColors&&self.inline.childNodes.length){var defMapSearch=self.inline.childNodes[0]._x3domNode._nameSpace.defMap;if(self.diffColors.added)for(i=0;i<self.diffColors.added.length;i++)obj=defMapSearch[self.diffColors.added[i]],obj&&(mat=obj._xmlNode.getElementsByTagName("Material"),mat.length?(self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0])):(mat=obj._xmlNode.getElementsByTagName("TwoSidedMaterial"),self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0])));if(self.diffColors.deleted)for(i=0;i<self.diffColors.deleted.length;i++)obj=defMapSearch[self.diffColors.deleted[i]],obj&&(mat=obj._xmlNode.getElementsByTagName("Material"),mat.length?(self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0])):(mat=obj._xmlNode.getElementsByTagName("TwoSidedMaterial"),self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0])))}},this.transformEvent=function(event,viewpoint,inverse){
var transformation;transformation=inverse?viewpoint._x3domNode.getTransformation().inverse():viewpoint._x3domNode.getTransformation();var newPos=transformation.multMatrixVec(event.position),newOrientMat=ViewerUtil.axisAngleToMatrix(event.orientation[0],event.orientation[1]);newOrientMat=transformation.mult(newOrientMat);var newOrient=new x3dom.fields.Quaternion;newOrient.setValue(newOrientMat),newOrient=newOrient.toAxisAngle(),event.position=newPos,event.orientation=newOrient},this.setMultiSelectMode=function(on){this.multiSelectMode=on},this.setPinDropMode=function(on){this.pinDropMode=on},this.broadcastClippingPlane=function(clip){callback(self.EVENT.CLIPPING_PLANE_BROADCAST,clip)},this.updateClippingPlanes=function(clipPlanes,fromPanel,account,model){clipPlanes&&0!==clipPlanes.length||UnityUtil.disableClippingPlanes(),clipPlanes&&clipPlanes.length>0&&UnityUtil.updateClippingPlanes(clipPlanes[0],!fromPanel,account,model),clipPlanes&&clipPlanes.length>1&&console.log("More than 1 clipping planes requested!")},this.clearClippingPlanes=function(){UnityUtil.disableClippingPlanes()},self.pins={},this.addPin=function(account,model,id,position,norm,colours,viewpoint){self.pins.hasOwnProperty(id)?errCallback(self.ERROR.PIN_ID_TAKEN):self.pins[id]=new Pin(id,position,norm,colours,viewpoint,account,model)},this.clickPin=function(id){if(self.pins.hasOwnProperty(id)){var pin=self.pins[id];callback(self.EVENT.CHANGE_PIN_COLOUR,{id:id,colours:[[1,.7,0]]}),callback(self.EVENT.SET_CAMERA,{position:pin.viewpoint.position,view_dir:pin.viewpoint.view_dir,up:pin.viewpoint.up,account:pin.account,model:pin.model}),callback(self.EVENT.UPDATE_CLIPPING_PLANES,{clippingPlanes:pin.viewpoint.clippingPlanes,account:pin.account,model:pin.model,fromClipPanel:!1})}},this.setPinVisibility=function(id,visibility){if(self.pins.hasOwnProperty(id)){var pin=self.pins[id];pin.setAttribute("render",visibility.toString())}},this.removePin=function(id){self.pins.hasOwnProperty(id)&&(self.pins[id].remove(id),delete self.pins[id])},this.previousHighLightedPin=null,this.highlightPin=function(id){self.previousHighLightedPin&&(self.previousHighLightedPin.highlight(),self.previousHighLightedPin=null),id&&self.pins.hasOwnProperty(id)&&(self.pins[id].highlight(),self.previousHighLightedPin=self.pins[id])},this.changePinColours=function(id,colours){self.pins.hasOwnProperty(id)&&self.pins[id].changeColour(colours)}},Viewer.prototype.SELECT_COLOUR={EMISSIVE:"1.0 0.5 0.0"},Viewer.prototype.ERROR={PIN_ID_TAKEN:"VIEWER_PIN_ID_TAKEN"}}();var VIEWER_NAV_MODES=Viewer.prototype.NAV_MODES={HELICOPTER:"HELICOPTER",WALK:"WALK",TURNTABLE:"TURNTABLE",WAYFINDER:"WAYFINDER",FLY:"FLY"},VIEWER_EVENTS=Viewer.prototype.EVENT={READY:"VIEWER_EVENT_READY",START_LOADING:"VIEWING_START_LOADING",LOAD_MODEL:"VIEWER_LOAD_MODEL",LOADED:"VIEWER_EVENT_LOADED",RUNTIME_READY:"VIEWING_RUNTIME_READY",ENTER_VR:"VIEWER_EVENT_ENTER_VR",VR_READY:"VIEWER_EVENT_VR_READY",SET_NAV_MODE:"VIEWER_SET_NAV_MODE",GO_HOME:"VIEWER_GO_HOME",SWITCH_FULLSCREEN:"VIEWER_SWITCH_FULLSCREEN",REGISTER_VIEWPOINT_CALLBACK:"VIEWER_REGISTER_VIEWPOINT_CALLBACK",REGISTER_MOUSE_MOVE_CALLBACK:"VIEWER_REGISTER_MOUSE_MOVE_CALLBACK",OBJECT_SELECTED:"VIEWER_OBJECT_SELECTED",BACKGROUND_SELECTED:"VIEWER_BACKGROUND_SELECTED",HIGHLIGHT_OBJECTS:"VIEWER_HIGHLIGHT_OBJECTS",SWITCH_OBJECT_VISIBILITY:"VIEWER_SWITCH_OBJECT_VISIBILITY",SET_PIN_VISIBILITY:"VIEWER_SET_PIN_VISIBILITY",GET_CURRENT_OBJECT_STATUS:"VIEWER_GET_CURRENT_OBJECT_STATUS",GET_CURRENT_VIEWPOINT:"VIEWER_GET_CURRENT_VIEWPOINT",GET_SCREENSHOT:"VIEWER_GET_SCREENSHOT",MEASURE_MODE_CLICK_POINT:"VIEWER_MEASURE_MODE_CLICK_POINT",PICK_POINT:"VIEWER_PICK_POINT",MOVE_POINT:"VIEWER_MOVE_POINT",SET_CAMERA:"VIEWER_SET_CAMERA",LOGO_CLICK:"VIEWER_LOGO_CLICK",CLEAR_CLIPPING_PLANES:"VIEWER_CLEAR_CLIPPING_PLANES",UPDATE_CLIPPING_PLANES:"VIEWER_UPDATE_CLIPPING_PLANE",CLIPPING_PLANE_READY:"VIEWER_CLIPPING_PLANE_READY",CLIPPING_PLANE_BROADCAST:"VIEWER_CLIPPING_PLANE_BROADCAST",CLICK_PIN:"VIEWER_CLICK_PIN",CHANGE_PIN_COLOUR:"VIEWER_CHANGE_PIN_COLOUR",REMOVE_PIN:"VIEWER_REMOVE_PIN",ADD_PIN:"VIEWER_ADD_PIN",MOVE_PIN:"VIEWER_MOVE_PIN"},ViewerManager={};!function(){"use strict";ViewerManager=function(){this.currentViewerName="",this.currentViewer=null,this.linkedViewers=[],this.linkedFunctions=[],this.viewers={},this.selectDefaultCurrentViewer=function(){var viewerNames=Object.keys(this.viewers);viewerNames.length?this.currentViewer=this.viewers[viewerNames[0]]:this.currentViewer=null}},ViewerManager.prototype.isValidViewerName=function(name){return this.viewers.hasOwnProperty(name)},ViewerManager.prototype.reshape=function(){var viewerSize=100/Object.keys(this.viewers).length,i=0;for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&(this.viewers[name].viewer.style.width=viewerSize+"%",this.viewers[name].viewer.style.left=i*viewerSize+"%",i++)},ViewerManager.prototype.removeViewer=function(name){if(this.isValidHandle(name)){if(1===Object.keys(this.viewers).length)return;this.viewers[name]===this.currentViewer&&this.selectDefaultCurrentViewer(),this.linkedViewers=this.linkedViewers.filter(function(linkedName){return linkedName!==name}),this.viewers[name].close(),delete this.viewers[name],this.currentViewerName===name&&(this.defaultViewerHandle=Object.keys(this.viewers)[0]),this.reshape()}},ViewerManager.prototype.close=function(){for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&this.removeViewer(name)},ViewerManager.prototype.registerMe=function(viewer){this.viewers[viewer.name]=viewer,1===Object.keys(this.viewers).length&&this.selectDefaultCurrentViewer(),this.reshape()},ViewerManager.prototype.linkMe=function(handle){this.addMe(this.linkedViewers,handle)},ViewerManager.prototype.switchCurrent=function(name){this.isValidHandle(name)&&(this.viewMaster=this.viewers[name])},ViewerManager.prototype.getCurrentViewer=function(){if(this.currentViewer)return this.currentViewer},ViewerManager.prototype.linkFunction=function(callback){this.linkedFunctions.push(callback)},ViewerManager.prototype.viewpointLinkFunction=function(newEvent,event){if(this.linkedViewers.length&&this.currentViewer&&event.target===this.currentViewer.getCurrentViewpoint()){event.orientation[1]=event.orientation[1]*-1,this.currentViewer.transformEvent(event,event.target,!1);var i;for(i=0;i<this.linkedViewers.length;i++){var name=this.linkedViewers[i];this.currentViewer.handle!==name&&this.isValidName(name)&&(this.viewers[name].getCurrentViewpoint().setAttribute("position",event.position.toString()),this.viewers[name].getCurrentViewpoint().setAttribute("orientation",event.orientation.toString()))}for(i=0;i<this.linkedFunctions.length;i++)this.linkedFunctions[i](event)}},ViewerManager.prototype.initRuntime=function(){for(var name in this.viewers)this.viewers.hasOwnProperty(name)&&(this.viewers[name].runtime||this.viewers[name].initRuntime())}}(),function(){"use strict";function accountBilling(){return{restrict:"EA",templateUrl:"accountBilling.html",scope:{account:"=",billingAddress:"=",quota:"=",billings:"=",subscriptions:"=",plans:"="},controller:AccountBillingCtrl,controllerAs:"vm",bindToController:!0}}function AccountBillingCtrl($scope,$window,$timeout,UtilsService,serverConfig){function setupLicensesInfo(){vm.numLicenses=vm.subscriptions.filter(function(sub){return sub.inCurrentAgreement}).length,vm.numNewLicenses=vm.numLicenses,vm.pricePerLicense=vm.plans[0].amount}function aRequiredAddressFieldIsEmpty(){return angular.isUndefined(vm.newBillingAddress.firstName)||angular.isUndefined(vm.newBillingAddress.lastName)||angular.isUndefined(vm.newBillingAddress.line1)||angular.isUndefined(vm.newBillingAddress.postalCode)||angular.isUndefined(vm.newBillingAddress.city)||angular.isUndefined(vm.newBillingAddress.countryCode)||angular.isDefined(vm.newBillingAddress.vat)&&""!==vm.newBillingAddress.vat&&angular.isUndefined(vm.newBillingAddress.company)||"US"===vm.newBillingAddress.countryCode&&angular.isUndefined(vm.newBillingAddress.state)}var promise,vm=this;vm.showInfo=!0,vm.saveDisabled=!0,vm.countries=serverConfig.countries,vm.usStates=serverConfig.usStates,vm.showStates=!1,vm.newBillingAddress={},$scope.$watch("vm.numNewLicenses",function(){angular.isDefined(vm.numNewLicenses)?(0===vm.numLicenses&&0===vm.numNewLicenses?vm.saveDisabled=!0:vm.numLicenses===vm.numNewLicenses?vm.saveDisabled=angular.equals(vm.newBillingAddress,vm.billingAddress)||aRequiredAddressFieldIsEmpty():vm.saveDisabled=aRequiredAddressFieldIsEmpty(),vm.priceLicenses=vm.numNewLicenses*vm.pricePerLicense):vm.saveDisabled=!0}),$scope.$watch("vm.billingAddress",function(){angular.isDefined(vm.billingAddress)&&(vm.newBillingAddress=angular.copy(vm.billingAddress),vm.countrySelectDisabled=angular.isDefined(vm.billingAddress.countryCode))},!0),$scope.$watch("vm.newBillingAddress",function(){angular.isDefined(vm.newBillingAddress)&&(0!==vm.numNewLicenses&&(vm.saveDisabled=angular.equals(vm.newBillingAddress,vm.billingAddress)||aRequiredAddressFieldIsEmpty(),vm.companyNameRequired=angular.isDefined(vm.newBillingAddress.vat)&&""!==vm.newBillingAddress.vat),vm.showStates="US"===vm.newBillingAddress.countryCode)},!0),$scope.$watch("vm.subscriptions",function(){angular.isDefined(vm.subscriptions)&&angular.isDefined(vm.plans)&&setupLicensesInfo()},!0),$scope.$watch("vm.plans",function(){angular.isDefined(vm.subscriptions)&&angular.isDefined(vm.plans)&&setupLicensesInfo()},!0),$scope.$watch("vm.billings",function(){var i,length;if(angular.isDefined(vm.billings))for(i=0,length=vm.billings.length;i<length;i+=1)"refund"===vm.billings[i].type?(vm.billings[i].status="Completed",vm.billings[i].description="Refund"):(vm.billings[i].status=vm.billings[i].pending?"Pending":"Paid",vm.billings[i].description=vm.billings[i].items[0].description)}),vm.downloadBilling=function(index){$window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/invoices/"+vm.billings[index].invoiceNo+".pdf"),"_blank")},vm.changeSubscription=function(){var data={plans:[{plan:"THE-100-QUID-PLAN",quantity:vm.numNewLicenses}],billingAddress:vm.newBillingAddress};vm.numLicenses===vm.numNewLicenses?vm.payPalInfo="Updating billing information. Please do not refresh the page or close the tab.":vm.payPalInfo="Redirecting to PayPal. Please do not refresh the page or close the tab.",UtilsService.showDialog("paypalDialog.html",$scope,null,!0),promise=UtilsService.doPost(data,vm.account+"/subscriptions"),promise.then(function(response){200===response.status?vm.numLicenses===vm.numNewLicenses?(vm.payPalInfo="Billing information updated.",$timeout(function(){UtilsService.closeDialog()},2e3)):location.href=response.data.url:(vm.closeDialogEnabled=!0,vm.changeHelpToShow=response.data.value,vm.payPalInfo=response.data.message)})},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("accountBilling",accountBilling),AccountBillingCtrl.$inject=["$scope","$window","$timeout","UtilsService","serverConfig"]}(),function(){"use strict";function AccountDataService(){var hasFederationsByProjectName=function(teamspaces,teamspaceName,projectName){return getFederations(teamspaces,teamspaceName,projectName).length>0},getFederationsByProjectName=function(teamspaces,teamspaceName,projectName){var project=getProject(teamspaces,teamspaceName,projectName);return project.models.filter(function(model){return model.subModels})},getIndividualModelsByProjectName=function(teamspaces,teamspaceName,projectName){var project=getProject(teamspaces,teamspaceName,projectName);return project.models.filter(function(model){return!model.subModels})},getIndividualTeamspaceModels=function(teamspaces,teamspaceName){var teamspace=getTeamspaceByName(teamspaces,teamspaceName);return teamspace.models.filter(function(model){return!model.subModels})},hasFederations=function(models){return getFederations(models).length>0},getFederations=function(models){return models.filter(function(model){return model.subModels})},getIndividualModels=function(models){return models.filter(function(model){return!model.subModels})},removeProjectInTeamspace=function(teamspaces,teamspaceName,projectName){var teamspace=getTeamspaceByName(teamspaces,teamspaceName);teamspace.projects.forEach(function(project,i){projectName===project.name&&teamspace.projects.splice(i,1)})},renameProjectInTeamspace=function(teamspaces,teamspaceName,newProjectName,oldProjectName){var teamspace=getTeamspaceByName(teamspaces,teamspaceName);teamspace.projects.forEach(function(project){project.name===oldProjectName&&(project.name=newProjectName)})},addProjectToTeamspace=function(teamspaces,teamspaceName,project){var teamspace=getTeamspaceByName(teamspaces,teamspaceName);teamspace.projects.push(project)},getProjectsByTeamspaceName=function(teamspaces,name){var projects=[];return teamspaces.forEach(function(teamspace){teamspace.name===name&&(projects=teamspace.projects)}),projects},getTeamspaceByName=function(teamspaces,name){return teamspaces.filter(function(teamspace){return teamspace.name===name})[0]},isSubModel=function(federation,model){var isSubModelOfFed=!1;return federation.subModels.forEach(function(submodel){submodel.model===model.model&&(isSubModelOfFed=!0)}),isSubModelOfFed},getNoneFederatedModels=function(federation,models){return models.filter(function(model){return!isSubModel(federation,model)})},removeFromFederation=function(federation,modelName){federation.subModels.forEach(function(submodel,i){submodel.model===modelName&&federation.subModels.splice(i,1)})},getProject=function(teamspaces,teamspaceName,projectName){var selectedTeamspace=teamspaces.filter(function(teamspace){return teamspace.name===teamspaceName})[0],selectedProject=selectedTeamspace.projects.filter(function(project){return project.name===projectName})[0];return selectedProject},getModels=function(teamspaces,teamspaceName,projectName){return getProject(teamspaces,teamspaceName,projectName).models},removeModelByProjectName=function(teamspaces,teamspaceName,projectName,modelName){var models=getModels(teamspaces,teamspaceName,projectName),project=getProject(teamspaces,teamspaceName,projectName);models.forEach(function(model,i){model.model===modelName&&project.models.splice(i,1)})},removeFromFederationByProjectName=function(teamspaces,teamspaceName,projectName,modelName){var federations=getFederationsByProjectName(teamspaces,teamspaceName,projectName);getProject(teamspaces,teamspaceName,projectName);federations.forEach(function(model,i){model.model===modelName&&model.subModels.splice(i,1)})},accountDataService={removeProjectInTeamspace:removeProjectInTeamspace,renameProjectInTeamspace:renameProjectInTeamspace,addProjectToTeamspace:addProjectToTeamspace,isSubModel:isSubModel,getNoneFederatedModels:getNoneFederatedModels,getModels:getModels,getProject:getProject,getProjectsByTeamspaceName:getProjectsByTeamspaceName,getTeamspaceByName:getTeamspaceByName,getIndividualModels:getIndividualModels,removeFromFederation:removeFromFederation,hasFederations:hasFederations,getFederations:getFederations,hasFederationsByProjectName:hasFederationsByProjectName,getFederationsByProjectName:getFederationsByProjectName,getIndividualModelsByProjectName:getIndividualModelsByProjectName,removeFromFederationByProjectName:removeFromFederationByProjectName,removeModelByProjectName:removeModelByProjectName,getIndividualTeamspaceModels:getIndividualTeamspaceModels};return accountDataService}angular.module("3drepo").factory("AccountDataService",AccountDataService),AccountDataService.$inject=[]}(),function(){"use strict";function accountDir(){return{restrict:"EA",templateUrl:"account.html",scope:{state:"=",query:"=",account:"=",keysDown:"="},controller:AccountCtrl,controllerAs:"vm",bindToController:!0}}function AccountCtrl($scope,$injector,$location,$timeout,AccountService,Auth,UtilsService){function loginStatusListener(event){"tdrLoggedIn"===event.key&&"false"===event.newValue&&Auth.logout()}function init(){var billingsPromise,subscriptionsPromise,plansPromise;getUserInfo(),billingsPromise=UtilsService.doGet(vm.account+"/invoices"),billingsPromise.then(function(response){vm.billings=response.data}),subscriptionsPromise=UtilsService.doGet(vm.account+"/subscriptions"),subscriptionsPromise.then(function(response){vm.subscriptions=response.data}),plansPromise=UtilsService.doGet("plans"),plansPromise.then(function(response){200===response.status&&(vm.plans=response.data)})}function getUserInfo(){var userInfoPromise;userInfoPromise=AccountService.getUserInfo(vm.account),userInfoPromise.then(function(response){var i,length;if(vm.accounts=response.data.accounts,vm.username=vm.account,vm.firstName=response.data.firstName,vm.lastName=response.data.lastName,vm.email=response.data.email,vm.hasAvatar=response.data.hasAvatar,vm.billingAddress={},response.data.hasOwnProperty("billingInfo")&&(vm.billingAddress=response.data.billingInfo,vm.billingAddress.hasOwnProperty("firstName")||(vm.billingAddress.firstName=vm.firstName,vm.billingAddress.lastName=vm.lastName)),angular.isDefined(vm.accounts))for(i=0,length=vm.accounts.length;i<length;i+=1)if(vm.accounts[i].account===vm.account){vm.quota=vm.accounts[i].quota;break}})}var vm=this;$scope.$watchGroup(["vm.account","vm.query.page"],function(){var promise;vm.account||vm.query.page?vm.query.hasOwnProperty("page")?($injector.has("account"+UtilsService.capitalizeFirstLetter(vm.query.page)+"Directive")?vm.itemToShow=vm.query.page:vm.itemToShow="teamspaces","billing"===vm.itemToShow?$location.search().hasOwnProperty("cancel")?($location.search("token",null),$location.search("cancel",null),init()):$location.search().hasOwnProperty("token")?(getUserInfo(),vm.payPalInfo="PayPal payment processing. Please do not refresh the page or close the tab.",vm.closeDialogEnabled=!1,UtilsService.showDialog("paypalDialog.html",$scope),promise=UtilsService.doPost({token:$location.search().token},"payment/paypal/execute"),promise.then(function(response){200===response.status,vm.payPalInfo="PayPal has finished processing. Thank you.",$location.search("token",null),$timeout(function(){UtilsService.closeDialog(),init()},2e3)})):init():init()):(vm.itemToShow="teamspaces",init()):(vm.username=null,vm.firstName=null,vm.lastName=null,vm.email=null,vm.modelsGrouped=null,vm.avatarUrl=null)}),vm.showItem=function(item){vm.itemToShow=item},vm.showPage=function(page,callingPage,data){vm.itemToShow=page,vm.callingPage=callingPage,vm.data=data},window.addEventListener("storage",loginStatusListener,!1),"false"===localStorage.getItem("tdrLoggedIn")&&null!==vm.account&&localStorage.setItem("tdrLoggedIn",vm.account)}angular.module("3drepo").directive("accountDir",accountDir),AccountCtrl.$inject=["$scope","$injector","$location","$timeout","AccountService","Auth","UtilsService"]}(),function(){"use strict";function accountFederations(){return{restrict:"EA",templateUrl:"accountFederations.html",scope:{account:"=",accounts:"=",federation:"=",project:"=",federationData:"=",federationIndex:"=",onShowPage:"&",quota:"=",subscriptions:"=",isDefaultFederation:"@",getPotentialFederationModels:"=",saveFederation:"=",addToFederation:"="},controller:AccountFederationsCtrl,controllerAs:"vm",bindToController:!0}}function AccountFederationsCtrl($scope,$location,$timeout,UtilsService,serverConfig,Auth,AnalyticService,AccountDataService){function getFederationOptions(model,account){account.account===vm.account.account;return{edit:{label:"Edit",icon:"edit",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_EDIT_FEDERATION,model.permissions)},delete:{label:"Delete",icon:"delete",color:"#F44336",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_DELETE_MODEL,model.permissions)}}}function setupEditFederation(event,teamspace,project,model){vm.federationData=model,vm.federationData.teamspace=teamspace.name,project&&project.name?vm.federationData.project=project.name:vm.federationData.project="default",vm.federationData._isEdit=!0,UtilsService.showDialog("federationDialog.html",$scope,event,!0)}function setupSetting(event,account,project,model){$location.search("proj",model.name),$location.search("targetAcct",account.account),vm.onShowPage({page:"modelsetting",callingPage:"teamspaces"})}function setupDelete(event,account,project,model){vm.deleteError=null,vm.deleteTitle="Delete Federation",vm.deleteWarning="This federation will be lost permanently and will not be recoverable",vm.deleteName=model.model,vm.projectToDeleteFrom=project,vm.currentAccount=account,UtilsService.showDialog("deleteDialog.html",$scope,event,!0,null,!1,dialogCloseToId)}function setupEditTeam(event,account,project,model){vm.item=model,vm.currentAccount=account,UtilsService.showDialog("teamDialog.html",$scope,event,!0,null,!1,dialogCloseToId)}var accountsToUse,dialogCloseToId,vm=this;vm.modelRegExp=serverConfig.modelNameRegExp,vm.getProjects=function(teamspace){var projects=AccountDataService.getProjectsByTeamspaceName(vm.accounts,teamspace);return projects},vm.units=server_config.units,vm.dialogCloseTo="accountFederationsOptionsMenu_"+vm.account.account,dialogCloseToId="#"+vm.dialogCloseTo,vm.showMenu=function(model,account){var isUserAccount=account.account===vm.account.account;return Auth.hasPermission(serverConfig.permissions.PERM_EDIT_FEDERATION,model.permissions)||Auth.hasPermission(serverConfig.permissions.PERM_CHANGE_MODEL_SETTINGS,model.permissions)||Auth.hasPermission(serverConfig.permissions.PERM_DELETE_MODEL,model.permissions)||isUserAccount},$scope.$watch("vm.accounts",function(){var i,length,account;if(angular.isDefined(vm.accounts)&&vm.accounts.length>0)for(accountsToUse=[],i=0,length=vm.accounts.length;i<length;i+=1)account=vm.accounts[i],account.fedModels&&account.fedModels.forEach(function(fedModel){fedModel.federationOptions=getFederationOptions(fedModel,account.account)}),account.projects&&account.projects.forEach(function(project){project.models.forEach(function(model){model.federate&&(model.federationOptions=getFederationOptions(model,account.account))})})}),vm.resetFederationData=function(){vm.federationData={}},vm.removeFromFederation=function(modelName){AccountDataService.removeFromFederation(vm.federationData,modelName)},vm.closeDialog=function(){UtilsService.closeDialog()},vm.viewFederation=function(event,account,project,model){model.hasOwnProperty("subModels")?($location.path("/"+account.name+"/"+model.model,"_self").search({}),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"view",eventLabel:"federation"})):setupEditFederation(event,model)},vm.doFederationOption=function(event,option,account,project,federation){switch(console.log(event,option,account,project,federation),option){case"edit":setupEditFederation(event,account,project,federation);break;case"team":setupEditTeam(event,account,project,federation);break;case"delete":console.log("Delete"),setupDelete(event,account,project,federation);break;case"modelsetting":setupSetting(event,account,project,federation)}},vm.deleteModel=function(federation){var promise=UtilsService.doDelete({},vm.currentAccount.name+"/"+vm.deleteName);promise.then(function(response){if(200===response.status){var account=vm.currentAccount;if(vm.projectToDeleteFrom&&vm.projectToDeleteFrom.name)AccountDataService.removeModelByProjectName(vm.accounts,account.name,vm.projectToDeleteFrom.name,response.data.model);else for(var j=0;j<account.fedModels.length;j++)if(console.log(account),console.log("Deleting from default",account.fedModels[j].model,response.data.model),account.fedModels[j].model===response.data.model){account.fedModels.splice(j,1);break}vm.closeDialog(),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"delete",eventLabel:"federation"})}else vm.deleteError="Error deleting federation"})}}angular.module("3drepo").directive("accountFederations",accountFederations),AccountFederationsCtrl.$inject=["$scope","$location","$timeout","UtilsService","serverConfig","Auth","AnalyticService","AccountDataService"]}(),function(){"use strict";function accountInfo(){return{restrict:"E",templateUrl:"accountInfo.html",scope:{username:"=",firstName:"=",lastName:"=",email:"=",itemToShow:"=",hasAvatar:"="},controller:AccountInfoCtrl,controllerAs:"vm",bindToController:!0}}function AccountInfoCtrl($location,$scope,serverConfig,UtilsService){function getAvatarUrl(){return serverConfig.apiUrl(serverConfig.GET_API,vm.username+"/avatar")+"?"+(new Date).valueOf()}var vm=this;vm.accountOptions={teamspaces:{label:"Teamspaces"},profile:{label:"Profile"},billing:{label:"Billing"},licenses:{label:"Licenses"}},vm.showItem=function(item){vm.itemToShow=item,$location.search({}).search("page",item)},$scope.$watchGroup(["vm.username","vm.hasAvatar"],function(){vm.username&&vm.hasAvatar&&(vm.avatarUrl=getAvatarUrl())}),vm.upload=function(){var file=document.createElement("input");file.setAttribute("type","file"),file.setAttribute("accept",".gif,.jpg,.jpeg,.png"),file.click(),file.addEventListener("change",function(){vm.uploadingAvatar=!0;var formData=new FormData;formData.append("file",file.files[0]),UtilsService.doPost(formData,vm.username+"/avatar",{"Content-Type":void 0}).then(function(res){vm.uploadingAvatar=!1,200===res.status?vm.avatarUrl=getAvatarUrl():console.error("Upload avatar error",res.data)}),$scope.$apply()})}}angular.module("3drepo").directive("accountInfo",accountInfo),AccountInfoCtrl.$inject=["$location","$scope","serverConfig","UtilsService"]}(),function(){"use strict";function accountLicenses(){return{restrict:"EA",templateUrl:"accountLicenses.html",scope:{account:"=",showPage:"&"},controller:AccountLicensesCtrl,controllerAs:"vm",bindToController:!0}}function AccountLicensesCtrl($scope,UtilsService,StateManager){var i,promise,vm=this;UtilsService.doGet(vm.account+"/subscriptions").then(function(res){vm.subscriptions=res.data}),$scope.$watch("vm.subscriptions",function(){if(vm.subscriptions){for(vm.unassigned=[],vm.licenses=[],vm.allLicensesAssigned=!1,vm.numLicensesAssigned=0,vm.numLicenses=vm.subscriptions.length,vm.toShow=vm.numLicenses>0?"0+":"0",i=0;i<vm.numLicenses;i+=1)vm.subscriptions[i].hasOwnProperty("assignedUser")?vm.licenses.push({user:vm.subscriptions[i].assignedUser,id:vm.subscriptions[i]._id,job:vm.subscriptions[i].job,showRemove:vm.subscriptions[i].assignedUser!==vm.account}):vm.unassigned.push(vm.subscriptions[i]._id);vm.allLicensesAssigned=0===vm.unassigned.length,vm.numLicensesAssigned=vm.numLicenses-vm.unassigned.length}}),$scope.$watch("vm.newLicenseAssignee",function(newValue){vm.addMessage="",vm.addDisabled=!(angular.isDefined(newValue)&&""!==newValue.toString())}),vm.jobs=[],UtilsService.doGet(vm.account+"/jobs").then(function(data){vm.jobs=data.data}),vm.assignJob=function(index){var licence=vm.licenses[index];UtilsService.doPut({job:licence.job},vm.account+"/subscriptions/"+licence.id+"/assign").then(function(res){200!==res.status&&(vm.addMessage=res.data.message)})},vm.addJob=function(){var job={_id:vm.newJob};vm.addJobMessage=null,UtilsService.doPost(job,vm.account+"/jobs").then(function(res){200!==res.status?vm.addJobMessage=res.data.message:vm.jobs.push(job)})},vm.removeJob=function(index){vm.deleteJobMessage=null,UtilsService.doDelete(null,vm.account+"/jobs/"+vm.jobs[index]._id).then(function(res){200!==res.status?vm.deleteJobMessage=res.data.message:vm.jobs.splice(index,1)})},vm.assignLicense=function(event){var doSave=!1,enterKey=13;angular.isDefined(event)?event.which===enterKey&&(doSave=!0):doSave=!0,doSave&&(promise=UtilsService.doPost({user:vm.newLicenseAssignee},vm.account+"/subscriptions/"+vm.unassigned[0]+"/assign"),promise.then(function(response){200===response.status?(vm.addMessage="User "+vm.newLicenseAssignee+" assigned a license",vm.licenses.push({user:response.data.assignedUser,id:response.data._id,showRemove:!0}),vm.unassigned.splice(0,1),vm.allLicensesAssigned=0===vm.unassigned.length,vm.numLicensesAssigned=vm.numLicenses-vm.unassigned.length,vm.addDisabled=vm.allLicensesAssigned,vm.newLicenseAssignee=""):400===response.status?vm.addMessage="This user has already been assigned a license":404===response.status&&(vm.addMessage="User not found")}))},vm.removeLicense=function(index){promise=UtilsService.doDelete({},vm.account+"/subscriptions/"+vm.licenses[index].id+"/assign"),promise.then(function(response){if(200===response.status)vm.unassigned.push(vm.licenses[index].id),vm.licenses.splice(index,1),vm.addDisabled=!1,vm.allLicensesAssigned=!1,vm.numLicensesAssigned=vm.numLicenses-vm.unassigned.length;else if(400===response.status){UtilsService.getErrorMessage(response.data);response.data.value===UtilsService.getResponseCode("USER_IN_COLLABORATOR_LIST")&&(vm.licenseAssigneeIndex=index,vm.userModels=response.data.models,UtilsService.showDialog("removeLicenseDialog.html",$scope))}})},vm.removeLicenseConfirmed=function(){promise=UtilsService.doDelete({},vm.account+"/subscriptions/"+vm.licenses[vm.licenseAssigneeIndex].id+"/assign?cascadeRemove=true"),promise.then(function(response){200===response.status&&(vm.unassigned.push(vm.licenses[vm.licenseAssigneeIndex].id),vm.licenses.splice(vm.licenseAssigneeIndex,1),vm.addDisabled=!1,vm.allLicensesAssigned=!1,vm.numLicensesAssigned=vm.numLicenses-vm.unassigned.length,UtilsService.closeDialog())})},vm.goToBillingPage=function(){StateManager.setQuery({page:"billing"})}}angular.module("3drepo").directive("accountLicenses",accountLicenses),AccountLicensesCtrl.$inject=["$scope","UtilsService","StateManager"]}(),function(){"use strict";function accountMenu(){return{restrict:"EA",templateUrl:"accountMenu.html",scope:{account:"="},controller:AccountMenuCtrl,controllerAs:"vm",bindToController:!0}}function AccountMenuCtrl(Auth,EventService){var vm=this;vm.openMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)},vm.showModels=function(){EventService.send(EventService.EVENT.SHOW_models)},vm.logout=function(){Auth.logout()},vm.openUserManual=function(){window.open("http://3drepo.org/models/3drepo-io-user-manual/","_blank")}}angular.module("3drepo").directive("accountMenu",accountMenu),AccountMenuCtrl.$inject=["Auth","EventService"]}(),function(){"use strict";function accountModel(){return{restrict:"E",templateUrl:"accountModel.html",scope:{account:"=",model:"=",project:"=",userAccount:"=",onUploadFile:"&",uploadedFile:"=",modelToUpload:"=",onShowPage:"&",onSetupDeleteModel:"&",quota:"=",isAccountAdmin:"=",subscriptions:"="},controller:AccountModelCtrl,controllerAs:"vm",bindToController:!0,link:function(scope,element){element.on("$destroy",function(){scope.vm.uploadedFileWatch(),scope.vm.modelToUploadFileWatch()})}}}function AccountModelCtrl($scope,$location,$timeout,$interval,$filter,UtilsService,serverConfig,RevisionsService,NotificationService,Auth,AnalyticService,AccountDataService){function uploadFileToModel(file,tag,desc){var promise,formData;promise=UtilsService.doGet(vm.userAccount+".json"),promise.then(function(response){response.data.accounts.find(function(account){return account.account===vm.account});file.size>serverConfig.uploadSizeLimit?$timeout(function(){vm.fileUploadInfo="File exceeds size limit",$timeout(function(){vm.fileUploadInfo=""},infoTimeout)}):(formData=new FormData,formData.append("file",file),tag&&formData.append("tag",tag),desc&&formData.append("desc",desc),promise=UtilsService.doPost(formData,vm.account+"/"+vm.model.name+"/upload",{"Content-Type":void 0}),promise.then(function(response){400===response.status||404===response.status?(vm.model.uploading=!1,vm.fileUploadInfo=UtilsService.getErrorMessage(response.data),$timeout(function(){vm.fileUploadInfo=""},infoTimeout)):AnalyticService.sendEvent({eventCategory:"Model",eventAction:"upload"})}))})}function watchModelStatus(){NotificationService.subscribe.modelStatusChanged(vm.account,vm.model.model,function(data){"ok"===data.status||"failed"===data.status?("ok"!==data.status&&data.errorReason.value!==UtilsService.getResponseCode("FILE_IMPORT_MISSING_TEXTURES")&&data.errorReason.value!==UtilsService.getResponseCode("FILE_IMPORT_MISSING_NODES")||(vm.model.timestamp=new Date,vm.model.timestampPretty=$filter("prettyDate")(vm.model.timestamp,{
showSeconds:!0}),vm.fileUploadInfo="Model imported successfully",vm.revisions=null),data.hasOwnProperty("errorReason")&&data.errorReason.message?vm.fileUploadInfo=data.errorReason.message:"failed"===data.status&&(vm.fileUploadInfo="Failed to import model"),vm.model.uploading=!1,$scope.$apply(),$timeout(function(){vm.fileUploadInfo=""},infoTimeout)):"uploading"===data.status?(vm.model.uploading=!0,vm.fileUploadInfo="Uploading...",$scope.$apply()):"processing"===data.status&&(vm.model.uploading=!0,vm.fileUploadInfo="Processing...",$scope.$apply())}),$scope.$on("$destroy",function(){NotificationService.unsubscribe.modelStatusChanged(vm.account,vm.model.model)})}function setupEditTeam(event){vm.item=vm.model,UtilsService.showDialog("teamDialog.html",$scope,event,!0,null,!1,dialogCloseToId)}var dialogCloseToId,vm=this,infoTimeout=4e3,isUserAccount=vm.account===vm.userAccount;vm.modelToUpload=null,vm.model.name=vm.model.model,vm.dialogCloseTo="accountModelsOptionsMenu_"+vm.account+"_"+vm.model.name,dialogCloseToId="#"+vm.dialogCloseTo,null!==vm.model.timestamp&&(vm.model.timestampPretty=$filter("prettyDate")(vm.model.timestamp,{showSeconds:!0})),vm.model.canUpload=!0,vm.modelOptions={upload:{label:"Upload file",icon:"cloud_upload",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_UPLOAD_FILES,vm.model.permissions)},team:{label:"Team",icon:"group",hidden:!isUserAccount},revision:{label:"Revisions",icon:"settings_backup_restore",hidden:!1},modelsetting:{label:"Settings",icon:"settings",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_CHANGE_MODEL_SETTINGS,vm.model.permissions)}},vm.model.timestamp&&!vm.model.federate&&(vm.modelOptions.download={label:"Download",icon:"cloud_download",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_DOWNLOAD_MODEL,vm.model.permissions)}),vm.uploadButtonDisabled=!0,vm.modelOptions.delete={label:"Delete",icon:"delete",hidden:!Auth.hasPermission(serverConfig.permissions.PERM_DELETE_MODEL,vm.model.permissions),color:"#F44336"},watchModelStatus(),"processing"===vm.model.status&&(vm.model.uploading=!0,vm.fileUploadInfo="Processing..."),vm.uploadedFileWatch=$scope.$watch("vm.uploadedFile",function(){angular.isDefined(vm.uploadedFile)&&null!==vm.uploadedFile&&vm.uploadedFile.model.name===vm.model.name&&vm.uploadedFile.account===vm.account&&uploadFileToModel(vm.uploadedFile.file,vm.uploadedFile.tag,vm.uploadedFile.desc)}),vm.modelToUploadFileWatch=$scope.$watch("vm.modelToUpload",function(){if(vm.modelToUpload){var names=vm.modelToUpload.name.split(".");vm.uploadErrorMessage=null,1===names.length?(vm.uploadErrorMessage="Filename must have extension",vm.modelToUpload=null,vm.uploadButtonDisabled=!0):serverConfig.acceptedFormat.indexOf(names[names.length-1].toLowerCase())===-1?(vm.uploadErrorMessage="File format not supported",vm.modelToUpload=null,vm.uploadButtonDisabled=!0):vm.uploadButtonDisabled=!1}}),vm.goToModel=function(){vm.model.uploading||(null===vm.model.timestamp?Auth.hasPermission(serverConfig.permissions.PERM_UPLOAD_FILES,vm.model.permissions)?(vm.tag=null,vm.desc=null,vm.modelToUpload=null,UtilsService.showDialog("uploadModelDialog.html",$scope,event,!0,null,!1,dialogCloseToId)):console.warn("Incorrect permissions"):($location.path("/"+vm.account+"/"+vm.model.name,"_self").search("page",null),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"view"})))},vm.doModelOption=function(event,option){switch(option){case"modelsetting":$location.search("proj",vm.model.name),$location.search("targetAcct",vm.account),vm.onShowPage({page:"modelsetting",callingPage:"teamspaces"});break;case"upload":vm.uploadErrorMessage=null,vm.modelToUpload=null,vm.tag=null,vm.desc=null,UtilsService.showDialog("uploadModelDialog.html",$scope,event,!0,null,!1,dialogCloseToId);break;case"download":window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/"+vm.model.name+"/download/latest"),"_blank"),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"download"});break;case"team":setupEditTeam(event);break;case"delete":vm.onSetupDeleteModel({event:event,model:vm.model,account:vm.account,project:vm.project});break;case"revision":vm.revisions||UtilsService.doGet(vm.account+"/"+vm.model.name+"/revisions.json").then(function(response){vm.revisions=response.data}),UtilsService.showDialog("revisionsDialog.html",$scope,event,!0,null,!1,dialogCloseToId)}},vm.setupAddLicenses=function(){vm.onShowPage({page:"billing",callingPage:"teamspaces"}),UtilsService.closeDialog()},vm.closeDialog=function(){UtilsService.closeDialog()},vm.selectFile=function(){vm.onUploadFile({model:vm.model,account:vm.account})},vm.uploadFile=function(){var revisions;vm.uploadErrorMessage=null,vm.tag&&RevisionsService.isTagFormatInValid(vm.tag)?vm.uploadErrorMessage="Invalid revision name":UtilsService.doGet(vm.account+"/"+vm.model.name+"/revisions.json").then(function(response){revisions=response.data,vm.tag&&revisions.forEach(function(rev){rev.tag===vm.tag&&(vm.uploadErrorMessage="Revision name already exists")}),vm.uploadErrorMessage||(vm.uploadedFile={model:vm.model,account:vm.account,file:vm.modelToUpload,tag:vm.tag,desc:vm.desc},vm.closeDialog())})},vm.goToRevision=function(revId){$location.path("/"+vm.account+"/"+vm.model.name+"/"+revId,"_self"),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"view"})}}angular.module("3drepo").directive("accountModel",accountModel),AccountModelCtrl.$inject=["$scope","$location","$timeout","$interval","$filter","UtilsService","serverConfig","RevisionsService","NotificationService","Auth","AnalyticService","AccountDataService"]}(),function(){"use strict";function accountModels(){return{restrict:"EA",templateUrl:"accountModels.html",scope:{account:"=",accounts:"=",onShowPage:"&",quota:"=",subscriptions:"="},controller:AccountModelsCtrl,controllerAs:"vm",bindToController:!0}}function AccountModelsCtrl($scope,$location,$element,$timeout,AccountService,UtilsService,RevisionsService,serverConfig,AnalyticService,NotificationService,Auth,AccountDataService){function updateAccountModels(account,model,projectName){var i,length,accountToUpdate,found=!1;for(i=0,length=vm.accounts.length;i<length;i+=1)if(vm.accounts[i].name===account){accountToUpdate=vm.accounts[i],accountToUpdate.projects.forEach(function(project){project.name===projectName&&(project.models.push(model),found=!0)}),found||accountToUpdate.models.push(model);break}angular.isUndefined(accountToUpdate)&&(accountToUpdate={name:account,models:[model]},accountToUpdate.canUpload=account===vm.account,vm.accounts.push(accountToUpdate)),null!==vm.newModelFileToUpload&&$timeout(function(){vm.uploadedFile={account:account,model:model,file:vm.newModelFileToUpload,tag:vm.tag,desc:vm.desc,newModel:!0}})}var existingModelToUpload,existingModelFileUploader,newModelFileUploader,vm=this;vm.info="Retrieving models...",vm.showProgress=!0,vm.modelTypes=["Architectural","Structural","Mechanical","GIS","Other"],vm.units=serverConfig.units,vm.modelRegExp=serverConfig.modelNameRegExp,existingModelFileUploader=$element[0].querySelector("#existingModelFileUploader"),existingModelFileUploader.addEventListener("change",function(){vm.modelToUpload=this.files[0],$scope.$apply()},!1),newModelFileUploader=$element[0].querySelector("#newModelFileUploader"),newModelFileUploader.addEventListener("change",function(){vm.newModelFileToUpload=this.files[0],$scope.$apply()},!1),vm.closeDialog=function(){UtilsService.closeDialog()},vm.addEscape=function(event){$element.bind("keydown keypress",function(event){27===event.which&&(vm.addButtons=!1,$scope.$apply(),event.preventDefault())})},vm.showDefault={project:!1,models:!1,feds:!1};var getState=function(node,prop){return void 0===node[prop]&&(node[prop]=!1),node[prop]};vm.shouldShow=function(items,type){switch(type){case"models":return getState(items,"modelsState");case"federations":return getState(items,"fedsState");default:return getState(items,"state")}},vm.toggleTeamspace=function(teamspace){teamspace.state=!teamspace.state},vm.toggleDefault=function(type){return vm.showDefault[type]=!vm.showDefault[type],vm.showDefault[type]},vm.toggleProjects=function(projects){projects.state=!projects.state},vm.toggleProject=function(project){project.state=!project.state,project.models.forEach(function(model){model.modelState=!!project.state,model.fedState=!!project.state})},vm.toggleModels=function(project){project.modelsState=!project.modelsState},vm.toggleFederations=function(project){project.fedsState=!project.fedsState},vm.hasFederations=function(models){return AccountDataService.hasFederations(models)},vm.getFederations=function(models){return AccountDataService.getFederations(models)},vm.getIndividualModels=function(models){return AccountDataService.getIndividualModels(models)},vm.getProjects=function(teamspace){return AccountDataService.getProjectsByTeamspaceName(vm.accounts,teamspace)},vm.addButtons=!1,vm.addButtonType="add",vm.addButtonsToggle=function(){vm.addButtons=!vm.addButtons,vm.addButtonType="add"===vm.addButtonType?"clear":"add"},vm.saveFederation=function(teamspaceName,projectName){var promise,project=AccountDataService.getProject(vm.accounts,teamspaceName,projectName),isEdit=vm.federationData._isEdit;isEdit?(delete vm.federationData._isEdit,promise=UtilsService.doPut(vm.federationData,teamspaceName+"/"+vm.federationData.model)):promise=UtilsService.doPost(vm.federationData,teamspaceName+"/"+vm.federationData.model),promise.then(function(response){200!==response.status&&201!==response.status?vm.errorMessage=response.data.message:(vm.errorMessage="",vm.showInfo=!1,vm.federationData.teamspace=teamspaceName,vm.federationData.project=projectName,vm.federationData.federate=!0,vm.federationData.timestamp=(new Date).toString(),vm.federationData.permissions=response.data.permissions||vm.federationData.permissions,isEdit||project.models.push(vm.federationData),vm.closeDialog(),AnalyticService.sendEvent({eventCategory:"Model",eventAction:vm.federationData._isEdit?"edit":"create",eventLabel:"federation"}))}),$timeout(function(){$scope.$apply()})},vm.getPotentialFederationModels=function(isDefault){var models;models=isDefault?AccountDataService.getIndividualModelsByProjectName(vm.accounts,vm.federationData.teamspace,vm.federationData.project):AccountDataService.getIndividualTeamspaceModels(vm.accounts,vm.federationData.teamspace);var noneFederated=AccountDataService.getNoneFederatedModels(vm.federationData,models);return noneFederated},vm.removeFromFederation=function(modelName){AccountDataService.removeFromFederation(vm.federationData,modelName)},vm.addToFederation=function(modelIndex,teamspaceName,models){vm.showRemoveWarning=!1,vm.federationData.subModels.push({database:teamspaceName,modelIndex:modelIndex,model:models[modelIndex].model}),models[modelIndex].federate=!0},vm.dialogCloseTo="accountFederationsOptionsMenu_"+vm.account;var dialogCloseToId="#"+vm.dialogCloseTo;$scope.$watch("vm.federationData",function(oldVal,newVal){},!0),vm.setupNewFederation=function(event,accounts){vm.federationOriginalData=null,vm.federationData={desc:"",type:"",subModels:[]},vm.errorMessage="",UtilsService.showDialog("federationDialog.html",$scope,event,!0,null,!1,dialogCloseToId)},$scope.$watch("vm.newModelData.type",function(newValue){angular.isDefined(newValue)&&(vm.showModelTypeOtherInput="Other"===newValue.toString())}),$scope.$watch("{a : vm.newModelData, b: vm.newModelFileToUpload.name}",function(data){var newValue=vm.newModelData;if(angular.isDefined(newValue)&&(vm.newModelButtonDisabled=angular.isUndefined(newValue.name)||angular.isDefined(newValue.name)&&""===newValue.name,vm.newModelButtonDisabled||"Other"!==newValue.type||(vm.newModelButtonDisabled=angular.isUndefined(newValue.otherType)||angular.isDefined(newValue.otherType)&&""===newValue.otherType),newValue.unit||(vm.newModelButtonDisabled=!0)),vm.newModelFileToUpload){vm.showNewModelErrorMessage=!1,vm.newModelErrorMessage="";var names=vm.newModelFileToUpload.name.split("."),find=names[names.length-1].toLowerCase(),match=serverConfig.acceptedFormat.indexOf(find)===-1;1===names.length?(vm.showNewModelErrorMessage=!0,vm.newModelErrorMessage="Filename must have extension",vm.newModelFileToUpload=null):match&&(vm.showNewModelErrorMessage=!0,vm.newModelErrorMessage="File format not supported",vm.newModelFileToUpload=null)}},!0),vm.setupDeleteModel=function(event,model,account,project){vm.modelToDelete=model,vm.projectToDeleteFrom=project,vm.deleteError=null,vm.deleteTitle="Delete model",vm.deleteWarning="Your data will be lost permanently and will not be recoverable",vm.deleteName=vm.modelToDelete.name,vm.targetAccountToDeleteModel=account,UtilsService.showDialog("deleteDialog.html",$scope,event,!0)},vm.deleteModel=function(){var account,url=vm.targetAccountToDeleteModel+"/"+vm.modelToDelete.name,promise=UtilsService.doDelete({},url);promise.then(function(response){if(200===response.status){for(var i=0;i<vm.accounts.length;i+=1)if(account=vm.accounts[i],account.name===response.data.account){if(vm.projectToDeleteFrom&&vm.projectToDeleteFrom.name){var projectToDeleteFrom=vm.projectToDeleteFrom.name;AccountDataService.removeModelByProjectName(vm.accounts,account.name,projectToDeleteFrom,response.data.model),AccountDataService.removeFromFederationByProjectName(vm.accounts,account.name,projectToDeleteFrom,response.data.model);break}for(var j=0;j<vm.accounts[i].models.length;j+=1)if(account.models[j].name===response.data.model){account.models.splice(j,1);break}}vm.closeDialog(),AnalyticService.sendEvent({eventCategory:"Model",eventAction:"delete"})}else vm.deleteError="Error deleting model",404===response.status&&(vm.deleteError+=" : File not found"),500===response.status&&(vm.deleteError+=" : There was a problem on the server")})},vm.teamspaceAndProjectSelected=!1,$scope.$watch("vm.newModelData.teamspace",function(newValue){newValue&&vm.newModelData.project?vm.teamspaceAndProjectSelected=!0:vm.teamspaceAndProjectSelected=!1}),$scope.$watch("vm.newModelData.project",function(newValue){newValue&&vm.newModelData.teamspace?vm.teamspaceAndProjectSelected=!0:vm.teamspaceAndProjectSelected=!1}),vm.newModel=function(event,accountForModel){vm.tag=null,vm.desc=null,vm.showNewModelErrorMessage=!1,vm.newModelFileToUpload=null,vm.newModelData={account:accountForModel,type:vm.modelTypes[0]},vm.newModelFileToUpload=null,UtilsService.showDialog("modelDialog.html",$scope,event,!0)},vm.saveNewModel=function(event){var model,promise,enterKey=13,doSave=!1;if(angular.isDefined(event)?event.which===enterKey&&(doSave=!0):doSave=!0,doSave){if(RevisionsService.isTagFormatInValid(vm.tag))return vm.showNewModelErrorMessage=!0,void(vm.newModelErrorMessage="Invalid revision name");if(!vm.newModelData.name)return vm.showNewModelErrorMessage=!0,void(vm.newModelErrorMessage="Invalid model name");promise=AccountService.newModel(vm.newModelData),promise.then(function(response){400===response.data.status?(vm.showNewModelErrorMessage=!0,vm.newModelErrorMessage=response.data.message):(vm.modelsExist=!0,model={model:response.data.model,project:vm.newModelData.project,permissions:response.data.permissions,canUpload:!0,timestamp:null},updateAccountModels(response.data.account,model,vm.newModelData.project),vm.closeDialog(),AnalyticService.sendEvent({eventCategory:"model",eventAction:"create"}))})}},vm.uploadFile=function(model){existingModelFileUploader.value="",existingModelToUpload=model,existingModelFileUploader.click()},vm.uploadFileForNewModel=function(){newModelFileUploader.value="",newModelFileUploader.click()},vm.setupPayment=function(){$timeout(function(){vm.showPaymentWait=!0})},vm.showPage=function(page,callingPage){vm.onShowPage({page:page,callingPage:callingPage})},vm.projectData={deleteName:"",deleteTeamspace:"",deleteWarning:"",teamspaceName:"",newProjectName:"",oldProjectName:"",errorMessage:"",projectOptions:{edit:{label:"Edit",icon:"edit"},delete:{label:"Delete",icon:"delete"}}},vm.doProjectOption=function(option,project,teamspace){switch(option){case"delete":vm.projectData.deleteName=project.name,vm.projectData.deleteTeamspace=teamspace.name,vm.projectData.deleteWarning="This will remove the project from your teamspace!",UtilsService.showDialog("deleteProjectDialog.html",$scope,event,!0);break;case"edit":vm.editProject(project,teamspace)}},vm.newProject=function(){vm.projectData.teamspaceName="",vm.projectData.newProjectName="",vm.projectData.oldProjectName="",vm.projectData.errorMessage="",UtilsService.showDialog("projectDialog.html",$scope,event,!0)},vm.editProject=function(project,teamspace){vm.projectData.oldProjectName=project.name,vm.projectData.teamspaceName=teamspace.name,vm.projectData.newProjectName=project.name,vm.projectData.errorMessage="",UtilsService.showDialog("projectDialog.html",$scope,event,!0)},vm.saveNewProject=function(teamspaceName,projectName){var url=teamspaceName+"/projects/",promise=UtilsService.doPost({name:projectName},url);vm.handleProjectPromise(promise,teamspaceName,!1)},vm.updateProject=function(teamspaceName,oldProjectName,newProjectName){var url=teamspaceName+"/projects/"+oldProjectName,promise=UtilsService.doPut({name:newProjectName},url);vm.handleProjectPromise(promise,teamspaceName,{edit:!0,newProjectName:newProjectName,oldProjectName:oldProjectName})},vm.deleteProject=function(teamspaceName,projectName){var url=teamspaceName+"/projects/"+projectName,promise=UtilsService.doDelete({},url);vm.handleProjectPromise(promise,teamspaceName,{projectName:projectName,delete:!0})},vm.handleProjectPromise=function(promise,teamspaceName,update){promise.then(function(response){if(200!==response.status&&201!==response.status)vm.projectData.errorMessage=response.data.message;else{var project=response.data;update.edit?AccountDataService.renameProjectInTeamspace(vm.accounts,teamspaceName,update.newProjectName,update.oldProjectName):update.delete?AccountDataService.removeProjectInTeamspace(vm.accounts,teamspaceName,update.projectName):AccountDataService.addProjectToTeamspace(vm.accounts,teamspaceName,project),vm.errorMessage="",delete vm.newProjectTeamspace,delete vm.newProjectName,vm.closeDialog()}})},$scope.$watch("vm.accounts",function(){if(angular.isDefined(vm.accounts))for(var i=0;i<vm.accounts.length;i++)vm.accounts[i].name=vm.accounts[i].account,vm.accounts[i].canAddModel=vm.accounts[i].isAdmin})}angular.module("3drepo").directive("accountModels",accountModels),AccountModelsCtrl.$inject=["$scope","$location","$element","$timeout","AccountService","UtilsService","RevisionsService","serverConfig","AnalyticService","NotificationService","Auth","AccountDataService"]}(),function(){"use strict";function accountModelsetting(){return{restrict:"EA",templateUrl:"accountModelsetting.html",scope:{account:"=",showPage:"&",subscriptions:"=",data:"="},controller:AccountModelsettingCtrl,controllerAs:"vm",bindToController:!0}}function AccountModelsettingCtrl($scope,$location,UtilsService,StateManager){function convertTopicTypesToString(topicTypes){var result=[];return topicTypes.forEach(function(type){result.push(type.label)}),result.join("\n")}var vm=this;vm.goBack=function(){vm.showPage({page:"teamspaces",data:vm.data})},vm.units=server_config.units,vm.mapTile={},vm.modelName=$location.search().proj,vm.targetAcct=$location.search().targetAcct,UtilsService.doGet(vm.targetAcct+"/"+vm.modelName+".json").then(function(response){200===response.status&&response.data.properties?(response.data.properties.mapTile&&(response.data.properties.mapTile.lat&&(vm.mapTile.lat=response.data.properties.mapTile.lat),response.data.properties.mapTile.lon&&(vm.mapTile.lon=response.data.properties.mapTile.lon),response.data.properties.mapTile.y&&(vm.mapTile.y=response.data.properties.mapTile.y)),vm.modelType=response.data.type,response.data.properties.topicTypes&&(vm.topicTypes=convertTopicTypesToString(response.data.properties.topicTypes)),response.data.properties.code&&(vm.code=response.data.properties.code),response.data.properties.unit&&(vm.unit=response.data.properties.unit),vm.oldUnit=vm.unit):vm.message=response.data.message}),vm.save=function(){var data={mapTile:vm.mapTile,unit:vm.unit,code:vm.code,topicTypes:vm.topicTypes.replace(/\r/g,"").split("\n")};UtilsService.doPut(data,vm.targetAcct+"/"+vm.modelName+"/settings").then(function(response){200===response.status?(vm.message="Saved",response.data.properties.topicTypes&&(vm.topicTypes=convertTopicTypesToString(response.data.properties.topicTypes)),vm.oldUnit=vm.unit):vm.message=response.data.message})}}angular.module("3drepo").directive("accountModelsetting",accountModelsetting),AccountModelsettingCtrl.$inject=["$scope","$location","UtilsService","StateManager"]}(),function(){"use strict";function accountProfile(){return{restrict:"EA",templateUrl:"accountProfile.html",scope:{username:"=",firstName:"=",lastName:"=",email:"="},controller:AccountProfileCtrl,controllerAs:"vm",bindToController:!0}}function AccountProfileCtrl(AccountService){var promise,vm=this;vm.showInfo=!0,vm.showChangePassword=!1,vm.firstNameNew=vm.firstName,vm.lastNameNew=vm.lastName,vm.emailNew=vm.email,vm.updateInfo=function(){promise=AccountService.updateInfo(vm.username,{email:vm.emailNew,firstName:vm.firstNameNew,lastName:vm.lastNameNew}),promise.then(function(response){"OK"===response.statusText?(vm.infoSaveInfo="Saved",vm.firstName=vm.firstNameNew,vm.lastName=vm.lastNameNew,vm.email=vm.emailNew):vm.infoSaveInfo=response.data.message})},vm.updatePassword=function(){promise=AccountService.updatePassword(vm.username,{oldPassword:vm.oldPassword,newPassword:vm.newPassword}),promise.then(function(response){"OK"===response.statusText?vm.passwordSaveInfo="Saved":vm.passwordSaveInfo=response.data.message})},vm.toggleInfo=function(){vm.showInfo=!vm.showInfo},vm.toggleChangePassword=function(){vm.showChangePassword=!vm.showChangePassword}}angular.module("3drepo").directive("accountProfile",accountProfile),AccountProfileCtrl.$inject=["AccountService"]}(),function(){"use strict";function accountProject(){return{restrict:"E",templateUrl:"accountProject.html",scope:{projectData:"="},controller:AccountProjectCtrl,controllerAs:"vm",bindToController:!0}}function AccountProjectCtrl($scope){}angular.module("3drepo").directive("accountProject",accountProject),AccountProjectCtrl.$inject=["$scope"]}(),function(){"use strict";function AccountService($http,$q,serverConfig,UtilsService){function doPost(data,urlEnd,headers){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,urlEnd),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(url,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}function doPut(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,urlEnd),config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise}var obj={};return obj.updateInfo=function(username,info){return doPut(info,username)},obj.updatePassword=function(username,passwords){return doPut(passwords,username)},obj.newModel=function(modelData){var data={desc:"",project:modelData.project,type:"Other"===modelData.type?modelData.otherType:modelData.type,unit:modelData.unit,code:modelData.code};return doPost(data,modelData.teamspace+"/"+encodeURIComponent(modelData.name))},obj.uploadModel=function(modelData){var data=new FormData;return data.append("file",modelData.uploadFile),doPost(data,modelData.teamspace+"/"+modelData.model+"/upload",{"Content-Type":void 0})},obj.uploadStatus=function(modelData){return UtilsService.doGet(modelData.teamspace+"/"+modelData.model+".json")},obj.newSubscription=function(teamspace,data){return doPost(data,teamspace+"/subscriptions")},obj.getUserInfo=function(username){return UtilsService.doGet(username+".json")},obj}angular.module("3drepo").factory("AccountService",AccountService),AccountService.$inject=["$http","$q","serverConfig","UtilsService"]}(),function(){"use strict";function accountTeam(){return{restrict:"EA",templateUrl:"accountTeam.html",scope:{account:"=",item:"=",showPage:"&",subscriptions:"="},controller:AccountTeamCtrl,controllerAs:"vm",bindToController:!0}}function AccountTeamCtrl($scope,$location,$timeout,UtilsService,StateManager){function createFilterFor(query){var lowercaseQuery=angular.lowercase(query);return function(user){return 0===user.user.indexOf(lowercaseQuery)}}function setupTeam(){var i,iLength,j,jLength,isMember;for(i=0,iLength=vm.numSubscriptions;i<iLength;i+=1)if(vm.subscriptions[i].hasOwnProperty("assignedUser")&&vm.subscriptions[i].assignedUser!==vm.account){for(isMember=!1,j=0,jLength=vm.members.length;j<jLength;j+=1)if(vm.members[j].user===vm.subscriptions[i].assignedUser){isMember=!0;break}isMember||vm.collaborators.push({user:vm.subscriptions[i].assignedUser})}vm.numSubscriptions=vm.subscriptions.filter(function(sub){return sub.inCurrentAgreement}).length,vm.noLicensesAssigned=vm.numSubscriptions>1&&vm.collaborators.length+vm.members.length===0,vm.notAllLicensesAssigned=!vm.noLicensesAssigned&&vm.numSubscriptions>1&&vm.numSubscriptions-1!==vm.collaborators.length+vm.members.length,vm.allLicenseAssigneesMembers=0===vm.collaborators.length}var promise,vm=this;vm.memberRole="collaborator",vm.collaborators=[],vm.members=[],vm.addDisabled=!1,vm.numSubscriptions=vm.subscriptions.length,vm.toShow=vm.numSubscriptions>1?"1+":vm.numSubscriptions.toString(),vm.showList=!0,promise=UtilsService.doGet(vm.account+"/"+vm.item.model+"/permissions"),promise.then(function(response){200===response.status&&(vm.members=response.data,angular.isDefined("vm.subscriptions")&&setupTeam())}),$scope.$watch("vm.selectedUser",function(newValue){vm.addDisabled=!(angular.isDefined(newValue)&&null!==newValue)}),vm.goBack=function(){$location.search("model",null),vm.showPage({page:"teamspaces"})},vm.addMember=function(){var i,length,data={permission:vm.memberRole,user:vm.selectedUser.user};promise=UtilsService.doPost(vm.members.concat([data]),vm.account+"/"+vm.item.model+"/permissions"),promise.then(function(response){if(200===response.status){for(vm.members.push(data),i=0,length=vm.collaborators.length;i<length;i+=1)if(vm.collaborators[i].user===vm.selectedUser.user){vm.collaborators.splice(i,1);break}vm.searchText=null,vm.selectedUser=null,vm.addDisabled=0===vm.collaborators.length,vm.allLicenseAssigneesMembers=0===vm.collaborators.length,vm.showList=!1,$timeout(function(){vm.showList=!0,$scope.$apply()})}})},vm.removeMember=function(index){var member=vm.members.splice(index,1);promise=UtilsService.doPost(vm.members,vm.account+"/"+vm.item.model+"/permissions"),promise.then(function(response){200===response.status?(vm.collaborators.push(member[0]),vm.addDisabled=!1,vm.allLicenseAssigneesMembers=!1):vm.members.splice(index,0,member)})},vm.querySearch=function(query){return query?vm.collaborators.filter(createFilterFor(query)):vm.collaborators},vm.goToPage=function(page){StateManager.setQuery({page:page})},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("accountTeam",accountTeam),AccountTeamCtrl.$inject=["$scope","$location","$timeout","UtilsService","StateManager"]}(),function(){"use strict";function accountTeamspaces(){return{restrict:"EA",templateUrl:"accountTeamspaces.html",scope:{account:"=",accounts:"=",onShowPage:"&",quota:"=",subscriptions:"=",selectedIndex:"="},controller:AccountReposCtrl,controllerAs:"vm",bindToController:!0}}function AccountReposCtrl(){var vm=this;vm.showPage=function(page,callingPage,data){vm.onShowPage({page:page,callingPage:callingPage,data:data})}}angular.module("3drepo").directive("accountTeamspaces",accountTeamspaces),AccountReposCtrl.$inject=[]}(),function(){"use strict";function billing(){return{restrict:"E",scope:{query:"="},templateUrl:"billing.html",controller:BillingCtrl,controllerAs:"vm",bindToController:!0}}function BillingCtrl(EventService,UtilsService,serverConfig){var billingsPromise,i,length,vm=this,euCountryCodes=["BE","BG","CZ","DK","DE","EE","IE","EL","ES","FR","HR","IT","CY","LV","LT","LU","HU","MT","NL","AT","PL","PT","RO","SI","SK","FI","SE"];vm.showBilling=!1,vm.B2B_EU=!1,vm.query.hasOwnProperty("user")&&vm.query.hasOwnProperty("item")&&(billingsPromise=UtilsService.doGet(vm.query.user+"/invoices"),billingsPromise.then(function(response){if(console.log("**billings**",response),response.data.length>0&&parseInt(vm.query.item)>=0&&parseInt(vm.query.item)<response.data.length&&(vm.showBilling=!0,vm.billing=response.data[parseInt(vm.query.item)],vm.billing.netAmount=parseFloat(vm.billing.amount-vm.billing.taxAmount).toFixed(2),vm.billing.taxPercentage=Math.round(vm.billing.taxAmount/vm.billing.netAmount*100),vm.B2B_EU=euCountryCodes.indexOf(vm.billing.info.countryCode)!==-1&&vm.billing.info.hasOwnProperty("vat"),vm.type=vm.billing.pending?"Order confirmation":"Invoice",serverConfig.hasOwnProperty("countries")))for(i=0,length=serverConfig.countries.length;i<length;i+=1)if(serverConfig.countries[i].code===vm.billing.info.countryCode){vm.billing.info.country=serverConfig.countries[i].name;break}})),vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)},vm.print=function(){window.print()}}angular.module("3drepo").directive("billing",billing),BillingCtrl.$inject=["EventService","UtilsService","serverConfig"]}(),function(){"use strict";function bottomButtons(){return{restrict:"E",templateUrl:"bottomButtons.html",scope:{},controller:BottomButtonsCtrl,controllerAs:"vm",bindToController:!0}}function BottomButtonsCtrl(EventService){var vm=this;vm.showButtons=!0,vm.fullScreen=!1,vm.showViewingOptionButtons=!1,vm.toggleElements=function(){EventService.send(EventService.EVENT.TOGGLE_ELEMENTS),vm.showButtons=!vm.showButtons};var setViewingOption=function(index){angular.isDefined(index)?(EventService.send(EventService.EVENT.VIEWER.SET_NAV_MODE,{mode:vm.viewingOptions[index].mode}),vm.selectedViewingOptionIndex=index,vm.rightButtons[0]=vm.viewingOptions[index],vm.showViewingOptionButtons=!1):vm.showViewingOptionButtons=!vm.showViewingOptionButtons},home=function(){EventService.send(EventService.EVENT.VIEWER.GO_HOME)},exitFullScreen=function(){document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen||!vm.fullScreen||(vm.fullScreen=!1)};document.addEventListener("webkitfullscreenchange",exitFullScreen,!1),document.addEventListener("mozfullscreenchange",exitFullScreen,!1),document.addEventListener("fullscreenchange",exitFullScreen,!1),document.addEventListener("MSFullscreenChange",exitFullScreen,!1);vm.viewingOptions=[{mode:VIEWER_NAV_MODES.HELICOPTER,label:"Helicopter",icon:"icon icon_helicopter",click:setViewingOption,iconClass:"bottomButtonIconHelicopter"},{mode:VIEWER_NAV_MODES.TURNTABLE,label:"Turntable",icon:"icon icon_turntable",click:setViewingOption}],vm.selectedViewingOptionIndex=1,vm.leftButtons=[],vm.leftButtons.push({label:"Home",icon:"fa fa-home",click:home}),vm.rightButtons=[],vm.rightButtons.push(vm.viewingOptions[vm.selectedViewingOptionIndex]),setViewingOption(1)}angular.module("3drepo").directive("bottomButtons",bottomButtons),BottomButtonsCtrl.$inject=["EventService"]}(),function(){"use strict";function compassMove(event){event.orientation[1]=-event.orientation[1],viewer.transformEvent(event,event.target,!1),document.getElementById("AxesTrans").setAttribute("rotation",event.orientation.toString())}function compass(){return{restrict:"E",templateUrl:"compass.html",scope:{},controller:CompassCtrl,controllerAs:"cc",bindToController:!0}}function CompassCtrl($scope,EventService){$scope.$watch(EventService.currentEvent,function(event){angular.isDefined(event)&&angular.isDefined(event.type)&&event.type===EventService.EVENT.VIEWER.START_LOADING&&EventService.send(EventService.EVENT.VIEWER.REGISTER_VIEWPOINT_CALLBACK,{callback:compassMove})})}angular.module("3drepo").directive("compass",compass),CompassCtrl.$inject=["$scope","EventService"]}(),function(){"use strict";
function building(){return{restrict:"EA",templateUrl:"building.html",scope:{show:"=",visible:"=",onContentHeightRequest:"&"},controller:BuildingCtrl,controllerAs:"vm",bindToController:!0}}function BuildingCtrl($scope,$timeout,EventService,$http){var vm=this;vm.meta={},$scope.$watch("vm.show",function(newValue){}),$scope.$watch("vm.visible",function(newValue){}),$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.VIEWER.OS_BUILDING_CLICK){vm.testdata=event.value.id;var url="/api/os/building-meta/"+event.value.id;$http.get(url).then(function(data){vm.meta=data.data},function(err){console.trace(err)})}})}angular.module("3drepo").directive("building",building),BuildingCtrl.$inject=["$scope","$timeout","EventService","$http"]}(),function(){"use strict";function clip(){return{restrict:"EA",templateUrl:"clip.html",scope:{show:"=",visible:"=",onContentHeightRequest:"&"},controller:ClipCtrl,controllerAs:"vm",bindToController:!0,account:null,model:null,disableRedefinition:!1}}function ClipCtrl($scope,$timeout,EventService){function updateClippingPlane(){vm.bbox&&EventService.send(EventService.EVENT.VIEWER.UPDATE_CLIPPING_PLANES,{clippingPlanes:[{normal:getNormal(),distance:vm.displayDistance,clipDirection:-1}],fromClipPanel:!0})}function determineAxis(normal){var res="";return 3===normal.length&&(0===normal[1]&&0===normal[2]?res="X":0===normal[0]&&0===normal[2]?res="Z":0===normal[0]&&0===normal[1]&&(res="Y")),res}function setDisplayValues(axis,distance,moveClip,slider){vm.disableWatchDistance=vm.disableWatchAxis=vm.disableWatchSlider=!0,vm.displayDistance=distance,vm.displayedAxis=axis,null!=slider?(vm.sliderPosition=slider,moveClip&&updateClippingPlane()):updateDisplaySlider(!1,moveClip)}function getNormal(){var normal=[-1,0,0];return vm.normal?normal=vm.normal:vm.displayedAxis&&("Y"==vm.displayedAxis?normal=[0,0,1]:"Z"==vm.displayedAxis&&(normal=[0,-1,0])),normal}function updateDisplayedDistance(updateSlider,moveClip){var min=0,max=0;if("X"===vm.displayedAxis)min=vm.bbox.min[0],max=vm.bbox.max[0];else if("Y"===vm.displayedAxis)min=vm.bbox.min[2],max=vm.bbox.max[2];else{if("Z"!==vm.displayedAxis)return;min=vm.bbox.min[1],max=vm.bbox.max[1]}var percentage=1-vm.sliderPosition/100;updateSlider||(vm.disableWatchDistance=!0),vm.displayDistance=min+Math.abs(max-min)*percentage,moveClip&&updateClippingPlane()}function updateDisplaySlider(updateDistance,moveClip){var min=0,max=0;if("X"===vm.displayedAxis)min=vm.bbox.min[0],max=vm.bbox.max[0];else if("Y"===vm.displayedAxis)min=vm.bbox.min[2],max=vm.bbox.max[2];else{if("Z"!==vm.displayedAxis)return;min=vm.bbox.min[1],max=vm.bbox.max[1]}var percentage=(vm.displayDistance-min)/Math.abs(max-min);updateDistance||(vm.disableWatchSlider=!0);var value=100*(1-percentage);(percentage>100||value<0)&&(value=0),(percentage<0||value>100)&&(value=100),vm.sliderPosition=value,moveClip&&updateClippingPlane()}var vm=this;vm.sliderMin=0,vm.sliderMax=100,vm.sliderStep=.1,vm.displayDistance=0,vm.sliderPosition=vm.sliderMin,vm.axes=["X","Y","Z"],vm.visible=!1,vm.bbox=null,vm.onContentHeightRequest({height:130}),vm.units="m",$scope.$watch("vm.show",function(newValue){angular.isDefined(newValue)&&(vm.visible=newValue)}),$scope.$watch("vm.visible",function(newValue){angular.isDefined(newValue)&&(newValue?updateClippingPlane():EventService.send(EventService.EVENT.VIEWER.CLEAR_CLIPPING_PLANES))}),$scope.$watch("vm.displayDistance",function(newValue){vm.disableWatchDistance||updateDisplaySlider(!1,vm.visible),vm.disableWatchDistance=!1}),$scope.$watch("vm.displayedAxis",function(newValue){vm.disableWatchAxis||updateDisplayedDistance(!1,vm.visible),vm.disableWatchAxis=!1}),$scope.$watch("vm.sliderPosition",function(newValue){vm.disableWatchSlider||updateDisplayedDistance(!1,vm.visible),vm.disableWatchSlider=!1}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.CLIPPING_PLANE_BROADCAST?setDisplayValues(determineAxis(event.value.normal),event.value.distance,!1):event.type===EventService.EVENT.VIEWER.SET_SUBMODEL_TRANS_INFO?(vm.modelTrans[event.value.modelNameSpace]=event.value.modelTrans,event.value.isMainModel&&(vm.offsetTrans=event.value.modelTrans)):event.type===EventService.EVENT.VIEWER.LOADED?(vm.bbox=event.value.bbox,setDisplayValues("X",vm.bbox.max[0],vm.visible,0)):event.type===EventService.EVENT.MODEL_SETTINGS_READY&&(vm.units=event.value.settings.unit)})}angular.module("3drepo").directive("clip",clip),ClipCtrl.$inject=["$scope","$timeout","EventService"]}(),function(){"use strict";function contact(){return{restrict:"E",scope:{},templateUrl:"contact.html",controller:ContactCtrl,controllerAs:"vm",bindToController:!0}}function ContactCtrl($scope,UtilsService){var promise,vm=this;vm.contact={information:"",name:"",email:""},vm.sent=!1,vm.sending=!1,vm.emailRegex=/^[_a-z0-9-]+(\.[_a-z0-9]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/,$scope.$watch("vm.contact",function(){vm.sendButtonDisabled=""===vm.contact.information||""===vm.contact.name||""===vm.contact.email||angular.isUndefined(vm.contact.email)},!0),vm.send=function(){vm.sending=!0,promise=UtilsService.doPost(vm.contact,"contact"),promise.then(function(response){console.log(response),vm.sending=!1,200===response.status&&(vm.sent=!0)})}}angular.module("3drepo").directive("contact",contact),ContactCtrl.$inject=["$scope","UtilsService"]}(),function(){"use strict";function cookies(){return{restrict:"E",scope:{},templateUrl:"cookies.html",controller:CookiesCtrl,controllerAs:"vm",bindToController:!0}}function CookiesCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("cookies",cookies),CookiesCtrl.$inject=["EventService"]}(),function(){"use strict";function docs(){return{restrict:"EA",templateUrl:"docs.html",scope:{show:"=",onContentHeightRequest:"&",treeMap:"="},controller:DocsCtrl,controllerAs:"vm",bindToController:!0}}function DocsCtrl($scope,$mdDialog,$timeout,$filter,EventService,DocsService,UtilsService){function removeDialog(){$scope.closeDialog()}function docsDialogController(){}function setContentHeight(){var itemsHeight,contentHeight=0,metaDataItemHeight=50;angular.forEach(vm.docs,function(value,key){contentHeight+=docTypeHeight,value.show&&("Meta Data"===key&&(itemsHeight=Object.keys(value.data[0].metadata).length*metaDataItemHeight),contentHeight+=itemsHeight)}),vm.onContentHeightRequest({height:contentHeight})}var allDocTypesHeight,autoMetaData,pinMode,vm=this,docTypeHeight=50;vm.showDocsGetProgress=!1,vm.onContentHeightRequest({height:80}),$scope.$watch(EventService.currentEvent,function(event){if(autoMetaData&&!pinMode&&event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED){var object=event.value,metadataIds=vm.treeMap.oIdToMetaId[object.id];metadataIds&&metadataIds.length?DocsService.getDocs(object.account,object.model,metadataIds[0]).then(function(data){data&&(vm.show=!0,$timeout(function(){vm.docs=data,allDocTypesHeight=0;for(var docType in vm.docs)vm.docs.hasOwnProperty(docType)&&(vm.docs[docType].show=!0,allDocTypesHeight+=docTypeHeight);setContentHeight()}))}):vm.show=!1}else event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?vm.show=!1:event.type===EventService.EVENT.AUTO_META_DATA?autoMetaData=event.value:event.type===EventService.EVENT.PIN_DROP_MODE&&(pinMode=event.value)}),vm.showDoc=function(doc){$scope.pdfUrl=doc.url,vm.progressInfo="Loading document "+doc.name,vm.showDocLoadProgress=!0,$mdDialog.show({controller:docsDialogController,templateUrl:"docsDialog.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0,scope:$scope,preserveScope:!0,onRemoving:removeDialog})},$scope.closeDialog=function(){$mdDialog.cancel()},vm.toggleItem=function(docType){vm.docs[docType].show=!vm.docs[docType].show,setContentHeight()}}angular.module("3drepo").directive("docs",docs),DocsCtrl.$inject=["$scope","$mdDialog","$timeout","$filter","EventService","DocsService","UtilsService"]}(),function(){"use strict";function DocsService($http,$q,serverConfig){var getDocs=function(account,model,metadataId){var i,length,data={},deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/meta/"+metadataId+".json");return $http.get(url).then(function(json){var dataType;for(i=0,length=json.data.meta.length;i<length;i+=1)dataType=json.data.meta[i].hasOwnProperty("mime")?json.data.meta[i].mime:"Meta Data","application/pdf"===dataType&&(dataType="PDF"),data.hasOwnProperty(dataType)||(data[dataType]={data:[]}),data[dataType].data.push(json.data.meta[i]),json.data.meta[i].url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/"+json.data.meta[i]._id+".pdf");deferred.resolve(data)},function(){deferred.resolve()}),deferred.promise};return{getDocs:getDocs}}angular.module("3drepo").factory("DocsService",DocsService),DocsService.$inject=["$http","$q","serverConfig"]}(),function(){"use strict";function groups(){return{restrict:"EA",templateUrl:"groups.html",scope:{account:"=",model:"=",show:"=",showAdd:"=",showEdit:"=",canAdd:"=",onContentHeightRequest:"&",onShowItem:"&",hideItem:"=",selectedMenuOption:"="},controller:GroupsCtrl,controllerAs:"vm",bindToController:!0}}function GroupsCtrl($scope,$timeout,EventService,GroupsService){function setContentHeight(){var contentHeight=0,groupHeaderHeight=56,baseGroupHeight=210,addHeight=250,infoHeight=80,loadingHeight=80;switch(vm.toShow){case"showGroups":angular.forEach(vm.groups,function(){contentHeight+=groupHeaderHeight});break;case"showGroup":contentHeight=baseGroupHeight;break;case"showAdd":contentHeight=addHeight;break;case"showInfo":contentHeight=infoHeight;break;case"showLoading":contentHeight=loadingHeight}vm.onContentHeightRequest({height:contentHeight})}function setupEventWatch(){var index;eventWatch=$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED&&(index=vm.selectedGroup.objects.indexOf(event.value.id),index!==-1?vm.selectedGroup.objects.splice(index,1):vm.selectedGroup.objects.push(event.value.id),promise=GroupsService.updateGroup(vm.selectedGroup),promise.then(function(data){setSelectedGroupHighlightStatus(!0)}))})}function setSelectedGroupHighlightStatus(highlight){var data;null!==vm.selectedGroup&&vm.selectedGroup.objects.length>0&&(data={source:"tree",account:vm.account,model:vm.model},highlight?(data.ids=vm.selectedGroup.objects,data.colour=vm.selectedGroup.color.map(function(item){return item/255}).join(" ")):data.ids=[],EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,data))}function setGroupsVisibleStatus(groups,visible){var i,length,data,ids=[];for(i=0,length=groups.length;i<length;i+=1)groups[i].objects.length>0&&(ids=ids.concat(groups[i].objects));ids.length>0&&(data={source:"tree",account:vm.account,model:vm.model,ids:ids,visible:visible},EventService.send(EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY,data))}function doHideAll(hideAllStatus){var i,length,groups=[];if("showGroups"===vm.toShow)setGroupsVisibleStatus(vm.groups,!hideAllStatus);else if("showGroup"===vm.toShow)for(i=0,length=vm.groups.length;i<length;i+=1)vm.groups[i]._id!==vm.selectedGroup._id&&(groups.push(vm.groups[i]),setGroupsVisibleStatus(groups,!hideAll)),setGroupsVisibleStatus([vm.selectedGroup],!0)}var eventWatch,promise,vm=this,colourChangeTimeout=null,hideAll=!1;vm.saveDisabled=!0,vm.canAdd=!0,vm.selectedGroup=null,vm.editingGroup=!1,vm.editingText="Start",vm.colourPickerColour=[255,255,255],vm.toShow="showLoading",vm.loadingInfo="Loading groups",setContentHeight(),GroupsService.init(vm.account,vm.model),promise=GroupsService.getGroups(),promise.then(function(data){vm.groups=data.data,vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",setContentHeight()}),$scope.$watch("vm.showAdd",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.toShow="showAdd",vm.onShowItem(),vm.canAdd=!1,vm.selectedGroup=null,vm.name="",setContentHeight())}),$scope.$watch("vm.hideItem",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",vm.showAdd=!1,vm.canAdd=!0,vm.showEdit=!1,setContentHeight(),setSelectedGroupHighlightStatus(!1),vm.selectedGroup=null,doHideAll(hideAll))}),$scope.$watch("vm.name",function(newValue){angular.isDefined(newValue)&&(vm.saveDisabled=angular.isUndefined(newValue)||""===newValue.toString())}),$scope.$watch("vm.editingGroup",function(newValue){angular.isDefined(newValue)&&(vm.editingText=newValue?"Stop":"Start",newValue?setupEventWatch():angular.isDefined(eventWatch)&&eventWatch())}),$scope.$watch("vm.show",function(newValue){angular.isDefined(newValue)&&(newValue||(vm.editingGroup=!1,hideAll=!1,vm.toShow="showGroups",doHideAll(hideAll)))}),$scope.$watch("vm.showObjects",function(newValue){angular.isDefined(newValue)&&null!==vm.selectedGroup&&setGroupsVisibleStatus([vm.selectedGroup],newValue)}),$scope.$watch("vm.selectedMenuOption",function(newValue){angular.isDefined(newValue)&&"hideAll"===newValue.value&&(hideAll=!hideAll,doHideAll(hideAll))}),vm.showGroup=function(index){vm.selectedGroup=vm.groups[index],vm.toShow="showGroup",vm.onShowItem(),vm.canAdd=!1,vm.editingGroup=!1,vm.showObjects=!0,vm.showEdit=!0,setContentHeight(),doHideAll(hideAll),setSelectedGroupHighlightStatus(!0)},vm.colourPickerChange=function(colour){vm.colourPickerColour=colour,null!==vm.selectedGroup&&(null!==colourChangeTimeout&&$timeout.cancel(colourChangeTimeout),colourChangeTimeout=$timeout(function(){vm.selectedGroup.color=colour,promise=GroupsService.updateGroup(vm.selectedGroup),promise.then(function(data){console.log(data),setSelectedGroupHighlightStatus(!0)})},500))},vm.colourToString=function(colour){return"rgb("+colour.join(",")+")"},vm.deleteGroup=function(){var i,length;for(i=0,length=vm.groups.length;i<length;i+=1)if(vm.groups[i].name===vm.selectedGroup.name){promise=GroupsService.deleteGroup(vm.selectedGroup._id),promise.then(function(data){"OK"===data.statusText&&(vm.groups.splice(i,1),vm.selectedGroup=null,vm.groups.length>0?vm.toShow="showGroups":vm.toShow="showInfo",vm.canAdd=!0,setContentHeight())});break}},vm.saveGroup=function(){var i,length,nameExists=!1;for(i=0,length=vm.groups.length;i<length;i+=1)if(vm.groups[i].name===vm.name){nameExists=!0;break}nameExists||(promise=GroupsService.createGroup(vm.name,vm.colourPickerColour),promise.then(function(data){"OK"===data.statusText&&(vm.groups.push(data.data),vm.selectedGroup=null,vm.toShow="showGroups",vm.canAdd=!0,vm.showAdd=!1,setContentHeight())}))}}angular.module("3drepo").directive("groups",groups),GroupsCtrl.$inject=["$scope","$timeout","EventService","GroupsService"]}(),function(){"use strict";function GroupsService($http,$q,serverConfig){function doPost(data,urlEnd,headers){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.model+"/"+urlEnd),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doGet(urlEnd,param){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,self.account+"/"+self.model+"/"+urlEnd),params={};return angular.isDefined(param)&&(params.responseType="arraybuffer"),$http.get(url,params).then(function(response){deferred.resolve(response)},function(response){deferred.resolve(response)}),deferred.promise}function doPut(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.model+"/"+urlEnd),config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doDelete(urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,self.account+"/"+self.model+"/"+urlEnd);return $http.delete(url).then(function(response){deferred.resolve(response)}),deferred.promise}var self=this,obj={};return obj.init=function(account,model){self.account=account,self.model=model},obj.getGroups=function(){return doGet("groups")},obj.createGroup=function(name,color){return doPost({name:name,color:color,objects:[]},"groups")},obj.deleteGroup=function(groupId){return doDelete("groups/"+groupId)},obj.updateGroup=function(group){return doPut(group,"groups/"+group._id)},obj}angular.module("3drepo").factory("GroupsService",GroupsService),GroupsService.$inject=["$http","$q","serverConfig"]}(),function(){"use strict";angular.module("3drepo").service("Auth",["$injector","$q","$http","serverConfig","EventService","AnalyticService",function($injector,$q,$http,serverConfig,EventService,AnalyticService){var self=this;self.authPromise=$q.defer(),self.loggedIn=null,self.username=null,this.loginSuccess=function(data){self.loggedIn=!0,self.username=data.username,self.userRoles=data.roles,EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:data.username,initialiser:data.initialiser}),AnalyticService.setUserId(self.username),self.authPromise.resolve(self.loggedIn)},this.loginFailure=function(reason){self.loggedIn=!1,self.username=null,self.userRoles=null;var initialiser=reason.initialiser;reason.initialiser=void 0,EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:null,initialiser:initialiser,error:reason}),self.authPromise.resolve(self.loggedIn)},this.logoutSuccess=function(){self.loggedIn=!1,self.username=null,self.userRoles=null,EventService.send(EventService.EVENT.USER_LOGGED_OUT),self.authPromise.resolve(self.loggedIn)},this.logoutFailure=function(reason){self.loggedIn=!1,self.username=null,self.userRoles=null,localStorage.setItem("tdrLoggedIn","false"),EventService.send(EventService.EVENT.USER_LOGGED_OUT,{error:reason}),self.authPromise.resolve(self.loggedIn)},this.init=function(){var initPromise=$q.defer();return null===self.loggedIn?($http.get(serverConfig.apiUrl(serverConfig.GET_API,"login")).success(function(data){data.initialiser=!0,self.loginSuccess(data)}).error(function(reason){reason.initialiser=!0,self.loginFailure(reason)}),self.authPromise.promise.then(function(){initPromise.resolve(self.loggedIn)})):(self.loggedIn?EventService.send(EventService.EVENT.USER_LOGGED_IN,{username:self.username}):EventService.send(EventService.EVENT.USER_LOGGED_OUT),initPromise.resolve(self.loggedIn)),initPromise.promise},this.loadModelRoles=function(account,model){var rolesPromise=$q.defer();return $http.get(serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/roles.json")).success(function(data){self.modelRoles=data,rolesPromise.resolve()}).error(function(){self.modelRoles=null,rolesPromise.resolve()}),rolesPromise.promise},this.getUsername=function(){return this.username},this.login=function(username,password){self.authPromise=$q.defer();var postData={username:username,password:password};return $http.post(serverConfig.apiUrl(serverConfig.POST_API,"login"),postData).success(self.loginSuccess).error(self.loginFailure),self.authPromise.promise},this.logout=function(){return self.authPromise=$q.defer(),$http.post(serverConfig.apiUrl(serverConfig.POST_API,"logout")).success(self.logoutSuccess).error(self.logoutFailure),self.authPromise.promise},this.hasPermission=function(requiredPerm,permissions){return permissions.indexOf(requiredPerm)!==-1}}])}(),function(){"use strict";angular.module("3drepo").config(["$stateProvider","$urlRouterProvider","$locationProvider","structure",function($stateProvider,$urlRouterProvider,$locationProvider,structure){$locationProvider.html5Mode(!0),$stateProvider.state("home",{name:"home",url:"/",resolve:{init:function(Auth,StateManager,$q){StateManager.state.authInitialized=!1;var finishedAuth=$q.defer();return StateManager.state.changing=!0,Auth.init().then(function(loggedIn){StateManager.state.authInitialized=!0,StateManager.state.loggedIn=loggedIn,finishedAuth.resolve()}),finishedAuth.promise}}});for(var stateStack=[structure],stateNameStack=["home"];stateStack.length>0;){var parentState=(stateStack.length,stateStack[0]),parentStateName=stateNameStack[0];if(parentState.functions)for(var i=0;i<parentState.functions.length;i++){var childFunction=parentState.functions[i],childFunctionName=parentStateName+"."+childFunction;!function(childFunction){$stateProvider.state(childFunctionName,{name:childFunction,url:childFunction,resolve:{init:function(StateManager,$location,$stateParams){$stateParams[childFunction]=!0,StateManager.setState($stateParams)}}})}(childFunction)}if(parentState.children)for(var i=0;i<parentState.children.length;i++){var childState=parentState.children[i],childStateName=parentStateName+"."+childState.plugin;stateNameStack.push(childStateName),stateStack.push(parentState.children[i]),function(childState){$stateProvider.state(childStateName,{name:parentState.children[i].plugin,params:childState.params,url:childState.url||("home"!==parentStateName?"/":"")+":"+childState.plugin,reloadOnSearch:!1,resolve:{init:function(StateManager,$location,$stateParams){StateManager.setState($stateParams)}}})}(childState)}stateStack.splice(0,1),stateNameStack.splice(0,1)}$urlRouterProvider.otherwise("")}]).run(["$location","$rootScope","$state","uiState","StateManager","Auth","$timeout","AnalyticService",function($location,$rootScope,$state,uiState,StateManager,Auth,$timeout,AnalyticService){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){console.log("stateChangeStart: "+JSON.stringify(fromState)+" --> "+JSON.stringify(toState)),StateManager.state.changing=!0;for(var i=0;i<StateManager.functions.length;i++)StateManager.setStateVar(StateManager.functions[i],!1);StateManager.clearQuery();var stateChangeObject={toState:toState,toParams:toParams,fromState:fromState,fromParams:fromParams};StateManager.startStateChange(stateChangeObject)}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){console.log("stateChangeSuccess: "+JSON.stringify(fromState)+" --> "+JSON.stringify(toState));var stateChangeObject={toState:toState,toParams:toParams,fromState:fromState,fromParams:fromParams};StateManager.handleStateChange(stateChangeObject)}),$rootScope.$on("$locationChangeStart",function(event,next,current){console.log("locationChange")}),$rootScope.$on("$locationChangeSuccess",function(){console.log("locationChangeSucc"),AnalyticService.sendPageView(location);var queryParams=$location.search();0===Object.keys(queryParams).length?StateManager.clearQuery():StateManager.setQuery(queryParams)})}]).service("StateManager",["$q","$state","$rootScope","$timeout","structure","EventService","$window","Auth",function($q,$state,$rootScope,$timeout,structure,EventService,$window,Auth){var self=this;$window.StateManager=this,this.state={changing:!0},this.changedState={},this.structure=structure,this.destroy=function(){delete this.state,this.state={},delete this.ui,this.ui={},delete this.Data,this.Data={}},this.changed={},this.state={loggedIn:!1},this.query={},this.functions=[];for(var stateStack=[structure];stateStack.length>0;){var functionName,stackLength=stateStack.length,parentState=stateStack[stackLength-1],i=0;if(parentState.functions)for(i=0;i<parentState.functions.length;i++)functionName=parentState.functions[i],this.functions.indexOf(functionName)>-1?console.error("Duplicate function name when loading in StateManager : "+functionName):this.functions.push(functionName);if(parentState.children)for(var i=0;i<parentState.children.length;i++)stateStack.push(parentState.children[i]);stateStack.splice(0,1)}this.clearChanged=function(){for(var i in self.changed)self.changed.hasOwnProperty(i)&&(self.changed[i]=!1)},self.clearChanged(),this.stateChangeQueue=[];var compareStateChangeObjects=function(stateChangeA,stateChangeB){return stateChangeA.toState===stateChangeB.toState&&stateChangeA.toParams===stateChangeB.toParams&&stateChangeA.fromState===stateChangeB.fromState&&stateChangeA.fromParams===stateChangeB.fromParams};this.startStateChange=function(stateChangeObject){self.stateChangeQueue.push(stateChangeObject)},this.handleStateChange=function(stateChangeObject){var param,fromParams=stateChangeObject.fromParams,toParams=stateChangeObject.toParams;for(param in fromParams)fromParams.hasOwnProperty(param)&&(toParams.hasOwnProperty(param)||self.setStateVar(param,null));for(param in toParams)toParams.hasOwnProperty(param)&&(fromParams.hasOwnProperty(param)?fromParams[param]!==toParams[param]&&self.setStateVar(param,toParams[param]):self.setStateVar(param,toParams[param]));for(var stateStack=[structure],stateNameStack=["home"],clearBelow=!1;stateStack.length>0;){var stackLength=stateStack.length,parentState=stateStack[stackLength-1],parentStateName=stateNameStack[stackLength-1];if("home"===parentStateName||self.state[parentStateName]||(clearBelow=!0),parentState.children)for(var i=0;i<parentState.children.length;i++){var childStateName=parentState.children[i].plugin;stateNameStack.push(childStateName),stateStack.push(parentState.children[i]),clearBelow&&self.setStateVar(childStateName,null)}stateStack.splice(0,1),stateNameStack.splice(0,1)}if(compareStateChangeObjects(stateChangeObject,self.stateChangeQueue[0])){self.stateChangeQueue.pop();var functionList=self.functionsUsed();0===functionList.length&&self.state.loggedIn&&!self.state.account?(self.setStateVar("account",Auth.username),self.updateState()):self.updateState(!0)}else self.stateChangeQueue.pop(),self.handleStateChange(self.stateChangeQueue[self.stateChangeQueue.length-1])},this.stateVars={},this.clearState=function(state){for(var state in self.state)["changing","authInitialized","loggedIn"].indexOf(state)===-1&&self.state.hasOwnProperty(state)&&self.setStateVar(state,null)},this.clearQuery=function(state){for(var param in self.query)delete self.query[param]},this.functionsUsed=function(){var functionList=[];if(self.structure.functions)for(i=0;i<self.structure.functions.length;i++)if(functionName=self.structure.functions[i],self.state[functionName]){functionList.push(functionName);break}return functionList},this.genStateName=function(){var currentChildren=self.structure.children,childidx=0,stateName="home.",functionList=self.functionsUsed(),usesFunction=functionList.length>0;if(usesFunction)stateName+=functionList.join(".")+".";else for(;childidx<currentChildren.length;){var child=currentChildren[childidx],plugin=child.plugin;self.state.hasOwnProperty(plugin)&&self.state[plugin]&&(stateName+=plugin+".",currentChildren=child.children?child.children:[],childidx=-1),childidx+=1}return stateName.substring(0,stateName.length-1)},this.setStateVar=function(varName,value){null===value?delete self.state[varName]:self.state[varName]!==value&&(self.state.changing=!0,self.changedState[varName]=value),self.state[varName]=value},this.setState=function(stateParams){if(!stateParams.noSet)for(var state in stateParams)stateParams.hasOwnProperty(state)&&self.setStateVar(state,stateParams[state])},this.setQuery=function(queryParams){for(var param in queryParams)queryParams.hasOwnProperty(param)&&(self.query[param]=queryParams[param])},this.updateState=function(dontUpdateLocation){var newStateName=self.genStateName();Object.keys(self.changedState).length&&(EventService.send(EventService.EVENT.STATE_CHANGED,self.changedState),self.changedState={});var updateLocation=!dontUpdateLocation;$state.transitionTo(newStateName,self.state,{location:updateLocation}),$timeout(function(){self.state.changing=!1})},$rootScope.$watch(EventService.currentEvent,function(event){if(angular.isDefined(event)&&angular.isDefined(event.type))if(event.type===EventService.EVENT.SET_STATE){for(var key in event.value)"updateLocation"!==key&&event.value.hasOwnProperty(key)&&self.setStateVar(key,event.value[key]);self.updateState()}else event.type===EventService.EVENT.CLEAR_STATE?self.clearState():event.type===EventService.EVENT.UPDATE_STATE&&self.updateState(!0)})}])}(),angular.module("3drepo").factory("AnalyticService",AnalyticService),AnalyticService.$inject=[],function(){"use strict";function autoLogin(){return{restrict:"E",scope:{account:"@",password:"@"},controller:AutoLoginCtrl,controllerAs:"al",bindToController:!0}}function AutoLoginCtrl(Auth){var al=this;al.getTemplateUrl=function(){return al.templateUrl},Auth.login(al.account,al.password)}angular.module("3drepo").directive("autoLogin",autoLogin),AutoLoginCtrl.$inject=["Auth"]}(),function(){"use strict";function home(){return{restrict:"E",templateUrl:"home.html",scope:{account:"@",password:"@",loggedInUrl:"@",loggedOutUrl:"@"},controller:HomeCtrl,controllerAs:"vm",bindToController:!0}}function HomeCtrl($scope,$element,$timeout,$compile,$mdDialog,$window,Auth,StateManager,EventService,UtilsService,serverConfig,$location){var homeLoggedOut,notLoggedInElement,element,func,i,vm=this;vm.state=StateManager.state,vm.query=StateManager.query,vm.functions=StateManager.functions,vm.pointerEvents="inherit",vm.goToAccount=!1,vm.goToUserPage=!1,vm.keysDown=[],vm.legalDisplays=[],angular.isDefined(serverConfig.legal)&&(vm.legalDisplays=serverConfig.legal),vm.legalDisplays.push({title:"Pricing",page:"http://3drepo.org/pricing"}),vm.legalDisplays.push({title:"Contact",page:"http://3drepo.org/contact/"}),$timeout(function(){homeLoggedOut=angular.element($element[0].querySelector("#homeLoggedOut")),EventService.send(EventService.EVENT.CREATE_VIEWER,{name:"default"}),$scope.$watch("vm.state",function(newState,oldState){if(newState!==oldState&&!vm.state.changing&&vm.state.authInitialized){for(homeLoggedOut.empty(),vm.goToUserPage=!1,i=0;i<vm.functions.length;i++)if(func=vm.functions[i],vm.state[func]){vm.goToUserPage=!0,element="<"+UtilsService.snake_case(func,"-")+" username='vm.query.username' token='vm.query.token' query='vm.query'></"+UtilsService.snake_case(func,"-")+">",notLoggedInElement=angular.element(element),homeLoggedOut.append(notLoggedInElement),$compile(notLoggedInElement)($scope);break}vm.state.loggedIn||vm.goToUserPage||(notLoggedInElement=angular.element("<login></login>"),homeLoggedOut.append(notLoggedInElement),$compile(notLoggedInElement)($scope))}},!0)}),angular.isDefined(vm.account)&&angular.isDefined(vm.password)&&Auth.login(vm.account,vm.password),vm.logout=function(){Auth.logout()},vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)},vm.legalDisplay=function(event,display){$window.open("/"+display.value)},$scope.$watch(EventService.currentEvent,function(event){angular.isDefined(event)&&angular.isDefined(event.type)&&(event.type===EventService.EVENT.USER_LOGGED_IN?event.value.error||event.value.initialiser||(StateManager.setStateVar("loggedIn",!0),EventService.send(EventService.EVENT.UPDATE_STATE),StateManager.state.account||EventService.send(EventService.EVENT.SET_STATE,{account:Auth.username})):event.type===EventService.EVENT.USER_LOGGED_OUT?(EventService.send(EventService.EVENT.CLEAR_STATE),EventService.send(EventService.EVENT.SET_STATE,{loggedIn:!1,account:null})):event.type===EventService.EVENT.SHOW_MODELS?(EventService.send(EventService.EVENT.CLEAR_STATE),Auth.init()):event.type===EventService.EVENT.GO_HOME?(EventService.send(EventService.EVENT.CLEAR_STATE),StateManager.state.loggedIn?EventService.send(EventService.EVENT.SET_STATE,{account:Auth.username}):EventService.send(EventService.EVENT.SET_STATE,{})):event.type===EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING&&(vm.pointerEvents=event.value.on?"none":"inherit"))}),vm.keyAction=function(event){var i,tmp;if("keydown"===event.type)vm.keysDown.indexOf(event.which)===-1&&(tmp=vm.keysDown,delete vm.keysDown,vm.keysDown=angular.copy(tmp),vm.keysDown.push(event.which));else if("keyup"===event.type){for(i=vm.keysDown.length-1;i>=0;i-=1)vm.keysDown[i]===event.which&&vm.keysDown.splice(i,1);tmp=vm.keysDown,delete vm.keysDown,vm.keysDown=angular.copy(tmp)}},$scope.closeDialog=function(){$mdDialog.cancel()}}angular.module("3drepo").directive("home",home).config(function($injector){if($injector.has("$mdThemingProvider")){var mdThemingProvider=$injector.get("$mdThemingProvider");mdThemingProvider.definePalette("three_d_repo_primary",{
50:"004594",100:"004594",200:"004594",300:"004594",400:"004594",500:"004594",600:"004594",700:"004594",800:"004594",900:"004594",A100:"004594",A200:"004594",A400:"004594",A700:"004594",contrastDefaultColor:"light",contrastDarkColors:["50","100","200","300","400","A100"],contrastLightColors:void 0}),mdThemingProvider.theme("default").primaryPalette("three_d_repo_primary",{default:"500","hue-1":"400","hue-2":"200","hue-3":"50"}).accentPalette("green",{default:"600"}).warnPalette("red")}}),HomeCtrl.$inject=["$scope","$element","$timeout","$compile","$mdDialog","$window","Auth","StateManager","EventService","UtilsService","serverConfig","$location"]}(),function(){"use strict";angular.module("3drepo").factory("authInterceptor",["EventService","$q",function(EventService,$q){return{responseError:function(res){return 401===res.status&&EventService.send(EventService.EVENT.USER_NOT_AUTHORIZED),$q.reject(res)}}}]).config(function($httpProvider){var checkAuthorization=["$q","$location",function($q,$location){var onSuccess=function(res){return res},onError=function(res){return 401===res.status||400===res.status?$q.reject(res):$q.reject(res)};return function(promise){return promise.then(onSuccess,onError)}}];$httpProvider.interceptors.push(checkAuthorization),$httpProvider.defaults.withCredentials=!0,$httpProvider.interceptors.push("authInterceptor")})}(),function(){"use strict";function HttpService($http,$q,EventService,serverConfig){var handlerFactory=function(httpReq){return function(type,url,success,failure){var deferred=$q.defer(),getURI=serverConfig.apiUrl(type,url),successFunc=success||function(response){deferred.resolve(response.data)},failureFunc=failure||function(response){404!==response.status&&401!==response.status||EventService.send(EventService.EVENT.GO_HOME),deferred.resolve([])};return httpReq(getURI).then(successFunc,failureFunc),deferred.promise}},get=handlerFactory($http.get),post=handlerFactory($http.post);return{get:get,post:post}}angular.module("3drepo").factory("HttpService",HttpService),HttpService.$inject=["$http","$q","EventService","serverConfig"]}(),angular.module("3drepo").factory("NotificationService",NotificationService),NotificationService.$inject=["serverConfig","$injector"],angular.module("3drepo").service("serverConfig",function(){"use strict";for(var k in server_config)this[k]=server_config[k]}),function(){"use strict";function IssueCompCtrl($q,$mdDialog,$element,EventService,IssuesService,UtilsService,NotificationService,Auth,$timeout,$scope,serverConfig,AnalyticService,$state){function convertCommentTopicType(){self.issueData&&self.issueData.comments.forEach(function(comment){comment.action&&"topic_type"===comment.action.property&&IssuesService.convertActionCommentToText(comment,self.topic_types)})}function setCanUpdateStatus(issueData){return Auth.hasPermission(serverConfig.permissions.PERM_CREATE_ISSUE,self.modelSettings.permissions)?void(self.canUpdateStatus=Auth.getUsername()===issueData.owner||issueData.assigned_roles.indexOf(self.userJob._id)!==-1):self.canUpdateStatus=!1}function saveIssue(){var data,viewpointPromise=$q.defer(),screenShotPromise=$q.defer(),objectsPromise=$q.defer();commentViewpoint?viewpointPromise.resolve(commentViewpoint):self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise,account:self.account,model:self.model}}),self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_OBJECT_STATUS,value:{promise:objectsPromise,account:self.account,model:self.model}}),viewpointPromise.promise.then(function(viewpoint){objectsPromise.promise.then(function(objectInfo){null!==savedScreenShot?objectInfo.highlightedNodes.length>0?(data={name:self.issueData.name,color:[255,0,0],objects:objectInfo.highlightedNodes},UtilsService.doPost(data,self.account+"/"+self.model+"/groups").then(function(response){doSaveIssue(viewpoint,savedScreenShot,response.data._id)})):doSaveIssue(viewpoint,savedScreenShot):(self.sendEvent({type:EventService.EVENT.VIEWER.GET_SCREENSHOT,value:{promise:screenShotPromise}}),screenShotPromise.promise.then(function(screenShot){objectInfo.highlightedNodes.length>0?(data={name:self.issueData.name,color:[255,0,0],objects:objectInfo.highlightedNodes},UtilsService.doPost(data,self.account+"/"+self.model+"/groups").then(function(response){doSaveIssue(viewpoint,screenShot,response.data._id)})):doSaveIssue(viewpoint,screenShot)}))})})}function doSaveIssue(viewpoint,screenShot,groupId){var issue;screenShot=screenShot.substring(screenShot.indexOf(",")+1),viewpoint.screenshot=screenShot,issue={account:self.account,model:self.model,objectId:null,name:self.issueData.name,viewpoint:viewpoint,creator_role:self.userJob._id,pickedPos:null,pickedNorm:null,scale:1,assigned_roles:self.issueData.assigned_roles,priority:self.issueData.priority,status:self.issueData.status,topic_type:self.issueData.topic_type,desc:self.issueData.desc,rev_id:self.revision},null!==self.pinData&&(issue.pickedPos=self.pinData.pickedPos,issue.pickedNorm=self.pinData.pickedNorm),angular.isDefined(groupId)&&(issue.group_id=groupId),IssuesService.saveIssue(issue).then(function(response){self.data=response.data,self.issueData=response.data,self.issueData.title=IssuesService.generateTitle(self.issueData),self.issueData.thumbnailPath=UtilsService.getServerUrl(self.issueData.thumbnail),self.descriptionThumbnail=UtilsService.getServerUrl(self.issueData.viewpoint.screenshotSmall),self.issueData.timeStamp=IssuesService.getPrettyTime(self.issueData.created),self.hideDescription=!self.issueData.hasOwnProperty("desc"),self.issueCreated({issue:self.issueData}),self.actions.pin.hidden=!0,self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1}),self.submitDisabled=!0,setContentHeight(),startNotification(),self.saving=!1,$state.go("home.account.model.issue",{account:self.account,model:self.model,revision:self.revision,issue:self.data._id,noSet:!0},{notify:!1})}),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"create"})}function saveComment(){var viewpointPromise=$q.defer();angular.isDefined(self.commentThumbnail)?IssuesService.saveComment(self.issueData,self.comment,commentViewpoint).then(function(response){self.saving=!1,afterNewComment(response.data.issue)}):(self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise,account:self.issueData.account,model:self.issueData.model}}),viewpointPromise.promise.then(function(viewpoint){IssuesService.saveComment(self.issueData,self.comment,viewpoint).then(function(response){self.saving=!1,afterNewComment(response.data.issue)})})),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"comment"})}function afterNewComment(comment,noDeleteInput){self.issueData.comments.forEach(function(comment){comment.sealed=!0}),comment.owner!==Auth.getUsername()&&(comment.sealed=!0),comment.viewpoint&&comment.viewpoint.screenshot&&(comment.viewpoint.screenshotPath=UtilsService.getServerUrl(comment.viewpoint.screenshot)),self.issueData.comments||(self.issueData.comments=[]),self.issueData.comments.push({sealed:comment.sealed,guid:comment.guid,comment:comment.comment,owner:comment.owner,timeStamp:IssuesService.getPrettyTime(comment.created),viewpoint:comment.viewpoint,action:comment.action}),noDeleteInput||(delete self.comment,delete self.commentThumbnail,IssuesService.updatedIssue=self.issueData,self.submitDisabled=!0),commentAreaScrollToBottom(),aboutToBeDestroyed||setContentHeight()}function ScreenShotDialogController(){this.dialogCaller=self,this.closeScreenShot=function(){}}function setRoleIndicatorColour(role){var roleColor=IssuesService.getJobColor(role);null!==roleColor?(issueRoleIndicator.css("background",IssuesService.getJobColor(role)),issueRoleIndicator.css("border","none")):(issueRoleIndicator.css("background","none"),issueRoleIndicator.css("border","1px solid #DDDDDD"))}function userHasCreatorRole(){if(self.userJob._id&&self.data.creator_role)return self.userJob._id===self.data.creator_role}function userHasAdminRole(){var hasAdminRole=!1;return hasAdminRole}function setContentHeight(){var i,length,newIssueHeight=285,descriptionTextHeight=80,commentTextHeight=80,commentImageHeight=170,additionalInfoHeight=140,thumbnailHeight=180,issueMinHeight=370,height=issueMinHeight;if(self.data){if(self.showAdditional&&(height+=additionalInfoHeight),(self.canEditDescription||self.issueData.hasOwnProperty("desc"))&&(height+=descriptionTextHeight),height+=thumbnailHeight,self.commentThumbnail&&(height+=thumbnailHeight),self.issueData.comments)for(i=0,length=self.issueData.comments.length;i<length;i+=1)height+=commentTextHeight,self.issueData.comments[i].viewpoint&&self.issueData.comments[i].viewpoint.hasOwnProperty("screenshot")&&(height+=commentImageHeight)}else height=newIssueHeight,self.showAdditional&&(height+=additionalInfoHeight),self.descriptionThumbnail&&(height+=thumbnailHeight);self.contentHeight({height:height})}function commentAreaScrollToBottom(){$timeout(function(){var commentArea=document.getElementById("descriptionAndComments");commentArea.scrollTop=commentArea.scrollHeight})}function startNotification(){self.data&&!self.notificationStarted&&(self.notificationStarted=!0,NotificationService.subscribe.newComment(self.data.account,self.data.model,self.data._id,function(comment){comment.action&&IssuesService.convertActionCommentToText(comment,self.topic_types),afterNewComment(comment,!0),$scope.$apply(),commentAreaScrollToBottom()}),NotificationService.subscribe.commentChanged(self.data.account,self.data.model,self.data._id,function(newComment){var comment=self.issueData.comments.find(function(comment){return comment.guid===newComment.guid});comment.comment=newComment.comment,$scope.$apply(),commentAreaScrollToBottom()}),NotificationService.subscribe.commentDeleted(self.data.account,self.data.model,self.data._id,function(newComment){var deleteIndex;self.issueData.comments.forEach(function(comment,i){comment.guid===newComment.guid&&(deleteIndex=i)}),self.issueData.comments[deleteIndex].comment="This comment has been deleted.",$scope.$apply(),commentAreaScrollToBottom(),$timeout(function(){self.issueData.comments.splice(deleteIndex,1)},4e3)}),NotificationService.subscribe.issueChanged(self.data.account,self.data.model,self.data._id,function(issue){self.issueData.topic_type=issue.topic_type,self.issueData.desc=issue.desc,self.issueData.priority=issue.priority,self.issueData.status=issue.status,self.issueData.assigned_roles=issue.assigned_roles,self.statusIcon=IssuesService.getStatusIcon(self.issueData),setRoleIndicatorColour(self.issueData.assigned_roles[0]),setCanUpdateStatus(self.issueData),$scope.$apply()}))}var commentViewpoint,savedDescription,savedComment,self=this,savedScreenShot=null,editingCommentIndex=null,aboutToBeDestroyed=!1,textInputHasFocus=!1,issueRoleIndicator=angular.element($element[0].querySelector("#issueRoleIndicator"));this.UtilsService=UtilsService,this.hideDescription=!1,this.submitDisabled=!0,this.pinData=null,this.showAdditional=!0,this.editingDescription=!1,this.clearPin=!1,this.priorities=[{value:"none",label:"None"},{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"}],this.statuses=[{value:"open",label:"Open"},{value:"in progress",label:"In progress"},{value:"for approval",label:"For approval"},{value:"closed",label:"Closed"}],this.actions={screen_shot:{icon:"camera_alt",label:"Screen shot",hidden:!1,selected:!1},pin:{icon:"place",label:"Pin",hidden:this.data,selected:!1}},this.notificationStarted=!1,this.$onChanges=function(changes){changes.hasOwnProperty("modelSettings")&&(this.topic_types=this.modelSettings.properties.topicTypes,this.canComment=Auth.hasPermission(serverConfig.permissions.PERM_COMMENT_ISSUE,this.modelSettings.permissions),convertCommentTopicType()),changes.hasOwnProperty("data")&&(this.data?(this.issueData=angular.copy(this.data),this.issueData.comments=this.issueData.comments||[],this.issueData.name=IssuesService.generateTitle(this.issueData),this.issueData.thumbnailPath=UtilsService.getServerUrl(this.issueData.thumbnail),this.issueData.comments.forEach(function(comment){comment.owner!==Auth.getUsername()&&(comment.sealed=!0)}),this.hideDescription=!this.issueData.hasOwnProperty("desc"),this.issueData.viewpoint.hasOwnProperty("screenshotSmall")&&(this.descriptionThumbnail=UtilsService.getServerUrl(this.issueData.viewpoint.screenshotSmall)),this.canUpdate=Auth.getUsername()===this.issueData.owner,this.canUpdate||(this.canUpdate=this.userJob._id&&this.issueData.creator_role&&this.userJob._id===this.issueData.creator_role),Auth.hasPermission(serverConfig.permissions.PERM_CREATE_ISSUE,this.modelSettings.permissions)||(this.canUpdate=!1),setCanUpdateStatus(this.issueData),this.canEditDescription=0===this.issueData.comments.length,setRoleIndicatorColour(this.issueData.assigned_roles.length>0?this.issueData.assigned_roles[0]:this.issueData.creator_role),this.issueData.priority=this.issueData.priority?this.issueData.priority:"none",this.issueData.status=this.issueData.status?this.issueData.status:"open",this.issueData.topic_type=this.issueData.topic_type?this.issueData.topic_type:"for_information",this.issueData.assigned_roles=this.issueData.assigned_roles?this.issueData.assigned_roles:[],"closed"===this.issueData.status&&(this.canUpdate=!1,this.canComment=!1),convertCommentTopicType()):(this.issueData={priority:"none",status:"open",assigned_roles:[],topic_type:"for_information",viewpoint:{}},this.canUpdate=!0,this.canUpdateStatus=!0),this.statusIcon=IssuesService.getStatusIcon(this.issueData),setContentHeight()),changes.hasOwnProperty("availableJobs")&&this.availableJobs&&(console.log(this.availableJobs),this.modelJobs=this.availableJobs.map(function(availableJob){return availableJob._id}),console.log(this.modelJobs))},this.$onDestroy=function(){aboutToBeDestroyed=!0,this.comment&&(IssuesService.updatedIssue=self.issueData,saveComment()),null!==editingCommentIndex&&(this.issueData.comments[editingCommentIndex].editing=!1),this.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1}),this.clearPin=!0,self.data&&(NotificationService.unsubscribe.newComment(self.data.account,self.data.model,self.data._id),NotificationService.unsubscribe.commentChanged(self.data.account,self.data.model,self.data._id),NotificationService.unsubscribe.commentDeleted(self.data.account,self.data.model,self.data._id),NotificationService.unsubscribe.issueChanged(self.data.account,self.data.model,self.data._id))},this.$onInit=function(){var disableStatus;disableStatus=!!this.data&&(!userHasCreatorRole()&&!userHasAdminRole()),this.statuses=[{value:"open",label:"Open",disabled:disableStatus},{value:"in progress",label:"In progress",disabled:!1},{value:"for approval",label:"For approval",disabled:!1},{value:"closed",label:"Closed",disabled:disableStatus}]},this.nameChange=function(){this.submitDisabled=!this.issueData.name},this.commentChange=function(){this.submitDisabled=this.data&&!this.comment},this.statusChange=function(){var data,comment;this.statusIcon=IssuesService.getStatusIcon(this.issueData),setRoleIndicatorColour(self.issueData.assigned_roles[0]),this.data&&(data={priority:self.issueData.priority,status:self.issueData.status,topic_type:self.issueData.topic_type,assigned_roles:self.issueData.assigned_roles},IssuesService.updateIssue(self.issueData,data).then(function(response){console.log(response),comment=response.data.issue.comments[response.data.issue.comments.length-1],IssuesService.convertActionCommentToText(comment,self.topic_types),comment.timeStamp=IssuesService.getPrettyTime(comment.created),self.issueData.comments.push(comment),self.issueData.comments.length>1&&(self.issueData.comments[self.issueData.comments.length-2].sealed=!0),self.issueData.status=response.data.issue.status,self.issueData.assigned_roles=response.data.issue.assigned_roles,IssuesService.updatedIssue=self.issueData,setCanUpdateStatus(self.issueData),commentAreaScrollToBottom()}),"closed"===self.issueData.status&&(this.canUpdate=!1,this.canComment=!1),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"edit"}))},this.submit=function(){this.saving=!0,self.data?saveComment():saveIssue()},this.showViewpoint=function(event,viewpoint){if(viewpoint&&"click"===event.type){var data={position:viewpoint.position,view_dir:viewpoint.view_dir,up:viewpoint.up,account:self.issueData.account,model:self.issueData.model};self.sendEvent({type:EventService.EVENT.VIEWER.SET_CAMERA,value:data}),data={clippingPlanes:viewpoint.clippingPlanes,fromClipPanel:!1,account:self.issueData.account,model:self.issueData.model},self.sendEvent({type:EventService.EVENT.VIEWER.UPDATE_CLIPPING_PLANES,value:data})}},this.showScreenShot=function(event,viewpoint){self.screenShot=UtilsService.getServerUrl(viewpoint.screenshot),$mdDialog.show({controller:function(){this.dialogCaller=self},controllerAs:"vm",templateUrl:"issueScreenShotDialog.html",targetEvent:event})},this.doAction=function(event,action){this.actions[action].selected=!this.actions[action].selected;var selected=this.actions[action].selected;switch(action){case"pin":selected?self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!0}):self.sendEvent({type:EventService.EVENT.PIN_DROP_MODE,value:!1});break;case"screen_shot":this.actions[action].selected=!1,delete this.screenShot,$mdDialog.show({controller:ScreenShotDialogController,controllerAs:"vm",templateUrl:"issueScreenShotDialog.html",targetEvent:event})}},this.setPin=function(pinData){self.pinData=pinData.data},this.toggleShowAdditional=function(){textInputHasFocus||(this.showAdditional=!this.showAdditional,setContentHeight())},this.toggleEditDescription=function(event){if(event.stopPropagation(),this.editingDescription){if(this.editingDescription=!1,self.issueData.desc!==savedDescription){var data={desc:self.issueData.desc};IssuesService.updateIssue(self.issueData,data).then(function(data){IssuesService.updatedIssue=self.issueData,savedDescription=self.issueData.desc;var comment=data.data.issue.comments[data.data.issue.comments.length-1];IssuesService.convertActionCommentToText(comment,self.topic_types),comment.timeStamp=IssuesService.getPrettyTime(comment.created),self.issueData.comments.push(comment)})}}else this.editingDescription=!0,savedDescription=self.issueData.desc},this.textInputHasFocus=function(focus){textInputHasFocus=focus},this.titleInputClick=function(event){event.stopPropagation()},this.deleteComment=function(event,index){event.stopPropagation(),IssuesService.deleteComment(self.issueData,index).then(function(response){self.issueData.comments.splice(index,1)}),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"deleteComment"}),setContentHeight()},this.toggleEditComment=function(event,index){event.stopPropagation(),this.issueData.comments[index].editing?(editingCommentIndex=null,this.issueData.comments[index].editing=!1,this.issueData.comments[index].comment!==savedComment&&(IssuesService.editComment(self.issueData,this.issueData.comments[index].comment,index).then(function(response){self.issueData.comments[index].timeStamp=IssuesService.getPrettyTime(response.data.created),IssuesService.updatedIssue=self.issueData,savedComment=self.issueData.comments[index].comment}),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"editComment"}))):(editingCommentIndex=index,this.issueData.comments[index].editing=!0,savedComment=this.issueData.comments[index].comment)},this.screenShotSave=function(data){var viewpointPromise=$q.defer();savedScreenShot=data.screenShot,"object"==typeof self.data?(self.commentThumbnail=data.screenShot,self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise,account:self.issueData.account,model:self.issueData.model}})):(self.descriptionThumbnail=data.screenShot,self.sendEvent({type:EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,value:{promise:viewpointPromise,account:self.account,model:self.model}})),viewpointPromise.promise.then(function(viewpoint){commentViewpoint=viewpoint,commentViewpoint.screenshot=data.screenShot.substring(data.screenShot.indexOf(",")+1)}),setContentHeight()},startNotification()}angular.module("3drepo").component("issueComp",{controller:IssueCompCtrl,templateUrl:"issueComp.html",bindings:{account:"<",model:"<",revision:"<",data:"<",keysDown:"<",exit:"&",sendEvent:"&",event:"<",issueCreated:"&",contentHeight:"&",selectedObjects:"<",modelSettings:"<",setInitialSelectedObjects:"&",userJob:"<",availableJobs:"<"}}),IssueCompCtrl.$inject=["$q","$mdDialog","$element","EventService","IssuesService","UtilsService","NotificationService","Auth","$timeout","$scope","serverConfig","AnalyticService","$state"]}(),function(){"use strict";function issue(){return{restrict:"EA",templateUrl:"issue.html",scope:{index:"=",data:"=",autoSaveComment:"=",onCommentSaved:"&",onCommentAutoSaved:"&",onToggleCloseIssue:"&",availableJobs:"=",modelUserJob:"=",onIssueAssignChange:"&"},controller:IssueCtrl,controllerAs:"vm",bindToController:!0}}function IssueCtrl($scope,IssuesService){function setupRolesWatch(){$scope.$watch("vm.roles",function(newValue,oldValue){var i=0,length=0;if(JSON.stringify(newValue)!==JSON.stringify(oldValue)){for(vm.data.assigned_roles=[],i=0,length=vm.roles.length;i<length;i+=1)vm.roles[i].assigned&&vm.data.assigned_roles.push(vm.roles[i]._id);promise=IssuesService.assignIssue(vm.data),promise.then(function(){setAssignedRolesColors(),vm.onIssueAssignChange()})}},!0)}function initAssignedRolesDisplay(){var i=0,length=0;if(angular.isDefined(vm.roles)&&angular.isDefined(vm.data)&&vm.data.hasOwnProperty("assigned_roles")){for(i=0,length=vm.roles.length;i<length;i+=1)vm.roles[i].assigned=vm.data.assigned_roles.indexOf(vm.roles[i]._id)!==-1;setAssignedRolesColors()}}function setAssignedRolesColors(){var i,length,pinColours=[];for(vm.assignedRolesColors=[],i=0,length=vm.roles.length;i<length;i+=1)if(vm.data.assigned_roles.indexOf(vm.roles[i]._id)!==-1){var roleColour=IssuesService.getJobColor(vm.roles[i]._id);vm.assignedRolesColors.push(roleColour),pinColours.push(IssuesService.hexToRgb(roleColour))}}function setupCanModifyIssue(){vm.canModifyIssue=!1,angular.isDefined(vm.modelUserJob)&&angular.isDefined(vm.data)&&vm.data.hasOwnProperty("assigned_roles")&&(vm.canModifyIssue=vm.modelUserJob._id===vm.data.creator_role||vm.data.assigned_roles.indexOf(vm.modelUserJob._id)!==-1)}var initWatch,vm=this,promise=null,originatorEv=null;vm.showComments=!0,vm.numNewComments=0,vm.saveCommentDisabled=!0,vm.autoSaveComment=!1,vm.showInfo=!1,vm.editingComment=!1,vm.assignedRolesColors=[],vm.savingComment=!1,vm.togglingIssueState=!0,$scope.$watch("vm.availableJobs",function(newValue){var i=0,length=0;if(angular.isDefined(newValue)){for(vm.roles=[],i=0,length=newValue.length;i<length;i+=1)vm.roles.push({_id:newValue[i]._id,color:newValue[i].color});setupRolesWatch(),initAssignedRolesDisplay(),setupCanModifyIssue()}}),$scope.$watch("vm.autoSaveComment",function(newValue){angular.isDefined(newValue)&&newValue&&!vm.editingComment&&angular.isDefined(vm.comment)&&""!==vm.comment&&(vm.autoSaveComment=!0,vm.saveComment())}),$scope.$watch("vm.comment",function(newValue){angular.isDefined(newValue)&&(vm.saveCommentDisabled=""===newValue)}),initWatch=$scope.$watch("vm.data",function(newValue){var i=0,length=0;if(angular.isDefined(newValue)){if(vm.issueIsOpen=!0,newValue.hasOwnProperty("closed")&&(vm.issueIsOpen=!newValue.closed),vm.issueIsOpen&&newValue.hasOwnProperty("comments"))for(i=0,length=newValue.comments.length;i<length;i+=1)newValue.comments[i].canDelete=i===newValue.comments.length-1&&!newValue.comments[i].sealed;initAssignedRolesDisplay()}initWatch()},!0),vm.saveComment=function(){angular.isDefined(vm.comment)&&""!==vm.comment&&(vm.savingComment=!0,vm.editingComment?(promise=IssuesService.editComment(vm.data,vm.comment,vm.editingCommentIndex),promise.then(function(data){vm.data.comments[vm.editingCommentIndex].comment=vm.comment,vm.data.comments[vm.editingCommentIndex].timeStamp=IssuesService.getPrettyTime(data.created),vm.comment="",vm.savingComment=!1})):(promise=IssuesService.saveComment(vm.data,vm.comment),promise.then(function(data){vm.data.hasOwnProperty("comments")||(vm.data.comments=[]),vm.data.comments.push({owner:data.owner,comment:vm.comment,created:data.created,timeStamp:IssuesService.getPrettyTime(data.created)}),vm.comment="",vm.numNewComments+=1,vm.autoSaveComment?(vm.onCommentAutoSaved({index:vm.index}),vm.autoSaveComment=!1):vm.onCommentSaved(),vm.data.comments.length>1&&(promise=IssuesService.setComment(vm.data,vm.data.comments.length-2),promise.then(function(data){vm.data.comments[vm.data.comments.length-2].set=!0})),vm.savingComment=!1})))},vm.deleteComment=function(index){promise=IssuesService.deleteComment(vm.data,index),promise.then(function(data){vm.data.comments.splice(index,1),vm.numNewComments-=1,vm.comment="",vm.editingComment=!1})},vm.toggleEditComment=function(index){vm.editingComment=!vm.editingComment,vm.editingCommentIndex=index,vm.editingComment?vm.comment=vm.data.comments[vm.data.comments.length-1].comment:vm.comment=""},vm.toggleCloseIssue=function(){vm.issueIsOpen=!vm.issueIsOpen,vm.onToggleCloseIssue({issue:vm.data})},vm.openAssignedRolesMenu=function($mdOpenMenu,event){originatorEv=event,$mdOpenMenu(event)}}angular.module("3drepo").directive("issue",issue),IssueCtrl.$inject=["$scope","IssuesService"]}(),function(){"use strict";function IssuesPinCtrl(EventService){function removePin(){self.sendEvent({type:EventService.EVENT.VIEWER.REMOVE_PIN,value:{id:newPinId}}),self.setPin({data:null})}var self=this,newPinId="newPinId",pinDropMode=!1;this.setPin({data:null}),this.$onChanges=function(changes){var data,position=[],normal=[];if(changes.hasOwnProperty("event")&&null!==changes.event.currentValue)if(changes.event.currentValue.type===EventService.EVENT.VIEWER.PICK_POINT&&changes.event.currentValue.value.hasOwnProperty("id")&&pinDropMode){removePin();var trans=changes.event.currentValue.value.trans;position=changes.event.currentValue.value.position,normal=changes.event.currentValue.value.normal,trans&&(position=trans.inverse().multMatrixPnt(position)),data={id:newPinId,account:self.account,model:self.model,selectedObjectId:changes.event.currentValue.value.id,pickedPos:position,pickedNorm:normal,colours:[[1,.7,0]]},self.sendEvent({type:EventService.EVENT.VIEWER.ADD_PIN,value:data}),this.setPin({data:data})}else changes.event.currentValue.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED&&pinDropMode?removePin():changes.event.currentValue.type===EventService.EVENT.PIN_DROP_MODE&&(pinDropMode=changes.event.currentValue.value);changes.hasOwnProperty("clearPin")&&changes.clearPin.currentValue&&removePin()},this.$onDestroy=function(){removePin()}}angular.module("3drepo").component("issuesPin",{controller:IssuesPinCtrl,bindings:{account:"<",model:"<",sendEvent:"&",event:"<",setPin:"&",clearPin:"<"}}),IssuesPinCtrl.$inject=["EventService"]}(),function(){"use strict";function IssuesScreenShotCtrl($q,$timeout,$element,UtilsService,EventService){function initCanvas(canvas){canvas.addEventListener("mousedown",function(evt){mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging=!0,updateImage(canvas),window.status="DOWN: "+evt.layerX+", "+evt.layerY,evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!0}),self.actionsPointerEvents="none"},!1),canvas.addEventListener("mouseup",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),self.actionsPointerEvents="auto"},!1),canvas.addEventListener("mouseout",function(evt){mouse_button=0,mouse_dragging=!1,last_mouse_drag_x=-1,last_mouse_drag_y=-1,updateImage(canvas),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,EventService.send(EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING,{on:!1}),self.actionsPointerEvents="auto"},!1),canvas.addEventListener("mousemove",function(evt){window.status="MOVE: "+evt.layerX+", "+evt.layerY,mouse_drag_x=evt.layerX,mouse_drag_y=evt.layerY,mouse_dragging||self.showPenIndicator?(last_mouse_drag_x===-1||hasDrawnOnCanvas||(hasDrawnOnCanvas=!0),updateImage(canvas)):$timeout(function(){self.showPenIndicator=!0}),evt.preventDefault(),evt.stopPropagation(),evt.returnValue=!1,setPenIndicatorPosition(evt.layerX,evt.layerY)},!1)}function updateImage(canvas){var context=canvas.getContext("2d");if(mouse_dragging){if(last_mouse_drag_x<0||last_mouse_drag_y<0)return last_mouse_drag_x=mouse_drag_x,void(last_mouse_drag_y=mouse_drag_y);context.lineWidth=pen_size,context.strokeStyle=pen_col,context.beginPath(),context.lineCap="round",context.moveTo(last_mouse_drag_x,last_mouse_drag_y),context.lineTo(mouse_drag_x,mouse_drag_y),context.stroke(),last_mouse_drag_x=mouse_drag_x,last_mouse_drag_y=mouse_drag_y}}function setupErase(){scribbleCanvasContext.globalCompositeOperation="destination-out",pen_col="rgba(0, 0, 0, 1)"}function setupScribble(){scribbleCanvasContext.globalCompositeOperation="source-over",pen_col="#FF0000"}function setPenIndicatorPosition(x,y){var positionFactorX=10,positionFactorY=30;penIndicator.css("left",x-positionFactorX+"px"),penIndicator.css("top",y+positionFactorY+"px")}var scribbleCanvas,scribbleCanvasContext,penIndicator,self=this,currentActionIndex=null,highlightBackground="#FF9800",screenShotPromise=$q.defer(),innerWidth=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,innerHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,mouse_drag_x=0,mouse_drag_y=0,last_mouse_drag_x=-1,last_mouse_drag_y=-1,mouse_button=0,mouse_dragging=!1,pen_col="#DD0000",penIndicatorSize=16,penToIndicatorRatio=.5,pen_size=penIndicatorSize*penToIndicatorRatio,hasDrawnOnCanvas=!1;"undefined"!=typeof this.screenShot?self.screenShotUse=this.screenShot:$timeout(function(){scribbleCanvas=document.getElementById("scribbleCanvas"),scribbleCanvasContext=scribbleCanvas.getContext("2d"),scribbleCanvas.width=80*innerWidth/100,scribbleCanvas.height=80*innerHeight/100,initCanvas(scribbleCanvas),setupScribble(),self.showPenIndicator=!1,penIndicator=angular.element($element[0].querySelector("#issueScreenShotPenIndicator")),penIndicator.css("font-size",penIndicatorSize+"px"),self.actionsPointerEvents="auto",self.sendEvent({type:EventService.EVENT.VIEWER.GET_SCREENSHOT,value:{promise:screenShotPromise}}),screenShotPromise.promise.then(function(screenShot){self.screenShotUse=screenShot}),self.actions=[{icon:"border_color",action:"draw",label:"Draw",color:highlightBackground},{icon:"fa fa-eraser",action:"erase",label:"Erase",color:""}],currentActionIndex=0}),this.closeDialog=function(){UtilsService.closeDialog(),this.close()},this.doAction=function(index){switch(null===currentActionIndex?(currentActionIndex=index,this.actions[currentActionIndex].color=highlightBackground):currentActionIndex===index?(this.actions[currentActionIndex].color="",currentActionIndex=null):(this.actions[currentActionIndex].color="",currentActionIndex=index,this.actions[currentActionIndex].color=highlightBackground),this.actions[currentActionIndex].action){case"draw":setupScribble();break;case"erase":setupErase()}},this.save=function(){var screenShot,screenShotCanvas=document.getElementById("screenShotCanvas"),screenShotCanvasContext=screenShotCanvas.getContext("2d"),screenShotImage=new Image;screenShotCanvas.width=scribbleCanvas.width,screenShotCanvas.height=scribbleCanvas.height,screenShotImage.src=this.screenShotUse,screenShotCanvasContext.drawImage(screenShotImage,0,0,screenShotCanvas.width,screenShotCanvas.height),screenShotCanvasContext.drawImage(scribbleCanvas,0,0),screenShot=screenShotCanvas.toDataURL("image/png"),this.screenShotSave({screenShot:screenShot}),this.closeDialog()}}angular.module("3drepo").component("issuesScreenShot",{controller:IssuesScreenShotCtrl,
templateUrl:"issueScreenShot.html",bindings:{sendEvent:"&",close:"&",screenShotSave:"&",screenShot:"="}}),IssuesScreenShotCtrl.$inject=["$q","$timeout","$element","UtilsService","EventService"]}(),function(){"use strict";function issues(){return{restrict:"EA",templateUrl:"issues.html",scope:{account:"=",model:"=",branch:"=",revision:"=",filterText:"=",modelSettings:"=",show:"=",showAdd:"=",selectedMenuOption:"=",onContentHeightRequest:"&",onShowItem:"&",hideItem:"=",keysDown:"=",treeMap:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:IssuesCtrl,controllerAs:"vm",bindToController:!0}}function IssuesCtrl($scope,$timeout,IssuesService,EventService,Auth,UtilsService,NotificationService,RevisionsService,serverConfig,AnalyticService,$state,$q){function setAllIssuesAssignedRolesColors(){var i,length;if(null!==vm.availableJobs)for(i=0,length=vm.issues.length;i<length;i+=1)setIssueAssignedRolesColors(vm.issues[i])}function setIssueAssignedRolesColors(issue){var i,length,roleColour,pinColours=[];for(issue.assignedRolesColors=[],i=0,length=issue.assigned_roles.length;i<length;i+=1)roleColour=IssuesService.getJobColor(issue.assigned_roles[i]),issue.assignedRolesColors.push(roleColour),pinColours.push(IssuesService.hexToRgb(roleColour))}function watchNotification(){function newIssueListener(issues,submodel){issues.forEach(function(issue){var showIssue;if(submodel)showIssue=!0;else{var currentRevision,issueRevision=vm.revisions.find(function(rev){return rev._id===issue.rev_id});currentRevision=vm.revision?vm.revisions.find(function(rev){return rev._id===vm.revision||rev.tag===vm.revision}):vm.revisions[0],showIssue=issueRevision&&new Date(issueRevision.timestamp)<=new Date(currentRevision.timestamp)}showIssue&&(issue.title=IssuesService.generateTitle(issue),issue.timeStamp=IssuesService.getPrettyTime(issue.created),issue.thumbnailPath=UtilsService.getServerUrl(issue.thumbnail),vm.issues.unshift(issue))}),vm.issues=vm.issues.slice(0),$scope.$apply()}function issueChangedListener(issue){issue.title=IssuesService.generateTitle(issue),issue.timeStamp=IssuesService.getPrettyTime(issue.created),issue.thumbnailPath=UtilsService.getServerUrl(issue.thumbnail),vm.issues.find(function(oldIssue,i){oldIssue._id===issue._id&&("closed"===issue.status?(vm.issues[i].justClosed=!0,$timeout(function(){vm.issues[i]=issue,vm.issues=vm.issues.slice(0)},4e3)):vm.issues[i]=issue)}),vm.issues=vm.issues.slice(0),$scope.$apply()}vm.revisions&&vm.subModels&&(NotificationService.subscribe.newIssues(vm.account,vm.model,newIssueListener),NotificationService.subscribe.issueChanged(vm.account,vm.model,issueChangedListener),vm.subModels&&vm.subModels.forEach(function(submodel){var submodel=!0;NotificationService.subscribe.newIssues(subModel.database,subModel.model,function(issues){newIssueListener(issues,submodel)}),NotificationService.subscribe.issueChanged(subModel.database,subModel.model,issueChangedListener)}))}function showIssue(issue){var data;EventService.send(EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,{id:issue._id,colours:[pinHighlightColour]}),EventService.send(EventService.EVENT.VIEWER.SET_CAMERA,{position:issue.viewpoint.position,view_dir:issue.viewpoint.view_dir,up:issue.viewpoint.up,account:issue.account,model:issue.model}),EventService.send(EventService.EVENT.VIEWER.UPDATE_CLIPPING_PLANES,{clippingPlanes:issue.viewpoint.clippingPlanes,fromClipPanel:!1,account:issue.account,model:issue.model}),EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,[]),issue.hasOwnProperty("group_id")&&UtilsService.doGet(issue.account+"/"+issue.model+"/groups/"+issue.group_id).then(function(response){var ids=[];response.data.objects&&(response.data.objects.forEach(function(obj){ids.push(vm.treeMap.sharedIdToUid[obj.shared_id])}),data={source:"tree",account:vm.account,model:vm.model,ids:ids,colour:response.data.colour},EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,data))})}function deselectPin(issueId){EventService.send(EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,{id:issueId,colours:[[.5,0,0]]})}var vm=this,pinHighlightColour=[1,.7,0];vm.saveIssueDisabled=!0,vm.issues=[],vm.issuesToShow=[],vm.showProgress=!0,vm.progressInfo="Loading issues",vm.availableJobs=null,vm.modelUserJob,vm.selectedIssue=null,vm.autoSaveComment=!1,vm.onContentHeightRequest({height:70}),vm.savingIssue=!1,vm.issueDisplay={};var getIssue=IssuesService.getIssues(vm.account,vm.model,vm.revision).then(function(data){vm.showProgress=!1,vm.toShow="showIssues",vm.issues=""===data?[]:data,vm.showAddButton=!0;var issue=vm.issues.find(function(issue){return issue._id===vm.issueId});issue&&(vm.displayIssue=issue)}),getJob=IssuesService.getJobs(vm.account,vm.model).then(function(data){vm.availableJobs=data;var menu=[];data.forEach(function(role){menu.push({value:"filterRole",role:role._id,label:role._id,keepCheckSpace:!0,toggle:!0,selected:!0,firstSelected:!1,secondSelected:!1})}),EventService.send(EventService.EVENT.PANEL_CONTENT_ADD_MENU_ITEMS,{type:"issues",menu:menu})});$q.all([getIssue,getJob]).then(function(){setAllIssuesAssignedRolesColors()}),IssuesService.getUserJobFormodel(vm.account,vm.model).then(function(data){vm.modelUserJob=data}),$scope.$watch("vm.title",function(){vm.saveIssueDisabled=angular.isUndefined(vm.title)||""===vm.title.toString()}),$scope.$watch(EventService.currentEvent,function(event){var i,length;if(vm.event=event,event.type===EventService.EVENT.VIEWER.CLICK_PIN){for(i=0,length=vm.issues.length;i<length;i+=1)if(vm.issues[i]._id===event.value.id){vm.editIssue(vm.issues[i]);break}}else event.type===EventService.EVENT.REVISIONS_LIST_READY?(vm.revisions=event.value,watchNotification()):event.type===EventService.EVENT.MODEL_SETTINGS_READY?(Auth.hasPermission(serverConfig.permissions.PERM_CREATE_ISSUE,event.value.permissions)&&(vm.canAddIssue=!0),vm.subModels=event.value.subModels||[],watchNotification()):event.type===EventService.EVENT.SELECT_ISSUE&&(vm.issueId=event.value)}),vm.issueAssignChange=function(){setIssueAssignedRolesColors(vm.selectedIssue),vm.showPins()},vm.showAlert=function(title){vm.showAddAlert=!0,vm.addAlertText=title},vm.closeAddAlert=function(){vm.showAddAlert=!1,vm.addAlertText=""},vm.commentSaved=function(){vm.setContentHeight()},vm.commentAutoSaved=function(index){vm.selectedIndex=index,vm.infoText="Comment on issue #"+vm.issuesToShow[vm.selectedIndex].title+" auto-saved",vm.issuesToShow[vm.selectedIndex].showInfo=!0,vm.infoTimeout=$timeout(function(){vm.issuesToShow[vm.selectedIndex].showInfo=!1},4e3)},vm.hideInfo=function(){vm.issuesToShow[vm.selectedIndex].showInfo=!1,$timeout.cancel(vm.infoTimeout)},vm.setContentHeight=function(height){vm.onContentHeightRequest({height:height})},$scope.$watch("vm.hideItem",function(newValue){console.log("hideItem changed",newValue),angular.isDefined(newValue)&&newValue&&(vm.toShow="showIssues",vm.showAddButton=!0,vm.displayIssue=null,$state.go("home.account.model",{account:vm.account,model:vm.model,revision:vm.revision,noSet:!0},{notify:!1}))}),$scope.$on("$destroy",function(){NotificationService.unsubscribe.newIssues(vm.account,vm.model),NotificationService.unsubscribe.issueChanged(vm.account,vm.model),vm.subModels&&vm.subModels.forEach(function(subModel){NotificationService.unsubscribe.newIssues(subModel.database,subModel.model),NotificationService.unsubscribe.issueChanged(subModel.database,subModel.model)})}),vm.sendEvent=function(type,value){EventService.send(type,value)},vm.importBcf=function(file){$scope.$apply(),vm.importingBCF=!0,IssuesService.importBcf(vm.account,vm.model,vm.revision,file).then(function(){return IssuesService.getIssues(vm.account,vm.model,vm.revision)}).then(function(data){vm.importingBCF=!1,vm.issues=""===data?[]:data}).catch(function(err){vm.importingBCF=!1,console.log("Error while importing bcf",err)})},vm.editIssue=function(issue){vm.event=null,vm.onShowItem(),vm.selectedIssue&&(!issue||issue&&vm.selectedIssue._id!=issue._id)&&(deselectPin(vm.selectedIssue._id),EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,[])),issue?(showIssue(issue),IssuesService.getIssue(issue.account,issue.model,issue._id).then(function(issue){vm.selectedIssue=issue}),$state.go("home.account.model.issue",{account:vm.account,model:vm.model,revision:vm.revision,issue:issue._id,noSet:!0},{notify:!1}),AnalyticService.sendEvent({eventCategory:"Issue",eventAction:"view"})):vm.selectedIssue=issue,vm.toShow="showIssue",vm.showAddButton=!1},vm.selectIssue=function(issue){vm.selectedIssue&&vm.selectedIssue._id!==issue._id&&deselectPin(vm.selectedIssue._id),vm.selectedIssue=issue},vm.editIssueExit=function(issue){vm.hideItem=!0},vm.issueCreated=function(issue){vm.issues.unshift(issue),vm.selectedIssue=issue}}angular.module("3drepo").directive("issues",issues),IssuesCtrl.$inject=["$scope","$timeout","IssuesService","EventService","Auth","UtilsService","NotificationService","RevisionsService","serverConfig","AnalyticService","$state","$q"]}(),function(){"use strict";function IssuesListCtrl($filter,$window,UtilsService,IssuesService,EventService,serverConfig,$timeout){function setFocus(issue,index){null!==selectedIssue&&(selectedIssue.focus=!1),focusedIssueIndex=index,issue.focus=!0}function setSelectedIssueIndex(selectedIssue){var i,length;if(null!==selectedIssue)for(i=0,length=self.issuesToShow.length;i<length;i+=1)self.issuesToShow[i]._id===selectedIssue._id&&(selectedIssueIndex=i);else selectedIssueIndex=null}function showIssue(issue){var data,pinHighlightColour=[1,.7,0];data={id:issue._id,colours:[pinHighlightColour]},self.sendEvent({type:EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,value:data}),data={position:issue.viewpoint.position,view_dir:issue.viewpoint.view_dir,up:issue.viewpoint.up,account:issue.account,model:issue.model},self.sendEvent({type:EventService.EVENT.VIEWER.SET_CAMERA,value:data}),data={clippingPlanes:issue.viewpoint.clippingPlanes,fromClipPanel:!1,account:issue.account,model:issue.model},self.sendEvent({type:EventService.EVENT.VIEWER.UPDATE_CLIPPING_PLANES,value:data}),self.sendEvent({type:EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,value:[]}),EventService.send(EventService.EVENT.RESET_SELECTED_OBJS,[]),issue.hasOwnProperty("group_id")&&UtilsService.doGet(issue.account+"/"+issue.model+"/groups/"+issue.group_id).then(function(response){console.log(response.data);var ids=[];response.data.objects.forEach(function(obj){var key=obj.account+"@"+obj.model;ids[key]||(ids[key]=[]),ids[key].push(self.treeMap.sharedIdToUid[obj.shared_id])});for(var key in ids){var vals=key.split("@"),account=vals[0],model=vals[1];data={source:"tree",account:account,model:model,ids:ids[key],colour:response.data.colour,multi:!0},EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,data)}})}function deselectPin(issue){var data;issue.position.length>0&&(data={id:issue._id,colours:[[.5,0,0]]},self.sendEvent({type:EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR,value:data}))}function setupIssuesToShow(){var sortedIssuesLength,i=0,j=0,length=0;if(self.issuesToShow=[],issuesToShowWithPinsIDs={},self.allIssues.length>0){for(self.issuesToShow=[self.allIssues[0]],i=1,length=self.allIssues.length;i<length;i+=1)for(j=0,sortedIssuesLength=self.issuesToShow.length;j<sortedIssuesLength;j+=1){if(self.allIssues[i].created<self.issuesToShow[j].created&&sortOldestFirst||self.allIssues[i].created>self.issuesToShow[j].created&&!sortOldestFirst){self.issuesToShow.splice(j,0,self.allIssues[i]);break}j===self.issuesToShow.length-1&&self.issuesToShow.push(self.allIssues[i])}if(angular.isDefined(self.filterText)&&""!==self.filterText){var stringSearch=function(superString,subString){return!!superString&&superString.toLowerCase().indexOf(subString.toLowerCase())!==-1};self.issuesToShow=$filter("filter")(self.issuesToShow,function(issue){var i,show=stringSearch(issue.title,self.filterText);if(show=show||stringSearch(issue.timeStamp,self.filterText),show=show||stringSearch(issue.owner,self.filterText),!show&&issue.hasOwnProperty("assigned_roles"))for(i=0;!show&&i<issue.assigned_roles.length;)show=show||stringSearch(issue.assigned_roles[i],self.filterText),i+=1;if(!show&&issue.hasOwnProperty("comments"))for(i=0;!show&&i<issue.comments.length;)show=show||stringSearch(issue.comments[i].comment,self.filterText),show=show||stringSearch(issue.comments[i].owner,self.filterText),i+=1;return show})}for(i=self.issuesToShow.length-1;i>=0;i-=1)showClosed||"closed"!==self.issuesToShow[i].status||self.issuesToShow.splice(i,1);self.issuesToShow=self.issuesToShow.filter(function(issue){return!!showSubModelIssues||issue.model===self.model}),self.issuesToShow=self.issuesToShow.filter(function(issue){return excludeRoles.indexOf(issue.creator_role)===-1})}for(i=0,length=self.issuesToShow.length;i<length;i+=1)self.issuesToShow[i].position.length>0&&(issuesToShowWithPinsIDs[self.issuesToShow[i]._id]=!0);self.issuesToShow.length>0?(self.toShow="list",self.contentHeight({height:self.issuesToShow.length*issuesListItemHeight})):(self.toShow="info",self.info="No issues to show",self.contentHeight({height:infoHeight}))}function showPins(){var i,length,pin,pinData;for(i=0,length=self.allIssues.length;i<length;i+=1)if(self.allIssues[i].position.length>0)if(pin=angular.element(document.getElementById(self.allIssues[i]._id)),pin.length>0)issuesToShowWithPinsIDs[self.allIssues[i]._id]?pin[0].setAttribute("render","true"):pin[0].setAttribute("render","false");else if(issuesToShowWithPinsIDs[self.allIssues[i]._id]){pinData={id:self.allIssues[i]._id,position:self.allIssues[i].position,norm:self.allIssues[i].norm,account:self.allIssues[i].account,model:self.allIssues[i].model};var pinColor=[.5,0,0];self.selectedIssue&&self.allIssues[i]._id===self.selectedIssue._id&&(pinColor=[1,.7,0]),IssuesService.addPin(pinData,[pinColor],self.allIssues[i].viewpoint)}}var issuesToShowWithPinsIDs,self=this,selectedIssue=null,selectedIssueIndex=null,issuesListItemHeight=141,infoHeight=81,sortOldestFirst=!1,showClosed=!1,focusedIssueIndex=null,showSubModelIssues=!1,excludeRoles=[];this.UtilsService=UtilsService,this.IssuesService=IssuesService,this.setFocus=setFocus,this.$onChanges=function(changes){var i,length,index,updatedIssue=IssuesService.updatedIssue;if(changes.hasOwnProperty("allIssues")&&this.allIssues&&(this.allIssues.length>0?(self.toShow="list",updatedIssue&&(index=this.allIssues.findIndex(function(issue){return issue._id===updatedIssue._id}),this.allIssues[index]=updatedIssue),self.issueDisplay.showClosed&&(showClosed=self.issueDisplay.showClosed),self.issueDisplay.sortOldestFirst&&(sortOldestFirst=self.issueDisplay.sortOldestFirst),self.issueDisplay.showSubModelIssues&&(showSubModelIssues=self.issueDisplay.showSubModelIssues),setupIssuesToShow(),showPins()):(self.toShow="info",self.info="There are currently no open issues",self.contentHeight({height:infoHeight}))),changes.hasOwnProperty("filterText")&&"undefined"!=typeof this.filterText&&(setupIssuesToShow(),showPins()),changes.hasOwnProperty("menuOption")&&this.menuOption){if("sortByDate"===this.menuOption.value)sortOldestFirst=!sortOldestFirst,self.issueDisplay.sortOldestFirst=sortOldestFirst;else if("showClosed"===this.menuOption.value)showClosed=!showClosed,self.issueDisplay.showClosed=showClosed;else if("showSubModels"===this.menuOption.value)showSubModelIssues=!showSubModelIssues,self.issueDisplay.showSubModelIssues=showSubModelIssues;else if("print"===this.menuOption.value){var ids=[];this.issuesToShow.forEach(function(issue){ids.push(issue._id)}),$window.open(serverConfig.apiUrl(serverConfig.GET_API,this.account+"/"+this.model+"/issues.html?ids="+ids.join(",")),"_blank")}else if("exportBCF"===this.menuOption.value)$window.open(serverConfig.apiUrl(serverConfig.GET_API,this.account+"/"+this.model+"/issues.bcfzip"),"_blank");else if("importBCF"===this.menuOption.value){var file=document.createElement("input");file.setAttribute("type","file"),file.setAttribute("accept",".zip,.bcfzip"),file.click(),file.addEventListener("change",function(){self.importBcf({file:file.files[0]})})}else if("filterRole"===this.menuOption.value){var index=excludeRoles.indexOf(this.menuOption.role);this.menuOption.selected?index!==-1&&excludeRoles.splice(index,1):index===-1&&excludeRoles.push(this.menuOption.role)}setupIssuesToShow(),showPins()}if(changes.hasOwnProperty("updatedIssue")&&this.updatedIssue)for(i=0,length=this.allIssues.length;i<length;i+=1)if(this.updatedIssue._id===this.allIssues[i]._id){this.allIssues[i]=this.updatedIssue;break}if(changes.hasOwnProperty("selectedIssue")&&this.issuesToShow)for(i=0,length=this.issuesToShow.length;i<length;i+=1)this.issuesToShow[i].selected=!1,this.issuesToShow[i].focus=!1,this.selectedIssue&&this.issuesToShow[i]._id===this.selectedIssue._id&&(selectedIssue=this.issuesToShow[i],selectedIssue.selected=!0,selectedIssue.focus=!0,focusedIssueIndex=i,selectedIssueIndex=i);if(changes.hasOwnProperty("displayIssue")&&this.displayIssue){var that=this;this.editIssue(this.displayIssue),$timeout(function(){showIssue(that.displayIssue)},1500)}},this.select=function(event,issue){"click"===event.type&&(null===selectedIssue||selectedIssue._id===issue._id?(selectedIssue=issue,selectedIssue.selected=!0,selectedIssue.focus=!0,showIssue(selectedIssue),setSelectedIssueIndex(selectedIssue)):(selectedIssue.selected=!1,selectedIssue.focus=!1,deselectPin(selectedIssue),selectedIssue=issue,selectedIssue.selected=!0,selectedIssue.focus=!0,showIssue(selectedIssue),setSelectedIssueIndex(selectedIssue)),this.onSelectIssue({issue:selectedIssue}))},this.initSetFocus=function(){null===this.setFocus&&(this.setFocus=setFocus)},this.removeFocus=function(event,issue){focusedIssueIndex=null,issue.focus=!1},this.editIssue=function(issue){this.onEditIssue({issue:issue})}}angular.module("3drepo").component("issuesList",{controller:IssuesListCtrl,templateUrl:"issuesList.html",bindings:{account:"<",model:"<",allIssues:"<",treeMap:"<",filterText:"<",sendEvent:"&",event:"<",onEditIssue:"&",onSelectIssue:"&",nonListSelect:"<",keysDown:"<",contentHeight:"&",menuOption:"<",importBcf:"&",selectedIssue:"<",displayIssue:"<",userJob:"<",issueDisplay:"<",availableJobs:"<"}}),IssuesListCtrl.$inject=["$filter","$window","UtilsService","IssuesService","EventService","serverConfig","$timeout"]}(),function(){"use strict";function IssuesListItemCtrl($element,$timeout,IssuesService){function setRoleIndicatorColour(){var assignedRoleColour;console.log("setRoleIndicatorColour",self.data.assigned_roles,IssuesService.getJobColor(self.data.assigned_roles[0])),self.data&&self.data.assigned_roles.length>0&&issueRoleIndicator&&(assignedRoleColour=IssuesService.getJobColor(self.data.assigned_roles[0]),null!==assignedRoleColour&&(issueRoleIndicator.css("border","none"),issueRoleIndicator.css("background",assignedRoleColour)))}function issueIsAssignedToAUserRole(){return self.data.assigned_roles.indexOf(self.userJob._id)!==-1}var self=this,issueRoleIndicator=null;this.IssuesService=IssuesService,this.$onInit=function(){$timeout(function(){issueRoleIndicator=angular.element($element[0].querySelector("#issueRoleIndicator")),setRoleIndicatorColour()})},this.$onChanges=function(changes){changes.hasOwnProperty("data")&&this.data&&(setRoleIndicatorColour(),this.userJob&&(this.assignedToAUserRole=issueIsAssignedToAUserRole())),changes.hasOwnProperty("userJob")&&this.userJob&&this.data&&(this.assignedToAUserRole=issueIsAssignedToAUserRole())}}angular.module("3drepo").component("issuesListItem",{controller:IssuesListItemCtrl,templateUrl:"issuesListItem.html",bindings:{data:"<",userJob:"<"}}),IssuesListItemCtrl.$inject=["$element","$timeout","IssuesService"]}(),function(){"use strict";function IssuesService($http,$q,serverConfig,EventService,UtilsService,$sanitize){function doPut(issue,data){var url,deferred=$q.defer();url=issue.rev_id?serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.model+"/revision/"+issue.rev_id+"/issues/"+issue._id+".json"):serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.model+"/issues/"+issue._id+".json");var config={withCredentials:!0};return $http.put(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function convertActionValueToText(value){var text="";switch(value){case"none":text="None";break;case"low":text="Low";break;case"medium":text="Medium";break;case"high":text="High";break;case"open":text="Open";break;case"in progress":text="In progress";break;case"for approval":text="For approval";break;case"closed":text="Closed"}return text}var i,url="",config={},numIssues=0,availableJobs=[],obj={},newPinId="newPinId",updatedIssue=null;return obj.getPrettyTime=function(time){var prettyTime,postFix,hours,date=new Date(time),currentDate=new Date,monthToText=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return date.getFullYear()===currentDate.getFullYear()&&date.getMonth()===currentDate.getMonth()&&date.getDate()===currentDate.getDate()?(hours=date.getHours(),hours>11?(postFix=" PM",hours>12&&(hours-=12)):(postFix=" AM",0===hours&&(hours=12)),prettyTime=hours+":"+("0"+date.getMinutes()).slice(-2)+postFix):prettyTime=date.getFullYear()===currentDate.getFullYear()?date.getDate()+" "+monthToText[date.getMonth()]:monthToText[date.getMonth()]+" '"+date.getFullYear().toString().slice(-2),prettyTime},obj.generateTitle=function(issue){return issue.modelCode?issue.modelCode+"."+issue.number+" "+issue.name:issue.typePrefix?issue.typePrefix+"."+issue.number+" "+issue.name:issue.number+" "+issue.name},obj.getIssue=function(account,model,issueId){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/issues/"+issueId+".json");return $http.get(url).then(function(res){res.data=obj.cleanIssue(res.data),deferred.resolve(res.data)}).catch(function(err){deferred.reject(err)}),deferred.promise},obj.getIssues=function(account,model,revision){var deferred=$q.defer();return url=revision?serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/revision/"+revision+"/issues.json"):serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/issues.json"),$http.get(url).then(function(data){for(deferred.resolve(data.data),i=0,numIssues=data.data.length;i<numIssues;i+=1)data.data[i].timeStamp=obj.getPrettyTime(data.data[i].created),data.data[i].title=obj.generateTitle(data.data[i]),data.data[i].thumbnail&&(data.data[i].thumbnailPath=UtilsService.getServerUrl(data.data[i].thumbnail))},function(){deferred.resolve([])}),deferred.promise},obj.saveIssue=function(issue){var url,deferred=$q.defer();return url=issue.rev_id?serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.model+"/revision/"+issue.rev_id+"/issues.json"):serverConfig.apiUrl(serverConfig.POST_API,issue.account+"/"+issue.model+"/issues.json"),config={withCredentials:!0},null!==issue.pickedPos&&(issue.position=issue.pickedPos,issue.norm=issue.pickedNorm),$http.post(url,issue,config).then(function(response){deferred.resolve(response)}),deferred.promise},obj.updateIssue=function(issue,data){return doPut(issue,data)},obj.toggleCloseIssue=function(issue){var closed=!0;return issue.hasOwnProperty("closed")&&(closed=!issue.closed),doPut(issue,{closed:closed,number:issue.number})},obj.assignIssue=function(issue){return doPut(issue,{assigned_roles:issue.assigned_roles,number:0})},obj.saveComment=function(issue,comment,viewpoint){return doPut(issue,{comment:comment,viewpoint:viewpoint})},obj.editComment=function(issue,comment,commentIndex){return doPut(issue,{comment:comment,number:issue.number,edit:!0,commentIndex:commentIndex})},obj.deleteComment=function(issue,index){return doPut(issue,{comment:"",number:issue.number,delete:!0,commentIndex:index})},obj.sealComment=function(issue,commentIndex){return doPut(issue,{comment:"",number:issue.number,sealed:!0,commentIndex:commentIndex})},obj.addPin=function(pin,colours,viewpoint){EventService.send(EventService.EVENT.VIEWER.ADD_PIN,{id:pin.id,account:pin.account,model:pin.model,pickedPos:pin.position,pickedNorm:pin.norm,colours:colours,viewpoint:viewpoint})},obj.removePin=function(id){EventService.send(EventService.EVENT.VIEWER.REMOVE_PIN,{id:id})},obj.fixPin=function(pin,colours){obj.removePin(),EventService.send(EventService.EVENT.VIEWER.ADD_PIN,{id:newPinId,pickedPos:pin.position,pickedNorm:pin.norm,colours:colours})},obj.getJobs=function(account,model){var deferred=$q.defer();return url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/jobs.json"),$http.get(url).then(function(data){availableJobs=data.data,deferred.resolve(availableJobs)},function(){deferred.resolve([])}),deferred.promise},obj.getUserJobFormodel=function(account,model){var deferred=$q.defer();return url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/userJobForModel.json"),$http.get(url).then(function(data){deferred.resolve(data.data)},function(){deferred.resolve()}),deferred.promise},obj.hexToRgb=function(hex){if(hex){var hexColours=[];return"#"===hex.charAt(0)&&(hex=hex.substr(1)),6===hex.length?(hexColours.push(hex.substr(0,2)),hexColours.push(hex.substr(2,2)),hexColours.push(hex.substr(4,2))):3===hex.length?(hexColours.push(hex.substr(0,1)+hex.substr(0,1)),hexColours.push(hex.substr(1,1)+hex.substr(1,1)),hexColours.push(hex.substr(2,1)+hex.substr(2,1))):hexColours=["00","00","00"],[parseInt(hexColours[0],16)/255,parseInt(hexColours[1],16)/255,parseInt(hexColours[2],16)/255]}},obj.getJobColor=function(id){var i,length,roleColor=null;for(i=0,length=availableJobs.length;i<length;i+=1)if(availableJobs[i]._id===id&&availableJobs[i].color){roleColor=availableJobs[i].color;break}return roleColor},obj.getStatusIcon=function(issue){var statusIcon={};switch(issue.priority){case"none":statusIcon.colour="#7777777";break;case"low":statusIcon.colour="#4CAF50";break;case"medium":statusIcon.colour="#FF9800";break;case"high":statusIcon.colour="#F44336"}switch(issue.status){case"open":statusIcon.icon="panorama_fish_eye";break;case"in progress":statusIcon.icon="lens";break;case"for approval":statusIcon.icon="adjust";break;case"closed":statusIcon.icon="check_circle",statusIcon.colour="#004594"}return statusIcon},obj.importBcf=function(account,model,revision,file){var deferred=$q.defer(),url=account+"/"+model+"/issues.bcfzip";revision&&(url=account+"/"+model+"/revision/"+revision+"/issues.bcfzip");var formData=new FormData;return formData.append("file",file),UtilsService.doPost(formData,url,{"Content-Type":void 0}).then(function(res){200===res.status?deferred.resolve():deferred.reject(res.data)}),deferred.promise},obj.convertActionCommentToText=function(comment,topic_types){var text="";switch(comment.action.property){case"priority":comment.action.propertyText="Priority",comment.action.from=convertActionValueToText(comment.action.from),comment.action.to=convertActionValueToText(comment.action.to);break;case"status":comment.action.propertyText="Status",comment.action.from=convertActionValueToText(comment.action.from),comment.action.to=convertActionValueToText(comment.action.to);break;case"assigned_roles":comment.action.propertyText="Assigned",comment.action.from=comment.action.from.toString(),comment.action.to=comment.action.to.toString();break;case"topic_type":if(comment.action.propertyText="Type",topic_types){var from=topic_types.find(function(topic_type){return topic_type.value===comment.action.from}),to=topic_types.find(function(topic_type){return topic_type.value===comment.action.to});from&&from.label&&(comment.action.from=from.label),to&&to.label&&(comment.action.to=to.label)}break;case"desc":comment.action.propertyText="Description"}return text},obj.cleanIssue=function(issue){var self=this;if(issue.timeStamp=self.getPrettyTime(issue.created),issue.title=self.generateTitle(issue),issue.hasOwnProperty("comments"))for(var j=0,numComments=issue.comments.length;j<numComments;j+=1)issue.comments[j].hasOwnProperty("created")&&(issue.comments[j].timeStamp=self.getPrettyTime(issue.comments[j].created)),issue.comments[j].action&&(issue.comments[j].comment=obj.convertActionCommentToText(issue.comments[j])),issue.comments[j].viewpoint&&issue.comments[j].viewpoint.screenshot&&(issue.comments[j].viewpoint.screenshotPath=UtilsService.getServerUrl(issue.comments[j].viewpoint.screenshot));return issue},Object.defineProperty(obj,"newPinId",{get:function(){return newPinId}}),Object.defineProperty(obj,"updatedIssue",{get:function(){var tmpUpdatedIssue;return null===updatedIssue?null:(tmpUpdatedIssue=updatedIssue,updatedIssue=null,tmpUpdatedIssue)},set:function(issue){updatedIssue=issue}}),obj}angular.module("3drepo").factory("IssuesService",IssuesService),IssuesService.$inject=["$http","$q","serverConfig","EventService","UtilsService","$sanitize"]}(),function(){"use strict";function login(){return{restrict:"EA",templateUrl:"login.html",scope:{},controller:LoginCtrl,controllerAs:"vm",bindToController:!0}}function LoginCtrl($scope,Auth,EventService,serverConfig,UtilsService){var vm=this,enterKey=13;vm.version=serverConfig.apiVersion,vm.login=function(event){angular.isDefined(event)?event.which===enterKey&&Auth.login(vm.user.username,vm.user.password):Auth.login(vm.user.username,vm.user.password)},$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.USER_LOGGED_IN&&event.value.hasOwnProperty("error")&&(500===event.value.error.status?vm.errorMessage="There is currently a problem with the system. Please try again later.":vm.errorMessage=UtilsService.getErrorMessage(event.value.error))})}angular.module("3drepo").directive("login",login),LoginCtrl.$inject=["$scope","Auth","EventService","serverConfig","UtilsService"]}(),function(){"use strict";function measure(){return{restrict:"EA",templateUrl:"measure.html",scope:{account:"=",model:"=",settings:"="},controller:MeasureCtrl,controllerAs:"vm",bindToController:!0}}function MeasureCtrl($scope,$element,EventService,ModelService){var currentPickPoint,vm=this,coords=[null,null];vm.axisDistance=[0,0,0],vm.totalDistance=0,vm.show=!1,vm.distance=!1,vm.allowMove=!1,vm.units=server_config.units;var coordVector=null;vm.screenPos=[0,0],vm.unit=vm.settings.unit,EventService.send(EventService.EVENT.VIEWER.REGISTER_MOUSE_MOVE_CALLBACK,{callback:function(event){var point=event.hitPnt;vm.screenPos=[event.layerX,event.layerY],vm.allowMove&&(point?(coords[1]=new x3dom.fields.SFVec3f(point[0],point[1],point[2]),coordVector=coords[0].subtract(coords[1]),vm.axisDistance[0]=Math.abs(coordVector.x).toFixed(3),vm.axisDistance[1]=Math.abs(coordVector.y).toFixed(3),vm.axisDistance[2]=Math.abs(coordVector.z).toFixed(3),vm.totalDistance=coordVector.length().toFixed(3),angular.element($element[0]).css("left",(vm.screenPos[0]+5).toString()+"px"),angular.element($element[0]).css("top",(vm.screenPos[1]+5).toString()+"px"),$scope.$apply(),vm.show=!0):vm.show=!1)}}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.VIEWER.PICK_POINT&&event.value.hasOwnProperty("position")&&(currentPickPoint=event.value.position,null===coords[1]||null===coords[0]?(vm.show=!0,vm.allowMove=!0,coords[0]=currentPickPoint):vm.allowMove?(vm.show=!0,vm.allowMove=!1):(coords[0]=currentPickPoint,coords[1]=null,vm.allowMove=!0))})}angular.module("3drepo").directive("tdrMeasure",measure),MeasureCtrl.$inject=["$scope","$element","EventService","ModelService"]}(),function(){"use strict";function EventService($timeout){var EVENT={AUTO_META_DATA:"EVENT_AUTO_META_DATA",FILTER:"EVENT_FILTER",FULL_SCREEN_ENTER:"EVENT_FULL_SCREEN_ENTER",GET_ISSUE_AREA_PNG:"EVENT_GET_ISSUE_AREA_PNG",GLOBAL_CLICK:"EVENT_GLOBAL_CLICK",ISSUE_AREA_PNG:"EVENT_ISSUE_AREA_PNG",MEASURE_MODE:"EVENT_MEASURE_MODE",MULTI_SELECT_MODE:"EVENT_MULTI_SELECT_MODE",OBJECT_SELECTED:"EVENT_OBJECT_SELECTED",PIN_DROP_MODE:"EVENT_PIN_DROP_MODE",PIN_SELECTED:"EVENT_PIN_SELECTED",PANEL_CONTENT_CLICK:"EVENT_LEFT_PANEL_CONTENT_CLICK",PANEL_CARD_ADD_MODE:"EVENT_PANEL_CARD_ADD_MODE",PANEL_CARD_EDIT_MODE:"EVENT_PANEL_CARD_EDIT_MODE",PANEL_CONTENT_SETUP:"EVENT_PANEL_CONTENT_SETUP",PANEL_CONTENT_TOGGLED:"EVENT_PANEL_CONTENT_TOGGLED",
UPDATE_CLIPPING_PLANES:"EVENT_UPDATE_CLIPPING_PLANES",SET_SUBMODEL_TRANS_INFO:"EVENT_SET_SUBMODEL_TRANS_INFO",SET_ISSUE_AREA_MODE:"EVENT_SET_ISSUE_AREA_MODE",SHOW_MODELS:"EVENT_SHOW_MODELS",SHOW_QR_CODE_READER:"EVENT_SHOW_QR_CODE_READER",TOGGLE_ELEMENTS:"EVENT_TOGGLE_ELEMENTS",TOGGLE_HELP:"EVENT_TOGGLE_HELP",TOGGLE_ISSUE_ADD:"EVENT_TOGGLE_ISSUE_ADD",TOGGLE_ISSUE_AREA:"EVENT_TOGGLE_ISSUE_AREA",TOGGLE_ISSUE_AREA_DRAWING:"EVENT_TOGGLE_ISSUE_AREA_DRAWING",WINDOW_HEIGHT_CHANGE:"EVENT_WINDOW_HEIGHT_CHANGE",PANEL_CONTENT_ADD_MENU_ITEMS:"PANEL_CONTENT_ADD_MENU_ITEMS",RESET_SELECTED_OBJS:"EVENT_RESET_SELECTED_OBJS",CREATE_VIEWER:"EVENT_CREATE_VIEWER",CLOSE_VIEWER:"EVENT_CLOSE_VIEWER",VIEWER:VIEWER_EVENTS,MODEL_SETTINGS_READY:"EVENT_MODEL_SETTINGS_READY",REVISIONS_LIST_READY:"EVENT_REVISIONS_LIST_READY",TREE_READY:"EVENT_TREE_READY",USER_LOGGED_IN:"EVENT_USER_LOGGED_IN",USER_LOGGED_OUT:"EVENT_USER_LOGGED_OUT",USER_NOT_AUTHORIZED:"EVENT_USER_NOT_AUTHORIZED",GO_HOME:"EVENT_GO_HOME",CLEAR_STATE:"EVENT_CLEAR_STATE",SET_STATE:"EVENT_SET_STATE",STATE_CHANGED:"EVENT_STATE_CHANGED",SELECT_ISSUE:"EVENT_SELECT_ISSUE",UPDATE_STATE:"EVENT_UPDATE_STATE"},ERROR={DUPLICATE_VIEWER_NAME:"ERROR_DUPLICATE_VIEWER_NAME"},currentEvent={},currentError={},send=function(type,value){$timeout(function(){angular.isUndefined(type)?console.trace("UNDEFINED EVENT TYPE"+type+JSON.stringify(value)):(console.log("SEND: "+type),console.log(value),currentEvent={type:type,value:value})})},sendError=function(type,value){$timeout(function(){angular.isUndefined(type)?console.trace("UNDEFINED ERROR TYPE"):currentError={type:type,value:value}})};return{EVENT:EVENT,ERROR:ERROR,currentEvent:function(){return currentEvent},currentError:function(){return currentError},send:send,sendError:sendError}}angular.module("3drepo").factory("EventService",EventService),EventService.$inject=["$timeout"]}(),function(){"use strict";function global(EventService){function link(scope,element){}return{restrict:"A",link:link}}angular.module("3drepo").directive("global",global),global.$inject=["EventService"]}(),function(){"use strict";function model(){return{restrict:"E",scope:{account:"=",model:"=",branch:"=",revision:"=",issueId:"=",state:"=",keysDown:"="},templateUrl:"model.html",controller:ModelCtrl,controllerAs:"vm",bindToController:!0}}function ModelCtrl($timeout,$scope,$element,$compile,EventService,ModelService,TreeService,RevisionsService){var modelUI,issueArea,vm=this,panelCard={left:[],right:[]},issuesCardIndex=0;vm.pointerEvents="inherit";var refreshHandler=function(e){var confirmationMessage="This will reload the whole model, are you sure?";return e.returnValue=confirmationMessage,confirmationMessage};window.addEventListener("beforeunload",refreshHandler),history.pushState(null,null,document.URL);var popStateHandler=function(){confirm("It will go back to model listing page, are you sure?")?history.go(-1):history.pushState(null,null,document.URL)};window.addEventListener("popstate",popStateHandler),$scope.$on("$destroy",function(){window.removeEventListener("beforeunload",refreshHandler),window.removeEventListener("popstate",popStateHandler)}),$timeout(function(){modelUI=angular.element($element[0].querySelector("#modelUI"))}),panelCard.left.push({type:"issues",title:"Issues",show:!0,help:"List current issues",icon:"place",menu:[{value:"print",label:"Print",selected:!1,noToggle:!0,icon:"fa-print"},{value:"exportBCF",label:"Export BCF",selected:!1,noToggle:!0,icon:"fa-cloud-download",divider:!0},{value:"sortByDate",label:"Sort by Date",firstSelectedIcon:"fa-sort-amount-desc",secondSelectedIcon:"fa-sort-amount-asc",toggle:!1,selected:!0,firstSelected:!0,secondSelected:!1},{value:"showClosed",label:"Show resolved issues",toggle:!0,selected:!1,firstSelected:!1,secondSelected:!1},{value:"showSubModels",label:"Show sub model issues",toggle:!0,selected:!1,firstSelected:!1,secondSelected:!1},{upperDivider:!0,label:"Created by: "}],minHeight:260,fixedHeight:!1,options:[{type:"menu",visible:!0},{type:"filter",visible:!0},{type:"pin",visible:!1},{type:"erase",visible:!1},{type:"scribble",visible:!1}],add:!0}),panelCard.left.push({type:"tree",title:"Tree",show:!1,help:"Model elements shown in a tree structure",icon:"device_hub",minHeight:80,fixedHeight:!1,options:[{type:"filter",visible:!0}]}),panelCard.left.push({type:"clip",title:"Clip",show:!1,help:"Clipping plane",icon:"crop_original",fixedHeight:!0,options:[{type:"visible",visible:!0}]}),panelCard.right.push({type:"docs",title:"Data",show:!1,help:"Documents",icon:"content_copy",minHeight:80,fixedHeight:!1,options:[{type:"close",visible:!0}]}),panelCard.right.push({type:"building",title:"Building",show:!1,help:"Building",icon:"fa-cubes",fixedHeight:!0,options:[]}),$scope.$watchGroup(["vm.account","vm.model"],function(){angular.isDefined(vm.account)&&angular.isDefined(vm.model)&&(ModelService.getModelInfo(vm.account,vm.model).then(function(data){vm.settings=data;var index=-1;data.federate||(panelCard.left[issuesCardIndex].menu.find(function(item,i){"showSubModels"===item.value&&(index=i)}),index!==-1&&panelCard.left[issuesCardIndex].menu.splice(index,1)),EventService.send(EventService.EVENT.MODEL_SETTINGS_READY,data)}),RevisionsService.listAll(vm.account,vm.model).then(function(revisions){EventService.send(EventService.EVENT.REVISIONS_LIST_READY,revisions)}),TreeService.init(vm.account,vm.model,vm.branch,vm.revision).then(function(data){vm.treeMap=TreeService.getMap(data.nodes),EventService.send(EventService.EVENT.TREE_READY,data)}))}),$timeout(function(){EventService.send(EventService.EVENT.VIEWER.LOAD_MODEL,{account:vm.account,model:vm.model,branch:vm.branch,revision:vm.revision}),EventService.send(EventService.EVENT.PANEL_CONTENT_SETUP,panelCard)}),$scope.$watch("vm.issueId",function(){vm.issueId&&$timeout(function(){EventService.send(EventService.EVENT.SELECT_ISSUE,vm.issueId)})}),$scope.$watch(EventService.currentEvent,function(event){var element;vm.event=event,event.type===EventService.EVENT.TOGGLE_ISSUE_AREA?event.value.on?(issueArea=angular.element("<issue-area></issue-area>"),event.value.hasOwnProperty("issue")?(vm.issueAreaIssue=event.value.issue,issueArea=angular.element("<issue-area data='vm.issueAreaIssue'></issue-area>")):event.value.hasOwnProperty("type")&&(vm.issueAreaType=event.value.type,issueArea=angular.element("<issue-area type='vm.issueAreaType'></issue-area>")),modelUI.prepend(issueArea),$compile(issueArea)($scope)):angular.isDefined(issueArea)&&issueArea.remove():event.type===EventService.EVENT.TOGGLE_ISSUE_AREA_DRAWING?vm.pointerEvents=event.value.on?"none":"inherit":event.type===EventService.EVENT.MEASURE_MODE&&(event.value?(element=angular.element("<tdr-measure id='tdrMeasure' account='vm.account' model='vm.model' settings='vm.settings' ></tdr-measure>"),angular.element($element[0].querySelector("#model")).append(element),$compile(element)($scope)):(element=angular.element($element[0].querySelector("#tdrMeasure")),element.remove()))}),vm.setSelectedObjects=function(selectedObjects){vm.selectedObjects=selectedObjects},vm.setInitialSelectedObjects=function(data){vm.initialSelectedObjects=data.selectedObjects,$timeout(function(){vm.initialSelectedObjects=null})},vm.sendEvent=function(type,value){EventService.send(type,value)}}angular.module("3drepo").directive("model",model),ModelCtrl.$inject=["$timeout","$scope","$element","$compile","EventService","ModelService","TreeService","RevisionsService"]}(),function(){"use strict";function ModelService($http,$q,StateManager,serverConfig,HttpService,Auth){function doPost(data,urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.POST_API,state.account+"/"+state.model+"/"+urlEnd),config={withCredentials:!0};return $http.post(url,data,config).then(function(response){deferred.resolve(response)}),deferred.promise}function doGet(urlEnd){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,state.account+"/"+state.model+"/"+urlEnd);return $http.get(url).then(function(response){deferred.resolve(response)},function(){deferred.resolve([])}),deferred.promise}var state=StateManager.state,getModelInfo=function(account,model){var deferred=$q.defer(),url=serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+".json");return $http.get(url).then(function(res){var data=res.data;data.account=account,data.model=model,data.settings=data.properties,deferred.resolve(data,function(){deferred.resolve()})}),deferred.promise},createModelSummary=function(data){return data.name=state.model,doPost(data,"info.json")},getModelSummary=function(){return doGet("info.json")};return{createmodelSummary:createModelSummary,getModelSummary:getModelSummary,getModelInfo:getModelInfo}}angular.module("3drepo").factory("ModelService",ModelService),ModelService.$inject=["$http","$q","StateManager","serverConfig","HttpService","Auth"]}(),function(){"use strict";function MultiSelectCtrl(EventService,$scope){var cmdKey=91,ctrlKey=17,escKey=27,isMac=navigator.platform.indexOf("Mac")!==-1,multiMode=!1,pinDropMode=!1;$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.PIN_DROP_MODE&&(pinDropMode=event.value)});var isMacKey=function(keysDown){return isMac&&keysDown.currentValue.indexOf(cmdKey)!==-1},isNotMacKey=function(keysDown){return!isMac&&keysDown.currentValue.indexOf(ctrlKey)!==-1},isKeyDown=function(keysDown){return isMacKey(keysDown)||isNotMacKey(keysDown)},isKeyDownNotCtrl=function(keysDown){return isMac&&keysDown.currentValue.indexOf(cmdKey)===-1||!isMac&&keysDown.currentValue.indexOf(ctrlKey)===-1};this.$onChanges=function(changes){pinDropMode||changes.hasOwnProperty("keysDown")&&(isKeyDown(changes.keysDown)?(multiMode=!0,this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:!0})):multiMode===!0&&isKeyDownNotCtrl(changes.keysDown)?(multiMode=!1,this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:!1})):changes.keysDown.currentValue.indexOf(escKey)!==-1&&this.sendEvent({type:EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,value:[]}))},this.$onDestroy=function(){this.sendEvent({type:EventService.EVENT.MULTI_SELECT_MODE,value:!1})}}angular.module("3drepo").component("multiSelect",{controller:MultiSelectCtrl,bindings:{account:"<",model:"<",treeMap:"<",keysDown:"<",sendEvent:"&",event:"<",setSelectedObjects:"&",initialSelectedObjects:"<"}}),MultiSelectCtrl.$inject=["EventService","$scope"]}(),function(){"use strict";function viewer(EventService){return{restrict:"E",scope:{manager:"=",account:"@",model:"@",branch:"@",revision:"@",name:"@",autoInit:"@",vrMode:"@",at:"@",up:"@",view:"@",eventService:"="},link:function(scope,element){element.on("$destroy",function(){scope.v.viewer.destroy()})},controller:ViewerCtrl,controllerAs:"v",bindToController:!0}}function ViewerCtrl($scope,$q,$http,$element,serverConfig,EventService,$location){function errCallback(errorType,errorValue){v.eventService.sendError(errorType,errorValue)}function eventCallback(type,value){v.eventService.send(type,value)}function fetchModelProperties(account,model,branch,revision){branch||(branch=revision?"":"master"),revision||(revision="head"),$http.get(serverConfig.apiUrl(serverConfig.GET_API,account+"/"+model+"/revision/"+branch+"/"+revision+"/modelProperties.json")).success(function(json,status){json.properties&&v.viewer.applyModelProperties(account,model,json.properties)})}var v=this;v.initialised=$q.defer(),v.loaded=$q.defer(),v.branch=v.branch?v.branch:"master",v.revision=v.revision?v.revision:"head",v.pointerEvents="auto",angular.isDefined(v.eventService)||(v.EventService=EventService),$scope.reload=function(){v.viewer.loadModel(v.account,v.model,v.branch,v.revision)},$scope.init=function(){v.viewer=new Viewer(v.name,$element[0],v.manager,eventCallback,errCallback);var options={},startLatLon=v.at&&v.at.split(","),view=v.view&&v.view.split(",");view&&view.forEach(function(val,i){view[i]=parseFloat(val)}),options.view=view;var up=v.up&&v.up.split(",");up&&up.forEach(function(val,i){up[i]=parseFloat(val)}),options.up=up;var showAll=!0;startLatLon&&(showAll=!1,options.lat=parseFloat(startLatLon[0]),options.lon=parseFloat(startLatLon[1]),options.y=parseFloat(startLatLon[2])),v.mapTile=new MapTile(v.viewer,eventCallback,options),v.viewer.init({showAll:showAll,plugins:{mapTile:v.mapTile}}),v.oculus=new Oculus(v.viewer),v.gamepad=new Gamepad(v.viewer),v.gamepad.init(),v.measure=new MeasureTool(v.viewer),v.collision=new Collision(v.viewer),v.loaded.promise.then(function(){v.oculus=new Oculus(v.viewer),v.gamepad=new Gamepad(v.viewer),v.gamepad.init(),v.collision=new Collision(v.viewer)})},$scope.enterVR=function(){v.loaded.promise.then(function(){v.oculus.switchVR()})},$scope.$watch(v.branch,function(blah){console.log(JSON.stringify(blah))}),$scope.$watch(v.eventService.currentEvent,function(event){angular.isDefined(event)&&angular.isDefined(event.type)&&(event.type===EventService.EVENT.VIEWER.START_LOADING?(v.initialised.resolve(),fetchModelProperties(v.account,v.model,v.branch,v.revision)):event.type===EventService.EVENT.VIEWER.LOADED?v.loaded.resolve():event.type===EventService.EVENT.VIEWER.LOAD_MODEL?(v.account=event.value.account,v.model=event.value.model,v.branch=event.value.branch,v.revision=event.value.revision,v.viewer.loadModel(event.value.account,event.value.model,event.value.branch,event.value.revision)):v.initialised.promise.then(function(){event.type===EventService.EVENT.VIEWER.GO_HOME?v.viewer.showAll():event.type===EventService.EVENT.VIEWER.SWITCH_FULLSCREEN?v.viewer.switchFullScreen(null):event.type===EventService.EVENT.VIEWER.ENTER_VR?v.oculus.switchVR():event.type===EventService.EVENT.VIEWER.REGISTER_VIEWPOINT_CALLBACK?v.viewer.onViewpointChanged(event.value.callback):event.type===EventService.EVENT.VIEWER.REGISTER_MOUSE_MOVE_CALLBACK?v.viewer.onMouseMove(event.value.callback):event.type===EventService.EVENT.MODEL_SETTINGS_READY?event.value.account===v.account&&event.value.model===v.model&&(v.viewer.updateSettings(event.value.settings),v.mapTile&&v.mapTile.updateSettings(event.value.settings)):event.type===EventService.EVENT.VIEWER.ADD_PIN?v.viewer.addPin(event.value.account,event.value.model,event.value.id,event.value.pickedPos,event.value.pickedNorm,event.value.colours,event.value.viewpoint):event.type===EventService.EVENT.VIEWER.REMOVE_PIN?v.viewer.removePin(event.value.id):event.type===EventService.EVENT.VIEWER.CHANGE_PIN_COLOUR?v.viewer.changePinColours(event.value.id,event.value.colours):event.type===EventService.EVENT.VIEWER.CLICK_PIN?v.viewer.clickPin(event.value.id):event.type===EventService.EVENT.VIEWER.SET_PIN_VISIBILITY?v.viewer.setPinVisibility(event.value.id,event.value.visibility):event.type===EventService.EVENT.VIEWER.CLEAR_CLIPPING_PLANES?v.viewer.clearClippingPlanes():event.type===EventService.EVENT.VIEWER.UPDATE_CLIPPING_PLANES?v.viewer.updateClippingPlanes(event.value.clippingPlanes,event.value.fromClipPanel,event.value.account,event.value.model):event.type===EventService.EVENT.VIEWER.GET_CURRENT_OBJECT_STATUS?v.viewer.getObjectsStatus(event.value.account,event.value.model,event.value.promise):event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED?v.viewer.highlightObjects(event.value.account,event.value.model,event.value.id?[event.value.id]:event.value.ids,event.value.zoom,event.value.colour):event.type===EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS?v.viewer.highlightObjects(event.value.account,event.value.model,event.value.id?[event.value.id]:event.value.ids,event.value.zoom,event.value.colour,event.value.multi):event.type===EventService.EVENT.VIEWER.HIGHLIGHT_AND_UNHIGHLIGHT_OBJECTS?v.viewer.highlightAndUnhighlightObjects(event.value.account,event.value.model,event.value.highlight_ids,event.value.unhighlight_ids,event.value.zoom,event.value.colour):event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?v.viewer.highlightObjects():event.type===EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY?v.viewer.switchObjectVisibility(event.value.account,event.value.model,event.value.ids,event.value.visible):event.type===EventService.EVENT.VIEWER.SET_CAMERA?v.viewer.setCamera(event.value.position,event.value.view_dir,event.value.up,event.value.look_at,!angular.isDefined(event.value.animate)||event.value.animate,event.value.rollerCoasterMode,event.value.account,event.value.model):event.type===EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT?angular.isDefined(event.value.promise)&&v.manager.getCurrentViewer().getCurrentViewpointInfo(event.value.account,event.value.model,event.value.promise):event.type===EventService.EVENT.VIEWER.GET_SCREENSHOT?angular.isDefined(event.value.promise)&&v.manager.getCurrentViewer().getScreenshot(event.value.promise):event.type===EventService.EVENT.VIEWER.SET_NAV_MODE?v.manager.getCurrentViewer().setNavMode(event.value.mode):event.type===EventService.EVENT.MEASURE_MODE?v.measure.measureMode(event.value):event.type===EventService.EVENT.VIEWER.UPDATE_URL?$location.path("/"+v.account+"/"+v.model).search({at:event.value.at,view:event.value.view,up:event.value.up}):event.type===EventService.EVENT.MULTI_SELECT_MODE?v.viewer.setMultiSelectMode(event.value):event.type===EventService.EVENT.PIN_DROP_MODE&&v.viewer.setPinDropMode(event.value)}))}),$scope.init(),angular.isDefined(v.vrMode)&&$scope.enterVR()}angular.module("3drepo").directive("viewer",viewer),viewer.$inject=["EventService"],ViewerCtrl.$inject=["$scope","$q","$http","$element","serverConfig","EventService","$location"]}(),function(){"use strict";function viewerManager(){return{restrict:"E",controller:ViewerManagerCtrl,scope:!0,templateUrl:"viewermanager.html",controllerAs:"vm",bindToController:!0}}function ViewerManagerService($timeout,nextEventService){var currentEvent={},currentError={},sendInternal=function(type,value){currentEvent={type:type,value:value}},send=function(type,value){nextEventService.send(type,value)},sendErrorInternal=function(type,value){currentError={type:type,value:value}},sendError=function(type,value){nextEventService.sendError(type,value)};return{currentEvent:function(){return currentEvent},currentError:function(){return currentError},send:send,sendInternal:sendInternal,sendError:sendError,sendErrorInternal:sendErrorInternal}}function ViewerManagerCtrl($scope,$q,$element,$timeout,EventService){var vm=this;vm.manager=new ViewerManager($element[0]),vm.vmservice=ViewerManagerService($timeout,EventService),vm.viewers={},$scope.manager=vm.manager,vm.viewerInit=$q.defer(),vm.viewerLoaded=$q.defer(),$scope.$watch(EventService.currentEvent,function(event){angular.isDefined(event.type)&&(event.type===EventService.EVENT.CREATE_VIEWER?vm.viewers.hasOwnProperty(event.value.name)||(vm.viewers[event.value.name]=event.value):event.type===EventService.EVENT.CLOSE_VIEWER?vm.viewers.hasOwnProperty(event.value.name)&&delete vm.viewers[event.value.name]:event.type===EventService.EVENT.VIEWER.READY?window.viewer=vm.manager.getCurrentViewer():vm.vmservice.sendInternal(event.type,event.value))})}angular.module("3drepo").directive("viewermanager",viewerManager),ViewerManagerCtrl.$inject=["$scope","$q","$element","$timeout","EventService"]}();var Oculus={};!function(){"use strict";Oculus=function(viewer){var self=this;this.leftTex=null,this.rightTex=null,this.lastW=null,this.lastH=null,this.vrHMD=null,this.vrSensor=null,this.IPD=.01,this.enabled=!1,this.oculus=null,this.viewer=viewer,this.addInstructions=function(){var instruction=document.createElement("div");instruction.setAttribute("id","instructionCircle"),self.viewer.element.appendChild(instruction),instruction.addEventListener("click",function(){self.viewer.switchFullScreen(self.vrHMD),instruction.style.display="none"});var instructionImage=document.createElement("img");instructionImage.setAttribute("id","instructionImage"),instructionImage.setAttribute("src","public/plugins/walkthroughVr/instruction_trans.gif"),instruction.appendChild(instructionImage);var instructionOK=document.createElement("div");instructionOK.setAttribute("id","instructionOK"),instructionOK.textContent="OK",instruction.appendChild(instructionOK)},this.switchVR=function(){var scene=self.viewer.scene;if(this.enabled)this.oculus.parentNode.removeChild(this.oculus),this.leftTex=null,this.rightTex=null,this.lastW=null,this.lastH=null,this.IPD=.0064,this.enabled=!1,this.oculus=null,this.enabled=!1,self.viewer.runtime.enterFrame=function(){},self.viewer.runtime.exitFrame=function(){},self.viewer.getViewArea().skipSceneRender=null,self.viewer.nav.setAttribute("type",self.oldNavMode),self.oldNavMode=null,self.viewer.getScene()._x3domNode._nameSpace.doc.canvas.isMulti=!1,self.viewer.createBackground(),self.viewer.setNavMode(this.oldNavMode),self.viewer.addLogo();else{self.addInstructions();var eyeGroup=document.createElement("group");eyeGroup.setAttribute("def","oculus"),eyeGroup.setAttribute("render","false"),this.oculus=eyeGroup;var leftEye=document.createElement("group");leftEye.setAttribute("def","left"),eyeGroup.appendChild(leftEye);var leftShape=document.createElement("shape");leftShape.setAttribute("isPickable","false"),leftEye.appendChild(leftShape);var leftApp=document.createElement("appearance");leftShape.appendChild(leftApp),self.leftTex=document.createElement("renderedtexture"),self.leftTex.setAttribute("id","rtLeft"),self.leftTex.setAttribute("stereoMode","LEFT_EYE"),self.leftTex.setAttribute("update","ALWAYS"),self.leftTex.setAttribute("oculusRiftVersion","2"),self.leftTex.setAttribute("repeatS","false"),self.leftTex.setAttribute("repeatT","false"),self.leftTex.setAttribute("interpupillaryDistance",this.IPD),leftApp.appendChild(self.leftTex);var leftVP=document.createElement("viewpoint");null!==self.viewer.getCurrentViewpoint()&&leftVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),leftVP.setAttribute("containerfield","viewpoint"),leftVP.textContent=" ",self.leftTex.appendChild(leftVP);var leftBground=document.createElement("background");leftBground.setAttribute("use","viewer_bground"),leftBground.setAttribute("containerfield","background"),leftBground.textContent=" ",self.leftTex.appendChild(leftBground);var leftScene=document.createElement("group");leftScene.setAttribute("USE","root"),leftScene.setAttribute("containerfield","scene"),self.leftTex.appendChild(leftScene);var leftPlane=document.createElement("plane");leftPlane.setAttribute("solid","false"),leftShape.appendChild(leftPlane);var rightEye=document.createElement("group");rightEye.setAttribute("def","right"),eyeGroup.appendChild(rightEye);var rightShape=document.createElement("shape");rightShape.setAttribute("isPickable","false"),rightEye.appendChild(rightShape);var rightApp=document.createElement("appearance");rightShape.appendChild(rightApp),self.rightTex=document.createElement("renderedtexture"),self.rightTex.setAttribute("id","rtRight"),self.rightTex.setAttribute("stereoMode","RIGHT_EYE"),self.rightTex.setAttribute("update","ALWAYS"),self.rightTex.setAttribute("oculusRiftVersion","2"),self.rightTex.setAttribute("repeatS","false"),self.rightTex.setAttribute("repeatT","false"),self.rightTex.setAttribute("interpupillaryDistance",this.IPD),rightApp.appendChild(self.rightTex);var rightPlane=document.createElement("plane");rightPlane.setAttribute("solid","false"),rightShape.appendChild(rightPlane);var rightVP=document.createElement("viewpoint");null!==self.viewer.getCurrentViewpoint()&&rightVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),rightVP.setAttribute("containerfield","viewpoint"),rightVP.textContent=" ",self.rightTex.appendChild(rightVP);var rightBground=document.createElement("background");rightBground.setAttribute("use","viewer_bground"),rightBground.setAttribute("containerfield","background"),rightBground.textContent=" ",self.rightTex.appendChild(rightBground);var rightScene=document.createElement("group");rightScene.setAttribute("use","root"),rightScene.setAttribute("containerfield","scene"),rightScene.textContent=" ",self.rightTex.appendChild(rightScene),scene.appendChild(eyeGroup),leftShape._x3domNode._graph.needCulling=!1,rightShape._x3domNode._graph.needCulling=!1,eyeGroup._x3domNode._graph.needCulling=!1,self.startVR(),self.oldNavMode=self.viewer.nav.getAttribute("type"),self.viewer.nav.setAttribute("type","EXAMINE"),self.viewer.getScene()._x3domNode._nameSpace.doc.canvas.isMulti=!0,this.oldNavMode=self.viewer.currentNavMode,self.viewer.setNavMode(self.viewer.NAV_MODES.FLY),this.enabled=!0,self.viewer.removeLogo()}},this.startVR=function(){self.lastW=self.viewer.runtime.getWidth(),self.lastH=self.viewer.runtime.getHeight(),self.viewpoint=self.viewer.viewpoint,self.viewer.getViewArea().skipSceneRender=!0,self.gyroOrientation=null,window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(event){self.gyroOrientation=event},!1),self.viewer.runtime.enterFrame=function(){if(self.gyroOrientation)self.viewer.gyroscope(self.gyroOrientation.alpha,self.gyroOrientation.beta,self.gyroOrientation.gamma),self.gyroOrientation=null;else if(self.vrSensor){var state=self.vrSensor.getState(),h=state.orientation;if(h){var vp=self.viewer.getCurrentViewpoint()._x3domNode,flyMat=vp.getViewMatrix().inverse(),q=new x3dom.fields.Quaternion(h.x,h.y,h.z,h.w);flyMat.setRotate(q),vp.setView(flyMat.inverse())}}},self.viewer.runtime.exitFrame=function(){var w=self.viewer.runtime.getWidth()*(window.devicePixelRatio?window.devicePixelRatio:1),h=self.viewer.runtime.getHeight()*(window.devicePixelRatio?window.devicePixelRatio:1),rotate=h>w;if(rotate?(self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,h/2,w,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.leftTex._x3domNode._webgl.fbo.tex),self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,0,w,h/2),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rightTex._x3domNode._webgl.fbo.tex)):(self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.leftTex._x3domNode._webgl.fbo.tex),self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(w/2,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rightTex._x3domNode._webgl.fbo.tex)),w!==self.lastW||h!==self.lastH){var half=0;half=Math.round(w/2),self.leftTex.setAttribute("dimensions",half+" "+h+" 4"),self.rightTex.setAttribute("dimensions",half+" "+h+" 4"),self.lastW=w,self.lastH=h}self.viewer.runtime.triggerRedraw()}},this.changeIPD=function(newIPD){self.leftTex.setAttribute("interpupillaryDistance",newIPD),self.rightTex.setAttribute("interpupillaryDistance",newIPD)},this.peturbIPD=function(peturbation){var oldDistance=parseFloat(self.leftTex.getAttribute("interpupillaryDistance"));this.changeIPD(oldDistance+peturbation)},this.exitFullscreen=function(){},this.createFullscreenExit=function(){document.addEventListener("webkitfullscreenchange",self.exitFullscreen,!1),document.addEventListener("mozfullscreenchange",self.exitFullscreen,!1),document.addEventListener("fullscreenchange",self.exitFullscreen,!1),document.addEventListener("MSFullscreenChange",self.exitFullscreen,!1)},this.init=function(vrdevs){var i;for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof HMDVRDevice){self.vrHMD=vrdevs[i];break}if(self.vrHMD){for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof PositionSensorVRDevice&&vrdevs[i].hardwareUnitId===self.vrHMD.hardwareUnitId){self.vrSensor=vrdevs[i];break}return self.vrHMD&&self.vrSensor?void 0:void console.error("No HMD found")}},navigator.getVRDevices&&navigator.getVRDevices().then(this.init),this.createFullscreenExit()}}(),function(){"use strict";function panelCardAdd(){return{restrict:"EA",templateUrl:"panelCardAdd.html",scope:{showAdd:"="},controller:PanelCardAddCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardAddCtrl(){var vm=this;vm.add=function(){vm.showAdd=!0}}angular.module("3drepo").directive("panelCardAdd",panelCardAdd),PanelCardAddCtrl.$inject=[]}(),function(){"use strict";function panelCard(){return{restrict:"E",templateUrl:"panelCard.html",scope:{account:"=",model:"=",branch:"=",revision:"=",position:"=",modelSettings:"=",treeMap:"=",contentData:"=",onHeightRequest:"&",onShowFilter:"&",keysDown:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:PanelCardCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardCtrl($scope,$element,$compile,EventService){function createCardContent(){var i,length,contentItem,element,content=angular.element($element[0].querySelector("#content"));if(element="<"+vm.contentData.type+" show='vm.contentData.show' on-content-height-request='vm.onContentHeightRequest(height)' on-show-item='vm.showItem()' hide-item='vm.hideSelectedItem' show-edit='vm.showEdit' account='vm.account' model='vm.model' branch='vm.branch' model-settings='vm.modelSettings' revision='vm.revision' keys-down='vm.keysDown' tree-map='vm.treeMap' selected-objects='vm.selectedObjects' set-initial-selected-objects='vm.setInitialSelectedObjects({selectedObjects: selectedObjects})'",vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)switch(vm.contentData.options[i].type){case"filter":element+="filter-text='vm.filterText' ";break;case"visible":element+="visible='vm.visible' ";break;case"menu":element+="selected-menu-option='vm.selectedMenuOption' "}vm.contentData.hasOwnProperty("add")&&vm.contentData.add&&(element+="show-add='vm.showAdd' can-add='vm.canAdd'"),element+="></"+vm.contentData.type+">",contentItem=angular.element(element),content.append(contentItem),$compile(contentItem)($scope)}function createToolbarOptions(){var i,length,option,optionElement;if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1){switch(option=null,optionElement="<panel-card-option-"+vm.contentData.options[i].type,optionElement+=" id='panal_card_option_"+vm.contentData.options[i].type+"'",optionElement+="menu"===vm.contentData.options[i].type?" ng-if='!vm.hideMenuButton'":" ng-if='vm.contentData.options["+i+"].visible'",vm.contentData.options[i].color="",optionElement+=" style='color:{{vm.contentData.options["+i+"].color}}'",vm.contentData.options[i].type){case"filter":optionElement+=" show-filter='vm.showFilter'";break;case"visible":optionElement+=" visible='vm.visible'";break;case"menu":optionElement+="menu='vm.contentData.menu' selected-menu-option='vm.selectedMenuOption'";break;case"close":optionElement+="show='vm.contentData.show'"}optionElement+="><panel-card-option-"+vm.contentData.options[i].type+">",option=angular.element(optionElement),null!==option&&(options.prepend(option),$compile(option)($scope))}}function showToolbarOptions(addOptions,show){var i,length;for(i=0,length=vm.contentData.options.length;i<length;i+=1)addOptions.indexOf(vm.contentData.options[i].type)!==-1&&(vm.contentData.options[i].visible=show)}function createFilter(){var i,length,filter,filterContainer=angular.element($element[0].querySelector("#filterContainer"));if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)if("filter"===vm.contentData.options[i].type){filter=angular.element("<panel-card-filter show-filter='vm.showFilter' filter-text='vm.filterText'></panel-card-filter>"),filterContainer.append(filter),$compile(filter)($scope);break}}function toggleAdd(on){on?("issues"===vm.contentData.type&&showToolbarOptions(["filter","menu"],!1),EventService.send(EventService.EVENT.PANEL_CARD_ADD_MODE,{on:!0,type:vm.contentData.type})):("issues"===vm.contentData.type&&showToolbarOptions(["filter","menu"],!0),EventService.send(EventService.EVENT.PANEL_CARD_ADD_MODE,{on:!1}))}function highlightOption(option){var i,length;if(vm.contentData.hasOwnProperty("options"))for(i=0,length=vm.contentData.options.length;i<length;i+=1)if(vm.contentData.options[i].type===option){currentHighlightedOptionIndex!==-1&&currentHighlightedOptionIndex!==i?(vm.contentData.options[currentHighlightedOptionIndex].color="",
currentHighlightedOptionIndex=i,vm.contentData.options[i].color="#FF9800"):(currentHighlightedOptionIndex=i,vm.contentData.options[i].color="#FF9800");break}}var contentHeight,vm=this,options=angular.element($element[0].querySelector("#options")),currentHighlightedOptionIndex=-1;vm.showHelp=!1,vm.showFilter=!1,vm.visibleStatus=!1,vm.showClearFilterButton=!1,vm.showAdd=!1,vm.hideMenuButton=!1,$scope.$watch("vm.contentData.type",function(newValue){angular.isDefined(newValue)&&(createCardContent(),createToolbarOptions(),createFilter(),vm.statusIcon=vm.contentData.icon)}),$scope.$watch("vm.contentData.show",function(newValue){angular.isDefined(newValue)&&!newValue&&vm.hideItem()}),$scope.$watch("vm.showAdd",function(newValue){angular.isDefined(newValue)&&toggleAdd(newValue)}),$scope.$watch("vm.showEdit",function(newValue){angular.isDefined(newValue)&&EventService.send(EventService.EVENT.PANEL_CARD_EDIT_MODE,{on:newValue,type:vm.contentData.type})}),$scope.$watch(EventService.currentEvent,function(event){event.type===EventService.EVENT.TOGGLE_ISSUE_ADD&&"issues"===vm.contentData.type?(toggleAdd(event.value.on),event.value.on||(vm.contentData.options[currentHighlightedOptionIndex].color="",currentHighlightedOptionIndex=-1)):event.type===EventService.EVENT.PANEL_CARD_ADD_MODE||event.type===EventService.EVENT.PANEL_CARD_EDIT_MODE?event.value.on&&event.value.type!==vm.contentData.type&&vm.hideItem():event.type===EventService.EVENT.SET_ISSUE_AREA_MODE&&"issues"===vm.contentData.type&&highlightOption(event.value)}),$scope.$watch("vm.hideSelectedItem",function(newValue){angular.isDefined(newValue)&&newValue&&(vm.statusIcon=vm.contentData.icon)}),vm.onContentHeightRequest=function(height){contentHeight=height,vm.onHeightRequest({contentItem:vm.contentData,height:contentHeight})},vm.showItem=function(){vm.statusIcon="arrow_back",vm.hideMenuButton=!0,vm.hideSelectedItem=!1},vm.hideItem=function(){vm.statusIcon=vm.contentData.icon,vm.hideMenuButton=!1,vm.hideSelectedItem=!0}}angular.module("3drepo").directive("panelCard",panelCard),PanelCardCtrl.$inject=["$scope","$element","$compile","EventService"]}(),function(){"use strict";function panelCardFilter(){return{restrict:"E",templateUrl:"panelCardFilter.html",scope:{showFilter:"=",filterText:"="},controller:PanelCardFilterCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardFilterCtrl($scope,$timeout,$element){var filterInput,vm=this,filterTimeout=null;vm.clearFilter=function(){vm.filterInputText="",filterInput.focus(),vm.showFilter=!1},$scope.$watch("vm.filterInputText",function(newValue){angular.isDefined(newValue)&&(null!==filterTimeout&&$timeout.cancel(filterTimeout),filterTimeout=$timeout(function(){vm.filterText=vm.filterInputText,vm.showClearFilterButton=""!==vm.filterInputText},500))}),$scope.$watch("vm.showFilter",function(newValue){angular.isDefined(newValue)&&newValue&&$timeout(function(){filterInput=angular.element($element[0].querySelector("#panelCardFilterInput")),filterInput.focus()})})}angular.module("3drepo").directive("panelCardFilter",panelCardFilter),PanelCardFilterCtrl.$inject=["$scope","$timeout","$element"]}(),function(){"use strict";function panelCardOptionAdd(){return{restrict:"E",templateUrl:"panelCardOptionAdd.html",scope:{showAdd:"="},controller:PanelCardOptionAddCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionAddCtrl(){var vm=this;vm.showAddElement=function(event){event.stopPropagation(),vm.showAdd=!0}}angular.module("3drepo").directive("panelCardOptionAdd",panelCardOptionAdd)}(),function(){"use strict";function panelCardOptionClose(){return{restrict:"E",templateUrl:"panelCardOptionClose.html",scope:{show:"="},controller:panelCardOptionCloseCtrl,controllerAs:"vm",bindToController:!0}}function panelCardOptionCloseCtrl(){var vm=this;vm.hide=function(){vm.show=!1}}angular.module("3drepo").directive("panelCardOptionClose",panelCardOptionClose)}(),function(){"use strict";function panelCardOptionErase(){return{restrict:"E",templateUrl:"panelCardOptionErase.html",scope:{},controller:PanelCardOptionEraseCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionEraseCtrl(EventService){var vm=this;vm.setupEraseMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"erase")}}angular.module("3drepo").directive("panelCardOptionErase",panelCardOptionErase),PanelCardOptionEraseCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionFilter(){return{restrict:"E",templateUrl:"panelCardOptionFilter.html",scope:{showFilter:"="},controller:PanelCardOptionFilterCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionFilterCtrl(){var vm=this;vm.toggleFilter=function(event){event.stopPropagation(),vm.showFilter=!vm.showFilter}}angular.module("3drepo").directive("panelCardOptionFilter",panelCardOptionFilter)}(),function(){"use strict";function panelCardOptionMenu(){return{restrict:"E",templateUrl:"panelCardOptionMenu.html",scope:{menu:"=",selectedMenuOption:"="},controller:PanelCardOptionMenuCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionMenuCtrl($timeout){var currentSortIndex,vm=this;vm.menuItemSelected=function(index){vm.menu[index].hasOwnProperty("toggle")?vm.menu[index].toggle?(vm.menu[index].selected=!vm.menu[index].selected,vm.selectedMenuOption=vm.menu[index]):(index!==currentSortIndex&&(currentSortIndex=index),vm.menu[currentSortIndex].firstSelected=!vm.menu[currentSortIndex].firstSelected,vm.menu[currentSortIndex].secondSelected=!vm.menu[currentSortIndex].secondSelected,vm.selectedMenuOption=vm.menu[currentSortIndex]):vm.selectedMenuOption=vm.menu[index],$timeout(function(){vm.selectedMenuOption=void 0})}}angular.module("3drepo").directive("panelCardOptionMenu",panelCardOptionMenu),PanelCardOptionMenuCtrl.$inject=["$timeout"]}(),function(){"use strict";function panelCardOptionPin(){return{restrict:"E",templateUrl:"panelCardOptionPin.html",scope:{},controller:PanelCardOptionPinCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionPinCtrl(EventService){var vm=this;vm.setupPinMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"pin")}}angular.module("3drepo").directive("panelCardOptionPin",panelCardOptionPin),PanelCardOptionPinCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionPrint(){return{restrict:"E",templateUrl:"panelCardOptionPrint.html",scope:{account:"=",model:"="},controller:PanelCardOptionPrintCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionPrintCtrl($window,serverConfig){var vm=this;vm.doPrint=function(event){event.stopPropagation(),$window.open(serverConfig.apiUrl(serverConfig.GET_API,vm.account+"/"+vm.model+"/issues.html"),"_blank")}}angular.module("3drepo").directive("panelCardOptionPrint",panelCardOptionPrint),PanelCardOptionPrintCtrl.$inject=["$window","serverConfig"]}(),function(){"use strict";function panelCardOptionScribble(){return{restrict:"E",templateUrl:"panelCardOptionScribble.html",scope:{},controller:PanelCardOptionScribbleCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionScribbleCtrl(EventService){var vm=this;vm.setupScribbleMode=function(){EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,"scribble")}}angular.module("3drepo").directive("panelCardOptionScribble",panelCardOptionScribble),PanelCardOptionScribbleCtrl.$inject=["EventService"]}(),function(){"use strict";function panelCardOptionVisible(){return{restrict:"E",templateUrl:"panelCardOptionVisible.html",scope:{visible:"="},controller:PanelCardOptionVisibleCtrl,controllerAs:"vm",bindToController:!0}}function PanelCardOptionVisibleCtrl(){var vm=this;vm.icon="visibility",vm.toggleVisible=function(event){event.stopPropagation(),vm.visible=!vm.visible,vm.icon=vm.visible?"visibility":"visibility_off"}}angular.module("3drepo").directive("panelCardOptionVisible",panelCardOptionVisible)}(),function(){"use strict";function panel(){return{restrict:"E",templateUrl:"panel.html",scope:{account:"=",model:"=",branch:"=",revision:"=",position:"@",keysDown:"=",modelSettings:"=",treeMap:"=",selectedObjects:"=",setInitialSelectedObjects:"&"},controller:PanelCtrl,controllerAs:"vm",bindToController:!0}}function PanelCtrl($scope,$window,$timeout,EventService){function hideLastItemGap(){var i,lastFound=!1;for(i=vm.contentItems.length-1;i>=0;i-=1)vm.contentItems[i].show&&(lastFound?vm.contentItems[i].showGap=!0:(vm.contentItems[i].showGap=!1,lastFound=!0))}function calculateContentHeights(){var tempContentItemsShown=angular.copy(contentItemsShown);assignHeights(maxHeightAvailable,tempContentItemsShown,null),$timeout(function(){$scope.$apply()})}function assignHeights(heightAvailable,contentItems,previousContentItems){var i,contentItem,availableHeight=heightAvailable,maxContentItemHeight=(availableHeight-panelToolbarHeight*contentItems.length-itemGap*(contentItems.length-1))/contentItems.length,prev=null;if(Array.isArray(previousContentItems)&&previousContentItems.length===contentItems.length)for(i=contentItems.length-1;i>=0;i-=1)contentItem=getContentItemShownFromType(contentItems[i].type),maxContentItemHeight<contentItem.minHeight?contentItem.requestedHeight<contentItem.minHeight?contentItem.height=contentItem.requestedHeight:(contentItem.height=contentItem.minHeight,availableHeight-=contentItem.height+panelToolbarHeight+itemGap,contentItems.splice(i,1),assignHeights(availableHeight,contentItems,prev)):contentItem.height=maxContentItemHeight;else{for(prev=angular.copy(contentItems),i=contentItems.length-1;i>=0;i-=1)(contentItems[i].requestedHeight<maxContentItemHeight||contentItems[i].fixedHeight)&&(contentItem=getContentItemShownFromType(contentItems[i].type),contentItem.height=contentItems[i].requestedHeight,availableHeight-=contentItem.height+panelToolbarHeight+itemGap,contentItems.splice(i,1));contentItems.length>0&&assignHeights(availableHeight,contentItems,prev)}}function getContentItemShownFromType(type){var i,length;for(i=0,length=contentItemsShown.length;i<length;i+=1)if(contentItemsShown[i].type===type)return contentItemsShown[i]}function setupShownCards(){var i,length;for(contentItemsShown=[],i=0,length=vm.contentItems.length;i<length;i+=1)vm.contentItems[i].show&&contentItemsShown.push(vm.contentItems[i])}function setupContentItemsWatch(){var i,length;$scope.$watch("vm.contentItems",function(newValue,oldValue){for(i=0,length=newValue.length;i<length;i+=1)if(newValue[i].show!==oldValue[i].show){setupShownCards(),hideLastItemGap();break}},!0)}var vm=this,panelTopBottomGap=55,maxHeightAvailable=$window.innerHeight-panelTopBottomGap,itemGap=20,panelToolbarHeight=40,contentItemsShown=[];vm.contentItems=[],vm.showPanel=!0,vm.window=$window,vm.activate=!0,console.log("watch event setup!"),$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.PANEL_CONTENT_SETUP)vm.contentItems=event.value[vm.position],setupShownCards(),hideLastItemGap(),setupContentItemsWatch();else if(event.type===EventService.EVENT.TOGGLE_ELEMENTS)vm.showPanel=!vm.showPanel;else if(event.type===EventService.EVENT.PANEL_CONTENT_ADD_MENU_ITEMS){var item=vm.contentItems.find(function(item){return item.type===event.value.type});item&&(item.menu=item.menu.concat(event.value.menu))}}),angular.element(document).bind("mousedown",function(event){"CANVAS"===event.target.tagName&&(vm.activate=!1,$scope.$apply())}),angular.element(document).bind("mouseup",function(){vm.activate=!0,$scope.$apply()}),vm.buttonClick=function(contentType){var i,j,length,contentItem;for(i=0,length=vm.contentItems.length;i<length;i+=1)if(contentType===vm.contentItems[i].type){if(contentItem=vm.contentItems[i],vm.contentItems[i].show=!vm.contentItems[i].show,vm.contentItems[i].show)contentItemsShown.push(vm.contentItems[i]),calculateContentHeights();else{for(j=contentItemsShown.length-1;j>=0;j-=1)contentItemsShown[j].type===contentType&&contentItemsShown.splice(j,1);vm.contentItems[i].showGap=!1,calculateContentHeights()}break}hideLastItemGap()},vm.heightRequest=function(contentItem,height){contentItem.requestedHeight=height,contentItem.height=height,calculateContentHeights()},angular.element($window).bind("resize",function(){maxHeightAvailable=$window.innerHeight-panelTopBottomGap,calculateContentHeights()})}angular.module("3drepo").directive("panel",panel),PanelCtrl.$inject=["$scope","$window","$timeout","EventService"]}(),function(){"use strict";function passwordChange(){return{restrict:"E",scope:{username:"=",token:"="},templateUrl:"passwordChange.html",controller:PasswordChangeCtrl,controllerAs:"vm",bindToController:!0}}function PasswordChangeCtrl($scope,UtilsService,EventService){function doPasswordChange(){angular.isDefined(vm.username)&&angular.isDefined(vm.token)&&(angular.isDefined(vm.newPassword)&&""!==vm.newPassword?(vm.messageColor=messageColour,vm.message="Please wait...",vm.showProgress=!0,promise=UtilsService.doPut({token:vm.token,newPassword:vm.newPassword},vm.username+"/password"),promise.then(function(response){vm.showProgress=!1,400===response.status?(vm.messageColor=messageErrorColour,vm.message="Error changing password"):(vm.passwordChanged=!0,vm.messageColor=messageColour,vm.message="Your password has been reset. Please go to the login page.")})):(vm.messageColor=messageErrorColour,vm.message="A new password must be entered"))}var promise,vm=this,enterKey=13,messageColour="rgba(0, 0, 0, 0.7)",messageErrorColour="#F44336";vm.passwordChanged=!1,vm.showProgress=!1,$scope.$watch("vm.newPassword",function(){vm.message=""}),vm.passwordChange=function(event){angular.isDefined(event)?event.which===enterKey&&doPasswordChange():doPasswordChange()},vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("passwordChange",passwordChange),PasswordChangeCtrl.$inject=["$scope","UtilsService","EventService"]}(),function(){"use strict";function passwordForgot(){return{restrict:"E",scope:{},templateUrl:"passwordForgot.html",controller:PasswordForgotCtrl,controllerAs:"vm",bindToController:!0}}function PasswordForgotCtrl($scope,UtilsService){var promise,vm=this,messageColour="rgba(0, 0, 0, 0.7)",messageErrorColour="#F44336";vm.showProgress=!1,$scope.$watchGroup(["vm.username","vm.email"],function(){vm.message=""}),vm.requestPasswordChange=function(event){var enterKey=13,requestChange=!1;requestChange=!angular.isDefined(event)||event.which===enterKey,requestChange&&(vm.username&&vm.email?(vm.messageColor=messageColour,vm.message="Please wait...",vm.showProgress=!0,promise=UtilsService.doPost({email:vm.email},vm.username+"/forgot-password"),promise.then(function(response){vm.showProgress=!1,200===response.status?(vm.verified=!0,vm.messageColor=messageColour,vm.message="Thank you. You will receive an email shortly with a link to change your password"):(vm.messageColor=messageErrorColour,vm.message=response.data.message)})):(vm.messageColor=messageErrorColour,vm.message="Missing username or email"))}}angular.module("3drepo").directive("passwordForgot",passwordForgot),PasswordForgotCtrl.$inject=["$scope","UtilsService"]}(),function(){"use strict";function payment(){return{restrict:"E",scope:{},templateUrl:"payment.html",controller:paymentCtrl,controllerAs:"vm",bindToController:!0}}function paymentCtrl(EventService){var vm=this;vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("payment",payment),paymentCtrl.$inject=["EventService"]}(),function(){"use strict";function privacy(){return{restrict:"E",scope:{},templateUrl:"privacy.html",controller:PrivacyCtrl,controllerAs:"vm",bindToController:!0}}function PrivacyCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("privacy",privacy),PrivacyCtrl.$inject=["EventService"]}(),function(){"use strict";function registerRequest(){return{restrict:"E",scope:{state:"="},templateUrl:"registerRequest.html",controller:RegisterRequestCtrl,controllerAs:"vm",bindToController:!0}}function RegisterRequestCtrl($scope,$window){var vm=this;$scope.$watch("vm.state",function(newValue){}),vm.goToLoginPage=function(){$window.location.href="/"}}angular.module("3drepo").directive("registerRequest",registerRequest),RegisterRequestCtrl.$inject=["$scope","$window"]}(),function(){"use strict";function registerVerify(){return{restrict:"E",scope:{},templateUrl:"registerVerify.html",controller:RegisterVerifyCtrl,controllerAs:"vm",bindToController:!0}}function RegisterVerifyCtrl(EventService,UtilsService,StateManager){var promise,vm=this,username=StateManager.query.username,token=StateManager.query.token;vm.verified=!1,vm.showPaymentWait=!1,vm.databaseName=username,vm.verifyErrorMessage="Verifying. Please wait...",promise=UtilsService.doPost({token:token},username+"/verify"),promise.then(function(response){200===response.status?(vm.verified=!0,vm.verifySuccessMessage="Congratulations. You have successfully signed up for 3D Repo. You may now login to you account."):"ALREADY_VERIFIED"===response.data.code?(vm.verified=!0,vm.verifySuccessMessage="You have already verified your account successfully. You may now login to your account."):vm.verifyErrorMessage="Error with verification"}),vm.goToLoginPage=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("registerVerify",registerVerify),RegisterVerifyCtrl.$inject=["EventService","UtilsService","StateManager"]}(),function(){"use strict";function revisions(){return{restrict:"E",templateUrl:"revisions.html",scope:{account:"=",model:"=",revision:"="},controller:revisionsCtrl,controllerAs:"vm",bindToController:!0}}function revisionsCtrl($location,$scope,RevisionsService,UtilsService,$filter,EventService){var vm=this;$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.REVISIONS_LIST_READY){if(vm.revisions=event.value,!vm.revisions||!vm.revisions[0])return;vm.revision?vm.revisions&&vm.revisions.forEach(function(rev,i){rev.tag===vm.revision?(vm.revName=vm.revision,vm.revisions[i].current=!0):rev._id===vm.revision&&(vm.revName=$filter("revisionDate")(rev.timestamp),vm.revisions[i].current=!0)}):(vm.revName=vm.revisions[0].tag||$filter("revisionDate")(vm.revisions[0].timestamp),vm.revisions[0].current=!0)}}),vm.openDialog=function(event){vm.revisions||RevisionsService.listAll(vm.account,vm.model).then(function(revisions){vm.revisions=revisions}),UtilsService.showDialog("revisionsDialog.html",$scope,event,!0)},vm.goToRevision=function(revId){UtilsService.closeDialog(),$location.path("/"+vm.account+"/"+vm.model+"/"+revId,"_self")},vm.closeDialog=function(){UtilsService.closeDialog()}}angular.module("3drepo").directive("revisions",revisions),revisionsCtrl.$inject=["$location","$scope","RevisionsService","UtilsService","$filter","EventService"]}(),function(){"use strict";function RevisionsService(UtilsService){function listAll(account,model){return UtilsService.doGet(account+"/"+model+"/revisions.json").then(function(response){return 200===response.status?response.data:response.data})}function isTagFormatInValid(tag){return tag&&!tag.match(server_config.tagRegExp)}return{listAll:listAll,isTagFormatInValid:isTagFormatInValid}}angular.module("3drepo").factory("RevisionsService",RevisionsService),RevisionsService.$inject=["UtilsService"]}(),function(){"use strict";function rightPanel(){return{restrict:"E",scope:{},templateUrl:"rightPanel.html",controller:RightPanelCtrl,controllerAs:"vm",bindToController:!0}}function RightPanelCtrl($scope,$timeout,EventService){var vm=this,addIssueMode=null,highlightBackground="#FF9800";vm.measureMode=!1,vm.metaData=!0,vm.showPanel=!0,vm.issueButtons={scribble:{label:"Scribble",icon:"border_color",background:""},erase:{label:"Erase",faIcon:"fa fa-eraser",background:""},pin:{label:"Pin",icon:"pin_drop",background:""}},vm.measureBackground="",vm.metaBackground=highlightBackground,$timeout(function(){EventService.send(EventService.EVENT.AUTO_META_DATA,vm.metaData)}),$scope.$watch(EventService.currentEvent,function(event){event.type!==EventService.EVENT.TOGGLE_ISSUE_AREA||event.value.on?event.type===EventService.EVENT.SET_ISSUE_AREA_MODE?addIssueMode!==event.value&&(vm.issueButtons[addIssueMode].background="",addIssueMode=event.value,vm.issueButtons[addIssueMode].background=highlightBackground):event.type===EventService.EVENT.TOGGLE_ELEMENTS&&(vm.showPanel=!vm.showPanel):null!==addIssueMode&&(vm.issueButtons[addIssueMode].background="",addIssueMode=null)}),vm.issueButtonClick=function(buttonType){measureMode&&(measureMode=!1,vm.measureBackground="",EventService.send(EventService.EVENT.MEASURE_MODE,measureMode)),null===addIssueMode?(addIssueMode=buttonType,vm.issueButtons[buttonType].background=highlightBackground,EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!0,type:buttonType})):addIssueMode===buttonType?(addIssueMode=null,vm.issueButtons[buttonType].background="",EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!1})):(vm.issueButtons[addIssueMode].background="",addIssueMode=buttonType,vm.issueButtons[addIssueMode].background=highlightBackground,EventService.send(EventService.EVENT.SET_ISSUE_AREA_MODE,buttonType))},vm.toggleMeasure=function(){null!==addIssueMode&&EventService.send(EventService.EVENT.TOGGLE_ISSUE_ADD,{on:!1}),vm.measureMode=!vm.measureMode,vm.measureBackground=vm.measureMode?highlightBackground:"",EventService.send(EventService.EVENT.MEASURE_MODE,vm.measureMode)},vm.toggleAutoMetaData=function(){vm.metaData=!vm.metaData,vm.metaBackground=vm.metaData?highlightBackground:"",EventService.send(EventService.EVENT.AUTO_META_DATA,vm.metaData)}}angular.module("3drepo").directive("rightPanel",rightPanel),RightPanelCtrl.$inject=["$scope","$timeout","EventService"]}(),function(){"use strict";function signUp(){return{restrict:"E",scope:{},templateUrl:"signUp.html",controller:SignUpCtrl,controllerAs:"vm",bindToController:!0}}function SignUpCtrl($location){}angular.module("3drepo").directive("signUp",signUp),SignUpCtrl.$inject=["$location"]}(),function(){"use strict";function signUpForm(){return{restrict:"EA",templateUrl:"signUpForm.html",scope:{buttonLabel:"@"},controller:SignUpFormCtrl,controllerAs:"vm",bindToController:!0}}function SignUpFormCtrl($scope,$mdDialog,$location,serverConfig,UtilsService,$timeout){function removeDialog(){$scope.closeDialog()}function doRegister(){var data,doRegister=!0,allowedFormat=new RegExp(server_config.usernameRegExp);console.log(vm.newUser),angular.isDefined(vm.newUser.username)&&angular.isDefined(vm.newUser.email)&&angular.isDefined(vm.newUser.password)&&angular.isDefined(vm.newUser.firstName)&&angular.isDefined(vm.newUser.lastName)&&angular.isDefined(vm.newUser.company)&&angular.isDefined(vm.newUser.jobTitle)&&("Other"!==vm.newUser.jobTitle||angular.isDefined(vm.newUser.otherJobTitle))&&angular.isDefined(vm.newUser.country)?allowedFormat.test(vm.newUser.username)?(vm.showLegalText&&(doRegister=vm.newUser.tcAgreed),doRegister?(data={email:vm.newUser.email,password:vm.newUser.password,firstName:vm.newUser.firstName,lastName:vm.newUser.lastName,company:vm.newUser.company,jobTitle:"Other"===vm.newUser.jobTitle?vm.newUser.otherJobTitle:vm.newUser.jobTitle,countryCode:vm.newUser.country,phoneNo:vm.newUser.phoneNo},vm.useReCapthca&&(data.captcha=vm.reCaptchaResponse),vm.registering=!0,promise=UtilsService.doPost(data,vm.newUser.username),promise.then(function(response){200===response.status?vm.showPage("registerRequest"):vm.registerErrorMessage=UtilsService.getErrorMessage(response.data),vm.registering=!1,vm.useReCapthca&&grecaptcha.reset()})):vm.registerErrorMessage="You must agree to the terms and conditions"):vm.registerErrorMessage="Username not allowed":vm.registerErrorMessage="Please fill all fields"}function getLegalTextFromLegalItem(legalItem){return"<a target='_blank' href='/"+legalItem.page+"'>"+legalItem.title+"</a>"}var promise,legalItem,vm=this,enterKey=13,agreeToText="",haveReadText="";vm.newUser={username:"",email:"",password:"",tcAgreed:!1},vm.version=serverConfig.apiVersion,vm.logo="/public/images/3drepo-logo-white.png",vm.captchaKey=serverConfig.captcha_client_key,vm.tcAgreed=!1,vm.useReCapthca=!1,vm.registering=!1,vm.showLegalText=!1,vm.jobTitles=["Director","Architect","Architectural assistant","BIM Manager","Structural engineer","Civil engineer","MEP engineer","Mechanical engineer","Facilities Manager","Other"],vm.countries=serverConfig.countries.concat();var gbIndex;if(vm.countries.find(function(country,i){"GB"===country.code&&(gbIndex=i)}),vm.countries.unshift(vm.countries.splice(gbIndex,1)[0]),serverConfig.hasOwnProperty("auth")&&serverConfig.auth.hasOwnProperty("captcha")&&serverConfig.auth.captcha&&(vm.useReCapthca=!0),angular.isDefined(serverConfig.legal)){vm.showLegalText=!0,vm.legalText="";for(legalItem in serverConfig.legal)serverConfig.legal.hasOwnProperty(legalItem)&&("agreeTo"===serverConfig.legal[legalItem].type?""===agreeToText?agreeToText="I agree to the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem]):agreeToText+=" and the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem]):"haveRead"===serverConfig.legal[legalItem].type&&(""===haveReadText?haveReadText="I have read the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem])+" policy":haveReadText+=" and the "+getLegalTextFromLegalItem(serverConfig.legal[legalItem])+" policy"));vm.legalText=agreeToText,""!==vm.legalText&&(vm.legalText+=" and "),vm.legalText+=haveReadText,""!==vm.legalText&&(vm.legalText+=".")}$scope.$watch("vm.newUser",function(newValue){angular.isDefined(newValue)&&(vm.registerErrorMessage="")},!0),vm.register=function(event){angular.isDefined(event)?event.which===enterKey&&doRegister():doRegister()},vm.showTC=function(){vm.legalTitle="Terms and Conditions",vm.legalText="termsAndConditions",$mdDialog.show({templateUrl:"legalDialog.html",parent:angular.element(document.body),targetEvent:event,clickOutsideToClose:!0,fullscreen:!0,scope:$scope,preserveScope:!0,onRemoving:removeDialog})},vm.showPage=function(page){$location.path("/"+page,"_self")},$scope.closeDialog=function(){$mdDialog.cancel()}}angular.module("3drepo").directive("signUpForm",signUpForm),SignUpFormCtrl.$inject=["$scope","$mdDialog","$location","serverConfig","UtilsService","$timeout"]}(),function(){"use strict";function terms(){return{restrict:"E",scope:{},templateUrl:"terms.html",controller:TermsCtrl,controllerAs:"vm",bindToController:!0}}function TermsCtrl(EventService){var vm=this;vm.home=function(){EventService.send(EventService.EVENT.GO_HOME)}}angular.module("3drepo").directive("terms",terms),TermsCtrl.$inject=["EventService"]}(),function(){"use strict";function tree(){return{restrict:"EA",templateUrl:"tree.html",scope:{account:"=",model:"=",branch:"=",revision:"=",filterText:"=",onContentHeightRequest:"&"},controller:TreeCtrl,controllerAs:"vm",bindToController:!0}}function TreeCtrl($scope,$timeout,TreeService,EventService){function setContentHeight(nodesToShow){var i,length,height=0,nodeMinHeight=42,maxStringLength=35,maxStringLengthForLevel=0,lineHeight=18,levelOffset=2;for(i=0,length=nodesToShow.length;i<length;i+=1)maxStringLengthForLevel=maxStringLength-nodesToShow[i].level*levelOffset,height+=nodesToShow[i].hasOwnProperty("name")?nodeMinHeight+lineHeight*Math.floor(nodesToShow[i].name.length/maxStringLengthForLevel):nodeMinHeight+lineHeight;vm.onContentHeightRequest({height:height})}function initNodesToShow(){vm.nodesToShow=[vm.allNodes[0]],vm.nodesToShow[0].level=0,vm.nodesToShow[0].expanded=!1,vm.nodesToShow[0].selected=!1,vm.nodesToShow[0].hasChildren=vm.nodesToShow[0].children,vm.nodesToShow[0].hasOwnProperty("toggleState")||(vm.nodesToShow[0].toggleState="visible")}function expandFirstNode(){expandToSelection(vm.nodesToShow[0].children[0].path.split("__"),0,!0),vm.nodesToShow[0].children[0].selected=!1}function traverseNode(node,callback){callback(node),node.children&&node.children.forEach(function(child){traverseNode(child,callback)})}function getAccountModelKey(account,model){return account+"@"+model}function traverseNodeAndPushId(node,nodes){traverseNode(node,function(node){if(!node.children&&"mesh"===(node.type||"mesh")){var key=getAccountModelKey(node.account,node.model);nodes[key]||(nodes[key]=[]),nodes[key].push(node._id)}})}function getVisibleArray(account,model){var key=getAccountModelKey(account,model);return vm.visible[key]||(vm.visible[key]=new Set),vm.visible[key]}function getInvisibleArray(account,model){var key=getAccountModelKey(account,model);return vm.invisible[key]||(vm.invisible[key]=new Set),vm.invisible[key]}function matchPath(ids,path){for(var i=0;i<ids.length;i++)if(path.indexOf(ids[i])!==-1)return!0;return!1}function expandToSelection(path,level,noHighlight){var i,j,length,childrenLength,selectedId=path[path.length-1],selectedIndex=0,selectionFound=!1;vm.showNodes=!1;var condLoop=!0;for(i=0,length=vm.nodesToShow.length;i<length&&condLoop;i+=1)if(vm.nodesToShow[i]._id===path[level]){lastParentWithName=vm.nodesToShow[i],vm.nodesToShow[i].expanded=!0,vm.nodesToShow[i].selected=!1,childrenLength=vm.nodesToShow[i].children.length,level===path.length-2&&(selectedIndex=i);var childWithNameCount=0;for(j=0;j<childrenLength;j+=1){if(vm.nodesToShow[i].children[j].expanded=!1,vm.nodesToShow[i].children[j]._id===selectedId?(vm.nodesToShow[i].children[j].hasOwnProperty("name")?(vm.nodesToShow[i].children[j].selected=!0,lastParentWithName=null,selectedIndex=i+j+1):noHighlight||(vm.selectNode(vm.nodesToShow[i]),selectedId=vm.nodesToShow[i]._id,selectedIndex=i,lastParentWithName=null,selectedId=vm.nodesToShow[i]._id),condLoop=!1):vm.nodesToShow[i].children[j].selected=!1,vm.nodesToShow[i].children[j].hasOwnProperty("toggleState")||vm.setToggleState(vm.nodesToShow[i].children[j],"visible"),vm.nodesToShow[i].children[j].hasChildren=!1,"children"in vm.nodesToShow[i].children[j]&&vm.nodesToShow[i].children[j].children.length>0)for(var k=0,jLength=vm.nodesToShow[i].children[j].children.length;k<jLength;k++)if(vm.nodesToShow[i].children[j].children[k].hasOwnProperty("name")){vm.nodesToShow[i].children[j].hasChildren=!0;break}vm.nodesToShow[i].children[j].selected&&(selectionFound=!0,currentSelectedNode=vm.nodesToShow[i].children[j]),vm.nodesToShow[i].children[j].level=level+1,vm.nodesToShow[i].hasChildren&&vm.nodesToShow[i].children[j].hasOwnProperty("name")&&(vm.nodesToShow.splice(i+childWithNameCount+1,0,vm.nodesToShow[i].children[j]),childWithNameCount++)}}level<path.length-2?expandToSelection(path,level+1):level===path.length-2&&(setContentHeight(vm.nodesToShow),vm.showNodes=!0,$timeout(function(){$scope.$broadcast("$md-resize"),vm.topIndex=selectedIndex}),$timeout(function(){var el=document.getElementById(selectedId);el&&el.scrollIntoView()}))}function setupInfiniteScroll(){vm.infiniteItemsTree={numLoaded_:0,toLoad_:0,getItemAtIndex:function(index){return index>this.numLoaded_?(this.fetchMoreItems_(index),null):index<vm.nodesToShow.length?vm.nodesToShow[index]:null},getLength:function(){return this.numLoaded_+5},fetchMoreItems_:function(index){this.toLoad_<index&&(this.toLoad_+=500,$timeout(angular.noop,300).then(angular.bind(this,function(){this.numLoaded_=this.toLoad_})))}}}function setupInfiniteItemsFilter(){vm.infiniteItemsFilter={numLoaded_:0,toLoad_:0,getItemAtIndex:function(index){return index>this.numLoaded_?(this.fetchMoreItems_(index),null):index<vm.nodes.length?vm.nodes[index]:null},getLength:function(){return this.numLoaded_+5},fetchMoreItems_:function(index){this.toLoad_<index&&(this.toLoad_+=20,$timeout(angular.noop,300).then(angular.bind(this,function(){this.numLoaded_=this.toLoad_})))}}}function updateClickedHidden(node){"invisible"===node.toggleState?clickedHidden[node._id]=node:delete clickedHidden[node._id]}function updateClickedShown(node){"visible"===node.toggleState?clickedShown[node._id]=node:delete clickedShown[node._id]}var vm=this,promise=null,i=0,length=0,currentSelectedNode=null,highlightSelectedViewerObject=!0,clickedHidden={},clickedShown={},multiSelectMode=!1;
vm.nodes=[],vm.showNodes=!0,vm.showTree=!0,vm.showFilterList=!1,vm.currentFilterItemSelected=null,vm.viewerSelectedObject=null,vm.showProgress=!0,vm.progressInfo="Loading full tree structure",vm.onContentHeightRequest({height:70}),vm.visible={},vm.invisible={},vm.setToggleState=function(node,visibility){var visible=getVisibleArray(node.account,node.model),invisible=getInvisibleArray(node.account,node.model);node.children||"mesh"!==(node.type||"mesh")||("invisible"===visibility?(invisible.has(node._id)?invisible.delete(node._id):invisible.add(node._id),visible.delete(node._id)):(visible.has(node._id)?visible.delete(node._id):visible.add(node._id),invisible.delete(node._id))),node.toggleState=visibility},vm.expand=function(event,_id){var i,length,j,jLength,numChildren=0,index=-1,endOfSplice=!1,numChildrenToForceRedraw=3;for(event.stopPropagation(),i=0,length=vm.nodesToShow.length;i<length;i+=1)if(vm.nodesToShow[i]._id===_id){index=i;break}var _ids=[_id];if(index!==-1&&vm.nodesToShow[index].hasChildren){if(vm.nodesToShow[index].expanded){if(vm.nodesToShow[index].hasSubProjTree){var subModelNode=vm.subTreesById[vm.nodesToShow[index].children[0]._id];_ids.push(subModelNode._id)}for(;!endOfSplice;)if(angular.isDefined(vm.nodesToShow[index+1])&&matchPath(_ids,vm.nodesToShow[index+1].path)){if(vm.nodesToShow[index+1].hasSubProjTree){var subModelNode=vm.subTreesById[vm.nodesToShow[index+1].children[0]._id];_ids.push(subModelNode._id)}vm.nodesToShow.splice(index+1,1)}else endOfSplice=!0}else{for(numChildren=vm.nodesToShow[index].children.length,numChildren>=numChildrenToForceRedraw&&(vm.showNodes=!1),i=0;i<numChildren;i+=1){if(0===vm.nodesToShow[index].level&&vm.nodesToShow[index].children[i].hasOwnProperty("children")&&vm.nodesToShow[index].children[i].children[0].hasOwnProperty("status")?vm.nodesToShow[index].children[i].status=vm.nodesToShow[index].children[i].children[0].status:(vm.nodesToShow[index].children[i].expanded=!1,vm.nodesToShow[index].children[i].hasOwnProperty("toggleState")||vm.setToggleState(vm.nodesToShow[index].children[i],"visible")),vm.nodesToShow[index].children[i].level=vm.nodesToShow[index].level+1,vm.nodesToShow[index].children[i].hasChildren=!1,"children"in vm.nodesToShow[index].children[i]&&vm.nodesToShow[index].children[i].children.length>0)for(j=0,jLength=vm.nodesToShow[index].children[i].children.length;j<jLength;j++)if(vm.nodesToShow[index].children[i].children[j].hasOwnProperty("name")){vm.nodesToShow[index].children[i].hasChildren=!0;break}vm.nodesToShow[index].children[i].hasOwnProperty("name")&&vm.nodesToShow.splice(index+i+1,0,vm.nodesToShow[index].children[i])}vm.showNodes||$timeout(function(){vm.showNodes=!0,$scope.$broadcast("$md-resize")})}vm.nodesToShow[index].expanded=!vm.nodesToShow[index].expanded}setContentHeight(vm.nodesToShow)};var lastParentWithName=null;$scope.$watch(EventService.currentEvent,function(event){if(event.type===EventService.EVENT.VIEWER.OBJECT_SELECTED){if("tree"!==event.value.source&&highlightSelectedViewerObject){var objectID=event.value.id;if(objectID){var path;if(vm.idToPath[objectID])path=vm.idToPath[objectID].split("__");else{path=vm.subProjIdToPath[objectID].split("__");var parentPath=vm.subTreesById[path[0]].parent.path.split("__");path=parentPath.concat(path)}initNodesToShow(),lastParentWithName=null,expandToSelection(path,0),lastParentWithName&&vm.selectNode(lastParentWithName)}}}else event.type===EventService.EVENT.VIEWER.BACKGROUND_SELECTED?null!==currentSelectedNode&&(currentSelectedNode.selected=!1,currentSelectedNode=null,null!==vm.currentFilterItemSelected&&(vm.currentFilterItemSelected.class="",vm.currentFilterItemSelected=null)):event.type===EventService.EVENT.PANEL_CARD_ADD_MODE||event.type===EventService.EVENT.PANEL_CARD_EDIT_MODE?highlightSelectedViewerObject=!event.value.on:event.type===EventService.EVENT.MULTI_SELECT_MODE?multiSelectMode=event.value:event.type===EventService.EVENT.TREE_READY&&(vm.allNodes=[],vm.allNodes.push(event.value.nodes),vm.nodes=vm.allNodes,vm.showTree=!0,vm.showProgress=!1,vm.subTreesById=event.value.subTreesById,vm.idToPath=event.value.idToPath,vm.subProjIdToPath=event.value.subProjIdToPath,initNodesToShow(),expandFirstNode(),setupInfiniteScroll(),setContentHeight(vm.nodesToShow))}),vm.toggleTreeNode=function(node){var i,j,nodesLength,path,hasParent,lastParent=node,nodeToggleState="visible",numInvisible=0,numParentInvisible=0;vm.toggledNode=node,vm.setToggleState(node,"visible"===node.toggleState?"invisible":"visible"),nodeToggleState=node.toggleState,updateClickedHidden(node),updateClickedShown(node);for(var stack=[node],head=null;stack.length>0;){var head=stack.pop();if(node!==head&&vm.setToggleState(head,nodeToggleState),head.children)for(var i=0;i<head.children.length;i++)stack.push(head.children[i])}for(path=node.path.split("__"),path.splice(path.length-1,1),i=0,nodesLength=vm.nodesToShow.length;i<nodesLength;i+=1)vm.nodesToShow[i]._id===path[path.length-1]?(lastParent=vm.nodesToShow[i],hasParent=!0):lastParent.parent&&(lastParent=lastParent.parent,path=lastParent.path.split("__").concat(path),hasParent=!0);if(hasParent)for(i=path.length-1;i>=0;i-=1)for(j=0,nodesLength=vm.nodesToShow.length;j<nodesLength;j+=1)vm.nodesToShow[j]._id===path[i]&&(numInvisible=vm.nodesToShow[j].children.reduce(function(total,child){return"invisible"===child.toggleState?total+1:total},0),numParentInvisible=vm.nodesToShow[j].children.reduce(function(total,child){return"parentOfInvisible"===child.toggleState?total+1:total},0),numInvisible===vm.nodesToShow[j].children.length?vm.nodesToShow[j].toggleState="invisible":numParentInvisible+numInvisible>0?vm.nodesToShow[j].toggleState="parentOfInvisible":vm.setToggleState(vm.nodesToShow[j],"visible"));toggleNode(node)};var toggleNode=function(node){var childNodes=[];traverseNodeAndPushId(node,childNodes);for(var key in childNodes){var vals=key.split("@"),account=vals[0],model=vals[1];EventService.send(EventService.EVENT.VIEWER.SWITCH_OBJECT_VISIBILITY,{source:"tree",account:account,model:model,name:node.name,visible:"invisible"!=node.toggleState,ids:childNodes[key]})}};$scope.$watch("vm.filterText",function(newValue){var noFilterItemsFoundHeight=82;angular.isDefined(newValue)&&(""===newValue.toString()?(vm.showTree=!0,vm.showFilterList=!1,vm.showProgress=!1,vm.nodes=vm.nodesToShow,setContentHeight(vm.nodes)):(vm.showTree=!1,vm.showFilterList=!1,vm.showProgress=!0,vm.progressInfo="Filtering tree for objects",promise=TreeService.search(newValue),promise.then(function(json){if(vm.showFilterList=!0,vm.showProgress=!1,vm.nodes=json.data,vm.nodes.length>0){for(vm.filterItemsFound=!0,i=0,length=vm.nodes.length;i<length;i+=1)vm.nodes[i].index=i,vm.nodes[i].toggleState="visible",vm.nodes[i].class="unselectedFilterItem",vm.nodes[i].level=0;setupInfiniteItemsFilter(),setContentHeight(vm.nodes)}else vm.filterItemsFound=!1,vm.onContentHeightRequest({height:noFilterItemsFoundHeight})})))}),vm.selectNode=function(node){if(null!==currentSelectedNode?(currentSelectedNode.selected=!1,currentSelectedNode._id===node._id?currentSelectedNode=null:(node.selected=!0,currentSelectedNode=node)):(node.selected=!0,currentSelectedNode=node),null===currentSelectedNode)EventService.send(EventService.EVENT.VIEWER.BACKGROUND_SELECTED);else{var map=[];traverseNodeAndPushId(node,map),EventService.send(EventService.EVENT.VIEWER.OBJECT_SELECTED,{source:"tree",account:node.account,model:node.model,id:node._id,name:node.name});for(var key in map){var vals=key.split("@"),account=vals[0],model=vals[1];EventService.send(EventService.EVENT.VIEWER.HIGHLIGHT_OBJECTS,{source:"tree",account:account,model:model,ids:map[key],multi:!0})}}},vm.filterItemSelected=function(item){null===vm.currentFilterItemSelected?(vm.nodes[item.index].class="treeNodeSelected",vm.currentFilterItemSelected=item):item.index===vm.currentFilterItemSelected.index?(vm.nodes[item.index].class="",vm.currentFilterItemSelected=null):(vm.nodes[vm.currentFilterItemSelected.index].class="",vm.nodes[item.index].class="treeNodeSelected",vm.currentFilterItemSelected=item);var selectedNode=vm.nodes[item.index];vm.selectNode(selectedNode)},vm.toggleFilterNode=function(item){vm.setToggleState(item,"visible"===item.toggleState?"invisible":"visible"),item.path=item._id,toggleNode(item)}}angular.module("3drepo").directive("tree",tree),TreeCtrl.$inject=["$scope","$timeout","TreeService","EventService"]}(),function(){"use strict";function TreeService($http,$q,EventService,serverConfig){var ts=this,genIdToObjRef=function(tree,map){return map||(map={}),map[tree._id]=tree,tree.children&&tree.children.forEach(function(child){genIdToObjRef(child,map)}),map},init=function(account,model,branch,revision){console.log("tree init"),ts.account=account,ts.model=model,ts.branch=branch?branch:"master",revision?ts.baseURL="/"+account+"/"+model+"/revision/"+revision+"/":ts.baseURL="/"+account+"/"+model+"/revision/master/head/";var deferred=$q.defer(),url=ts.baseURL+"fulltree.json";return $http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(json){var mainTree=JSON.parse(json.data.mainTree),subTrees=json.data.subTrees,subTreesById={};if(subTrees){var idToObjRef=genIdToObjRef(mainTree.nodes);mainTree.subProjIdToPath={},subTrees.forEach(function(tree){if(idToObjRef[tree._id]){if(tree.buf){var obj=JSON.parse(tree.buf),subTree=obj.nodes;subTree.parent=idToObjRef[tree._id],angular.extend(mainTree.subProjIdToPath,obj.idToPath),idToObjRef[tree._id].children=[subTree],idToObjRef[tree._id].hasSubProjTree=!0,subTreesById[subTree._id]=subTree}tree.status&&(idToObjRef[tree._id].status=tree.status)}}),mainTree.subTreesById=subTreesById}deferred.resolve(mainTree)}),deferred.promise},search=function(searchString){var deferred=$q.defer(),url=ts.baseURL+"searchtree.json?searchString="+searchString;return $http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(json){deferred.resolve(json)}),deferred.promise},getMap=function(treeItem){function genMap(treeItem){treeItem&&(treeItem.children&&treeItem.children.forEach(genMap),uidToSharedId[treeItem._id]=treeItem.shared_id,sharedIdToUid[treeItem.shared_id]=treeItem._id,treeItem.meta&&(oIdToMetaId[treeItem._id]=treeItem.meta))}var uidToSharedId={},sharedIdToUid={},oIdToMetaId={};return genMap(treeItem),{uidToSharedId:uidToSharedId,sharedIdToUid:sharedIdToUid,oIdToMetaId:oIdToMetaId}};return{init:init,search:search,getMap:getMap}}angular.module("3drepo").factory("TreeService",TreeService),TreeService.$inject=["$http","$q","EventService","serverConfig"]}();var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"Other",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"Unknown"},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;if(this.versionSearchString=data[i].subString,dataString.indexOf(data[i].subString)!==-1)return data[i].identity}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index!==-1){var rv=dataString.indexOf("rv:");return"Trident"===this.versionSearchString&&rv!==-1?parseFloat(dataString.substring(rv+3)):parseFloat(dataString.substring(index+this.versionSearchString.length+1))}},dataBrowser:[{string:navigator.userAgent,subString:"Edge",identity:"MS Edge"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer"},{string:navigator.userAgent,subString:"Trident",identity:"Explorer"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"Opera",identity:"Opera"},{string:navigator.userAgent,subString:"OPR",identity:"Opera"},{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"Safari",identity:"Safari"}]};BrowserDetect.init(),function(){"use strict";function colourPicker(){return{restrict:"EA",templateUrl:"colourPicker.html",scope:{title:"@",colour:"=",onColourChange:"&",offset:"@"},controller:ColourPickerCtrl,controllerAs:"vm",bindToController:!0}}function ColourPickerCtrl($scope){var vm=this;vm.red=200,vm.green=150,vm.blue=100,$scope.$watchGroup(["vm.red","vm.green","vm.blue"],function(newValues){vm.onColourChange({colour:newValues})}),$scope.$watch("vm.colour",function(newValue){Array.isArray(newValue)&&(vm.red=newValue[0],vm.green=newValue[1],vm.blue=newValue[2])}),vm.open=function($mdOpenMenu,event){$mdOpenMenu(event)}}angular.module("3drepo").directive("tdrColourPicker",colourPicker),ColourPickerCtrl.$inject=["$scope"]}(),function(){"use strict";function tdrProgress(){return{restrict:"EA",templateUrl:"tdrProgress.html",scope:{info:"="},controller:TdrProgressCtrl,controllerAs:"vm",bindToController:!0}}function TdrProgressCtrl($scope){}angular.module("3drepo").directive("tdrProgress",tdrProgress),TdrProgressCtrl.$inject=["$scope"]}(),function(){"use strict";angular.module("3drepo").directive("tdrFocus",function($timeout){return{scope:{trigger:"@tdrFocus"},link:function(scope,element){scope.$watch("trigger",function(value){"true"===value.toString()&&$timeout(function(){element[0].focus()})})}}})}(),function(){"use strict";angular.module("3drepo").filter("formatBytes",function(){return function(input,referenceValue){var factor,units,bytesInMB=1048576,bytesInGB=1073741824;return angular.isDefined(referenceValue)?referenceValue>1073741824?(factor=bytesInGB,units=" GB"):(factor=bytesInMB,units=" MB"):input>1073741824?(factor=bytesInGB,units=" GB"):(factor=bytesInMB,units=" MB"),(Math.round(input/factor*100)/100).toString()+units}}).filter("invoiceDate",function(){return function(input){var invoiceDate,date=new Date(input);return invoiceDate=(date.getDate()<10?"0":"")+date.getDate()+"-"+(date.getMonth()+1<10?"0":"")+(date.getMonth()+1)+"-"+date.getFullYear()+" "+(date.getHours()<10?"0":"")+date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes()}}).filter("prettyDate",function(){return function(input,showSeconds){var modelDate,date=new Date(input);return modelDate=(date.getDate()<10?"0":"")+date.getDate()+"-"+(date.getMonth()+1<10?"0":"")+(date.getMonth()+1)+"-"+date.getFullYear(),angular.isDefined(showSeconds)&&showSeconds&&(modelDate+=", "+(date.getHours()<10?"0":"")+date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes()),modelDate}}).filter("prettyGMTDate",function(){return function(input){var date=new Date(input);return date.toISOString().substr(0,10)}}).filter("revisionDate",function(){return function(input){return moment(input).format("DD/MM/YYYY HH:mm")}})}(),function(){"use strict";function UtilsService($http,$q,$mdDialog,serverConfig){var obj={};return obj.snake_case=function(name,separator){var SNAKE_CASE_REGEXP=/[A-Z]/g;return separator=separator||"_",name.replace(SNAKE_CASE_REGEXP,function(letter,pos){return(pos?separator:"")+letter.toLowerCase()})},obj.capitalizeFirstLetter=function(string){return string.toString().charAt(0).toUpperCase()+string.slice(1)},obj.doGet=function(url){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.GET_API,url);return $http.get(urlUse).then(function(response){deferred.resolve(response)},function(response){deferred.resolve(response)}),deferred.promise},obj.doPost=function(data,url,headers){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.POST_API,url),config={withCredentials:!0};return angular.isDefined(headers)&&(config.headers=headers),$http.post(urlUse,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.doPut=function(data,url){var deferred=$q.defer(),urlUse=serverConfig.apiUrl(serverConfig.POST_API,url),config={withCredentials:!0};return $http.put(urlUse,data,config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.doDelete=function(data,url){var deferred=$q.defer(),config={method:"DELETE",url:serverConfig.apiUrl(serverConfig.POST_API,url),data:data,withCredentials:!0,headers:{"Content-Type":"application/json"}};return $http(config).then(function(response){deferred.resolve(response)},function(error){deferred.resolve(error)}),deferred.promise},obj.showDialog=function(dialogTemplate,scope,event,clickOutsideToClose,parent,fullscreen,closeTo){scope.utilsRemoveDialog=scope.utilsRemoveDialog||function(){$mdDialog.cancel()};var data={controller:function(){},templateUrl:dialogTemplate,onRemoving:function(){$mdDialog.cancel()}};data.parent=angular.element(angular.isDefined(parent)?parent:document.body),data.scope=angular.isDefined(scope)?scope:null,data.preserveScope=null!==data.scope,data.targetEvent=angular.isDefined(event)?event:null,data.clickOutsideToClose=!angular.isDefined(clickOutsideToClose)||clickOutsideToClose,data.fullscreen=!!angular.isDefined(fullscreen)&&fullscreen,data.closeTo=!!angular.isDefined(closeTo)&&closeTo,$mdDialog.show(data)},obj.closeDialog=function(){$mdDialog.cancel()},obj.getServerUrl=function(url){return serverConfig.apiUrl(serverConfig.GET_API,url)},obj.getErrorMessage=function(resData){var message,messages={FILE_FORMAT_NOT_SUPPORTED:"Unsupported file format",SIZE_LIMIT_PAY:"Insufficient quota for model",USER_NOT_VERIFIED:"Please click on the link in the verify email sent to your account",ALREADY_VERIFIED:"You have already verified your account successfully. You may now login to your account.",INVALID_CAPTCHA_RES:"Prove you're not a robot",USER_EXISTS:"User already exists"};return Object.keys(serverConfig.responseCodes).forEach(function(key){serverConfig.responseCodes[key].value===resData.value&&(message=messages[key]?messages[key]:serverConfig.responseCodes[key].message)}),message},obj.getResponseCode=function(errorToFind){return Object.keys(serverConfig.responseCodes).indexOf(errorToFind)},obj}angular.module("3drepo").factory("UtilsService",UtilsService),UtilsService.$inject=["$http","$q","$mdDialog","serverConfig"]}(),function(){"use strict";function WalkthroughService($interval,$timeout,$q,$http,serverConfig){function getWalkthroughs(account,model,index){var modelKey=account+"__"+model;angular.isUndefined(index)&&(index="all");var url="/"+account+"/"+model+"/walkthrough/"+index+".json",i=0,length=0;loading=$q.defer();var needLoading=!1;return walkthroughs.hasOwnProperty(modelKey)?walkthroughs[modelKey].hasOwnProperty(index)||(needLoading=!0):(walkthroughs[modelKey]=[],needLoading=!0),needLoading?$http.get(serverConfig.apiUrl(serverConfig.GET_API,url)).then(function(data){for(i=0,length=data.data.length;i<length;i++)walkthroughs[modelKey][data.data[i].index]=data.data[i].cameraData;loading.resolve(walkthroughs[modelKey][index])}):loading.resolve(walkthroughs[modelKey][index]),loading.promise}var walkthroughs={},loading=null,saveRecording=function(account,model,index,recording){var postUrl="/"+account+"/"+model+"/walkthrough",modelKey=account+"__"+model;walkthroughs[modelKey][index]=recording,$http.post(serverConfig.apiUrl(serverConfig.POST_API,postUrl),{index:index,cameraData:recording}).then(function(){})};return{saveRecording:saveRecording,getWalkthroughs:getWalkthroughs}}angular.module("3drepo").factory("WalkthroughService",WalkthroughService),WalkthroughService.$inject=["$interval","$timeout","$q","$http","serverConfig"]}(),function(){"use strict";function walkthroughVr(){return{restrict:"EA",scope:{account:"@",model:"@",autoPlay:"@",animate:"@",fps:"@",rollerCoaster:"@"},template:"walkthrough.html",controller:WalkthroughCtrl,controllerAs:"wt",bindToController:!0}}function WalkthroughCtrl($scope,$q,$interval,$timeout,WalkthroughService,EventService){var wt=this;wt.initialized=!1,wt.frames=[],wt.loading=null,wt.frame=0,wt.autoPlay=!!angular.isDefined(wt.autoPlay)&&wt.autoPlay,wt.fps=angular.isDefined(wt.fps)?wt.fps:DEFAULT_FRAMES_PER_SECOND,wt.rollerCoaster=angular.isDefined(wt.rollerCoaster),wt.animate=angular.isDefined(wt.animate),wt.currentWalkthrough=wt.autoPlay?wt.autoPlay:-1,wt.recording=[],wt.isPlaying=!1,wt.isRecording=!1,wt.playInterval=null,wt.recordingInterval=null,wt.userWatchDog=null,wt.stop=function(){wt.isPlaying&&($interval.cancel(wt.playInterval),wt.isPlaying=!1)},wt.play=function(){wt.initialized||(wt.initialized=!0,wt.isPlaying=!0,$timeout.cancel(wt.userWatchDog),wt.frame=0,wt.playInterval=$interval(wt.tickFunction,wt.msPerFrame))},wt.startRecording=function(){wt.currentWalkthrough!==-1&&(wt.isRecording=!0,wt.recording=[],wt.recordingInterval=$interval(function(){var viewpointPromise=$q.defer();EventService.send(EventService.EVENT.VIEWER.GET_CURRENT_VIEWPOINT,{promise:viewpointPromise.promise}),viewpointPromise.then(function(viewpoint){wt.recording.push({position:viewpoint.position,up:viewpoint.up,view_dir:viewpoint.view_dir})})},wt.msPerFrame))},wt.stopRecording=function(){wt.isRecording=!1,$interval.cancel(wt.recordingInterval),WalkthroughService.saveRecording(wt.account,wt.model,wt.currentWalkthrough,wt.recording)},wt.tickFunction=function(){wt.loading&&wt.loading.then(function(){EventService.send(EventService.EVENT.VIEWER.SET_CAMERA,{position:wt.frames[wt.frame].position,up:wt.frames[wt.frame].up,view_dir:wt.frames[wt.frame].view_dir,rollerCoasterMode:wt.rollerCoaster,animate:wt.animate}),wt.frame===wt.numFrames-1?wt.frame=0:wt.frame+=1})},wt.recordButtonClass="btn walkthroughButton btn-success",wt.record=function(){wt.currentWalkthrough!==-1&&(wt.isRecording?(wt.stopRecording(),wt.recordButtonClass="btn walkthroughButton btn-success"):(wt.startRecording(),wt.recordButtonClass="btn walkthroughButton btn-danger"))},wt.userInControl=function(){wt.stop(),$interval.cancel(wt.userWatchDog),wt.userWatchDog=$timeout(function(){wt.play()},USER_CONTROL_WAIT)},wt.setCurrentWalkthrough=function(index){wt.currentWalkthrough=index,wt.loading=WalkthroughService.getWalkthroughs(wt.account,wt.model,index)},$scope.$watchGroup(["account","model"],function(){wt.currentWalkthrough=0,wt.loading=WalkthroughService.getWalkthroughs(wt.account,wt.model)}),$scope.$watch(["fps"],function(newFPS){wt.fps=newFPS,wt.msPerFrame=Math.floor(1e3/wt.fps)}),$scope.$on("$destroy",function(){wt.stop()}),wt.setCurrentWalkthrough(wt.currentWalkthrough)}angular.module("3drepo").directive("walkthrough",walkthroughVr);var DEFAULT_FRAMES_PER_SECOND=30,USER_CONTROL_WAIT=6e4;WalkthroughCtrl.$inject=["$scope","$q","$interval","$timeout","WalkthroughService","EventService"]}(),function(){"use strict";angular.module("3drepo").controller("VRDemoCtrl",["$scope",function($scope){$scope.showMenu=!0,$scope.demoOne=!1,$scope.demoTwo=!1,$scope.goDemoOne=function($event){$scope.showMenu=!1,$scope.demoOne=!0,$scope.demoTwo=!1,$event.preventDefault()},$scope.goDemoTwo=function($event){$scope.showMenu=!1,$scope.demoOne=!1,$scope.demoTwo=!0,$event.preventDefault()},$scope.backToMenu=function(){document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen||($scope.showMenu=!0,$scope.demoOne=!1,$scope.demoTwo=!1)},document.addEventListener("webkitfullscreenchange",$scope.backToMenu,!1),document.addEventListener("mozfullscreenchange",$scope.backToMenu,!1),document.addEventListener("fullscreenchange",$scope.backToMenu,!1),document.addEventListener("MSFullscreenChange",$scope.backToMenu,!1)}])}();
//# sourceMappingURL=three_d_repo.min.js.map