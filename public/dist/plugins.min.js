function bgroundClick(event){$.event.trigger("bgroundClicked",event)}function clickObject(event){$.event.trigger("clickObject",event)}function clickPin(event){var pinGroupObject=event.hitObject.parentElement.parentElement.parentElement;$.event.trigger("pinClick",{fromViewer:!0,object:pinGroupObject})}function onMouseOver(event){$.event.trigger("onMouseOver",event)}function onMouseDown(event){$.event.trigger("onMouseDown",event)}function onMouseUp(event){$.event.trigger("onMouseUp",event)}function onMouseMove(event){$.event.trigger("onMouseMove",event)}function onMouseOver(event){$.event.trigger("onMouseOver",event)}function onViewpointChange(event){$.event.trigger("onViewpointChange",event)}function onLoaded(event){$.event.trigger("onLoaded",event)}function runtimeReady(){$.event.trigger("runtimeReady")}function getProject(accountName,projectName){return $("inline").filter(function(){return this.nameSpaceName==accountName+"__"+projectName})}function getNode(node){return"project"in node.data?getProject(node.data.account,node.data.project)[0]:document.getElementById(node.data.namespace+node.data.uuid)}function treeURL(account,project,branch,revision,sid,depth){var newURL="";return newURL+=revision&&"head"!=revision?account+"/"+project+"/revision/"+revision+"/tree/":account+"/"+project+"/revision/"+branch+"/head/tree/",newURL+=sid?sid:"root",newURL+=".json?",depth&&(newURL+="depth="+depth+"&"),newURL+="htmlMode=true",server_config.apiUrl(newURL)}function refreshTree(account,project,branch,revision){var newURL=treeURL(account,project,branch,revision),tree=$("#scenetree").fancytree("getTree");TreeControl.loading||(TreeControl.loading=!0,TreeControl.promise=tree.reload({url:newURL}).done(function(){TreeControl.loading=!1}))}angular.module("3drepo").service("Auth",["$injector","$q","$state","serverConfig",function($injector,$q,$state,serverConfig){this.loggedIn=null,this.username=null;var self=this;this.init=function(){var deferred=$q.defer();if(null===self.loggedIn){var http=$injector.get("$http");http.get(serverConfig.apiUrl("login")).success(function(data,status){self.loggedIn=!0,self.username=data.username,deferred.resolve(self.loggedIn)}).error(function(data,status){self.loggedIn=!1,self.username=null,deferred.resolve(self.loggedIn)})}else deferred.resolve(self.loggedIn);return deferred.promise},this.getUsername=function(){return this.username},this.login=function(username,password){var deferred=$q.defer(),postData={username:username,password:password},http=$injector.get("$http");return http.post(serverConfig.apiUrl("login"),postData).success(function(){self.username=username,self.loggedIn=!0,deferred.resolve(username)}).error(function(data,status){self.username=null,self.loggedIn=!1,401==status?deferred.reject("Unauthorized"):400==status?deferred.reject("Invalid username/password"):deferred.reject("Unknown error")}),deferred.promise},this.logout=function(){var deferred=$q.defer(),http=$injector.get("$http");return http.post(serverConfig.apiUrl("logout")).success(function(){self.username=null,self.loggedIn=!1,deferred.resolve()}).error(function(){self.username=null,self.loggedIn=!1,deferred.reject("Unable to logout.")}),deferred.promise}}]),angular.module("3drepo").config(["$stateProvider","$locationProvider",function($stateProvider,$locationProvider){$stateProvider.state("base",{name:"base",resolve:{StateManager:"StateManager",init:function(StateManager){StateManager.refresh("base")}}}),$locationProvider.html5Mode(!0)}]).factory("BaseData",["StateManager","uiState",function(StateManager,uiState){var o={};o.refresh=function(){for(uicomp in o.uiComps)uicomp in StateManager.ui&&(StateManager.ui[uicomp]=!1);for(statevar in StateManager.state)StateManager.state[statevar]=null},o.uiComps=[];for(k in uiState)for(var i=0;i<uiState[k].length;i++){var plugin=uiState[k][i];-1==o.uiComps.indexOf(plugin)&&o.uiComps.push(plugin)}return o}]).controller("BaseCtrl",["$scope","StateManager",function($scope,StateManager){$scope.ui=StateManager.ui,$scope.Data=StateManager.Data,$scope.state=StateManager.state}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("base","BaseData",function(){return"base"})}]).factory("clickOutsideService",function($document){return function($scope,expr){var clickCB=function(){$scope.$apply(expr)};$document.on("click",clickCB),$scope.$on("$destroy",function(){$document.off("click",clickCB)})}}).directive("clickOutside",function($document,clickOutsideService){return{restrict:"A",link:function(scope,element,attr){var clickCB=function(event){event.stopPropagation()};element.on("click",clickCB),scope.$on("$destroy",function(){element.off("click",clickCB)}),clickOutsideService(scope,attr.clickOutside)}}}),angular.module("3drepo").controller("DialogCtrl",function($scope,$modalInstance,params){$scope.params=params,$scope.ok=function(){$modalInstance.close($scope.params)},$scope.cancel=function(){$modalInstance.dismiss("cancel")}}),angular.module("3drepo").service("CameraService",["$window","$timeout",function($window,$timeout){var self=this;self.cameraSwitch=!1,self.source=null,$window.MediaStreamTrack.getSources&&$window.MediaStreamTrack.getSources(function(srcs){var videoSRCS=srcs.filter(function(item){return"video"==item.kind});videoSRCS.length>1&&(videoSRCS=videoSRCS.filter(function(item){return"environment"==item.facing})),videoSRCS.length||callback("No valid cameras found"),self.source=videoSRCS[0]}),this.decodeCanvas=function(scope,element,callback){var width=element.videoWidth,height=element.videoHeight;if(width&&height){scope.canvas||(scope.canvas=document.createElement("canvas"),scope.canvas.id="qr-canvas",scope.canvas.width=width,scope.canvas.style.width=width+"px",scope.canvas.height=height,scope.canvas.style.height=height+"px",element.appendChild(scope.canvas));var ctx=scope.canvas.getContext("2d");ctx.clearRect(0,0,width,height),ctx.drawImage(element,0,0,width,height);try{return callback(null,qrcode.decode())}catch(err){if(!self.cameraSwitch)return self.videoStream&&self.videoStream.stop(),callback(err);callback(err)}}$timeout(function(){self.decodeCanvas(scope,element,callback)},200)},this.captureQRCode=function(scope,element,callback){$window.navigator.getUserMedia=$window.navigator.getUserMedia||$window.navigator.webkitGetUserMedia||$window.navigator.mozGetUserMedia;var constraints={video:{optional:[{sourceId:self.source.id}]}};$window.navigator.getUserMedia(constraints,function(videoStream){element.src=$window.URL.createObjectURL(videoStream),self.videoStream=videoStream,$timeout(function(){self.decodeCanvas(scope,element,callback)},200)},function(err){callback(err)})}}]).controller("HeaderCtrl",["$scope","Auth","$modal","CameraService","StateManager",function($scope,Auth,$modal,CameraService,StateManager){$scope.Auth=Auth,$scope.user={username:"",password:""},$scope.CameraService=CameraService,$scope.captureQRCode=$scope.CameraService.captureQRCode,$scope.logOut=function(){Auth.logout().then(function(){$scope.errorMessage=null,StateManager.state.account=null,StateManager.updateState()},function(reason){$scope.errorMessage=reason,StateManager.updateState()})},$scope.goAccount=function(){StateManager.setState({account:Auth.username},{clearState:!0}),StateManager.updateState()},$scope.$on("notAuthorized",function(event,message){$scope.goAccount()}),$scope.whereAmI=function(){$scope.CameraService.cameraSwitch=!0;var modalInstance=$modal.open({templateUrl:"cameramodal.html",controller:"DialogCtrl",backdrop:!1,resolve:{params:{}}});modalInstance.result.then(function(params){},function(){$scope.CameraService.cameraSwitch=!1})}}]).directive("cameraSwitch",function(){return{restrict:"A",scope:{capture:"="},link:function(scope,element,attrs){"true"==attrs.cameraSwitch&&scope.capture(scope,element[0],function(err,res){err?console.log("QRCode error: "+err):window.location.replace(res)})}}}),angular.module("3drepo").run(["$rootScope","uiState","StateManager",function($rootScope,uiState,StateManager){$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){console.log("$stateChangeStart to "+JSON.stringify(toState)+"- fired when the transition begins. toState,toParams : \n",toState,toParams)}),$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){console.log("$stateChangeError - fired when an error occurs during transition."),console.log(arguments)}),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){for(var uiComps=uiState[toState.name],toStates=toState.name.split("."),fromStates=fromState.name.split("."),i=0;i<fromStates.length;i++)-1==toStates.indexOf(fromStates[i])&&StateManager.clearStateVars(fromStates[i]);for(uicomp in StateManager.ui)StateManager.ui[uicomp]=!1;if(uiComps)for(var i=0;i<uiComps.length;i++)StateManager.ui[uiComps[i]]=!0}),$rootScope.$on("$viewContentLoaded",function(event){console.log("$viewContentLoaded - fired after dom rendered",event)}),$rootScope.$on("$stateNotFound",function(event,unfoundState,fromState,fromParams){console.log("$stateNotFound "+unfoundState.to+"  - fired when a state cannot be found by its name."),console.log(unfoundState,fromState,fromParams)})}]).service("StateManager",["$injector","$state","structure",function($injector,$state,structure){var self=this;this.Data={},this.state={},this.ui={},this.pluginData={},this.pluginState={},this.changed={},this.clearChanged=function(){for(var i in self.changed)self.changed[i]=!1},this.destroy=function(){delete this.state,this.state={},delete this.ui,this.ui={},delete this.Data,this.Data={}},self.clearChanged(),this.registerPlugin=function(plugin,dataFactory,stateFunc){dataFactory&&(this.Data[dataFactory]=$injector.get(dataFactory),plugin&&(plugin in this.pluginData||(this.pluginData[plugin]=[]),this.pluginData[plugin].push(this.Data[dataFactory]))),stateFunc&&(this.pluginState[plugin]=stateFunc)},this.stateVars={},this.setClearStateVars=function(state,stateVars){self.stateVars[state]=stateVars},this.clearStateVars=function(state){var myStateVars=self.stateVars[state];if(myStateVars)for(var i=0;i<myStateVars.length;i++)self.state[myStateVars[i]]=null},this.refresh=function(plugin){for(var dataFactories=this.pluginData[plugin],i=0;i<dataFactories.length;i++)dataFactories[i].refresh()},this.genStateName=function(){for(var currentChildren=structure.children,childidx=0,stateName="base.";childidx<currentChildren.length;){var child=currentChildren[childidx],plugin=child.plugin,pluginStateName=this.pluginState[plugin](this);pluginStateName&&(stateName+=pluginStateName+".",currentChildren=child.children?child.children:[],childidx=-1),childidx+=1}return stateName.substring(0,stateName.length-1)},this.createStateVar=function(varName,value){this.state.varName=value},this.setStateVar=function(varName,value){self.state[varName]!=value&&(self.changed[varName]=!0),self.state[varName]=value},this.setState=function(stateParams,extraParams){var stateObj=$.extend(stateParams,extraParams);console.log("Setting state - "+JSON.stringify(stateParams));for(var i in stateObj){var currentStateParams=Object.keys(self.state);-1==currentStateParams.indexOf(i)&&self.createStateVar(i,stateObj[i]),self.setStateVar(i,stateObj[i])}if(extraParams.clearState){var objectKeys=Object.keys(stateObj);for(var i in self.state)-1==objectKeys.indexOf(i)&&delete self.state[i]}},this.updateState=function(dontUpdateLocation){console.log("Moving to "+self.genStateName()+" ...");var updateLocation=dontUpdateLocation?!1:!0;$state.transitionTo(self.genStateName(),self.state,{location:updateLocation})}}]),angular.module("3drepo").factory("authInterceptor",["$rootScope","$q",function($rootScope,$q){return{responseError:function(res){return 401==res.status&&$rootScope.$broadcast("notAuthorized",null),$q.reject(res)}}}]).config(function($httpProvider){var checkAuthorization=["$q","$location",function($q,$location){var onSuccess=function(res){return res},onError=function(res){return 401==res.status||400==res.status?($location.path("/login"),$q.reject(res)):$q.reject(res)};return function(promise){return promise.then(onSuccess,onError)}}];$httpProvider.interceptors.push(checkAuthorization),$httpProvider.defaults.withCredentials=!0,$httpProvider.interceptors.push("authInterceptor")}),angular.module("3drepo").provider("pageConfig",["$urlRouterProvider",function($urlRouterProvider){var loggedInFunc=null,notLoggedInFunc=null;this.setStateFuncs=function(newLoggedInFunc,newNotLoggedInFunc){loggedInFunc=newLoggedInFunc,notLoggedInFunc=newNotLoggedInFunc},this.$get=["Auth","StateManager",function(Auth,StateManager){var obj={};return obj.loggedInFunc=loggedInFunc,obj.notLoggedInFunc=notLoggedInFunc,obj.goDefault=function(){Auth.loggedIn?loggedInFunc(Auth,StateManager):notLoggedInFunc(Auth,StateManager)},$urlRouterProvider.otherwise(obj.goDefault),obj}]}]),angular.module("3drepo").config(["pageConfigProvider","$urlRouterProvider",function(pageConfigProvider,$urlRouterProvider){pageConfigProvider.setStateFuncs(function(Auth,StateManager){StateManager.state.account=Auth.username,StateManager.updateState()},function(Auth,StateManager){StateManager.updateState()})}]),angular.module("3drepo").service("serverConfig",function(){this.apiUrl=server_config.apiUrl,this.democompany=server_config.democompany,this.demoproject=server_config.demoproject,this.chatHost=server_config.chatHost,this.chatPath=server_config.chatPath}),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.login,i=0;i<states.length;i++)$stateProvider.state(states[i]+".login",{url:"/",views:{"@":{templateUrl:"login.html"}}})}]).run(["StateManager","Auth",function(StateManager,Auth){StateManager.registerPlugin("login",null,function(){return"login"})}]).controller("LoginCtrl",["$scope","StateManager","Auth",function($scope,StateManager,Auth){$scope.user={username:"",password:""},$scope.login=function(){Auth.login($scope.user.username,$scope.user.password).then(function(username){$scope.errorMessage=null,$scope.user.username=null,$scope.user.password=null,StateManager.setStateVar("account",username),StateManager.updateState()},function(reason){$scope.errorMessage=reason,$scope.user.password=null,StateManager.setStateVar("account",null),StateManager.updateState()})}}]),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.account,i=0;i<states.length;i++)$stateProvider.state(states[i]+".account",{url:":account",templateUrl:"account.html",resolve:{auth:function(Auth){return Auth.init()},init:function(StateManager,$stateParams){""==$stateParams.account&&($stateParams.account=null),StateManager.setState($stateParams,{}),StateManager.refresh("account")}},views:{"@":{templateUrl:"account.html",controller:"AccountCtrl"}}})}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("account","AccountData",function(){return StateManager.state.account?"account":null}),StateManager.setClearStateVars("account",["account"])}]).controller("AccountCtrl",["$scope","StateManager",function($scope,StateManager){$scope.defaultView="projects",$scope.view=$scope.defaultView,$scope.setView=function(view){$scope.view=view},$scope.goProject=function(account,project){StateManager.setStateVar("account",account),StateManager.setStateVar("project",project),StateManager.updateState()},$scope.isView=function(view){return $scope.view==view},$scope.passwords={},$scope.passwords.updateUserError="",$scope.passwords.changePasswordError="",$scope.errors={},$scope.errors.oldPassword="",$scope.errors.newPassword="",$scope.updateUser=function(){$scope.Data.UserData.updateUser().success(function(data,status){$scope.setView($scope.defaultView)}).error(function(message,status){$scope.updateUserError="["+message.message+"]"})},$scope.changePassword=function(){$scope.Data.UserData.updatePassword($scope.passwords.oldPassword,$scope.passwords.newPassword).success(function(data,status){$scope.setView($scope.defaultView)}).error(function(message,status){$scope.errors.changePasswordError="["+message.message+"]"})},$scope.projectsShowList=!0,$scope.toggleProjectsView=function(){$scope.projectsShowList=!$scope.projectsShowList}}]),angular.module("3drepo").factory("AccountData",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={username:null,firstName:null,lastName:null,email:null,projects:null};return o.refresh=function(){var self=this,username=StateManager.state.account,deferred=$q.defer();return username!=self.username?(self.username=username,self.firstName="",self.lastName="",self.email="",self.projects=[],self.avatarURL=serverConfig.apiUrl(username+".jpg"),$http.get(serverConfig.apiUrl(username+".json")).then(function(json){if(self.username=username,json.data.firstName&&(self.firstName=json.data.firstName),json.data.lastName&&(self.lastName=json.data.lastName),json.data.email&&(self.email=json.data.email),json.data.projects){self.projects=json.data.projects,self.projectsGrouped={};for(var p=0;p<self.projects.length;p++){var project=self.projects[p];project.account in self.projectsGrouped||(self.projectsGrouped[project.account]=[]),self.projectsGrouped[project.account].push(project.project)}}return $http.get(self.avatarURL)},function(message){return self.loadError="["+message+"]",$q.reject(message)}).then(function(json){self.hasAvatar=!0,self.loading=!1,deferred.resolve()},function(message){self.hasAvatar=!1,self.loading=!1,deferred.resolve()})):deferred.resolve(),deferred.promise},o.updatePassword=function(oldPassword,newPassword){var passwords={oldPassword:oldPassword,newPassword:newPassword};return $http.post(serverConfig.apiUrl(this.username),passwords)},o.updateUser=function(){var user={email:this.email,firstName:this.firstName,lastName:this.lastName};return $http.post(serverConfig.apiUrl(this.username),user)},o}]),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.project,i=0;i<states.length;i++)$stateProvider.state(states[i]+".project",{url:"/:project",templateUrl:"account.html",resolve:{auth:function(Auth){return Auth.init()},init:function(StateManager,$stateParams){StateManager.setStateVar("branch","master"),StateManager.setStateVar("revision","head"),StateManager.setState($stateParams,{}),StateManager.refresh("project")}},views:{"@":{templateUrl:"project.html",controller:"ProjectCtrl"}}})}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("project","ProjectData",function(){return StateManager.state.project?"project":null}),StateManager.setClearStateVars("project",["project"])}]).controller("ProjectCtrl",["$scope","StateManager","ViewerService","ProjectData",function($scope,StateManager,ViewerService,ProjectData){ViewerService.init(),$scope.$watch("state.project",function(){StateManager.setStateVar("branch","master"),StateManager.setStateVar("revision","head"),StateManager.updateState(),ProjectData.loadingPromise.promise.then(function(){ViewerService.defaultViewer.updateSettings(ProjectData.settings)})}),$scope.$watchGroup(["state.branch","state.revision"],function(){ViewerService.loadModel(),ViewerService.defaultViewer.setNavMode("TURNTABLE")})}]),angular.module("3drepo").factory("ProjectData",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={project:null,name:"",owner:"",description:"",settings:null,publicPerm:{read:!1,write:!1,execute:!1},userPerm:{read:!1,write:!1,execute:!1},ownerPerm:{read:!1,write:!1,execute:!1}};return o.projectTypes=[{label:"Architectural",value:1},{label:"Aerospace",value:2},{label:"Automotive",value:3},{label:"Enginering",value:4},{label:"Other",value:5}],o.roleIndex={OWNER:0,USER:1,PUBLIC:2},o.bitMasks={READ_BIT:4,WRITE_BIT:2,EXECUTE_BIT:1},o.loading=!1,o.loadingPromise=$q.defer(),o.refresh=function(){var self=this,account=StateManager.state.account,project=StateManager.state.project;return self.loading||(project!=self.project?(self.visibility="private",self.loading=!0,$http.get(serverConfig.apiUrl(account+"/"+project+".json")).success(function(json,status){self.name=project,self.owner=json.owner,self.description=json.desc,self.type=json.type,self.selected=self.projectTypes[0];for(var i=0;i<self.projectTypes.length;i++)if(self.projectTypes[i].label.toLowerCase()==self.type.toLowerCase()){self.selected=self.projectTypes[i];break}self.publicPerm.read=(json.permissions[self.roleIndex.PUBLIC]&self.bitMasks.READ_BIT)>0,self.publicPerm.write=(json.permissions[self.roleIndex.PUBLIC]&self.bitMasks.WRITE_BIT)>0,self.publicPerm.execute=(json.permissions[self.roleIndex.PUBLIC]&self.bitMasks.EXECUTE_BIT)>0,self.userPerm.read=(json.permissions[self.roleIndex.USER]&self.bitMasks.READ_BIT)>0,self.userPerm.write=(json.permissions[self.roleIndex.USER]&self.bitMasks.WRITE_BIT)>0,self.userPerm.execute=(json.permissions[self.roleIndex.USER]&self.bitMasks.EXECUTE_BIT)>0,self.ownerPerm.read=(json.permissions[self.roleIndex.OWNER]&self.bitMasks.READ_BIT)>0,self.ownerPerm.write=(json.permissions[self.roleIndex.OWNER]&self.bitMasks.WRITE_BIT)>0,self.ownerPerm.execute=(json.permissions[self.roleIndex.OWNER]&self.bitMasks.EXECUTE_BIT)>0,self.loading=!1,self.settings=json.properties,self.loadingPromise.resolve()})):self.loadingPromise.resolve()),self.loadingPromise.promise},o.updateInfo=function(){var newInfo={type:this.type,description:this.description};return $http.post(serverConfig.apiUrl(StateManager.state.account+"/"+self.project),newInfo)},o}]),angular.module("3drepo").service("ViewerService",["$window","StateManager","serverConfig","$http","$q",function($window,StateManager,serverConfig,$http,$q){var self=this,readyQ=$q.defer();self.ready=readyQ.promise,this.init=function(){self.viewerManager=new ViewerManager,self.defaultViewer=self.viewerManager.getDefaultViewer(),self.defaultViewer.enableClicking(),$window.viewer=self.defaultViewer,self.oculus=new Oculus(self.defaultViewer),self.gamepad=new Gamepad(self.defaultViewer),self.gamepad.init(),self.collision=new Collision(self.defaultViewer),self.defaultViewer.whenLoaded(function(){readyQ.resolve()})},this.linkFunction=function(callback){self.viewerManager.linkFunction(callback)},this.loadModel=function(){var branch=StateManager.state.branch?StateManager.state.branch:"master",revision=StateManager.state.revision?StateManager.state.revision:"head",url=null;url="head"==revision?serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+branch+"/head.x3d.mp"):serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+revision+".x3d.mp"),self.defaultViewer.loadURL(url),self.defaultViewer.setCurrentViewpoint("model__"+StateManager.state.account+"_"+StateManager.state.project+"_origin")},this.pickPoint=function(x,y){return self.defaultViewer.pickPoint(x,y),self.defaultViewer.pickObject},this.switchVR=function(){self.oculus&&self.oculus.switchVR()},this.close=function(){delete $window.oculus,delete $window.collision,self.viewerManager.close(),delete $window.viewerManager,self.defaultViewer=null}}]);var Collision=function(viewer){var self=this;this._deltaT=.1,this.deltaX=0,this.deltaY=0,this.ticking=!1,this.prevMove=0,this.stopped=!0,this.viewer=viewer,this.updateDirections=function(event,gamepad){var speed=self.viewer.nav._x3domNode._vf.speed,userX=self._deltaT*speed*gamepad.xaxis,userY=self._deltaT*speed*gamepad.yaxis;if(0==userX&&0==userY?self.stopped=!0:self.stopped=!1,self.stopped)self.userX=0,self.userY=0;else{self.viewer.getViewMatrix();self.userX=-userX,self.userY=-userY,self.ticking||self.tick()}},this.tick=function(){self.ticking=!0;var viewArea=self.viewer.getViewArea(),straightDown=new x3dom.fields.SFVec3f(0,-1,0),straightUp=new x3dom.fields.SFVec3f(0,1,0),right=(new x3dom.fields.SFVec3f(0,0,-1),new x3dom.fields.SFVec3f(-1,0,0)),currProjMat=self.viewer.getProjectionMatrix(),currViewMat=self.viewer.getViewMatrix(),flyMat=currViewMat.inverse(),from=flyMat.e3(),tmpFlatAt=flyMat.e3(),viewDir=currViewMat.inverse().e2().multiply(-1),viewX=viewDir.x,viewZ=viewDir.z;self.deltaX=self.userX*viewZ+self.userY*viewX,self.deltaZ=-self.userX*viewX+self.userY*viewZ,tmpFlatAt.x+=self.deltaX,tmpFlatAt.z+=self.deltaZ;var tmpTmpMat=x3dom.fields.SFMatrix4f.lookAt(from,tmpFlatAt,straightUp);tmpTmpMat=tmpTmpMat.inverse(),viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpTmpMat,currProjMat.mult(tmpTmpMat));var dist=self.viewer.avatarRadius+1;if(viewArea._pickingInfo.pickObj&&(dist=viewArea._pickingInfo.pickPos.subtract(from).length()),!self.stopped&&dist>self.viewer.avatarRadius){var tmpUp=tmpFlatAt.subtract(from).normalize(),right=straightDown.cross(tmpUp);tmpUp=right.cross(straightDown),from.x+=self.deltaX,from.z+=self.deltaZ;var tmpDownMat=x3dom.fields.SFMatrix4f.identity();if(tmpDownMat.setValue(right,tmpUp,straightDown.multiply(-1),from),tmpDownMat=tmpDownMat.inverse(),viewArea._pickingInfo.pickObj=null,viewArea._scene._nameSpace.doc.ctx.pickValue(viewArea,viewArea._width/2,viewArea._height/2,this._lastButton,tmpDownMat,currProjMat.mult(tmpDownMat)),viewArea._pickingInfo.pickObj){var dist=viewArea._pickingInfo.pickPos.subtract(from).length(),movement=.5*(self.viewer.avatarHeight-dist+self.prevMove);from.y+=movement,self.prevMove=movement}var up=(from.subtract(flyMat.e2()),flyMat.e1()),tmpMat=x3dom.fields.SFMatrix4f.identity(),right=up.cross(flyMat.e2());tmpMat.setValue(right,up,flyMat.e2(),from),viewArea._scene.getViewpoint().setView(tmpMat.inverse()),self.viewer.runtime.triggerRedraw()}self.nextTick()},this.nextTick=function(){window.requestAnimationFrame?window.requestAnimationFrame(this.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(this.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(this.tick)},$(document).on("gamepadMove",this.updateDirections)},Gamepad=function(viewer){var self=this;this.enabled=!1,this.gamepad=null,this.timestamp=null,this.browser=null,this.platform=null,this.viewer=viewer,this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){self.gamepad&&(self.gamepad.timestamp&&self.gamepad.timestamp==self.timestamp||(self.timestamp=self.gamepad.timestamp))},this.connected=function(event){self.gamepad=event.gamepad,self.startPolling()},this.disconnected=function(event){self.gamepad=null,self.stopPolling()},this.startPolling=function(){self.enabled||(self.enabled=!0,self.tick())},this.oldButton=!1,this.checkStatus=function(){if(self.gamepad&&(!self.gamepad.timestamp||self.gamepad.timestamp!=self.timestamp)){self.timestamp=self.gamepad.timestamp;var button_idx=0;"Linux"===self.platform&&"Chrome"===self.browser?$.event.trigger("gamepadMove",{xaxis:self.gamepad.axes[0],yaxis:self.gamepad.axes[1],button:self.gamepad.buttons[button_idx]}):"Win32"===self.platform&&"Chrome"===self.browser?(button_idx=3,$.event.trigger("gamepadMove",{xaxis:self.gamepad.buttons[15].value-self.gamepad.buttons[14].value,yaxis:self.gamepad.buttons[13].value-self.gamepad.buttons[12].value,button:self.gamepad.buttons[button_idx]})):"Win32"===self.platform&&"Firefox"===self.browser&&$.event.trigger("gamepadMove",{xaxis:self.gamepad.axes[4],yaxis:self.gamepad.axes[5],button:self.gamepad.buttons[button_idx]}),self.gamepad.buttons[button_idx].pressed&&(self.oldButton||(viewer.reset(),viewer.setNavMode("NONE"),viewer.setApp(null),viewer.disableClicking())),self.oldButton=self.gamepad.buttons[button_idx].pressed}},this.tick=function(){navigator.getGamepads()[0]&&(self.gamepad=navigator.getGamepads()[0]),self.gamepad&&self.checkStatus(),self.nextTick()},this.nextTick=function(){this.enabled&&(window.requestAnimationFrame?window.requestAnimationFrame(self.tick):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(self.tick):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(self.tick))},this.stopPolling=function(){self.enabled=!1},this.init=function(){var gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;gamepadSupportAvailable&&(-1!=window.navigator.platform.indexOf("Linux")?self.platform="Linux":-1!=window.navigator.platform.indexOf("Win32")||-1!=window.navigator.platform.indexOf("Win64")?self.platform="Win32":console.error("Platform "+window.navigator.platform+" is not supported."),-1!=window.navigator.appVersion.indexOf("Chrome")?self.browser="Chrome":-1!=window.navigator.appVersion.indexOf("Firefox")?self.browser="Firefox":-1!=window.navigator.userAgent.indexOf("Firefox")?self.browser="Firefox":console.error("Browser version "+window.navigator.appVersion+" is not supported."),self.browser&&self.platform&&("ongamepadconnected"in window?(window.addEventListener("gamepadconnected",self.connected,!1),window.addEventListener("gamepaddisconnected",self.disconnected,!1)):self.startPolling()))}},logo_string="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAB0CAMAAACcw5TeAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAA/SAAAP0gH7iTvJAAAAGXRFWHRTb2Z0d2FyZQB3d3cuaW5rc2NhcGUub3Jnm+48GgAAAwBQTFRF////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////vy5IYQAAAP90Uk5TAAECAwQF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";
x3dom.runtime.ready=runtimeReady;var Viewer=function(name,handle,x3ddiv,manager){function scale(v,s){return[v[0]*s,v[1]*s,v[2]*s]}function normalize(v){var sz=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return scale(v,1/sz)}var self=this;name?this.name=name:this.name="viewer",handle&&(this.handle=handle),x3ddiv?this.x3ddiv=x3ddiv:this.x3ddiv=$("#x3d")[0],this.inline=null,this.runtime=null,this.fullscreen=!1,this.clickingEnabled=!1,this.avatarRadius=.5,this.defaultShowAll=!0,this.zNear=-1,this.zFar=-1,this.manager=null,this.initialized=!1,this.loadedPromise=$.Deferred(),this.downloadsLeft=1,this.init=function(){self.initialized||(manager?self.manager=manager:x3dom.runtime.ready=self.initRuntime,self.manager?self.displayMessage=self.manager.displayMessage:self.displayMessage=function(text,textColor,timeout){},self.logo=document.createElement("div"),self.logo.setAttribute("id","viewer_logo"),self.logo.setAttribute("style","top: 0px; left: 0px; position: absolute; z-index:2;"),self.logoImage=document.createElement("img"),self.logoImage.setAttribute("src",logo_string),self.logoImage.setAttribute("style","width: 150px;"),self.logoImage.textContent=" ",self.logoLink=document.createElement("a"),self.logoLink.setAttribute("href","https://3drepo.io"),self.logoLink.setAttribute("style","top: 0px; left: 0px; padding: 10px; position: absolute;"),self.logoLink.appendChild(self.logoImage),self.logo.appendChild(self.logoLink),self.x3ddiv.appendChild(self.logo),self.viewer=document.createElement("x3d"),self.viewer.setAttribute("id",self.name),self.viewer.setAttribute("xmlns","http://www.web3d.org/specification/x3d-namespace"),self.viewer.setAttribute("keysEnabled",!1),self.viewer.setAttribute("mousedown",onMouseDown),self.viewer.setAttribute("mouseup",onMouseUp),self.viewer.className="viewer",self.x3ddiv.appendChild(self.viewer),self.scene=document.createElement("scene"),self.scene.setAttribute("onbackgroundclicked","bgroundClick(event);"),self.viewer.appendChild(self.scene),self.bground=null,self.currentNavMode=null,self.createBackground(),self.environ=document.createElement("environment"),self.environ.setAttribute("frustumCulling","true"),self.environ.setAttribute("smallFeatureCulling","true"),self.environ.setAttribute("smallFeatureThreshold",5),self.environ.setAttribute("occlusionCulling","true"),self.scene.appendChild(self.environ),self.light=document.createElement("directionallight"),self.light.setAttribute("color","0.714, 0.910, 0.953"),self.light.setAttribute("direction","0, -0.9323, -0.362"),self.light.setAttribute("global","true"),self.light.setAttribute("ambientIntensity","0.8"),self.light.setAttribute("shadowIntensity",0),self.scene.appendChild(self.light),self.createViewpoint(self.name+"_default"),self.nav=document.createElement("navigationInfo"),self.nav.setAttribute("headlight","false"),self.nav.setAttribute("type","TURNTABLE"),self.scene.appendChild(self.nav),self.loadViewpoint=self.name+"_default",self.viewer.addEventListener("keypress",function(e){e.charCode=="r".charCodeAt(0)?(self.reset(),self.setApp(null),self.setNavMode("WALK"),self.disableClicking()):e.charCode=="a".charCodeAt(0)?(self.showAll(),self.setNavMode("TURNTABLE"),self.enableClicking()):e.charCode=="n".charCodeAt(0)?(self.setNavMode("TURNTABLE"),self.enableClicking()):e.charCode=="w".charCodeAt(0)?self.setNavMode("WALK"):e.charCode=="e".charCodeAt(0)&&(self.setNavMode("EXAMINE"),self.enableClicking())}),self.addAxes(),self.initialized=!0)},this.close=function(){self.viewer.parentNode.removeChild(self.viewer),self.viewer=null},this.initRuntime=function(x3domruntime){self.manager?self.runtime=self.viewer.runtime:self.runtime=this,self.showAll=function(){self.runtime.fitAll(),self.getViewArea()._flyMat=null,self.setNavMode("TURNTABLE")},self.getCurrentViewpoint().addEventListener("viewpointChanged",self.viewPointChanged),$(document).on("onLoaded",function(event,objEvent){self.loadViewpoint&&self.setCurrentViewpoint(self.loadViewpoint);var targetParent=$(objEvent.target)[0]._x3domNode._nameSpace.doc._x3dElem;self.loadViewpoints(),targetParent==self.viewer&&self.setDiffColors(null),$("#model__mapPosition")[0]&&($("#model__mapPosition")[0].parentNode._x3domNode._graph.needCulling=!1),self.downloadsLeft+=objEvent.target.querySelectorAll("[load]").length-1,self.downloadsLeft||self.loadedPromise.resolve()})},this.whenLoaded=function(callback){self.loadedPromise.done(callback)},this.createBackground=function(){self.bground&&self.bground.parentNode.removeChild(self.bground),self.bground=document.createElement("background"),self.bground.setAttribute("DEF",name+"_bground"),self.bground.setAttribute("skyangle","0.9 1.5 1.57"),self.bground.setAttribute("skycolor","0.21 0.18 0.66 0.2 0.44 0.85 0.51 0.81 0.95 0.83 0.93 1"),self.bground.setAttribute("groundangle","0.9 1.5 1.57"),self.bground.setAttribute("groundcolor","0.65 0.65 0.65 0.73 0.73 0.73 0.81 0.81 0.81 0.91 0.91 0.91"),self.bground.textContent=" ",self.scene.appendChild(self.bground)},this.switchDebug=function(){self.getViewArea()._visDbgBuf=!self.getViewArea()._visDbgBuf},this.showStats=function(){self.runtime.canvas.stateViewer.display()},this.getViewArea=function(){return self.runtime.canvas.doc._viewarea},this.getViewMatrix=function(){return self.getViewArea().getViewMatrix()},this.getProjectionMatrix=function(){return self.getViewArea().getProjectionMatrix()},this.onMouseUp=function(functionToBind){$(self.viewer).on("onMouseUp",functionToBind)},this.onMouseDown=function(functionToBind){$(self.viewer).on("onMouseDown",functionToBind)},this.onViewpointChanged=function(functionToBind){$(self.viewer).on("myViewpointHasChanged",functionToBind)},this.offViewpointChanged=function(functionToBind){$(self.viewer).off("myViewpointHasChanged",functionToBind)},this.viewPointChanged=function(event){$(self.viewer).trigger("myViewpointHasChanged",event)},this.onBackgroundClicked=function(functionToBind){$(document).on("bgroundClicked",functionToBind)},this.offBackgroundClicked=function(functionToBind){$(document).off("bgroundClicked",functionToBind)},this.triggerSelected=function(node){$.event.trigger("objectSelected",node)},this.triggerPartSelected=function(part){$.event.trigger("partSelected",part)},$(document).on("partSelected",function(event,part,zoom){zoom&&part.fit(),self.oldPart&&self.oldPart.resetColor(),self.oldPart=part,part.setEmissiveColor("1.0 0.5 0.0","front")}),$(document).on("objectSelected",function(event,object,zoom){zoom&&"false"!=object.getAttribute("render")&&self.lookAtObject(object),self.setApp(object)}),$(document).on("pinClick",function(event,clickInfo){self.setApp(clickInfo.object,"0.5 0.5 1.0")}),this.onClickObject=function(functionToBind){$(document).on("clickObject",functionToBind)},this.offClickObject=function(functionToBind){$(document).off("clickObject",functionToBind)},this.viewpoints={},this.viewpointsNames={},this.selectedViewpointIdx=0,this.selectedViewpoint=null,this.isFlyingThrough=!1,this.flyThroughTime=1e3,this.flyThrough=function(){self.isFlyingThrough?self.isFlyingThrough=!1:(self.isFlyingThrough=!0,setTimeout(self.flyThroughTick,self.flyThroughTime))},this.flyThroughTick=function(){var newViewpoint=self.selectedViewpointIdx+1;newViewpoint==self.viewpoints.length&&(newViewpoint=0),self.setCurrentViewpoint(self.viewpoints[newViewpoint]),self.isFlyingThrough&&setTimeout(self.flyThroughTick,self.flyThroughTime)},this.getViewpointGroupAndName=function(id){var splitID=id.trim().split("__");if(splitID.length>1)var group=splitID[0].trim(),name=splitID[1].trim();else var name=splitID[0].trim(),group="<uncategorized>";return{group:group,name:name}},this.loadViewpoints=function(){for(var viewpointList=$("viewpoint"),v=0;v<viewpointList.length;v++){var id=viewpointList[v].id.trim();viewpointList[v].def=id;var groupName=self.getViewpointGroupAndName(id);self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=id,self.viewpointsNames[id]=viewpointList[v]}},this.loadViewpoint=null,this.getAxisAngle=function(from,at,look){var x3dfrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),x3dat=new x3dom.fields.SFVec3f(at[0],at[1],at[2]),x3dup=new x3dom.fields.SFVec3f(up[0],up[1],up[2]),viewMat=new x3dom.fields.SFMatrix4f.lookAt(x3dfrom,x3dat,x3dup).inverse(),q=new x3dom.fields.Quaternion(0,0,0,1);return q.setValue(viewMat),q.toAxisAngle()[0].toGL()+q[1]},this.axisAngleToMatrix=function(axis,angle){var mat=new x3dom.fields.SFMatrix4f,cosAngle=Math.cos(angle),sinAngle=Math.sin(angle),t=1-cosAngle,v=axis.normalize();return mat.setFromArray([t*v.x*v.x+cosAngle,t*v.x*v.y+v.z*sinAngle,t*v.x*v.z-v.y*sinAngle,0,t*v.x*v.y-v.z*sinAngle,t*v.y*v.y+cosAngle,t*v.y*v.z+v.x*sinAngle,0,t*v.x*v.z+v.y*sinAngle,t*v.y*v.z-v.x*sinAngle,t*v.z*v.z+cosAngle,0,0,0,0,1]),mat},this.createViewpoint=function(name,from,at,up){var groupName=self.getViewpointGroupAndName(name);if(self.viewpoints[groupName.group]&&self.viewpoints[groupName.group][groupName.name])console.error("Tried to create viewpoint with duplicate name: "+name);else{var newViewPoint=document.createElement("viewpoint");if(newViewPoint.setAttribute("id",name),newViewPoint.setAttribute("def",name),self.scene.appendChild(newViewPoint),from&&at&&up){var q=self.getAxisAngle(from,at,up);newViewpoint.setAttribute("orientation",q.join(","))}self.viewpoints[groupName.group]||(self.viewpoints[groupName.group]={}),self.viewpoints[groupName.group][groupName.name]=name,self.viewpointsNames[name]=newViewPoint}},this.setCurrentViewpointIdx=function(idx){var viewpointNames=Object.keys(self.viewpointsNames);self.setCurrentViewpoint(viewpointNames[idx])},this.setCurrentViewpoint=function(id){if(-1!=Object.keys(self.viewpointsNames).indexOf(id)){var viewpoint=self.viewpointsNames[id];return self.currentViewpoint&&self.currentViewpoint._xmlNode.removeEventListener("viewpointChanged",self.viewPointChanged),self.currentViewpoint=viewpoint._x3domNode,viewpoint.setAttribute("bind",!0),self.getViewArea().resetView(),self.getViewArea()._flyMat=null,viewpoint.addEventListener("viewpointChanged",self.viewPointChanged),self.loadViewpoint=null,viewpoint.appendChild(self.nav),self.runtime.resetExamin(),self.applySettings(),void(id===self.name+"_default"&&(self.defaultShowAll?self.runtime.fitAll():self.reset()))}self.loadViewpoint=id},this.updateSettings=function(settings){settings&&(self.settings=settings)},this.applySettings=function(){self.settings&&("start_all"in self.settings&&(self.defaultShowAll=self.settings.start_all),"speed"in self.settings&&self.setSpeed(self.settings.speed),"avatarHeight"in self.settings&&self.changeAvatarHeight(self.settings.avatarHeight),"visibilityLimit"in self.settings&&self.nav.setAttribute("visibilityLimit",self.settings.visibilityLimit),"zFar"in self.settings&&self.currentViewpoint._xmlNode.setAttribute("zFar",self.settings.zFar),"zNear"in self.settings&&self.currentViewpoint._xmlNode.setAttribute("zNear",self.settings.zNear))},this.lookAtObject=function(obj){self.runtime.fitObject(obj,!0)},this.applyApp=function(nodes,factor,emiss,otherSide){if(otherSide){for(var m_idx=0;m_idx<nodes.length;m_idx++)if(nodes[m_idx]._x3domNode){var origDiff=nodes[m_idx]._x3domNode._vf.backDiffuseColor;nodes[m_idx]._x3domNode._vf.backDiffuseColor.setValues(origDiff.multiply(factor));var origAmb=nodes[m_idx]._x3domNode._vf.backAmbientIntensity;nodes[m_idx]._x3domNode._vf.backAmbientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.backEmissiveColor.setValueByStr(emiss)}}else for(var m_idx=0;m_idx<nodes.length;m_idx++)if(nodes[m_idx]._x3domNode){var origDiff=nodes[m_idx]._x3domNode._vf.diffuseColor;nodes[m_idx]._x3domNode._vf.diffuseColor.setValues(origDiff.multiply(factor));var origAmb=nodes[m_idx]._x3domNode._vf.ambientIntensity;nodes[m_idx]._x3domNode._vf.ambientIntensity=origAmb*factor,nodes[m_idx]._x3domNode._vf.emissiveColor.setValueByStr(emiss)}},this.pickObject={},this.pickPoint=function(x,y){var viewArea=self.getViewArea(),scene=viewArea._scene,oldPickMode=scene._vf.pickMode.toLowerCase();scene._vf.pickMode="idbuf";scene._nameSpace.doc.ctx.pickValue(viewArea,x,y);scene._vf.pickMode=oldPickMode,self.pickObject.pickPos=viewArea._pickingInfo.pickPos,self.pickObject.pickNorm=viewArea._pickingInfo.pickNorm,self.pickObject.pickObj=viewArea._pickingInfo.pickObj,self.pickObject.part=null,self.pickObject.partID=null;var objId=viewArea._pickingInfo.shadowObjectId;if(scene._multiPartMap)for(var mpi=0;mpi<scene._multiPartMap.multiParts.length;mpi++){var mp=scene._multiPartMap.multiParts[mpi];if(objId>mp._minId&&objId<=mp._maxId){var colorMap=mp._inlineNamespace.defMap.MultiMaterial_ColorMap,emissiveMap=mp._inlineNamespace.defMap.MultiMaterial_EmissiveMap,specularMap=mp._inlineNamespace.defMap.MultiMaterial_SpecularMap,visibilityMap=mp._inlineNamespace.defMap.MultiMaterial_VisibilityMap;self.pickObject.part=new x3dom.Parts(mp,[objId-mp._minId],colorMap,emissiveMap,specularMap,visibilityMap),self.pickObject.partID=mp._idMap.mapping[objId-mp._minId].name}}},this.oneGrpNodes=[],this.twoGrpNodes=[],this.setApp=function(group,app){void 0===app&&(app="1.0 0.5 0.0"),self.applyApp(self.oneGrpNodes,2,"0.0 0.0 0.0",!1),self.applyApp(self.twoGrpNodes,2,"0.0 0.0 0.0",!1),self.applyApp(self.twoGrpNodes,2,"0.0 0.0 0.0",!0),self.applyApp(self.diffColorAdded,.5,"0.0 1.0 0.0"),self.applyApp(self.diffColorDeleted,.5,"1.0 0.0 0.0"),group?(self.twoGrpNodes=group.getElementsByTagName("TwoSidedMaterial"),self.oneGrpNodes=group.getElementsByTagName("Material")):(self.oneGrpNodes=[],self.twoGrpNodes=[]),self.applyApp(self.oneGrpNodes,.5,app,!1),self.applyApp(self.twoGrpNodes,.5,app,!1),self.applyApp(self.twoGrpNodes,.5,app,!0),self.viewer.render()},this.evDist=function(evt,posA){return Math.sqrt(Math.pow(posA[0]-evt.position.x,2)+Math.pow(posA[1]-evt.position.y,2)+Math.pow(posA[2]-evt.position.z,2))},this.dist=function(posA,posB){return Math.sqrt(Math.pow(posA[0]-posB[0],2)+Math.pow(posA[1]-posB[1],2)+Math.pow(posA[2]-posB[2],2))},this.rotToRotation=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo);return crossVec.x+" "+crossVec.y+" "+crossVec.z+" "+Math.acos(dot)},this.rotAxisAngle=function(from,to){var vecFrom=new x3dom.fields.SFVec3f(from[0],from[1],from[2]),vecTo=new x3dom.fields.SFVec3f(to[0],to[1],to[2]),dot=vecFrom.dot(vecTo),crossVec=vecFrom.cross(vecTo),qt=new x3dom.fields.Quaternion(crossVec.x,crossVec.y,crossVec.z,1);return qt.w=vecFrom.length()*vecTo.length()+dot,qt.normalize(qt).toAxisAngle()},this.setNavMode=function(mode){if(self.currentNavMode!=mode){if("WAYFINDER"==mode&&waypoint.init(),"WAYFINDER"==self.currentNavMode&&waypoint.close(),"HELICOPTER"==mode){var eye=self.getCurrentViewpointInfo().position;self.nav._x3domNode._vf.typeParams[0]=0,self.nav._x3domNode._vf.typeParams[1]=eye[1]}self.currentNavMode=mode,self.nav.setAttribute("type",mode),"WALK"==mode||"HELICOPTER"==mode?(self.disableClicking(),self.setApp(null)):self.enableClicking(),"WAYFINDER"==mode&&waypoint&&waypoint.resetViewer(),"TURNTABLE"==mode&&self.nav.setAttribute("typeParams","-0.4 60.0 0 3.14 0.00001")}},this.reload=function(){x3dom.reload()},this.startingPoint=[0,0,0],this.setStartingPoint=function(x,y,z){self.startingPoint[0]=x,self.startingPoint[1]=y,self.startingPoint[2]=z},this.defaultOrientation=[0,0,1],this.setStartingOrientation=function(x,y,z){self.defaultOrientation[0]=x,self.defaultOrientation[1]=y,self.defaultOrientation[2]=z},this.setCameraPosition=function(pos){var vpInfo=self.getCurrentViewpointInfo(),viewDir=vpInfo.view_dir,up=vpInfo.up;self.updateCamera(pos,up,viewDir)},this.moveCamera=function(dV){var currentPos=self.getCurrentViewpointInfo().position;currentPos[0]+=dV[0],currentPos[1]+=dV[1],currentPos[2]+=dV[2],self.setCameraPosition(currentPos)},this.setCameraViewDir=function(viewDir,upDir){var currentPos=self.getCurrentViewpointInfo().position;self.updateCamera(currentPos,upDir,viewDir)},this.setCamera=function(pos,viewDir,upDir){self.updateCamera(pos,upDir,viewDir)},this.updateCamera=function(pos,up,viewDir){var x3domView=new x3dom.fields.SFVec3f;x3domView.setValueByStr(normalize(viewDir).join(","));var x3domUp=new x3dom.fields.SFVec3f;x3domUp.setValueByStr(normalize(up).join(","));var x3domFrom=new x3dom.fields.SFVec3f;x3domFrom.setValueByStr(pos.join(","));var x3domAt=x3domFrom.add(x3domView),viewMatrix=x3dom.fields.SFMatrix4f.lookAt(x3domFrom,x3domAt,x3domUp).inverse(),currMatrix=self.getCurrentViewpoint()._x3domNode;if("HELICOPTER"==self.currentNavMode){var angle=Math.acos(x3domUp.y);self.nav._x3domNode._vf.typeParams[0]=angle,self.nav._x3domNode._vf.typeParams[1]=x3domFrom.y}self.getViewArea().animateTo(viewMatrix,currMatrix),self.linked&&self.manager.switchMaster(self.handle)},this.linked=!1,this.linkMe=function(){self.manager&&(self.manager.linkMe(self.handle),self.onViewpointChanged(self.manager.viewpointLinkFunction),self.viewer.addEventListener("mousedown",function(){self.manager.switchMaster(self.handle)}),self.linked=!0)},this.collDistance=.1,this.changeCollisionDistance=function(collDistance){self.collDistance=collDistance,self.nav._x3domNode._vf.avatarSize[0]=collDistance},this.avatarHeight=1.83,this.changeAvatarHeight=function(height){self.avatarHeight=height,self.nav._x3domNode._vf.avatarSize[1]=height},this.stepHeight=.4,this.changeStepHeight=function(stepHeight){self.stepHeight=stepHeight,self.nav._x3domNode._vf.avatarSize[2]=stepHeight},this.reset=function(){self.setCurrentViewpoint("model__start"),self.changeCollisionDistance(self.collDistance),self.changeAvatarHeight(self.avatarHeight),self.changeStepHeight(self.stepHeight)},this.loadURL=function(url){self.inline&&(self.inline.parentNode.removeChild(self.inline),self.inline=null),self.inline=document.createElement("inline"),self.scene.appendChild(self.inline),self.inline.setAttribute("namespacename","model"),self.inline.setAttribute("onload","onLoaded(event);"),self.inline.setAttribute("url",url),self.reload(),self.url=url},this.getRoot=function(){return self.inline},this.getScene=function(){return self.scene},this.getCurrentViewpoint=function(){return self.getViewArea()._scene.getViewpoint()._xmlNode},this.getCurrentViewpointInfo=function(){var viewPoint={},viewMat=(self.getViewArea()._scene.getViewpoint().getCurrentTransform(),self.getViewMatrix().inverse()),viewRight=viewMat.e0(),viewUp=viewMat.e1(),viewDir=viewMat.e2().multiply(-1),viewPos=viewMat.e3(),center=self.getViewArea()._scene.getViewpoint().getCenterOfRotation();if(center)var lookAt=center.subtract(viewPos);else var lookAt=viewPos.add(viewDir);var projMat=self.getProjectionMatrix();viewPoint.up=[viewUp.x,viewUp.y,viewUp.z],viewPoint.position=[viewPos.x,viewPos.y,viewPos.z],viewPoint.look_at=[lookAt.x,lookAt.y,lookAt.z],viewPoint.view_dir=[viewDir.x,viewDir.y,viewDir.z],viewPoint.right=[viewRight.x,viewRight.y,viewRight.z],viewPoint.unityHeight=2/projMat._00,viewPoint.fov=2*Math.atan(1/projMat._00),viewPoint.aspect_ratio=viewPoint.fov/projMat._11;var f=projMat._23/(projMat._22+1),n=f*projMat._23/(projMat._23-2*f);return viewPoint.far=f,viewPoint.near=n,viewPoint.clippingPlanes=self.clippingPlanes,viewPoint},this.speed=2,this.setSpeed=function(speed){self.speed=speed,self.nav.speed=speed},this.bgroundClick=function(event){self.triggerSelected(null)},this.clickObject=function(event,objEvent){objEvent.partID?(objEvent.part.partID=objEvent.partID,self.triggerPartSelected(objEvent.part)):self.triggerSelected(objEvent.target)},this.disableClicking=function(){self.clickingEnabled&&(self.offBackgroundClicked(self.bgroundClick),self.offClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!0),self.clickingEnabled=!1)},this.enableClicking=function(){self.clickingEnabled||(self.onBackgroundClicked(self.bgroundClick),self.onClickObject(self.clickObject),self.viewer.setAttribute("disableDoubleClick",!1),self.clickingEnabled=!0)},this.switchFullScreen=function(vrDisplay){vrDisplay=vrDisplay||{},self.fullscreen?(document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen(),self.fullscreen=!1):(self.viewer.mozRequestFullScreen?self.viewer.mozRequestFullScreen({vrDisplay:vrDisplay}):self.viewer.webkitRequestFullscreen&&self.viewer.webkitRequestFullscreen({vrDisplay:vrDisplay}),self.fullscreen=!0)},this.diffColorDeleted=[],this.diffColorAdded=[],this.setDiffColors=function(diffColors){if(diffColors&&(self.diffColors=diffColors),self.applyApp(self.diffColorAdded,2,"0.0 0.0 0.0",!1),self.applyApp(self.diffColorDeleted,2,"0.0 0.0 0.0",!1),self.diffColorAdded=[],self.diffColorDeleted=[],self.diffColors&&self.inline.childNodes.length){var defMapSearch=self.inline.childNodes[0]._x3domNode._nameSpace.defMap;if(self.diffColors.added)for(var i=0;i<self.diffColors.added.length;i++){var obj=defMapSearch[self.diffColors.added[i]];if(obj){var mat=$(obj._xmlNode).find("Material");if(mat.length)self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0]);else{var mat=$(obj._xmlNode).find("TwoSidedMaterial");self.applyApp(mat,.5,"0.0 1.0 0.0",!1),self.diffColorAdded.push(mat[0])}}}if(self.diffColors.deleted)for(var i=0;i<self.diffColors.deleted.length;i++){var obj=defMapSearch[self.diffColors.deleted[i]];if(obj){var mat=$(obj._xmlNode).find("Material");if(mat.length)self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0]);else{var mat=$(obj._xmlNode).find("TwoSidedMaterial");self.applyApp(mat,.5,"1.0 0.0 0.0",!1),self.diffColorDeleted.push(mat[0])}}}}},this.transformEvent=function(event,viewpoint,inverse){if(inverse)var transformation=viewpoint._x3domNode.getTransformation().inverse();else var transformation=viewpoint._x3domNode.getTransformation();var newPos=transformation.multMatrixVec(event.position),newOrientMat=self.axisAngleToMatrix(event.orientation[0],event.orientation[1]);newOrientMat=transformation.mult(newOrientMat);var newOrient=new x3dom.fields.Quaternion;newOrient.setValue(newOrientMat),newOrient=newOrient.toAxisAngle(),event.position=newPos,event.orientation=newOrient},this.axesMove=function(origEvent,event){event.orientation[1]=-1*event.orientation[1],self.transformEvent(event,event.target,!1),self.axesGroup.setAttribute("rotation",event.orientation.toString())},this.linkAxes=function(){self.onViewpointChanged(self.axesMove)},this.addAxes=function(){var coord=document.createElement("X3D");coord.setAttribute("id","Axes"),coord.setAttribute("showStat","false"),coord.setAttribute("showLog","false"),self.x3ddiv.appendChild(coord);var scene=document.createElement("scene");coord.appendChild(scene);var vp=document.createElement("Viewpoint");vp.setAttribute("position","0.76500 0.765 5.0"),scene.appendChild(vp),self.axesScene=scene,self.axesNav=document.createElement("navigationInfo"),self.axesNav.setAttribute("type","NONE"),scene.appendChild(self.axesNav),self.axesGroup=document.createElement("Transform"),scene.appendChild(self.axesGroup);var x3dFile=document.createElement("inline");x3dFile.setAttribute("url","public/box.x3d"),self.axesGroup.appendChild(x3dFile),self.reload(),self.linkAxes()};var clippingPlaneID=-1;this.clippingPlanes=[],this.setClippingPlanes=function(clippingPlanes){self.clearClippingPlanes();for(var clipidx=0;clipidx<clippingPlanes.length;clipidx++){self.addClippingPlane(clippingPlanes[clipidx].axis,clippingPlanes[clipidx].distance,clippingPlanes[clipidx].clipDirection)}},this.addClippingPlane=function(axis,distance,clipDirection){clippingPlaneID+=1;var newClipPlane=new ClipPlane(clippingPlaneID,self,axis,[1,1,1],distance,clipDirection);return self.clippingPlanes.push(newClipPlane),clippingPlaneID},this.clearClippingPlanes=function(){self.clippingPlanes.forEach(function(clipPlane){clipPlane.destroy(),delete clipPlane}),clippingPlanes=[]},this.getClippingPlane=function(id){return self.clippingPlanes.filter(function(clipPlane){return clipPlane.getID()===id})[0]}},ClipPlane=function(id,viewer,axis,colour,distance,clipDirection){var self=this;this.axis="X",this.clipDirection=void 0===clipDirection?-1:clipDirection,this.distance=void 0===distance?0:distance;var volume=null,clipPlaneElem=document.createElement("ClipPlane"),normal=new x3dom.fields.SFVec3f(0,0,0),coordinateFrame=document.createElement("Transform"),outline=document.createElement("Shape"),outlineApp=document.createElement("Appearance"),outlineMat=document.createElement("Material"),outlineLines=document.createElement("LineSet"),outlineCoords=document.createElement("Coordinate");this.getID=function(){return id};var setOutlineCoordinates=function(){var min=volume.min.toGL(),max=volume.max.toGL(),axisIDX="XYZ".indexOf(self.axis),outline=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],minor=(axisIDX+1)%3,major=(axisIDX+2)%3;outline[0][minor]=min[minor],outline[0][major]=max[major],outline[1][minor]=min[minor],outline[1][major]=min[major],outline[2][minor]=max[minor],outline[2][major]=min[major],outline[3][minor]=max[minor],outline[3][major]=max[major],outline[4][minor]=min[minor],outline[4][major]=max[major],outlineCoords.setAttribute("point",outline.map(function(item){return item.join(" ")}).join(","))};this.movePlane=function(percentage){var axisIDX="XYZ".indexOf(this.axis),min=volume.min.toGL(),max=volume.max.toGL();this.distance=(max[axisIDX]-min[axisIDX])*percentage+min[axisIDX],clipPlaneElem.setAttribute("plane",normal.toGL().join(" ")+" "+this.distance);var translation=[0,0,0];translation[axisIDX]=-this.distance*this.clipDirection,coordinateFrame.setAttribute("translation",translation.join(","))},this.changeAxis=function(axis){this.axis=axis.toUpperCase(),normal.x="X"===axis?this.clipDirection:0,normal.y="Y"===axis?this.clipDirection:0,normal.z="Z"===axis?this.clipDirection:0,this.movePlane(100),setOutlineCoordinates()},this.destroy=function(){clipPlaneElem.parentNode.removeChild(clipPlaneElem),coordinateFrame.parentNode.removeChild(coordinateFrame)},outlineMat.setAttribute("emissiveColor",colour.join(" ")),outlineLines.setAttribute("vertexCount",5),outlineLines.appendChild(outlineCoords),outlineApp.appendChild(outlineMat),outline.appendChild(outlineApp),outline.appendChild(outlineLines),coordinateFrame.appendChild(outline),viewer.getScene().appendChild(coordinateFrame),volume=viewer.runtime.getBBox(viewer.getScene()),this.changeAxis(axis),viewer.getScene().appendChild(clipPlaneElem)},ViewerManager=function(){var self=this;this.defaultViewerHandle=null,this.viewers={},this.x3ddiv=$("#x3d")[0],this.newIdx=0,this.reshape=function(){for(var viewerSize=100/Object.keys(self.viewers).length,idxes=Object.keys(self.viewers),i=0;i<idxes.length;i++){var idx=idxes[i];self.viewers[idx].viewer.style.width=viewerSize+"%",self.viewers[idx].viewer.style.left=i*viewerSize+"%"}},this.close=function(){for(var idxes=Object.keys(self.viewers).slice(0),i=0;i<idxes.length;i++){var handle=parseInt(idxes[i]);self.removeViewer(handle)}},this.addViewer=function(name){return self.newIdx+=1,self.viewers[self.newIdx]=new Viewer(name,self.newIdx,self.x3ddiv,self),self.viewers[self.newIdx].init(),self.reshape(),self.newIdx},this.isValidHandle=function(handle){if(!handle)return!1;var idx=Object.keys(self.viewers).map(function(v){return parseInt(v)}).indexOf(handle);return-1==idx&&console.log("INVALID HANDLE "+handle),idx>-1},this.getHandleByName=function(name){var match=Object.keys(self.viewers).filter(function(v){return self.viewers[v].name==name});return match.length?parseInt(match[0]):null},this.getViewerByName=function(name){var handle=self.getHandleByName(name);return handle?self.viewers[handle]:null},this.getViewer=function(handle){return self.isValidHandle(handle)?self.viewers[handle]:null},this.removeViewer=function(handle){if(self.isValidHandle(handle)){if(1==Object.keys(self.viewers).length)return;self.viewers[handle]==self.viewMaster&&(self.viewMaster=null),self.defaultViewerHandle==handle&&(self.defaultViewerHandle=parseInt(Object.keys(self.viewers)[0])),self.diffHandle==handle&&(self.diffHandle=null),self.linkedViewers=self.linkedViewers.filter(function(idx){return idx!=handle}),self.viewers[handle].close(),delete self.viewers[handle],self.reshape()}},this.linkedViewers=[],this.linkedFunctions=[],this.linkMe=function(handle){self.addMe(self.linkedViewers,handle)},this.viewMaster=null,this.switchMaster=function(handle){self.isValidHandle(handle)&&(self.viewMaster=self.viewers[handle])},this.linkFunction=function(callback){this.linkedFunctions.push(callback)},this.addMe=function(array,handle){self.isValidHandle(handle)&&-1==array.indexOf(handle)&&array.push(handle)},this.viewpointLinkFunction=function(newEvent,event){if(self.linkedViewers.length&&self.viewMaster&&event.target==self.viewMaster.getCurrentViewpoint()){event.orientation[1]=-1*event.orientation[1],self.viewMaster.transformEvent(event,event.target,!1);for(var i=0;i<self.linkedViewers.length;i++){var handle=self.linkedViewers[i];self.viewMaster.handle!=handle&&self.isValidHandle(handle)&&(self.viewers[handle].getCurrentViewpoint().setAttribute("position",event.position.toString()),self.viewers[handle].getCurrentViewpoint().setAttribute("orientation",event.orientation.toString()))}for(var i=0;i<self.linkedFunctions.length;i++)self.linkedFunctions[i](event)}},this.initRuntime=function(){for(handle in self.viewers)self.viewers[handle]&&(self.viewers[handle].runtime||self.viewers[handle].initRuntime())},x3dom.runtime.ready=this.initRuntime,this.diffHandle=null,this.diffView=function(enable){enable?self.isValidHandle(self.diffHandle)||(self.diffHandle=self.addViewer("diffView"),self.getDiffViewer().linkMe(),self.getDefaultViewer().linkMe()):self.isValidHandle(self.diffHandle)&&self.removeViewer(self.diffHandle)},this.setDiffColors=function(diffColors){self.getDefaultViewer().setDiffColors(diffColors),self.getDiffViewer().setDiffColors(diffColors)},this.getDiffViewer=function(){return self.diffHandle?self.viewers[self.diffHandle]:void 0},this.getDefaultViewer=function(){return self.defaultViewerHandle?self.viewers[self.defaultViewerHandle]:void 0},this.loadURL=function(handle,url){if(self.isValidHandle(handle)){var viewer=self.viewers[handle];viewer.loadURL(url)}},this.messageBox=document.createElement("div"),this.messageBox.setAttribute("id","viewerMessageBox"),this.messageBox.className="panel panel-default",this.messageBox.style.display="none",this.messageBoxMessage=document.createElement("p"),this.messageBoxMessage.innerHTML="",this.messageBox.appendChild(this.messageBoxMessage),this.x3ddiv.appendChild(this.messageBox),this.displayMessage=function(text,textColor,timeout){self.messageBoxMessage.innerHTML=text,self.messageBox.style.display="";var rgbstr="RGB("+textColor[0]+", "+textColor[1]+", "+textColor[2]+")";self.messageBox.style.color=rgbstr,setTimeout(function(){self.messageBox.style.display="none"},timeout)},self.defaultViewerHandle=self.addViewer("viewer")};angular.module("3drepo").controller("OculusCtrl",["$scope","StateManager","ViewerService",function($scope,StateManager,ViewerService){$scope.defaultViewer=ViewerService.defaultViewer,$scope.switchVR=function(mode){ViewerService.switchVR()}}]);var Oculus=function(viewer){var self=this;this.rtLeft=null,this.rtRight=null,this.lastW=null,this.lastH=null,this.vrHMD=null,this.vrSensor=null,this.IPD=.0064,this.enabled=!1,this.oculus=null,this.viewer=viewer,this.switchVR=function(){var scene=self.viewer.scene;if(this.enabled)this.oculus.parentNode.removeChild(this.oculus),this.rtLeft=null,this.rtRight=null,this.lastW=null,this.lastH=null,this.IPD=.0064,this.enabled=!1,this.oculus=null,this.enabled=!1,self.viewer.runtime.enterFrame=function(){},self.viewer.runtime.exitFrame=function(){},self.viewer.getViewArea().skipSceneRender=null,self.viewer.switchFullScreen(self.vrHMD),self.viewer.createBackground();else{var eyeGroup=document.createElement("group");eyeGroup.setAttribute("def","oculus"),eyeGroup.setAttribute("render","true"),this.oculus=eyeGroup;var leftEye=document.createElement("group");
leftEye.setAttribute("def","left"),leftEye.setAttribute("render","false"),eyeGroup.appendChild(leftEye);var leftShape=document.createElement("shape");leftShape.setAttribute("isPickable","false"),leftEye.appendChild(leftShape);var leftApp=document.createElement("appearance");leftShape.appendChild(leftApp);var leftTex=document.createElement("renderedtexture");leftTex.setAttribute("id","rtLeft"),leftTex.setAttribute("stereoMode","LEFT_EYE"),leftTex.setAttribute("update","ALWAYS"),leftTex.setAttribute("oculusRiftVersion","2"),leftTex.setAttribute("dimensions","980 1080 3"),leftTex.setAttribute("repeatS","false"),leftTex.setAttribute("repeatT","false"),leftTex.setAttribute("interpupillaryDistance",this.IPD),leftApp.appendChild(leftTex);var leftVP=document.createElement("viewpoint");leftVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),leftVP.setAttribute("containerfield","viewpoint"),leftVP.textContent=" ",leftTex.appendChild(leftVP);var leftBground=document.createElement("background");leftBground.setAttribute("use","viewer_bground"),leftBground.setAttribute("containerfield","background"),leftBground.textContent=" ",leftTex.appendChild(leftBground);var leftScene=document.createElement("group");leftScene.setAttribute("use","model__root"),leftScene.setAttribute("containerfield","scene"),leftTex.appendChild(leftScene);var leftPlane=document.createElement("plane");leftPlane.setAttribute("solid","false"),leftShape.appendChild(leftPlane);var rightEye=document.createElement("group");rightEye.setAttribute("def","right"),rightEye.setAttribute("render","false"),eyeGroup.appendChild(rightEye);var rightShape=document.createElement("shape");rightShape.setAttribute("isPickable","false"),rightEye.appendChild(rightShape);var rightApp=document.createElement("appearance");rightShape.appendChild(rightApp);var rightTex=document.createElement("renderedtexture");rightTex.setAttribute("id","rtRight"),rightTex.setAttribute("stereoMode","RIGHT_EYE"),rightTex.setAttribute("update","ALWAYS"),rightTex.setAttribute("oculusRiftVersion","2"),rightTex.setAttribute("dimensions","980 1080 3"),rightTex.setAttribute("repeatS","false"),rightTex.setAttribute("repeatT","false"),rightTex.setAttribute("interpupillaryDistance",this.IPD),rightApp.appendChild(rightTex);var rightPlane=document.createElement("plane");rightPlane.setAttribute("solid","false"),rightShape.appendChild(rightPlane);var rightVP=document.createElement("viewpoint");rightVP.setAttribute("use",self.viewer.getCurrentViewpoint().getAttribute("id")),rightVP.setAttribute("containerfield","viewpoint"),rightVP.textContent=" ",rightTex.appendChild(rightVP);var rightBground=document.createElement("background");rightBground.setAttribute("use","viewer_bground"),rightBground.setAttribute("containerfield","background"),rightBground.textContent=" ",rightTex.appendChild(rightBground);var rightScene=document.createElement("group");rightScene.setAttribute("use","model__root"),rightScene.setAttribute("containerfield","scene"),rightScene.textContent=" ",rightTex.appendChild(rightScene),scene.appendChild(eyeGroup),leftShape._x3domNode._graph.needCulling=!1,rightShape._x3domNode._graph.needCulling=!1,eyeGroup._x3domNode._graph.needCulling=!1,this.startVR(),self.viewer.switchFullScreen(self.vrHMD),this.enabled=!0}},this.startVR=function(){self.rtLeft=$("#rtLeft")[0],self.rtRight=$("#rtRight")[0],self.lastW=self.viewer.runtime.getWidth(),self.lastH=self.viewer.runtime.getHeight(),self.viewpoint=self.viewer.viewpoint,self.viewer.getViewArea().skipSceneRender=!0,self.viewer.runtime.enterFrame=function(){if(self.vrSensor){var state=self.vrSensor.getState(),h=state.orientation;if(h){var vp=self.viewer.getCurrentViewpoint()._x3domNode,flyMat=vp.getViewMatrix().inverse(),q=new x3dom.fields.Quaternion(h.x,h.y,h.z,h.w);flyMat.setRotate(q),vp.setView(flyMat.inverse())}}},self.viewer.runtime.exitFrame=function(){var w=self.viewer.runtime.getWidth(),h=self.viewer.runtime.getHeight();if(self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(0,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rtLeft._x3domNode._webgl.fbo.tex),self.viewer.runtime.canvas.doc.ctx.stateManager.viewport(w/2,0,w/2,h),self.viewer.viewer.runtime.canvas.doc._scene._fgnd._webgl.render(self.viewer.viewer.runtime.canvas.doc.ctx.ctx3d,self.rtRight._x3domNode._webgl.fbo.tex),w!=self.lastW||h!=self.lastH){var half=Math.round(w/2);self.rtLeft.setAttribute("dimensions",half+" "+h+" 4"),self.rtRight.setAttribute("dimensions",half+" "+h+" 4"),self.lastW=w,self.lastH=h}self.viewer.runtime.triggerRedraw()}},this.changeIPD=function(newIPD){self.rtLeft.setAttribute("interpupillaryDistance",newIPD),self.rtRight.setAttribute("interpupillaryDistance",newIPD)},this.peturbIPD=function(perturbation){var oldDistance=parseFloat(self.rtLeft.getAttribute("interpupillaryDistance"));this.changeIPD(oldDistance+peturbation)},this.exitFullscreen=function(){document.webkitIsFullScreen||document.msFullscreenElement||document.mozFullScreen||self.switchVR()},this.createFullscreenExit=function(){document.addEventListener("webkitfullscreenchange",self.exitFullscreen,!1),document.addEventListener("mozfullscreenchange",self.exitFullscreen,!1),document.addEventListener("fullscreenchange",self.exitFullscreen,!1),document.addEventListener("MSFullscreenChange",self.exitFullscreen,!1)},this.init=function(vrdevs){var i;for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof HMDVRDevice){self.vrHMD=vrdevs[i];break}if(self.vrHMD){for(i=0;i<vrdevs.length;++i)if(vrdevs[i]instanceof PositionSensorVRDevice&&vrdevs[i].hardwareUnitId==self.vrHMD.hardwareUnitId){self.vrSensor=vrdevs[i];break}return self.vrHMD&&self.vrSensor?void 0:void alert("Didn't find a HMD and sensor!")}},navigator.getVRDevices&&navigator.getVRDevices().then(this.init),this.createFullscreenExit()};angular.module("3drepo").controller("NavigationCtrl",["$scope","StateManager","ViewerService",function($scope,StateManager,ViewerService){$scope.defaultViewer=ViewerService.defaultViewer,$scope.setViewerMode=function(mode){$scope.defaultViewer.setNavMode(mode)}}]),angular.module("3drepo").controller("ViewpointCtrl",["$scope","StateManager","ViewerService","$modal","$rootScope",function($scope,StateManager,ViewerService,$modal,$rootScope){$scope.ViewerService=ViewerService,$scope.viewpoints=ViewerService.defaultViewer.viewpoints,$scope.viewpointname="",$scope.sid="",$scope.showAll=function(){ViewerService.defaultViewer.showAll()},$scope.reset=function(){ViewerService.defaultViewer.reset()},$scope.flyThrough=function(){ViewerService.defaultViewer.flyThrough(ViewerService.defaultViewer.viewpoints)},$scope.setCurrentViewpoint=function(id){ViewerService.defaultViewer.setCurrentViewpoint(id)},$scope.newViewpoint=function(){var modalInstance=$modal.open({templateUrl:"newviewpointmodal.html",controller:"DialogCtrl",backdrop:!1,resolve:{params:{name:""}}});modalInstance.result.then(function(params){var thisViewer=ViewerService.defaultViewer,viewpoint=thisViewer.getCurrentViewpointInfo();$("#model__root")[0]._x3domNode.getCurrentTransform().inverse();viewpoint.name=params.name,$scope.sid&&(viewpoint.shared_id=$scope.sid);var cameraPostURL=server_config.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/"+StateManager.state.branch+"/viewpoint");$.ajax({type:"POST",url:cameraPostURL,data:{data:JSON.stringify(viewpoint)},dataType:"json",xhrFields:{withCredentials:!0},success:function(data){console.log("Success: "+data)}})},function(){})},$rootScope.$on("sidNotFound",function(event,args){$scope.sid=args.uuid,$modal.open({templateUrl:"newviewpointinfomodal.html",controller:"DialogCtrl",backdrop:!1,resolve:{params:{}}})}),$scope.ok=function(){$modalInstance.close($scope.selected.item)},$scope.setViewerMode=function(mode){defaultViewer.setNavMode(mode)}}]),angular.module("3drepo").config(["$stateProvider","$locationProvider","parentStates",function($stateProvider,$locationProvider,parentStates){for(var states=parentStates.inspect,i=0;i<states.length;i++)$stateProvider.state(states[i]+".inspect",{url:"/inspect",resolve:{init:function(StateManager){StateManager.refresh("inspect")}}})}]).controller("InspectCtrl",["$scope","StateManager","ViewerService","$window","$modal","$timeout",function($scope,StateManager,ViewerService,$window,$modal,$timeout){$scope.defaultViewer=ViewerService.defaultViewer,$scope.cameraSwitch=!1,$scope.startInspect=function(){StateManager.setStateVar("inspect",!0),StateManager.updateState()},$scope.whereAmI=function(){$modal.open({templateUrl:"cameramodal.html",backdrop:!1}),cameraSwitch=!0}}]).factory("InspectData",function(){var o={captureCamera:!1};return o.refresh=function(){},o}).run(["StateManager",function(StateManager){StateManager.registerPlugin("inspect","InspectData",function(){return StateManager.state.inspect?"inspect":null}),StateManager.setClearStateVars("inspect",["inspect"])}]),angular.module("3drepo").factory("CurrentBranch",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={name:"",revisions:[],n_revisions:0};return o.refresh=function(){var self=this,account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/revisions/"+branch+".json")).then(function(json){self.name=branch,self.revisions=json.data,self.n_revisions=self.revisions.length,deferred.resolve()},function(message){deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").factory("CurrentRevision",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={revision:"",shortName:"",author:"",date:"",message:"",branch:""};return o.refresh=function(){var self=this,deferred=$q.defer(),account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,revision=StateManager.state.revision,baseUrl="";return revision==self.revision?deferred.resolve():(baseUrl=revision&&"head"!=revision?serverConfig.apiUrl(account+"/"+project+"/revision/"+revision):serverConfig.apiUrl(account+"/"+project+"/revision/"+branch+"/head"),$http.get(baseUrl+".json").then(function(json){self.revision=json.data.revision,self.shortName=json.data.revision.substr(0,20)+"...",self.author=json.data.author,self.date=json.data.date,self.message=json.data.message,self.branch=json.data.branch,deferred.resolve()},function(message){deferred.resolve()})),deferred.promise},o}]),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.revision,i=0;i<states.length;i++)$stateProvider.state(states[i]+".branch",{url:"/revision/:branch/head",resolve:{init:function(StateManager,$stateParams){StateManager.setState($stateParams,{}),StateManager.state.revision="head",StateManager.refresh("revision")}}}).state(states[i]+".revision",{url:"/revision/:revision",resolve:{init:function(StateManager,$stateParams){StateManager.setState($stateParams,{}),StateManager.refresh("revision")}}})}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("revision","RevisionData",function(){return StateManager.state.branch&&"head"==StateManager.state.revision?"branch":StateManager.state.revision?"revision":null}),StateManager.setClearStateVars("revision",["revision"]),StateManager.setClearStateVars("branch",["branch"])}]),angular.module("3drepo").factory("RevisionData",["$http","$q","serverConfig","StateManager","Branches","CurrentBranch","CurrentRevision",function($http,$q,serverConfig,StateManager,Branches,CurrentBranch,CurrentRevision){var o={CurrentBranch:CurrentBranch,CurrentRevision:CurrentRevision};return o.genStateName=function(){return StateManager.state.branch&&"head"==StateManager.state.revision?"branch":StateManager.state.revision?"revision":null},o.refresh=function(){var self=this;return $q.all([self.CurrentBranch.refresh(),self.CurrentRevision.refresh()])},o}]),angular.module("3drepo").controller("PanelCtrl",["$scope",function($scope){$scope.toggleLeftPanel=function(){$("#ui2-leftpanel").toggleClass("collapsed")},$scope.toggleRightPanel=function(){$("#ui2-rightpanel").toggleClass("collapsed")}}]),angular.module("3drepo").controller("TreeCtrl",["$scope","TreeService",function($scope,TreeService){$scope.$watchGroup(["state.project","state.branch","state.revision"],function(){TreeService.refresh()}),TreeService.init($("#scenetree"))}]),angular.module("3drepo").service("TreeService",["StateManager","serverConfig",function(StateManager,serverConfig){var self=this;self.rootElement=null,this.getKeyPath=function(obj){return obj.getAttribute("namespacename")?"":"root"==obj.getAttribute("DEF")?obj.parentElement?self.getKeyPath(obj.parentElement):"":self.getKeyPath(obj.parentElement)+"/"+obj.getAttribute("DEF")},this.onlyThis=function(node){var parent=node.getParent();if(null!=parent){for(var siblings=parent.getChildren(),s_idx=0;s_idx<siblings.length;s_idx++)siblings[s_idx]!=node&&siblings[s_idx].setExpanded(!1);self.onlyThis(parent)}},this.clickedFromView=!1,this.loading=!1,this.getProject=function(accountName,projectName){return $("inline").filter(function(){return this.nameSpaceName==accountName+"__"+projectName})},this.getNode=function(node){return"project"in node.data?getProject(node.data.account,node.data.project)[0]:document.getElementById(node.data.namespace+node.data.uuid)},this.treeURL=function(account,project,branch,revision,sid,depth){var newURL="";return newURL+=revision&&"head"!=revision?account+"/"+project+"/revision/"+revision+"/tree/":account+"/"+project+"/revision/"+branch+"/head/tree/",newURL+=sid?sid:"root",newURL+=".json?",depth&&(newURL+="depth="+depth+"&"),newURL+="htmlMode=true",serverConfig.apiUrl(newURL)},this.onObjectSelected=function(object){var tree=self.rootElement.fancytree("getTree");if(object)tree.loadKeyPath(self.getKeyPath(object),function(node,status){"ok"===status&&(self.clickedFromView=!0,self.onlyThis(node),node.setActive())});else{var rootNode=self.rootElement.fancytree("getRootNode");rootNode.setActive(!1),rootNode.setExpanded(!1)}},this.onPartSelected=function(objEvent){},this.wasPartSelect=!1,this.init=function(rootElement){if(!self.intialized){var account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,revision=StateManager.state.revision;self.rootElement=rootElement,self.rootElement.fancytree({selectMode:3,beforeSelect:function(event,data){self.wasPartSelect=data.node.partsel},select:function(event,data){self.getNode(data.node).setAttribute("render",data.node.selected);var parent=data.node.getParent();if(data.node.selected&&data.node.selected!=parent.selected){for(var par_node=parent;null!=par_node;)self.getNode(par_node).setAttribute("render",!0),par_node=par_node.getParent();for(var siblings=data.node.getParent().getChildren(),sib_idx=0;sib_idx<siblings.length;sib_idx++)self.getNode(siblings[sib_idx]).setAttribute("render",!1)}},activate:function(event,data){if("uuid"in data.node.data){var rootObj=self.getNode(data.node);$(document).trigger("objectSelected",[rootObj,!self.clickedFromView])}self.clickedFromView=!1},source:{url:self.treeURL(account,project,branch,revision,null,null)},checkbox:!0,lazyLoad:function(event,data){var node=data.node;if("project"in node.data)var params={selected:node.selected,namespace:node.data.namespace},json_key="root";else var params={mode:"children",selected:node.selected,namespace:node.data.namespace},json_key=node.key;params.depth=1,data.result=$.ajax({url:self.treeURL(account,node.data.dbname,node.data.branch,node.data.revision,json_key,null),data:params,cache:!1})}}),$(document).on("objectSelected",function(event,object,zoom){self.onObjectSelected(object)}),$(document).on("partSelected",function(event,objEvent,zoom){self.onPartSelected(objEvent)})}},this.refresh=function(){if(self.rootElement){var account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,revision=StateManager.state.revision,newURL=self.treeURL(account,project,branch,revision,null),tree=self.rootElement.fancytree("getTree");self.loading||(self.loading=!0,tree.getRootNode().isLoading()||(self.loadingPromise=tree.reload({url:newURL}).done(function(){self.loading=!1})))}}}]);var TreeControl=function(){this.getKeyPath=function(obj){return obj.hasAttribute("namespacename")&&"model"==obj.getAttribute("namespacename")?"":this.getKeyPath(obj.parentElement)+"/"+obj.getAttribute("DEF")},this.onlyThis=function(node){var parent=node.getParent();if(null!=parent){for(var siblings=parent.getChildren(),s_idx=0;s_idx<siblings.length;s_idx++)siblings[s_idx]!=node&&siblings[s_idx].setExpanded(!1);this.onlyThis(parent)}},this.clickedFromView=!1,this.loading=!1};$(document).on("bgroundClicked",function(event){var rootNode=$("#scenetree").fancytree("getRootNode");rootNode.setExpanded(!1)}),$(document).on("clickObject",function(event,objEvent){var tree=$("#scenetree").fancytree("getTree");tree.loadKeyPath(treeCtrl.getKeyPath(objEvent.target),function(node,status){"ok"===status&&(treeCtrl.clickedFromView=!0,treeCtrl.onlyThis(node),node.setActive())})});var initTree=function(account,project,branch,revision){window.treeCtrl=new TreeControl,$("#scenetree").fancytree({selectMode:3,beforeSelect:function(event,data){window.wasPartSelect=data.node.partsel},select:function(event,data){getNode(data.node).setAttribute("render",data.node.selected);var parent=data.node.getParent();if(data.node.selected&&data.node.selected!=parent.selected){for(var par_node=parent;null!=par_node;)getNode(par_node).setAttribute("render",!0),par_node=par_node.getParent();for(var siblings=data.node.getParent().getChildren(),sib_idx=0;sib_idx<siblings.length;sib_idx++)getNode(siblings[sib_idx]).setAttribute("render",!1)}},activate:function(event,data){if("uuid"in data.node.data){var rootObj=getNode(data.node);viewer.selectGroup(rootObj,!treeCtrl.clickedFromView)}if("meta"in data.node.data&&data.node.data.meta.length){$("#meta-popup").css("visibility","visible"),$("#metadata").remove(),$("#meta-popup").append('<table id="metadata"></div>'),$("#metadata").append('<tr><th c class="metadata-title" colspan="2">'+data.node.title+"</th></tr>");for(var metaObj={},i=0;i<data.node.data.meta.length;i++)$.extend(metaObj,data.node.data.meta[i].metadata);Object.keys(metaObj).forEach(function(key){$("#metadata").append('<tr><td class="metadata-row">'+key+'</td><td class="metadata-row">'+metaObj[key]+"</td></tr>")})}else $("#meta-popup").css("visibility","hidden");treeCtrl.clickedFromView=!1},source:{url:treeURL(account,project,branch,revision,null,null)},checkbox:!0,lazyLoad:function(event,data){var node=data.node;if("project"in node.data)var params={selected:node.selected,namespace:node.data.namespace},json_key="root";else var params={mode:"children",selected:node.selected,namespace:node.data.namespace},json_key=node.key;params.depth=1,data.result=$.ajax({url:treeURL(account,node.data.dbname,node.data.branch,node.data.revision,json_key,null),data:params,cache:!1})}})};angular.module("3drepo").controller("MetaCtrl",["$scope","MetaService","$modal",function($scope,MetaService,$modal){$scope.MetaService=MetaService,$scope.pdf={},$(document).on("objectSelected",function(event,object,zoom){object&&MetaService.getObjectMetaData(object)}),$scope.openPDF=function(pdfURL){$scope.pdfURL=pdfURL;$modal.open({templateUrl:"pdfviewer.html",controller:"DialogCtrl",backdrop:!1,size:"lg",resolve:{params:function(){return{pdfURL:$scope.pdfURL}}}})}}]),angular.module("3drepo").service("MetaService",["StateManager","serverConfig","$http","$q",function(StateManager,serverConfig,$http,$q){var self=this;self.rootElement=null,self.metadocs={},self.loadingPromise=null,self.loading=!1,self.currentLoadingID=null,this.getObjectMetaData=function(object){var account=StateManager.state.account,objectIDParts=object.id.split("__"),numIDParts=objectIDParts.length,project=objectIDParts[numIDParts-2];"model"==project&&(project=StateManager.state.project);var uid=objectIDParts[numIDParts-1],baseUrl=serverConfig.apiUrl(account+"/"+project+"/meta/"+uid+".json");if(self.loading)uid!=self.currentLoadingID&&self.loadingPromise.then(function(res){self.getObjectMetaData(object)});else{self.loading=!0,self.currentLoadingID=uid;var deferred=$q.defer();self.loadingPromise=deferred.promise,self.metadocs={},$http.get(baseUrl).then(function(json){for(var meta=json.data.meta,i=0;i<meta.length;i++){var subtype=meta[i].mime?meta[i].mime:"metadata";self.metadocs[subtype]||(self.metadocs[subtype]=[]);var baseUrl=serverConfig.apiUrl(account+"/"+project+"/"+meta[i]._id+".pdf");meta[i].url=baseUrl,self.metadocs[subtype].push(meta[i])}self.loading=!1,self.currentLoadingID=null,deferred.resolve()},function(message){self.loading=!1,self.currentLoadingID=null,deferred.resolve()})}}}]),angular.module("3drepo").controller("IssuesCtrl",["$scope","$modal","StateManager","IssuesService","$rootScope","$http","$q","serverConfig","ViewerService",function($scope,$modal,StateManager,IssuesService,$rootScope,$http,$q,serverConfig,ViewerService){$scope.objectIsSelected=!1,$scope.currentSelected=null,$scope.mapPromise=null,$scope.map={},$scope.IssuesService=IssuesService,$scope.chat_updated=$scope.IssuesService.updated,$scope.newComment={},$scope.newComment.text="",$scope.pickedPos=null,$scope.pickedNorm=null,$scope.expanded=$scope.IssuesService.expanded,$(document).on("objectSelected",function(event,object,zoom){$scope.objectIsSelected=!(void 0===object),$scope.selectedID=object.getAttribute("DEF")}),$(document).on("partSelected",function(event,part,zoom){$scope.objectIsSelected=!(void 0===part),$scope.IssuesService.mapPromise.then(function(){$scope.selectedID=$scope.IssuesService.IDMap[part.partID]})}),$scope.openIssue=function(issue){$scope.IssuesService.getIssue(issue.account,issue.project,issue._id),$scope.newComment.text="";var newPos=issue.viewpoint.position,newViewDir=issue.viewpoint.view_dir,newUpDir=issue.viewpoint.up;ViewerService.defaultViewer.setCamera(newPos,newViewDir,newUpDir),$scope.expanded[issue._id]?$(document).trigger("pinClick",{fromViewer:!1,object:null}):$(document).trigger("pinClick",{fromViewer:!1,object:$("#"+issue._id)[0]})},$scope.addNewComment=function(issue){$scope.IssuesService.postComment(issue.account,issue.project,issue._id,issue.parent,$scope.newComment.text).then(function(){setTimeout(function(){$scope.$apply()},0)}),$scope.newComment.text=""},$scope.complete=function(issue){var issueObject={_id:issue.id,complete:!0};$scope.postComment(issueObject)},$scope.drawPin=function(){$scope.currentSelected&&$scope.IssuesService.drawPin($scope.pickedPos,$scope.pickedNorm,$scope.currentSelected._xmlNode)},$scope.newIssue=function(){if($scope.selectedID){var modalInstance=$modal.open({templateUrl:"newissuemodal.html",controller:"DialogCtrl",backdrop:!1,resolve:{params:{name:"",pickedObj:$scope.pickedObj}}});modalInstance.result.then(function(params){var account=StateManager.state.account,project=StateManager.state.project,sid=$scope.selectedID;position=$scope.pickedPos,norm=$scope.pickedNorm,$scope.IssuesService.newIssue(account,project,params.name,sid,position,norm,sid)},function(){})}},$scope.$watchGroup(["StateManager.state.branch","StateManager.state.revision"],function(){StateManager.state.account,StateManager.state.project;return $scope.IssuesService.getIssueStubs()})}]).directive("simpleDraggable",["ViewerService",function(ViewerService){return{restrict:"A",link:function(scope,element,attrs){angular.element(element).attr("draggable","true"),element.bind("dragend",function(event){var dragEndX=event.clientX-screen.availLeft,dragEndY=event.clientY,pickObj=ViewerService.pickPoint(dragEndX,dragEndY);pickObj.partID?scope.selectedID=scope.IssuesService.IDMap[pickObj.partID]:scope.selectedID=pickObj.pickObj._xmlNode.getAttribute("DEF"),scope.pickedPos=pickObj.pickPos,scope.pickedNorm=pickObj.pickNorm,scope.newIssue()})}}}]),angular.module("3drepo").service("IssuesService",["StateManager","Auth","serverConfig","$http","$q","$rootScope","ViewerService",function(StateManager,Auth,serverConfig,$http,$q,$rootScope,ViewerService){var self=this;self.issues={},self.issueContents={},self.loadingPromise=null,self.loading=!1,self.pinPositions=[],self.pinNamespaces={},self.io=io(serverConfig.chatHost,{path:serverConfig.chatPath}),self.draggedPin=null,self.pinCoverage=15,self.pinRadius=.25,self.pinHeight=1,self.currentOpenIssue=null,self.expanded={};var mapDeferred=$q.defer(),mapResolved=!1;self.mapPromise=mapDeferred.promise,self.IDMap={},self.SIDMap={},self.switchCollapse=function(issueId){self.currentOpenIssue==issueId?self.expanded[self.currentOpenIssue]=!self.expanded[self.currentOpenIssue]:(self.currentOpenIssue&&(self.expanded[self.currentOpenIssue]=!1),issueId&&(self.currentOpenIssue=issueId,self.expanded[self.currentOpenIssue]=!0))},$(document).on("pinClick",function(event,clickInfo){var issueId=clickInfo.object?clickInfo.object.id:null;self.switchCollapse(issueId),clickInfo.fromViewer&&$rootScope.$apply()}),self.io.on("new_issue",function(data){self.issues[data.project]||(self.issues[data.project]={}),self.issues[data.project][data._id]||(self.issues[data.project][data._id]=data,$rootScope.$apply())}),self.io.on("post_comment",function(data){self.issueContents[data._id]||(self.issueContents[data._id]=[]),self.issueContents[data._id].push(data),$rootScope.$apply()}),self.prepareIssue=function(issue){return"comments"in issue||(issue.comments=[]),issue},self.newIssue=function(account,project,name,sid,pickedPos,pickedNorm){var deferred=$q.defer(),newIssueObject={},currentVP=ViewerService.defaultViewer.getCurrentViewpointInfo();if(newIssueObject.name=name,newIssueObject.viewpoint=currentVP,newIssueObject.scale=1,pickedPos){newIssueObject.position=pickedPos.toGL(),newIssueObject.norm=pickedNorm.toGL();var vp=new x3dom.fields.SFVec3f(0,0,0);vp.setValueByStr(currentVP.position.join(" "));var pp=new x3dom.fields.SFVec3f;pp.setValueByStr(newIssueObject.position.join(" "));var pn=new x3dom.fields.SFVec3f;pn.setValueByStr(newIssueObject.norm.join(" ")),pp=pp.add(pn.multiply(self.pinHeight));var dist=pp.subtract(vp).length(),pixelViewRatio=currentVP.unityHeight/ViewerService.defaultViewer.getViewArea()._height,pinPixelSize=2*self.pinRadius/(pixelViewRatio*dist),scale=self.pinCoverage/pinPixelSize;newIssueObject.scale=scale}var issuePostURL=serverConfig.apiUrl(account+"/"+project+"/issues/"+sid);return $.ajax({type:"POST",url:issuePostURL,data:{data:JSON.stringify(newIssueObject)},dataType:"json",xhrFields:{withCredentials:!0},success:function(data){if(newIssueObject._id=data.issue_id,newIssueObject.account=account,newIssueObject.project=project,newIssueObject.owner=Auth.username,newIssueObject.parent=sid,newIssueObject.number=data.number,newIssueObject=self.prepareIssue(newIssueObject),self.issues[project]||(self.issues[project]={}),self.issues[project][newIssueObject._id]=newIssueObject,self.io.emit("new_issue",newIssueObject),pickedPos){var pinObj={id:newIssueObject._id,position:newIssueObject.position,norm:newIssueObject.norm,parent:newIssueObject.parent,scale:newIssueObject.scale};self.draggedPin=null,self.pinPositions.push(pinObj),self.addPin(pinObj)}$rootScope.$apply(),deferred.resolve()}}),deferred.promise},self.drawPin=function(position,norm,parentTrans){if(!self.draggedPin){var pinObj={parent:parentTrans.getAttribute("DEF"),position:position.toGL(),norm:norm.toGL()};self.draggedPin=self.addPin(pinObj)}var pinNamespace=parentTrans.parentNode._x3domNode._nameSpace.name,parentSize=parentTrans.parentNode._x3domNode._graph.volume.max.subtract(parentTrans.parentNode._x3domNode._graph.volume.min).length(),pinSize=parentSize/10;self.pinNamespaces[pinNamespace]||self.prepareX3DScene(pinNamespace,.25,.1,1),self.draggedPin.setAttribute("scale",pinSize+" "+pinSize+" "+pinSize),self.draggedPin.setAttribute("translation",position.toGL().join(","));var axisAngle=ViewerService.defaultViewer.rotAxisAngle([0,1,0],norm.toGL());self.draggedPin.setAttribute("rotation",axisAngle.toGL().join(","))},self.postComment=function(account,project,id,sid,comment){var deferred=$q.defer(),issuePostURL=serverConfig.apiUrl(account+"/"+project+"/issues/"+sid),issueObject={_id:id,comment:comment};return $.ajax({type:"POST",url:issuePostURL,data:{data:JSON.stringify(issueObject)},dataType:"json",xhrFields:{withCredentials:!0},success:function(data){issueObject.owner=Auth.username,self.issueContents[data.issue_id]||(self.issueContents[data.issue_id]=[]),self.issueContents[data.issue_id].push(issueObject),issueObject.account=account,issueObject.project=project,self.io.emit("post_comment",issueObject),deferred.resolve()}}),deferred.promise},self.getIssue=function(account,project,id){if(id in self.issueContents)return $q.when();var deferred=$q.defer(),baseUrl=serverConfig.apiUrl(account+"/"+project+"/issue/"+id+".json");return $http.get(baseUrl).then(function(json){self.issueContents[id]=json.data[0].comments,self.io.emit("open_issue",{project:project,account:account,issue_id:id}),deferred.resolve()},function(message){deferred.resolve()}),deferred.promise},self.getIssueStubs=function(){var account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,revision=StateManager.state.revision,baseUrl=serverConfig.apiUrl(account+"/"+project+"/issues.json");if(!self.loading){var deferred=$q.defer();self.loadingPromise=deferred.promise,self.loading=!0,self.issues={},$http.get(baseUrl).then(function(json){for(var i=0;i<json.data.length;i++){var issue=self.prepareIssue(json.data[i]);if(self.issues[issue.project]||(self.issues[issue.project]={}),self.issues[issue.project][issue._id]=issue,!issue.complete&&issue.position){var pinObj={id:issue._id,position:issue.position,norm:issue.norm,scale:issue.scale,parent:issue.parent};self.pinPositions.push(pinObj)}}if("head"==revision||branch&&!revision)var baseUrl=serverConfig.apiUrl(account+"/"+project+"/revision/"+branch+"/head/map.json");else var baseUrl=serverConfig.apiUrl(account+"/"+project+"/revision/"+revision+"/map.json");mapResolved||$http.get(baseUrl).then(function(json){self.SIDMap=json.data.map,self.IDMap=json.data.invMap,mapResolved=!0,mapDeferred.resolve()},function(message){mapDeferred.reject()}),ViewerService.ready.then(function(){for(var i=0;i<self.pinPositions.length;i++)self.addPin(self.pinPositions[i])}),self.io.emit("watch_project",{account:account,project:project}),self.loading=!1,deferred.resolve()},function(message){self.loading=!1,deferred.resolve()})}return self.loadingPromise},self.addPin=function(pin){var pinPlacement=document.createElement("Transform"),position=new x3dom.fields.SFVec3f(pin.position[0],pin.position[1],pin.position[2]);pinPlacement.setAttribute("translation",position.toString());var norm=new x3dom.fields.SFVec3f(pin.norm[0],pin.norm[1],pin.norm[2]),axisAngle=ViewerService.defaultViewer.rotAxisAngle([0,1,0],norm.toGL());return pinPlacement.setAttribute("rotation",axisAngle.toString()),self.createPinShape(pinPlacement,pin.id,self.pinRadius,self.pinHeight,pin.scale),$("#model__root")[0].appendChild(pinPlacement),pinPlacement},self.createPinShape=function(parent,id,radius,height,scale){var coneHeight=height-radius,pinshape=document.createElement("Group");pinshape.setAttribute("id",id),pinshape.setAttribute("onclick","clickPin(event)");var pinshapeapp=document.createElement("Appearance");pinshape.appendChild(pinshapeapp);var pinshapedepth=document.createElement("DepthMode");pinshapedepth.setAttribute("depthFunc","ALWAYS"),pinshapedepth.setAttribute("enableDepthTest",!1),pinshapeapp.appendChild(pinshapedepth);var pinshapemat=document.createElement("Material");pinshapemat.setAttribute("diffuseColor","1.0 0.0 0.0"),pinshapeapp.appendChild(pinshapemat);var pinshapescale=document.createElement("Transform");pinshapescale.setAttribute("scale",scale+" "+scale+" "+scale),pinshape.appendChild(pinshapescale);
var pinshapeconetrans=document.createElement("Transform");pinshapeconetrans.setAttribute("translation","0.0 "+.5*coneHeight+" 0.0"),pinshapescale.appendChild(pinshapeconetrans);var pinshapeconerot=document.createElement("Transform");pinshapeconerot.setAttribute("rotation","1.0 0.0 0.0 3.1416"),pinshapeconetrans.appendChild(pinshapeconerot);var pinshapeconeshape=document.createElement("Shape");pinshapeconerot.appendChild(pinshapeconeshape);var pinshapecone=document.createElement("Cone");pinshapecone.setAttribute("bottomRadius",.5*radius),pinshapecone.setAttribute("height",coneHeight);var coneApp=pinshapeapp.cloneNode(!0);pinshapeconeshape.appendChild(pinshapecone),pinshapeconeshape.appendChild(coneApp);var pinshapeballtrans=document.createElement("Transform");pinshapeballtrans.setAttribute("translation","0.0 "+coneHeight+" 0.0"),pinshapescale.appendChild(pinshapeballtrans);var pinshapeballshape=document.createElement("Shape");pinshapeballtrans.appendChild(pinshapeballshape);var pinshapeball=document.createElement("Sphere");pinshapeball.setAttribute("radius",radius);var ballApp=pinshapeapp.cloneNode(!0);pinshapeballshape.appendChild(pinshapeball),pinshapeballshape.appendChild(ballApp),parent.appendChild(pinshape)},self.prepareX3DScene=function(namespace,radius,scale,height){var namespaceNode=$("[namespacename="+namespace+"]")[0];self.pinNamespaces[namespace]=namespaceNode,self.createPinShape(namespaceNode.childNodes[0],radius,scale,height)}}]),angular.module("3drepo").factory("Branches",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={};return o.refresh=function(){var self=this,account=StateManager.state.account,project=StateManager.state.project;self.branches=[];var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/branches.json")).then(function(json){self.branches=json.data.map(function(item){return"00000000-0000-0000-0000-000000000000"==item.name?"master":item.name}),deferred.resolve()},function(message){deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").run(["StateManager",function(StateManager){StateManager.registerPlugin("revision","SelectorData")}]).controller("SelectorCtrl",["$scope","StateManager","serverConfig","$q","$http",function($scope,StateManager,serverConfig,$q,$http){$scope.setBranch=function(branch){StateManager.setStateVar("branch",branch),StateManager.updateState()},$scope.setRevision=function(rev){StateManager.setStateVar("revision",rev.name),StateManager.updateState()}}]),angular.module("3drepo").factory("SelectorData",["$http","$q","serverConfig","StateManager","Branches",function($http,$q,serverConfig,StateManager,Branches){var o={Branches:Branches};return o.genStateName=function(){return null},o.refresh=function(){var self=this;self.Branches.refresh()},o}]),angular.module("3drepo").controller("DiffSelectorCtrl",["$scope","StateManager","DiffViewerService",function($scope,StateManager,DiffViewerService){$scope.diffEnabled=!1,$scope.setDiffBranch=function(branch){StateManager.setStateVar("diffbranch",branch),StateManager.updateState(),$scope.diffEnabled=!0},$scope.setDiffRevision=function(rev){StateManager.setStateVar("diffrevision",rev.name),StateManager.updateState(),$scope.diffEnabled=!0},$scope.toggleDiff=function(){$scope.diffEnabled?($scope.diffEnabled=!1,StateManager.setStateVar("diffbranch",null),StateManager.setStateVar("diffrevision",null),StateManager.updateState()):($scope.diffEnabled=!0,StateManager.setStateVar("diffbranch","master"),StateManager.setStateVar("diffrevision","head"),StateManager.updateState())},$scope.$watchGroup(["state.project"],function(){StateManager.state.diffbranch?$scope.diffEnabled=!0:$scope.diffEnabled=!1,DiffViewerService.switchDiff($scope.diffEnabled)}),$scope.$watchGroup(["state.diffbranch","state.diffrevision"],function(){DiffViewerService.switchDiff($scope.diffEnabled),$scope.diffEnabled&&(DiffViewerService.loadModel(),DiffViewerService.diffViewer.setNavMode("TURNTABLE"))})}]),angular.module("3drepo").service("DiffViewerService",["StateManager","serverConfig","ViewerService",function(StateManager,serverConfig,ViewerService){var self=this;self.diffViewer=null,this.switchDiff=function(enable){ViewerService.viewerManager.diffView(enable),self.diffViewer=ViewerService.viewerManager.getDiffViewer()},this.loadModel=function(){var branch=StateManager.state.diffbranch?StateManager.state.diffbranch:"master",revision=StateManager.state.diffrevision?StateManager.state.diffrevision:"head",url=null;url="head"==revision?serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+branch+"/head.x3d.src"):serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+revision+".x3d.src"),self.diffViewer.loadURL(url)}}]),angular.module("3drepo").controller("ClipCtrl",["$scope","ViewerService",function($scope,ViewerService){$scope.sliderMaxValue=1e3,$scope.clipPlaneID=-1,$scope.slider=$scope.sliderMaxValue,$scope.pdf={},$scope.addClipPlane=function(){$scope.clipPlaneID=ViewerService.defaultViewer.addClippingPlane("X")},$scope.changeAxis=function(axs){var clipPlane=ViewerService.defaultViewer.getClippingPlane($scope.clipPlaneID);clipPlane||($scope.addClipPlane(),clipPlane=ViewerService.defaultViewer.getClippingPlane($scope.clipPlaneID)),clipPlane.changeAxis(axs),$scope.slider=$scope.sliderMaxValue},$scope.$watch("slider",function(){var clipPlane=ViewerService.defaultViewer.getClippingPlane($scope.clipPlaneID);clipPlane&&clipPlane.movePlane($scope.slider/$scope.sliderMaxValue)}),$scope.openPDF=function(pdfURL){$scope.pdfURL=pdfURL;$modal.open({templateUrl:"pdfviewer.html",controller:"DialogCtrl",backdrop:!1,size:"lg",resolve:{params:function(){return{pdfURL:$scope.pdfURL}}}})}}]),angular.module("3drepo").service("MetaService",["StateManager","serverConfig","$http","$q",function(StateManager,serverConfig,$http,$q){var self=this;self.rootElement=null,self.metadocs={},self.loadingPromise=null,self.loading=!1,self.currentLoadingID=null,this.getObjectMetaData=function(object){var account=StateManager.state.account,objectIDParts=object.id.split("__"),project=objectIDParts[0];"model"==project&&(project=StateManager.state.project);var uid=objectIDParts[1],baseUrl=serverConfig.apiUrl(account+"/"+project+"/meta/"+uid+".json");if(self.loading)uid!=self.currentLoadingID&&self.loadingPromise.then(function(res){self.getObjectMetaData(object)});else{self.loading=!0,self.currentLoadingID=uid;var deferred=$q.defer();self.loadingPromise=deferred.promise,self.metadocs={},$http.get(baseUrl).then(function(json){for(var meta=json.data.meta,i=0;i<meta.length;i++){var subtype=meta[i].mime?meta[i].mime:"metadata";self.metadocs[subtype]||(self.metadocs[subtype]=[]);var baseUrl=serverConfig.apiUrl(account+"/"+project+"/"+meta[i]._id+".pdf");meta[i].url=baseUrl,self.metadocs[subtype].push(meta[i])}self.loading=!1,self.currentLoadingID=null,deferred.resolve()},function(message){self.loading=!1,self.currentLoadingID=null,deferred.resolve()})}}}]),angular.module("3drepo").factory("CurrentDiffBranch",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={name:"",revision:[],n_revision:0};return o.refresh=function(account,project,branch){var self=this,account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.branch,deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/revisions/"+branch+".json")).then(function(json){self.name=branch,self.revisions=json.data,self.n_revisions=self.revisions.length,deferred.resolve()},function(message){deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").factory("CurrentDiffRevision",["$http","$q","serverConfig","StateManager",function($http,$q,serverConfig,StateManager){var o={name:"",shortName:"",author:"",date:"",message:"",branch:""};return o.refresh=function(account,project,branch,revision){var self=this,account=StateManager.state.account,project=StateManager.state.project,branch=StateManager.state.diffbranch,revision=StateManager.state.diffrevision,deferred=$q.defer(),baseUrl="";return baseUrl="head"==revision?serverConfig.apiUrl(account+"/"+project+"/revision/"+branch+"/"+revision):serverConfig.apiUrl(account+"/"+project+"/revision/"+revision),$http.get(baseUrl+".json").then(function(json){self.revision=json.data.revision,self.shortName=json.data.revision.substr(0,20)+"...",self.author=json.data.author,self.data=json.data.date,self.message=json.data.message,self.branch=json.data.branch,deferred.resolve()},function(message){deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.diff,i=0;i<states.length;i++)$stateProvider.state(states[i]+".diffbranch",{url:"/diff/branch/:diffbranch/head",resolve:{init:function(StateManager,$stateParams){StateManager.setState($stateParams,{}),StateManager.refresh("diff")}}}).state(states[i]+".diffrevision",{url:"/diff/revision/:diffrevision",resolve:{init:function(StateManager,$stateParams){StateManager.setState($stateParams,{}),StateManager.refresh("diff")}}})}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("diff","DiffData",function(){return!StateManager.state.diffrevision&&StateManager.state.diffbranch&&(StateManager.state.diffrevision="head"),StateManager.state.diffbranch&&"head"==StateManager.state.diffrevision?"diffbranch":StateManager.state.diffrevision?"diffrevision":null}),StateManager.setClearStateVars("diffrevision",["diffrevision"]),StateManager.setClearStateVars("diffbranch",["diffbranch"])}]),angular.module("3drepo").factory("DiffData",["$q","$http","serverConfig","StateManager","ViewerService","CurrentDiffBranch","CurrentDiffRevision",function($q,$http,serverConfig,StateManager,ViewerService,CurrentDiffBranch,CurrentDiffRevision){var o={CurrentDiffBranch:CurrentDiffBranch,CurrentDiffRevision:CurrentDiffRevision};return o.refresh=function(){var self=this;return $q.all([self.CurrentDiffBranch.refresh(),self.CurrentDiffRevision.refresh()]).then(function(){var baseUrl=serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+StateManager.Data.RevisionData.CurrentRevision.revision+"/diff/"+self.CurrentDiffRevision.revision+".json");$http.get(baseUrl,{withCredentials:!0}).then(function(json){var diffColors={added:json.data.added,modified:json.data.modified,deleted:json.data.deleted};ViewerService.viewerManager.setDiffColors(diffColors)})})},o}]),angular.module("3drepo").factory("Comments",["$http","$q","serverConfig",function($http,$q,serverConfig){var o={};return o.getNumberOfComments=function(account,project){var self=this;self.n_comments=0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/comments.json?mode=number")).then(function(json){self.n_comments=json.data.n_comments,deferred.resolve(self.n_comments)},function(json){deferred.resolve(0)}),deferred.promise()},o.refresh=function(account,project,first,last){var self=this;self.comments=[],self.loading=!0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/comments.json?start="+first+"&end="+last+"&full=true")).then(function(json){self.comments=json.data,self.n_comments=self.comments.length,self.loading=!1,deferred.resolve()},function(json){deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").factory("Log",["$http","$q","serverConfig",function($http,$q,serverConfig){var o={};return o.getNumberOfLogEntries=function(account,project){var self=this;self.n_logentries=0,self.loading=!0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/log.json?mode=number")).then(function(json){self.n_logentries=json.data.n_logentries,self.loading=!1,deferred.resolve(self.n_logentries)},function(json){deferred.resolve(0)}),deferred.promise},o.refresh=function(account,project,first,last){var self=this;self.log=[],self.n_log=0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/log.json?first="+first+"&last="+last)).then(function(json){self.log=json.data,self.loading=!1,deferred.resolve()},function(message){self.loading=!1,deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").factory("Readme",["$http","$q","serverConfig",function($http,$q,serverConfig){var o={};return o.defaultReadme="[Missing Readme]",o.refresh=function(account,project,branch,revision){var self=this;self.text="";var deferred=$q.defer(),newURL="";return newURL+=branch?account+"/"+project+"/revision/"+branch+"/head":account+"/"+project+"/revision/"+revision,$http.get(serverConfig.apiUrl(newURL+"/readme.json")).then(function(json){self.text=json.data.readme,deferred.resolve()},function(json){self.text=self.defaultReadme,deferred.resolve()}),deferred.promise},o}]).directive("markdown",function(){var converter=new Showdown.converter;return{restrict:"A",link:function(scope,element,attrs){function renderMarkdown(){var htmlText=converter.makeHtml(scope.$eval(attrs.markdown)||"");element.html(htmlText)}scope.$watch(attrs.markdown,renderMarkdown),renderMarkdown()}}}),angular.module("3drepo").factory("RevisionsByDay",["$http","$q","serverConfig",function($http,$q,serverConfig){var o={};return o.month=function(month){var monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];return monthNames[month]},o.getNumberOfRevisions=function(account,project,branch){var self=this;self.n_revisions=0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/revisions/"+branch+".json?mode=number")).then(function(json){self.n_revisions=json.data.n_revisions,deferred.resolve(self.n_revisions)},function(json){deferred.resolve(0)}),deferred.promise},o.refresh=function(account,project,branch,first,last){var self=this;self.revisionsByDay={},self.loading=!0;var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/revisions/"+branch+".json?start="+first+"&end="+last+"&full=true")).then(function(json){for(var rev in json.data){var dt=new Date(json.data[rev].timestamp),day=dt.getDate(),month=self.month(dt.getMonth()),year=dt.getFullYear(),dtStr=day+" "+month+" "+year;dtStr in res||(res[dtStr]=[]),json.data[rev].date=dtStr,self.revisionsByDay[dtStr].push(json.data[rev])}self.loading=!1,deferred.resolve(res)},function(json){self.loading=!1,deferred.resolve()}),deferred.promise},o}]),angular.module("3drepo").factory("Users",["$http","$q","serverConfig",function($http,$q,serverConfig){var o={};return o.userRoles=[{label:"Owner",value:1},{label:"Admin",value:2},{label:"Viewer",value:3}],o.refresh=function(account,project){var self=this;self.users=[];var deferred=$q.defer();return $http.get(serverConfig.apiUrl(account+"/"+project+"/users.json")).then(function(json){self.users=json.data,deferred.resolve()}),deferred.promise},o.updateUsers=function(){return null},o}]);var possible_views=["info","comments","revisions","log","settings","cobie"];angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.view,i=0;i<states.length;i++)for(var v=0;v<possible_views.length;v++){var stateObj=(possible_views[v],{url:"/"+possible_views[v],resolve:{auth:function(Auth){return Auth.init()},init:function(StateManager,$stateParams){var splitURL=this.url.source.split("/"),view=splitURL[splitURL.length-1];StateManager.setState($stateParams,{}),StateManager.setStateVar(view),StateManager.refresh("view")}},views:{"footer@base.login.account.project":{templateUrl:possible_views[v]+".html"}}});$stateProvider.state(states[i]+"."+possible_views[v],stateObj)}}]).run(["$rootScope","parentStates","StateManager",function($rootScope,parentStates,StateManager){StateManager.registerPlugin("view","ViewData",function(){return-1!=possible_views.indexOf(StateManager.state.view)?StateManager.state.view:null}),StateManager.setClearStateVars("view",["view"]),$rootScope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){for(var states=parentStates.view,i=0;i<states.length;i++)if(states[i]==toState.name){StateManager.setStateVar("view","info"),StateManager.updateState();break}console.log("$stateChangeSuccess to "+toState.name+"- fired once the state transition is complete.")})}]).controller("ViewCtrl",["$scope","StateManager","serverConfig","$state",function($scope,StateManager,serverConfig,$state){$scope.pageChanged=function(){StateManager.Data.ViewData.updatePaginatedView($scope.view)},$scope.go=function(v){var bp=$("#bottom-panel");bp.hasClass("collapsed")?bp.removeClass("collapsed"):v===StateManager.state.view&&bp.addClass("collapsed"),StateManager.setStateVar("view",v),StateManager.updateState()},$scope.pageChanged()}]),angular.module("3drepo").factory("ViewData",["StateManager","Readme","Comments","Log","RevisionsByDay","Users",function(StateManager,Readme,Comments,Log,RevisionsByDay,Users){var o={Readme:Readme,Comments:Comments,Log:Log,RevisionsByDay:RevisionsByDay,Users:Users,totalItems:0,currentPage:1,itemsPerPage:0};return o.genStateName=function(){return StateManager.state.view?"view":null},o.updatePaginatedView=function(view){var self=this,first=(self.currentPage-1)*self.itemsPerPage,last=Math.min(self.totalItems-1,self.currentPage*self.itemsPerPage-1);"comments"==view?self.Comments.refresh(StateManager.state.account,StateManager.state.project,first,last):"log"==view?self.Log.refresh(StateManager.state.account,StateManager.state.project,first,last):"revisions"==view&&self.RevisionsByDay.refresh(StateManager.state.account,StateManager.state.project,StateManager.state.branch,first,last)},o.refresh=function(){var self=this,view=StateManager.state.view;if("info"==view)self.Readme.refresh(StateManager.state.account,StateManager.state.project,StateManager.state.branch,StateManager.state.revision);else if("comments"==StateManager.state.view)self.Comments.getNumberOfComments(StateManager.state.account,StateManager.state.project).then(function(n_comments){self.totalItems=n_comments,self.updatePaginatedView()});else if("log"==view)self.Log.getNumberOfLogEntries(StateManager.state.account,StateManager.state.project).then(function(n_logentries){self.totalItems=n_logentries,self.updatePaginatedView()});else if("revisions"==view)self.RevisionsByDay.getNumberOfRevisions(StateManager.state.account,StateManager.state.project,StateManager.state.branch).then(function(n_revisions){self.totalItems=n_revisions,self.updatePaginatedView("revisions")});else if("settings"==view)self.Users.refresh(StateManager.state.account,StateManager.state.project);else if(view)return StateManager.setStateVar("view",null),StateManager.updateState()},o}]),angular.module("3drepo").config(["$stateProvider","parentStates",function($stateProvider,parentStates){for(var states=parentStates.sid,i=0;i<states.length;i++)$stateProvider.state(states[i]+".sid",{url:"/:sid",resolve:{init:function(StateManager,$stateParams){StateManager.setState($stateParams,{}),StateManager.refresh("sid")}}})}]).run(["StateManager",function(StateManager){StateManager.registerPlugin("sid","SIDData",function(){return StateManager.state.sid?"sid":null}),StateManager.setClearStateVars("sid",["sid"])}]),angular.module("3drepo").factory("SIDData",["$http","$q","serverConfig","StateManager","$rootScope","ViewerService",function($http,$q,serverConfig,StateManager,$rootScope,ViewerService){var o={};return o.refresh=function(){var sid=(StateManager.state.account,StateManager.state.project,StateManager.state.sid),branch=StateManager.state.branch?StateManager.state.branch:"master",revision=StateManager.state.revision?StateManager.state.revision:"head",url=null;url="head"==revision?serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+branch+"/head/"):serverConfig.apiUrl(StateManager.state.account+"/"+StateManager.state.project+"/revision/"+revision+"/"),url+=sid+".json",$http.get(url).then(function(json){if(json.data.cameras_count){var camkey=Object.keys(json.data.cameras)[0],name=json.data.cameras[camkey].name;ViewerService.defaultViewer.setCurrentViewpoint("model__"+name)}},function(json){$rootScope.$broadcast("sidNotFound",{uuid:sid})})},o}]),function(){"use strict";function WalkthroughCtrl(WalkthroughService){var wt=this;wt.recordButtonClass="btn walkthroughButton btn-success",wt.walkthroughs=WalkthroughService.getWalkthroughs(),wt.currentWalkthrough=WalkthroughService.getCurrentWalkthrough(),wt.record=function(){-1!==wt.currentWalkthrough&&(WalkthroughService.isRecording()?(WalkthroughService.stopRecording(),wt.recordButtonClass="btn walkthroughButton btn-success"):(WalkthroughService.startRecording(),wt.recordButtonClass="btn walkthroughButton btn-danger"))},wt.play=function(){WalkthroughService.play()},wt.stop=function(){WalkthroughService.stop()},wt.userInControl=function(){WalkthroughService.userInControl()},wt.setCurrentWalkthrough=function(index){WalkthroughService.setCurrentWalkthrough(index),wt.currentWalkthrough=WalkthroughService.getCurrentWalkthrough()}}angular.module("3drepo").controller("WalkthroughCtrl",WalkthroughCtrl),WalkthroughCtrl.$inject=["WalkthroughService"]}(),function(){"use strict";function WalkthroughService($interval,$timeout,$http,ViewerService,StateManager,serverConfig){function getWalkthroughData(index){var url="/"+state.account+"/"+state.project+"/"+index+"/walkthrough.json",i=0,length=0;$http.get(serverConfig.apiUrl(url)).then(function(data){for(i=0,length=data.data.length;length>i;i++)walkthroughs[data.data[i].index]=data.data[i].cameraData})}var defaultViewer=ViewerService.defaultViewer,recordingInterval=null,playingInterval=null,position=0,recording=!1,playing=!1,walkthroughs=new Array(5),currentWalkthrough=-1,state=StateManager.state,userControlTimeout=null;getWalkthroughData("all");var startRecording=function(){var viewpoint={};-1!==currentWalkthrough&&(recording=!0,walkthroughs[currentWalkthrough]=[],recordingInterval=$interval(function(){viewpoint=defaultViewer.getCurrentViewpointInfo(),walkthroughs[currentWalkthrough].push({position:viewpoint.position,up:viewpoint.up,view_dir:viewpoint.view_dir})},250))},stopRecording=function(){var postUrl="/"+state.account+"/"+state.project+"/walkthrough";recording=!1,$interval.cancel(recordingInterval),$http.post(serverConfig.apiUrl(postUrl),{index:currentWalkthrough,cameraData:walkthroughs[currentWalkthrough]}).then(function(json){console.log(json)})},play=function(){var numCameraPositions=0;-1!==currentWalkthrough&&angular.isDefined(walkthroughs[currentWalkthrough])&&(numCameraPositions=walkthroughs[currentWalkthrough].length,playing=!0,playingInterval=$interval(function(){defaultViewer.updateCamera(walkthroughs[currentWalkthrough][position].position,walkthroughs[currentWalkthrough][position].up,walkthroughs[currentWalkthrough][position].view_dir),position===numCameraPositions-1?position=0:position+=1},500))},stop=function(){playing=!1,$interval.cancel(playingInterval),$timeout.cancel(userControlTimeout)},userInControl=function(){playing&&($interval.cancel(playingInterval),$timeout.cancel(userControlTimeout),userControlTimeout=$timeout(function(){play()},5e3))},isRecording=function(){return recording},setCurrentWalkthrough=function(index){currentWalkthrough=index,stop(),angular.isDefined(walkthroughs[currentWalkthrough])?(position=0,play()):getWalkthroughData(currentWalkthrough)},getCurrentWalkthrough=function(){return currentWalkthrough},getWalkthroughs=function(){return walkthroughs};return{isRecording:isRecording,startRecording:startRecording,stopRecording:stopRecording,play:play,stop:stop,userInControl:userInControl,setCurrentWalkthrough:setCurrentWalkthrough,getCurrentWalkthrough:getCurrentWalkthrough,getWalkthroughs:getWalkthroughs}}angular.module("3drepo").service("WalkthroughService",WalkthroughService),WalkthroughService.$inject=["$interval","$timeout","$http","ViewerService","StateManager","serverConfig"]}(),function(){"use strict";function ViewingCtrl(){var vw=this;vw.currentViewing=0,vw.viewings=[{label:"T"},{label:"H"},{label:"W"}]}angular.module("3drepo").controller("ViewingCtrl",ViewingCtrl)}();