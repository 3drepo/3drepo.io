matrix:
  include:
    #linter test
    - language: node_js
      dist: focal
      name: Linter check
      git:
      submodules: false
      depth: 1
      node_js:
        - "14.17.1"
      script:
        - cd backend
        - yarn install
        - yarn lint
        - cd ../frontend
        - yarn install
        - yarn lint
        - yarn build:test
    # tests
    - language: node_js
      dist: focal
      name: Backend tests
      git:
      submodules: false
      depth: 1
      node_js:
        - "14.17.1"
      sudo: true
      addons:
        apt:
         packages:
            - expect-dev
            - rabbitmq-server
      hosts:
        - test.127.0.0.1
      services:
        - mongodb
        - docker

      before_install:
        - docker-compose up alluxio-proxy alluxio-worker alluxio-master &
        - sleep 100
        - mkdir -p submodules
        - sleep 100
        - test_ver=`cat backend/test/testDBVersion`
        - sleep 100
        - cd submodules
        - sleep 100
        - git clone https://$TESTS_USER:$TESTS_PASSWORD@github.com/3drepo/tests.git
        - sleep 100
        - cd tests
        - sleep 100
        - git checkout $test_ver
        - sleep 100
        - git status
        - sleep 100
        - sudo apt install mongo-tools -y
        - sleep 100
        - cd backend && mongorestore
        - sleep 100
        - cd ../../../
        - sleep 100
        - cp -r ./submodules/tests/frontend/staticPages/legal/ ./resources/legal
        - until nc -z localhost 39999; do echo Waiting for Alluxio; sleep 1; done

      install:
        - cd ./backend
        - yarn install
        - cd ./../frontend
        - DETECT_CHROMEDRIVER_VERSION=true yarn install
        - yarn build

      script:
        - cd ../backend
        - mkdir coverage
        - unbuffer yarn test
        - cd ../
        - NODE_ENV=test NODE_CONFIG_DIR='./config' node "./backend/3drepo.js" &
        - cd ./frontend
       #- unbuffer yarn test

notifications:
    email:
        recipients:
            - devOps@3drepo.org
