language: node_js

git:
  submodules: false
  depth: 1

node_js:
    - "6.11.3"

sudo: false
dist: trusty

addons:
  apt:
   sources:
      - mongodb-3.2-precise
  chrome: stable
  hosts:
    - test.127.0.0.1

before_install:
    - mongo --version
    - mkdir -p submodules
    - cd submodules
    - git clone https://$TESTS_USER:$TESTS_PASSWORD@github.com/3drepo/tests.git
    - cd ..
    - sudo apt-get install -y graphicsmagick 
    - mongod --version
    - until nc -z localhost 27017; do sleep 1; done
    - test_ver=`cat backend/test/testDBVersion`
    - cd submodules/tests
    - git checkout $test_ver
    - git status
    - cd backend && mongorestore
    - cd ./../../../
    - cp -r ./submodules/tests/frontend/pug/legal/ ./pug/legal
    - echo $PWD
    - cd ./frontend 
    - yarn install
    - yarn run gulp build
    - cd ./../backend 
    - yarn install
    - cd ..


cache:
  yarn: true
  directories:
    - ./frontend/node_modules
    - ./backend/node_modules

services:
  - rabbitmq
  - mongodb

matrix:
    include:
        - env: TEST_SUITE=backend
        - env: TEST_SUITE=frontend

script: 
    - echo $PWD
    - ls -lah
    - ls -lah ./../
    - chmod +X ./test.sh
    - node --version
    - bash ./test.sh $TEST_SUITE

notifications:
    email: 
        recipients:
            - devOps@3drepo.org
